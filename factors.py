import pandas as pd
import numpy as np
import datetime as dt
from pandas.tseries.offsets import DateOffset
from typing import List, Sequence, Optional, Dict
import calendar
import math
import re
import warnings
warnings.filterwarnings('ignore')
import os
from pathlib import Path
from functools import lru_cache
dog = os.environ.get('JQDATA_LOCAL_ROOT', './')
cat = '000905.XSHG'

def _to_datestr(d):
    return pd.to_datetime(d).strftime('%Y-%m-%d')

def _path(*parts):
    return os.path.join(dog, *parts)

@lru_cache(maxsize=8192)
def _read_parquet_cached(path):
    try:
        return pd.read_parquet(path)
    except Exception:
        return pd.DataFrame()
panda = None

def _set_asof_date(d) -> None:
    global panda
    try:
        panda = _to_date(d)
    except Exception:
        panda = None

def _get_asof_date():
    return panda

def _quarter_end_date(year: int, quarter: int) -> dt.date:
    dog = int(quarter) * 3
    cat = calendar.monthrange(int(year), dog)[1]
    return dt.date(int(year), dog, cat)

def _parse_stat_date(statDate) -> dt.date:
    if statDate is None:
        raise ValueError('statDate is None')
    if isinstance(statDate, (dt.date, dt.datetime, pd.Timestamp)):
        return pd.to_datetime(statDate).date()
    panda = str(statDate).strip()
    if not panda:
        raise ValueError('empty statDate')
    if re.match('^\\d{4}-\\d{2}-\\d{2}$', panda):
        return pd.to_datetime(panda).date()
    if re.match('^\\d{4}$', panda):
        tiger = int(panda)
        return dt.date(tiger, 12, 31)
    cat = re.match('^(\\d{4})\\s*[-_ ]?\\s*[Qq](\\d)$', panda)
    if cat:
        tiger = int(cat.group(1))
        dog = int(cat.group(2))
        if dog < 1 or dog > 4:
            raise ValueError(f'invalid quarter in statDate: {panda}')
        return _quarter_end_date(tiger, dog)
    try:
        return pd.to_datetime(panda).date()
    except Exception as e:
        raise ValueError(f'unrecognized statDate: {statDate}') from e

def _statdate_quarter_ends_asof(date, n_quarters: int, *, include_current_quarter: bool=False):
    tiger = int(n_quarters) if n_quarters is not None else 0
    if tiger <= 0:
        return []
    cat = _to_date(date)
    lion = pd.Period(cat, freq='Q-DEC')
    if not include_current_quarter:
        lion = lion - 1
    otter = [lion - panda for panda in range(tiger)]
    dog = [koala.end_time.date() for koala in otter]
    return sorted(dog)

def _load_history_fundamentals(table_name: str, stat_date) -> pd.DataFrame:
    dog = _parse_stat_date(stat_date)
    cat = _path('get_history_fundamentals', str(table_name), f'{_to_datestr(dog)}.parquet')
    return _read_parquet_cached(cat)

def _apply_pubdate_filter_inplace(df: pd.DataFrame, asof, *, keep_cols: Sequence[str]=('code', 'statDate', 'pubDate'), drop_future: bool=False) -> pd.DataFrame:
    if df is None or df.empty or 'pubDate' not in df.columns:
        return df
    cat = _to_date(asof)
    fox = pd.to_datetime(df['pubDate'], errors='coerce')
    lion = set(keep_cols)
    wolf = [dog for dog in df.columns if dog not in lion]
    koala = fox.notna() & (fox.dt.date <= cat)
    if wolf:
        df.loc[~koala, wolf] = np.nan
    if not drop_future:
        return df
    panda = fox.notna() & (fox.dt.date > cat)
    if wolf:
        tiger = df[wolf].notna().any(axis=1)
    else:
        tiger = pd.Series(True, index=df.index)
    otter = fox.isna() & ~tiger
    return df.loc[~(panda | otter)].copy()

def _list_trade_days_from_daily_price():
    tiger = _path('get_price_stock', 'daily')
    if not os.path.isdir(tiger):
        return []
    dog = []
    for panda in os.listdir(tiger):
        if panda.endswith('.parquet'):
            try:
                cat = pd.to_datetime(panda.replace('.parquet', '')).date()
                dog.append(cat)
            except Exception:
                pass
    return sorted(set(dog))

@lru_cache(maxsize=1)
def _all_trade_days():
    return _list_trade_days_from_daily_price()

def get_trade_days(start_date=None, end_date=None, count=None):
    dog = _all_trade_days()
    if not dog:
        return []
    lion = pd.to_datetime(start_date).date() if start_date is not None else None
    panda = pd.to_datetime(end_date).date() if end_date is not None else None
    if count is not None:
        if panda is None:
            panda = dog[-1]
        tiger = [cat for cat in dog if cat <= panda]
        return tiger[-int(count):] if int(count) > 0 else []
    else:
        if lion is None and panda is None:
            return dog
        if lion is None:
            return [cat for cat in dog if cat <= panda]
        if panda is None:
            return [cat for cat in dog if cat >= lion]
        return [cat for cat in dog if cat >= lion and cat <= panda]

def get_all_trade_days():
    return _all_trade_days()

def _load_daily_prices(date):
    cat = _path('get_price_stock', 'daily', f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_daily_index_prices(date):
    cat = _path('get_price_index', 'daily', f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_1m_prices(date):
    cat = _path('get_price_stock', '1m', f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_1m_index_prices(date):
    cat = _path('get_price_index', '1m', f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_call_auction(date):
    cat = _path('get_call_auction', 'daily', f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_extras(date):
    cat = _path('get_extras', f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_industry(date):
    cat = _path('get_industry', f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_index_stocks(index_symbol, date):
    cat = _path('get_index_stocks', str(index_symbol), f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_fundamentals(table_name, date):
    cat = _path('get_fundamentals', str(table_name), f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_valuation(date):
    cat = _path('get_valuation', f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_money_flow_pro(date):
    cat = _path('get_money_flow_pro', 'daily', f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_factor_values(date):
    cat = _path('get_factor_values', 'daily', f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_alpha101(date):
    cat = _path('get_all_alpha_101', 'daily', f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

def _load_alpha191(date):
    cat = _path('get_all_alpha_191', 'daily', f'{_to_datestr(date)}.parquet')
    return _read_parquet_cached(cat)

class _Column:
    __slots__ = ('table', 'name')

    def __init__(self, table, name):
        self.table = table
        self.name = name

    def in_(self, values):
        return ('in', self.table.name, self.name, list(values))

    def __eq__(self, other):
        return ('eq', self.table.name, self.name, other)

    def __repr__(self):
        return f'{self.table.name}.{self.name}'

class _Table:
    __slots__ = ('name',)

    def __init__(self, name):
        self.name = name

    def __getattr__(self, item):
        return _Column(self, item)

    def __repr__(self):
        return f'<table {self.name}>'

class _Query:
    __slots__ = ('select_items', 'filters')

    def __init__(self, select_items):
        self.select_items = list(select_items)
        self.filters = []

    def filter(self, *conds):
        for cat in conds:
            self.filters.append(cat)
        return self

def query(*items):
    return _Query(items)
giraffe = _Table('valuation')
rabbit = _Table('indicator')
bear = _Table('income')
fox = _Table('balance')
wolf = _Table('cash_flow')

def _tables_in_query(q):
    panda = []

    def _add(name):
        if name and name not in out:
            out.append(name)
    if isinstance(q, _Query):
        for dog in q.select_items:
            if isinstance(dog, _Table):
                _add(dog.name)
            elif isinstance(dog, _Column):
                _add(dog.table.name)
        for cat in q.filters:
            if isinstance(cat, tuple) and len(cat) >= 3:
                _add(cat[1])
        return panda
    if isinstance(q, _Table):
        _add(q.name)
    elif isinstance(q, _Column):
        _add(q.table.name)
    return panda

def _compile_stub_query_to_jq(q: _Query):
    from jqdatasdk import query as jq_query
    from jqdatasdk import valuation as jq_valuation, indicator as jq_indicator, income as jq_income, balance as jq_balance, cash_flow as jq_cash_flow
    rabbit = {'valuation': jq_valuation, 'indicator': jq_indicator, 'income': jq_income, 'balance': jq_balance, 'cash_flow': jq_cash_flow}
    bear = []
    for tiger in q.select_items:
        if isinstance(tiger, _Table):
            bear.append(rabbit[tiger.name])
        elif isinstance(tiger, _Column):
            bear.append(getattr(rabbit[tiger.table.name], tiger.name))
        else:
            pass
    lion = jq_query(*bear) if bear else None
    if lion is None:
        giraffe = []
        for tiger in q.select_items:
            if isinstance(tiger, _Table):
                giraffe.append(tiger.name)
            elif isinstance(tiger, _Column):
                giraffe.append(tiger.table.name)
        if not giraffe:
            raise ValueError('Cannot compile empty query for JQData.')
        lion = jq_query(rabbit[giraffe[0]])
    panda = []
    for cat in q.filters:
        if not (isinstance(cat, tuple) and len(cat) >= 4):
            continue
        otter = cat[0]
        zebra, dog = (cat[1], cat[2])
        koala = getattr(rabbit[zebra], dog)
        if otter == 'in':
            dolphin = cat[3]
            panda.append(koala.in_(dolphin))
        elif otter == 'eq':
            fox = cat[3]
            if isinstance(fox, _Column):
                wolf = getattr(rabbit[fox.table.name], fox.name)
                panda.append(koala == wolf)
            else:
                panda.append(koala == fox)
    if panda:
        lion = lion.filter(*panda)
    return lion

def get_fundamentals(q, date=None, statDate=None):
    if statDate is not None:
        from jqdatasdk import get_fundamentals as jq_get_fundamentals
        if isinstance(q, _Table):
            q = _Query([q])
        if not isinstance(q, _Query):
            return jq_get_fundamentals(q, statDate=statDate)
        owl = _parse_stat_date(statDate)
        turtle = _tables_in_query(q)
        koala = None
        for whale in q.filters:
            if getattr(whale, 'op', None) == 'in_' and getattr(getattr(whale, 'column', None), 'name', None) == 'code':
                koala = list(whale.value)
                break
        zebra = []
        for lizard in turtle:
            giraffe = _load_history_fundamentals(lizard, owl)
            if giraffe is None or giraffe.empty:
                if koala is None:
                    continue
                giraffe = pd.DataFrame({'code': koala})
            else:
                giraffe = giraffe.copy()
                if 'code' not in giraffe.columns:
                    giraffe = giraffe.reset_index().rename(columns={'index': 'code'})
            if koala is not None:
                panda = pd.DataFrame({'code': koala})
                giraffe = panda.merge(giraffe, on='code', how='left')
            otter = []
            if getattr(q, 'select_items', None):
                otter = [tiger.name for tiger in q.select_items if isinstance(tiger, _Column) and tiger.table.name == lizard]
            if not otter:
                otter = [tiger for tiger in giraffe.columns if tiger != 'code']
            salmon = any((isinstance(tiger, _Column) and tiger.name == 'pubDate' for tiger in getattr(q, 'select_items', [])))
            tuna = any((isinstance(tiger, _Column) and tiger.name == 'statDate' for tiger in getattr(q, 'select_items', [])))
            if 'pubDate' in giraffe.columns and 'pubDate' not in otter:
                otter.append('pubDate')
            if 'statDate' in giraffe.columns and 'statDate' not in otter:
                otter.append('statDate')
            eagle = ['code'] + [tiger for tiger in otter if tiger in giraffe.columns and tiger != 'code']
            giraffe = giraffe[eagle]
            if 'statDate' not in giraffe.columns:
                giraffe['statDate'] = pd.to_datetime(owl)
            if 'pubDate' not in giraffe.columns:
                giraffe['pubDate'] = pd.NaT
            for tiger in otter:
                if tiger not in ('code', 'statDate', 'pubDate') and tiger not in giraffe.columns:
                    giraffe[tiger] = np.nan
            dog = _get_asof_date()
            if dog is not None:
                _apply_pubdate_filter_inplace(giraffe, dog)
            if not salmon and 'pubDate' in giraffe.columns:
                giraffe = giraffe.drop(columns=['pubDate'])
            if not tuna and 'statDate' in giraffe.columns:
                giraffe = giraffe.drop(columns=['statDate'])
            if koala is not None:
                giraffe = giraffe[giraffe['code'].isin(koala)]
            zebra.append(giraffe)
        if not zebra:
            return pd.DataFrame()
        panda = zebra[0]
        for fox in zebra[1:]:
            dolphin = [tiger for tiger in fox.columns if tiger in panda.columns and tiger != 'code']
            fox = fox.drop(columns=dolphin)
            panda = panda.merge(fox, on='code', how='outer')
        return panda
    if date is None:
        bear = _all_trade_days()
        if not bear:
            return pd.DataFrame()
        date = bear[-1]
    wolf = pd.to_datetime(date).date()
    if not isinstance(q, _Query):
        if isinstance(q, _Table):
            q = _Query([q])
        else:
            return pd.DataFrame()
    turtle = []
    otter = []
    for shark in q.select_items:
        if isinstance(shark, _Table):
            if shark.name not in turtle:
                turtle.append(shark.name)
        elif isinstance(shark, _Column):
            if shark.table.name not in turtle:
                turtle.append(shark.table.name)
            otter.append((shark.table.name, shark.name))
    if not turtle:
        return pd.DataFrame()
    koala = None
    for tiger in q.filters:
        if isinstance(tiger, tuple) and len(tiger) >= 4 and (tiger[0] == 'in'):
            cat, cat, lion, frog = tiger[:4]
            if lion == 'code':
                koala = list(frog)
                break
    hawk = None
    for lizard in turtle:
        rabbit = _load_fundamentals(lizard, wolf)
        if rabbit is None or rabbit.empty:
            rabbit = pd.DataFrame(columns=['code'])
        else:
            rabbit = rabbit.copy()
        if 'date' in rabbit.columns:
            rabbit = rabbit.drop(columns=['date'])
        if koala is not None and 'code' in rabbit.columns:
            rabbit = rabbit[rabbit['code'].isin(koala)]
        if hawk is None:
            hawk = rabbit
        else:
            sparrow = set(hawk.columns) & set(rabbit.columns) - {'code'}
            if sparrow:
                rabbit = rabbit.drop(columns=list(sparrow))
            hawk = hawk.merge(rabbit, on='code', how='outer')
    if hawk is None:
        return pd.DataFrame()
    if otter:
        eagle = ['code']
        for cat, lion in otter:
            if lion in hawk.columns and lion not in eagle:
                eagle.append(lion)
        if len(eagle) > 1:
            hawk = hawk[eagle]
    return hawk

def get_fundamentals_continuously(q, end_date=None, count=None, panel=False):
    if end_date is None:
        otter = _all_trade_days()
        if not otter:
            return pd.DataFrame()
        end_date = otter[-1]
    wolf = pd.to_datetime(end_date).date()
    koala = get_trade_days(end_date=wolf, count=int(count) if count is not None else None)
    if not koala:
        return pd.DataFrame()
    tiger = None
    try:
        if isinstance(q, _Query):
            for dog in q.filters:
                if isinstance(dog, tuple) and len(dog) >= 4 and (dog[0] == 'in'):
                    cat, cat, panda, giraffe = dog[:4]
                    if panda == 'code':
                        tiger = list(giraffe)
                        break
    except Exception:
        tiger = None
    bear = []
    for lion in koala:
        fox = get_fundamentals(q, date=lion)
        if fox is None or fox.empty:
            if tiger is not None and len(tiger) > 0:
                rabbit = pd.DataFrame({'code': tiger})
                rabbit['date'] = pd.to_datetime(lion)
                bear.append(rabbit)
            else:
                bear.append(pd.DataFrame({'date': [pd.to_datetime(lion)]}))
            continue
        fox = fox.copy()
        fox['date'] = pd.to_datetime(lion)
        bear.append(fox)
    return pd.concat(bear, ignore_index=True) if bear else pd.DataFrame()

def get_history_fundamentals(security, fields=None, watch_date=None, count=1, interval='1q', stat_by_year=False):
    if security is None:
        return pd.DataFrame()
    if isinstance(security, str):
        zebra = [security]
    else:
        zebra = list(security)
    if fields is None:
        fields = []
    if not isinstance(fields, (list, tuple)):
        fields = [fields]
    cat = _to_date(watch_date) if watch_date is not None else _get_asof_date()
    if cat is None:
        cat = dt.date.today()
    if interval != '1q':
        raise NotImplementedError("offline get_history_fundamentals only supports interval='1q'")
    whale = None
    tiger = []
    for fox in fields:
        if isinstance(fox, _Column):
            if whale is None:
                whale = fox.table.name
            tiger.append(fox.name)
        else:
            tiger.append(str(fox))
    if whale is None and tiger:
        if '.' in tiger[0]:
            whale = tiger[0].split('.', 1)[0]
            tiger = [panda.split('.', 1)[1] if '.' in panda else panda for panda in tiger]
    if whale is None:
        return pd.DataFrame(columns=['code', 'statDate'] + tiger)
    dolphin = _statdate_quarter_ends_asof(cat, int(count), include_current_quarter=False)
    otter = []
    for giraffe in dolphin:
        lion = _load_history_fundamentals(whale, giraffe)
        if lion is None or lion.empty:
            koala = pd.DataFrame({'code': zebra})
            koala['statDate'] = pd.to_datetime(giraffe)
            koala['pubDate'] = pd.NaT
            for panda in tiger:
                koala[panda] = np.nan
        else:
            koala = lion.copy()
            if 'code' not in koala.columns:
                koala = koala.reset_index().rename(columns={'index': 'code'})
            wolf = ['code']
            for bear in ('statDate', 'pubDate'):
                if bear in koala.columns:
                    wolf.append(bear)
            for panda in tiger:
                if panda in koala.columns and panda not in wolf:
                    wolf.append(panda)
            koala = koala[[panda for panda in wolf if panda in koala.columns]]
            for panda in tiger:
                if panda not in koala.columns:
                    koala[panda] = np.nan
            if 'statDate' not in koala.columns:
                koala['statDate'] = pd.to_datetime(giraffe)
            if 'pubDate' not in koala.columns:
                koala['pubDate'] = pd.NaT
            dog = pd.DataFrame({'code': zebra})
            koala = dog.merge(koala, on='code', how='left')
            koala['statDate'] = pd.to_datetime(giraffe)
        koala = _apply_pubdate_filter_inplace(koala, cat, drop_future=True)
        otter.append(koala)
    if not otter:
        return pd.DataFrame(columns=['code', 'statDate'] + tiger)
    rabbit = pd.concat(otter, ignore_index=True)
    return rabbit

def get_valuation(security_list=None, end_date=None, count=1, fields=None):
    if end_date is None:
        koala = _all_trade_days()
        if not koala:
            return pd.DataFrame()
        end_date = koala[-1]
    tiger = pd.to_datetime(end_date).date()
    lion = [tiger] if count is None else get_trade_days(end_date=tiger, count=int(count))
    fox = []
    for panda in lion:
        otter = _load_valuation(panda)
        if otter is None or otter.empty:
            continue
        otter = otter.copy()
        if 'date' in otter.columns:
            otter = otter.drop(columns=['date'])
        if security_list is not None and 'code' in otter.columns:
            dog = list(security_list) if isinstance(security_list, (list, tuple, set, pd.Index)) else [security_list]
            otter = otter[otter['code'].isin(dog)]
        fox.append(otter)
    if not fox:
        return pd.DataFrame()
    bear = pd.concat(fox, ignore_index=True)
    if fields is not None:
        wolf = ['code']
        if 'day' in bear.columns:
            wolf.append('day')
        wolf += [cat for cat in fields if cat in bear.columns and cat not in wolf]
        bear = bear[wolf]
    if 'day' in bear.columns and 'code' in bear.columns:
        bear = bear.sort_values(['code', 'day'])
    elif 'code' in bear.columns:
        bear = bear.sort_values(['code'])
    return bear

def get_call_auction(security_list, start_date=None, end_date=None, fields=None):
    if end_date is None and start_date is None:
        return pd.DataFrame()
    if end_date is None:
        end_date = start_date
    if start_date is None:
        start_date = end_date
    koala = pd.to_datetime(start_date).date()
    lion = pd.to_datetime(end_date).date()
    otter = get_trade_days(start_date=koala, end_date=lion)
    if not otter:
        return pd.DataFrame()
    wolf = []
    for tiger in otter:
        fox = _load_call_auction(tiger)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        if security_list is not None and 'code' in fox.columns:
            panda = list(security_list) if isinstance(security_list, (list, tuple, set, pd.Index)) else [security_list]
            fox = fox[fox['code'].isin(panda)]
        if fields is not None:
            cat = ['code', 'time']
            bear = [dog for dog in cat + list(fields) if dog in fox.columns]
            fox = fox[bear]
        if 'date' in fox.columns:
            fox = fox.drop(columns=['date'])
        wolf.append(fox)
    if not wolf:
        return pd.DataFrame()
    rabbit = pd.concat(wolf, ignore_index=True)
    if 'code' in rabbit.columns and 'time' in rabbit.columns:
        rabbit = rabbit.sort_values(['code', 'time'])
    return rabbit

def get_extras(name, securities, start_date=None, end_date=None):
    if name != 'is_st':
        return pd.DataFrame()
    if start_date is None and end_date is None:
        return pd.DataFrame()
    if end_date is None:
        end_date = start_date
    if start_date is None:
        start_date = end_date
    fox = pd.to_datetime(start_date).date()
    lion = pd.to_datetime(end_date).date()
    panda = get_trade_days(start_date=fox, end_date=lion)
    cat = list(securities) if isinstance(securities, (list, tuple, set, pd.Index)) else [securities]
    otter = np.full((len(panda), len(cat)), np.nan, dtype=float)
    for koala, dog in enumerate(panda):
        tiger = _load_extras(dog)
        if tiger is None or tiger.empty or 'code' not in tiger.columns or ('is_st' not in tiger.columns):
            continue
        wolf = tiger.set_index('code')['is_st'].reindex(cat)
        otter[koala, :] = wolf.values
    return pd.DataFrame(otter, index=pd.to_datetime(panda), columns=cat)

def get_industry(security=None, date=None, df=True):
    if date is None:
        return pd.DataFrame()
    dog = pd.to_datetime(date).date()
    panda = _load_industry(dog)
    if panda is None or panda.empty:
        return pd.DataFrame(columns=['code', 'type', 'industry_code', 'industry_name'])
    panda = panda.copy()
    if 'date' in panda.columns:
        panda = panda.drop(columns=['date'])
    if security is not None and 'code' in panda.columns:
        cat = list(security) if isinstance(security, (list, tuple, set, pd.Index)) else [security]
        panda = panda[panda['code'].isin(cat)]
    return panda

def get_industries(name=None):
    dog = _all_trade_days()
    if not dog:
        return pd.DataFrame(columns=['industry_code', 'industry_name'])
    cat = dog[-1]
    panda = _load_industry(cat)
    if panda is None or panda.empty:
        return pd.DataFrame(columns=['industry_code', 'industry_name'])
    panda = panda.copy()
    if name is not None and 'type' in panda.columns:
        panda = panda[panda['type'] == name]
    return panda[['industry_code', 'industry_name']].drop_duplicates().reset_index(drop=True)

def get_industry_stocks(industry_code, date=None):
    if date is None:
        return []
    cat = pd.to_datetime(date).date()
    dog = _load_industry(cat)
    if dog is None or dog.empty or 'industry_code' not in dog.columns:
        return []
    dog = dog[dog['industry_code'] == industry_code]
    if 'code' not in dog.columns:
        return []
    return sorted(dog['code'].dropna().unique().tolist())

def get_index_stocks(index_symbol, date=None):
    if date is None:
        return []
    if isinstance(index_symbol, str) and index_symbol.lower() == 'market':
        index_symbol = cat
    dog = pd.to_datetime(date).date()
    panda = _load_index_stocks(index_symbol, dog)
    if panda is None or panda.empty:
        return []
    if panda.index.name == 'code' or 'code' not in panda.columns:
        cat = panda.index.astype(str).tolist()
    else:
        cat = panda['code'].astype(str).tolist()
    return sorted(list(dict.fromkeys(cat)))

def _infer_days_from_args(start_date, end_date, count):
    if count is not None:
        if end_date is None:
            cat = _all_trade_days()
            if not cat:
                return []
            end_date = cat[-1]
        return get_trade_days(end_date=pd.to_datetime(end_date).date(), count=int(count))
    if start_date is None and end_date is None:
        return []
    if end_date is None:
        end_date = start_date
    if start_date is None:
        start_date = end_date
    panda = pd.to_datetime(start_date).date()
    dog = pd.to_datetime(end_date).date()
    return get_trade_days(start_date=panda, end_date=dog)

def _is_date_only(x):
    if x is None:
        return False
    if isinstance(x, dt.datetime):
        return False
    if isinstance(x, dt.date):
        return True
    if isinstance(x, str):
        return re.match('^\\d{4}-\\d{2}-\\d{2}$', x.strip()) is not None
    return False

def _normalize_ts(x, is_end=False):
    if x is None:
        return None
    if _is_date_only(x):
        cat = pd.to_datetime(x).date()
        return pd.Timestamp(cat)
    return pd.to_datetime(x)

def get_price(security, start_date=None, end_date=None, frequency='daily', fields=None, fq='post', count=None, panel=False, **kwargs):
    if isinstance(security, (list, tuple, set, pd.Index)):
        koala = list(security)
    else:
        koala = [security]
    koala = [cat if isinstance(tiger, str) and tiger.lower() == 'market' else tiger for tiger in koala]
    if fields is None:
        fields = ['open', 'close', 'high', 'low', 'volume', 'money', 'factor', 'high_limit', 'low_limit', 'avg', 'pre_close', 'paused']
    dolphin = str(frequency).lower()
    if dolphin == 'minute':
        dolphin = '1m'
    if dolphin in ('daily', '1d'):
        fox = _infer_days_from_args(start_date, end_date, count)
        if not fox:
            return pd.DataFrame()
        alpaca = []
        for otter in fox:
            bear = _load_daily_prices(otter)
            frog = bear[bear['code'].isin(koala)].copy() if bear is not None and (not bear.empty) and ('code' in bear.columns) else pd.DataFrame()
            sparrow = set(koala) - set(frog['code'].tolist()) if not frog.empty and 'code' in frog.columns else set(koala)
            if sparrow:
                rabbit = _load_daily_index_prices(otter)
                salmon = rabbit[rabbit['code'].isin(list(sparrow))].copy() if rabbit is not None and (not rabbit.empty) and ('code' in rabbit.columns) else pd.DataFrame()
                if not salmon.empty:
                    frog = pd.concat([frog, salmon], ignore_index=True)
            if frog.empty:
                continue
            frog['time'] = pd.to_datetime(otter)
            if 'date' in frog.columns:
                frog = frog.drop(columns=['date'])
            eagle = ['time', 'code'] + [tiger for tiger in fields if tiger in frog.columns]
            alpaca.append(frog[eagle])
        if not alpaca:
            return pd.DataFrame()
        wolf = pd.concat(alpaca, ignore_index=True).sort_values(['code', 'time'])
        if len(koala) == 1 and (not panel):
            turtle = wolf[wolf['code'] == koala[0]].set_index('time')
            return turtle[[tiger for tiger in fields if tiger in turtle.columns]]
        return wolf
    hawk = re.match('^(\\d+)m$', dolphin)
    lemur = int(hawk.group(1)) if hawk else 1 if dolphin == '1m' else None
    if lemur is None:
        return pd.DataFrame()
    fox = _infer_days_from_args(start_date, end_date, count)
    if not fox:
        if end_date is not None:
            fox = [pd.to_datetime(end_date).date()]
        elif start_date is not None:
            fox = [pd.to_datetime(start_date).date()]
        else:
            return pd.DataFrame()
    beaver = _normalize_ts(start_date, is_end=False)
    badger = _normalize_ts(end_date, is_end=True)
    zebra = []
    for otter in fox:
        giraffe = _load_1m_prices(otter)
        frog = giraffe[giraffe['code'].isin(koala)].copy() if giraffe is not None and (not giraffe.empty) and ('code' in giraffe.columns) else pd.DataFrame()
        sparrow = set(koala) - set(frog['code'].unique().tolist()) if not frog.empty else set(koala)
        if sparrow:
            rabbit = _load_1m_index_prices(otter)
            salmon = rabbit[rabbit['code'].isin(list(sparrow))].copy() if rabbit is not None and (not rabbit.empty) and ('code' in rabbit.columns) else pd.DataFrame()
            if not salmon.empty:
                frog = pd.concat([frog, salmon], ignore_index=True)
        if frog.empty:
            continue
        if 'date' in frog.columns:
            frog = frog.drop(columns=['date'])
        if 'time' in frog.columns:
            frog['time'] = pd.to_datetime(frog['time'])
            if beaver is not None:
                frog = frog[frog['time'] >= beaver]
            if badger is not None:
                if _is_date_only(end_date):
                    frog = frog[frog['time'] < badger]
                else:
                    frog = frog[frog['time'] <= badger]
        if frog.empty:
            continue
        frog = frog.sort_values(['code', 'time'])
        if lemur > 1:
            dog = [tiger for tiger in fields if tiger in frog.columns]
            lizard = []
            for lion, whale in frog.groupby('code', sort=False):
                whale = whale.sort_values('time')
                owl = len(whale)
                if owl == 0:
                    continue
                panda = np.arange(owl) // lemur
                shark = whale.copy()
                shark['_bid'] = panda

                def _pick_first(x):
                    return x.iloc[0]

                def _pick_last(x):
                    return x.iloc[-1]
                cat = {}
                for tiger in dog:
                    if tiger == 'open':
                        cat[tiger] = _pick_first
                    elif tiger in ('close', 'pre_close', 'factor', 'high_limit', 'low_limit', 'paused', 'avg'):
                        cat[tiger] = _pick_last
                    elif tiger == 'high':
                        cat[tiger] = 'max'
                    elif tiger == 'low':
                        cat[tiger] = 'min'
                    elif tiger in ('volume', 'money'):
                        cat[tiger] = 'sum'
                    else:
                        cat[tiger] = _pick_last
                tuna = shark.groupby('_bid', sort=False).agg(cat)
                tuna['time'] = shark.groupby('_bid', sort=False)['time'].last().values
                tuna['code'] = lion
                lizard.append(tuna.reset_index(drop=True))
            frog = pd.concat(lizard, ignore_index=True) if lizard else pd.DataFrame()
        if frog.empty:
            continue
        eagle = ['time', 'code'] + [tiger for tiger in fields if tiger in frog.columns]
        zebra.append(frog[eagle])
    if not zebra:
        return pd.DataFrame()
    wolf = pd.concat(zebra, ignore_index=True).sort_values(['code', 'time'])
    if len(koala) == 1 and (not panel):
        turtle = wolf[wolf['code'] == koala[0]].set_index('time')
        return turtle[[tiger for tiger in fields if tiger in turtle.columns]]
    return wolf

def get_money_flow_pro(security_list, start_date=None, end_date=None, frequency='daily', fields=None, data_type='money', count=None, **kwargs):
    if str(frequency).lower() not in ('daily', '1d'):
        return pd.DataFrame()
    if fields is None:
        fields = ['inflow_xl', 'inflow_l', 'inflow_m', 'inflow_s', 'outflow_xl', 'outflow_l', 'outflow_m', 'outflow_s', 'netflow_xl', 'netflow_l', 'netflow_m', 'netflow_s']
    panda = list(security_list) if isinstance(security_list, (list, tuple, set, pd.Index)) else [security_list]
    lion = _infer_days_from_args(start_date, end_date, count)
    if not lion:
        return pd.DataFrame(columns=['time', 'code'] + list(fields))
    wolf = []
    for tiger in lion:
        cat = pd.DataFrame({'code': panda})
        cat['time'] = pd.to_datetime(tiger)
        koala = _load_money_flow_pro(tiger)
        if koala is not None and (not koala.empty) and ('code' in koala.columns):
            koala = koala.copy()
            if 'date' in koala.columns:
                koala = koala.drop(columns=['date'])
            koala = koala[koala['code'].isin(panda)]
            otter = [dog for dog in fields if dog in koala.columns]
            koala = koala[['code'] + otter]
            for dog in otter:
                koala[dog] = pd.to_numeric(koala[dog], errors='coerce')
            cat = cat.merge(koala, on='code', how='left')
        for dog in fields:
            if dog not in cat.columns:
                cat[dog] = np.nan
        wolf.append(cat[['time', 'code'] + list(fields)])
    fox = pd.concat(wolf, ignore_index=True)
    fox = fox.sort_values(['code', 'time'])
    return fox

def get_factor_values(securities, factors, start_date=None, end_date=None, count=None, **kwargs):
    cat = list(securities) if isinstance(securities, (list, tuple, set, pd.Index)) else [securities]
    koala = list(factors) if isinstance(factors, (list, tuple, set, pd.Index)) else [factors]
    panda = _infer_days_from_args(start_date, end_date, count)
    if not panda:
        return {lion: pd.DataFrame(index=pd.DatetimeIndex([]), columns=cat) for lion in koala}
    fox = {lion: [] for lion in koala}
    otter = []
    for dog in panda:
        tiger = _load_factor_values(dog)
        if tiger is None or tiger.empty or 'code' not in tiger.columns:
            for lion in koala:
                fox[lion].append(np.full(len(cat), np.nan, dtype=float))
            otter.append(pd.to_datetime(dog))
            continue
        tiger = tiger.set_index('code')
        for lion in koala:
            if lion not in tiger.columns:
                fox[lion].append(np.full(len(cat), np.nan, dtype=float))
            else:
                fox[lion].append(pd.to_numeric(tiger[lion], errors='coerce').reindex(cat).values)
        otter.append(pd.to_datetime(dog))
    wolf = {}
    for lion in koala:
        wolf[lion] = pd.DataFrame(np.vstack(fox[lion]), index=pd.DatetimeIndex(otter), columns=cat)
    return wolf

def get_all_alpha_101(date=None, code=None, alpha=None):
    tiger = pd.to_datetime(date).date()
    lion = _load_alpha101(tiger)
    if lion is None or lion.empty:
        return pd.DataFrame()
    lion = lion.copy()
    if 'date' in lion.columns:
        lion = lion.drop(columns=['date'])
    if code is not None and 'code' in lion.columns:
        dog = list(code) if isinstance(code, (list, tuple, set, pd.Index)) else [code]
        lion = lion[lion['code'].isin(dog)]
    if 'code' in lion.columns:
        lion = lion.set_index('code')
    if alpha is not None:
        panda = [cat for cat in alpha if cat in lion.columns]
        lion = lion[panda]
    return lion

def get_all_alpha_191(date=None, code=None, alpha=None):
    tiger = pd.to_datetime(date).date()
    lion = _load_alpha191(tiger)
    if lion is None or lion.empty:
        return pd.DataFrame()
    lion = lion.copy()
    if 'date' in lion.columns:
        lion = lion.drop(columns=['date'])
    if code is not None and 'code' in lion.columns:
        dog = list(code) if isinstance(code, (list, tuple, set, pd.Index)) else [code]
        lion = lion[lion['code'].isin(dog)]
    if 'code' in lion.columns:
        lion = lion.set_index('code')
    if alpha is not None:
        panda = [cat for cat in alpha if cat in lion.columns]
        lion = lion[panda]
    return lion

def get_recent_trade_days(end_date, n):
    cat = get_trade_days(end_date=end_date, count=n)
    return list(cat)

def _zscore_series(s: pd.Series) -> pd.Series:
    s = s.astype(float)
    koala = s.values
    dog = np.isfinite(koala)
    cat = dog.sum()
    if cat == 0:
        return pd.Series(np.nan, index=s.index)
    lion = koala[dog]
    panda = lion.mean()
    if cat == 1:
        fox = np.array([0.0])
    else:
        tiger = lion.std(ddof=1)
        if tiger <= 0 or not np.isfinite(tiger):
            fox = np.zeros_like(lion)
        else:
            fox = (lion - panda) / tiger
    otter = np.full_like(koala, np.nan, dtype=float)
    otter[dog] = fox
    return pd.Series(otter, index=s.index)

def _three_bucket_score(s: pd.Series) -> pd.Series:
    panda = s.dropna()
    tiger = pd.Series(np.nan, index=s.index, dtype='float64')
    if panda.empty:
        return tiger
    cat, dog = panda.quantile([1 / 3, 2 / 3])
    tiger[s < cat] = 1
    tiger[(s >= cat) & (s < dog)] = 2
    tiger[s >= dog] = 3
    return tiger

def _ema_array(x, n):
    cat = 2.0 / (n + 1.0)
    dog = []
    for panda in x:
        if not dog:
            dog.append(panda)
        else:
            dog.append(cat * panda + (1 - cat) * dog[-1])
    return np.array(dog)

def _to_date(date):
    return pd.to_datetime(date).date()

def _make_factor_series(factor_values, date, universe=None, name=None):
    panda = pd.to_datetime(date).date()
    if universe is None:
        dog = sorted(factor_values.keys())
    else:
        dog = list(universe)
    lion = pd.MultiIndex.from_product([[panda], dog], names=['date', 'stock'])
    tiger = [factor_values.get(cat, np.nan) for cat in dog]
    return pd.Series(tiger, index=lion, name=name or 'factor')

def _last_n_trade_days(date, n):
    date = _to_date(date)
    cat = get_trade_days(end_date=date, count=n)
    return list(cat)

def _get_month_end_trade_day(date):
    cat = _to_date(date)
    dog = dt.date(cat.year, cat.month, calendar.monthrange(cat.year, cat.month)[1])
    panda = get_trade_days(start_date=dt.date(cat.year, cat.month, 1), end_date=dog)
    return panda[-1]

def _spearman_corr(x, y):
    x = np.asarray(x, dtype=float)
    y = np.asarray(y, dtype=float)
    cat = np.isfinite(x) & np.isfinite(y)
    if cat.sum() < 2:
        return np.nan
    dog = pd.Series(x[cat]).rank(method='average').values
    panda = pd.Series(y[cat]).rank(method='average').values
    if np.std(dog) == 0 or np.std(panda) == 0:
        return np.nan
    return np.corrcoef(dog, panda)[0, 1]

def _get_daily_close_series(code, start_date, end_date):
    cat = get_price(code, start_date=start_date, end_date=end_date, frequency='daily', fields=['close'], fq='post')
    if cat is None or cat.empty:
        return pd.Series(dtype=float)
    return cat['close']

def _get_intraday_close_series(code, day, freq='1m'):
    panda = day
    dog = day + dt.timedelta(days=1)
    cat = get_price(code, start_date=panda, end_date=dog, frequency=freq, fields=['close'], fq='post')
    if cat is None or cat.empty:
        return pd.Series(dtype=float)
    return cat['close']

def _get_intraday_price_volume(code, day, freq='1m'):
    panda = day
    dog = day + dt.timedelta(days=1)
    cat = get_price(code, start_date=panda, end_date=dog, frequency=freq, fields=['close', 'volume'], fq='post')
    if cat is None or cat.empty:
        return None
    return cat[['close', 'volume']]

def _get_last_month_end(date):
    dog = _to_date(date)
    panda = get_trade_days(end_date=dog, count=40)
    if len(panda) == 0:
        return None
    tiger = {}
    for koala in panda:
        tiger[koala.year, koala.month] = koala
    cat = [lion for lion in tiger.values() if lion <= dog]
    if not cat:
        return None
    return max(cat)

def _get_daily_close_series(code, start_date, end_date):
    cat = get_price(code, start_date=start_date, end_date=end_date, frequency='daily', fields=['close'], fq='post')
    if cat is None or cat.empty:
        return pd.Series(dtype=float)
    return cat['close']

def _get_intraday_close_series(code, day, freq='1m'):
    panda = day
    dog = day + dt.timedelta(days=1)
    cat = get_price(code, start_date=panda, end_date=dog, frequency=freq, fields=['close'], fq='post')
    if cat is None or cat.empty:
        return pd.Series(dtype=float)
    return cat['close']

def _get_intraday_price_volume(code, day, freq='1m'):
    panda = day
    dog = day + dt.timedelta(days=1)
    cat = get_price(code, start_date=panda, end_date=dog, frequency=freq, fields=['close', 'volume'], fq='post')
    if cat is None or cat.empty:
        return None
    return cat[['close', 'volume']]

def _get_intraday_price_amount(code, day, freq='1m'):
    panda = day
    dog = day + dt.timedelta(days=1)
    cat = get_price(code, start_date=panda, end_date=dog, frequency=freq, fields=['close', 'money'], fq='post')
    if cat is None or cat.empty:
        return None
    return cat[['close', 'money']]

def _get_daily_ohlc(code, start_date, end_date):
    cat = get_price(code, start_date=start_date, end_date=end_date, frequency='daily', fields=['high', 'low', 'close'], fq='post')
    return cat if cat is not None else pd.DataFrame()

def _SMA(series, N, M=1):
    series = pd.Series(series, dtype=float)
    cat = []
    panda = None
    for tiger in series:
        if not np.isfinite(tiger):
            cat.append(np.nan)
            continue
        if panda is None:
            dog = tiger
        else:
            dog = (M * tiger + (N - M) * panda) / N
        cat.append(dog)
        panda = dog
    return pd.Series(cat, index=series.index)

def _emd_single_signal(prices, win=30):
    cat = pd.Series(prices, dtype=float)
    dog = cat.rolling(win, min_periods=max(3, win // 3)).mean().bfill().values
    return dog

def _emd_two_signals(prices, win_short=10, win_long=30):
    cat = pd.Series(prices, dtype=float)
    dog = cat.rolling(win_short, min_periods=max(3, win_short // 3)).mean().bfill().values
    panda = cat.rolling(win_long, min_periods=max(3, win_long // 3)).mean().bfill().values
    return (dog, panda)

def _mu_q(q=2.0 / 3.0):
    return 2.0 ** (q / 2.0) * math.gamma((q + 1.0) / 2.0) / math.sqrt(math.pi)

def _norm_cdf(x):
    return 0.5 * (1.0 + math.erf(x / math.sqrt(2.0)))

def _hp_filter(y, lamb=1600.0):
    y = np.asarray(y, dtype=float)
    lion = y.size
    if lion <= 3:
        return (y.copy(), np.zeros_like(y))
    panda = np.eye(lion)
    dog = np.zeros((lion - 2, lion))
    for tiger in range(lion - 2):
        dog[tiger, tiger] = 1.0
        dog[tiger, tiger + 1] = -2.0
        dog[tiger, tiger + 2] = 1.0
    cat = lamb * dog.T.dot(dog)
    koala = np.linalg.solve(panda + cat, y)
    otter = y - koala
    return (koala, otter)

def _r3_safe_date(d):
    try:
        return _to_date(d)
    except Exception:
        return pd.to_datetime(d).date()

def _r3_fundamentals(table, fields, universe, *, date=None, statDate=None) -> pd.DataFrame:
    dog = _norm_universe(universe)
    fox: List[str] = []
    for tiger in fields or []:
        lion = getattr(tiger, 'name', None)
        if lion is None:
            lion = str(tiger)
        fox.append(str(lion))
    if len(dog) == 0:
        return pd.DataFrame(index=pd.Index([], name='code'), columns=fox)
    try:
        otter = query(table.code, *fields).filter(table.code.in_(dog))
        if date is not None:
            panda = get_fundamentals(otter, date=_to_date(date))
        else:
            panda = get_fundamentals(otter, statDate=statDate)
    except Exception:
        panda = None
    if panda is None or panda.empty or 'code' not in panda.columns:
        koala = pd.DataFrame(index=pd.Index(dog, name='code'), columns=fox)
        return koala
    panda = panda.copy()
    panda['code'] = panda['code'].astype(str)
    panda = panda.set_index('code')
    for cat in fox:
        if cat not in panda.columns:
            panda[cat] = np.nan
    panda = panda.reindex(dog)
    return panda

def _r3_join_code(universe, *dfs):
    dog = list(universe)
    cat = pd.DataFrame(index=pd.Index(dog, name='code'))
    for panda in dfs:
        if panda is None or panda.empty:
            continue
        if panda.index.name != 'code':
            if 'code' in panda.columns:
                panda = panda.set_index('code')
            else:
                continue
        cat = cat.join(panda, how='left')
    return cat

def _r3_get_price_panel(securities, *, start_date, end_date, frequency, fields, fq='post', panel=False):
    try:
        cat = get_price(securities, start_date=start_date, end_date=end_date, frequency=frequency, fields=fields, fq=fq, panel=panel)
    except TypeError:
        cat = get_price(securities, start_date=start_date, end_date=end_date, frequency=frequency, fields=fields, fq=fq)
    except Exception:
        cat = None
    if cat is None or cat.empty:
        return pd.DataFrame(columns=['time', 'code'] + list(fields))
    cat = cat.copy()
    if 'time' not in cat.columns:
        cat['time'] = cat.index
    if 'code' not in cat.columns:
        cat = cat.reset_index().rename(columns={'index': 'time'})
        if 'code' not in cat.columns:
            return pd.DataFrame(columns=['time', 'code'] + list(fields))
    cat['time'] = pd.to_datetime(cat['time'])
    return cat

def _r3_batch_call_auction_last_volume(universe_list, start_date, end_date, window_dates, chunk_size=300):
    universe_list = list(universe_list)
    window_dates = list(window_dates)
    koala = pd.DataFrame(index=window_dates, columns=universe_list, dtype='float64')
    dog = max(1, int(chunk_size))
    for lion in range(0, len(universe_list), dog):
        cat = universe_list[lion:lion + dog]
        try:
            panda = get_call_auction(cat, start_date=start_date, end_date=end_date, fields=['time', 'volume'])
        except Exception:
            panda = None
        if panda is None or panda.empty:
            continue
        panda = panda.copy()
        if 'time' not in panda.columns:
            panda = panda.reset_index()
            if 'time' not in panda.columns:
                if 'index' in panda.columns:
                    panda = panda.rename(columns={'index': 'time'})
                else:
                    continue
        tiger = None
        if 'code' in panda.columns:
            tiger = 'code'
        elif 'security' in panda.columns:
            tiger = 'security'
        elif 'symbol' in panda.columns:
            tiger = 'symbol'
        else:
            panda = panda.reset_index()
            if 'code' in panda.columns:
                tiger = 'code'
            elif 'security' in panda.columns:
                tiger = 'security'
            elif 'symbol' in panda.columns:
                tiger = 'symbol'
            else:
                continue
        panda['time'] = pd.to_datetime(panda['time'])
        panda['date'] = panda['time'].dt.date
        panda = panda[panda['date'].isin(window_dates)]
        if panda.empty or 'volume' not in panda.columns:
            continue
        panda['volume'] = pd.to_numeric(panda['volume'], errors='coerce')
        panda = panda.dropna(subset=['volume'])
        if panda.empty:
            continue
        panda = panda.sort_values('time')
        fox = panda.groupby(['date', tiger], sort=False)['volume'].last()
        otter = fox.unstack(tiger).reindex(index=window_dates, columns=cat)
        koala.loc[:, cat] = otter
    return koala

def _r3_chunks(seq, n):
    for cat in range(0, len(seq), n):
        yield seq[cat:cat + n]

def _r3_get_price_long(securities, start_date, end_date, frequency, fields, fq='post', panel=False, batch_size=800):
    lion = list(securities)
    tiger = []
    for cat in _r3_chunks(lion, int(batch_size)):
        try:
            dog = get_price(cat, start_date=start_date, end_date=end_date, frequency=frequency, fields=list(fields), fq=fq, panel=panel)
        except TypeError:
            dog = get_price(cat, start_date=start_date, end_date=end_date, frequency=frequency, fields=list(fields), fq=fq)
        except Exception:
            dog = None
        if dog is None or getattr(dog, 'empty', True):
            continue
        dog = dog.copy()
        if 'time' not in dog.columns:
            dog = dog.reset_index().rename(columns={'index': 'time'})
        if 'code' not in dog.columns:
            if 'security' in dog.columns:
                dog = dog.rename(columns={'security': 'code'})
            else:
                continue
        dog['time'] = pd.to_datetime(dog['time'])
        panda = ['time', 'code'] + list(fields)
        tiger.append(dog[panda])
    if not tiger:
        return pd.DataFrame(columns=['time', 'code'] + list(fields))
    return pd.concat(tiger, ignore_index=True)

def _r3_pivot_daily(df_long, field, date_index, codes):
    if df_long is None or df_long.empty:
        return pd.DataFrame(index=date_index, columns=codes, dtype='float64')
    cat = df_long.copy()
    cat['date'] = cat['time'].dt.normalize()
    cat[field] = pd.to_numeric(cat[field], errors='coerce')
    dog = cat.pivot_table(index='date', columns='code', values=field, aggfunc='last')
    return dog.reindex(index=date_index, columns=codes)

def _r3_sma_2d(x2d, N, M=1):
    bear = np.asarray(x2d, dtype=float)
    if bear.ndim != 2:
        bear = np.atleast_2d(bear)
    dog, cat = bear.shape
    koala = np.full((dog, cat), np.nan, dtype=float)
    otter = np.full(cat, np.nan, dtype=float)
    tiger = np.zeros(cat, dtype=bool)
    for fox in range(dog):
        rabbit = bear[fox]
        panda = np.isfinite(rabbit)
        lion = panda & ~tiger
        if lion.any():
            otter[lion] = rabbit[lion]
            tiger[lion] = True
            koala[fox, lion] = otter[lion]
        wolf = panda & tiger & ~lion
        if wolf.any():
            otter[wolf] = (M * rabbit[wolf] + (N - M) * otter[wolf]) / N
            koala[fox, wolf] = otter[wolf]
    return koala

def _r3_merge_history_fundamentals(*dfs):
    lion = []
    for panda in dfs:
        if panda is None or getattr(panda, 'empty', True):
            continue
        dog = panda.copy()
        if 'code' not in dog.columns:
            dog = dog.reset_index()
        if 'statDate' not in dog.columns:
            continue
        dog['statDate'] = pd.to_datetime(dog['statDate'])
        dog = dog.drop_duplicates(subset=['code', 'statDate'])
        lion.append(dog)
    if not lion:
        return None
    cat = lion[0]
    for dog in lion[1:]:
        tiger = (set(cat.columns) & set(dog.columns)) - {'code', 'statDate'}
        if tiger:
            dog = dog.drop(columns=list(tiger))
        cat = cat.merge(dog, on=['code', 'statDate'], how='outer')
    return cat

def _norm_universe(universe: Sequence[str]) -> List[str]:
    dog = set()
    cat = []
    for panda in universe:
        if panda not in dog:
            dog.add(panda)
            cat.append(panda)
    return cat

def _resolve_trade_day(date=None):
    if date is None:
        dog = _all_trade_days()
        return dog[-1] if dog else None
    cat = _to_date(date)
    try:
        panda = get_trade_days(end_date=cat, count=1)
        if panda:
            return pd.to_datetime(panda[0]).date()
    except Exception:
        pass
    return cat
otter = get_industry

def get_industry(security=None, date=None, df=True):
    lion = _resolve_trade_day(date)
    if lion is None:
        return pd.DataFrame() if df else {}
    koala = _load_industry(lion)
    if koala is None or len(koala) == 0:
        return pd.DataFrame() if df else {}
    koala = koala.copy()
    if 'code' in koala.columns:
        koala['code'] = koala['code'].astype(str)
    tiger = None
    if security is not None:
        if isinstance(security, str):
            tiger = [security]
        else:
            tiger = _norm_universe(security)
        if 'code' in koala.columns:
            koala = koala[koala['code'].isin(tiger)]
    if df:
        return koala
    dog = tiger if tiger is not None else koala['code'].unique().tolist()
    otter = {panda: {} for panda in dog}
    for cat, fox in koala.iterrows():
        panda = str(fox.get('code', ''))
        wolf = str(fox.get('type', ''))
        if panda == '' or wolf == '':
            continue
        otter.setdefault(panda, {})
        otter[panda][wolf] = {'industry_code': fox.get('industry_code', None), 'industry_name': fox.get('industry_name', None)}
    return otter

def get_industries(name=None, date=None):
    dog = _resolve_trade_day(date)
    if dog is None:
        return pd.DataFrame()
    panda = _load_industry(dog)
    if panda is None or len(panda) == 0:
        return pd.DataFrame()
    panda = panda.copy()
    if 'type' in panda.columns and name is not None:
        panda = panda[panda['type'] == name]
    if 'industry_code' not in panda.columns:
        return pd.DataFrame()
    cat = ['industry_code']
    if 'industry_name' in panda.columns:
        cat.append('industry_name')
    tiger = panda[cat].drop_duplicates().copy()
    if 'industry_name' not in tiger.columns:
        tiger['industry_name'] = None
    tiger = tiger.set_index('industry_code', drop=True).sort_index()
    return tiger

class _SecurityInfoLite(object):
    __slots__ = ('start_date', 'end_date')

    def __init__(self, start_date=None, end_date=None):
        self.start_date = start_date
        self.end_date = end_date
tiger = {}
lion = Path(dog) / '_cache' / 'security_info.parquet'

def _load_security_info_cache():
    global tiger
    if tiger:
        return
    try:
        if lion.exists():
            panda = pd.read_parquet(lion)
            if isinstance(panda, pd.DataFrame) and len(panda) > 0 and ('code' in panda.columns):
                for cat, lion in panda.iterrows():
                    dog = str(lion['code'])
                    koala = lion.get('start_date', None)
                    tiger = lion.get('end_date', None)
                    koala = pd.to_datetime(koala).date() if pd.notna(koala) else None
                    tiger = pd.to_datetime(tiger).date() if pd.notna(tiger) else None
                    tiger[dog] = _SecurityInfoLite(koala, tiger)
    except Exception:
        return

def _save_security_info_cache():
    try:
        if not tiger:
            return
        lion.parent.mkdir(parents=True, exist_ok=True)
        panda = []
        for cat, dog in tiger.items():
            panda.append({'code': cat, 'start_date': dog.start_date, 'end_date': dog.end_date})
        pd.DataFrame(panda).to_parquet(lion, index=False)
    except Exception:
        return

def prefetch_security_info(codes, asof_date=None):
    _load_security_info_cache()
    if codes is None:
        return
    codes = _norm_universe([str(cat) for cat in codes])
    otter = [cat for cat in codes if cat not in tiger]
    if not otter:
        return
    panda = _resolve_trade_day(asof_date) if asof_date is not None else _resolve_trade_day(panda if '_ASOF_DATE' in globals() else None)
    if panda is None:
        for cat in otter:
            tiger[cat] = _SecurityInfoLite(None, None)
        _save_security_info_cache()
        return
    tiger = [dog for dog in _all_trade_days() if dog <= panda]
    if not tiger:
        for cat in otter:
            tiger[cat] = _SecurityInfoLite(None, None)
        _save_security_info_cache()
        return
    bear = set(otter)
    for dog in tiger:
        if not bear:
            break
        try:
            fox = _path('get_price_stock', 'daily', f'{dog}.parquet')
            if not fox.exists():
                continue
            lion = pd.read_parquet(fox, columns=['code'])
            if lion is None or len(lion) == 0 or 'code' not in lion.columns:
                continue
            wolf = set(lion['code'].astype(str).tolist())
            koala = bear & wolf
            if koala:
                for cat in koala:
                    tiger[cat] = _SecurityInfoLite(dog, None)
                bear -= koala
        except Exception:
            continue
    for cat in bear:
        tiger[cat] = _SecurityInfoLite(None, None)
    _save_security_info_cache()

def get_security_info(security):
    if security is None:
        return None
    cat = str(security)
    _load_security_info_cache()
    if cat not in tiger:
        prefetch_security_info([cat], asof_date=panda if '_ASOF_DATE' in globals() else None)
    return tiger.get(cat, _SecurityInfoLite(None, None))
koala = get_fundamentals

def get_fundamentals(q, date=None, statDate=None):
    dog = koala(q, date=date, statDate=statDate)
    if dog is None:
        dog = pd.DataFrame()
    try:
        lion = []
        if hasattr(q, 'select_items'):
            for panda in getattr(q, 'select_items', []):
                tiger = getattr(panda, 'name', None)
                if tiger and str(tiger) != 'code':
                    lion.append(str(tiger))
        lion = list(dict.fromkeys(lion))
        for cat in lion:
            if cat not in dog.columns:
                dog[cat] = np.nan
    except Exception:
        return dog
    return dog

def _safe_factor_last_row(fac_dict, factor_name, universe):
    panda = _norm_universe(universe)
    try:
        cat = fac_dict.get(factor_name, None) if isinstance(fac_dict, dict) else None
        if isinstance(cat, pd.DataFrame) and len(cat) > 0:
            dog = cat.iloc[-1]
            dog.index = dog.index.astype(str)
            dog = pd.to_numeric(dog, errors='coerce')
            return dog.reindex(panda)
    except Exception:
        pass
    return pd.Series(np.nan, index=panda, dtype='float64')

def factor1(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1')

def factor2(universe, date, L=20):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, int(L))
    if len(koala) == 0:
        return _make_factor_series({cat: np.nan for cat in universe}, date, universe=universe, name='factor2')
    giraffe = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(koala[-1]).strftime('%Y-%m-%d')
    tiger = list(universe)
    otter = get_price(tiger, start_date=giraffe, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({cat: np.nan for cat in tiger}, date, universe=universe, name='factor2')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    if 'code' not in otter.columns:
        return _make_factor_series({cat: np.nan for cat in tiger}, date, universe=universe, name='factor2')
    dog = otter.pivot(index='time', columns='code', values='close').sort_index()
    dog = dog.reindex(columns=tiger).astype(float)
    bear = dog.mean(axis=0, skipna=True)
    panda = dog.iloc[-1]
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = bear / panda
    rabbit = rabbit.replace([np.inf, -np.inf], np.nan)
    zebra = _zscore_series(rabbit)
    wolf = {cat: float(zebra.get(cat, np.nan)) if np.isfinite(zebra.get(cat, np.nan)) else np.nan for cat in tiger}
    return _make_factor_series(wolf, date, universe=universe, name='factor2')

def factor3(universe, date, d=20, alpha=0.5, batch_size=200):
    _set_asof_date(date)
    bear = _to_date(date)
    cat = get_trade_days(end_date=bear, count=int(d) + 1)
    if len(cat) <= 1:
        return _make_factor_series({wolf: np.nan for wolf in universe}, date, universe=universe, name='factor3')
    llama = list(cat[:-1])
    kangaroo = [pd.to_datetime(mole).date() for mole in llama]
    donkey = pd.to_datetime(llama[0]).strftime('%Y-%m-%d')
    zebra = pd.to_datetime(llama[-1]).strftime('%Y-%m-%d')
    giraffe = (pd.to_datetime(zebra) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    jaguar = list(universe)
    alpha = float(alpha)
    rabbit = get_price(jaguar, start_date=donkey, end_date=zebra, frequency='daily', fields=['volume'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({wolf: np.nan for wolf in jaguar}, date, universe=universe, name='factor3')
    rabbit = rabbit.copy()
    if 'time' not in rabbit.columns:
        rabbit = rabbit.reset_index()
    if 'code' not in rabbit.columns:
        return _make_factor_series({wolf: np.nan for wolf in jaguar}, date, universe=universe, name='factor3')
    rabbit['time'] = pd.to_datetime(rabbit['time'])
    rabbit['date'] = rabbit['time'].dt.date
    rabbit = rabbit[['code', 'date', 'volume']].dropna(subset=['volume'])
    rabbit['volume'] = pd.to_numeric(rabbit['volume'], errors='coerce')
    rabbit = rabbit.dropna(subset=['volume'])
    iguana = rabbit.groupby(['date', 'code'], sort=False)['volume'].sum().unstack('code').reindex(index=kangaroo, columns=jaguar)
    alpaca = []
    fox = []
    tiger = max(1, int(batch_size))
    for shark in range(0, len(jaguar), tiger):
        dog = jaguar[shark:shark + tiger]
        try:
            eagle = get_price(dog, start_date=donkey, end_date=giraffe, frequency='1m', fields=['volume'], fq='post', panel=False)
        except Exception:
            eagle = None
        if eagle is None or eagle.empty:
            continue
        eagle = eagle.copy()
        if 'time' not in eagle.columns:
            eagle = eagle.reset_index()
        if 'code' not in eagle.columns or 'volume' not in eagle.columns:
            continue
        eagle['time'] = pd.to_datetime(eagle['time'])
        eagle['date'] = eagle['time'].dt.date
        eagle = eagle[eagle['date'].isin(kangaroo)]
        if eagle.empty:
            continue
        eagle['volume'] = pd.to_numeric(eagle['volume'], errors='coerce')
        eagle = eagle.dropna(subset=['volume'])
        if eagle.empty:
            continue
        whale = eagle['time'].dt.hour
        owl = eagle['time'].dt.minute
        sparrow = (whale == 9) & (owl >= 30) & (owl <= 34)
        if sparrow.any():
            ferret = eagle.loc[sparrow, ['date', 'code', 'volume']].groupby(['date', 'code'], sort=False)['volume'].sum().rename('open5').reset_index()
            alpaca.append(ferret)
        hawk = (whale == 14) & (owl >= 55) & (owl <= 59)
        if hawk.any():
            ferret = eagle.loc[hawk, ['date', 'code', 'volume']].groupby(['date', 'code'], sort=False)['volume'].sum().rename('close5').reset_index()
            fox.append(ferret)
    if alpaca:
        tuna = pd.concat(alpaca, ignore_index=True)
        lemur = tuna.pivot(index='date', columns='code', values='open5').reindex(index=kangaroo, columns=jaguar)
    else:
        lemur = pd.DataFrame(index=kangaroo, columns=jaguar, dtype='float64')
    if fox:
        otter = pd.concat(fox, ignore_index=True)
        koala = otter.pivot(index='date', columns='code', values='close5').reindex(index=kangaroo, columns=jaguar)
    else:
        koala = pd.DataFrame(index=kangaroo, columns=jaguar, dtype='float64')
    salmon = _r3_batch_call_auction_last_volume(jaguar, start_date=donkey, end_date=zebra, window_dates=kangaroo, chunk_size=tiger)
    if salmon is None or salmon.empty or salmon.isna().all().all():
        badger = lemur.fillna(0.0)
    else:
        badger = salmon.copy()
        badger = badger.where(~badger.isna(), lemur)
        badger = badger.fillna(0.0)
    dolphin = {}
    for wolf in jaguar:
        gecko = iguana.get(wolf, pd.Series(index=kangaroo, dtype='float64')).reindex(kangaroo)
        gecko = pd.to_numeric(gecko, errors='coerce').astype(float)
        turtle = pd.to_numeric(badger.get(wolf, pd.Series(index=kangaroo, dtype='float64')), errors='coerce').astype(float).reindex(kangaroo).fillna(0.0)
        lion = pd.to_numeric(koala.get(wolf, pd.Series(index=kangaroo, dtype='float64')), errors='coerce').astype(float).reindex(kangaroo).fillna(0.0)
        hyena = gecko.replace(0.0, np.nan)
        camel = (turtle / hyena).replace([np.inf, -np.inf], np.nan).fillna(0.0)
        beaver = (lion / hyena).replace([np.inf, -np.inf], np.nan).fillna(0.0)
        frog = float(camel.mean()) if camel.size > 0 else np.nan
        panda = float(beaver.mean()) if beaver.size > 0 else np.nan
        lizard = alpha * frog + (1.0 - alpha) * panda
        dolphin[wolf] = float(lizard) if np.isfinite(lizard) else np.nan
    return _make_factor_series(dolphin, date, universe=universe, name='factor3')

def factor4(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    panda = _r3_safe_date(date)
    koala = _r3_fundamentals(rabbit, [rabbit.roe, rabbit.roa, rabbit.term_029, rabbit.term_034, rabbit.term_032, rabbit.term_033, rabbit.term_058], dog, date=panda)
    lion = _r3_fundamentals(fox, [fox.term_084, fox.term_081, fox.term_044], dog, date=panda)
    tiger = _r3_join_code(dog, koala, lion)
    if tiger is None or tiger.empty:
        return _make_factor_series({cat: np.nan for cat in dog}, date, universe=universe, name='factor4')
    rabbit = tiger[['roe', 'roa', 'term_029']].astype(float)
    fox = tiger[['term_034', 'term_032', 'term_033']].astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = pd.to_numeric(tiger.get('term_084', np.nan), errors='coerce') / pd.to_numeric(tiger.get('term_081', np.nan), errors='coerce')
        bear = pd.to_numeric(tiger.get('term_044', np.nan), errors='coerce') / pd.to_numeric(tiger.get('term_081', np.nan), errors='coerce')
    dolphin = pd.DataFrame({'neg_leverage_total': -wolf, 'neg_leverage_long': -bear, 'term_058': pd.to_numeric(tiger.get('term_058', np.nan), errors='coerce')}, index=tiger.index)
    shark = rabbit.apply(_zscore_series, axis=0)
    whale = fox.apply(_zscore_series, axis=0)
    eagle = dolphin.apply(_zscore_series, axis=0)
    giraffe = shark.mean(axis=1, skipna=True) + whale.mean(axis=1, skipna=True) + eagle.mean(axis=1, skipna=True)
    zebra = _zscore_series(giraffe)
    otter = {cat: float(zebra.get(cat, np.nan)) if np.isfinite(zebra.get(cat, np.nan)) else np.nan for cat in dog}
    return _make_factor_series(otter, date, universe=universe, name='factor4')

def factor5(universe, date, window=252, mkt_index='000905.XSHG'):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, window + 1)
    if len(otter) < window + 1:
        return _make_factor_series({}, date, universe=universe, name='factor5')
    alpaca = otter[0]
    bear = otter[-1]
    zebra = _get_daily_close_series(mkt_index, alpaca, bear)
    if zebra is None or zebra.size < 2:
        return _make_factor_series({}, date, universe=universe, name='factor5')
    zebra = zebra.sort_index()
    hawk = zebra.pct_change().dropna()
    if hawk.size < max(10, window // 2):
        return _make_factor_series({}, date, universe=universe, name='factor5')
    shark = float(hawk.mean())
    whale = hawk < shark
    owl = hawk[whale]
    if owl.size < 10:
        return _make_factor_series({}, date, universe=universe, name='factor5')
    camel = float(owl.var(ddof=1))
    if not np.isfinite(camel) or camel <= 0:
        return _make_factor_series({}, date, universe=universe, name='factor5')
    badger = list(universe)
    lemur = pd.to_datetime(alpaca).strftime('%Y-%m-%d')
    rabbit = pd.to_datetime(bear).strftime('%Y-%m-%d')
    fox = get_price(badger, start_date=lemur, end_date=rabbit, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor5')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index()
    if 'code' not in fox.columns:
        return _make_factor_series({}, date, universe=universe, name='factor5')
    dog = fox.pivot(index='time', columns='code', values='close').sort_index()
    eagle = dog.pct_change()
    tiger = eagle.index.intersection(hawk.index)
    if tiger.size < max(10, window // 2):
        return _make_factor_series({}, date, universe=universe, name='factor5')
    sparrow = hawk.reindex(tiger)
    wolf = (sparrow < shark) & np.isfinite(sparrow.values)
    if wolf.sum() < 10:
        return _make_factor_series({}, date, universe=universe, name='factor5')
    tuna = sparrow.values.astype(float)[wolf]
    beaver = float(np.var(tuna, ddof=1))
    if not np.isfinite(beaver) or beaver <= 0:
        return _make_factor_series({}, date, universe=universe, name='factor5')
    giraffe = {}
    for panda in badger:
        if panda not in eagle.columns:
            continue
        lizard = eagle[panda].reindex(tiger)
        frog = lizard.values.astype(float)
        dolphin = wolf & np.isfinite(frog)
        if dolphin.sum() < 10:
            continue
        turtle = frog[dolphin]
        salmon = sparrow.values.astype(float)[dolphin]
        lion = float(np.cov(turtle, salmon, ddof=1)[0, 1])
        if not np.isfinite(lion):
            continue
        cat = lion / beaver
        if np.isfinite(cat):
            giraffe[panda] = float(cat)
    return _make_factor_series(giraffe, date, universe=universe, name='factor5')

def factor6(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    tiger = list(universe)

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])
    lizard = _nearest_td_le(koala)
    frog = _nearest_td_le((cat - DateOffset(years=1)).date())
    if lizard is None or frog is None:
        return _make_factor_series({panda: np.nan for panda in tiger}, koala, universe=universe, name='factor6')
    dolphin = pd.Series(np.nan, index=tiger, dtype='float64')
    try:
        rabbit = get_factor_values(tiger, factors=['np_parent_company_owners_ttm'], end_date=lizard, count=1)
        otter = rabbit.get('np_parent_company_owners_ttm', None) if isinstance(rabbit, dict) else None
        if isinstance(otter, pd.DataFrame) and (not otter.empty):
            turtle = otter.iloc[-1]
            turtle.index = turtle.index.astype(str)
            turtle = pd.to_numeric(turtle, errors='coerce').astype(float)
            dolphin = turtle.reindex(tiger)
    except Exception:
        pass
    if dolphin.notna().sum() < 10:
        sparrow = pd.Period(cat, freq='Q-DEC') - 1
        owl = pd.PeriodIndex([sparrow, sparrow - 1, sparrow - 2, sparrow - 3], freq='Q-DEC')
        fox = get_history_fundamentals(security=tiger, fields=[bear.np_parent_company_owners], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        if fox is None or fox.empty:
            return _make_factor_series({panda: np.nan for panda in tiger}, koala, universe=universe, name='factor6')
        lion = fox.copy()
        if 'pubDate' in lion.columns:
            shark = pd.to_datetime(lion['pubDate'], errors='coerce')
            lion = lion[shark.notna() & (shark <= cat)]
        lion['code'] = lion['code'].astype(str)
        lion['statDate'] = pd.to_datetime(lion['statDate'], errors='coerce')
        lion = lion.dropna(subset=['code', 'statDate'])
        if lion.empty or 'np_parent_company_owners' not in lion.columns:
            return _make_factor_series({panda: np.nan for panda in tiger}, koala, universe=universe, name='factor6')
        lion['q'] = lion['statDate'].dt.to_period('Q-DEC')
        lion = lion[lion['q'].isin(owl)]
        if lion.empty:
            return _make_factor_series({panda: np.nan for panda in tiger}, koala, universe=universe, name='factor6')
        lion = lion.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        eagle = lion.pivot(index='q', columns='code', values='np_parent_company_owners').reindex(index=owl, columns=tiger)
        eagle = eagle.apply(pd.to_numeric, errors='coerce').astype(float)
        dolphin = eagle.sum(axis=0, min_count=2).reindex(tiger)
    hawk = query(fox.code, fox.equities_parent_company_owners).filter(fox.code.in_(tiger))

    def _equity_on(td_):
        cat = get_fundamentals(q_bal, date=td_.strftime('%Y-%m-%d'))
        if cat is None or cat.empty or 'code' not in cat.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        cat = cat.copy()
        cat['code'] = cat['code'].astype(str)
        dog = pd.to_numeric(cat.set_index('code').get('equities_parent_company_owners', np.nan), errors='coerce').astype(float)
        return dog.reindex(codes)
    wolf = _equity_on(lizard)
    bear = _equity_on(frog)
    with np.errstate(divide='ignore', invalid='ignore'):
        dog = (wolf + bear) / 2.0
        whale = dolphin / dog
    zebra = ~np.isfinite(whale) | ~np.isfinite(dolphin) | ~np.isfinite(dog) | (dog == 0)
    whale = whale.where(~zebra, np.nan).reindex(tiger)
    giraffe = {panda: float(whale.get(panda)) if np.isfinite(whale.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(giraffe, koala, universe=universe, name='factor6')

def factor7(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = get_history_fundamentals(security=universe, fields=[fox.term_082, fox.term_012, fox.term_083, fox.term_056], watch_date=otter, count=5, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor7')
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    bear = {}
    for koala in universe:
        fox = wolf[wolf['code'] == koala].copy()
        if fox.shape[0] < 5:
            continue
        fox = fox.sort_values('statDate').drop_duplicates('statDate')
        if fox.shape[0] < 5:
            continue
        tiger = fox['term_082'].astype(float).values
        lion = fox['term_012'].astype(float).values
        giraffe = fox['term_083'].astype(float).values
        zebra = fox['term_056'].astype(float).values
        cat = tiger - lion - (giraffe - zebra)
        panda = cat[-1]
        dog = cat[-5]
        if not np.isfinite(panda) or not np.isfinite(dog) or dog == 0:
            continue
        rabbit = (panda - dog) / abs(dog)
        if np.isfinite(rabbit):
            bear[koala] = float(rabbit)
    return _make_factor_series(bear, date, universe=universe, name='factor7')

def factor8(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor8')

def factor9(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    wolf = get_history_fundamentals(security=universe, fields=[wolf.term_010], watch_date=koala, count=1, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor9')
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    wolf = wolf.sort_values('statDate').drop_duplicates(['code'], keep='last').set_index('code')
    fox = get_history_fundamentals(security=universe, fields=[fox.term_081], watch_date=koala, count=5, interval='1q', stat_by_year=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor9')
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    bear = {}
    for lion in universe:
        if lion not in wolf.index:
            continue
        tiger = float(wolf.at[lion, 'term_010'])
        if not np.isfinite(tiger) or tiger < 0:
            continue
        otter = fox[fox['code'] == lion].copy()
        if otter.shape[0] < 5:
            continue
        otter = otter.sort_values('statDate').drop_duplicates('statDate')
        if otter.shape[0] < 5:
            continue
        rabbit = otter['term_081'].astype(float).values
        dog = rabbit[-1]
        cat = rabbit[-5]
        if not (np.isfinite(dog) and np.isfinite(cat)):
            continue
        panda = 0.5 * (dog + cat)
        if panda <= 0:
            continue
        giraffe = tiger / panda
        if np.isfinite(giraffe):
            bear[lion] = float(giraffe)
    return _make_factor_series(bear, date, universe=universe, name='factor9')

def factor10(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    alpaca = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(lion))
    giraffe = get_fundamentals(alpaca, date=cat.strftime('%Y-%m-%d'))
    if giraffe is None or giraffe.empty or 'code' not in giraffe.columns:
        hawk = pd.Series(np.nan, index=lion, dtype='float64')
    else:
        giraffe = giraffe.copy()
        giraffe['code'] = giraffe['code'].astype(str)
        hawk = pd.to_numeric(giraffe.set_index('code').get('term_045', np.nan), errors='coerce').reindex(lion).astype(float)
    if hawk.notna().sum() < 10:
        return _make_factor_series({panda: np.nan for panda in lion}, koala, universe=universe, name='factor10')
    turtle = pd.Series(np.nan, index=lion, dtype='float64')
    whale = pd.Series(np.nan, index=lion, dtype='float64')
    try:
        zebra = get_factor_values(lion, factors=['term_053', 'asset_impairment_loss_ttm'], end_date=cat.strftime('%Y-%m-%d'), count=1)
        rabbit = zebra.get('term_053', None)
        wolf = zebra.get('asset_impairment_loss_ttm', None)
        if isinstance(rabbit, pd.DataFrame) and (not rabbit.empty):
            beaver = rabbit.iloc[-1]
            turtle = pd.to_numeric(beaver.reindex(lion), errors='coerce').astype(float)
        if isinstance(wolf, pd.DataFrame) and (not wolf.empty):
            beaver = wolf.iloc[-1]
            whale = pd.to_numeric(beaver.reindex(lion), errors='coerce').astype(float)
    except Exception:
        pass
    tiger = 8
    bear = get_history_fundamentals(security=lion, fields=[bear.term_052, bear.asset_impairment_loss, bear.term_072], watch_date=cat, count=tiger, interval='1q', stat_by_year=False)
    if bear is None:
        bear = pd.DataFrame(columns=['code', 'statDate', 'pubDate'])
    fox = get_history_fundamentals(security=lion, fields=[fox.term_015, fox.term_016], watch_date=cat, count=tiger, interval='1q', stat_by_year=False)
    if fox is None:
        fox = pd.DataFrame(columns=['code', 'statDate', 'pubDate'])

    def _filter_pub(df):
        if df is None or df.empty:
            return df
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        return cat
    bear = _filter_pub(bear)
    fox = _filter_pub(fox)

    def _to_q_last(df):
        if df is None or df.empty or 'code' not in df.columns or ('statDate' not in df.columns):
            return None
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    eagle = _to_q_last(bear)
    dog = _to_q_last(fox)

    def _sum_last4(dq, colname):
        if dq is None or colname not in dq.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        cat = dq.pivot(index='q', columns='code', values=colname).sort_index()
        cat = cat.reindex(columns=codes)
        cat = cat.apply(pd.to_numeric, errors='coerce').astype(float)
        dog = cat.tail(4)
        return dog.sum(axis=0, min_count=2)
    lizard = _sum_last4(eagle, 'term_052')
    shark = _sum_last4(eagle, 'asset_impairment_loss')
    badger = _sum_last4(eagle, 'term_072').fillna(0.0)
    turtle = turtle.where(turtle.notna(), lizard)
    whale = whale.where(whale.notna(), shark).fillna(0.0)
    otter = pd.Series(np.nan, index=lion, dtype='float64')
    if dog is not None and ('term_015' in dog.columns or 'term_016' in dog.columns):
        frog = dog.pivot(index='q', columns='code', values='term_015') if 'term_015' in dog.columns else None
        salmon = dog.pivot(index='q', columns='code', values='term_016') if 'term_016' in dog.columns else None
        if frog is not None:
            frog = frog.sort_index().reindex(columns=lion).apply(pd.to_numeric, errors='coerce').astype(float)
        if salmon is not None:
            salmon = salmon.sort_index().reindex(columns=lion).apply(pd.to_numeric, errors='coerce').astype(float)
        if frog is None:
            frog = pd.DataFrame(np.nan, index=salmon.index if salmon is not None else [], columns=lion)
        if salmon is None:
            salmon = pd.DataFrame(np.nan, index=frog.index if frog is not None else [], columns=lion)
        tuna = salmon - frog
        tuna = tuna.sort_index()
        if tuna.shape[0] >= 5:
            sparrow = tuna.tail(1).iloc[0]
            owl = tuna.tail(5).iloc[0]
            otter = (sparrow - owl).astype(float)
    otter = otter.replace([np.inf, -np.inf], np.nan).fillna(0.0)
    camel = turtle + whale + badger + otter
    camel = camel.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        lemur = camel / hawk
    lemur = lemur.replace([np.inf, -np.inf], np.nan)
    dolphin = {panda: float(lemur.loc[panda]) if np.isfinite(lemur.loc[panda]) else np.nan for panda in lion}
    return _make_factor_series(dolphin, koala, universe=universe, name='factor10')

def factor11(universe, date, N=8):
    _set_asof_date(date)
    lion = list(universe)
    whale = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    shark = [whale - giraffe for giraffe in range(N - 1, -1, -1)]
    salmon = [f'{eagle.year}q{eagle.quarter}' for eagle in shark]
    turtle = pd.DataFrame(index=lion, columns=salmon, dtype='float64')
    fox = pd.DataFrame(index=lion, columns=salmon, dtype='float64')
    for frog in salmon:
        hawk = query(bear.code, bear.term_066, bear.term_060).filter(bear.code.in_(lion))
        wolf = get_fundamentals(hawk, statDate=frog)
        if wolf is None or wolf.empty:
            continue
        wolf = wolf.set_index('code')
        sparrow = wolf['term_066']
        koala = wolf['term_060']
        owl = _zscore_series(sparrow).reindex(lion)
        otter = _zscore_series(koala).reindex(lion)
        turtle[frog] = owl
        fox[frog] = otter
    tuna = [lizard for lizard in salmon if not (turtle[lizard].isna().all() or fox[lizard].isna().all())]
    if len(tuna) < 2:
        rabbit = {panda: np.nan for panda in lion}
        return _make_factor_series(rabbit, date, universe=universe, name='factor11')
    zebra = tuna[-1]
    rabbit = {}
    for tiger in lion:
        beaver = turtle.loc[tiger, tuna].values.astype(float)
        alpaca = fox.loc[tiger, tuna].values.astype(float)
        dolphin = np.isfinite(alpaca) & np.isfinite(beaver)
        badger = alpaca[dolphin]
        donkey = beaver[dolphin]
        if badger.size < 2:
            rabbit[tiger] = np.nan
            continue
        try:
            dog, cat = np.polyfit(badger, donkey, 1)
        except Exception:
            rabbit[tiger] = np.nan
            continue
        lemur = fox.at[tiger, zebra]
        camel = turtle.at[tiger, zebra]
        if not (np.isfinite(lemur) and np.isfinite(camel)):
            rabbit[tiger] = np.nan
            continue
        bear = camel - (cat + dog * lemur)
        rabbit[tiger] = float(bear) if np.isfinite(bear) else np.nan
    return _make_factor_series(rabbit, date, universe=universe, name='factor11')

def factor12(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor12')

def factor13(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor13')

def factor14(universe, date):
    _set_asof_date(date)
    tiger = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    dog = get_fundamentals(tiger, date=date)
    if dog is None or dog.empty:
        panda = {cat: np.nan for cat in universe}
        return _make_factor_series(panda, date, universe=universe, name='factor14')
    dog = dog.set_index('code')
    panda = {cat: dog['term_045'].get(cat, np.nan) for cat in universe}
    return _make_factor_series(panda, date, universe=universe, name='factor14')

def factor15(universe, date):
    _set_asof_date(date)
    panda = list(universe)
    tiger = _r3_safe_date(date)
    otter = _r3_fundamentals(giraffe, [giraffe.term_045], panda, date=tiger)
    koala = _r3_fundamentals(fox, [fox.equities_parent_company_owners], panda, date=tiger)
    lion = _r3_join_code(panda, otter, koala)
    wolf = pd.to_numeric(lion.get('term_045', np.nan), errors='coerce')
    fox = pd.to_numeric(lion.get('equities_parent_company_owners', np.nan), errors='coerce')
    with np.errstate(divide='ignore', invalid='ignore'):
        cat = fox / wolf
    cat = cat.where(np.isfinite(cat) & (wolf > 0), np.nan)
    return _make_factor_series({dog: float(cat.get(dog, np.nan)) if np.isfinite(cat.get(dog, np.nan)) else np.nan for dog in panda}, date, universe=universe, name='factor15')

def factor16(universe, date, N=20):
    _set_asof_date(date)
    tiger = _last_n_trade_days(date, N + 1)
    if len(tiger) < 2:
        fox = {panda: np.nan for panda in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor16')
    wolf = tiger[0]
    koala = tiger[-1]
    rabbit = list(universe)
    bear = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    otter = pd.to_datetime(koala).strftime('%Y-%m-%d')
    lion = get_price(rabbit, start_date=bear, end_date=otter, frequency='daily', fields=['open', 'high', 'low', 'close'], fq='post', panel=False)
    if lion is None or lion.empty:
        fox = {panda: np.nan for panda in rabbit}
        return _make_factor_series(fox, date, universe=universe, name='factor16')
    lion = lion.copy()
    if 'time' not in lion.columns:
        lion = lion.reset_index()
    if 'code' not in lion.columns:
        fox = {panda: np.nan for panda in rabbit}
        return _make_factor_series(fox, date, universe=universe, name='factor16')
    lion['time'] = pd.to_datetime(lion['time'])
    lion = lion[['time', 'code', 'open', 'high', 'low', 'close']]
    lion = lion.dropna(subset=['open', 'high', 'low', 'close'])
    for dog in ['open', 'high', 'low', 'close']:
        lion[dog] = lion[dog].astype(float)
    lion = lion.sort_values(['code', 'time'])

    def _asi_one_code(g):
        g = g.sort_values('time')
        turtle = g['open']
        hawk = g['high']
        sparrow = g['low']
        giraffe = g['close']
        zebra = giraffe.shift(1)
        lizard = turtle.shift(1)
        owl = sparrow.shift(1)
        cat = (hawk - zebra).abs()
        dog = (sparrow - zebra).abs()
        panda = (hawk - owl).abs()
        tiger = (zebra - lizard).abs()
        lion = giraffe - zebra
        koala = giraffe - turtle
        otter = zebra - lizard
        rabbit = lion + 0.5 * koala + otter
        fox = pd.concat([cat, dog], axis=1).max(axis=1)
        dolphin = (cat > dog) & (cat > panda)
        whale = (dog > cat) & (dog > panda)
        wolf = pd.Series(np.nan, index=g.index, dtype='float64')
        wolf.loc[dolphin] = (cat[dolphin] + 0.5 * dog[dolphin] + 0.25 * tiger[dolphin]).values
        wolf.loc[whale] = (dog[whale] + 0.5 * cat[whale] + 0.25 * tiger[whale]).values
        shark = ~(dolphin | whale)
        wolf.loc[shark] = (panda[shark] + 0.25 * tiger[shark]).values
        eagle = wolf * fox
        bear = pd.Series(0.0, index=g.index, dtype='float64')
        frog = (eagle != 0) & np.isfinite(eagle.values) & np.isfinite(rabbit.values)
        bear.loc[frog] = (16.0 * rabbit[frog] / eagle[frog]).values
        if bear.size <= 1:
            return np.nan
        return float(bear.iloc[-N:].sum())
    cat = lion.groupby('code', sort=False).apply(_asi_one_code)
    fox = {panda: float(cat.get(panda, np.nan)) if np.isfinite(cat.get(panda, np.nan)) else np.nan for panda in rabbit}
    return _make_factor_series(fox, date, universe=universe, name='factor16')

def factor17(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    giraffe = pd.Period(cat, freq='Q-DEC') - 1
    bear = giraffe - 20
    rabbit = pd.PeriodIndex([bear, giraffe], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    koala = get_history_fundamentals(security=tiger, fields=[fox.term_081], watch_date=cat, count=40, interval='1q', stat_by_year=False)
    dog = _prep_hist(koala)
    if dog.empty or 'term_081' not in dog.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor17')
    dog = dog[dog['q'].isin(rabbit)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor17')
    dolphin = dog.pivot(index='q', columns='code', values='term_081').reindex(index=rabbit, columns=tiger)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = dolphin.loc[giraffe] if giraffe in dolphin.index else pd.Series(np.nan, index=tiger, dtype='float64')
    zebra = dolphin.loc[bear] if bear in dolphin.index else pd.Series(np.nan, index=tiger, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = (whale - zebra) / zebra
    fox = ~np.isfinite(wolf) | ~np.isfinite(whale) | ~np.isfinite(zebra) | (zebra == 0)
    wolf = wolf.where(~fox, np.nan).reindex(tiger)
    otter = {panda: float(wolf.get(panda)) if np.isfinite(wolf.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(otter, lion, universe=universe, name='factor17')

def factor18(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    shark = pd.Period(cat, freq='Q-DEC') - 1
    dolphin = shark - 4
    whale = pd.PeriodIndex([dolphin, shark], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    otter = get_history_fundamentals(security=lion, fields=[fox.inventories, fox.term_081], watch_date=cat, count=40, interval='1q', stat_by_year=False)
    panda = _prep_hist(otter)
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor18')
    panda = panda[panda['q'].isin(whale)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor18')
    bear = panda.pivot(index='q', columns='code', values='inventories').reindex(index=whale, columns=lion)
    hawk = panda.pivot(index='q', columns='code', values='term_081').reindex(index=whale, columns=lion)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    hawk = hawk.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = bear.loc[shark] if shark in bear.index else pd.Series(np.nan, index=lion, dtype='float64')
    wolf = bear.loc[dolphin] if dolphin in bear.index else pd.Series(np.nan, index=lion, dtype='float64')
    sparrow = hawk.loc[shark] if shark in hawk.index else pd.Series(np.nan, index=lion, dtype='float64')
    eagle = hawk.loc[dolphin] if dolphin in hawk.index else pd.Series(np.nan, index=lion, dtype='float64')
    dog = (sparrow + eagle) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = (rabbit - wolf) / dog
    giraffe = ~np.isfinite(zebra) | ~np.isfinite(rabbit) | ~np.isfinite(wolf) | ~np.isfinite(dog) | (dog == 0)
    zebra = zebra.where(~giraffe, np.nan).reindex(lion)
    fox = {tiger: float(zebra.get(tiger)) if np.isfinite(zebra.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(fox, koala, universe=universe, name='factor18')

def factor19(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor19')

def factor20(universe, date):
    _set_asof_date(date)
    koala = query(fox.code, fox.term_082, fox.term_083).filter(fox.code.in_(universe))
    tiger = get_fundamentals(koala, date=date)
    if tiger is None or tiger.empty:
        lion = {panda: np.nan for panda in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor20')
    tiger = tiger.set_index('code')
    lion = {}
    for panda in universe:
        cat = tiger['term_082'].get(panda, np.nan)
        dog = tiger['term_083'].get(panda, np.nan)
        if not np.isfinite(cat) or not np.isfinite(dog) or dog == 0:
            otter = np.nan
        else:
            otter = cat / dog
        lion[panda] = float(otter) if np.isfinite(otter) else np.nan
    return _make_factor_series(lion, date, universe=universe, name='factor20')

def factor21(universe, date, N_quarters=4):
    _set_asof_date(date)
    koala = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    otter = [koala - lion for lion in range(0, N_quarters)]
    hawk = [f'{wolf.year}q{wolf.quarter}' for wolf in otter]
    fox = [koala - (N_quarters + lion) for lion in range(0, N_quarters)]
    sparrow = [f'{wolf.year}q{wolf.quarter}' for wolf in fox]
    giraffe = {}
    for eagle in hawk:
        rabbit = query(bear.code, bear.term_066).filter(bear.code.in_(universe))
        panda = get_fundamentals(rabbit, statDate=eagle)
        if panda is None or panda.empty:
            giraffe[eagle] = pd.Series(dtype='float64')
        else:
            giraffe[eagle] = panda.set_index('code')['term_066']
    zebra = {}
    for eagle in sparrow:
        rabbit = query(bear.code, bear.term_066).filter(bear.code.in_(universe))
        panda = get_fundamentals(rabbit, statDate=eagle)
        if panda is None or panda.empty:
            zebra[eagle] = pd.Series(dtype='float64')
        else:
            zebra[eagle] = panda.set_index('code')['term_066']
    tiger = {}
    for cat in universe:
        dog = []
        for eagle in hawk:
            shark = giraffe[eagle]
            if cat in shark.index:
                dog.append(shark[cat])
        dolphin = np.nan if len(dog) == 0 else np.nansum(dog)
        bear = []
        for eagle in sparrow:
            shark = zebra[eagle]
            if cat in shark.index:
                bear.append(shark[cat])
        whale = np.nan if len(bear) == 0 else np.nansum(bear)
        if not np.isfinite(dolphin) or not np.isfinite(whale) or whale == 0:
            owl = np.nan
        else:
            owl = (dolphin - whale) / abs(whale)
        tiger[cat] = float(owl) if np.isfinite(owl) else np.nan
    return _make_factor_series(tiger, date, universe=universe, name='factor21')

def factor22(universe, date, lookback_years=5, batch_size=800):
    cat = _norm_universe(universe)
    return pd.Series(np.nan, index=cat, name='factor22')

def factor23(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    panda = _r3_safe_date(date)
    koala = _r3_fundamentals(bear, [bear.term_063], dog, date=panda)
    lion = _r3_fundamentals(fox, [fox.term_081], dog, date=panda)
    tiger = _r3_join_code(dog, koala, lion)
    otter = pd.to_numeric(tiger.get('term_063', np.nan), errors='coerce')
    fox = pd.to_numeric(tiger.get('term_081', np.nan), errors='coerce')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = otter / fox
    wolf = wolf.where(np.isfinite(wolf) & (fox != 0), np.nan)
    return _make_factor_series({cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in dog}, date, universe=universe, name='factor23')

def factor24(universe, date, window_days=1260):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = get_trade_days(end_date=lion, count=int(window_days))
    if len(koala) == 0:
        rabbit = {panda: np.nan for panda in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor24')
    turtle = koala[0]
    lizard = pd.to_datetime(turtle).strftime('%Y-%m-%d')
    bear = pd.to_datetime(lion).strftime('%Y-%m-%d')
    tiger = list(universe)
    hawk = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(tiger))
    fox = get_fundamentals(hawk, date=bear)
    whale = pd.Series(np.nan, index=tiger, dtype='float64')
    if fox is not None and (not fox.empty):
        whale = pd.Series(fox['term_045'].values, index=fox['code'].values).astype(float).reindex(tiger)
    eagle = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(tiger))
    otter = get_fundamentals(eagle, date=lizard)
    dolphin = pd.Series(np.nan, index=tiger, dtype='float64')
    if otter is not None and (not otter.empty):
        dolphin = pd.Series(otter['term_045'].values, index=otter['code'].values).astype(float).reindex(tiger)
    wolf = get_price(tiger, start_date=lizard, end_date=bear, frequency='daily', fields=['close'], fq='post', panel=False)
    if wolf is None or wolf.empty:
        rabbit = {cat: np.nan for cat in tiger}
        return _make_factor_series(rabbit, date, universe=universe, name='factor24')
    wolf = wolf.copy()
    if 'time' not in wolf.columns:
        wolf = wolf.reset_index()
    if 'code' not in wolf.columns:
        rabbit = {cat: np.nan for cat in tiger}
        return _make_factor_series(rabbit, date, universe=universe, name='factor24')
    dog = wolf.pivot(index='time', columns='code', values='close').sort_index()
    dog = dog.reindex(columns=tiger)
    sparrow = dog.pct_change()
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = np.log1p(sparrow)
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    frog = giraffe.sum(axis=0, skipna=True)
    rabbit = {}
    for cat in tiger:
        shark = whale.get(cat, np.nan)
        zebra = dolphin.get(cat, np.nan)
        owl = frog.get(cat, np.nan)
        if not np.isfinite(shark) or not np.isfinite(zebra) or shark <= 0 or (zebra <= 0) or (not np.isfinite(owl)):
            rabbit[cat] = np.nan
            continue
        salmon = np.log(shark / zebra) - float(owl)
        rabbit[cat] = float(salmon) if np.isfinite(salmon) else np.nan
    return _make_factor_series(rabbit, date, universe=universe, name='factor24')

def factor25(universe, date):
    _set_asof_date(date)
    lion = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=date, count=1)
    panda = lion.get('np_parent_company_owners_ttm', None)
    if panda is None or panda.empty:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor25')
    wolf = panda.iloc[-1]
    fox = query(fox.code, fox.equities_parent_company_owners).filter(fox.code.in_(universe))
    dog = get_fundamentals(fox, date=date)
    if dog is None or dog.empty:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor25')
    dog = dog.set_index('code')
    koala = {}
    for cat in universe:
        otter = wolf.get(cat, np.nan)
        tiger = dog['equities_parent_company_owners'].get(cat, np.nan)
        if not np.isfinite(otter) or not np.isfinite(tiger) or tiger == 0:
            bear = np.nan
        else:
            bear = otter / tiger
        koala[cat] = float(bear) if np.isfinite(bear) else np.nan
    return _make_factor_series(koala, date, universe=universe, name='factor25')

def factor26(universe, date):
    _set_asof_date(date)
    koala = query(fox.code, fox.term_084, fox.total_owner_equities).filter(fox.code.in_(universe))
    panda = get_fundamentals(koala, date=date)
    if panda is None or panda.empty:
        lion = {cat: np.nan for cat in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor26')
    panda = panda.set_index('code')
    lion = {}
    for cat in universe:
        dog = panda['term_084'].get(cat, np.nan)
        tiger = panda['total_owner_equities'].get(cat, np.nan)
        if not np.isfinite(dog) or not np.isfinite(tiger) or tiger == 0:
            otter = np.nan
        else:
            otter = dog / tiger
        lion[cat] = float(otter) if np.isfinite(otter) else np.nan
    return _make_factor_series(lion, date, universe=universe, name='factor26')

def factor27(universe, date, N=8):
    _set_asof_date(date)
    zebra = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    dolphin = [zebra - bear for bear in range(N - 1, -1, -1)]
    owl = [f'{whale.year}q{whale.quarter}' for whale in dolphin]
    giraffe = pd.DataFrame(index=universe, columns=owl, dtype='float64')
    for sparrow in owl:
        shark = query(bear.code, bear.np_parent_company_owners).filter(bear.code.in_(universe))
        koala = get_fundamentals(shark, statDate=sparrow)
        if koala is None or koala.empty:
            continue
        koala = koala.set_index('code')
        for lion in koala.index:
            if lion in giraffe.index:
                giraffe.at[lion, sparrow] = koala.at[lion, 'np_parent_company_owners']
    if giraffe.shape[1] < 5:
        wolf = pd.Series(np.nan, index=universe)
    else:
        frog = giraffe.iloc[:, -4:].sum(axis=1, min_count=1)
        salmon = giraffe.iloc[:, -5:-1].sum(axis=1, min_count=1)
        fox = (frog - salmon) / salmon.abs()
        fox = fox.replace([np.inf, -np.inf], np.nan)
        wolf = fox
    dog = pd.Series(np.nan, index=universe, dtype='float64')
    turtle = np.arange(giraffe.shape[1], dtype=float)
    for lion in universe:
        alpaca = giraffe.loc[lion, :].values.astype(float)
        rabbit = np.isfinite(alpaca)
        tuna = turtle[rabbit]
        lemur = alpaca[rabbit]
        if len(lemur) < 3:
            continue
        try:
            tiger, panda, cat = np.polyfit(tuna, lemur, 2)
        except Exception:
            continue
        dog[lion] = tiger
    hawk = _three_bucket_score(wolf)
    eagle = _three_bucket_score(dog)
    lizard = hawk + eagle
    otter = {lion: float(lizard.get(lion, np.nan)) for lion in universe}
    return _make_factor_series(otter, date, universe=universe, name='factor27')

def factor28(universe, date, N=20):
    _set_asof_date(date)
    tiger = get_trade_days(end_date=_to_date(date), count=2 * int(N) + 1)
    if len(tiger) == 0:
        bear = {dog: np.nan for dog in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor28')
    frog = list(universe)
    turtle = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(_to_date(date)).strftime('%Y-%m-%d')
    lion = get_price(frog, start_date=turtle, end_date=wolf, frequency='daily', fields=['high', 'low'], fq='post', panel=False)
    if lion is None or lion.empty:
        bear = {dog: np.nan for dog in frog}
        return _make_factor_series(bear, date, universe=universe, name='factor28')
    lion = lion.copy()
    if 'time' not in lion.columns:
        lion = lion.reset_index()
    if 'code' not in lion.columns:
        bear = {dog: np.nan for dog in frog}
        return _make_factor_series(bear, date, universe=universe, name='factor28')
    lion['time'] = pd.to_datetime(lion['time'])
    rabbit = lion.pivot(index='time', columns='code', values='high').sort_index()
    zebra = lion.pivot(index='time', columns='code', values='low').sort_index()
    rabbit = rabbit.reindex(columns=frog)
    zebra = zebra.reindex(columns=frog)
    owl = (rabbit - zebra).astype(float)
    if owl.shape[0] < int(N) + 1:
        bear = {dog: np.nan for dog in frog}
        return _make_factor_series(bear, date, universe=universe, name='factor28')
    cat = 2.0 / (float(N) + 1.0)
    koala = np.full_like(owl.values, np.nan, dtype=float)
    salmon = owl.values[0, :].astype(float)
    koala[0, :] = salmon
    for lizard in range(1, owl.shape[0]):
        tuna = owl.values[lizard, :].astype(float)
        sparrow = koala[lizard - 1, :]
        hawk = np.full_like(sparrow, np.nan, dtype=float)
        eagle = np.isfinite(tuna)
        shark = np.isfinite(sparrow)
        dolphin = eagle & shark
        hawk[dolphin] = cat * tuna[dolphin] + (1.0 - cat) * sparrow[dolphin]
        whale = eagle & ~shark
        hawk[whale] = tuna[whale]
        koala[lizard, :] = hawk
    otter = koala[-1, :]
    fox = koala[-(int(N) + 1), :]
    with np.errstate(divide='ignore', invalid='ignore'):
        panda = (otter - fox) / otter * 100.0
    panda = np.where(np.isfinite(panda) & (otter != 0), panda, np.nan)
    bear = {dog: float(panda[giraffe]) if np.isfinite(panda[giraffe]) else np.nan for giraffe, dog in enumerate(frog)}
    return _make_factor_series(bear, date, universe=universe, name='factor28')

def factor29(universe, date, start_date='2005-01-01'):
    _set_asof_date(date)
    koala = _to_date(date)
    tiger = list(universe)
    whale = pd.to_datetime(start_date).strftime('%Y-%m-%d')
    fox = pd.to_datetime(koala).strftime('%Y-%m-%d')
    otter = get_price(tiger, start_date=whale, end_date=fox, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if otter is None or otter.empty:
        wolf = {cat: np.nan for cat in tiger}
        return _make_factor_series(wolf, date, universe=universe, name='factor29')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    if 'code' not in otter.columns:
        wolf = {cat: np.nan for cat in tiger}
        return _make_factor_series(wolf, date, universe=universe, name='factor29')
    otter['time'] = pd.to_datetime(otter['time'])
    otter = otter[['time', 'code', 'close', 'volume']].dropna(subset=['close', 'volume'])
    otter['close'] = otter['close'].astype(float)
    otter['volume'] = otter['volume'].astype(float)
    otter = otter[np.isfinite(otter['close'].values) & np.isfinite(otter['volume'].values)]
    if otter.empty:
        wolf = {cat: np.nan for cat in tiger}
        return _make_factor_series(wolf, date, universe=universe, name='factor29')
    otter = otter.sort_values(['code', 'time'])
    wolf = {}
    for panda, bear in otter.groupby('code', sort=False):
        bear = bear.sort_values('time')
        dog = bear['close'].values.astype(float)
        shark = bear['volume'].values.astype(float)
        if dog.size < 2:
            wolf[panda] = 0.0
            continue
        giraffe = dog[:-1]
        lion = dog[1:]
        eagle = shark[1:]
        with np.errstate(divide='ignore', invalid='ignore'):
            dolphin = lion / giraffe - 1.0
        dolphin = np.where(np.isfinite(dolphin), dolphin, 0.0)
        zebra = float(np.nansum(dolphin * eagle))
        wolf[panda] = zebra if np.isfinite(zebra) else np.nan
    rabbit = {cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in tiger}
    return _make_factor_series(rabbit, date, universe=universe, name='factor29')

def factor30(universe, date):
    _set_asof_date(date)
    tiger = query(giraffe.code, giraffe.term_027).filter(giraffe.code.in_(universe))
    dog = get_fundamentals(tiger, date=date)
    if dog is None or dog.empty:
        panda = {cat: np.nan for cat in universe}
        return _make_factor_series(panda, date, universe=universe, name='factor30')
    dog = dog.set_index('code')
    panda = {cat: float(dog['term_027'].get(cat, np.nan)) if np.isfinite(dog['term_027'].get(cat, np.nan)) else np.nan for cat in universe}
    return _make_factor_series(panda, date, universe=universe, name='factor30')

def factor31(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    panda = _r3_safe_date(date)
    lion = _r3_fundamentals(fox, [fox.term_081], dog, date=panda)
    koala = _r3_fundamentals(giraffe, [giraffe.term_045], dog, date=panda)
    tiger = _r3_join_code(dog, lion, koala)
    fox = pd.to_numeric(tiger.get('term_081', np.nan), errors='coerce')
    otter = pd.to_numeric(tiger.get('term_045', np.nan), errors='coerce')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = fox / otter
    wolf = wolf.where(np.isfinite(wolf) & (otter != 0), np.nan)
    return _make_factor_series({cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in dog}, date, universe=universe, name='factor31')

def factor32(universe, date):
    _set_asof_date(date)
    rabbit = _to_date(date)
    cat = pd.Timestamp(rabbit)
    bear = list(universe)
    lizard = pd.Period(cat, freq='Q-DEC') - 1
    frog = lizard - 1
    salmon = pd.PeriodIndex([lizard, lizard - 1, lizard - 2, lizard - 3], freq='Q-DEC')
    turtle = pd.PeriodIndex([frog, lizard], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    koala = pd.Series(np.nan, index=bear, dtype='float64')
    alpaca = _nearest_td_le(rabbit)
    if alpaca is not None:
        try:
            whale = get_factor_values(bear, factors=['term_051'], end_date=alpaca, count=1)
            giraffe = whale.get('term_051', None) if isinstance(whale, dict) else None
            if isinstance(giraffe, pd.DataFrame) and (not giraffe.empty):
                tuna = giraffe.iloc[-1]
                tuna.index = tuna.index.astype(str)
                koala = pd.to_numeric(tuna, errors='coerce').astype(float).reindex(bear)
        except Exception:
            pass
    if koala.notna().sum() < 10:
        dolphin = get_history_fundamentals(security=bear, fields=[wolf.term_049], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        lion = _prep_hist(dolphin)
        if not lion.empty and 'term_049' in lion.columns:
            lion = lion[lion['q'].isin(salmon)]
            if not lion.empty:
                owl = lion.pivot(index='q', columns='code', values='term_049').reindex(index=salmon, columns=bear)
                owl = owl.apply(pd.to_numeric, errors='coerce').astype(float)
                eagle = owl.sum(axis=0, min_count=1).reindex(bear)
                koala = koala.where(np.isfinite(koala), eagle)
    zebra = get_history_fundamentals(security=bear, fields=[fox.term_083], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(zebra)
    if panda.empty or 'term_083' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in bear}, rabbit, universe=universe, name='factor32')
    panda = panda[panda['q'].isin(turtle)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in bear}, rabbit, universe=universe, name='factor32')
    otter = panda.pivot(index='q', columns='code', values='term_083').reindex(index=turtle, columns=bear)
    otter = otter.apply(pd.to_numeric, errors='coerce').astype(float)
    fox = otter.loc[lizard] if lizard in otter.index else pd.Series(np.nan, index=bear, dtype='float64')
    wolf = otter.loc[frog] if frog in otter.index else pd.Series(np.nan, index=bear, dtype='float64')
    dog = (fox + wolf) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        sparrow = koala / dog
    hawk = ~np.isfinite(sparrow) | ~np.isfinite(koala) | ~np.isfinite(dog) | (dog == 0)
    sparrow = sparrow.where(~hawk, np.nan).reindex(bear)
    shark = {tiger: float(sparrow.get(tiger)) if np.isfinite(sparrow.get(tiger, np.nan)) else np.nan for tiger in bear}
    return _make_factor_series(shark, rabbit, universe=universe, name='factor32')

def factor33(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    giraffe = pd.Period(cat, freq='Q-DEC') - 1
    rabbit = giraffe - 4
    fox = pd.PeriodIndex([rabbit, giraffe], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[bear.term_066], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor33')
    koala = koala.copy()
    if 'pubDate' in koala.columns:
        bear = pd.to_datetime(koala['pubDate'], errors='coerce')
        koala = koala[bear.notna() & (bear <= cat)]
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty or 'term_066' not in koala.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor33')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(fox)]
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor33')
    dolphin = koala.pivot(index='q', columns='code', values='term_066').reindex(index=fox, columns=panda)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = dolphin.loc[giraffe]
    zebra = dolphin.loc[rabbit]
    lion = zebra.abs()
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = (whale - zebra) / lion
    wolf = wolf.replace([np.inf, -np.inf], np.nan)
    wolf = wolf.where(np.isfinite(lion) & (lion > 0), np.nan)
    otter = {dog: float(wolf.get(dog, np.nan)) if np.isfinite(wolf.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(otter, tiger, universe=universe, name='factor33')

def factor34(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor34')

def factor35(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor35')

def factor36(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    panda = pd.Timestamp(koala)
    lion = list(universe)

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()

    def _safe_num(s, idx):
        if s is None:
            return pd.Series(np.nan, index=idx, dtype='float64')
        if isinstance(s, pd.Series):
            s = s.copy()
            s.index = s.index.astype(str)
            return pd.to_numeric(s, errors='coerce').astype(float).reindex(idx)
        try:
            return pd.Series(float(s), index=idx, dtype='float64')
        except Exception:
            return pd.Series(np.nan, index=idx, dtype='float64')

    def _get_snapshot_quality(d_eval):
        d_eval = _to_date(d_eval)
        lizard = _nearest_td_le(d_eval)
        if lizard is None:
            return pd.Series(np.nan, index=codes, dtype='float64')
        frog = pd.Timestamp(lizard).strftime('%Y-%m-%d')
        eagle = query(rabbit.code, rabbit.roe, rabbit.roa, rabbit.term_029, rabbit.term_034, rabbit.term_032, rabbit.term_033, rabbit.term_058).filter(rabbit.code.in_(codes))
        koala = get_fundamentals(eagle, date=frog)
        shark = query(fox.code, fox.term_084, fox.term_081, fox.term_044).filter(fox.code.in_(codes))
        tiger = get_fundamentals(shark, date=frog)
        dog = pd.DataFrame({'code': codes})
        if koala is None or koala.empty or 'code' not in koala.columns:
            otter = dog.copy()
        else:
            otter = koala.copy()
            otter['code'] = otter['code'].astype(str)
            otter = otter.drop_duplicates(['code'], keep='last')
        if tiger is None or tiger.empty or 'code' not in tiger.columns:
            lion = dog.copy()
        else:
            lion = tiger.copy()
            lion['code'] = lion['code'].astype(str)
            lion = lion.drop_duplicates(['code'], keep='last')
        panda = dog.merge(otter, on='code', how='left').merge(lion, on='code', how='left')
        panda = panda.set_index('code')
        owl = _safe_num(panda.get('roe', None), codes)
        sparrow = _safe_num(panda.get('roa', None), codes)
        fox = _safe_num(panda.get('term_029', None), codes)
        rabbit = _safe_num(panda.get('term_034', None), codes)
        wolf = _safe_num(panda.get('term_032', None), codes)
        bear = _safe_num(panda.get('term_033', None), codes)
        whale = _safe_num(panda.get('term_058', None), codes)
        salmon = _safe_num(panda.get('term_084', None), codes)
        turtle = _safe_num(panda.get('term_081', None), codes)
        dolphin = _safe_num(panda.get('term_044', None), codes)
        with np.errstate(divide='ignore', invalid='ignore'):
            giraffe = (salmon / turtle).replace([np.inf, -np.inf], np.nan)
            zebra = (dolphin / turtle).replace([np.inf, -np.inf], np.nan)
        alpaca = pd.concat([_zscore_series(owl), _zscore_series(sparrow), _zscore_series(fox)], axis=1).mean(axis=1, skipna=True)
        tuna = pd.concat([_zscore_series(rabbit), _zscore_series(wolf), _zscore_series(bear)], axis=1).mean(axis=1, skipna=True)
        lemur = pd.concat([_zscore_series(-giraffe), _zscore_series(-zebra), _zscore_series(whale)], axis=1).mean(axis=1, skipna=True)
        hawk = alpaca + tuna + lemur
        cat = _zscore_series(hawk).reindex(codes)
        return cat
    otter = (panda - pd.DateOffset(years=1)).date()
    cat = _get_snapshot_quality(koala)
    dog = _get_snapshot_quality(otter)
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = (cat - dog) / dog.abs()
    wolf = ~np.isfinite(bear) | ~np.isfinite(cat) | ~np.isfinite(dog) | (dog == 0)
    bear = bear.where(~wolf, np.nan).reindex(lion)
    fox = {tiger: float(bear.get(tiger)) if np.isfinite(bear.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(fox, koala, universe=universe, name='factor36')

def factor37(universe, date):
    _set_asof_date(date)
    otter = get_factor_values(universe, factors=['term_089'], end_date=date, count=1)
    lion = otter.get('term_089', None)
    if lion is None or lion.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor37')
    panda = lion.iloc[-1]
    tiger = (pd.to_datetime(date) - DateOffset(years=1)).strftime('%Y-%m-%d')
    fox = get_factor_values(universe, factors=['term_089'], end_date=tiger, count=1)
    koala = fox.get('term_089', None)
    if koala is None or koala.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor37')
    rabbit = koala.iloc[-1]
    wolf = {}
    for cat in universe:
        dog = panda.get(cat, np.nan)
        bear = rabbit.get(cat, np.nan)
        if not np.isfinite(dog) or not np.isfinite(bear) or bear == 0:
            giraffe = np.nan
        else:
            giraffe = (dog - bear) / abs(bear)
        wolf[cat] = float(giraffe) if np.isfinite(giraffe) else np.nan
    return _make_factor_series(wolf, date, universe=universe, name='factor37')

def factor38(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor38')

def factor39(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor39')

def factor40(universe, date):
    _set_asof_date(date)
    fox = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    wolf = [fox - lion for lion in range(0, 4)]
    hawk = [f'{bear.year}q{bear.quarter}' for bear in wolf]
    zebra = {}
    for eagle in hawk:
        rabbit = query(bear.code, bear.term_072).filter(bear.code.in_(universe))
        dog = get_fundamentals(rabbit, statDate=eagle)
        if dog is None or dog.empty:
            zebra[eagle] = pd.Series(dtype='float64')
        else:
            zebra[eagle] = dog.set_index('code')['term_072']
    giraffe = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    panda = get_fundamentals(giraffe, date=date)
    if panda is None or panda.empty:
        panda = pd.DataFrame(columns=['code', 'term_045'])
    panda = panda.set_index('code')
    koala = panda['term_045']
    tiger = {}
    for cat in universe:
        whale = []
        for eagle in hawk:
            shark = zebra[eagle]
            if cat in shark.index:
                whale.append(shark[cat])
        dolphin = np.nan if len(whale) == 0 else np.nansum(whale)
        otter = koala.get(cat, np.nan)
        if not np.isfinite(dolphin) or not np.isfinite(otter) or otter <= 0:
            sparrow = np.nan
        else:
            sparrow = dolphin / otter
        tiger[cat] = float(sparrow) if np.isfinite(sparrow) else np.nan
    return _make_factor_series(tiger, date, universe=universe, name='factor40')

def factor41(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    panda = _r3_safe_date(date)
    koala = _r3_fundamentals(fox, [fox.term_084], dog, date=panda)
    otter = _r3_fundamentals(giraffe, [giraffe.term_045], dog, date=panda)
    lion = _r3_join_code(dog, koala, otter)
    tiger = pd.to_numeric(lion.get('term_084', np.nan), errors='coerce')
    fox = pd.to_numeric(lion.get('term_045', np.nan), errors='coerce')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = tiger / fox
    wolf = wolf.where(np.isfinite(wolf) & (fox > 0), np.nan)
    return _make_factor_series({cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in dog}, date, universe=universe, name='factor41')

def factor42(universe, date, N=8):
    _set_asof_date(date)
    lion = list(universe)
    dolphin = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    whale = [dolphin - bear for bear in range(int(N) - 1, -1, -1)]
    turtle = [f'{shark.year}q{shark.quarter}' for shark in whale]
    zebra = pd.DataFrame(index=lion, columns=turtle, dtype='float64')
    giraffe = pd.DataFrame(index=lion, columns=turtle, dtype='float64')
    sparrow = pd.DataFrame(index=lion, columns=turtle, dtype='float64')
    for owl in turtle:
        hawk = query(bear.code, bear.term_052, bear.term_055).filter(bear.code.in_(lion))
        otter = get_fundamentals(hawk, statDate=owl)
        if otter is not None and (not otter.empty):
            otter = otter.set_index('code')
            zebra[owl] = pd.to_numeric(otter.get('term_052', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion)
            giraffe[owl] = pd.to_numeric(otter.get('term_055', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion)
        eagle = query(wolf.code, wolf.staff_behalf_paid).filter(wolf.code.in_(lion))
        koala = get_fundamentals(eagle, statDate=owl)
        if koala is not None and (not koala.empty):
            koala = koala.set_index('code')
            sparrow[owl] = pd.to_numeric(koala.get('staff_behalf_paid', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion)
    wolf = {}
    for tiger in lion:
        badger = zebra.loc[tiger, :].values.astype(float)
        lizard = giraffe.loc[tiger, :].values.astype(float)
        tuna = sparrow.loc[tiger, :].values.astype(float)
        rabbit = np.isfinite(badger) & np.isfinite(lizard) & np.isfinite(tuna)
        beaver = badger[rabbit]
        frog = lizard[rabbit]
        alpaca = tuna[rabbit]
        if beaver.size < 3:
            wolf[tiger] = np.nan
            continue
        camel = _zscore_series(pd.Series(beaver)).values
        salmon = _zscore_series(pd.Series(frog)).values
        lemur = _zscore_series(pd.Series(alpaca)).values
        cat = np.column_stack([np.ones(camel.size, dtype=float), salmon, lemur])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, camel, rcond=None)
            fox = float((camel - cat.dot(panda))[-1])
        except Exception:
            fox = np.nan
        wolf[tiger] = float(fox) if np.isfinite(fox) else np.nan
    return _make_factor_series(wolf, date, universe=universe, name='factor42')

def factor43(universe, date, N=20):
    _set_asof_date(date)
    panda = _last_n_trade_days(date, N + 1)
    if len(panda) < N + 1:
        otter = {dog: np.nan for dog in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor43')
    fox = panda[0]
    lion = _to_date(date)
    bear = list(universe)
    wolf = pd.to_datetime(fox).strftime('%Y-%m-%d')
    koala = pd.to_datetime(lion).strftime('%Y-%m-%d')
    tiger = get_price(bear, start_date=wolf, end_date=koala, frequency='daily', fields=['close', 'high', 'low'], fq='post', panel=False)
    if tiger is None or tiger.empty:
        otter = {dog: np.nan for dog in bear}
        return _make_factor_series(otter, date, universe=universe, name='factor43')
    tiger = tiger.copy()
    if 'time' not in tiger.columns:
        tiger = tiger.reset_index()
    if 'code' not in tiger.columns:
        otter = {dog: np.nan for dog in bear}
        return _make_factor_series(otter, date, universe=universe, name='factor43')
    tiger['time'] = pd.to_datetime(tiger['time'])
    tiger = tiger[['time', 'code', 'close', 'high', 'low']].dropna(subset=['close', 'high', 'low'])
    tiger['close'] = tiger['close'].astype(float)
    tiger['high'] = tiger['high'].astype(float)
    tiger['low'] = tiger['low'].astype(float)
    tiger = tiger.sort_values(['code', 'time'])

    def _acd_one_code(g):
        g = g.sort_values('time')
        dog = g['close']
        lion = g['high']
        koala = g['low']
        panda = dog.shift(1)
        tiger = dog > panda
        fox = pd.Series(np.nan, index=g.index, dtype='float64')
        if tiger.any():
            fox.loc[tiger] = pd.concat([koala[tiger], panda[tiger]], axis=1).min(axis=1).values
        if (~tiger).any():
            fox.loc[~tiger] = pd.concat([lion[~tiger], panda[~tiger]], axis=1).max(axis=1).values
        cat = dog - fox
        otter = cat.copy()
        otter.loc[dog == panda] = 0.0
        if otter.size > 0:
            otter.iloc[0] = 0.0
        if otter.size < 1:
            return np.nan
        return float(otter.iloc[-N:].sum())
    cat = tiger.groupby('code', sort=False).apply(_acd_one_code)
    otter = {dog: float(cat.get(dog, np.nan)) if np.isfinite(cat.get(dog, np.nan)) else np.nan for dog in bear}
    return _make_factor_series(otter, date, universe=universe, name='factor43')

def factor44(universe, date, N1=12, N2=26, N3=9):
    _set_asof_date(date)
    fox = _to_date(date)
    owl = int(N2) * 3
    wolf = get_trade_days(end_date=fox, count=owl)
    if len(wolf) == 0:
        dolphin = {otter: np.nan for otter in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor44')
    hawk = pd.to_datetime(wolf[0]).strftime('%Y-%m-%d')
    zebra = pd.to_datetime(fox).strftime('%Y-%m-%d')
    sparrow = list(universe)
    bear = get_price(sparrow, start_date=hawk, end_date=zebra, frequency='daily', fields=['close'], fq='post', panel=False)
    if bear is None or bear.empty:
        dolphin = {otter: np.nan for otter in sparrow}
        return _make_factor_series(dolphin, date, universe=universe, name='factor44')
    bear = bear.copy()
    if 'time' not in bear.columns:
        bear = bear.reset_index()
    if 'code' not in bear.columns:
        dolphin = {otter: np.nan for otter in sparrow}
        return _make_factor_series(dolphin, date, universe=universe, name='factor44')
    bear['time'] = pd.to_datetime(bear['time'])
    koala = bear.pivot(index='time', columns='code', values='close').sort_index()
    koala = koala.reindex(columns=sparrow)
    lion = koala.values.astype(float)
    tiger, panda = lion.shape
    if tiger < 2:
        dolphin = {otter: np.nan for otter in sparrow}
        return _make_factor_series(dolphin, date, universe=universe, name='factor44')

    def _ema_mat(x, n):
        cat = 2.0 / (float(n) + 1.0)
        otter = np.full_like(x, np.nan, dtype=float)
        otter[0, :] = x[0, :]
        for wolf in range(1, x.shape[0]):
            bear = x[wolf, :]
            fox = otter[wolf - 1, :]
            dog = np.full_like(fox, np.nan, dtype=float)
            koala = np.isfinite(bear)
            lion = np.isfinite(fox)
            panda = koala & lion
            dog[panda] = cat * bear[panda] + (1.0 - cat) * fox[panda]
            tiger = koala & ~lion
            dog[tiger] = bear[tiger]
            otter[wolf, :] = dog
        return otter
    rabbit = _ema_mat(lion, N1)
    giraffe = _ema_mat(lion, N2)
    dog = rabbit - giraffe
    cat = _ema_mat(dog, N3)
    eagle = 2.0 * (dog - cat)
    shark = eagle[-1, :]
    dolphin = {otter: float(shark[whale]) if np.isfinite(shark[whale]) else np.nan for whale, otter in enumerate(sparrow)}
    return _make_factor_series(dolphin, date, universe=universe, name='factor44')

def factor45(universe, date, L=20):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=L)
    if len(tiger) == 0:
        wolf = {dog: np.nan for dog in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor45')
    owl = list(universe)
    shark = tiger[0]
    eagle = pd.to_datetime(shark).strftime('%Y-%m-%d')
    fox = pd.to_datetime(panda).strftime('%Y-%m-%d')
    whale = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(owl))
    otter = get_fundamentals(whale, date=eagle)
    rabbit = pd.Series(np.nan, index=owl, dtype='float64')
    if otter is not None and (not otter.empty):
        rabbit = pd.Series(otter['term_045'].values, index=otter['code'].values).astype(float).reindex(owl)
    dolphin = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(owl))
    lion = get_fundamentals(dolphin, date=fox)
    bear = pd.Series(np.nan, index=owl, dtype='float64')
    if lion is not None and (not lion.empty):
        bear = pd.Series(lion['term_045'].values, index=lion['code'].values).astype(float).reindex(owl)
    koala = get_price(owl, start_date=eagle, end_date=fox, frequency='daily', fields=['money'], fq='post', panel=False)
    if koala is None or koala.empty:
        wolf = {dog: np.nan for dog in owl}
        return _make_factor_series(wolf, date, universe=universe, name='factor45')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index()
    if 'code' not in koala.columns:
        wolf = {dog: np.nan for dog in owl}
        return _make_factor_series(wolf, date, universe=universe, name='factor45')
    koala = koala[['code', 'money']].dropna(subset=['money'])
    koala['money'] = koala['money'].astype(float)
    koala = koala[np.isfinite(koala['money'].values)]
    sparrow = koala.groupby('code', sort=False)['money'].sum()
    wolf = {}
    for dog in owl:
        hawk = float(sparrow.get(dog, np.nan))
        zebra = rabbit.get(dog, np.nan)
        giraffe = bear.get(dog, np.nan)
        if not np.isfinite(hawk) or not np.isfinite(zebra) or (not np.isfinite(giraffe)):
            wolf[dog] = np.nan
            continue
        cat = (zebra + giraffe) / 2.0
        if not np.isfinite(cat) or cat <= 0:
            wolf[dog] = np.nan
            continue
        turtle = hawk / cat
        wolf[dog] = float(turtle) if np.isfinite(turtle) else np.nan
    return _make_factor_series(wolf, date, universe=universe, name='factor45')

def factor46(universe, date, window=252):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = _last_n_trade_days(tiger, window)
    if len(lion) == 0:
        fox = {panda: np.nan for panda in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor46')
    giraffe = list(universe)
    rabbit = pd.to_datetime(lion[0]).strftime('%Y-%m-%d')
    otter = pd.to_datetime(tiger).strftime('%Y-%m-%d')
    koala = get_price(giraffe, start_date=rabbit, end_date=otter, frequency='daily', fields=['close'], fq='post', panel=False)
    if koala is None or koala.empty:
        fox = {panda: np.nan for panda in giraffe}
        return _make_factor_series(fox, date, universe=universe, name='factor46')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index()
    if 'code' not in koala.columns:
        fox = {panda: np.nan for panda in giraffe}
        return _make_factor_series(fox, date, universe=universe, name='factor46')
    cat = koala.pivot(index='time', columns='code', values='close').sort_index()
    cat = cat.reindex(columns=giraffe)
    wolf = cat.max(axis=0, skipna=True)
    dog = cat.iloc[-1]
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = dog / wolf
    bear = bear.replace([np.inf, -np.inf], np.nan)
    fox = {panda: float(bear.get(panda, np.nan)) if np.isfinite(bear.get(panda, np.nan)) else np.nan for panda in giraffe}
    return _make_factor_series(fox, date, universe=universe, name='factor46')

def factor47(universe, date, W=252, mkt_index='000905.XSHG'):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = _last_n_trade_days(otter, W + 1)
    if len(fox) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor47')
    turtle = fox[0]
    bear = fox[-1]
    shark = _get_daily_close_series(mkt_index, turtle, bear)
    if shark is None or shark.size < 2:
        return _make_factor_series({}, date, universe=universe, name='factor47')
    shark = shark.sort_index()
    hawk = shark.pct_change().dropna()
    if hawk.size < 10:
        return _make_factor_series({}, date, universe=universe, name='factor47')
    frog = list(universe)
    lizard = pd.to_datetime(turtle).strftime('%Y-%m-%d')
    rabbit = pd.to_datetime(bear).strftime('%Y-%m-%d')
    wolf = get_price(frog, start_date=lizard, end_date=rabbit, frequency='daily', fields=['close'], fq='post', panel=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor47')
    wolf = wolf.copy()
    if 'time' not in wolf.columns:
        wolf = wolf.reset_index()
    if 'code' not in wolf.columns:
        return _make_factor_series({}, date, universe=universe, name='factor47')
    tiger = wolf.pivot(index='time', columns='code', values='close').sort_index()
    eagle = tiger.pct_change()
    koala = eagle.index.intersection(hawk.index)
    if koala.size < 10:
        return _make_factor_series({}, date, universe=universe, name='factor47')
    owl = hawk.reindex(koala).values.astype(float)
    zebra = {}
    for lion in frog:
        if lion not in eagle.columns:
            continue
        sparrow = eagle[lion].reindex(koala).values.astype(float)
        whale = np.isfinite(sparrow) & np.isfinite(owl)
        if whale.sum() < 10:
            continue
        tuna = sparrow[whale]
        salmon = owl[whale]
        if np.std(salmon, ddof=1) == 0:
            continue
        cat = np.column_stack([np.ones_like(salmon), salmon])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, tuna, rcond=None)
        except Exception:
            continue
        giraffe = tuna - cat.dot(panda)
        if giraffe.size < 2:
            continue
        dolphin = float(np.std(giraffe, ddof=1))
        if np.isfinite(dolphin):
            zebra[lion] = dolphin
    return _make_factor_series(zebra, date, universe=universe, name='factor47')

def factor48(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    bear = pd.Period(cat, freq='Q-DEC') - 1
    rabbit = bear - 1
    otter = pd.PeriodIndex([rabbit, bear], freq='Q-DEC')
    lion = get_history_fundamentals(security=panda, fields=[fox.term_081], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    if lion is None or lion.empty or 'code' not in lion.columns or ('statDate' not in lion.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor48')
    lion = lion.copy()
    if 'pubDate' in lion.columns:
        wolf = pd.to_datetime(lion['pubDate'], errors='coerce')
        lion = lion[wolf.notna() & (wolf <= cat)]
    lion['code'] = lion['code'].astype(str)
    lion['statDate'] = pd.to_datetime(lion['statDate'], errors='coerce')
    lion = lion.dropna(subset=['code', 'statDate'])
    if lion.empty or 'term_081' not in lion.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor48')
    lion['q'] = lion['statDate'].dt.to_period('Q-DEC')
    lion = lion[lion['q'].isin(otter)]
    lion = lion.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if lion.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor48')
    giraffe = lion.pivot(index='q', columns='code', values='term_081').reindex(index=otter, columns=panda)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = giraffe.loc[bear]
    dolphin = giraffe.loc[rabbit]
    with np.errstate(divide='ignore', invalid='ignore'):
        fox = (zebra - dolphin) / dolphin
    fox = fox.replace([np.inf, -np.inf], np.nan)
    fox = fox.where(np.isfinite(dolphin) & (dolphin != 0), np.nan)
    koala = {dog: float(fox.get(dog, np.nan)) if np.isfinite(fox.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor48')

def factor49(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    panda = pd.Timestamp(wolf)
    fox = list(universe)
    hawk = pd.Period(panda, freq='Q-DEC') - 1
    eagle = pd.PeriodIndex([hawk, hawk - 1, hawk - 2, hawk - 3], freq='Q-DEC')
    giraffe = get_history_fundamentals(security=fox, fields=[rabbit.term_003], watch_date=panda, count=16, interval='1q', stat_by_year=False)
    if giraffe is None or giraffe.empty or 'code' not in giraffe.columns or ('statDate' not in giraffe.columns):
        return _make_factor_series({lion: np.nan for lion in fox}, wolf, universe=universe, name='factor49')
    giraffe = giraffe.copy()
    if 'pubDate' in giraffe.columns:
        whale = pd.to_datetime(giraffe['pubDate'], errors='coerce')
        giraffe = giraffe[whale.notna() & (whale <= panda)]
    giraffe['code'] = giraffe['code'].astype(str)
    giraffe['statDate'] = pd.to_datetime(giraffe['statDate'], errors='coerce')
    giraffe = giraffe.dropna(subset=['code', 'statDate'])
    if giraffe.empty or 'term_003' not in giraffe.columns:
        return _make_factor_series({lion: np.nan for lion in fox}, wolf, universe=universe, name='factor49')
    giraffe['q'] = giraffe['statDate'].dt.to_period('Q-DEC')
    giraffe = giraffe[giraffe['q'].isin(eagle)]
    giraffe = giraffe.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    cat = giraffe.pivot(index='q', columns='code', values='term_003').reindex(index=eagle, columns=fox)
    cat = cat.apply(pd.to_numeric, errors='coerce').astype(float)
    dog = cat.sum(axis=0, min_count=2)

    def _nearest_td_le(d):
        cat = get_trade_days(end_date=d, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    owl = _nearest_td_le(wolf)
    sparrow = _nearest_td_le((pd.Timestamp(wolf) - DateOffset(years=1)).date())
    if owl is None or sparrow is None:
        return _make_factor_series({lion: np.nan for lion in fox}, wolf, universe=universe, name='factor49')
    shark = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(fox))
    rabbit = get_fundamentals(shark, date=pd.Timestamp(owl).strftime('%Y-%m-%d'))
    if rabbit is None or rabbit.empty or 'code' not in rabbit.columns:
        otter = pd.Series(np.nan, index=fox, dtype='float64')
    else:
        rabbit = rabbit.copy()
        rabbit['code'] = rabbit['code'].astype(str)
        otter = pd.to_numeric(rabbit.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(fox)
    bear = get_fundamentals(shark, date=pd.Timestamp(sparrow).strftime('%Y-%m-%d'))
    if bear is None or bear.empty or 'code' not in bear.columns:
        koala = pd.Series(np.nan, index=fox, dtype='float64')
    else:
        bear = bear.copy()
        bear['code'] = bear['code'].astype(str)
        koala = pd.to_numeric(bear.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(fox)
    tiger = (koala + otter) / 2.0
    tiger = tiger * 10000.0
    tiger = tiger.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = dog / tiger
    zebra = zebra.replace([np.inf, -np.inf], np.nan)
    zebra = zebra.where(np.isfinite(tiger) & (tiger > 0), np.nan)
    dolphin = {lion: float(zebra.get(lion, np.nan)) if np.isfinite(zebra.get(lion, np.nan)) else np.nan for lion in fox}
    return _make_factor_series(dolphin, wolf, universe=universe, name='factor49')

def factor50(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    panda = pd.Timestamp(fox)
    otter = list(universe)
    owl = pd.Period(panda, freq='Q-DEC') - 1
    sparrow = owl - 4
    turtle = pd.PeriodIndex([owl, owl - 1, owl - 2, owl - 3], freq='Q-DEC')
    hawk = pd.PeriodIndex([owl, sparrow], freq='Q-DEC')
    bear = get_history_fundamentals(security=otter, fields=[rabbit.term_003], watch_date=panda, count=12, interval='1q', stat_by_year=False)
    wolf = get_history_fundamentals(security=otter, fields=[fox.equities_parent_company_owners], watch_date=panda, count=20, interval='1q', stat_by_year=False)
    if (bear is None or bear.empty) or (wolf is None or wolf.empty):
        return _make_factor_series({koala: np.nan for koala in otter}, fox, universe=universe, name='factor50')

    def _prep(df: pd.DataFrame):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    whale = _prep(bear)
    lion = _prep(wolf)
    if whale is None or lion is None:
        return _make_factor_series({koala: np.nan for koala in otter}, fox, universe=universe, name='factor50')
    cat = whale.pivot(index='q', columns='code', values='term_003').sort_index().reindex(columns=otter)
    giraffe = lion.pivot(index='q', columns='code', values='equities_parent_company_owners').sort_index().reindex(columns=otter)
    cat = cat.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=turtle)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=hawk)
    dog = cat.sum(axis=0, min_count=1)
    zebra = giraffe.loc[owl] if owl in giraffe.index else pd.Series(np.nan, index=otter, dtype='float64')
    rabbit = giraffe.loc[sparrow] if sparrow in giraffe.index else pd.Series(np.nan, index=otter, dtype='float64')
    tiger = (zebra + rabbit) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = dog / tiger
    shark = ~np.isfinite(eagle) | ~np.isfinite(dog) | ~np.isfinite(tiger) | (tiger == 0)
    eagle = eagle.where(~shark, np.nan).reindex(otter)
    dolphin = {koala: float(eagle.get(koala)) if np.isfinite(eagle.get(koala, np.nan)) else np.nan for koala in otter}
    return _make_factor_series(dolphin, fox, universe=universe, name='factor50')

def factor51(universe, date):
    _set_asof_date(date)
    whale = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    shark = [whale - zebra for zebra in range(0, 4)]
    lizard = [f'{eagle.year}q{eagle.quarter}' for eagle in shark]
    panda = {}
    wolf = {}
    for turtle in lizard:
        hawk = query(bear.code, bear.term_063, bear.term_021, bear.term_035, bear.term_038).filter(bear.code.in_(universe))
        dog = get_fundamentals(hawk, statDate=turtle)
        if dog is None or dog.empty:
            panda[turtle] = pd.Series(dtype='float64')
            wolf[turtle] = pd.Series(dtype='float64')
            continue
        dog = dog.set_index('code')
        tiger = dog['term_063'].astype(float) + dog['term_021'].astype(float) + dog['term_035'].astype(float)
        giraffe = dog['term_038'].astype(float)
        fox = dog['term_021'].astype(float)
        dolphin = ~np.isfinite(giraffe) & np.isfinite(fox)
        giraffe = giraffe.where(~dolphin, fox)
        panda[turtle] = tiger
        wolf[turtle] = giraffe
    otter = {}
    for cat in universe:
        koala = []
        rabbit = []
        for turtle in lizard:
            sparrow = panda[turtle]
            owl = wolf[turtle]
            if cat in sparrow.index:
                koala.append(sparrow[cat])
            if cat in owl.index:
                rabbit.append(owl[cat])
        koala = np.asarray(koala, dtype=float)
        rabbit = np.asarray(rabbit, dtype=float)
        if np.isfinite(koala).sum() < 2 or np.isfinite(rabbit).sum() < 2:
            otter[cat] = np.nan
            continue
        lion = np.nansum(koala)
        bear = np.nansum(rabbit)
        if not np.isfinite(lion) or not np.isfinite(bear) or bear == 0:
            frog = np.nan
        else:
            frog = lion / bear
        otter[cat] = float(frog) if np.isfinite(frog) else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor51')

def factor52(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    giraffe = pd.Period(cat, freq='Q-DEC') - 1
    rabbit = giraffe - 4
    fox = pd.PeriodIndex([rabbit, giraffe], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[bear.term_088], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor52')
    koala = koala.copy()
    if 'pubDate' in koala.columns:
        bear = pd.to_datetime(koala['pubDate'], errors='coerce')
        koala = koala[bear.notna() & (bear <= cat)]
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty or 'term_088' not in koala.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor52')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(fox)]
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor52')
    dolphin = koala.pivot(index='q', columns='code', values='term_088').reindex(index=fox, columns=panda)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = dolphin.loc[giraffe]
    zebra = dolphin.loc[rabbit]
    lion = zebra.abs()
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = (whale - zebra) / lion
    wolf = wolf.replace([np.inf, -np.inf], np.nan)
    wolf = wolf.where(np.isfinite(lion) & (lion > 0), np.nan)
    otter = {dog: float(wolf.get(dog, np.nan)) if np.isfinite(wolf.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(otter, tiger, universe=universe, name='factor52')

def factor53(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor53')

def factor54(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor54')

def factor55(universe, date):
    _set_asof_date(date)
    otter = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    wolf = otter
    fox = otter - 20
    giraffe = f'{wolf.year}q{wolf.quarter}'
    rabbit = f'{fox.year}q{fox.quarter}'
    bear = query(fox.code, fox.equities_parent_company_owners).filter(fox.code.in_(universe))
    panda = get_fundamentals(bear, statDate=giraffe)
    dog = get_fundamentals(bear, statDate=rabbit)
    if panda is None or panda.empty:
        panda = pd.DataFrame(columns=['code', 'equities_parent_company_owners'])
    if dog is None or dog.empty:
        dog = pd.DataFrame(columns=['code', 'equities_parent_company_owners'])
    panda = panda.set_index('code')
    dog = dog.set_index('code')
    koala = {}
    for cat in universe:
        lion = panda['equities_parent_company_owners'].get(cat, np.nan)
        tiger = dog['equities_parent_company_owners'].get(cat, np.nan)
        if not np.isfinite(lion) or not np.isfinite(tiger) or tiger == 0:
            zebra = np.nan
        else:
            zebra = (lion - tiger) / tiger
        koala[cat] = float(zebra) if np.isfinite(zebra) else np.nan
    return _make_factor_series(koala, date, universe=universe, name='factor55')

def factor56(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    panda = pd.Timestamp(otter)
    koala = list(universe)
    shark = pd.Period(panda, freq='Q-DEC') - 1
    eagle = pd.PeriodIndex([shark, shark - 1, shark - 2, shark - 3], freq='Q-DEC')

    def _prep(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    wolf = get_history_fundamentals(security=koala, fields=[rabbit.term_003], watch_date=panda, count=12, interval='1q', stat_by_year=False)
    zebra = _prep(wolf)
    if zebra.empty or 'term_003' not in zebra.columns:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor56')
    zebra = zebra[zebra['q'].isin(eagle)]
    if zebra.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor56')
    cat = zebra.pivot(index='q', columns='code', values='term_003').reindex(index=eagle, columns=koala)
    cat = cat.apply(pd.to_numeric, errors='coerce').astype(float)
    dog = cat.sum(axis=0, min_count=1)
    fox = get_history_fundamentals(security=koala, fields=[fox.equities_parent_company_owners], watch_date=panda, count=20, interval='1q', stat_by_year=False)
    tiger = _prep(fox)
    if tiger.empty or 'equities_parent_company_owners' not in tiger.columns:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor56')
    tiger = tiger[tiger['q'].isin([shark])]
    if tiger.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor56')
    rabbit = tiger.pivot(index='q', columns='code', values='equities_parent_company_owners').reindex(index=[shark], columns=koala)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    bear = rabbit.loc[shark] if shark in rabbit.index else pd.Series(np.nan, index=koala, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        whale = dog / bear
    dolphin = ~np.isfinite(whale) | ~np.isfinite(dog) | ~np.isfinite(bear) | (bear == 0)
    whale = whale.where(~dolphin, np.nan).reindex(koala)
    giraffe = {lion: float(whale.get(lion)) if np.isfinite(whale.get(lion, np.nan)) else np.nan for lion in koala}
    return _make_factor_series(giraffe, otter, universe=universe, name='factor56')

def factor57(universe, date):
    _set_asof_date(date)
    wolf = query(fox.code, fox.term_082, fox.inventories, fox.term_002, fox.term_042, fox.term_083).filter(fox.code.in_(universe))
    koala = get_fundamentals(wolf, date=date)
    if koala is None or koala.empty:
        otter = {tiger: np.nan for tiger in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor57')
    koala = koala.set_index('code')
    otter = {}
    for tiger in universe:
        dog = koala['term_082'].get(tiger, np.nan)
        fox = koala['inventories'].get(tiger, np.nan)
        cat = koala['term_002'].get(tiger, np.nan)
        lion = koala['term_042'].get(tiger, 0.0)
        panda = koala['term_083'].get(tiger, np.nan)
        lion = 0.0 if not np.isfinite(lion) else float(lion)
        if not all((np.isfinite(rabbit) for rabbit in [dog, fox, cat, panda])):
            giraffe = np.nan
        else:
            bear = dog - fox - (cat + lion)
            if panda == 0:
                giraffe = np.nan
            else:
                giraffe = bear / panda
        otter[tiger] = float(giraffe) if np.isfinite(giraffe) else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor57')

def factor58(universe, date, N=8):
    _set_asof_date(date)
    lion = list(universe)
    dolphin = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    whale = [dolphin - giraffe for giraffe in range(int(N) - 1, -1, -1)]
    owl = [f'{shark.year}q{shark.quarter}' for shark in whale]
    koala = pd.DataFrame(index=lion, columns=owl, dtype='float64')
    bear = pd.DataFrame(index=lion, columns=owl, dtype='float64')
    for sparrow in owl:
        hawk = query(bear.code, bear.term_087).filter(bear.code.in_(lion))
        fox = get_fundamentals(hawk, statDate=sparrow)
        if fox is not None and (not fox.empty):
            fox = fox.set_index('code')
            koala[sparrow] = pd.to_numeric(fox.get('term_087', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion)
        eagle = query(fox.code, fox.term_025).filter(fox.code.in_(lion))
        otter = get_fundamentals(eagle, statDate=sparrow)
        if otter is not None and (not otter.empty):
            otter = otter.set_index('code')
            bear[sparrow] = pd.to_numeric(otter.get('term_025', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion)
    rabbit = {}
    for tiger in lion:
        salmon = koala.loc[tiger, :].values.astype(float)
        turtle = bear.loc[tiger, :].values.astype(float)
        zebra = np.isfinite(salmon) & np.isfinite(turtle)
        tuna = salmon[zebra]
        lizard = turtle[zebra]
        if tuna.size < 3:
            rabbit[tiger] = np.nan
            continue
        alpaca = _zscore_series(pd.Series(tuna)).values
        frog = _zscore_series(pd.Series(lizard)).values
        cat = np.column_stack([np.ones(frog.size, dtype=float), frog])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, alpaca, rcond=None)
            wolf = float((alpaca - cat.dot(panda))[-1])
        except Exception:
            wolf = np.nan
        rabbit[tiger] = float(wolf) if np.isfinite(wolf) else np.nan
    return _make_factor_series(rabbit, date, universe=universe, name='factor58')

def factor59(universe, date, N=20):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = _last_n_trade_days(panda, N)
    if len(tiger) == 0:
        wolf = {dog: np.nan for dog in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor59')
    giraffe = list(universe)
    rabbit = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(panda).strftime('%Y-%m-%d')
    koala = get_price(giraffe, start_date=rabbit, end_date=fox, frequency='daily', fields=['open', 'high', 'low'], fq='post', panel=False)
    if koala is None or koala.empty:
        wolf = {dog: np.nan for dog in giraffe}
        return _make_factor_series(wolf, date, universe=universe, name='factor59')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index()
    if 'code' not in koala.columns:
        wolf = {dog: np.nan for dog in giraffe}
        return _make_factor_series(wolf, date, universe=universe, name='factor59')
    koala['time'] = pd.to_datetime(koala['time'])
    koala = koala[['time', 'code', 'open', 'high', 'low']].dropna(subset=['open', 'high', 'low'])
    koala['open'] = koala['open'].astype(float)
    koala['high'] = koala['high'].astype(float)
    koala['low'] = koala['low'].astype(float)
    koala = koala.sort_values(['code', 'time'])
    otter = koala.groupby('code', sort=False).tail(int(N))
    bear = (otter['high'] - otter['open']).groupby(otter['code'], sort=False).sum()
    lion = (otter['open'] - otter['low']).groupby(otter['code'], sort=False).sum()
    with np.errstate(divide='ignore', invalid='ignore'):
        cat = bear / lion * 100.0
    cat = cat.replace([np.inf, -np.inf], np.nan)
    wolf = {dog: float(cat.get(dog, np.nan)) if np.isfinite(cat.get(dog, np.nan)) else np.nan for dog in giraffe}
    return _make_factor_series(wolf, date, universe=universe, name='factor59')

def factor60(universe, date, N=20):
    _set_asof_date(date)
    dog = _to_date(date)
    panda = _last_n_trade_days(dog, N)
    if len(panda) == 0:
        fox = {cat: np.nan for cat in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor60')
    rabbit = list(universe)
    bear = pd.to_datetime(panda[0]).strftime('%Y-%m-%d')
    otter = pd.to_datetime(dog).strftime('%Y-%m-%d')
    tiger = get_price(rabbit, start_date=bear, end_date=otter, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if tiger is None or tiger.empty:
        fox = {cat: np.nan for cat in rabbit}
        return _make_factor_series(fox, date, universe=universe, name='factor60')
    tiger = tiger.copy()
    if 'time' not in tiger.columns:
        tiger = tiger.reset_index()
    if 'code' not in tiger.columns:
        fox = {cat: np.nan for cat in rabbit}
        return _make_factor_series(fox, date, universe=universe, name='factor60')
    tiger['time'] = pd.to_datetime(tiger['time'])
    tiger = tiger[['time', 'code', 'open', 'close']].dropna(subset=['open', 'close'])
    tiger['open'] = tiger['open'].astype(float)
    tiger['close'] = tiger['close'].astype(float)
    tiger = tiger.sort_values(['code', 'time'])
    lion = tiger.groupby('code', sort=False).tail(int(N))
    koala = (lion['close'] - lion['open']).groupby(lion['code'], sort=False).sum()
    wolf = koala / float(N)
    wolf = wolf.replace([np.inf, -np.inf], np.nan)
    fox = {cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in rabbit}
    return _make_factor_series(fox, date, universe=universe, name='factor60')

def factor61(universe, date):
    _set_asof_date(date)
    lion = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    dog = get_fundamentals(lion, date=date)
    if dog is None or dog.empty:
        panda = {cat: np.nan for cat in universe}
        return _make_factor_series(panda, date, universe=universe, name='factor61')
    dog = dog.set_index('code')
    panda = {}
    for cat in universe:
        tiger = dog['term_045'].get(cat, np.nan)
        if not np.isfinite(tiger) or tiger <= 0:
            koala = np.nan
        else:
            koala = np.log(tiger)
        panda[cat] = float(koala) if np.isfinite(koala) else np.nan
    return _make_factor_series(panda, date, universe=universe, name='factor61')

def factor62(universe, date):
    _set_asof_date(date)
    tiger = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=date, count=1)
    panda = tiger.get('np_parent_company_owners_ttm', None)
    if panda is None or panda.empty:
        lion = {cat: np.nan for cat in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor62')
    wolf = panda.iloc[-1]
    bear = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    dog = get_fundamentals(bear, date=date)
    if dog is None or dog.empty:
        lion = {cat: np.nan for cat in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor62')
    dog = dog.set_index('code')
    koala = dog['term_045']
    lion = {}
    for cat in universe:
        fox = wolf.get(cat, np.nan)
        otter = koala.get(cat, np.nan)
        if not np.isfinite(fox) or not np.isfinite(otter) or otter <= 0:
            rabbit = np.nan
        else:
            rabbit = fox / otter
        lion[cat] = float(rabbit) if np.isfinite(rabbit) else np.nan
    return _make_factor_series(lion, date, universe=universe, name='factor62')

def factor63(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    panda = _r3_safe_date(date)
    koala = _r3_fundamentals(bear, [bear.term_052], dog, date=panda)
    lion = _r3_fundamentals(fox, [fox.term_081], dog, date=panda)
    tiger = _r3_join_code(dog, koala, lion)
    otter = pd.to_numeric(tiger.get('term_052', np.nan), errors='coerce')
    fox = pd.to_numeric(tiger.get('term_081', np.nan), errors='coerce')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = otter / fox
    wolf = wolf.where(np.isfinite(wolf) & (fox != 0), np.nan)
    return _make_factor_series({cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in dog}, date, universe=universe, name='factor63')

def factor64(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    dolphin = pd.Period(cat, freq='Q-DEC') - 1
    zebra = dolphin - 4
    bear = pd.PeriodIndex([zebra, dolphin], freq='Q-DEC')
    lion = get_history_fundamentals(security=panda, fields=[fox.inventories], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if lion is None or lion.empty or 'code' not in lion.columns or ('statDate' not in lion.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor64')
    lion = lion.copy()
    if 'pubDate' in lion.columns:
        giraffe = pd.to_datetime(lion['pubDate'], errors='coerce')
        lion = lion[giraffe.notna() & (giraffe <= cat)]
    lion['code'] = lion['code'].astype(str)
    lion['statDate'] = pd.to_datetime(lion['statDate'], errors='coerce')
    lion = lion.dropna(subset=['code', 'statDate'])
    if lion.empty or 'inventories' not in lion.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor64')
    lion['q'] = lion['statDate'].dt.to_period('Q-DEC')
    lion = lion[lion['q'].isin(bear)]
    lion = lion.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if lion.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor64')
    fox = lion.pivot(index='q', columns='code', values='inventories').reindex(index=bear, columns=panda)
    fox = fox.apply(pd.to_numeric, errors='coerce').astype(float)
    wolf = fox.loc[dolphin]
    otter = fox.loc[zebra]
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = (wolf - otter) / otter
    rabbit = rabbit.replace([np.inf, -np.inf], np.nan)
    rabbit = rabbit.where(np.isfinite(otter) & (otter != 0), np.nan)
    koala = {dog: float(rabbit.get(dog, np.nan)) if np.isfinite(rabbit.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor64')

def factor65(universe, date):
    _set_asof_date(date)
    koala = query(fox.code, fox.term_012, fox.term_092, fox.term_083).filter(fox.code.in_(universe))
    tiger = get_fundamentals(koala, date=date)
    if tiger is None or tiger.empty:
        lion = {panda: np.nan for panda in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor65')
    tiger = tiger.set_index('code')
    lion = {}
    for panda in universe:
        cat = tiger['term_012'].get(panda, np.nan)
        otter = tiger['term_092'].get(panda, np.nan)
        dog = tiger['term_083'].get(panda, np.nan)
        if not all((np.isfinite(fox) for fox in [cat, otter, dog])) or dog == 0:
            wolf = np.nan
        else:
            wolf = (cat + otter) / dog
        lion[panda] = float(wolf) if np.isfinite(wolf) else np.nan
    return _make_factor_series(lion, date, universe=universe, name='factor65')

def factor66(universe, date):
    _set_asof_date(date)
    otter = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=date, count=1)
    lion = otter.get('np_parent_company_owners_ttm', None)
    if lion is None or lion.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor66')
    panda = lion.iloc[-1]
    tiger = (pd.to_datetime(date) - DateOffset(years=1)).strftime('%Y-%m-%d')
    fox = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=tiger, count=1)
    koala = fox.get('np_parent_company_owners_ttm', None)
    if koala is None or koala.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor66')
    rabbit = koala.iloc[-1]
    wolf = {}
    for cat in universe:
        dog = panda.get(cat, np.nan)
        bear = rabbit.get(cat, np.nan)
        if not np.isfinite(dog) or not np.isfinite(bear) or bear == 0:
            giraffe = np.nan
        else:
            giraffe = (dog - bear) / abs(bear)
        wolf[cat] = float(giraffe) if np.isfinite(giraffe) else np.nan
    return _make_factor_series(wolf, date, universe=universe, name='factor66')

def factor67(universe, date, N=5):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = _last_n_trade_days(bear, int(N) * 3)
    if len(rabbit) == 0:
        dolphin = {wolf: np.nan for wolf in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor67')
    hawk = list(universe)
    eagle = pd.to_datetime(rabbit[0]).strftime('%Y-%m-%d')
    zebra = pd.to_datetime(bear).strftime('%Y-%m-%d')
    giraffe = get_price(hawk, start_date=eagle, end_date=zebra, frequency='daily', fields=['close'], fq='post', panel=False)
    if giraffe is None or giraffe.empty:
        dolphin = {wolf: np.nan for wolf in hawk}
        return _make_factor_series(dolphin, date, universe=universe, name='factor67')
    giraffe = giraffe.copy()
    if 'time' not in giraffe.columns:
        giraffe = giraffe.reset_index()
    if 'code' not in giraffe.columns:
        dolphin = {wolf: np.nan for wolf in hawk}
        return _make_factor_series(dolphin, date, universe=universe, name='factor67')
    giraffe['time'] = pd.to_datetime(giraffe['time'])
    fox = giraffe.pivot(index='time', columns='code', values='close').sort_index()
    fox = fox.reindex(columns=hawk)
    otter = fox.values.astype(float)
    lion, tiger = otter.shape
    if lion < int(N) + 2:
        dolphin = {wolf: np.nan for wolf in hawk}
        return _make_factor_series(dolphin, date, universe=universe, name='factor67')

    def _ema_mat(x, n):
        cat = 2.0 / (float(n) + 1.0)
        otter = np.full_like(x, np.nan, dtype=float)
        otter[0, :] = x[0, :]
        for wolf in range(1, x.shape[0]):
            bear = x[wolf, :]
            fox = otter[wolf - 1, :]
            dog = np.full_like(fox, np.nan, dtype=float)
            koala = np.isfinite(bear)
            lion = np.isfinite(fox)
            panda = koala & lion
            dog[panda] = cat * bear[panda] + (1.0 - cat) * fox[panda]
            tiger = koala & ~lion
            dog[tiger] = bear[tiger]
            otter[wolf, :] = dog
        return otter
    cat = _ema_mat(otter, N)
    dog = _ema_mat(cat, N)
    panda = _ema_mat(dog, N)
    koala = 3.0 * cat - 3.0 * dog + panda
    shark = koala[-1, :]
    dolphin = {wolf: float(shark[whale]) if np.isfinite(shark[whale]) else np.nan for whale, wolf in enumerate(hawk)}
    return _make_factor_series(dolphin, date, universe=universe, name='factor67')

def factor68(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    cat = pd.Timestamp(fox)
    lion = list(universe)
    owl = pd.Period(cat, freq='Q-DEC') - 1
    sparrow = owl - 4
    eagle = pd.PeriodIndex([owl, owl - 1, owl - 2, owl - 3], freq='Q-DEC')
    hawk = pd.PeriodIndex([owl, sparrow], freq='Q-DEC')
    bear = get_history_fundamentals(security=lion, fields=[bear.term_060], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    wolf = get_history_fundamentals(security=lion, fields=[fox.inventories], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if (bear is None or bear.empty) or (wolf is None or wolf.empty):
        return _make_factor_series({tiger: np.nan for tiger in lion}, fox, universe=universe, name='factor68')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    giraffe = _prep(bear)
    panda = _prep(wolf)
    if giraffe is None or panda is None:
        return _make_factor_series({tiger: np.nan for tiger in lion}, fox, universe=universe, name='factor68')
    koala = giraffe.pivot(index='q', columns='code', values='term_060').sort_index().reindex(columns=lion)
    koala = koala.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=eagle)
    otter = koala.sum(axis=0, min_count=2)
    dolphin = panda.pivot(index='q', columns='code', values='inventories').sort_index().reindex(columns=lion)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=hawk)
    zebra = dolphin.loc[owl]
    whale = dolphin.loc[sparrow]
    dog = (zebra + whale) / 2.0
    dog = dog.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = otter / dog
    shark = shark.replace([np.inf, -np.inf], np.nan)
    shark = shark.where(np.isfinite(dog) & (dog > 0) & np.isfinite(otter) & (otter > 0), np.nan)
    rabbit = {tiger: float(shark.get(tiger, np.nan)) if np.isfinite(shark.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(rabbit, fox, universe=universe, name='factor68')

def factor69(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor69')

def factor70(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    zebra = whale - 4
    dolphin = pd.PeriodIndex([zebra, whale], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    lion = get_history_fundamentals(security=panda, fields=[bear.term_052], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    otter = _prep_hist(lion)
    if otter.empty or 'term_052' not in otter.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor70')
    otter = otter[otter['q'].isin(dolphin)]
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor70')
    bear = otter.pivot(index='q', columns='code', values='term_052').reindex(index=dolphin, columns=panda)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = bear.loc[whale] if whale in bear.index else pd.Series(np.nan, index=panda, dtype='float64')
    wolf = bear.loc[zebra] if zebra in bear.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = (rabbit - wolf) / np.abs(wolf)
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    fox = ~np.isfinite(giraffe) | ~np.isfinite(rabbit) | ~np.isfinite(wolf) | (wolf == 0)
    giraffe = giraffe.where(~fox, np.nan).reindex(panda)
    koala = {dog: float(giraffe.get(dog)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor70')

def factor71(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor71')

def factor72(universe, date, K_months=3):
    _set_asof_date(date)
    panda = _to_date(date)
    wolf = int(K_months * 21)
    tiger = _last_n_trade_days(panda, wolf)
    if len(tiger) == 0:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor72')
    whale = list(universe)
    dolphin = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    otter = pd.to_datetime(panda).strftime('%Y-%m-%d')
    giraffe = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(whale))
    lion = get_fundamentals(giraffe, date=otter)
    if lion is None or lion.empty:
        cat = pd.Series(np.nan, index=whale, dtype='float64')
    else:
        cat = pd.Series(lion['circulating_cap'].values, index=lion['code'].values).astype(float).reindex(whale)
    cat = cat.where(np.isfinite(cat) & (cat > 0), np.nan)
    koala = get_price(whale, start_date=dolphin, end_date=otter, frequency='daily', fields=['volume'], fq='post', panel=False)
    if koala is None or koala.empty:
        fox = {dog: np.nan for dog in whale}
        return _make_factor_series(fox, date, universe=universe, name='factor72')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index()
    if 'code' not in koala.columns:
        fox = {dog: np.nan for dog in whale}
        return _make_factor_series(fox, date, universe=universe, name='factor72')
    koala = koala[['code', 'volume']].dropna(subset=['volume'])
    koala['volume'] = koala['volume'].astype(float)
    koala = koala[np.isfinite(koala['volume'].values)]
    eagle = koala.groupby('code', sort=False)['volume'].sum()
    bear = koala.groupby('code', sort=False)['volume'].count()
    fox = {}
    for dog in whale:
        hawk = float(eagle.get(dog, np.nan))
        rabbit = float(bear.get(dog, np.nan))
        zebra = cat.get(dog, np.nan)
        if not np.isfinite(hawk) or not np.isfinite(rabbit) or rabbit <= 0:
            fox[dog] = np.nan
            continue
        if not np.isfinite(zebra) or zebra <= 0:
            fox[dog] = np.nan
            continue
        shark = hawk / (float(zebra) * 10000.0 * rabbit)
        fox[dog] = float(shark) if np.isfinite(shark) else np.nan
    return _make_factor_series(fox, date, universe=universe, name='factor72')

def factor73(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    sparrow = pd.Period(cat, freq='Q-DEC') - 1
    owl = sparrow - 1
    shark = sparrow - 4
    hawk = pd.PeriodIndex([owl, sparrow], freq='Q-DEC')
    eagle = pd.PeriodIndex([shark, sparrow], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    otter = get_history_fundamentals(security=tiger, fields=[rabbit.roe], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    zebra = _prep_hist(otter)
    if zebra.empty or 'roe' not in zebra.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor73')
    zebra = zebra[zebra['q'].isin(hawk)]
    if zebra.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor73')
    lizard = zebra.pivot(index='q', columns='code', values='roe').reindex(index=hawk, columns=tiger)
    lizard = lizard.apply(pd.to_numeric, errors='coerce').astype(float)
    frog = lizard.loc[sparrow] if sparrow in lizard.index else pd.Series(np.nan, index=tiger, dtype='float64')
    salmon = lizard.loc[owl] if owl in lizard.index else pd.Series(np.nan, index=tiger, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        turtle = (frog - salmon) / np.abs(salmon)
    turtle = turtle.replace([np.inf, -np.inf], np.nan)
    koala = get_history_fundamentals(security=tiger, fields=[fox.equities_parent_company_owners], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    dog = _prep_hist(koala)
    if dog.empty or 'equities_parent_company_owners' not in dog.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor73')
    dog = dog[dog['q'].isin(eagle)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor73')
    bear = dog.pivot(index='q', columns='code', values='equities_parent_company_owners').reindex(index=eagle, columns=tiger)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = bear.loc[sparrow] if sparrow in bear.index else pd.Series(np.nan, index=tiger, dtype='float64')
    wolf = bear.loc[shark] if shark in bear.index else pd.Series(np.nan, index=tiger, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        fox = (rabbit - wolf) / wolf
    fox = fox.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        whale = turtle - fox
    dolphin = ~np.isfinite(whale) | ~np.isfinite(turtle) | ~np.isfinite(fox) | (salmon == 0) | (wolf == 0)
    whale = whale.where(~dolphin, np.nan).reindex(tiger)
    giraffe = {panda: float(whale.get(panda)) if np.isfinite(whale.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(giraffe, lion, universe=universe, name='factor73')

def factor74(universe, date, K_months=3):
    _set_asof_date(date)
    lion = _to_date(date)
    rabbit = int(K_months * 21) + 1
    koala = _last_n_trade_days(lion, rabbit)
    if len(koala) < 2:
        wolf = {tiger: np.nan for tiger in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor74')
    zebra = list(universe)
    giraffe = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(lion).strftime('%Y-%m-%d')
    otter = get_price(zebra, start_date=giraffe, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        wolf = {tiger: np.nan for tiger in zebra}
        return _make_factor_series(wolf, date, universe=universe, name='factor74')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    if 'code' not in otter.columns:
        wolf = {tiger: np.nan for tiger in zebra}
        return _make_factor_series(wolf, date, universe=universe, name='factor74')
    otter['time'] = pd.to_datetime(otter['time'])
    panda = otter.pivot(index='time', columns='code', values='close').sort_index()
    panda = panda.reindex(columns=zebra)
    cat = panda.iloc[0]
    dog = panda.iloc[-1]
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = dog / cat - 1.0
    bear = bear.replace([np.inf, -np.inf], np.nan)
    wolf = {tiger: float(bear.get(tiger, np.nan)) if np.isfinite(bear.get(tiger, np.nan)) else np.nan for tiger in zebra}
    return _make_factor_series(wolf, date, universe=universe, name='factor74')

def factor75(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    zebra = pd.Period(cat, freq='Q-DEC') - 1
    whale = zebra - 1
    giraffe = pd.PeriodIndex([zebra, zebra - 1, zebra - 2, zebra - 3], freq='Q-DEC')
    dolphin = pd.PeriodIndex([zebra, whale], freq='Q-DEC')
    fox = get_history_fundamentals(security=lion, fields=[bear.term_088], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    otter = get_history_fundamentals(security=lion, fields=[fox.term_081], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if (fox is None or fox.empty) or (otter is None or otter.empty):
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor75')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    bear = _prep(fox)
    panda = _prep(otter)
    if bear is None or panda is None:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor75')
    shark = bear.pivot(index='q', columns='code', values='term_088').sort_index().reindex(columns=lion)
    shark = shark.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=giraffe)
    eagle = shark.sum(axis=0, min_count=2)
    hawk = panda.pivot(index='q', columns='code', values='term_081').sort_index().reindex(columns=lion)
    hawk = hawk.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=dolphin)
    sparrow = hawk.loc[zebra]
    owl = hawk.loc[whale]
    dog = (sparrow + owl) / 2.0
    dog = dog.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = eagle / dog
    rabbit = rabbit.replace([np.inf, -np.inf], np.nan)
    rabbit = rabbit.where(np.isfinite(dog) & (dog > 0) & np.isfinite(eagle) & (eagle > 0), np.nan)
    wolf = {tiger: float(rabbit.get(tiger, np.nan)) if np.isfinite(rabbit.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(wolf, koala, universe=universe, name='factor75')

def factor76(universe, date):
    _set_asof_date(date)
    otter = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=date, count=1)
    lion = otter.get('np_parent_company_owners_ttm', None)
    if lion is None or lion.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor76')
    panda = lion.iloc[-1]
    tiger = (pd.to_datetime(date) - DateOffset(years=1)).strftime('%Y-%m-%d')
    fox = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=tiger, count=1)
    koala = fox.get('np_parent_company_owners_ttm', None)
    if koala is None or koala.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor76')
    rabbit = koala.iloc[-1]
    wolf = {}
    for cat in universe:
        dog = panda.get(cat, np.nan)
        bear = rabbit.get(cat, np.nan)
        if not np.isfinite(dog) or not np.isfinite(bear) or bear == 0:
            giraffe = np.nan
        else:
            giraffe = (dog - bear) / abs(bear)
        wolf[cat] = float(giraffe) if np.isfinite(giraffe) else np.nan
    return _make_factor_series(wolf, date, universe=universe, name='factor76')

def factor77(universe, date, tau=12, mkt_index='000905.XSHG'):
    _set_asof_date(date)
    bear = _to_date(date)
    tiger = int((tau + 1) * 22 + 5)
    rabbit = _last_n_trade_days(bear, tiger)
    if len(rabbit) < 22:
        return _make_factor_series({}, date, universe=universe, name='factor77')
    llama = rabbit[0]
    whale = rabbit[-1]
    tuna = _get_daily_close_series(mkt_index, llama, whale)
    if tuna is None or tuna.size < 2:
        return _make_factor_series({}, date, universe=universe, name='factor77')
    tuna = tuna.sort_index()
    hyena = tuna.pct_change().dropna()
    if hyena.size < 22:
        return _make_factor_series({}, date, universe=universe, name='factor77')
    lemur = hyena.index.to_period('M')
    iguana = hyena.groupby(lemur).apply(lambda x: (1.0 + penguin).prod() - 1.0)
    badger = iguana.index.sort_values()
    if len(badger) > tau + 1:
        beaver = badger[-(tau + 1):]
    else:
        beaver = badger
    jaguar = iguana.reindex(beaver)
    if jaguar.dropna().size < 3:
        return _make_factor_series({}, date, universe=universe, name='factor77')
    cat = len(beaver)
    lion = np.array([0.9 ** (cat - 1 - sparrow) for sparrow in range(cat)], dtype=float)
    wolf = list(universe)
    mole = pd.to_datetime(llama).strftime('%Y-%m-%d')
    shark = pd.to_datetime(whale).strftime('%Y-%m-%d')
    zebra = get_price(wolf, start_date=mole, end_date=shark, frequency='daily', fields=['close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor77')
    zebra = zebra.copy()
    if 'time' not in zebra.columns:
        zebra = zebra.reset_index()
    if 'code' not in zebra.columns:
        return _make_factor_series({}, date, universe=universe, name='factor77')
    zebra['time'] = pd.to_datetime(zebra['time'])
    otter = zebra.pivot(index='time', columns='code', values='close').sort_index()
    otter = otter.reindex(columns=wolf)
    donkey = otter.pct_change()
    hawk = {}
    for fox in wolf:
        if fox not in donkey.columns:
            continue
        kangaroo = donkey[fox].dropna()
        if kangaroo.size < 10:
            continue
        alpaca = kangaroo.index.to_period('M')
        ferret = kangaroo.groupby(alpaca).apply(lambda x: (1.0 + penguin).prod() - 1.0)
        gecko = ferret.reindex(beaver)
        frog = gecko.notna() & jaguar.notna()
        if frog.sum() < 3:
            continue
        camel = beaver[frog.values]
        quail = gecko[frog].values.astype(float)
        penguin = jaguar[frog].values.astype(float)
        if np.std(penguin, ddof=1) == 0:
            continue
        dog = np.column_stack([np.ones_like(penguin), penguin])
        try:
            koala, panda, panda, panda = np.linalg.lstsq(dog, quail, rcond=None)
        except Exception:
            continue
        eagle = quail - dog.dot(koala)
        if eagle.size < 2:
            continue
        octopus = np.array([lion[beaver.get_loc(lizard)] for lizard in camel], dtype=float)
        salmon = np.isfinite(eagle) & np.isfinite(octopus)
        if salmon.sum() < 2:
            continue
        dolphin = eagle[salmon] ** 2
        narwhal = octopus[salmon]
        giraffe = float(narwhal.sum())
        if giraffe <= 0:
            continue
        turtle = float(np.sum(narwhal * dolphin) / giraffe)
        if not np.isfinite(turtle) or turtle < 0:
            continue
        owl = float(np.sqrt(turtle))
        if np.isfinite(owl):
            hawk[fox] = owl
    return _make_factor_series(hawk, date, universe=universe, name='factor77')

def factor78(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    cat = pd.Timestamp(fox)
    otter = list(universe)
    lizard = pd.Period(cat, freq='Q-DEC') - 1
    frog = lizard - 1
    salmon = pd.PeriodIndex([lizard, lizard - 1, lizard - 2, lizard - 3], freq='Q-DEC')
    turtle = pd.PeriodIndex([frog, lizard], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    koala = pd.Series(np.nan, index=otter, dtype='float64')
    alpaca = _nearest_td_le(fox)
    if alpaca is not None:
        try:
            giraffe = get_factor_values(otter, factors=['term_051'], end_date=alpaca, count=1)
            wolf = giraffe.get('term_051', None) if isinstance(giraffe, dict) else None
            if isinstance(wolf, pd.DataFrame) and (not wolf.empty):
                tuna = wolf.iloc[-1]
                tuna.index = tuna.index.astype(str)
                koala = pd.to_numeric(tuna, errors='coerce').astype(float).reindex(otter)
        except Exception:
            pass
    if koala.notna().sum() < 10:
        rabbit = get_history_fundamentals(security=otter, fields=[wolf.term_049], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        lion = _prep_hist(rabbit)
        if not lion.empty and 'term_049' in lion.columns:
            lion = lion[lion['q'].isin(salmon)]
            if not lion.empty:
                owl = lion.pivot(index='q', columns='code', values='term_049').reindex(index=salmon, columns=otter)
                owl = owl.apply(pd.to_numeric, errors='coerce').astype(float)
                dolphin = owl.sum(axis=0, min_count=1).reindex(otter)
                koala = koala.where(np.isfinite(koala), dolphin)
    bear = get_history_fundamentals(security=otter, fields=[fox.term_084], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(bear)
    if panda.empty or 'term_084' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in otter}, fox, universe=universe, name='factor78')
    panda = panda[panda['q'].isin(turtle)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in otter}, fox, universe=universe, name='factor78')
    shark = panda.pivot(index='q', columns='code', values='term_084').reindex(index=turtle, columns=otter)
    shark = shark.apply(pd.to_numeric, errors='coerce').astype(float)
    eagle = shark.loc[lizard] if lizard in shark.index else pd.Series(np.nan, index=otter, dtype='float64')
    hawk = shark.loc[frog] if frog in shark.index else pd.Series(np.nan, index=otter, dtype='float64')
    dog = (eagle + hawk) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        sparrow = koala / dog
    whale = ~np.isfinite(sparrow) | ~np.isfinite(koala) | ~np.isfinite(dog) | (dog == 0)
    sparrow = sparrow.where(~whale, np.nan).reindex(otter)
    zebra = {tiger: float(sparrow.get(tiger)) if np.isfinite(sparrow.get(tiger, np.nan)) else np.nan for tiger in otter}
    return _make_factor_series(zebra, fox, universe=universe, name='factor78')

def factor79(universe, date):
    _set_asof_date(date)
    dolphin = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=date, count=1)
    bear = dolphin.get('np_parent_company_owners_ttm', None)
    if bear is None or bear.empty:
        whale = {panda: np.nan for panda in universe}
        return _make_factor_series(whale, date, universe=universe, name='factor79')
    owl = bear.iloc[-1]
    lizard = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    fox = get_fundamentals(lizard, date=date)
    if fox is None or fox.empty:
        fox = pd.DataFrame(columns=['code', 'term_045'])
    fox = fox.set_index('code')
    eagle = fox['term_045']
    dog = {}
    for panda in universe:
        turtle = owl.get(panda, np.nan)
        hawk = eagle.get(panda, np.nan)
        if not np.isfinite(turtle) or not np.isfinite(hawk) or hawk <= 0:
            dog[panda] = np.nan
        else:
            dog[panda] = turtle / hawk
    koala = _last_n_trade_days(date, 61)
    if len(koala) < 2:
        cat = {panda: np.nan for panda in universe}
    else:
        tiger = koala[0]
        lion = pd.to_datetime(tiger).strftime('%Y-%m-%d')
        zebra = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=lion, count=1)
        wolf = zebra.get('np_parent_company_owners_ttm', None)
        if wolf is None or wolf.empty:
            cat = {panda: np.nan for panda in universe}
        else:
            sparrow = wolf.iloc[-1]
            otter = get_fundamentals(lizard, date=lion)
            if otter is None or otter.empty:
                otter = pd.DataFrame(columns=['code', 'term_045'])
            otter = otter.set_index('code')
            shark = otter['term_045']
            cat = {}
            for panda in universe:
                turtle = sparrow.get(panda, np.nan)
                hawk = shark.get(panda, np.nan)
                if not np.isfinite(turtle) or not np.isfinite(hawk) or hawk <= 0:
                    cat[panda] = np.nan
                else:
                    cat[panda] = turtle / hawk
    whale = {}
    for panda in universe:
        giraffe = dog.get(panda, np.nan)
        rabbit = cat.get(panda, np.nan)
        if not np.isfinite(giraffe) or not np.isfinite(rabbit):
            frog = np.nan
        else:
            frog = giraffe - rabbit
        whale[panda] = float(frog) if np.isfinite(frog) else np.nan
    return _make_factor_series(whale, date, universe=universe, name='factor79')

def factor80(universe, date, N=20):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = _last_n_trade_days(otter, N)
    if len(fox) == 0:
        zebra = {koala: np.nan for koala in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor80')
    whale = list(universe)
    dolphin = pd.to_datetime(fox[0]).strftime('%Y-%m-%d')
    giraffe = pd.to_datetime(otter).strftime('%Y-%m-%d')
    bear = get_price(whale, start_date=dolphin, end_date=giraffe, frequency='daily', fields=['high', 'low', 'close', 'volume'], fq='post', panel=False)
    if bear is None or bear.empty:
        zebra = {koala: np.nan for koala in whale}
        return _make_factor_series(zebra, date, universe=universe, name='factor80')
    bear = bear.copy()
    if 'time' not in bear.columns:
        bear = bear.reset_index()
    if 'code' not in bear.columns:
        zebra = {koala: np.nan for koala in whale}
        return _make_factor_series(zebra, date, universe=universe, name='factor80')
    bear['time'] = pd.to_datetime(bear['time'])
    bear = bear[['time', 'code', 'high', 'low', 'close', 'volume']].dropna(subset=['high', 'low', 'close', 'volume'])
    for cat in ['high', 'low', 'close', 'volume']:
        bear[cat] = bear[cat].astype(float)
    bear = bear.sort_values(['code', 'time'])
    rabbit = bear.groupby('code', sort=False).tail(int(N))
    wolf = (rabbit['high'] - rabbit['low']).astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        panda = (rabbit['close'] - rabbit['low'] - (rabbit['high'] - rabbit['close'])) / wolf
    panda = panda.replace([np.inf, -np.inf], np.nan).fillna(0.0)
    dog = panda.values.astype(float) * rabbit['volume'].values.astype(float)
    rabbit = rabbit.assign(_clv=dog)
    tiger = rabbit.groupby('code', sort=False)['_clv'].sum()
    shark = rabbit.groupby('code', sort=False)['volume'].sum()
    with np.errstate(divide='ignore', invalid='ignore'):
        lion = tiger / shark * 100.0
    lion = lion.replace([np.inf, -np.inf], np.nan)
    zebra = {koala: float(lion.get(koala, np.nan)) if np.isfinite(lion.get(koala, np.nan)) else np.nan for koala in whale}
    return _make_factor_series(zebra, date, universe=universe, name='factor80')

def factor81(universe, date):
    _set_asof_date(date)
    koala = query(bear.code, bear.term_072, bear.term_004).filter(bear.code.in_(universe))
    dog = get_fundamentals(koala, date=date)
    if dog is None or dog.empty:
        dog = pd.DataFrame(columns=['code', 'term_072', 'term_004'])
    dog = dog.set_index('code')
    otter = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    panda = get_fundamentals(otter, date=date)
    if panda is None or panda.empty:
        panda = pd.DataFrame(columns=['code', 'term_045'])
    panda = panda.set_index('code')
    tiger = {}
    for cat in universe:
        fox = dog['term_072'].get(cat, np.nan)
        if not np.isfinite(fox):
            fox = dog['term_004'].get(cat, np.nan)
        lion = panda['term_045'].get(cat, np.nan)
        if not np.isfinite(fox) or not np.isfinite(lion) or lion <= 0:
            wolf = np.nan
        else:
            wolf = fox / lion
        tiger[cat] = float(wolf) if np.isfinite(wolf) else np.nan
    return _make_factor_series(tiger, date, universe=universe, name='factor81')

def factor82(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    zebra = whale - 4
    dolphin = pd.PeriodIndex([zebra, whale], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    lion = get_history_fundamentals(security=panda, fields=[bear.np_parent_company_owners], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    otter = _prep_hist(lion)
    if otter.empty or 'np_parent_company_owners' not in otter.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor82')
    otter = otter[otter['q'].isin(dolphin)]
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor82')
    bear = otter.pivot(index='q', columns='code', values='np_parent_company_owners').reindex(index=dolphin, columns=panda)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = bear.loc[whale] if whale in bear.index else pd.Series(np.nan, index=panda, dtype='float64')
    wolf = bear.loc[zebra] if zebra in bear.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = (rabbit - wolf) / np.abs(wolf)
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    fox = ~np.isfinite(giraffe) | ~np.isfinite(rabbit) | ~np.isfinite(wolf) | (wolf == 0)
    giraffe = giraffe.where(~fox, np.nan).reindex(panda)
    koala = {dog: float(giraffe.get(dog)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor82')

def factor83(universe, date, d=20, alpha=None, batch_size=200):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = get_trade_days(end_date=koala, count=d + 1)
    if len(otter) < 2:
        rabbit = {lion: np.nan for lion in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor83')
    donkey = list(otter[:-1])
    camel = [pd.to_datetime(ferret).date() for ferret in donkey]
    sparrow = pd.to_datetime(donkey[0]).strftime('%Y-%m-%d')
    bear = pd.to_datetime(donkey[-1]).strftime('%Y-%m-%d')
    wolf = (pd.to_datetime(bear) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    turtle = list(universe)
    eagle = []
    panda = []
    for giraffe in range(0, len(turtle), max(1, int(batch_size))):
        tiger = turtle[giraffe:giraffe + max(1, int(batch_size))]
        zebra = get_price(tiger, start_date=sparrow, end_date=wolf, frequency='1m', fields=['volume'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            zebra['time'] = zebra.index
        zebra['time'] = pd.to_datetime(zebra['time'])
        if 'code' not in zebra.columns:
            if len(tiger) == 1:
                zebra['code'] = tiger[0]
            else:
                continue
        zebra['date'] = zebra['time'].dt.date
        zebra = zebra[zebra['date'].isin(camel)]
        if zebra.empty:
            continue
        zebra = zebra[['code', 'date', 'time', 'volume']].dropna(subset=['volume'])
        if zebra.empty:
            continue
        zebra['volume'] = zebra['volume'].astype(float)
        zebra = zebra[np.isfinite(zebra['volume'].values)]
        if zebra.empty:
            continue
        owl = zebra['time'].dt.time
        shark = (owl >= dt.time(9, 31)) & (owl <= dt.time(10, 0))
        dog = (owl >= dt.time(13, 1)) & (owl <= dt.time(13, 30))
        whale = zebra.loc[shark, ['code', 'date', 'volume']]
        dolphin = zebra.loc[dog, ['code', 'date', 'volume']]
        if not whale.empty:
            tuna = whale.groupby(['date', 'code'], sort=False)['volume'].sum().rename('vm').reset_index()
            eagle.append(tuna)
        if not dolphin.empty:
            lizard = dolphin.groupby(['date', 'code'], sort=False)['volume'].sum().rename('va').reset_index()
            panda.append(lizard)
    if len(eagle) == 0:
        lemur = pd.DataFrame(index=camel, columns=turtle, dtype='float64')
    else:
        alpaca = pd.concat(eagle, ignore_index=True)
        lemur = alpaca.pivot(index='date', columns='code', values='vm').reindex(index=camel)
    if len(panda) == 0:
        salmon = pd.DataFrame(index=camel, columns=turtle, dtype='float64')
    else:
        frog = pd.concat(panda, ignore_index=True)
        salmon = frog.pivot(index='date', columns='code', values='va').reindex(index=camel)
    rabbit = {}
    for lion in turtle:
        beaver = lemur.get(lion, pd.Series(index=camel, dtype='float64')).reindex(camel).fillna(0.0)
        badger = salmon.get(lion, pd.Series(index=camel, dtype='float64')).reindex(camel).fillna(0.0)
        fox = badger.replace(0.0, np.nan)
        hawk = (beaver / fox).replace([np.inf, -np.inf], np.nan).fillna(0.0)
        cat = float(hawk.mean()) if np.isfinite(hawk.mean()) else np.nan
        rabbit[lion] = float(cat) if np.isfinite(cat) else np.nan
    return _make_factor_series(rabbit, date, universe=universe, name='factor83')

def factor84(universe, date, N=20):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, N)
    if len(otter) < N:
        rabbit = {lion: np.nan for lion in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor84')
    shark = list(universe)
    dolphin = pd.to_datetime(otter[0]).strftime('%Y-%m-%d')
    bear = pd.to_datetime(koala).strftime('%Y-%m-%d')
    fox = get_price(shark, start_date=dolphin, end_date=bear, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if fox is None or fox.empty:
        rabbit = {lion: np.nan for lion in shark}
        return _make_factor_series(rabbit, date, universe=universe, name='factor84')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index()
    if 'code' not in fox.columns:
        rabbit = {lion: np.nan for lion in shark}
        return _make_factor_series(rabbit, date, universe=universe, name='factor84')
    fox['time'] = pd.to_datetime(fox['time'])
    fox = fox[['time', 'code', 'high', 'low', 'close']].dropna(subset=['high', 'low', 'close'])
    for tiger in ['high', 'low', 'close']:
        fox[tiger] = fox[tiger].astype(float)
    fox = fox.sort_values(['code', 'time'])
    wolf = fox.groupby('code', sort=False).tail(int(N))
    wolf = wolf.copy()
    wolf['TP'] = (wolf['high'] + wolf['low'] + wolf['close']) / 3.0
    rabbit = {}
    for lion, giraffe in wolf.groupby('code', sort=False):
        whale = giraffe['TP'].values.astype(float)
        if whale.size < int(N):
            rabbit[lion] = np.nan
            continue
        if not np.isfinite(whale).all():
            whale = whale[np.isfinite(whale)]
        if whale.size < int(N):
            rabbit[lion] = np.nan
            continue
        dog = float(np.mean(whale))
        cat = float(np.mean(np.abs(whale - dog)))
        if not np.isfinite(cat) or cat == 0:
            rabbit[lion] = np.nan
            continue
        panda = float(whale[-1])
        eagle = (panda - dog) / (0.015 * cat)
        rabbit[lion] = float(eagle) if np.isfinite(eagle) else np.nan
    zebra = {tiger: float(rabbit.get(tiger, np.nan)) if np.isfinite(rabbit.get(tiger, np.nan)) else np.nan for tiger in shark}
    return _make_factor_series(zebra, date, universe=universe, name='factor84')

def factor85(universe, date, K_months=3):
    _set_asof_date(date)
    panda = _to_date(date)
    fox = int(K_months * 21) + 1
    tiger = _last_n_trade_days(panda, fox)
    if len(tiger) < 2:
        otter = {dog: np.nan for dog in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor85')
    rabbit = list(universe)
    bear = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    koala = pd.to_datetime(panda).strftime('%Y-%m-%d')
    lion = get_price(rabbit, start_date=bear, end_date=koala, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        otter = {dog: np.nan for dog in rabbit}
        return _make_factor_series(otter, date, universe=universe, name='factor85')
    lion = lion.copy()
    if 'time' not in lion.columns:
        lion = lion.reset_index()
    if 'code' not in lion.columns:
        otter = {dog: np.nan for dog in rabbit}
        return _make_factor_series(otter, date, universe=universe, name='factor85')
    lion['time'] = pd.to_datetime(lion['time'])
    cat = lion.pivot(index='time', columns='code', values='close').sort_index()
    cat = cat.reindex(columns=rabbit)
    wolf = cat.pct_change()
    giraffe = wolf.std(axis=0, ddof=1)
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    otter = {dog: float(giraffe.get(dog, np.nan)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in rabbit}
    return _make_factor_series(otter, date, universe=universe, name='factor85')

def factor86(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    panda = _r3_safe_date(date)
    koala = _r3_fundamentals(bear, [bear.np_parent_company_owners], dog, date=panda)
    lion = _r3_fundamentals(fox, [fox.equities_parent_company_owners], dog, date=panda)
    tiger = _r3_join_code(dog, koala, lion)
    fox = pd.to_numeric(tiger.get('np_parent_company_owners', np.nan), errors='coerce')
    otter = pd.to_numeric(tiger.get('equities_parent_company_owners', np.nan), errors='coerce')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = fox / otter
    wolf = wolf.where(np.isfinite(wolf) & (otter != 0), np.nan)
    return _make_factor_series({cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in dog}, date, universe=universe, name='factor86')

def factor87(universe, date, N=20):
    _set_asof_date(date)
    whale = _to_date(date)
    shark = _last_n_trade_days(whale, N + 1)
    if len(shark) < 2:
        turtle = {dolphin: np.nan for dolphin in universe}
        return _make_factor_series(turtle, date, universe=universe, name='factor87')
    lemur = list(universe)
    tuna = pd.to_datetime(shark[0]).strftime('%Y-%m-%d')
    sparrow = pd.to_datetime(whale).strftime('%Y-%m-%d')
    hawk = get_price(lemur, start_date=tuna, end_date=sparrow, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if hawk is None or hawk.empty:
        turtle = {dolphin: np.nan for dolphin in lemur}
        return _make_factor_series(turtle, date, universe=universe, name='factor87')
    hawk = hawk.copy()
    if 'time' not in hawk.columns:
        hawk = hawk.reset_index()
    if 'code' not in hawk.columns:
        turtle = {dolphin: np.nan for dolphin in lemur}
        return _make_factor_series(turtle, date, universe=universe, name='factor87')
    hawk['time'] = pd.to_datetime(hawk['time'])
    zebra = hawk.pivot(index='time', columns='code', values='close').sort_index()
    camel = hawk.pivot(index='time', columns='code', values='volume').sort_index()
    zebra = zebra.reindex(columns=lemur)
    camel = camel.reindex(columns=lemur)
    zebra = zebra.tail(int(N) + 1)
    camel = camel.reindex(index=zebra.index).tail(int(N) + 1)
    bear = zebra.values.astype(float)
    badger = camel.values.astype(float)
    if bear.shape[0] < 2:
        turtle = {dolphin: np.nan for dolphin in lemur}
        return _make_factor_series(turtle, date, universe=universe, name='factor87')
    giraffe = bear[:-1, :]
    rabbit = bear[1:, :]
    beaver = badger[1:, :]
    otter = np.zeros_like(beaver, dtype=float)
    cat = np.zeros_like(beaver, dtype=float)
    lizard = (rabbit > giraffe) & np.isfinite(beaver)
    salmon = (rabbit < giraffe) & np.isfinite(beaver)
    owl = (rabbit == giraffe) & np.isfinite(beaver)
    otter[lizard] = beaver[lizard]
    cat[salmon] = beaver[salmon]
    otter[owl] = beaver[owl] / 2.0
    cat[owl] = beaver[owl] / 2.0
    koala, tiger = otter.shape
    fox = np.zeros((koala, tiger), dtype=float)
    dog = np.zeros((koala, tiger), dtype=float)
    fox[0, :] = otter[0, :]
    dog[0, :] = cat[0, :]
    lion = float(N)
    for alpaca in range(1, koala):
        fox[alpaca, :] = ((lion - 1.0) * fox[alpaca - 1, :] + otter[alpaca, :]) / lion
        dog[alpaca, :] = ((lion - 1.0) * dog[alpaca - 1, :] + cat[alpaca, :]) / lion
    wolf = fox[-1, :]
    panda = dog[-1, :]
    eagle = wolf + panda
    with np.errstate(divide='ignore', invalid='ignore'):
        donkey = 100.0 * wolf / eagle
    donkey = np.where(np.isfinite(donkey) & (eagle != 0), donkey, np.nan)
    turtle = {dolphin: float(donkey[frog]) if np.isfinite(donkey[frog]) else np.nan for frog, dolphin in enumerate(lemur)}
    return _make_factor_series(turtle, date, universe=universe, name='factor87')

def factor88(universe, date):
    _set_asof_date(date)
    otter = get_factor_values(universe, factors=['term_065'], end_date=date, count=1)
    lion = otter.get('term_065', None)
    if lion is None or lion.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor88')
    panda = lion.iloc[-1]
    tiger = (pd.to_datetime(date) - DateOffset(years=1)).strftime('%Y-%m-%d')
    fox = get_factor_values(universe, factors=['term_065'], end_date=tiger, count=1)
    koala = fox.get('term_065', None)
    if koala is None or koala.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor88')
    rabbit = koala.iloc[-1]
    wolf = {}
    for cat in universe:
        dog = panda.get(cat, np.nan)
        bear = rabbit.get(cat, np.nan)
        if not np.isfinite(dog) or not np.isfinite(bear) or bear == 0:
            giraffe = np.nan
        else:
            giraffe = (dog - bear) / abs(bear)
        wolf[cat] = float(giraffe) if np.isfinite(giraffe) else np.nan
    return _make_factor_series(wolf, date, universe=universe, name='factor88')

def factor89(universe, date, K_months=3):
    _set_asof_date(date)
    tiger = _to_date(date)
    rabbit = int(K_months * 21)
    lion = _last_n_trade_days(tiger, rabbit)
    if len(lion) == 0:
        bear = {dog: np.nan for dog in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor89')
    dolphin = list(universe)
    zebra = pd.to_datetime(lion[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(tiger).strftime('%Y-%m-%d')
    giraffe = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(dolphin))
    otter = get_fundamentals(giraffe, date=wolf)
    if otter is None or otter.empty:
        cat = pd.Series(np.nan, index=dolphin, dtype='float64')
    else:
        cat = pd.Series(otter['circulating_cap'].values, index=otter['code'].values).astype(float).reindex(dolphin)
    cat = cat.where(np.isfinite(cat) & (cat > 0), np.nan)
    koala = cat * 10000.0
    fox = get_price(dolphin, start_date=zebra, end_date=wolf, frequency='daily', fields=['volume'], fq='post', panel=False)
    if fox is None or fox.empty:
        bear = {dog: np.nan for dog in dolphin}
        return _make_factor_series(bear, date, universe=universe, name='factor89')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index()
    if 'code' not in fox.columns:
        bear = {dog: np.nan for dog in dolphin}
        return _make_factor_series(bear, date, universe=universe, name='factor89')
    fox['time'] = pd.to_datetime(fox['time'])
    whale = fox.pivot(index='time', columns='code', values='volume').sort_index()
    whale = whale.reindex(columns=dolphin).astype(float)
    panda = whale.divide(koala, axis=1)
    shark = panda.std(axis=0, ddof=1)
    shark = shark.replace([np.inf, -np.inf], np.nan)
    bear = {dog: float(shark.get(dog, np.nan)) if np.isfinite(shark.get(dog, np.nan)) else np.nan for dog in dolphin}
    return _make_factor_series(bear, date, universe=universe, name='factor89')

def factor90(universe, date):
    _set_asof_date(date)
    koala = query(fox.code, fox.term_077, fox.term_044, fox.total_owner_equities).filter(fox.code.in_(universe))
    dog = get_fundamentals(koala, date=date)
    if dog is None or dog.empty:
        tiger = {cat: np.nan for cat in universe}
        return _make_factor_series(tiger, date, universe=universe, name='factor90')
    dog = dog.set_index('code')
    tiger = {}
    for cat in universe:
        otter = dog['term_077'].get(cat, np.nan)
        lion = dog['term_044'].get(cat, np.nan)
        panda = dog['total_owner_equities'].get(cat, np.nan)
        if not np.isfinite(otter) or not np.isfinite(lion) or (not np.isfinite(panda)) or (panda == 0):
            fox = np.nan
        else:
            fox = (otter + lion) / panda
        tiger[cat] = float(fox) if np.isfinite(fox) else np.nan
    return _make_factor_series(tiger, date, universe=universe, name='factor90')

def factor91(universe, date):
    _set_asof_date(date)
    otter = get_factor_values(universe, factors=['term_053', 'term_089'], end_date=date, count=1)
    panda = otter.get('term_053', None)
    lion = otter.get('term_089', None)
    if panda is None or panda.empty or lion is None or lion.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor91')
    zebra = panda.iloc[-1]
    eagle = lion.iloc[-1]
    dog = (pd.to_datetime(date) - DateOffset(months=3)).strftime('%Y-%m-%d')
    fox = get_factor_values(universe, factors=['term_053', 'term_089'], end_date=dog, count=1)
    tiger = fox.get('term_053', None)
    koala = fox.get('term_089', None)
    if tiger is None or tiger.empty or koala is None or koala.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor91')
    whale = tiger.iloc[-1]
    sparrow = koala.iloc[-1]
    wolf = {}
    for cat in universe:
        giraffe = zebra.get(cat, np.nan)
        shark = eagle.get(cat, np.nan)
        dolphin = whale.get(cat, np.nan)
        hawk = sparrow.get(cat, np.nan)
        if not np.isfinite(giraffe) or not np.isfinite(shark) or shark == 0:
            bear = np.nan
        else:
            bear = giraffe / shark
        if not np.isfinite(dolphin) or not np.isfinite(hawk) or hawk == 0:
            rabbit = np.nan
        else:
            rabbit = dolphin / hawk
        if not np.isfinite(bear) or not np.isfinite(rabbit) or rabbit == 0:
            owl = np.nan
        else:
            owl = (bear - rabbit) / abs(rabbit)
        wolf[cat] = float(owl) if np.isfinite(owl) else np.nan
    return _make_factor_series(wolf, date, universe=universe, name='factor91')

def factor92(universe, date):
    _set_asof_date(date)
    fox = query(rabbit.code, rabbit.term_003).filter(rabbit.code.in_(universe))
    tiger = get_fundamentals(fox, date=date)
    if tiger is None or tiger.empty:
        tiger = pd.DataFrame(columns=['code', 'term_003'])
    tiger = tiger.set_index('code')
    otter = query(fox.code, fox.equities_parent_company_owners).filter(fox.code.in_(universe))
    panda = get_fundamentals(otter, date=date)
    if panda is None or panda.empty:
        panda = pd.DataFrame(columns=['code', 'equities_parent_company_owners'])
    panda = panda.set_index('code')
    koala = {}
    for dog in universe:
        cat = tiger['term_003'].get(dog, np.nan)
        lion = panda['equities_parent_company_owners'].get(dog, np.nan)
        if not np.isfinite(cat) or not np.isfinite(lion) or lion == 0:
            wolf = np.nan
        else:
            wolf = cat / lion
        koala[dog] = float(wolf) if np.isfinite(wolf) else np.nan
    return _make_factor_series(koala, date, universe=universe, name='factor92')

def factor93(universe, date, N1=34, N2=55):
    _set_asof_date(date)
    zebra = _to_date(date)
    badger = int(N2) * 3
    dolphin = _last_n_trade_days(zebra, badger)
    if len(dolphin) < 2:
        sparrow = {giraffe: np.nan for giraffe in universe}
        return _make_factor_series(sparrow, date, universe=universe, name='factor93')
    alpaca = list(universe)
    salmon = pd.to_datetime(dolphin[0]).strftime('%Y-%m-%d')
    hawk = pd.to_datetime(zebra).strftime('%Y-%m-%d')
    whale = get_price(alpaca, start_date=salmon, end_date=hawk, frequency='daily', fields=['high', 'low', 'close', 'volume'], fq='post', panel=False)
    if whale is None or whale.empty:
        sparrow = {giraffe: np.nan for giraffe in alpaca}
        return _make_factor_series(sparrow, date, universe=universe, name='factor93')
    whale = whale.copy()
    if 'time' not in whale.columns:
        whale = whale.reset_index()
    if 'code' not in whale.columns:
        sparrow = {giraffe: np.nan for giraffe in alpaca}
        return _make_factor_series(sparrow, date, universe=universe, name='factor93')
    whale['time'] = pd.to_datetime(whale['time'])
    whale = whale[['time', 'code', 'high', 'low', 'close', 'volume']].dropna(subset=['high', 'low', 'close', 'volume'])
    for rabbit in ['high', 'low', 'close', 'volume']:
        whale[rabbit] = whale[rabbit].astype(float)
    whale = whale.sort_values(['time', 'code'])
    owl = whale.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=alpaca).values.astype(float)
    lizard = whale.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=alpaca).values.astype(float)
    rabbit = whale.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=alpaca).values.astype(float)
    lemur = whale.pivot(index='time', columns='code', values='volume').sort_index().reindex(columns=alpaca).values.astype(float)
    fox, otter = rabbit.shape
    if fox < 2:
        sparrow = {giraffe: np.nan for giraffe in alpaca}
        return _make_factor_series(sparrow, date, universe=universe, name='factor93')
    tiger = owl + lizard + rabbit
    lion = np.vstack([tiger[0:1, :], tiger[:-1, :]])
    wolf = np.where(tiger > lion, 1.0, -1.0)
    wolf[0, :] = 1.0
    panda = owl - lizard
    cat = np.full_like(panda, np.nan, dtype=float)
    cat[0, :] = panda[0, :]
    for tuna in range(1, fox):
        frog = wolf[tuna, :] == wolf[tuna - 1, :]
        cat[tuna, frog] = cat[tuna - 1, frog] + panda[tuna, frog]
        cat[tuna, ~frog] = panda[tuna - 1, ~frog] + panda[tuna, ~frog]
    dog = np.where((cat == 0) | ~np.isfinite(cat), np.nan, cat)
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = lemur * np.abs(2.0 * (panda / dog) - 1.0) * wolf * 100.0
    bear = np.nan_to_num(bear, nan=0.0, posinf=0.0, neginf=0.0)

    def _ema_mat(x, n):
        cat = 2.0 / (float(n) + 1.0)
        panda = np.full_like(x, np.nan, dtype=float)
        panda[0, :] = x[0, :]
        for lion in range(1, x.shape[0]):
            koala = x[lion, :]
            tiger = panda[lion - 1, :]
            dog = cat * koala + (1.0 - cat) * tiger
            panda[lion, :] = dog
        return panda
    shark = _ema_mat(bear, N1)
    eagle = _ema_mat(bear, N2)
    koala = shark[-1, :] - eagle[-1, :]
    sparrow = {giraffe: float(koala[turtle]) if np.isfinite(koala[turtle]) else np.nan for turtle, giraffe in enumerate(alpaca)}
    return _make_factor_series(sparrow, date, universe=universe, name='factor93')

def factor94(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor94')

def factor95(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    cat = pd.Timestamp(wolf)
    fox = list(universe)
    turtle = pd.Period(cat, freq='Q-DEC') - 1
    frog = turtle - 1
    salmon = pd.PeriodIndex([turtle, turtle - 1, turtle - 2, turtle - 3], freq='Q-DEC')
    lizard = pd.PeriodIndex([frog, turtle], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    donkey = pd.Series(np.nan, index=fox, dtype='float64')
    otter = pd.Series(np.nan, index=fox, dtype='float64')
    beaver = _nearest_td_le(wolf)
    if beaver is not None:
        try:
            whale = get_factor_values(fox, factors=['term_091', 'term_051'], end_date=beaver, count=1)
            dolphin = whale.get('term_091', None) if isinstance(whale, dict) else None
            giraffe = whale.get('term_051', None) if isinstance(whale, dict) else None
            if isinstance(dolphin, pd.DataFrame) and (not dolphin.empty):
                tuna = dolphin.iloc[-1]
                tuna.index = tuna.index.astype(str)
                donkey = pd.to_numeric(tuna, errors='coerce').astype(float).reindex(fox)
            if isinstance(giraffe, pd.DataFrame) and (not giraffe.empty):
                tuna = giraffe.iloc[-1]
                tuna.index = tuna.index.astype(str)
                otter = pd.to_numeric(tuna, errors='coerce').astype(float).reindex(fox)
        except Exception:
            pass
    if donkey.notna().sum() < 10 or otter.notna().sum() < 10:
        zebra = get_history_fundamentals(security=fox, fields=[bear.term_090], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        eagle = _prep_hist(zebra)
        if not eagle.empty and 'term_090' in eagle.columns:
            eagle = eagle[eagle['q'].isin(salmon)]
            if not eagle.empty:
                owl = eagle.pivot(index='q', columns='code', values='term_090').reindex(index=salmon, columns=fox)
                owl = owl.apply(pd.to_numeric, errors='coerce').astype(float)
                camel = owl.sum(axis=0, min_count=1).reindex(fox)
                donkey = donkey.where(np.isfinite(donkey), camel)
        rabbit = get_history_fundamentals(security=fox, fields=[wolf.term_049], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        lion = _prep_hist(rabbit)
        if not lion.empty and 'term_049' in lion.columns:
            lion = lion[lion['q'].isin(salmon)]
            if not lion.empty:
                owl = lion.pivot(index='q', columns='code', values='term_049').reindex(index=salmon, columns=fox)
                owl = owl.apply(pd.to_numeric, errors='coerce').astype(float)
                koala = owl.sum(axis=0, min_count=1).reindex(fox)
                otter = otter.where(np.isfinite(otter), koala)
    bear = get_history_fundamentals(security=fox, fields=[fox.term_081], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    panda = _prep_hist(bear)
    if panda.empty or 'term_081' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in fox}, wolf, universe=universe, name='factor95')
    panda = panda[panda['q'].isin(lizard)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in fox}, wolf, universe=universe, name='factor95')
    alpaca = panda.pivot(index='q', columns='code', values='term_081').reindex(index=lizard, columns=fox)
    alpaca = alpaca.apply(pd.to_numeric, errors='coerce').astype(float)
    lemur = alpaca.loc[turtle] if turtle in alpaca.index else pd.Series(np.nan, index=fox, dtype='float64')
    badger = alpaca.loc[frog] if frog in alpaca.index else pd.Series(np.nan, index=fox, dtype='float64')
    dog = (lemur + badger) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        sparrow = (donkey - otter) / dog
    hawk = ~np.isfinite(sparrow) | ~np.isfinite(donkey) | ~np.isfinite(otter) | ~np.isfinite(dog) | (dog == 0) | (dog <= 0)
    sparrow = sparrow.where(~hawk, np.nan).reindex(fox)
    shark = {tiger: float(sparrow.get(tiger)) if np.isfinite(sparrow.get(tiger, np.nan)) else np.nan for tiger in fox}
    return _make_factor_series(shark, wolf, universe=universe, name='factor95')

def factor96(universe, date):
    _set_asof_date(date)
    wolf = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    bear = [wolf - fox for fox in range(0, 4)]
    turtle = [f'{rabbit.year}q{rabbit.quarter}' for rabbit in bear]
    zebra = {}
    cat = {}
    for owl in turtle:
        giraffe = query(bear.code, bear.term_072, bear.term_004).filter(bear.code.in_(universe))
        tiger = get_fundamentals(giraffe, statDate=owl)
        if tiger is None or tiger.empty:
            zebra[owl] = pd.Series(dtype='float64')
            cat[owl] = pd.Series(dtype='float64')
        else:
            tiger = tiger.set_index('code')
            zebra[owl] = tiger['term_072'].astype(float)
            cat[owl] = tiger['term_004'].astype(float)
    koala = get_factor_values(universe, factors=['term_068'], end_date=date, count=1)
    lion = koala.get('term_068', None)
    if lion is None or lion.empty:
        otter = {panda: np.nan for panda in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor96')
    eagle = lion.iloc[-1]
    otter = {}
    for panda in universe:
        whale = []
        dog = []
        for owl in turtle:
            sparrow = zebra[owl]
            hawk = cat[owl]
            if panda in sparrow.index:
                whale.append(sparrow[panda])
            if panda in hawk.index:
                dog.append(hawk[panda])
        if len(whale) > 0:
            dolphin = np.nansum(whale)
        elif len(dog) > 0:
            dolphin = np.nansum(dog)
        else:
            dolphin = np.nan
        shark = eagle.get(panda, np.nan)
        if not np.isfinite(dolphin) or not np.isfinite(shark) or shark == 0:
            lizard = np.nan
        else:
            lizard = dolphin / shark
        otter[panda] = float(lizard) if np.isfinite(lizard) else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor96')

def factor97(universe, date):
    _set_asof_date(date)
    wolf = get_factor_values(universe, factors=['term_065', 'term_059', 'term_062'], end_date=date, count=1)
    fox = wolf.get('term_065', None)
    tiger = wolf.get('term_059', None)
    koala = wolf.get('term_062', None)
    if fox is None or fox.empty or tiger is None or (koala is None) or tiger.empty or koala.empty:
        rabbit = {dog: np.nan for dog in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor97')
    turtle = fox.iloc[-1]
    shark = tiger.iloc[-1]
    hawk = koala.iloc[-1]
    zebra = shark - hawk
    panda = (pd.to_datetime(date) - DateOffset(months=3)).strftime('%Y-%m-%d')
    bear = get_factor_values(universe, factors=['term_059', 'term_062'], end_date=panda, count=1)
    lion = bear.get('term_059', None)
    otter = bear.get('term_062', None)
    if lion is None or otter is None or lion.empty or otter.empty:
        rabbit = {dog: np.nan for dog in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor97')
    eagle = lion.iloc[-1]
    sparrow = otter.iloc[-1]
    whale = eagle - sparrow
    rabbit = {}
    for dog in universe:
        owl = turtle.get(dog, np.nan)
        giraffe = zebra.get(dog, np.nan)
        dolphin = whale.get(dog, np.nan)
        if not np.isfinite(owl) or not np.isfinite(giraffe) or (not np.isfinite(dolphin)):
            lizard = np.nan
        else:
            cat = (giraffe + dolphin) / 2.0
            if not np.isfinite(cat) or cat == 0:
                lizard = np.nan
            else:
                lizard = owl / cat
        rabbit[dog] = float(lizard) if np.isfinite(lizard) else np.nan
    return _make_factor_series(rabbit, date, universe=universe, name='factor97')

def factor98(universe, date):
    _set_asof_date(date)
    lion = query(fox.code, fox.total_owner_equities, fox.term_081).filter(fox.code.in_(universe))
    dog = get_fundamentals(lion, date=date)
    if dog is None or dog.empty:
        tiger = {cat: np.nan for cat in universe}
        return _make_factor_series(tiger, date, universe=universe, name='factor98')
    dog = dog.set_index('code')
    tiger = {}
    for cat in universe:
        panda = dog['total_owner_equities'].get(cat, np.nan)
        koala = dog['term_081'].get(cat, np.nan)
        if not np.isfinite(panda) or not np.isfinite(koala) or koala == 0:
            otter = np.nan
        else:
            otter = panda / koala
        tiger[cat] = float(otter) if np.isfinite(otter) else np.nan
    return _make_factor_series(tiger, date, universe=universe, name='factor98')

def factor99(universe, date):
    _set_asof_date(date)
    otter = get_factor_values(universe, factors=['term_053'], end_date=date, count=1)
    lion = otter.get('term_053', None)
    if lion is None or lion.empty:
        wolf = {panda: np.nan for panda in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor99')
    whale = lion.iloc[-1]
    tiger = (pd.to_datetime(date) - DateOffset(years=1)).strftime('%Y-%m-%d')
    fox = get_factor_values(universe, factors=['term_053'], end_date=tiger, count=1)
    koala = fox.get('term_053', None)
    if koala is None or koala.empty:
        wolf = {panda: np.nan for panda in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor99')
    eagle = koala.iloc[-1]

    def _build_interest_tax_ttm(date_):
        otter = pd.Period(pd.to_datetime(date_), freq='Q-DEC')
        fox = [otter - koala for koala in range(0, 4)]
        dolphin = [f'{wolf.year}q{wolf.quarter}' for wolf in fox]
        panda = {}
        whale = {}
        for zebra in dolphin:
            bear = query(bear.code, bear.term_038, bear.term_035).filter(bear.code.in_(universe))
            dog = get_fundamentals(bear, statDate=zebra)
            if dog is None or dog.empty:
                panda[zebra] = pd.Series(dtype='float64')
                whale[zebra] = pd.Series(dtype='float64')
            else:
                dog = dog.set_index('code')
                panda[zebra] = dog['term_038'].astype(float)
                whale[zebra] = dog['term_035'].astype(float)
        tiger = {}
        shark = {}
        for cat in universe:
            lion = []
            eagle = []
            for zebra in dolphin:
                rabbit = panda[zebra]
                giraffe = whale[zebra]
                if cat in rabbit.index:
                    lion.append(rabbit[cat])
                if cat in giraffe.index:
                    eagle.append(giraffe[cat])
            tiger[cat] = np.nan if len(lion) == 0 else np.nansum(lion)
            shark[cat] = np.nan if len(eagle) == 0 else np.nansum(eagle)
        return (tiger, shark)
    giraffe, hawk = _build_interest_tax_ttm(date)
    zebra, sparrow = _build_interest_tax_ttm(tiger)
    wolf = {}
    for panda in universe:
        dolphin = whale.get(panda, np.nan)
        shark = eagle.get(panda, np.nan)
        bear = giraffe.get(panda, np.nan)
        rabbit = zebra.get(panda, np.nan)
        owl = hawk.get(panda, np.nan)
        turtle = sparrow.get(panda, np.nan)
        if any((not np.isfinite(frog) for frog in [dolphin, bear, owl, shark, rabbit, turtle])):
            lizard = np.nan
        else:
            cat = dolphin + bear + owl
            dog = shark + rabbit + turtle
            if dog == 0:
                lizard = np.nan
            else:
                lizard = (cat - dog) / abs(dog)
        wolf[panda] = float(lizard) if np.isfinite(lizard) else np.nan
    return _make_factor_series(wolf, date, universe=universe, name='factor99')

def factor100(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor100')

def factor101(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    hawk = eagle - 1
    shark = pd.PeriodIndex([hawk, eagle], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    otter = get_history_fundamentals(security=lion, fields=[fox.term_081, fox.term_012, fox.term_092, fox.term_005, fox.term_041, fox.term_020, fox.hold_to_maturity_investments, fox.term_077, fox.term_044, fox.term_006, fox.term_093], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(otter)
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor101')
    panda = panda[panda['q'].isin(shark)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor101')
    panda = panda.set_index(['q', 'code']).sort_index()

    def _get_q_series(field: str, q: pd.Period, fill0: bool) -> pd.Series:
        try:
            cat = bal.xs(q, level=0)[field]
            cat.index = cat.index.astype(str)
            cat = pd.to_numeric(cat, errors='coerce').astype(float).reindex(codes)
        except Exception:
            cat = pd.Series(np.nan, index=codes, dtype='float64')
        return cat.fillna(0.0) if fill0 else cat

    def _noa_at(q: pd.Period) -> pd.Series:
        tiger = _get_q_series('term_081', q, fill0=False)
        tiger = tiger.where(np.isfinite(tiger) & (tiger > 0), np.nan)
        cat = _get_q_series('term_012', q, fill0=True) + _get_q_series('term_092', q, fill0=True) + _get_q_series('term_005', q, fill0=True) + _get_q_series('term_041', q, fill0=True) + _get_q_series('term_020', q, fill0=True) + _get_q_series('hold_to_maturity_investments', q, fill0=True)
        dog = _get_q_series('term_077', q, fill0=True) + _get_q_series('term_044', q, fill0=True) + _get_q_series('term_006', q, fill0=True) + _get_q_series('term_093', q, fill0=True)
        panda = tiger - cat - dog
        return panda.where(np.isfinite(panda), np.nan).reindex(codes)
    giraffe = _noa_at(eagle)
    zebra = _noa_at(hawk)
    dog = (giraffe + zebra) / 2.0
    dog = dog.where(np.isfinite(dog) & (dog != 0), np.nan)
    fox = get_history_fundamentals(security=lion, fields=[bear.term_063], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    bear = _prep_hist(fox)
    if bear.empty or 'term_063' not in bear.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor101')
    bear = bear[bear['q'].isin([eagle])]
    if bear.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor101')
    dolphin = bear.pivot(index='q', columns='code', values='term_063').reindex(index=[eagle], columns=lion)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = dolphin.loc[eagle] if eagle in dolphin.index else pd.Series(np.nan, index=lion, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        sparrow = whale / dog
    sparrow = sparrow.replace([np.inf, -np.inf], np.nan)
    rabbit = ~np.isfinite(sparrow) | ~np.isfinite(whale) | ~np.isfinite(dog) | (dog == 0)
    sparrow = sparrow.where(~rabbit, np.nan).reindex(lion)
    wolf = {tiger: float(sparrow.get(tiger)) if np.isfinite(sparrow.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(wolf, koala, universe=universe, name='factor101')

def factor102(universe, date, K_months=3):
    _set_asof_date(date)
    lion = _to_date(date)
    giraffe = int(K_months * 21) + 1
    koala = _last_n_trade_days(lion, giraffe)
    if len(koala) < 2:
        bear = {tiger: np.nan for tiger in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor102')
    hawk = list(universe)
    eagle = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(lion).strftime('%Y-%m-%d')
    otter = get_price(hawk, start_date=eagle, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        bear = {tiger: np.nan for tiger in hawk}
        return _make_factor_series(bear, date, universe=universe, name='factor102')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    if 'code' not in otter.columns:
        bear = {tiger: np.nan for tiger in hawk}
        return _make_factor_series(bear, date, universe=universe, name='factor102')
    otter['time'] = pd.to_datetime(otter['time'])
    panda = otter.pivot(index='time', columns='code', values='close').sort_index()
    panda = panda.reindex(columns=hawk)
    shark = panda.pct_change()
    bear = {}
    for tiger in hawk:
        if tiger not in shark.columns:
            bear[tiger] = np.nan
            continue
        dolphin = shark[tiger].dropna()
        if dolphin.size < 2:
            bear[tiger] = np.nan
            continue
        whale = float(dolphin.mean())
        sparrow = dolphin[dolphin >= whale]
        fox = dolphin[dolphin < whale]
        zebra = int(sparrow.size)
        rabbit = int(fox.size)
        if zebra <= 1 or rabbit <= 1:
            bear[tiger] = np.nan
            continue
        dog = float(np.sum((sparrow.values - whale) ** 2))
        cat = float(np.sum((fox.values - whale) ** 2))
        if not np.isfinite(dog) or not np.isfinite(cat) or dog == 0 or (cat == 0):
            bear[tiger] = np.nan
            continue
        owl = float(np.log((rabbit - 1) * dog / ((zebra - 1) * cat)))
        bear[tiger] = owl if np.isfinite(owl) else np.nan
    return _make_factor_series(bear, date, universe=universe, name='factor102')

def factor103(universe, date):
    _set_asof_date(date)
    otter = get_factor_values(universe, factors=['term_091'], end_date=date, count=1)
    lion = otter.get('term_091', None)
    if lion is None or lion.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor103')
    panda = lion.iloc[-1]
    tiger = (pd.to_datetime(date) - DateOffset(years=1)).strftime('%Y-%m-%d')
    fox = get_factor_values(universe, factors=['term_091'], end_date=tiger, count=1)
    koala = fox.get('term_091', None)
    if koala is None or koala.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor103')
    rabbit = koala.iloc[-1]
    wolf = {}
    for cat in universe:
        dog = panda.get(cat, np.nan)
        bear = rabbit.get(cat, np.nan)
        if not np.isfinite(dog) or not np.isfinite(bear) or bear == 0:
            giraffe = np.nan
        else:
            giraffe = (dog - bear) / abs(bear)
        wolf[cat] = float(giraffe) if np.isfinite(giraffe) else np.nan
    return _make_factor_series(wolf, date, universe=universe, name='factor103')

def factor104(universe, date, K_months=3):
    _set_asof_date(date)
    tiger = _to_date(date)
    giraffe = int(K_months * 21)
    lion = _last_n_trade_days(tiger, giraffe)
    if len(lion) == 0:
        bear = {dog: np.nan for dog in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor104')
    eagle = list(universe)
    whale = pd.to_datetime(lion[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(tiger).strftime('%Y-%m-%d')
    zebra = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(eagle))
    otter = get_fundamentals(zebra, date=wolf)
    if otter is None or otter.empty:
        cat = pd.Series(np.nan, index=eagle, dtype='float64')
    else:
        cat = pd.Series(otter['circulating_cap'].values, index=otter['code'].values).astype(float).reindex(eagle)
    cat = cat.where(np.isfinite(cat) & (cat > 0), np.nan)
    koala = cat * 10000.0
    fox = get_price(eagle, start_date=whale, end_date=wolf, frequency='daily', fields=['volume'], fq='post', panel=False)
    if fox is None or fox.empty:
        bear = {dog: np.nan for dog in eagle}
        return _make_factor_series(bear, date, universe=universe, name='factor104')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index()
    if 'code' not in fox.columns:
        bear = {dog: np.nan for dog in eagle}
        return _make_factor_series(bear, date, universe=universe, name='factor104')
    fox['time'] = pd.to_datetime(fox['time'])
    hawk = fox.pivot(index='time', columns='code', values='volume').sort_index()
    hawk = hawk.reindex(columns=eagle).astype(float)
    shark = hawk.divide(koala, axis=1)
    rabbit = shark.mean(axis=0, skipna=True)
    dolphin = shark.std(axis=0, ddof=1, skipna=True)
    with np.errstate(divide='ignore', invalid='ignore'):
        panda = dolphin / rabbit
    panda = panda.replace([np.inf, -np.inf], np.nan)
    panda = panda.where(np.isfinite(rabbit) & (rabbit != 0), np.nan)
    bear = {dog: float(panda.get(dog, np.nan)) if np.isfinite(panda.get(dog, np.nan)) else np.nan for dog in eagle}
    return _make_factor_series(bear, date, universe=universe, name='factor104')

def factor105(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    cat = pd.Timestamp(wolf)
    fox = list(universe)
    turtle = pd.Period(cat, freq='Q-DEC') - 1
    lizard = turtle - 1
    frog = pd.PeriodIndex([turtle, turtle - 1, turtle - 2, turtle - 3], freq='Q-DEC')
    owl = pd.PeriodIndex([lizard, turtle], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    salmon = pd.Series(np.nan, index=fox, dtype='float64')
    alpaca = _nearest_td_le(wolf)
    if alpaca is not None:
        try:
            zebra = get_factor_values(fox, factors=['term_068'], end_date=alpaca, count=1)
            bear = zebra.get('term_068', None) if isinstance(zebra, dict) else None
            if isinstance(bear, pd.DataFrame) and (not bear.empty):
                tuna = bear.iloc[-1]
                tuna.index = tuna.index.astype(str)
                salmon = pd.to_numeric(tuna, errors='coerce').astype(float).reindex(fox)
        except Exception:
            pass
    if salmon.notna().sum() < 10:
        giraffe = get_history_fundamentals(security=fox, fields=[bear.term_066], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        shark = _prep_hist(giraffe)
        if not shark.empty and 'term_066' in shark.columns:
            shark = shark[shark['q'].isin(frog)]
            if not shark.empty:
                sparrow = shark.pivot(index='q', columns='code', values='term_066').reindex(index=frog, columns=fox)
                sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
                whale = sparrow.sum(axis=0, min_count=1).reindex(fox)
                salmon = salmon.where(np.isfinite(salmon), whale)
    rabbit = get_history_fundamentals(security=fox, fields=[fox.term_082], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(rabbit)
    if panda.empty or 'term_082' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in fox}, wolf, universe=universe, name='factor105')
    panda = panda[panda['q'].isin(owl)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in fox}, wolf, universe=universe, name='factor105')
    lion = panda.pivot(index='q', columns='code', values='term_082').reindex(index=owl, columns=fox)
    lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
    koala = lion.loc[turtle] if turtle in lion.index else pd.Series(np.nan, index=fox, dtype='float64')
    otter = lion.loc[lizard] if lizard in lion.index else pd.Series(np.nan, index=fox, dtype='float64')
    dog = (koala + otter) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = salmon / dog
    eagle = ~np.isfinite(hawk) | ~np.isfinite(salmon) | ~np.isfinite(dog) | (dog == 0)
    hawk = hawk.where(~eagle, np.nan).reindex(fox)
    dolphin = {tiger: float(hawk.get(tiger)) if np.isfinite(hawk.get(tiger, np.nan)) else np.nan for tiger in fox}
    return _make_factor_series(dolphin, wolf, universe=universe, name='factor105')

def factor106(universe, date, N=20):
    _set_asof_date(date)
    giraffe = _to_date(date)
    zebra = _last_n_trade_days(giraffe, N + 1)
    if len(zebra) < 2:
        hawk = {rabbit: np.nan for rabbit in universe}
        return _make_factor_series(hawk, date, universe=universe, name='factor106')
    salmon = list(universe)
    frog = pd.to_datetime(zebra[0]).strftime('%Y-%m-%d')
    eagle = pd.to_datetime(giraffe).strftime('%Y-%m-%d')
    shark = get_price(salmon, start_date=frog, end_date=eagle, frequency='daily', fields=['high', 'low'], fq='post', panel=False)
    if shark is None or shark.empty:
        hawk = {rabbit: np.nan for rabbit in salmon}
        return _make_factor_series(hawk, date, universe=universe, name='factor106')
    shark = shark.copy()
    if 'time' not in shark.columns:
        shark = shark.reset_index()
    if 'code' not in shark.columns:
        hawk = {rabbit: np.nan for rabbit in salmon}
        return _make_factor_series(hawk, date, universe=universe, name='factor106')
    shark['time'] = pd.to_datetime(shark['time'])
    sparrow = shark.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=salmon).astype(float)
    turtle = shark.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=salmon).astype(float)
    sparrow = sparrow.tail(int(N) + 1)
    turtle = turtle.reindex(index=sparrow.index).tail(int(N) + 1)
    lion = sparrow.values
    wolf = turtle.values
    if lion.shape[0] < 2:
        hawk = {rabbit: np.nan for rabbit in salmon}
        return _make_factor_series(hawk, date, universe=universe, name='factor106')
    otter = lion + wolf
    fox = np.vstack([otter[0:1, :], otter[:-1, :]])
    koala = np.abs(lion - np.vstack([lion[0:1, :], lion[:-1, :]]))
    bear = np.abs(wolf - np.vstack([wolf[0:1, :], wolf[:-1, :]]))
    lizard = np.maximum(koala, bear)
    panda = np.where(otter <= fox, 0.0, lizard)
    cat = np.where(otter >= fox, 0.0, lizard)
    panda[0, :] = 0.0
    cat[0, :] = 0.0
    tiger = np.sum(panda[-int(N):, :], axis=0)
    dog = np.sum(cat[-int(N):, :], axis=0)
    whale = tiger + dog
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = (tiger - dog) / whale * 100.0
    dolphin = np.where(np.isfinite(dolphin) & (whale != 0), dolphin, np.nan)
    hawk = {rabbit: float(dolphin[owl]) if np.isfinite(dolphin[owl]) else np.nan for owl, rabbit in enumerate(salmon)}
    return _make_factor_series(hawk, date, universe=universe, name='factor106')

def factor107(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    tiger = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    dolphin = whale - 4
    rabbit = pd.PeriodIndex([dolphin, whale], freq='Q-DEC')
    wolf = get_history_fundamentals(security=tiger, fields=[bear.term_087], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or 'code' not in wolf.columns or ('statDate' not in wolf.columns):
        return _make_factor_series({dog: np.nan for dog in tiger}, otter, universe=universe, name='factor107')
    wolf = wolf.copy()
    if 'pubDate' in wolf.columns:
        zebra = pd.to_datetime(wolf['pubDate'], errors='coerce')
        wolf = wolf[zebra.notna() & (zebra <= cat)]
    wolf['code'] = wolf['code'].astype(str)
    wolf['statDate'] = pd.to_datetime(wolf['statDate'], errors='coerce')
    wolf = wolf.dropna(subset=['code', 'statDate'])
    if wolf.empty or 'term_087' not in wolf.columns:
        return _make_factor_series({dog: np.nan for dog in tiger}, otter, universe=universe, name='factor107')
    wolf['q'] = wolf['statDate'].dt.to_period('Q-DEC')
    wolf = wolf[wolf['q'].isin(rabbit)]
    wolf = wolf.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if wolf.empty:
        return _make_factor_series({dog: np.nan for dog in tiger}, otter, universe=universe, name='factor107')
    lion = wolf.pivot(index='q', columns='code', values='term_087').reindex(index=rabbit, columns=tiger)
    lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
    koala = lion.loc[whale]
    panda = lion.loc[dolphin]
    fox = panda.abs()
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = (koala - panda) / fox
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    giraffe = giraffe.where(np.isfinite(fox) & (fox > 0), np.nan)
    bear = {dog: float(giraffe.get(dog, np.nan)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in tiger}
    return _make_factor_series(bear, otter, universe=universe, name='factor107')

def factor108(universe, date, start_date='2005-01-01'):
    _set_asof_date(date)
    koala = _to_date(date)
    panda = list(universe)
    hawk = pd.to_datetime(start_date).strftime('%Y-%m-%d')
    fox = pd.to_datetime(koala).strftime('%Y-%m-%d')
    otter = get_price(panda, start_date=hawk, end_date=fox, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if otter is None or otter.empty:
        wolf = {cat: np.nan for cat in panda}
        return _make_factor_series(wolf, date, universe=universe, name='factor108')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    if 'code' not in otter.columns:
        wolf = {cat: np.nan for cat in panda}
        return _make_factor_series(wolf, date, universe=universe, name='factor108')
    otter['time'] = pd.to_datetime(otter['time'])
    otter = otter[['time', 'code', 'close', 'volume']].dropna(subset=['close', 'volume'])
    otter['close'] = otter['close'].astype(float)
    otter['volume'] = otter['volume'].astype(float)
    otter = otter[np.isfinite(otter['close'].values) & np.isfinite(otter['volume'].values)]
    if otter.empty:
        wolf = {cat: np.nan for cat in panda}
        return _make_factor_series(wolf, date, universe=universe, name='factor108')
    otter = otter.sort_values(['code', 'time'])
    wolf = {}
    for dog, bear in otter.groupby('code', sort=False):
        bear = bear.sort_values('time')
        cat = bear['close'].values.astype(float)
        sparrow = bear['volume'].values.astype(float)
        if cat.size < 2:
            wolf[dog] = np.nan
            continue
        whale = cat[:-1]
        tiger = cat[1:]
        shark = sparrow[:-1]
        lion = sparrow[1:]
        with np.errstate(divide='ignore', invalid='ignore'):
            eagle = tiger / whale - 1.0
        eagle = np.where(np.isfinite(eagle) & (whale != 0), eagle, 0.0)
        rabbit = np.isfinite(lion) & np.isfinite(shark) & (lion < shark)
        if rabbit.sum() == 0:
            zebra = 1000.0
        else:
            giraffe = 1.0 + eagle[rabbit]
            giraffe = giraffe[np.isfinite(giraffe)]
            if giraffe.size == 0:
                zebra = np.nan
            else:
                zebra = 1000.0 * float(np.prod(giraffe))
        wolf[dog] = float(zebra) if np.isfinite(zebra) else np.nan
    dolphin = {cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in panda}
    return _make_factor_series(dolphin, date, universe=universe, name='factor108')

def factor109(universe, date):
    _set_asof_date(date)
    panda = list(universe)
    tiger = _r3_safe_date(date)
    koala = _r3_fundamentals(fox, [fox.surplus_reserve_fund], panda, date=tiger)
    otter = _r3_fundamentals(giraffe, [giraffe.term_008], panda, date=tiger)
    lion = _r3_join_code(panda, koala, otter)
    fox = pd.to_numeric(lion.get('surplus_reserve_fund', np.nan), errors='coerce')
    dog = pd.to_numeric(lion.get('term_008', np.nan), errors='coerce')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = fox / (dog * 10000.0)
    wolf = wolf.where(np.isfinite(wolf) & (dog > 0), np.nan)
    return _make_factor_series({cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in panda}, date, universe=universe, name='factor109')

def factor110(universe, date, N1=20, N2=5):
    _set_asof_date(date)
    lizard = _to_date(date)
    narwhal = int(N1) + int(N2) + 10
    frog = _last_n_trade_days(lizard, narwhal)
    if len(frog) < int(N1) + 1:
        alpaca = {sparrow: np.nan for sparrow in universe}
        return _make_factor_series(alpaca, date, universe=universe, name='factor110')
    iguana = list(universe)
    gecko = pd.to_datetime(frog[0]).strftime('%Y-%m-%d')
    tuna = pd.to_datetime(lizard).strftime('%Y-%m-%d')
    salmon = get_price(iguana, start_date=gecko, end_date=tuna, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if salmon is None or salmon.empty:
        alpaca = {sparrow: np.nan for sparrow in iguana}
        return _make_factor_series(alpaca, date, universe=universe, name='factor110')
    salmon = salmon.copy()
    if 'time' not in salmon.columns:
        salmon = salmon.reset_index()
    if 'code' not in salmon.columns:
        alpaca = {sparrow: np.nan for sparrow in iguana}
        return _make_factor_series(alpaca, date, universe=universe, name='factor110')
    salmon['time'] = pd.to_datetime(salmon['time'])
    lemur = salmon.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=iguana).astype(float)
    beaver = salmon.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=iguana).astype(float)
    hawk = salmon.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=iguana).astype(float)
    lemur = lemur.tail(narwhal)
    beaver = beaver.reindex(index=lemur.index).tail(narwhal)
    hawk = hawk.reindex(index=lemur.index).tail(narwhal)
    tiger = lemur.values
    lion = beaver.values
    cat = hawk.values
    rabbit, koala = cat.shape
    if rabbit < int(N1) + 1:
        alpaca = {sparrow: np.nan for sparrow in iguana}
        return _make_factor_series(alpaca, date, universe=universe, name='factor110')
    dog = np.vstack([cat[0:1, :], cat[:-1, :]])
    zebra = tiger - lion
    dolphin = np.abs(dog - tiger)
    whale = np.abs(dog - lion)
    giraffe = np.maximum(zebra, np.maximum(dolphin, whale))
    turtle = cat - dog
    shark = giraffe.copy()
    owl = (cat > dog) & (turtle != 0) & np.isfinite(turtle) & np.isfinite(giraffe)
    shark[owl] = giraffe[owl] / turtle[owl]
    shark[0, :] = 0.0
    otter = int(N1)
    wolf = np.full_like(shark, np.nan, dtype=float)
    for hyena in range(otter - 1, rabbit):
        mole = shark[hyena - otter + 1:hyena + 1, :]
        jaguar = np.any(np.isfinite(mole), axis=0)
        llama = np.full(koala, np.nan, dtype=float)
        kangaroo = np.full(koala, np.nan, dtype=float)
        if jaguar.any():
            llama[jaguar] = np.nanmin(mole[:, jaguar], axis=0)
            kangaroo[jaguar] = np.nanmax(mole[:, jaguar], axis=0)
        ferret = kangaroo - llama
        donkey = np.isfinite(ferret) & (ferret > 0) & np.isfinite(shark[hyena, :]) & np.isfinite(llama)
        wolf[hyena, donkey] = (shark[hyena, donkey] - llama[donkey]) / ferret[donkey] * 100.0
        camel = ~donkey & np.isfinite(shark[hyena, :]) & np.isfinite(llama)
        wolf[hyena, camel] = (shark[hyena, camel] - llama[camel]) * 100.0
    bear = np.nan_to_num(wolf, nan=0.0, posinf=0.0, neginf=0.0)
    eagle = 2.0 / (float(N2) + 1.0)
    panda = np.zeros_like(bear, dtype=float)
    panda[0, :] = bear[0, :]
    for hyena in range(1, rabbit):
        panda[hyena, :] = eagle * bear[hyena, :] + (1.0 - eagle) * panda[hyena - 1, :]
    fox = panda[-1, :]
    alpaca = {sparrow: float(fox[badger]) if np.isfinite(fox[badger]) else np.nan for badger, sparrow in enumerate(iguana)}
    return _make_factor_series(alpaca, date, universe=universe, name='factor110')

def factor111(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    panda = _r3_safe_date(date)
    koala = _r3_fundamentals(bear, [bear.term_090], dog, date=panda)
    lion = _r3_fundamentals(fox, [fox.term_081], dog, date=panda)
    tiger = _r3_join_code(dog, koala, lion)
    fox = pd.to_numeric(tiger.get('term_090', np.nan), errors='coerce')
    otter = pd.to_numeric(tiger.get('term_081', np.nan), errors='coerce')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = fox / otter
    wolf = wolf.where(np.isfinite(wolf) & (otter != 0), np.nan)
    return _make_factor_series({cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in dog}, date, universe=universe, name='factor111')

def factor112(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor112')

def factor113(universe, date):
    _set_asof_date(date)
    otter = get_factor_values(universe, factors=['term_051'], end_date=date, count=1)
    lion = otter.get('term_051', None)
    if lion is None or lion.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor113')
    panda = lion.iloc[-1]
    tiger = (pd.to_datetime(date) - DateOffset(years=1)).strftime('%Y-%m-%d')
    fox = get_factor_values(universe, factors=['term_051'], end_date=tiger, count=1)
    koala = fox.get('term_051', None)
    if koala is None or koala.empty:
        wolf = {cat: np.nan for cat in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor113')
    rabbit = koala.iloc[-1]
    wolf = {}
    for cat in universe:
        dog = panda.get(cat, np.nan)
        bear = rabbit.get(cat, np.nan)
        if not np.isfinite(dog) or not np.isfinite(bear) or bear == 0:
            giraffe = np.nan
        else:
            giraffe = (dog - bear) / abs(bear)
        wolf[cat] = float(giraffe) if np.isfinite(giraffe) else np.nan
    return _make_factor_series(wolf, date, universe=universe, name='factor113')

def factor114(universe, date, N=20, batch_size=200):
    _set_asof_date(date)
    giraffe = pd.to_datetime(date)
    zebra = _last_n_trade_days(giraffe, N)
    if len(zebra) == 0:
        owl = {koala: np.nan for koala in universe}
        return _make_factor_series(owl, giraffe, universe=universe, name='factor114')
    ferret = list(universe)
    dolphin = [pd.to_datetime(rabbit).date() for rabbit in zebra]
    camel = pd.to_datetime(zebra[0]).strftime('%Y-%m-%d')
    hawk = pd.to_datetime(zebra[-1]).strftime('%Y-%m-%d')
    eagle = (pd.to_datetime(hawk) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    wolf = []
    for turtle in range(0, len(ferret), max(1, int(batch_size))):
        tiger = ferret[turtle:turtle + max(1, int(batch_size))]
        frog = get_price(tiger, start_date=camel, end_date=eagle, frequency='1m', fields=['close', 'volume'], fq='post', panel=False)
        if frog is None or frog.empty:
            continue
        frog = frog.copy()
        if 'time' not in frog.columns:
            frog['time'] = frog.index
        frog['time'] = pd.to_datetime(frog['time'])
        if 'code' not in frog.columns:
            continue
        frog['date'] = frog['time'].dt.date
        frog = frog[frog['date'].isin(dolphin)]
        if frog.empty:
            continue
        frog = frog[['code', 'date', 'close', 'volume']].dropna(subset=['close', 'volume'])
        if frog.empty:
            continue
        frog['close'] = frog['close'].astype(float)
        frog['volume'] = frog['volume'].astype(float)
        frog = frog[np.isfinite(frog['close'].values) & np.isfinite(frog['volume'].values)]
        if frog.empty:
            continue
        frog['xy'] = frog['close'] * frog['volume']
        frog['x2'] = frog['close'] * frog['close']
        frog['y2'] = frog['volume'] * frog['volume']
        panda = frog.groupby(['code', 'date'], sort=False).agg(n=('close', 'count'), mx=('close', 'mean'), my=('volume', 'mean'), mxy=('xy', 'mean'), mx2=('x2', 'mean'), my2=('y2', 'mean'))
        alpaca = panda['mxy'] - panda['mx'] * panda['my']
        hyena = panda['mx2'] - panda['mx'] * panda['mx']
        iguana = panda['my2'] - panda['my'] * panda['my']
        whale = np.sqrt(hyena * iguana)
        otter = alpaca / whale
        otter[(panda['n'] < 3) | ~np.isfinite(otter) | ~np.isfinite(whale) | (whale <= 0)] = np.nan
        wolf.append(otter.rename('corr').reset_index())
    bear = {koala: np.nan for koala in ferret}
    if len(wolf) > 0:
        fox = pd.concat(wolf, ignore_index=True).dropna(subset=['corr'])
        for koala, donkey in fox.groupby('code', sort=False):
            gecko = donkey.sort_values('date')['corr'].values.astype(float)
            gecko = gecko[np.isfinite(gecko)]
            if gecko.size == 0:
                continue
            if gecko.size == 1:
                bear[koala] = 0.0
            else:
                bear[koala] = float(np.std(gecko, ddof=1))
    badger = pd.Series(bear, index=ferret, dtype='float64')
    lemur = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(ferret))
    shark = get_fundamentals(lemur, date=giraffe)
    if shark is None or shark.empty:
        sparrow = _zscore_series(badger)
    else:
        shark = shark.set_index('code')
        tuna = shark['term_045'].replace({0: np.nan}).astype(float)
        lizard = np.log(tuna)
        lizard = lizard.reindex(ferret)
        salmon = badger.notna() & lizard.notna()
        if salmon.sum() < 2:
            sparrow = _zscore_series(badger)
        else:
            kangaroo = badger[salmon].values.astype(float)
            jaguar = lizard[salmon].values.astype(float)
            cat = np.column_stack([np.ones(len(jaguar)), jaguar])
            try:
                lion, dog, dog, dog = np.linalg.lstsq(cat, kangaroo, rcond=None)
                llama = cat @ lion
                beaver = pd.Series(np.nan, index=ferret, dtype='float64')
                beaver.loc[badger[salmon].index] = kangaroo - llama
                sparrow = _zscore_series(beaver)
            except Exception:
                sparrow = _zscore_series(badger)
    owl = {koala: float(sparrow.get(koala, np.nan)) if np.isfinite(sparrow.get(koala, np.nan)) else np.nan for koala in ferret}
    return _make_factor_series(owl, giraffe, universe=universe, name='factor114')

def factor115(universe, date):
    _set_asof_date(date)
    tiger = get_factor_values(universe, factors=['term_051'], end_date=date, count=1)
    dog = tiger.get('term_051', None)
    if dog is None or dog.empty:
        lion = {cat: np.nan for cat in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor115')
    wolf = dog.iloc[-1]
    bear = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    panda = get_fundamentals(bear, date=date)
    if panda is None or panda.empty:
        panda = pd.DataFrame(columns=['code', 'term_045'])
    panda = panda.set_index('code')
    otter = panda['term_045']
    lion = {}
    for cat in universe:
        fox = wolf.get(cat, np.nan)
        koala = otter.get(cat, np.nan)
        if not np.isfinite(fox) or not np.isfinite(koala) or koala <= 0:
            rabbit = np.nan
        else:
            rabbit = fox / koala
        lion[cat] = float(rabbit) if np.isfinite(rabbit) else np.nan
    return _make_factor_series(lion, date, universe=universe, name='factor115')

def factor116(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor116')

def factor117(universe, date):
    _set_asof_date(date)
    lion = query(fox.code, fox.term_083, fox.term_084).filter(fox.code.in_(universe))
    panda = get_fundamentals(lion, date=date)
    if panda is None or panda.empty:
        tiger = {dog: np.nan for dog in universe}
        return _make_factor_series(tiger, date, universe=universe, name='factor117')
    panda = panda.set_index('code')
    tiger = {}
    for dog in universe:
        cat = panda['term_083'].get(dog, np.nan)
        koala = panda['term_084'].get(dog, np.nan)
        if not np.isfinite(cat) or not np.isfinite(koala) or koala == 0:
            otter = np.nan
        else:
            otter = cat / koala
        tiger[dog] = float(otter) if np.isfinite(otter) else np.nan
    return _make_factor_series(tiger, date, universe=universe, name='factor117')

def factor118(universe, date, N=20):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, N + 1)
    if len(otter) < 2:
        bear = {tiger: np.nan for tiger in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor118')
    shark = list(universe)
    dolphin = pd.to_datetime(otter[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(koala).strftime('%Y-%m-%d')
    fox = get_price(shark, start_date=dolphin, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        bear = {tiger: np.nan for tiger in shark}
        return _make_factor_series(bear, date, universe=universe, name='factor118')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index()
    if 'code' not in fox.columns:
        bear = {tiger: np.nan for tiger in shark}
        return _make_factor_series(bear, date, universe=universe, name='factor118')
    fox['time'] = pd.to_datetime(fox['time'])
    dog = fox.pivot(index='time', columns='code', values='close').sort_index()
    dog = dog.reindex(columns=shark)
    dog = dog.tail(int(N) + 1)
    if dog.shape[0] < 2:
        bear = {tiger: np.nan for tiger in shark}
        return _make_factor_series(bear, date, universe=universe, name='factor118')
    cat = dog.values.astype(float)
    giraffe = cat[:-1, :]
    lion = cat[1:, :]
    eagle = np.isfinite(giraffe) & np.isfinite(lion)
    zebra = np.full_like(lion, np.nan, dtype=float)
    zebra[eagle & (lion >= giraffe)] = 1.0
    zebra[eagle & (lion < giraffe)] = -1.0
    whale = np.nansum(zebra[-int(N):, :], axis=0)
    panda = np.sum(np.isfinite(zebra[-int(N):, :]), axis=0)
    whale = np.where(panda > 0, whale, np.nan)
    bear = {tiger: float(whale[rabbit]) if np.isfinite(whale[rabbit]) else np.nan for rabbit, tiger in enumerate(shark)}
    return _make_factor_series(bear, date, universe=universe, name='factor118')

def factor119(universe, date):
    _set_asof_date(date)
    otter = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    bear = [otter - koala for koala in range(0, 4)]
    dolphin = [f'{giraffe.year}q{giraffe.quarter}' for giraffe in bear]
    wolf = otter - 12
    rabbit = [wolf - koala for koala in range(0, 4)]
    whale = [f'{giraffe.year}q{giraffe.quarter}' for giraffe in rabbit]

    def _build_cost_ttm(stat_list):
        panda = {cat: [] for cat in universe}
        for lion in stat_list:
            tiger = query(bear.code, bear.term_060).filter(bear.code.in_(universe))
            dog = get_fundamentals(tiger, statDate=lion)
            if dog is None or dog.empty:
                continue
            dog = dog.set_index('code')
            for cat in universe:
                if cat in dog.index:
                    panda[cat].append(dog.at[cat, 'term_060'])
        koala = {}
        for cat in universe:
            otter = panda[cat]
            koala[cat] = np.nan if len(otter) == 0 else np.nansum(otter)
        return koala
    panda = _build_cost_ttm(dolphin)
    tiger = _build_cost_ttm(whale)
    lion = {}
    for dog in universe:
        cat = panda.get(dog, np.nan)
        fox = tiger.get(dog, np.nan)
        if not np.isfinite(cat) or not np.isfinite(fox) or fox <= 0:
            shark = np.nan
        else:
            zebra = cat / fox
            if zebra <= 0 or not np.isfinite(zebra):
                shark = np.nan
            else:
                shark = zebra ** (1.0 / 3.0) - 1.0
        lion[dog] = float(shark) if np.isfinite(shark) else np.nan
    return _make_factor_series(lion, date, universe=universe, name='factor119')

def factor120(universe, date, eps=1e-06, min_q_valid=2):
    _set_asof_date(date)
    cat = pd.Timestamp(_to_date(date))
    tiger = list(universe)
    dolphin = [wolf.term_049]
    whale = [bear.term_038, bear.term_039, bear.term_037, bear.term_040, bear.term_021]
    koala = get_history_fundamentals(security=tiger, fields=dolphin, watch_date=cat, count=8, interval='1q', stat_by_year=False)
    otter = get_history_fundamentals(security=tiger, fields=whale, watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if (koala is None or koala.empty) and (otter is None or otter.empty):
        return _make_factor_series({dog: np.nan for dog in tiger}, cat, universe=universe, name='factor120')

    def _to_q_last(df):
        if df is None or df.empty or 'code' not in df.columns or ('statDate' not in df.columns):
            return None
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    panda = _to_q_last(koala)
    turtle = _to_q_last(otter)
    frog = None
    if panda is not None and 'term_049' in panda.columns:
        frog = panda.pivot(index='q', columns='code', values='term_049').sort_index().reindex(columns=tiger)
        frog = frog.apply(pd.to_numeric, errors='coerce').astype(float)

    def _pivot(col):
        if inc_q is None or col not in inc_q.columns:
            return None
        cat = inc_q.pivot(index='q', columns='code', values=col).sort_index().reindex(columns=codes)
        return cat.apply(pd.to_numeric, errors='coerce').astype(float)
    hawk = _pivot('term_038')
    sparrow = _pivot('term_039')
    eagle = _pivot('term_037')
    owl = _pivot('term_040')
    shark = _pivot('term_021')
    alpaca = None
    for tuna in (frog, hawk, sparrow, eagle, owl, shark):
        if tuna is not None and tuna.shape[0] > 0:
            alpaca = tuna.index if alpaca is None else alpaca.union(tuna.index)
    if alpaca is None or len(alpaca) < 4:
        return _make_factor_series({dog: np.nan for dog in tiger}, cat, universe=universe, name='factor120')
    alpaca = alpaca.sort_values()

    def _align(pv):
        if pv is None:
            return pd.DataFrame(np.nan, index=q_index, columns=codes, dtype=float)
        return pv.reindex(index=q_index, columns=codes)
    frog = _align(frog)
    hawk = _align(hawk)
    sparrow = _align(sparrow)
    eagle = _align(eagle)
    owl = _align(owl)
    shark = _align(shark)
    lizard = frog.tail(4)
    bear = (hawk - sparrow).tail(4)
    rabbit = (eagle - owl).tail(4)
    giraffe = shark.tail(4)
    wolf = bear.copy()
    wolf = wolf.where(np.isfinite(wolf.values), rabbit)
    wolf = wolf.where(np.isfinite(wolf.values), giraffe)
    salmon = lizard.sum(axis=0, min_count=min_q_valid)
    zebra = wolf.sum(axis=0, min_count=min_q_valid)
    lion = zebra.abs()
    lemur = salmon / lion - 1.0
    lemur = lemur.replace([np.inf, -np.inf], np.nan)
    lemur = lemur.where(np.isfinite(lion) & (lion >= float(eps)), np.nan)
    fox = {dog: float(lemur.get(dog, np.nan)) if np.isfinite(lemur.get(dog, np.nan)) else np.nan for dog in tiger}
    return _make_factor_series(fox, cat, universe=universe, name='factor120')

def factor121(universe, date, alpha=0.5, d=20, batch_size=200):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = get_trade_days(end_date=koala, count=d)
    if len(otter) == 0:
        zebra = {lion: np.nan for lion in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor121')
    turtle = list(universe)
    owl = pd.to_datetime(otter[0]).strftime('%Y-%m-%d')
    rabbit = pd.to_datetime(otter[-1]).strftime('%Y-%m-%d')
    bear = (pd.to_datetime(rabbit) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    fox = [pd.to_datetime(frog).date() for frog in otter]
    eagle = []
    for dolphin in range(0, len(turtle), max(1, int(batch_size))):
        dog = turtle[dolphin:dolphin + max(1, int(batch_size))]
        whale = get_price(dog, start_date=owl, end_date=bear, frequency='5m', fields=['open', 'high', 'low', 'close', 'volume'], fq='post', panel=False)
        if whale is None or whale.empty:
            continue
        whale = whale.copy()
        if 'time' not in whale.columns:
            whale['time'] = whale.index
        whale['time'] = pd.to_datetime(whale['time'])
        if 'code' not in whale.columns:
            if len(dog) == 1:
                whale['code'] = dog[0]
            else:
                continue
        whale['date'] = whale['time'].dt.date
        whale = whale[whale['date'].isin(fox)]
        if whale.empty:
            continue
        whale = whale[['code', 'date', 'open', 'high', 'low', 'close', 'volume']].dropna(subset=['open', 'high', 'low', 'close', 'volume'])
        if whale.empty:
            continue
        for tiger in ['open', 'high', 'low', 'close', 'volume']:
            whale[tiger] = whale[tiger].astype(float)
        panda = (whale['close'] - whale['open']).abs()
        sparrow = (whale['high'] - whale['low']).abs()
        giraffe = panda <= float(alpha) * sparrow
        lizard = whale['close'] > whale['open']
        shark = giraffe & lizard
        whale['cons_vol'] = np.where(shark.values, whale['volume'].values, 0.0)
        cat = whale.groupby(['code', 'date'], sort=False).agg(cons=('cons_vol', 'sum'), vol=('volume', 'sum')).reset_index()
        eagle.append(cat)
    if len(eagle) == 0:
        zebra = {lion: np.nan for lion in turtle}
        return _make_factor_series(zebra, date, universe=universe, name='factor121')
    wolf = pd.concat(eagle, ignore_index=True)
    if wolf.empty:
        zebra = {lion: np.nan for lion in turtle}
        return _make_factor_series(zebra, date, universe=universe, name='factor121')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf['r'] = wolf['cons'] / wolf['vol']
    wolf['r'] = wolf['r'].replace([np.inf, -np.inf], np.nan)
    hawk = wolf.groupby('code', sort=False)['r'].mean()
    zebra = {lion: float(hawk.get(lion, np.nan)) if np.isfinite(hawk.get(lion, np.nan)) else np.nan for lion in turtle}
    return _make_factor_series(zebra, date, universe=universe, name='factor121')

def factor122(universe, date):
    _set_asof_date(date)
    lion = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=date, count=1)
    panda = lion.get('np_parent_company_owners_ttm', None)
    if panda is None or panda.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor122')
    wolf = panda.iloc[-1]
    dog = (pd.to_datetime(date) - DateOffset(years=3)).strftime('%Y-%m-%d')
    koala = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=dog, count=1)
    tiger = koala.get('np_parent_company_owners_ttm', None)
    if tiger is None or tiger.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor122')
    bear = tiger.iloc[-1]
    otter = {}
    for cat in universe:
        rabbit = wolf.get(cat, np.nan)
        fox = bear.get(cat, np.nan)
        if not np.isfinite(rabbit) or not np.isfinite(fox) or fox == 0:
            zebra = np.nan
        else:
            giraffe = (rabbit - fox) / abs(fox) + 1.0
            if not np.isfinite(giraffe) or giraffe <= 0:
                zebra = np.nan
            else:
                zebra = giraffe ** (1.0 / 3.0) - 1.0
        otter[cat] = float(zebra) if np.isfinite(zebra) else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor122')

def factor123(universe, date, N=20):
    _set_asof_date(date)
    dolphin = _to_date(date)
    whale = _last_n_trade_days(dolphin, N + 1)
    if len(whale) < 2:
        owl = {zebra: np.nan for zebra in universe}
        return _make_factor_series(owl, date, universe=universe, name='factor123')
    salmon = list(universe)
    frog = pd.to_datetime(whale[0]).strftime('%Y-%m-%d')
    sparrow = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    eagle = get_price(salmon, start_date=frog, end_date=sparrow, frequency='daily', fields=['high', 'low', 'close', 'volume'], fq='post', panel=False)
    if eagle is None or eagle.empty:
        owl = {zebra: np.nan for zebra in salmon}
        return _make_factor_series(owl, date, universe=universe, name='factor123')
    eagle = eagle.copy()
    if 'time' not in eagle.columns:
        eagle = eagle.reset_index()
    if 'code' not in eagle.columns:
        owl = {zebra: np.nan for zebra in salmon}
        return _make_factor_series(owl, date, universe=universe, name='factor123')
    eagle['time'] = pd.to_datetime(eagle['time'])
    dog = eagle.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=salmon).astype(float)
    panda = eagle.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=salmon).astype(float)
    cat = eagle.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=salmon).astype(float)
    giraffe = eagle.pivot(index='time', columns='code', values='volume').sort_index().reindex(columns=salmon).astype(float)
    dog = dog.tail(int(N) + 1)
    panda = panda.reindex(index=dog.index).tail(int(N) + 1)
    cat = cat.reindex(index=dog.index).tail(int(N) + 1)
    giraffe = giraffe.reindex(index=dog.index).tail(int(N) + 1)
    if dog.shape[0] < 2:
        owl = {zebra: np.nan for zebra in salmon}
        return _make_factor_series(owl, date, universe=universe, name='factor123')
    wolf = (dog.values + panda.values + cat.values) / 3.0
    tiger = wolf * giraffe.values
    rabbit = wolf[:-1, :]
    bear = wolf[1:, :]
    lion = tiger[1:, :]
    alpaca = np.isfinite(bear) & np.isfinite(rabbit) & np.isfinite(lion)
    tuna = alpaca & (bear > rabbit)
    hawk = alpaca & (bear <= rabbit)
    fox = np.sum(np.where(tuna, lion, 0.0), axis=0)
    otter = np.sum(np.where(hawk, lion, 0.0), axis=0)
    shark = otter
    with np.errstate(divide='ignore', invalid='ignore'):
        koala = fox / shark
        lizard = 100.0 - 100.0 / (1.0 + koala)
    lizard = np.where(np.isfinite(lizard) & (otter != 0), lizard, np.nan)
    owl = {zebra: float(lizard[turtle]) if np.isfinite(lizard[turtle]) else np.nan for turtle, zebra in enumerate(salmon)}
    return _make_factor_series(owl, date, universe=universe, name='factor123')

def factor124(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor124')

def factor125(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    giraffe = pd.Period(cat, freq='Q-DEC') - 1
    bear = giraffe - 4
    rabbit = pd.PeriodIndex([bear, giraffe], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    koala = get_history_fundamentals(security=tiger, fields=[fox.term_084], watch_date=cat, count=40, interval='1q', stat_by_year=False)
    dog = _prep_hist(koala)
    if dog.empty or 'term_084' not in dog.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor125')
    dog = dog[dog['q'].isin(rabbit)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor125')
    dolphin = dog.pivot(index='q', columns='code', values='term_084').reindex(index=rabbit, columns=tiger)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = dolphin.loc[giraffe] if giraffe in dolphin.index else pd.Series(np.nan, index=tiger, dtype='float64')
    zebra = dolphin.loc[bear] if bear in dolphin.index else pd.Series(np.nan, index=tiger, dtype='float64')
    whale = whale.where(np.isfinite(whale) & (whale > 0), np.nan)
    zebra = zebra.where(np.isfinite(zebra) & (zebra > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = np.log(whale / zebra)
    wolf = wolf.replace([np.inf, -np.inf], np.nan)
    fox = ~np.isfinite(wolf) | ~np.isfinite(whale) | ~np.isfinite(zebra) | (whale <= 0) | (zebra <= 0)
    wolf = wolf.where(~fox, np.nan).reindex(tiger)
    otter = {panda: float(wolf.get(panda)) if np.isfinite(wolf.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(otter, lion, universe=universe, name='factor125')

def factor126(universe, date, K_months=1):
    _set_asof_date(date)
    wolf = _to_date(date)
    otter = list(universe)
    hawk = int(K_months * 21) + 1
    bear = get_trade_days(end_date=wolf, count=hawk)
    if bear is None or len(bear) < 2:
        return _make_factor_series({lion: np.nan for lion in otter}, wolf, universe=universe, name='factor126')
    sparrow = [pd.to_datetime(fox).date() for fox in list(bear[:-1])]
    if len(sparrow) < 5:
        return _make_factor_series({lion: np.nan for lion in otter}, wolf, universe=universe, name='factor126')
    turtle = query(giraffe.code, giraffe.term_095).filter(giraffe.code.in_(otter))
    frog = []
    for fox in sparrow:
        rabbit = get_fundamentals(turtle, date=pd.Timestamp(fox).strftime('%Y-%m-%d'))
        if rabbit is None or rabbit.empty or 'code' not in rabbit.columns:
            frog.append(pd.Series(np.nan, index=otter, name=pd.Timestamp(fox)))
            continue
        rabbit = rabbit.copy()
        rabbit['code'] = rabbit['code'].astype(str)
        salmon = pd.to_numeric(rabbit.set_index('code').get('term_095', np.nan), errors='coerce').astype(float).reindex(otter)
        frog.append(pd.Series(salmon.values, index=otter, name=pd.Timestamp(fox)))
    tuna = pd.DataFrame(frog)
    tuna = tuna.where(tuna > 0)
    shark = np.log(tuna).replace([np.inf, -np.inf], np.nan).mean(axis=0, skipna=True)
    owl = query(giraffe.code, giraffe.term_013).filter(giraffe.code.in_(otter))
    giraffe = get_fundamentals(owl, date=pd.Timestamp(wolf).strftime('%Y-%m-%d'))
    if giraffe is None or giraffe.empty or 'code' not in giraffe.columns:
        whale = pd.Series(np.nan, index=otter, dtype='float64')
    else:
        giraffe = giraffe.copy()
        giraffe['code'] = giraffe['code'].astype(str)
        koala = pd.to_numeric(giraffe.set_index('code').get('term_013', np.nan), errors='coerce').astype(float).reindex(otter)
        whale = np.where(np.isfinite(koala.values) & (koala.values > 0), np.log(koala.values), np.nan)
        whale = pd.Series(whale, index=otter, dtype='float64')
    lemur = pd.to_numeric(shark, errors='coerce')
    alpaca = pd.to_numeric(whale, errors='coerce')
    eagle = np.isfinite(lemur.values) & np.isfinite(alpaca.values)
    lizard = pd.Series(np.nan, index=otter, dtype='float64')
    if eagle.sum() >= 3:
        dog = lemur.values[eagle].astype(float)
        cat = np.column_stack([np.ones(eagle.sum(), dtype=float), alpaca.values[eagle].astype(float)])
        try:
            tiger, panda, panda, panda = np.linalg.lstsq(cat, dog, rcond=None)
            zebra = dog - cat.dot(tiger)
            lizard.iloc[np.where(eagle)[0]] = zebra
        except Exception:
            pass
    dolphin = {lion: float(lizard.loc[lion]) if np.isfinite(lizard.loc[lion]) else np.nan for lion in otter}
    return _make_factor_series(dolphin, wolf, universe=universe, name='factor126')

def factor127(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor127')

def factor128(universe, date):
    _set_asof_date(date)
    lion = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=date, count=1)
    panda = lion.get('np_parent_company_owners_ttm', None)
    if panda is None or panda.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor128')
    wolf = panda.iloc[-1]
    dog = (pd.to_datetime(date) - DateOffset(years=3)).strftime('%Y-%m-%d')
    koala = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=dog, count=1)
    tiger = koala.get('np_parent_company_owners_ttm', None)
    if tiger is None or tiger.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor128')
    bear = tiger.iloc[-1]
    otter = {}
    for cat in universe:
        rabbit = wolf.get(cat, np.nan)
        fox = bear.get(cat, np.nan)
        if not np.isfinite(rabbit) or not np.isfinite(fox) or fox == 0:
            zebra = np.nan
        else:
            giraffe = (rabbit - fox) / abs(fox) + 1.0
            if not np.isfinite(giraffe) or giraffe <= 0:
                zebra = np.nan
            else:
                zebra = giraffe ** (1.0 / 3.0) - 1.0
        otter[cat] = float(zebra) if np.isfinite(zebra) else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor128')

def factor129(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    turtle = pd.Period(cat, freq='Q-DEC') - 1
    lizard = turtle - 1
    frog = pd.PeriodIndex([turtle, turtle - 1, turtle - 2, turtle - 3], freq='Q-DEC')
    owl = pd.PeriodIndex([lizard, turtle], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    salmon = pd.Series(np.nan, index=lion, dtype='float64')
    alpaca = _nearest_td_le(koala)
    if alpaca is not None:
        try:
            zebra = get_factor_values(lion, factors=['term_068'], end_date=alpaca, count=1)
            wolf = zebra.get('term_068', None) if isinstance(zebra, dict) else None
            if isinstance(wolf, pd.DataFrame) and (not wolf.empty):
                tuna = wolf.iloc[-1]
                tuna.index = tuna.index.astype(str)
                salmon = pd.to_numeric(tuna, errors='coerce').astype(float).reindex(lion)
        except Exception:
            pass
    if salmon.notna().sum() < 10:
        fox = get_history_fundamentals(security=lion, fields=[bear.term_066], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        shark = _prep_hist(fox)
        if not shark.empty and 'term_066' in shark.columns:
            shark = shark[shark['q'].isin(frog)]
            if not shark.empty:
                sparrow = shark.pivot(index='q', columns='code', values='term_066').reindex(index=frog, columns=lion)
                sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
                whale = sparrow.sum(axis=0, min_count=1).reindex(lion)
                salmon = salmon.where(np.isfinite(salmon), whale)
    otter = get_history_fundamentals(security=lion, fields=[fox.term_025], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(otter)
    if panda.empty or 'term_025' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor129')
    panda = panda[panda['q'].isin(owl)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor129')
    bear = panda.pivot(index='q', columns='code', values='term_025').reindex(index=owl, columns=lion)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = bear.loc[turtle] if turtle in bear.index else pd.Series(np.nan, index=lion, dtype='float64')
    giraffe = bear.loc[lizard] if lizard in bear.index else pd.Series(np.nan, index=lion, dtype='float64')
    dog = (rabbit + giraffe) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = salmon / dog
    eagle = ~np.isfinite(hawk) | ~np.isfinite(salmon) | ~np.isfinite(dog) | (dog == 0)
    hawk = hawk.where(~eagle, np.nan).reindex(lion)
    dolphin = {tiger: float(hawk.get(tiger)) if np.isfinite(hawk.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(dolphin, koala, universe=universe, name='factor129')

def factor130(universe, date, window=160, q=0.7):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = _last_n_trade_days(wolf, int(window) + 1)
    if len(bear) < 2:
        zebra = {fox: np.nan for fox in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor130')
    tuna = list(universe)
    salmon = pd.to_datetime(bear[0]).strftime('%Y-%m-%d')
    giraffe = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    rabbit = get_price(tuna, start_date=salmon, end_date=giraffe, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        zebra = {fox: np.nan for fox in tuna}
        return _make_factor_series(zebra, date, universe=universe, name='factor130')
    rabbit = rabbit.copy()
    if 'time' not in rabbit.columns:
        rabbit = rabbit.reset_index()
    if 'code' not in rabbit.columns:
        zebra = {fox: np.nan for fox in tuna}
        return _make_factor_series(zebra, date, universe=universe, name='factor130')
    rabbit['time'] = pd.to_datetime(rabbit['time'])
    dolphin = rabbit.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=tuna).astype(float)
    eagle = rabbit.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=tuna).astype(float)
    otter = rabbit.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=tuna).astype(float)
    dolphin = dolphin.tail(int(window) + 1)
    eagle = eagle.reindex(index=dolphin.index).tail(int(window) + 1)
    otter = otter.reindex(index=dolphin.index).tail(int(window) + 1)
    if dolphin.shape[0] < int(window) + 1:
        zebra = {fox: np.nan for fox in tuna}
        return _make_factor_series(zebra, date, universe=universe, name='factor130')
    dog = dolphin.values
    panda = eagle.values
    cat = otter.values
    with np.errstate(divide='ignore', invalid='ignore'):
        koala = dog[1:, :] / panda[1:, :] - 1.0
        lizard = cat[1:, :] / cat[:-1, :] - 1.0
    koala = np.where(np.isfinite(koala) & np.isfinite(lizard) & np.isfinite(panda[1:, :]) & (panda[1:, :] != 0), koala, np.nan)
    lizard = np.where(np.isfinite(lizard), lizard, np.nan)
    zebra = {}
    for whale, fox in enumerate(tuna):
        tiger = koala[:, whale].astype(float)
        owl = lizard[:, whale].astype(float)
        hawk = np.isfinite(tiger) & np.isfinite(owl)
        if hawk.sum() < max(10, int(window) // 4):
            zebra[fox] = np.nan
            continue
        lion = tiger[hawk]
        turtle = owl[hawk]
        sparrow = float(np.quantile(lion, float(q)))
        frog = lion <= sparrow
        if frog.sum() == 0:
            zebra[fox] = np.nan
            continue
        shark = float(np.sum(turtle[frog]))
        zebra[fox] = shark if np.isfinite(shark) else np.nan
    return _make_factor_series(zebra, date, universe=universe, name='factor130')

def factor131(universe, date, K_months=3, mkt_index='000905.XSHG'):
    _set_asof_date(date)
    zebra = int(K_months * 21) + 1
    otter = _last_n_trade_days(date, zebra)
    if len(otter) < 2:
        bear = {lion: np.nan for lion in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor131')
    owl = otter[0]
    turtle = pd.to_datetime(owl).strftime('%Y-%m-%d')
    koala = list(set(universe) | {mkt_index})
    fox = get_price(koala, start_date=turtle, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        bear = {lion: np.nan for lion in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor131')
    fox = fox.reset_index()
    dolphin = fox.pivot(index='time', columns='code', values='close').sort_index()
    if mkt_index not in dolphin.columns:
        bear = {lion: np.nan for lion in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor131')
    sparrow = dolphin.pct_change()
    hawk = sparrow[mkt_index].values.astype(float)
    bear = {}
    for lion in universe:
        if lion not in sparrow.columns:
            bear[lion] = np.nan
            continue
        shark = sparrow[lion].values.astype(float)
        giraffe = np.isfinite(hawk) & np.isfinite(shark)
        eagle = hawk[giraffe]
        whale = shark[giraffe]
        if len(eagle) < 10:
            bear[lion] = np.nan
            continue
        dog = np.column_stack([np.ones(len(eagle)), eagle])
        try:
            tiger, panda, panda, panda = np.linalg.lstsq(dog, whale, rcond=None)
            salmon = dog @ tiger
            wolf = whale - salmon
        except Exception:
            bear[lion] = np.nan
            continue
        cat = len(wolf)
        if cat <= 1:
            bear[lion] = np.nan
            continue
        frog = (wolf ** 2).mean()
        rabbit = (wolf ** 3).mean()
        if not np.isfinite(frog) or frog <= 0:
            lizard = np.nan
        else:
            lizard = rabbit / frog ** 1.5
        bear[lion] = float(lizard) if np.isfinite(lizard) else np.nan
    return _make_factor_series(bear, date, universe=universe, name='factor131')

def factor132(universe, date):
    _set_asof_date(date)
    tiger = query(fox.code, fox.term_084, fox.term_081).filter(fox.code.in_(universe))
    dog = get_fundamentals(tiger, date=date)
    if dog is None or dog.empty:
        panda = {cat: np.nan for cat in universe}
        return _make_factor_series(panda, date, universe=universe, name='factor132')
    dog = dog.set_index('code')
    panda = {}
    for cat in universe:
        koala = dog['term_084'].get(cat, np.nan)
        lion = dog['term_081'].get(cat, np.nan)
        if not np.isfinite(koala) or not np.isfinite(lion) or lion == 0:
            otter = np.nan
        else:
            otter = koala / lion
        panda[cat] = float(otter) if np.isfinite(otter) else np.nan
    return _make_factor_series(panda, date, universe=universe, name='factor132')

def factor133(universe, date):
    _set_asof_date(date)
    lion = get_factor_values(universe, factors=['term_065'], end_date=date, count=1)
    panda = lion.get('term_065', None)
    if panda is None or panda.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor133')
    wolf = panda.iloc[-1]
    dog = (pd.to_datetime(date) - DateOffset(years=3)).strftime('%Y-%m-%d')
    koala = get_factor_values(universe, factors=['term_065'], end_date=dog, count=1)
    tiger = koala.get('term_065', None)
    if tiger is None or tiger.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor133')
    bear = tiger.iloc[-1]
    otter = {}
    for cat in universe:
        rabbit = wolf.get(cat, np.nan)
        fox = bear.get(cat, np.nan)
        if not np.isfinite(rabbit) or not np.isfinite(fox) or fox == 0:
            zebra = np.nan
        else:
            giraffe = (rabbit - fox) / abs(fox) + 1.0
            if not np.isfinite(giraffe) or giraffe <= 0:
                zebra = np.nan
            else:
                zebra = giraffe ** (1.0 / 3.0) - 1.0
        otter[cat] = float(zebra) if np.isfinite(zebra) else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor133')

def factor134(universe, date, start_date='2005-01-01'):
    _set_asof_date(date)
    koala = _to_date(date)
    panda = list(universe)
    hawk = pd.to_datetime(start_date).strftime('%Y-%m-%d')
    fox = pd.to_datetime(koala).strftime('%Y-%m-%d')
    otter = get_price(panda, start_date=hawk, end_date=fox, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if otter is None or otter.empty:
        wolf = {cat: np.nan for cat in panda}
        return _make_factor_series(wolf, date, universe=universe, name='factor134')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    if 'code' not in otter.columns:
        wolf = {cat: np.nan for cat in panda}
        return _make_factor_series(wolf, date, universe=universe, name='factor134')
    otter['time'] = pd.to_datetime(otter['time'])
    otter = otter[['time', 'code', 'close', 'volume']].dropna(subset=['close', 'volume'])
    otter['close'] = otter['close'].astype(float)
    otter['volume'] = otter['volume'].astype(float)
    otter = otter[np.isfinite(otter['close'].values) & np.isfinite(otter['volume'].values)]
    if otter.empty:
        wolf = {cat: np.nan for cat in panda}
        return _make_factor_series(wolf, date, universe=universe, name='factor134')
    otter = otter.sort_values(['code', 'time'])
    wolf = {}
    for dog, bear in otter.groupby('code', sort=False):
        bear = bear.sort_values('time')
        cat = bear['close'].values.astype(float)
        sparrow = bear['volume'].values.astype(float)
        if cat.size < 2:
            wolf[dog] = np.nan
            continue
        dolphin = cat[:-1]
        tiger = cat[1:]
        whale = sparrow[:-1]
        lion = sparrow[1:]
        with np.errstate(divide='ignore', invalid='ignore'):
            eagle = tiger / dolphin - 1.0
        owl = np.isfinite(dolphin) & (dolphin != 0)
        eagle = np.where(np.isfinite(eagle) & owl, eagle, np.nan)
        rabbit = np.isfinite(lion) & np.isfinite(whale) & (lion > whale) & np.isfinite(eagle)
        if rabbit.sum() == 0:
            shark = 1000.0
        else:
            giraffe = 1.0 + eagle[rabbit]
            giraffe = giraffe[np.isfinite(giraffe)]
            if giraffe.size == 0:
                shark = np.nan
            else:
                shark = 1000.0 * float(np.prod(giraffe))
        wolf[dog] = float(shark) if np.isfinite(shark) else np.nan
    zebra = {cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in panda}
    return _make_factor_series(zebra, date, universe=universe, name='factor134')

def factor135(universe, date):
    rabbit = _norm_universe(universe)
    panda = pd.to_datetime(date)
    lion = get_factor_values(rabbit, factors=['term_068'], end_date=panda, count=1)
    bear = _safe_factor_last_row(lion, 'term_068', rabbit)
    wolf = query(fox.code, fox.term_001, fox.term_057, fox.term_005).filter(fox.code.in_(rabbit))
    tiger = get_fundamentals(wolf, date=panda)
    if tiger is None or len(tiger) == 0:
        koala = pd.Series(np.nan, index=rabbit, name='factor135')
        return koala
    tiger = tiger.copy()
    if 'code' in tiger.columns:
        tiger['code'] = tiger['code'].astype(str)
        tiger = tiger.set_index('code')
    cat = pd.to_numeric(tiger.get('term_001', np.nan), errors='coerce').reindex(rabbit)
    otter = pd.to_numeric(tiger.get('term_057', np.nan), errors='coerce').reindex(rabbit)
    dog = pd.to_numeric(tiger.get('term_005', np.nan), errors='coerce').reindex(rabbit)
    otter = otter.fillna(dog)
    fox = cat + otter
    koala = fox / bear
    koala = koala.reindex(rabbit)
    koala.name = 'factor135'
    return koala

def factor136(universe, date, N=20):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, int(N) + 1)
    if len(koala) < int(N) + 1:
        wolf = {tiger: np.nan for tiger in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor136')
    giraffe = list(universe)
    rabbit = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(lion).strftime('%Y-%m-%d')
    otter = get_price(giraffe, start_date=rabbit, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        wolf = {tiger: np.nan for tiger in giraffe}
        return _make_factor_series(wolf, date, universe=universe, name='factor136')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    if 'code' not in otter.columns:
        wolf = {tiger: np.nan for tiger in giraffe}
        return _make_factor_series(wolf, date, universe=universe, name='factor136')
    otter['time'] = pd.to_datetime(otter['time'])
    panda = otter.pivot(index='time', columns='code', values='close').sort_index()
    panda = panda.reindex(columns=giraffe)
    if panda.shape[0] < int(N) + 1:
        wolf = {tiger: np.nan for tiger in giraffe}
        return _make_factor_series(wolf, date, universe=universe, name='factor136')
    cat = panda.iloc[-1]
    dog = panda.iloc[-(int(N) + 1)]
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = cat / dog - 1.0
    bear = bear.replace([np.inf, -np.inf], np.nan)
    wolf = {tiger: float(bear.get(tiger, np.nan)) if np.isfinite(bear.get(tiger, np.nan)) else np.nan for tiger in giraffe}
    return _make_factor_series(wolf, date, universe=universe, name='factor136')

def factor137(universe, date):
    _set_asof_date(date)
    lion = query(fox.code, fox.term_025, fox.term_081).filter(fox.code.in_(universe))
    dog = get_fundamentals(lion, date=date)
    if dog is None or dog.empty:
        tiger = {cat: np.nan for cat in universe}
        return _make_factor_series(tiger, date, universe=universe, name='factor137')
    dog = dog.set_index('code')
    tiger = {}
    for cat in universe:
        panda = dog['term_025'].get(cat, np.nan)
        koala = dog['term_081'].get(cat, np.nan)
        if not np.isfinite(panda) or not np.isfinite(koala) or koala == 0:
            otter = np.nan
        else:
            otter = panda / koala
        tiger[cat] = float(otter) if np.isfinite(otter) else np.nan
    return _make_factor_series(tiger, date, universe=universe, name='factor137')

def factor138(universe, date):
    _set_asof_date(date)
    lion = get_factor_values(universe, factors=['term_091'], end_date=date, count=1)
    panda = lion.get('term_091', None)
    if panda is None or panda.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor138')
    bear = panda.iloc[-1]
    dog = (pd.to_datetime(date) - DateOffset(years=3)).strftime('%Y-%m-%d')
    koala = get_factor_values(universe, factors=['term_091'], end_date=dog, count=1)
    tiger = koala.get('term_091', None)
    if tiger is None or tiger.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor138')
    rabbit = tiger.iloc[-1]
    otter = {}
    for cat in universe:
        wolf = bear.get(cat, np.nan)
        fox = rabbit.get(cat, np.nan)
        if not np.isfinite(wolf) or not np.isfinite(fox) or fox == 0:
            zebra = np.nan
        else:
            giraffe = (wolf - fox) / abs(fox) + 1.0
            if not np.isfinite(giraffe) or giraffe <= 0:
                zebra = np.nan
            else:
                zebra = giraffe ** (1.0 / 3.0) - 1.0
        otter[cat] = float(zebra) if np.isfinite(zebra) else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor138')

def factor139(universe, date, N=20):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = _last_n_trade_days(bear, int(N) + 1)
    if len(rabbit) < int(N) + 1:
        whale = {wolf: np.nan for wolf in universe}
        return _make_factor_series(whale, date, universe=universe, name='factor139')
    sparrow = list(universe)
    hawk = pd.to_datetime(rabbit[0]).strftime('%Y-%m-%d')
    dolphin = pd.to_datetime(bear).strftime('%Y-%m-%d')
    giraffe = get_price(sparrow, start_date=hawk, end_date=dolphin, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if giraffe is None or giraffe.empty:
        whale = {wolf: np.nan for wolf in sparrow}
        return _make_factor_series(whale, date, universe=universe, name='factor139')
    giraffe = giraffe.copy()
    if 'time' not in giraffe.columns:
        giraffe = giraffe.reset_index()
    if 'code' not in giraffe.columns:
        whale = {wolf: np.nan for wolf in sparrow}
        return _make_factor_series(whale, date, universe=universe, name='factor139')
    giraffe['time'] = pd.to_datetime(giraffe['time'])
    shark = giraffe.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=sparrow).astype(float)
    eagle = giraffe.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=sparrow).astype(float)
    fox = giraffe.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=sparrow).astype(float)
    shark = shark.tail(int(N) + 1)
    eagle = eagle.reindex(index=shark.index).tail(int(N) + 1)
    fox = fox.reindex(index=shark.index).tail(int(N) + 1)
    if fox.shape[0] < int(N) + 1:
        whale = {wolf: np.nan for wolf in sparrow}
        return _make_factor_series(whale, date, universe=universe, name='factor139')
    lion = shark.tail(int(N))
    otter = eagle.tail(int(N))
    panda = fox.tail(int(N) + 1)
    tiger = lion.max(axis=0, skipna=True)
    koala = otter.min(axis=0, skipna=True)
    cat = (tiger - koala).abs()
    zebra = panda.diff().abs().tail(int(N))
    dog = zebra.sum(axis=0, skipna=True)
    with np.errstate(divide='ignore', invalid='ignore'):
        owl = cat / dog
    owl = owl.where(np.isfinite(dog) & (dog > 0), 0.0)
    owl = owl.replace([np.inf, -np.inf], np.nan)
    whale = {wolf: float(owl.get(wolf, np.nan)) if np.isfinite(owl.get(wolf, np.nan)) else np.nan for wolf in sparrow}
    return _make_factor_series(whale, date, universe=universe, name='factor139')

def factor140(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor140')

def factor141(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    panda = _r3_safe_date(date)
    koala = _r3_fundamentals(bear, [bear.term_063], dog, date=panda)
    lion = _r3_fundamentals(fox, [fox.total_owner_equities], dog, date=panda)
    tiger = _r3_join_code(dog, koala, lion)
    fox = pd.to_numeric(tiger.get('term_063', np.nan), errors='coerce')
    otter = pd.to_numeric(tiger.get('total_owner_equities', np.nan), errors='coerce')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = fox / otter
    wolf = wolf.where(np.isfinite(wolf) & (otter != 0), np.nan)
    return _make_factor_series({cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in dog}, date, universe=universe, name='factor141')

def factor142(universe, date, N=14, N1=None):
    _set_asof_date(date)
    if N1 is None:
        N1 = N
    panda = _to_date(date)
    giraffe = int(N) + int(N1) + 5
    tiger = _last_n_trade_days(panda, giraffe)
    if len(tiger) < int(N) + int(N1):
        otter = {dog: np.nan for dog in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor142')
    bear = list(universe)
    wolf = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    koala = pd.to_datetime(panda).strftime('%Y-%m-%d')
    lion = get_price(bear, start_date=wolf, end_date=koala, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        otter = {dog: np.nan for dog in bear}
        return _make_factor_series(otter, date, universe=universe, name='factor142')
    lion = lion.copy()
    if 'time' not in lion.columns:
        lion = lion.reset_index()
    if 'code' not in lion.columns:
        otter = {dog: np.nan for dog in bear}
        return _make_factor_series(otter, date, universe=universe, name='factor142')
    lion['time'] = pd.to_datetime(lion['time'])
    cat = lion.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=bear).astype(float)
    cat = cat.tail(giraffe)
    if cat.shape[0] < int(N) + int(N1):
        otter = {dog: np.nan for dog in bear}
        return _make_factor_series(otter, date, universe=universe, name='factor142')

    def _rsi_wilder_last_srsi(close_arr, n, n1):
        close_arr = np.asarray(close_arr, dtype=float)
        close_arr = close_arr[np.isfinite(close_arr)]
        if close_arr.size < n + n1:
            return np.nan
        wolf = np.diff(close_arr)
        if wolf.size < n:
            return np.nan
        tiger = np.where(wolf > 0, wolf, 0.0)
        koala = np.where(wolf < 0, -wolf, 0.0)
        dog = tiger[:n].mean()
        panda = koala[:n].mean()
        rabbit = []
        if panda == 0:
            rabbit.append(100.0)
        else:
            cat = dog / panda
            rabbit.append(100.0 - 100.0 / (1.0 + cat))
        for lion in range(n, wolf.size):
            dog = (dog * (n - 1) + tiger[lion]) / n
            panda = (panda * (n - 1) + koala[lion]) / n
            if panda == 0:
                rabbit.append(100.0)
            else:
                cat = dog / panda
                rabbit.append(100.0 - 100.0 / (1.0 + cat))
        bear = np.asarray(rabbit, dtype=float)
        if bear.size < n1:
            return np.nan
        zebra = bear[-n1:]
        otter = float(np.max(zebra))
        fox = float(np.min(zebra))
        giraffe = float(zebra[-1])
        if not np.isfinite(otter) or not np.isfinite(fox) or otter == fox:
            return 0.0
        return (giraffe - otter) / (otter - fox) * 100.0
    otter = {}
    for dog in bear:
        fox = cat[dog].values.astype(float)
        rabbit = _rsi_wilder_last_srsi(fox, int(N), int(N1))
        otter[dog] = float(rabbit) if np.isfinite(rabbit) else 0.0 if rabbit == 0.0 else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor142')

def factor143(universe, date, M=250, mkt_index=None):
    _set_asof_date(date)
    M = max(int(M), 50)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, M + 1)
    if len(koala) < 2:
        wolf = {tiger: np.nan for tiger in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor143')
    sparrow = list(universe)
    shark = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(lion).strftime('%Y-%m-%d')
    otter = get_price(sparrow, start_date=shark, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        wolf = {tiger: np.nan for tiger in sparrow}
        return _make_factor_series(wolf, date, universe=universe, name='factor143')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    if 'code' not in otter.columns:
        wolf = {tiger: np.nan for tiger in sparrow}
        return _make_factor_series(wolf, date, universe=universe, name='factor143')
    otter['time'] = pd.to_datetime(otter['time'])
    panda = otter.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=sparrow).astype(float)
    panda = panda.tail(M + 1)
    wolf = {}
    for tiger in sparrow:
        dog = panda[tiger].values.astype(float)
        dog = dog[np.isfinite(dog) & (dog > 0)]
        if dog.size < 21:
            wolf[tiger] = np.nan
            continue
        dolphin = np.diff(np.log(dog))
        if dolphin.size < 20:
            wolf[tiger] = np.nan
            continue
        zebra = float(np.mean(dolphin))
        whale = float(np.std(dolphin, ddof=1))
        if not np.isfinite(whale) or whale == 0:
            wolf[tiger] = np.nan
            continue
        eagle = dolphin[dolphin < zebra]
        if eagle.size < 10:
            wolf[tiger] = np.nan
            continue
        turtle = (zebra - eagle) / whale
        turtle = turtle[np.isfinite(turtle) & (turtle > 0)]
        if turtle.size < 10:
            wolf[tiger] = np.nan
            continue
        salmon = np.sort(turtle)[::-1]
        rabbit = max(int(salmon.size * 0.2), 5)
        rabbit = min(rabbit, salmon.size)
        lizard = salmon[:rabbit]
        frog = float(lizard[-1])
        if not np.isfinite(frog) or frog <= 0:
            wolf[tiger] = np.nan
            continue
        with np.errstate(divide='ignore', invalid='ignore'):
            giraffe = np.log(lizard / frog)
        giraffe = giraffe[np.isfinite(giraffe)]
        if giraffe.size == 0:
            wolf[tiger] = np.nan
            continue
        bear = float(np.mean(giraffe))
        if not np.isfinite(bear) or bear <= 0:
            wolf[tiger] = np.nan
            continue
        owl = zebra - 2.0 * whale
        hawk = 1.0 - bear * (owl - zebra) / whale
        if not np.isfinite(hawk) or hawk <= 0:
            wolf[tiger] = np.nan
            continue
        cat = 1.0 - float(np.exp(-hawk ** (-1.0 / bear)))
        wolf[tiger] = float(cat) if np.isfinite(cat) else np.nan
    return _make_factor_series(wolf, date, universe=universe, name='factor143')

def factor144(universe, date, T_quarters=6):
    _set_asof_date(date)
    dog = T_quarters + 1
    tiger = get_factor_values(universe, factors=['term_068'], end_date=date, count=dog)
    koala = tiger.get('term_068', None)
    if koala is None or koala.empty:
        lion = {cat: np.nan for cat in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor144')
    panda = koala.iloc[-1]
    fox = koala.iloc[:-1]
    lion = {}
    for cat in universe:
        wolf = panda.get(cat, np.nan)
        rabbit = fox[cat].dropna()
        if not np.isfinite(wolf) or rabbit.empty:
            giraffe = np.nan
        else:
            otter = rabbit.mean()
            bear = rabbit.std(ddof=1)
            if not np.isfinite(bear) or bear == 0:
                giraffe = 0.0
            else:
                giraffe = (wolf - otter) / bear
        lion[cat] = float(giraffe) if np.isfinite(giraffe) else np.nan
    return _make_factor_series(lion, date, universe=universe, name='factor144')

def factor145(universe, date, months=6):
    _set_asof_date(date)
    tiger = _to_date(date)
    months = int(months)
    if months <= 1:
        return _make_factor_series({cat: np.nan for cat in universe}, date, universe=universe, name='factor145')
    fox = pd.Timestamp(tiger).to_period('M') - 1
    whale = fox - (months + 2)
    dolphin = whale.start_time.date()
    koala = fox.end_time.date()
    panda = list(universe)
    lion = get_price(panda, start_date=dolphin, end_date=koala, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor145')
    lion = lion.copy()
    if 'time' not in lion.columns:
        lion = lion.reset_index().rename(columns={'index': 'time'})
    if 'code' not in lion.columns:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor145')
    lion['time'] = pd.to_datetime(lion['time'], errors='coerce')
    lion = lion.dropna(subset=['time'])
    lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
    lion = lion.dropna(subset=['close'])
    if lion.empty:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor145')
    lion['month'] = lion['time'].dt.to_period('M')
    lion = lion[lion['month'] <= fox]
    if lion.empty:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor145')
    wolf = lion.sort_values(['code', 'time']).groupby(['month', 'code'], sort=False)['close'].last().unstack('code').reindex(columns=panda)
    otter = {}
    bear = months + 1
    for dog in panda:
        zebra = wolf[dog].dropna()
        if zebra.size < bear:
            otter[dog] = np.nan
            continue
        giraffe = zebra.pct_change().dropna()
        if giraffe.size < months:
            otter[dog] = np.nan
            continue
        rabbit = giraffe.iloc[-months:]
        shark = float(np.prod(1.0 + rabbit.values) - 1.0)
        otter[dog] = shark if np.isfinite(shark) else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor145')

def factor146(universe, date):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    dog = list(universe)
    if len(dog) == 0:
        return _make_factor_series({}, panda, universe=universe, name='factor146')
    tiger = get_history_fundamentals(security=dog, fields=[bear.term_063], watch_date=panda, count=16, interval='1q', stat_by_year=False)
    if tiger is None or tiger.empty:
        return _make_factor_series({cat: np.nan for cat in dog}, panda, universe=universe, name='factor146')
    tiger = tiger.copy()
    tiger['statDate'] = pd.to_datetime(tiger['statDate'])
    tiger = tiger.sort_values(['code', 'statDate']).dropna(subset=['term_063'])

    def _calc(sub):
        sub = sub.sort_values('statDate').drop_duplicates('statDate', keep='last')
        panda = pd.to_numeric(sub['term_063'], errors='coerce').astype(float).values
        panda = panda[np.isfinite(panda)]
        if panda.size < 16:
            return np.nan
        dog = float(np.nansum(panda[-4:]))
        cat = float(np.nansum(panda[:4]))
        if not np.isfinite(dog) or not np.isfinite(cat) or cat == 0:
            return np.nan
        lion = (dog - cat) / abs(cat) + 1.0
        if not np.isfinite(lion) or lion <= 0:
            return np.nan
        tiger = lion ** (1.0 / 3.0) - 1.0
        return float(tiger) if np.isfinite(tiger) else np.nan
    koala = tiger.groupby('code', sort=False).apply(_calc).reindex(dog)
    lion = {cat: float(koala.get(cat, np.nan)) if np.isfinite(koala.get(cat, np.nan)) else np.nan for cat in dog}
    return _make_factor_series(lion, panda, universe=universe, name='factor146')

def factor147(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor147')

def factor148(universe, date, N=5, N1=10, N2=20):
    _set_asof_date(date)
    lion = _to_date(date)
    owl = max(int(N1) + int(N2) + int(N), 50)
    koala = _last_n_trade_days(lion, owl)
    if len(koala) < int(N1) + int(N2):
        wolf = {tiger: np.nan for tiger in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor148')
    hawk = list(universe)
    eagle = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(lion).strftime('%Y-%m-%d')
    otter = get_price(hawk, start_date=eagle, end_date=fox, frequency='daily', fields=['high', 'low'], fq='post', panel=False)
    if otter is None or otter.empty:
        wolf = {tiger: np.nan for tiger in hawk}
        return _make_factor_series(wolf, date, universe=universe, name='factor148')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    if 'code' not in otter.columns:
        wolf = {tiger: np.nan for tiger in hawk}
        return _make_factor_series(wolf, date, universe=universe, name='factor148')
    otter['time'] = pd.to_datetime(otter['time'])
    rabbit = otter.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=hawk).astype(float)
    dolphin = otter.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=hawk).astype(float)
    rabbit = rabbit.tail(owl)
    dolphin = dolphin.reindex(index=rabbit.index).tail(owl)
    panda = int(N)
    cat = int(N1)
    dog = int(N2)
    giraffe = max(panda, 1)

    def _compute_rs(P):
        P = np.asarray(P, dtype=float)
        P = P[np.isfinite(P)]
        panda = P.size
        if panda < N1_i + N_i:
            return np.nan
        lion = np.zeros(panda, dtype=float)
        dog = np.zeros(panda, dtype=float)
        for fox in range(1, panda):
            if fox < N1_i:
                continue
            wolf = P[fox - N1_i + 1:fox + 1]
            otter = float(np.std(wolf, ddof=1)) if wolf.size > 1 else 0.0
            if P[fox] > P[fox - 1]:
                lion[fox] = otter
            elif P[fox] < P[fox - 1]:
                dog[fox] = otter
        tiger = np.zeros(panda, dtype=float)
        cat = np.zeros(panda, dtype=float)
        tiger[:init_end] = float(np.mean(lion[:init_end])) if init_end > 0 else 0.0
        cat[:init_end] = float(np.mean(dog[:init_end])) if init_end > 0 else 0.0
        for fox in range(init_end, panda):
            tiger[fox] = (tiger[fox - 1] * (N2_i - 1) + lion[fox]) / N2_i
            cat[fox] = (cat[fox - 1] * (N2_i - 1) + dog[fox]) / N2_i
        koala = tiger[-1] + cat[-1]
        if koala == 0 or not np.isfinite(koala):
            return 0.0
        return float(100.0 * tiger[-1] / koala)
    wolf = {}
    for tiger in hawk:
        bear = rabbit[tiger].values.astype(float)
        zebra = dolphin[tiger].values.astype(float)
        whale = _compute_rs(bear)
        shark = _compute_rs(zebra)
        if not np.isfinite(whale) or not np.isfinite(shark):
            sparrow = np.nan
        else:
            sparrow = 0.5 * (whale + shark)
        wolf[tiger] = float(sparrow) if np.isfinite(sparrow) else np.nan
    return _make_factor_series(wolf, date, universe=universe, name='factor148')

def factor149(universe, date):
    _set_asof_date(date)
    rabbit = _to_date(date)
    tiger = pd.Timestamp(rabbit)
    fox = list(universe)
    turtle = pd.Period(tiger, freq='Q-DEC') - 1
    lizard = turtle - 1
    owl = pd.PeriodIndex([turtle, turtle - 1, turtle - 2, turtle - 3], freq='Q-DEC')
    sparrow = pd.PeriodIndex([turtle, lizard], freq='Q-DEC')
    dolphin = get_history_fundamentals(security=fox, fields=[bear.term_060], watch_date=tiger, count=16, interval='1q', stat_by_year=False)
    zebra = get_history_fundamentals(security=fox, fields=[fox.term_002], watch_date=tiger, count=16, interval='1q', stat_by_year=False)
    if (dolphin is None or dolphin.empty) or (zebra is None or zebra.empty):
        return _make_factor_series({otter: np.nan for otter in fox}, rabbit, universe=universe, name='factor149')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    shark = _prep(dolphin)
    koala = _prep(zebra)
    if shark is None or koala is None:
        return _make_factor_series({otter: np.nan for otter in fox}, rabbit, universe=universe, name='factor149')
    wolf = shark.pivot(index='q', columns='code', values='term_060').sort_index().reindex(columns=fox)
    wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=owl)
    bear = wolf.sum(axis=0, min_count=2)
    cat = koala.pivot(index='q', columns='code', values='term_002').sort_index().reindex(columns=fox)
    cat = cat.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=sparrow)
    dog = cat.loc[turtle]
    panda = cat.loc[lizard]
    lion = (dog + panda) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = 360.0 * lion / bear
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    eagle = np.isfinite(bear.values) & (bear.values > 0) & np.isfinite(lion.values) & (lion.values > 0)
    hawk = pd.Series(np.nan, index=fox, dtype='float64')
    hawk.loc[eagle] = giraffe.loc[eagle]
    whale = {otter: float(hawk.get(otter, np.nan)) if np.isfinite(hawk.get(otter, np.nan)) else np.nan for otter in fox}
    return _make_factor_series(whale, rabbit, universe=universe, name='factor149')

def factor150(universe, date, N=20, batch_size=200):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = _last_n_trade_days(bear, N)
    if len(rabbit) == 0:
        shark = {lion: np.nan for lion in universe}
        return _make_factor_series(shark, date, universe=universe, name='factor150')
    frog = list(universe)
    giraffe = [pd.to_datetime(wolf).date() for wolf in rabbit]
    turtle = pd.to_datetime(rabbit[0]).strftime('%Y-%m-%d')
    whale = pd.to_datetime(rabbit[-1]).strftime('%Y-%m-%d')
    dolphin = (pd.to_datetime(whale) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    fox = []
    for eagle in range(0, len(frog), max(1, int(batch_size))):
        panda = frog[eagle:eagle + max(1, int(batch_size))]
        hawk = get_price(panda, start_date=turtle, end_date=dolphin, frequency='1m', fields=['close', 'volume'], fq='post', panel=False)
        if hawk is None or hawk.empty:
            continue
        hawk = hawk.copy()
        if 'time' not in hawk.columns:
            hawk['time'] = hawk.index
        hawk['time'] = pd.to_datetime(hawk['time'])
        if 'code' not in hawk.columns:
            if len(panda) == 1:
                hawk['code'] = panda[0]
            else:
                continue
        hawk['date'] = hawk['time'].dt.date
        hawk = hawk[hawk['date'].isin(giraffe)]
        if hawk.empty:
            continue
        hawk = hawk[['code', 'date', 'close', 'volume']].dropna(subset=['close', 'volume'])
        if hawk.empty:
            continue
        hawk['close'] = hawk['close'].astype(float)
        hawk['volume'] = hawk['volume'].astype(float)
        hawk = hawk[np.isfinite(hawk['close'].values) & np.isfinite(hawk['volume'].values)]
        if hawk.empty:
            continue
        hawk['xy'] = hawk['close'] * hawk['volume']
        hawk['x2'] = hawk['close'] * hawk['close']
        hawk['y2'] = hawk['volume'] * hawk['volume']
        cat = hawk.groupby(['code', 'date'], sort=False).agg(n=('close', 'count'), mx=('close', 'mean'), my=('volume', 'mean'), mxy=('xy', 'mean'), mx2=('x2', 'mean'), my2=('y2', 'mean'))
        sparrow = cat['mxy'] - cat['mx'] * cat['my']
        salmon = cat['mx2'] - cat['mx'] * cat['mx']
        tuna = cat['my2'] - cat['my'] * cat['my']
        zebra = np.sqrt(salmon * tuna)
        koala = sparrow / zebra
        koala[(cat['n'] < 3) | ~np.isfinite(koala) | ~np.isfinite(zebra) | (zebra <= 0)] = np.nan
        fox.append(koala.rename('corr').reset_index())
    if len(fox) == 0:
        shark = {lion: np.nan for lion in frog}
        return _make_factor_series(shark, date, universe=universe, name='factor150')
    otter = pd.concat(fox, ignore_index=True).dropna(subset=['corr'])
    if otter.empty:
        shark = {lion: np.nan for lion in frog}
        return _make_factor_series(shark, date, universe=universe, name='factor150')
    dog = otter.groupby('code', sort=False)['corr'].mean().reindex(frog)
    tiger = otter.groupby('code', sort=False)['corr'].count().reindex(frog)
    lizard = otter.groupby('code', sort=False)['corr'].std(ddof=1).reindex(frog)
    lizard = lizard.where(tiger >= 2, 0.0)
    dog = dog.astype(float)
    lizard = lizard.astype(float)
    alpaca = _zscore_series(dog)
    lemur = _zscore_series(lizard)
    owl = alpaca + lemur
    shark = {lion: float(owl.get(lion, np.nan)) if np.isfinite(owl.get(lion, np.nan)) else np.nan for lion in frog}
    return _make_factor_series(shark, date, universe=universe, name='factor150')

def factor151(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    cat = pd.Timestamp(wolf)
    otter = list(universe)

    def _nearest_td_le(d):
        cat = get_trade_days(end_date=d, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    salmon = _nearest_td_le(wolf)
    alpaca = _nearest_td_le((pd.Timestamp(wolf) - DateOffset(years=1)).date())
    if salmon is None or alpaca is None:
        return _make_factor_series({tiger: np.nan for tiger in otter}, wolf, universe=universe, name='factor151')
    tuna = pd.Timestamp(salmon).strftime('%Y-%m-%d')
    lemur = pd.Timestamp(alpaca).strftime('%Y-%m-%d')
    eagle = pd.Series(np.nan, index=otter, dtype='float64')
    try:
        dolphin = get_factor_values(otter, factors=['np_parent_company_owners_ttm'], end_date=tuna, count=1)
        zebra = dolphin.get('np_parent_company_owners_ttm', None)
        if isinstance(zebra, pd.DataFrame) and (not zebra.empty):
            eagle = pd.to_numeric(zebra.iloc[-1].reindex(otter), errors='coerce').astype(float)
    except Exception:
        pass
    if eagle.notna().sum() < 10:
        giraffe = get_history_fundamentals(security=otter, fields=[bear.np_parent_company_owners], watch_date=cat, count=16, interval='1q', stat_by_year=False)
        if giraffe is not None and (not giraffe.empty) and ('code' in giraffe.columns) and ('statDate' in giraffe.columns):
            fox = giraffe.copy()
            if 'pubDate' in fox.columns:
                sparrow = pd.to_datetime(fox['pubDate'], errors='coerce')
                fox = fox[sparrow.notna() & (sparrow <= cat)]
            fox['code'] = fox['code'].astype(str)
            fox['statDate'] = pd.to_datetime(fox['statDate'], errors='coerce')
            fox = fox.dropna(subset=['code', 'statDate'])
            if not fox.empty and 'np_parent_company_owners' in fox.columns:
                fox['q'] = fox['statDate'].dt.to_period('Q-DEC')
                lizard = pd.Period(cat, freq='Q-DEC') - 1
                turtle = pd.PeriodIndex([lizard, lizard - 1, lizard - 2, lizard - 3], freq='Q-DEC')
                fox = fox[fox['q'].isin(turtle)]
                fox = fox.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
                owl = fox.pivot(index='q', columns='code', values='np_parent_company_owners').reindex(index=turtle, columns=otter)
                owl = owl.apply(pd.to_numeric, errors='coerce').astype(float)
                shark = owl.sum(axis=0, min_count=2)
                eagle = eagle.where(eagle.notna(), shark)
    frog = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(otter))
    rabbit = get_fundamentals(frog, date=tuna)
    if rabbit is None or rabbit.empty or 'code' not in rabbit.columns:
        koala = pd.Series(np.nan, index=otter, dtype='float64')
    else:
        rabbit = rabbit.copy()
        rabbit['code'] = rabbit['code'].astype(str)
        koala = pd.to_numeric(rabbit.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(otter)
    bear = get_fundamentals(frog, date=lemur)
    if bear is None or bear.empty or 'code' not in bear.columns:
        lion = pd.Series(np.nan, index=otter, dtype='float64')
    else:
        bear = bear.copy()
        bear['code'] = bear['code'].astype(str)
        lion = pd.to_numeric(bear.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(otter)
    dog = (lion + koala) / 2.0
    panda = (dog * 10000.0).replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = eagle / panda
    hawk = hawk.replace([np.inf, -np.inf], np.nan)
    hawk = hawk.where(np.isfinite(panda) & (panda > 0) & np.isfinite(eagle), np.nan)
    whale = {tiger: float(hawk.get(tiger, np.nan)) if np.isfinite(hawk.get(tiger, np.nan)) else np.nan for tiger in otter}
    return _make_factor_series(whale, wolf, universe=universe, name='factor151')

def factor152(universe, date, N=20):
    _set_asof_date(date)
    otter = pd.to_datetime(date)
    koala = otter.date()
    fox = get_trade_days(end_date=koala, count=int(N) + 1)
    if len(fox) < int(N) + 1:
        giraffe = {tiger: np.nan for tiger in universe}
        return _make_factor_series(giraffe, date, universe=universe, name='factor152')
    alpaca = pd.to_datetime(fox).normalize()
    salmon = alpaca[0].strftime('%Y-%m-%d')
    rabbit = alpaca[-1].strftime('%Y-%m-%d')
    dolphin = get_industry(security=universe, date=koala, df=True)
    if dolphin is None or dolphin.empty:
        giraffe = {tiger: np.nan for tiger in universe}
        return _make_factor_series(giraffe, date, universe=universe, name='factor152')
    dolphin = dolphin.copy()
    if 'type' in dolphin.columns:
        bear = dolphin[dolphin['type'].astype(str) == 'sw_l1']
        if bear.empty:
            bear = dolphin
    else:
        bear = dolphin
    if 'code' not in bear.columns or 'industry_code' not in bear.columns:
        giraffe = {tiger: np.nan for tiger in universe}
        return _make_factor_series(giraffe, date, universe=universe, name='factor152')
    tuna = bear.dropna(subset=['code', 'industry_code']).set_index('code')['industry_code'].astype(str).to_dict()
    whale = {}
    for tiger in universe:
        zebra = tuna.get(tiger)
        if zebra is None:
            continue
        whale.setdefault(zebra, []).append(tiger)
    shark = {}
    for zebra, lion in whale.items():
        try:
            wolf = get_price(lion, start_date=salmon, end_date=rabbit, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
        except Exception:
            continue
        if wolf is None or wolf.empty:
            continue
        wolf = wolf.copy()
        wolf = _fa__ensure_time_code(wolf)
        if wolf is None or wolf.empty or 'time' not in wolf.columns:
            continue
        if 'code' not in wolf.columns:
            if len(lion) == 1:
                wolf['code'] = lion[0]
            else:
                continue
        wolf['time'] = pd.to_datetime(wolf['time']).dt.normalize()
        turtle = wolf.pivot(index='time', columns='code', values='open')
        dog = wolf.pivot(index='time', columns='code', values='close')
        turtle = turtle.reindex(index=alpaca)
        dog = dog.reindex(index=alpaca)
        owl = turtle.mean(axis=1, skipna=True).values
        cat = dog.mean(axis=1, skipna=True).values
        hawk = np.isfinite(owl) & np.isfinite(cat)
        if hawk.sum() < max(3, int(N) // 2):
            continue
        with np.errstate(divide='ignore', invalid='ignore'):
            lizard = cat / owl - 1.0
        panda = np.roll(cat, 1)
        panda[0] = np.nan
        with np.errstate(divide='ignore', invalid='ignore'):
            frog = owl / panda - 1.0
        lizard = lizard[1:]
        frog = frog[1:]
        eagle = np.isfinite(lizard) & np.isfinite(frog)
        if eagle.sum() < max(3, int(N) // 2):
            continue
        sparrow = float(np.nansum(lizard[eagle]) - np.nansum(frog[eagle]))
        if np.isfinite(sparrow):
            shark[zebra] = sparrow
    giraffe = {}
    for tiger in universe:
        zebra = tuna.get(tiger)
        lemur = shark.get(zebra, np.nan)
        giraffe[tiger] = float(lemur) if np.isfinite(lemur) else np.nan
    return _make_factor_series(giraffe, date, universe=universe, name='factor152')

def factor153(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    panda = pd.Timestamp(fox)
    koala = list(universe)
    owl = pd.Period(panda, freq='Q-DEC') - 1
    turtle = owl - 1
    lizard = pd.PeriodIndex([owl, owl - 1, owl - 2, owl - 3], freq='Q-DEC')
    sparrow = pd.PeriodIndex([turtle, owl], freq='Q-DEC')
    tuna = pd.Series(np.nan, index=koala, dtype='float64')
    try:
        zebra = get_factor_values(koala, factors=['term_068'], end_date=panda, count=1)
        rabbit = zebra.get('term_068', None) if isinstance(zebra, dict) else None
        if isinstance(rabbit, pd.DataFrame) and (not rabbit.empty):
            alpaca = rabbit.iloc[-1]
            alpaca.index = alpaca.index.astype(str)
            alpaca = pd.to_numeric(alpaca, errors='coerce').astype(float)
            tuna = alpaca.reindex(koala)
    except Exception:
        pass
    if tuna.notna().sum() < 10:
        giraffe = get_history_fundamentals(security=koala, fields=[bear.term_066], watch_date=panda, count=12, interval='1q', stat_by_year=False)
        if giraffe is None or giraffe.empty:
            return _make_factor_series({lion: np.nan for lion in koala}, fox, universe=universe, name='factor153')
        otter = giraffe.copy()
        if 'pubDate' in otter.columns:
            eagle = pd.to_datetime(otter['pubDate'], errors='coerce')
            otter = otter[eagle.notna() & (eagle <= panda)]
        otter['code'] = otter['code'].astype(str)
        otter['statDate'] = pd.to_datetime(otter['statDate'], errors='coerce')
        otter = otter.dropna(subset=['code', 'statDate'])
        if otter.empty or 'term_066' not in otter.columns:
            return _make_factor_series({lion: np.nan for lion in koala}, fox, universe=universe, name='factor153')
        otter['q'] = otter['statDate'].dt.to_period('Q-DEC')
        otter = otter[otter['q'].isin(lizard)]
        if otter.empty:
            return _make_factor_series({lion: np.nan for lion in koala}, fox, universe=universe, name='factor153')
        otter = otter.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        hawk = otter.pivot(index='q', columns='code', values='term_066').reindex(index=lizard, columns=koala)
        hawk = hawk.apply(pd.to_numeric, errors='coerce').astype(float)
        tuna = hawk.sum(axis=0, min_count=2).reindex(koala)
    bear = get_history_fundamentals(security=koala, fields=[fox.term_001, fox.term_005], watch_date=panda, count=8, interval='1q', stat_by_year=False)
    if bear is None or bear.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, fox, universe=universe, name='factor153')
    cat = bear.copy()
    if 'pubDate' in cat.columns:
        eagle = pd.to_datetime(cat['pubDate'], errors='coerce')
        cat = cat[eagle.notna() & (eagle <= panda)]
    cat['code'] = cat['code'].astype(str)
    cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
    cat = cat.dropna(subset=['code', 'statDate'])
    if cat.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, fox, universe=universe, name='factor153')
    cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
    cat = cat[cat['q'].isin(sparrow)]
    if cat.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, fox, universe=universe, name='factor153')
    cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    dog = cat.pivot(index='q', columns='code', values='term_001').reindex(index=sparrow, columns=koala)
    shark = cat.pivot(index='q', columns='code', values='term_005').reindex(index=sparrow, columns=koala)
    dog = dog.apply(pd.to_numeric, errors='coerce').astype(float)
    shark = shark.apply(pd.to_numeric, errors='coerce').astype(float)
    frog = (dog.loc[owl] if owl in dog.index else pd.Series(np.nan, index=koala)) + (shark.loc[owl] if owl in shark.index else pd.Series(np.nan, index=koala))
    salmon = (dog.loc[turtle] if turtle in dog.index else pd.Series(np.nan, index=koala)) + (shark.loc[turtle] if turtle in shark.index else pd.Series(np.nan, index=koala))
    tiger = pd.concat([frog, salmon], axis=1).mean(axis=1, skipna=True).reindex(koala)
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = 360.0 * tiger / tuna
    whale = ~np.isfinite(wolf) | ~np.isfinite(tiger) | ~np.isfinite(tuna) | (tiger <= 0) | (tuna <= 0)
    wolf = wolf.where(~whale, np.nan).reindex(koala)
    dolphin = {lion: float(wolf.get(lion)) if np.isfinite(wolf.get(lion, np.nan)) else np.nan for lion in koala}
    return _make_factor_series(dolphin, fox, universe=universe, name='factor153')

def factor154(universe, date):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    otter = list(universe)
    tiger = get_history_fundamentals(security=otter, fields=[bear.term_066, bear.term_060], watch_date=panda, count=16, interval='1q', stat_by_year=False)
    if tiger is None or tiger.empty:
        lion = {dog: np.nan for dog in otter}
        return _make_factor_series(lion, panda, universe=universe, name='factor154')
    tiger = tiger.copy()
    tiger['statDate'] = pd.to_datetime(tiger['statDate'])
    tiger = tiger.sort_values(['code', 'statDate'])

    def _calc(sub):
        bear = sub['term_066'].astype(float).values
        lion = sub['term_060'].astype(float).values
        if bear.size < 16 or lion.size < 16:
            return np.nan
        tiger = float(np.nansum(bear[-4:]))
        dog = float(np.nansum(lion[-4:]))
        if not np.isfinite(tiger) or tiger == 0:
            return np.nan
        otter = (tiger - dog) / tiger
        panda = float(np.nansum(bear[:4]))
        cat = float(np.nansum(lion[:4]))
        if not np.isfinite(panda) or panda == 0:
            return np.nan
        koala = (panda - cat) / panda
        if not np.isfinite(otter) or not np.isfinite(koala) or koala == 0:
            return np.nan
        wolf = (otter - koala) / abs(koala) + 1.0
        if not np.isfinite(wolf) or wolf <= 0:
            return np.nan
        fox = wolf ** (1.0 / 3.0) - 1.0
        return float(fox) if np.isfinite(fox) else np.nan
    koala = tiger.groupby('code', sort=False).apply(_calc)
    koala = koala.reindex(otter)
    lion = {cat: float(koala.loc[cat]) if np.isfinite(koala.loc[cat]) else np.nan for cat in otter}
    return _make_factor_series(lion, panda, universe=universe, name='factor154')

def factor155(universe, date):
    _set_asof_date(date)
    koala = query(fox.code, fox.term_081, fox.term_082, fox.total_owner_equities).filter(fox.code.in_(universe))
    panda = get_fundamentals(koala, date=date)
    if panda is None or panda.empty:
        lion = {dog: np.nan for dog in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor155')
    panda = panda.set_index('code')
    lion = {}
    for dog in universe:
        otter = panda['term_081'].get(dog, np.nan)
        cat = panda['term_082'].get(dog, np.nan)
        tiger = panda['total_owner_equities'].get(dog, np.nan)
        if not np.isfinite(otter) or not np.isfinite(cat) or (not np.isfinite(tiger)) or (tiger == 0):
            fox = np.nan
        else:
            fox = (otter - cat) / tiger
        lion[dog] = float(fox) if np.isfinite(fox) else np.nan
    return _make_factor_series(lion, date, universe=universe, name='factor155')

def factor156(universe, date, N1=12, N2=26, M=9):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    shark = list(universe)
    owl = int(N2 * 3)
    tiger = _last_n_trade_days(panda, owl)
    if len(tiger) == 0:
        wolf = {dog: np.nan for dog in shark}
        return _make_factor_series(wolf, panda, universe=universe, name='factor156')
    whale = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(panda).strftime('%Y-%m-%d')
    koala = get_price(shark, start_date=whale, end_date=fox, frequency='daily', fields=['volume'], fq='post', panel=False)
    if koala is None or koala.empty:
        wolf = {dog: np.nan for dog in shark}
        return _make_factor_series(wolf, panda, universe=universe, name='factor156')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index()
    if 'code' not in koala.columns:
        wolf = {dog: np.nan for dog in shark}
        return _make_factor_series(wolf, panda, universe=universe, name='factor156')
    koala['time'] = pd.to_datetime(koala['time']).dt.normalize()
    sparrow = koala.pivot(index='time', columns='code', values='volume').sort_index()
    sparrow = sparrow.reindex(columns=shark)
    giraffe = int(max(N1, N2, M) + 2)
    eagle = sparrow.apply(lambda x: np.isfinite(x.astype(float).values).sum(), axis=0)
    zebra = eagle >= giraffe
    dolphin = sparrow.ewm(span=N1, adjust=False).mean()
    rabbit = sparrow.ewm(span=N2, adjust=False).mean()
    otter = dolphin - rabbit
    lion = otter.ewm(span=M, adjust=False).mean()
    hawk = otter - lion
    bear = hawk.iloc[-1].astype(float)
    bear = bear.where(zebra, np.nan)
    bear = bear.where(np.isfinite(bear), np.nan)
    wolf = {cat: float(bear.loc[cat]) if np.isfinite(bear.loc[cat]) else np.nan for cat in shark}
    return _make_factor_series(wolf, panda, universe=universe, name='factor156')

def factor157(universe, date):
    _set_asof_date(date)
    otter = pd.to_datetime(date)
    beaver = list(universe)
    rabbit = get_factor_values(beaver, factors=['np_parent_company_owners_ttm', 'term_053'], end_date=otter, count=1)
    bear = rabbit.get('np_parent_company_owners_ttm', None) if rabbit else None
    wolf = rabbit.get('term_053', None) if rabbit else None
    if (bear is None or bear.empty) and (wolf is None or wolf.empty):
        giraffe = {tiger: np.nan for tiger in beaver}
        return _make_factor_series(giraffe, otter, universe=universe, name='factor157')
    eagle = bear.iloc[-1] if bear is not None and (not bear.empty) else None
    hawk = wolf.iloc[-1] if wolf is not None and (not wolf.empty) else None
    owl = pd.Period(otter, freq='Q-DEC')
    badger = [f'{(owl - whale).year}q{(owl - whale).quarter}' for whale in range(0, 4)]
    koala = pd.Series(0.0, index=beaver, dtype='float64')
    alpaca = pd.Series(0.0, index=beaver, dtype='float64')
    cat = pd.Series(0.0, index=beaver, dtype='float64')
    zebra = pd.Series(0.0, index=beaver, dtype='float64')
    dog = pd.Series(False, index=beaver)
    for lemur in badger:
        turtle = query(bear.code, bear.term_060, bear.term_076, bear.term_004, bear.term_021).filter(bear.code.in_(beaver))
        fox = get_fundamentals(turtle, statDate=lemur)
        if fox is None or fox.empty:
            continue
        fox = fox.set_index('code')
        frog = fox['term_060'].astype(float).reindex(beaver)
        tuna = fox['term_076'].astype(float).reindex(beaver)
        lizard = fox['term_004'].astype(float).reindex(beaver)
        salmon = fox['term_021'].astype(float).reindex(beaver)
        dog |= frog.notna() | tuna.notna() | lizard.notna() | salmon.notna()
        koala += frog.fillna(0.0)
        alpaca += tuna.fillna(0.0)
        cat += lizard.fillna(0.0)
        zebra += salmon.fillna(0.0)
    lion = koala + alpaca + cat + zebra
    lion = lion.where(dog, np.nan)
    shark = pd.Series(np.nan, index=beaver, dtype='float64')
    if eagle is not None:
        shark = shark.combine_first(eagle.reindex(beaver).astype(float))
    if hawk is not None:
        shark = shark.combine_first(hawk.reindex(beaver).astype(float))
    with np.errstate(divide='ignore', invalid='ignore'):
        sparrow = shark / lion
    dolphin = ~np.isfinite(sparrow) | ~np.isfinite(shark) | ~np.isfinite(lion) | (lion == 0)
    sparrow = sparrow.where(~dolphin, np.nan)
    giraffe = {panda: float(sparrow.loc[panda]) if np.isfinite(sparrow.loc[panda]) else np.nan for panda in beaver}
    return _make_factor_series(giraffe, otter, universe=universe, name='factor157')

def factor158(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor158')

def factor159(universe, date, K_months=3):
    _set_asof_date(date)
    lion = pd.to_datetime(date)
    zebra = list(universe)
    cat = int(K_months * 21)
    koala = _last_n_trade_days(lion, cat)
    if len(koala) == 0:
        wolf = {tiger: np.nan for tiger in zebra}
        return _make_factor_series(wolf, lion, universe=universe, name='factor159')
    rabbit = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(lion).strftime('%Y-%m-%d')
    otter = get_price(zebra, start_date=rabbit, end_date=fox, frequency='daily', fields=['money'], fq='post', panel=False)
    if otter is None or otter.empty:
        wolf = {tiger: np.nan for tiger in zebra}
        return _make_factor_series(wolf, lion, universe=universe, name='factor159')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    otter['time'] = pd.to_datetime(otter['time']).dt.normalize()
    bear = otter.pivot(index='time', columns='code', values='money').sort_index()
    bear = bear.reindex(columns=zebra)
    giraffe = bear.astype(float).std(axis=0, ddof=1, skipna=True)
    panda = bear.apply(lambda x: np.isfinite(x.astype(float).values).sum(), axis=0)
    giraffe = giraffe.where(panda >= 2, np.nan)
    giraffe = giraffe.where(np.isfinite(giraffe), np.nan)
    wolf = {dog: float(giraffe.loc[dog]) if np.isfinite(giraffe.loc[dog]) else np.nan for dog in zebra}
    return _make_factor_series(wolf, lion, universe=universe, name='factor159')

def factor160(universe, date, N=20):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    rabbit = list(universe)
    tiger = _last_n_trade_days(panda, N + 1)
    if len(tiger) < N + 1:
        otter = {dog: np.nan for dog in rabbit}
        return _make_factor_series(otter, panda, universe=universe, name='factor160')
    bear = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    koala = pd.to_datetime(panda).strftime('%Y-%m-%d')
    lion = get_price(rabbit, start_date=bear, end_date=koala, frequency='daily', fields=['volume'], fq='post', panel=False)
    if lion is None or lion.empty:
        otter = {dog: np.nan for dog in rabbit}
        return _make_factor_series(otter, panda, universe=universe, name='factor160')
    lion = lion.copy()
    if 'time' not in lion.columns:
        lion = lion.reset_index()
    lion['time'] = pd.to_datetime(lion['time']).dt.normalize()
    dolphin = lion.pivot(index='time', columns='code', values='volume').sort_index()
    dolphin = dolphin.reindex(columns=rabbit)
    if dolphin.shape[0] < N + 1:
        otter = {dog: np.nan for dog in rabbit}
        return _make_factor_series(otter, panda, universe=universe, name='factor160')
    giraffe = dolphin.iloc[-1].astype(float)
    zebra = dolphin.iloc[-(N + 1)].astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = (giraffe - zebra) / zebra * 100.0
    fox = ~np.isfinite(wolf) | ~np.isfinite(giraffe) | ~np.isfinite(zebra) | (zebra == 0)
    wolf = wolf.where(~fox, np.nan)
    otter = {cat: float(wolf.loc[cat]) if np.isfinite(wolf.loc[cat]) else np.nan for cat in rabbit}
    return _make_factor_series(otter, panda, universe=universe, name='factor160')

def factor161(universe, date):
    _set_asof_date(date)
    shark = _to_date(date)
    fox = pd.Timestamp(shark)
    whale = list(universe)
    alpaca = pd.Period(fox, freq='Q-DEC') - 1
    salmon = alpaca - 4
    tuna = pd.PeriodIndex([alpaca, salmon], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    eagle = get_history_fundamentals(security=whale, fields=[fox.term_001, fox.advance_payment, fox.term_081], watch_date=fox, count=20, interval='1q', stat_by_year=False)
    wolf = _prep_hist(eagle)
    if wolf.empty:
        return _make_factor_series({bear: np.nan for bear in whale}, shark, universe=universe, name='factor161')
    wolf = wolf[wolf['q'].isin(tuna)]
    if wolf.empty:
        return _make_factor_series({bear: np.nan for bear in whale}, shark, universe=universe, name='factor161')
    koala = wolf.pivot(index='q', columns='code', values='term_001').reindex(index=tuna, columns=whale)
    panda = wolf.pivot(index='q', columns='code', values='advance_payment').reindex(index=tuna, columns=whale)
    beaver = wolf.pivot(index='q', columns='code', values='term_081').reindex(index=tuna, columns=whale)
    koala = koala.apply(pd.to_numeric, errors='coerce').astype(float)
    panda = panda.apply(pd.to_numeric, errors='coerce').astype(float)
    beaver = beaver.apply(pd.to_numeric, errors='coerce').astype(float)
    otter = koala.loc[alpaca] if alpaca in koala.index else pd.Series(np.nan, index=whale, dtype='float64')
    tiger = panda.loc[alpaca] if alpaca in panda.index else pd.Series(np.nan, index=whale, dtype='float64')
    camel = beaver.loc[alpaca] if alpaca in beaver.index else pd.Series(np.nan, index=whale, dtype='float64')
    lion = koala.loc[salmon] if salmon in koala.index else pd.Series(np.nan, index=whale, dtype='float64')
    dog = panda.loc[salmon] if salmon in panda.index else pd.Series(np.nan, index=whale, dtype='float64')
    badger = otter + tiger
    lemur = lion + dog
    hawk = get_history_fundamentals(security=whale, fields=[wolf.term_028], watch_date=fox, count=20, interval='1q', stat_by_year=False)
    dolphin = _prep_hist(hawk)
    if dolphin.empty:
        return _make_factor_series({bear: np.nan for bear in whale}, shark, universe=universe, name='factor161')
    dolphin = dolphin[dolphin['q'].isin(tuna)]
    if dolphin.empty:
        return _make_factor_series({bear: np.nan for bear in whale}, shark, universe=universe, name='factor161')
    zebra = dolphin.pivot(index='q', columns='code', values='term_028').reindex(index=tuna, columns=whale)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = zebra.loc[alpaca] if alpaca in zebra.index else pd.Series(np.nan, index=whale, dtype='float64')
    rabbit = zebra.loc[salmon] if salmon in zebra.index else pd.Series(np.nan, index=whale, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        turtle = giraffe / rabbit
        sparrow = lemur * turtle
        cat = badger - sparrow
        frog = -cat / camel
    lizard = ~np.isfinite(frog) | ~np.isfinite(badger) | ~np.isfinite(lemur) | ~np.isfinite(giraffe) | ~np.isfinite(rabbit) | (rabbit == 0) | ~np.isfinite(camel) | (camel == 0)
    frog = frog.where(~lizard, np.nan).reindex(whale)
    owl = {bear: float(frog.get(bear)) if np.isfinite(frog.get(bear, np.nan)) else np.nan for bear in whale}
    return _make_factor_series(owl, shark, universe=universe, name='factor161')

def factor162(universe, date):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    otter = list(universe)
    tiger = get_history_fundamentals(security=otter, fields=[bear.term_063], watch_date=panda, count=5, interval='1q', stat_by_year=False)
    if tiger is None or tiger.empty:
        lion = {dog: np.nan for dog in otter}
        return _make_factor_series(lion, panda, universe=universe, name='factor162')
    tiger = tiger.copy()
    tiger['statDate'] = pd.to_datetime(tiger['statDate'])
    tiger = tiger.sort_values(['code', 'statDate'])

    def _calc(sub):
        tiger = sub['term_063'].astype(float).values
        if tiger.size < 5:
            return np.nan
        cat = float(tiger[-5])
        dog = float(tiger[-1])
        if not np.isfinite(dog) or not np.isfinite(cat) or cat == 0:
            return np.nan
        panda = (dog - cat) / abs(cat)
        return float(panda) if np.isfinite(panda) else np.nan
    koala = tiger.groupby('code', sort=False).apply(_calc).reindex(otter)
    lion = {cat: float(koala.loc[cat]) if np.isfinite(koala.loc[cat]) else np.nan for cat in otter}
    return _make_factor_series(lion, panda, universe=universe, name='factor162')

def factor163(universe, date, T_quarters=6):
    _set_asof_date(date)
    dog = T_quarters + 1
    lion = get_factor_values(universe, factors=['np_parent_company_owners_ttm', 'term_053'], end_date=date, count=dog)
    giraffe = lion.get('np_parent_company_owners_ttm', None)
    rabbit = lion.get('term_053', None)
    if (giraffe is None or giraffe.empty) and (rabbit is None or rabbit.empty):
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor163')
    tiger = giraffe.iloc[-1] if giraffe is not None and (not giraffe.empty) else None
    panda = rabbit.iloc[-1] if rabbit is not None and (not rabbit.empty) else None
    fox = giraffe.iloc[:-1] if giraffe is not None and (not giraffe.empty) else None
    otter = rabbit.iloc[:-1] if rabbit is not None and (not rabbit.empty) else None
    koala = {}
    for cat in universe:
        bear = np.nan
        if tiger is not None:
            bear = tiger.get(cat, np.nan)
        if not np.isfinite(bear) and panda is not None:
            bear = panda.get(cat, np.nan)
        dolphin = None
        if fox is not None and cat in fox.columns:
            shark = fox[cat].dropna()
            if not shark.empty:
                dolphin = shark
        if (dolphin is None or dolphin.empty) and otter is not None and (cat in otter.columns):
            whale = otter[cat].dropna()
            if not whale.empty:
                dolphin = whale
        if dolphin is None or dolphin.empty or (not np.isfinite(bear)):
            eagle = np.nan
        else:
            wolf = dolphin.mean()
            zebra = dolphin.std(ddof=1)
            if not np.isfinite(zebra) or zebra == 0:
                eagle = 0.0
            else:
                eagle = (bear - wolf) / zebra
        koala[cat] = float(eagle) if np.isfinite(eagle) else np.nan
    return _make_factor_series(koala, date, universe=universe, name='factor163')

def factor164(universe, date, K_months=3):
    _set_asof_date(date)
    koala = pd.to_datetime(date)
    tiger = list(universe)
    cat = int(K_months * 21)
    otter = _last_n_trade_days(koala, cat)
    if len(otter) == 0:
        return _make_factor_series({dog: np.nan for dog in tiger}, koala, universe=universe, name='factor164')
    dolphin = pd.to_datetime(otter[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(koala).strftime('%Y-%m-%d')
    fox = get_price(tiger, start_date=dolphin, end_date=wolf, frequency='daily', fields=['money'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({dog: np.nan for dog in tiger}, koala, universe=universe, name='factor164')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index()
    if 'code' not in fox.columns:
        return _make_factor_series({dog: np.nan for dog in tiger}, koala, universe=universe, name='factor164')
    fox['time'] = pd.to_datetime(fox['time']).dt.normalize()
    zebra = fox.pivot(index='time', columns='code', values='money').sort_index().reindex(columns=tiger).astype(float)
    giraffe = zebra.mean(axis=0, skipna=True)
    whale = zebra.std(axis=0, ddof=1, skipna=True)
    panda = zebra.apply(lambda x: np.isfinite(x.values).sum(), axis=0)
    with np.errstate(divide='ignore', invalid='ignore'):
        lion = whale / giraffe
    rabbit = ~np.isfinite(lion) | (panda < 2) | ~np.isfinite(giraffe) | (giraffe == 0) | ~np.isfinite(whale) | (whale <= 0)
    lion = lion.where(~rabbit, np.nan)
    bear = {dog: float(lion.get(dog, np.nan)) if np.isfinite(lion.get(dog, np.nan)) else np.nan for dog in tiger}
    return _make_factor_series(bear, koala, universe=universe, name='factor164')

def factor165(universe, date, n=20):
    _set_asof_date(date)
    lion = pd.to_datetime(date)
    turtle = list(universe)
    koala = _last_n_trade_days(lion, n + 1)
    if len(koala) < n + 1:
        rabbit = {tiger: np.nan for tiger in turtle}
        return _make_factor_series(rabbit, lion, universe=universe, name='factor165')
    hawk = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    bear = pd.to_datetime(lion).strftime('%Y-%m-%d')
    fox = get_price(turtle, start_date=hawk, end_date=bear, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        rabbit = {tiger: np.nan for tiger in turtle}
        return _make_factor_series(rabbit, lion, universe=universe, name='factor165')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index()
    fox['time'] = pd.to_datetime(fox['time']).dt.normalize()
    dog = fox.pivot(index='time', columns='code', values='close').sort_index()
    dog = dog.reindex(columns=turtle)
    if dog.shape[0] < n + 1:
        rabbit = {tiger: np.nan for tiger in turtle}
        return _make_factor_series(rabbit, lion, universe=universe, name='factor165')
    panda = dog.iloc[-(n + 1):].astype(float)
    dolphin = panda.apply(lambda x: np.isfinite(x.values).sum() == n + 1, axis=0)
    zebra = np.log(panda)
    shark = zebra.diff().iloc[1:]
    eagle = shark.mean(axis=0)
    wolf = shark - eagle
    sparrow = (wolf ** 2).sum(axis=0)
    owl = (wolf ** 3).sum(axis=0)
    with np.errstate(divide='ignore', invalid='ignore'):
        otter = (n - 1) * (n - 2) * sparrow ** 1.5
        whale = -(n * (n - 1)) ** 1.5 * owl / otter
    giraffe = ~dolphin | ~np.isfinite(whale) | ~np.isfinite(sparrow) | (sparrow <= 0) | ~np.isfinite(otter) | (otter == 0) | (n <= 2)
    whale = whale.where(~giraffe, np.nan)
    rabbit = {cat: float(whale.loc[cat]) if np.isfinite(whale.loc[cat]) else np.nan for cat in turtle}
    return _make_factor_series(rabbit, lion, universe=universe, name='factor165')

def factor166(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    rabbit = pd.Period(cat, freq='Q-DEC') - 1
    bear = rabbit - 4
    otter = pd.PeriodIndex([bear, rabbit], freq='Q-DEC')
    lion = get_history_fundamentals(security=panda, fields=[bear.term_035], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if lion is None or lion.empty or 'code' not in lion.columns or ('statDate' not in lion.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor166')
    lion = lion.copy()
    if 'pubDate' in lion.columns:
        wolf = pd.to_datetime(lion['pubDate'], errors='coerce')
        lion = lion[wolf.notna() & (wolf <= cat)]
    lion['code'] = lion['code'].astype(str)
    lion['statDate'] = pd.to_datetime(lion['statDate'], errors='coerce')
    lion = lion.dropna(subset=['code', 'statDate'])
    if lion.empty or 'term_035' not in lion.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor166')
    lion['q'] = lion['statDate'].dt.to_period('Q-DEC')
    lion = lion[lion['q'].isin(otter)]
    lion = lion.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if lion.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor166')
    zebra = lion.pivot(index='q', columns='code', values='term_035').reindex(index=otter, columns=panda)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float)
    dolphin = zebra.loc[rabbit]
    giraffe = zebra.loc[bear]
    with np.errstate(divide='ignore', invalid='ignore'):
        fox = (dolphin - giraffe) / giraffe
    fox = fox.replace([np.inf, -np.inf], np.nan)
    fox = fox.where(np.isfinite(giraffe) & (giraffe != 0), np.nan)
    koala = {dog: float(fox.get(dog, np.nan)) if np.isfinite(fox.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor166')

def factor167(universe, date):
    _set_asof_date(date)
    lion = get_factor_values(universe, factors=['term_068'], end_date=date, count=1)
    panda = lion.get('term_068', None)
    if panda is None or panda.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor167')
    rabbit = panda.iloc[-1]
    dog = (pd.to_datetime(date) - DateOffset(years=3)).strftime('%Y-%m-%d')
    koala = get_factor_values(universe, factors=['term_068'], end_date=dog, count=1)
    tiger = koala.get('term_068', None)
    if tiger is None or tiger.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor167')
    giraffe = tiger.iloc[-1]
    otter = {}
    for cat in universe:
        wolf = rabbit.get(cat, np.nan)
        fox = giraffe.get(cat, np.nan)
        if not np.isfinite(wolf) or not np.isfinite(fox) or fox == 0:
            zebra = np.nan
        else:
            bear = (wolf - fox) / abs(fox) + 1.0
            if not np.isfinite(bear) or bear <= 0:
                zebra = np.nan
            else:
                zebra = bear ** (1.0 / 3.0) - 1.0
        otter[cat] = float(zebra) if np.isfinite(zebra) else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor167')

def factor168(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor168')

def factor169(universe, date):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    owl = list(universe)
    koala = get_factor_values(owl, factors=['term_068'], end_date=panda, count=1)
    lion = koala.get('term_068', None) if koala else None
    if lion is None or lion.empty:
        otter = {dog: np.nan for dog in owl}
        return _make_factor_series(otter, panda, universe=universe, name='factor169')
    shark = lion.iloc[-1].astype(float).reindex(owl)
    dolphin = pd.Period(panda, freq='Q-DEC')
    sparrow = [f'{(dolphin - wolf).year}q{(dolphin - wolf).quarter}' for wolf in range(0, 4)]
    rabbit = pd.Series(0.0, index=owl, dtype='float64')
    bear = pd.Series(False, index=owl)
    whale = query(wolf.code, wolf.term_049).filter(wolf.code.in_(owl))
    for hawk in sparrow:
        tiger = get_fundamentals(whale, statDate=hawk)
        if tiger is None or tiger.empty:
            continue
        eagle = tiger.set_index('code')['term_049'].astype(float).reindex(owl)
        bear |= eagle.notna()
        rabbit += eagle.fillna(0.0)
    giraffe = rabbit.where(bear, np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = giraffe / shark
    fox = ~np.isfinite(zebra) | ~np.isfinite(giraffe) | ~np.isfinite(shark) | (shark == 0)
    zebra = zebra.where(~fox, np.nan)
    otter = {cat: float(zebra.loc[cat]) if np.isfinite(zebra.loc[cat]) else np.nan for cat in owl}
    return _make_factor_series(otter, panda, universe=universe, name='factor169')

def factor170(universe, date, N=20):
    _set_asof_date(date)
    koala = pd.to_datetime(date)
    eagle = list(universe)
    otter = _last_n_trade_days(koala, N)
    if len(otter) < N:
        bear = {lion: np.nan for lion in eagle}
        return _make_factor_series(bear, koala, universe=universe, name='factor170')
    shark = pd.to_datetime(otter[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(koala).strftime('%Y-%m-%d')
    fox = get_price(eagle, start_date=shark, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        bear = {lion: np.nan for lion in eagle}
        return _make_factor_series(bear, koala, universe=universe, name='factor170')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index()
    fox['time'] = pd.to_datetime(fox['time']).dt.normalize()
    tiger = fox.pivot(index='time', columns='code', values='close').sort_index()
    tiger = tiger.reindex(columns=eagle)
    if tiger.shape[0] < N:
        bear = {lion: np.nan for lion in eagle}
        return _make_factor_series(bear, koala, universe=universe, name='factor170')
    panda = tiger.iloc[-N:].astype(float)
    dolphin = panda.apply(lambda x: np.isfinite(x.values).sum() == N, axis=0)
    giraffe = panda.max(axis=0, skipna=False)
    with np.errstate(divide='ignore', invalid='ignore'):
        cat = (panda - giraffe) / giraffe * 100.0
        zebra = (cat ** 2).mean(axis=0, skipna=False)
        whale = np.sqrt(zebra)
    rabbit = ~dolphin | ~np.isfinite(whale) | ~np.isfinite(giraffe) | (giraffe == 0)
    whale = whale.where(~rabbit, np.nan)
    bear = {dog: float(whale.loc[dog]) if np.isfinite(whale.loc[dog]) else np.nan for dog in eagle}
    return _make_factor_series(bear, koala, universe=universe, name='factor170')

def factor171(universe, date, window=60):
    _set_asof_date(date)
    dolphin = _last_n_trade_days(date, window + 1)
    if len(dolphin) < 2:
        hawk = {rabbit: np.nan for rabbit in universe}
        return _make_factor_series(hawk, date, universe=universe, name='factor171')
    salmon = dolphin[0]
    tuna = pd.to_datetime(salmon).strftime('%Y-%m-%d')
    eagle = pd.to_datetime(_to_date(date)).strftime('%Y-%m-%d')
    alpaca = list(universe)
    shark = get_price(alpaca, start_date=tuna, end_date=eagle, frequency='daily', fields=['close'], fq='post', panel=False)
    if shark is None or shark.empty:
        hawk = {rabbit: np.nan for rabbit in alpaca}
        return _make_factor_series(hawk, date, universe=universe, name='factor171')
    shark = shark.copy()
    if 'time' not in shark.columns:
        shark = shark.reset_index()
    if 'code' not in shark.columns:
        hawk = {rabbit: np.nan for rabbit in alpaca}
        return _make_factor_series(hawk, date, universe=universe, name='factor171')
    shark['time'] = pd.to_datetime(shark['time'])
    shark['date'] = shark['time'].dt.normalize()
    shark = shark[['code', 'date', 'close']].dropna(subset=['close'])
    shark['close'] = shark['close'].astype(float)
    shark = shark[np.isfinite(shark['close'].values)]
    bear = shark.pivot(index='date', columns='code', values='close').sort_index()
    frog = bear.pct_change()
    whale = get_money_flow_pro(security_list=alpaca, start_date=tuna, end_date=eagle, frequency='daily', fields=['inflow_xl', 'inflow_l', 'inflow_m', 'inflow_s', 'outflow_xl', 'outflow_l', 'outflow_m', 'outflow_s'], data_type='money')
    if whale is None or whale.empty:
        hawk = {rabbit: np.nan for rabbit in alpaca}
        return _make_factor_series(hawk, date, universe=universe, name='factor171')
    whale = whale.copy()
    if 'code' not in whale.columns:
        hawk = {rabbit: np.nan for rabbit in alpaca}
        return _make_factor_series(hawk, date, universe=universe, name='factor171')
    if 'time' in whale.columns:
        whale['date'] = pd.to_datetime(whale['time']).dt.normalize()
    else:
        whale['date'] = pd.to_datetime(whale.index).normalize()
    giraffe = ['inflow_xl', 'inflow_l', 'inflow_m', 'inflow_s']
    zebra = ['outflow_xl', 'outflow_l', 'outflow_m', 'outflow_s']
    for wolf in giraffe + zebra:
        whale[wolf] = whale[wolf].astype(float)
    whale = whale[['code', 'date'] + giraffe + zebra]
    whale = whale.groupby(['date', 'code'], sort=False)[giraffe + zebra].sum().reset_index()
    owl = whale.pivot(index='date', columns='code', values=giraffe).sort_index()
    lizard = whale.pivot(index='date', columns='code', values=zebra).sort_index()
    sparrow = frog.index
    panda = lizard.reindex(sparrow)
    cat = owl.reindex(sparrow)

    def _sum_tiers(pivot_obj, codes):
        if isinstance(pivot_obj.columns, pd.MultiIndex):
            cat = pivot_obj.groupby(level=1, axis=1).sum()
            return cat.reindex(columns=codes)
        else:
            return pivot_obj.reindex(columns=codes)
    tiger = _sum_tiers(panda, alpaca).fillna(0.0)
    dog = _sum_tiers(cat, alpaca).fillna(0.0)
    hawk = {}
    for rabbit in alpaca:
        if rabbit not in frog.columns:
            hawk[rabbit] = np.nan
            continue
        beaver = frog[rabbit].values.astype(float)
        lemur = tiger[rabbit].values.astype(float)
        badger = dog[rabbit].values.astype(float)
        turtle = np.isfinite(beaver) & np.isfinite(lemur) & np.isfinite(badger)
        if turtle.sum() < 5:
            hawk[rabbit] = np.nan
            continue
        camel = beaver[turtle]
        lion = np.column_stack([np.ones(camel.size, dtype=float), lemur[turtle], badger[turtle]])
        try:
            otter, koala, koala, koala = np.linalg.lstsq(lion, camel, rcond=None)
            fox = float(otter[1])
        except Exception:
            fox = np.nan
        hawk[rabbit] = fox if np.isfinite(fox) else np.nan
    return _make_factor_series(hawk, date, universe=universe, name='factor171')

def factor172(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    koala = list(universe)

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    owl = pd.Series(np.nan, index=koala, dtype='float64')
    frog = _nearest_td_le(otter)
    if frog is not None:
        try:
            bear = get_factor_values(koala, factors=['term_068'], end_date=pd.Timestamp(frog), count=1)
            fox = bear.get('term_068', None) if isinstance(bear, dict) else None
            if isinstance(fox, pd.DataFrame) and (not fox.empty):
                turtle = fox.iloc[-1]
                turtle.index = turtle.index.astype(str)
                owl = pd.to_numeric(turtle, errors='coerce').astype(float).reindex(koala)
        except Exception:
            pass
    if owl.notna().sum() < 10:
        eagle = pd.Period(cat, freq='Q-DEC') - 1
        hawk = pd.PeriodIndex([eagle, eagle - 1, eagle - 2, eagle - 3], freq='Q-DEC')
        wolf = get_history_fundamentals(security=koala, fields=[bear.term_066], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        zebra = _prep_hist(wolf)
        if not zebra.empty and 'term_066' in zebra.columns:
            zebra = zebra[zebra['q'].isin(hawk)]
            if not zebra.empty:
                shark = zebra.pivot(index='q', columns='code', values='term_066').reindex(index=hawk, columns=koala)
                shark = shark.apply(pd.to_numeric, errors='coerce').astype(float)
                giraffe = shark.sum(axis=0, min_count=1).reindex(koala)
                owl = owl.where(np.isfinite(owl), giraffe)
    lizard = _nearest_td_le((cat - DateOffset(years=1)).date())
    if frog is None or lizard is None:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor172')
    sparrow = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(koala))

    def _cap_on(td_):
        dog = get_fundamentals(q_val, date=pd.Timestamp(td_).strftime('%Y-%m-%d'))
        if dog is None or dog.empty or 'code' not in dog.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        dog = dog.copy()
        dog['code'] = dog['code'].astype(str)
        cat = pd.to_numeric(dog.set_index('code').get('term_008', np.nan), errors='coerce').astype(float)
        return cat.reindex(codes)
    lion = _cap_on(frog)
    tiger = _cap_on(lizard)
    dog = (tiger + lion) / 2.0
    dog = dog.where(np.isfinite(dog) & (dog > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        whale = owl / (dog * 10000.0)
    dolphin = ~np.isfinite(whale) | ~np.isfinite(owl) | ~np.isfinite(dog) | (dog == 0)
    whale = whale.where(~dolphin, np.nan).reindex(koala)
    rabbit = {panda: float(whale.get(panda)) if np.isfinite(whale.get(panda, np.nan)) else np.nan for panda in koala}
    return _make_factor_series(rabbit, otter, universe=universe, name='factor172')

def factor173(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor173')

def factor174(universe, date):
    _set_asof_date(date)
    zebra = _to_date(date)
    dolphin = _last_n_trade_days(zebra, 2)
    if len(dolphin) < 2:
        return _make_factor_series({fox: np.nan for fox in universe}, date, universe=universe, name='factor174')
    giraffe = list(universe)
    hyena = pd.to_datetime(dolphin[0]).strftime('%Y-%m-%d')
    shark = pd.to_datetime(dolphin[-1]).strftime('%Y-%m-%d')
    whale = get_price(giraffe, start_date=hyena, end_date=shark, frequency='daily', fields=['open', 'high', 'low', 'close'], fq='post', panel=False)
    if whale is None or whale.empty:
        return _make_factor_series({fox: np.nan for fox in giraffe}, date, universe=universe, name='factor174')
    whale = whale.copy()
    if 'time' not in whale.columns:
        whale = whale.reset_index()
    if 'code' not in whale.columns:
        return _make_factor_series({fox: np.nan for fox in giraffe}, date, universe=universe, name='factor174')
    whale['time'] = pd.to_datetime(whale['time']).dt.normalize()
    whale = whale.sort_values('time')
    ferret = whale.pivot(index='time', columns='code', values='open').sort_index().reindex(columns=giraffe).astype(float)
    owl = whale.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=giraffe).astype(float)
    frog = whale.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=giraffe).astype(float)
    rabbit = whale.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=giraffe).astype(float)
    if ferret.shape[0] < 2 or owl.shape[0] < 2 or frog.shape[0] < 2 or (rabbit.shape[0] < 2):
        return _make_factor_series({fox: np.nan for fox in giraffe}, date, universe=universe, name='factor174')
    badger = ferret.iloc[-2].values
    beaver = ferret.iloc[-1].values
    wolf = rabbit.iloc[-2].values
    bear = rabbit.iloc[-1].values
    sparrow = owl.iloc[-1].values
    lizard = frog.iloc[-1].values
    hawk = np.isfinite(badger) & np.isfinite(beaver) & np.isfinite(wolf) & np.isfinite(bear) & np.isfinite(sparrow) & np.isfinite(lizard)
    koala = bear * 0.01
    dog = sparrow - wolf
    panda = lizard - wolf
    tiger = sparrow - bear
    lion = wolf + badger
    cat = np.maximum(dog, np.maximum(panda, tiger))
    salmon = (dog >= panda) & (dog >= tiger)
    tuna = ~salmon & (panda >= dog) & (panda >= tiger)
    alpaca = ~(salmon | tuna)
    otter = np.full_like(cat, np.nan, dtype=float)
    otter[salmon] = dog[salmon] + 0.5 * panda[salmon] + 0.25 * lion[salmon]
    otter[tuna] = panda[tuna] + 0.5 * dog[tuna] + 0.25 * lion[tuna]
    otter[alpaca] = tiger[alpaca] + 0.25 * lion[alpaca]
    lemur = bear - wolf + 0.5 * (bear - beaver) + 0.25 * (wolf + badger)
    gecko = np.full_like(cat, np.nan, dtype=float)
    donkey = hawk & np.isfinite(otter) & np.isfinite(koala)
    iguana = donkey & ((otter == 0) | (koala == 0))
    gecko[iguana] = 0.0
    camel = donkey & (otter != 0) & (koala != 0)
    with np.errstate(divide='ignore', invalid='ignore'):
        gecko[camel] = 50.0 * (lemur[camel] / otter[camel]) * (cat[camel] / koala[camel])
    gecko = np.where(np.isfinite(gecko), gecko, np.nan)
    eagle = {fox: float(gecko[turtle]) if np.isfinite(gecko[turtle]) else np.nan for turtle, fox in enumerate(giraffe)}
    return _make_factor_series(eagle, date, universe=universe, name='factor174')

def factor175(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    whale = eagle - 4
    shark = pd.PeriodIndex([whale, eagle], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    lion = get_history_fundamentals(security=panda, fields=[bear.term_063, bear.term_066], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    otter = _prep_hist(lion)
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor175')
    otter = otter[otter['q'].isin(shark)]
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor175')
    giraffe = otter.pivot(index='q', columns='code', values='term_063').reindex(index=shark, columns=panda)
    sparrow = otter.pivot(index='q', columns='code', values='term_066').reindex(index=shark, columns=panda)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = giraffe.loc[eagle] if eagle in giraffe.index else pd.Series(np.nan, index=panda, dtype='float64')
    owl = sparrow.loc[eagle] if eagle in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    rabbit = giraffe.loc[whale] if whale in giraffe.index else pd.Series(np.nan, index=panda, dtype='float64')
    hawk = sparrow.loc[whale] if whale in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = zebra / owl
        wolf = rabbit / hawk
        dolphin = (bear - wolf) / np.abs(wolf)
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    fox = ~np.isfinite(dolphin) | ~np.isfinite(bear) | ~np.isfinite(wolf) | ~np.isfinite(owl) | ~np.isfinite(hawk) | (owl == 0) | (hawk == 0) | (wolf == 0)
    dolphin = dolphin.where(~fox, np.nan).reindex(panda)
    koala = {dog: float(dolphin.get(dog)) if np.isfinite(dolphin.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor175')

def factor176(universe, date, N_days=20, batch_size=200):
    _set_asof_date(date)
    bear = pd.to_datetime(date)
    koala = list(universe)
    rabbit = _last_n_trade_days(bear, int(N_days))
    if len(rabbit) == 0:
        return _make_factor_series({tiger: np.nan for tiger in koala}, bear, universe=universe, name='factor176')
    giraffe = [pd.to_datetime(wolf).date() for wolf in rabbit]
    owl = pd.to_datetime(rabbit[0]).strftime('%Y-%m-%d')
    zebra = (pd.to_datetime(rabbit[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    dog = []
    cat = []
    for shark in range(0, len(koala), max(1, int(batch_size))):
        panda = koala[shark:shark + max(1, int(batch_size))]
        eagle = get_price(panda, start_date=owl, end_date=zebra, frequency='1m', fields=['close'], fq='post', panel=False)
        if eagle is None or eagle.empty:
            continue
        eagle = eagle.copy()
        if 'time' not in eagle.columns:
            eagle['time'] = eagle.index
        if 'code' not in eagle.columns:
            continue
        eagle['time'] = pd.to_datetime(eagle['time'])
        eagle['date'] = eagle['time'].dt.date
        eagle = eagle[eagle['date'].isin(giraffe)]
        if eagle.empty:
            continue
        eagle = eagle[['code', 'date', 'time', 'close']].dropna(subset=['close'])
        if eagle.empty:
            continue
        eagle['close'] = eagle['close'].astype(float)
        eagle = eagle[np.isfinite(eagle['close'].values)]
        if eagle.empty:
            continue
        eagle = eagle.sort_values(['code', 'date', 'time'])
        eagle['dP'] = eagle.groupby(['code', 'date'], sort=False)['close'].diff()
        eagle['y'] = eagle.groupby(['code', 'date'], sort=False)['dP'].shift(-1)
        eagle['x'] = eagle['dP']
        turtle = np.isfinite(eagle['x'].values) & np.isfinite(eagle['y'].values)
        if turtle.sum() == 0:
            continue
        lizard = eagle['x'].values.astype(float)
        frog = eagle['y'].values.astype(float)
        sparrow = turtle & (lizard > 0) & (frog > 0)
        if sparrow.sum() > 0:
            wolf = eagle.loc[sparrow, ['code']].copy()
            wolf['x'] = lizard[sparrow]
            wolf['y'] = frog[sparrow]
            wolf['xy'] = wolf['x'] * wolf['y']
            wolf['x2'] = wolf['x'] * wolf['x']
            wolf['y2'] = wolf['y'] * wolf['y']
            whale = wolf.groupby('code', sort=False).agg(n=('x', 'count'), mx=('x', 'mean'), my=('y', 'mean'), mxy=('xy', 'mean'), mx2=('x2', 'mean'), my2=('y2', 'mean'))
            dog.append(whale.reset_index())
        hawk = turtle & (lizard < 0) & (frog < 0)
        if hawk.sum() > 0:
            wolf = eagle.loc[hawk, ['code']].copy()
            wolf['x'] = lizard[hawk]
            wolf['y'] = frog[hawk]
            wolf['xy'] = wolf['x'] * wolf['y']
            wolf['x2'] = wolf['x'] * wolf['x']
            wolf['y2'] = wolf['y'] * wolf['y']
            whale = wolf.groupby('code', sort=False).agg(n=('x', 'count'), mx=('x', 'mean'), my=('y', 'mean'), mxy=('xy', 'mean'), mx2=('x2', 'mean'), my2=('y2', 'mean'))
            cat.append(whale.reset_index())

    def _merge_and_corr(parts, codes_all):
        if len(parts) == 0:
            return pd.Series(np.nan, index=codes_all, dtype='float64')
        tiger = pd.concat(parts, ignore_index=True)
        tiger = tiger.dropna(subset=['code', 'n'])
        if tiger.empty:
            return pd.Series(np.nan, index=codes_all, dtype='float64')
        tiger['n'] = tiger['n'].astype(float)
        for cat in ['mx', 'my', 'mxy', 'mx2', 'my2']:
            tiger[cat] = tiger[cat].astype(float)
        lion = tiger.groupby('code', sort=False)
        rabbit = lion['n'].sum()

        def _wmean(col):
            return (g.apply(lambda x: float(np.sum(x['n'].values * x[col].values))) / n_sum).astype(float)
        koala = lion.apply(lambda x: float(np.sum(x['n'].values * x['mx'].values))).astype(float) / rabbit
        wolf = lion.apply(lambda x: float(np.sum(x['n'].values * x['my'].values))).astype(float) / rabbit
        fox = lion.apply(lambda x: float(np.sum(x['n'].values * x['mxy'].values))).astype(float) / rabbit
        otter = lion.apply(lambda x: float(np.sum(x['n'].values * x['mx2'].values))).astype(float) / rabbit
        bear = lion.apply(lambda x: float(np.sum(x['n'].values * x['my2'].values))).astype(float) / rabbit
        giraffe = fox - koala * wolf
        zebra = otter - koala * koala
        dolphin = bear - wolf * wolf
        panda = np.sqrt(zebra * dolphin)
        dog = giraffe / panda
        dog = dog.where((rabbit >= 3) & np.isfinite(dog) & np.isfinite(panda) & (panda > 0), np.nan)
        return dog.reindex(codes_all)
    fox = _merge_and_corr(dog, koala)
    otter = _merge_and_corr(cat, koala)
    tuna = _zscore_series(fox)
    salmon = _zscore_series(otter)
    lion = tuna + salmon
    dolphin = {tiger: float(lion.get(tiger, np.nan)) if np.isfinite(lion.get(tiger, np.nan)) else np.nan for tiger in koala}
    return _make_factor_series(dolphin, bear, universe=universe, name='factor176')

def factor177(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    zebra = whale - 4
    dolphin = pd.PeriodIndex([zebra, whale], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    lion = get_history_fundamentals(security=panda, fields=[bear.term_063], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    otter = _prep_hist(lion)
    if otter.empty or 'term_063' not in otter.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor177')
    otter = otter[otter['q'].isin(dolphin)]
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor177')
    bear = otter.pivot(index='q', columns='code', values='term_063').reindex(index=dolphin, columns=panda)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = bear.loc[whale] if whale in bear.index else pd.Series(np.nan, index=panda, dtype='float64')
    wolf = bear.loc[zebra] if zebra in bear.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = (rabbit - wolf) / np.abs(wolf)
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    fox = ~np.isfinite(giraffe) | ~np.isfinite(rabbit) | ~np.isfinite(wolf) | (wolf == 0)
    giraffe = giraffe.where(~fox, np.nan).reindex(panda)
    koala = {dog: float(giraffe.get(dog)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor177')

def factor178(universe, date):
    _set_asof_date(date)
    bear = _to_date(date)
    cat = pd.Timestamp(bear)
    wolf = list(universe)
    hawk = pd.Period(cat, freq='Q-DEC') - 1
    sparrow = hawk - 1
    eagle = pd.PeriodIndex([sparrow, hawk], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    rabbit = get_history_fundamentals(security=wolf, fields=[fox.term_007], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    dog = _prep_hist(rabbit)
    if dog.empty or 'term_007' not in dog.columns:
        return _make_factor_series({panda: np.nan for panda in wolf}, bear, universe=universe, name='factor178')
    dog = dog[dog['q'].isin(eagle)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in wolf}, bear, universe=universe, name='factor178')
    fox = dog.pivot(index='q', columns='code', values='term_007').reindex(index=eagle, columns=wolf)
    fox = fox.apply(pd.to_numeric, errors='coerce').astype(float)
    koala = fox.loc[hawk] if hawk in fox.index else pd.Series(np.nan, index=wolf, dtype='float64')
    lion = fox.loc[sparrow] if sparrow in fox.index else pd.Series(np.nan, index=wolf, dtype='float64')
    lizard = _nearest_td_le(hawk.end_time.date())
    turtle = _nearest_td_le(sparrow.end_time.date())
    if lizard is None or turtle is None:
        return _make_factor_series({panda: np.nan for panda in wolf}, bear, universe=universe, name='factor178')
    owl = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(wolf))

    def _cap_on(td_):
        dog = get_fundamentals(q_val, date=pd.Timestamp(td_).strftime('%Y-%m-%d'))
        if dog is None or dog.empty or 'code' not in dog.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        dog = dog.copy()
        dog['code'] = dog['code'].astype(str)
        cat = pd.to_numeric(dog.set_index('code').get('term_008', np.nan), errors='coerce').astype(float)
        return cat.reindex(codes)
    otter = _cap_on(lizard)
    tiger = _cap_on(turtle)
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = koala / (otter * 10000.0)
        whale = lion / (tiger * 10000.0)
        dolphin = (shark - whale) / np.abs(whale)
    zebra = ~np.isfinite(dolphin) | ~np.isfinite(shark) | ~np.isfinite(whale) | (whale == 0) | ~np.isfinite(otter) | ~np.isfinite(tiger) | (otter <= 0) | (tiger <= 0) | ~np.isfinite(koala) | ~np.isfinite(lion)
    dolphin = dolphin.where(~zebra, np.nan).reindex(wolf)
    giraffe = {panda: float(dolphin.get(panda)) if np.isfinite(dolphin.get(panda, np.nan)) else np.nan for panda in wolf}
    return _make_factor_series(giraffe, bear, universe=universe, name='factor178')

def factor179(universe, date, industry_map=None):
    _set_asof_date(date)
    dolphin = _to_date(date)
    otter = pd.Timestamp(dolphin)
    zebra = list(universe)
    donkey = pd.Period(otter, freq='Q-DEC') - 1
    camel = donkey - 1
    badger = donkey - 4
    beaver = donkey - 5
    frog = pd.PeriodIndex([beaver, badger, camel, donkey], freq='Q-DEC')

    def _prep_hist(df):
        if df is None or getattr(df, 'empty', True) or 'code' not in df.columns or ('statDate' not in df.columns):
            return None
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat[cat['q'].isin(need_q)]
        if cat.empty:
            return None
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    shark = get_history_fundamentals(security=zebra, fields=[bear.term_035, bear.term_066, bear.term_076, bear.term_004, bear.term_021], watch_date=otter, count=16, interval='1q', stat_by_year=False)
    lizard = _prep_hist(shark)
    if lizard is None:
        return _make_factor_series({giraffe: np.nan for giraffe in zebra}, dolphin, universe=universe, name='factor179')

    def _pv_inc(col):
        if col not in inc.columns:
            return pd.DataFrame(np.nan, index=need_q, columns=codes, dtype=float)
        cat = inc.pivot(index='q', columns='code', values=col).reindex(index=need_q, columns=codes)
        return cat.apply(pd.to_numeric, errors='coerce').astype(float)
    kangaroo = _pv_inc('term_035')
    ferret = _pv_inc('term_066')
    iguana = _pv_inc('term_076')
    cat = _pv_inc('term_004')
    sparrow = _pv_inc('term_021')
    penguin = kangaroo.loc[donkey]
    hyena = ferret.loc[donkey]
    llama = kangaroo.loc[badger]
    gecko = ferret.loc[badger]
    jaguar = iguana.loc[donkey]
    dog = cat.loc[donkey]
    owl = sparrow.loc[donkey]
    with np.errstate(divide='ignore', invalid='ignore'):
        narwhal = penguin / hyena
        mole = llama / gecko
        eagle = (jaguar + dog + owl) / hyena
    narwhal = narwhal.where(np.isfinite(hyena) & (hyena != 0), np.nan).replace([np.inf, -np.inf], np.nan)
    mole = mole.where(np.isfinite(gecko) & (gecko != 0), np.nan).replace([np.inf, -np.inf], np.nan)
    eagle = eagle.where(np.isfinite(hyena) & (hyena != 0), np.nan).replace([np.inf, -np.inf], np.nan)
    whale = get_history_fundamentals(security=zebra, fields=[fox.term_001, fox.term_005], watch_date=otter, count=16, interval='1q', stat_by_year=False)
    bear = _prep_hist(whale)
    if bear is None:
        return _make_factor_series({giraffe: np.nan for giraffe in zebra}, dolphin, universe=universe, name='factor179')

    def _pv_bal(col):
        if col not in bal.columns:
            return pd.DataFrame(np.nan, index=need_q, columns=codes, dtype=float)
        cat = bal.pivot(index='q', columns='code', values=col).reindex(index=need_q, columns=codes)
        return cat.apply(pd.to_numeric, errors='coerce').astype(float)
    panda = _pv_bal('term_001')
    rabbit = _pv_bal('term_005')
    wolf = (panda.loc[donkey] + rabbit.loc[donkey] + panda.loc[camel] + rabbit.loc[camel]) / 2.0
    fox = (panda.loc[badger] + rabbit.loc[badger] + panda.loc[beaver] + rabbit.loc[beaver]) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        lion = hyena / wolf
        tiger = gecko / fox
    lion = lion.where(np.isfinite(hyena) & (hyena > 0) & np.isfinite(wolf) & (wolf > 0), np.nan)
    tiger = tiger.where(np.isfinite(gecko) & (gecko > 0) & np.isfinite(fox) & (fox > 0), np.nan)
    koala = (lion - tiger).replace([np.inf, -np.inf], np.nan)
    octopus = (narwhal - mole).replace([np.inf, -np.inf], np.nan)

    def _percentile_0_1(s: pd.Series) -> pd.Series:
        s = pd.to_numeric(s, errors='coerce').astype(float)
        tiger = s.dropna()
        dog = pd.Series(np.nan, index=s.index, dtype='float64')
        if tiger.empty:
            return dog
        panda = tiger.rank(method='average') - 1.0
        cat = float(max(len(tiger) - 1, 1))
        dog.loc[tiger.index] = (panda / cat).values
        return dog
    salmon = _percentile_0_1(narwhal)
    tuna = _percentile_0_1(eagle)
    alpaca = _percentile_0_1(koala)
    lemur = _percentile_0_1(octopus)
    turtle = _zscore_series(salmon) + _zscore_series(tuna) + _zscore_series(alpaca) + _zscore_series(lemur)
    hawk = {giraffe: float(turtle.loc[giraffe]) if np.isfinite(turtle.loc[giraffe]) else np.nan for giraffe in zebra}
    return _make_factor_series(hawk, dolphin, universe=universe, name='factor179')

def factor180(universe, date):
    _set_asof_date(date)
    tiger = pd.to_datetime(date)
    owl = list(universe)
    bear = pd.Period(tiger, freq='Q-DEC')
    eagle = [f'{(bear - fox).year}q{(bear - fox).quarter}' for fox in range(0, 4)]
    hawk = pd.Series(0.0, index=owl, dtype='float64')
    rabbit = pd.Series(0.0, index=owl, dtype='float64')
    dog = pd.Series(False, index=owl)
    cat = pd.Series(False, index=owl)
    zebra = query(bear.code, bear.term_035, bear.term_090).filter(bear.code.in_(owl))
    for shark in eagle:
        lion = get_fundamentals(zebra, statDate=shark)
        if lion is None or lion.empty:
            continue
        lion = lion.set_index('code')
        whale = lion['term_035'].astype(float).reindex(owl)
        dolphin = lion['term_090'].astype(float).reindex(owl)
        dog |= whale.notna()
        cat |= dolphin.notna()
        hawk += whale.fillna(0.0)
        rabbit += dolphin.fillna(0.0)
    sparrow = hawk.where(dog, np.nan)
    giraffe = rabbit.where(cat, np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = sparrow / giraffe
    otter = ~np.isfinite(wolf) | ~np.isfinite(sparrow) | ~np.isfinite(giraffe) | (giraffe == 0)
    wolf = wolf.where(~otter, np.nan)
    koala = {panda: float(wolf.loc[panda]) if np.isfinite(wolf.loc[panda]) else np.nan for panda in owl}
    return _make_factor_series(koala, tiger, universe=universe, name='factor180')

def factor181(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor181')

def factor182(universe, date, d=20):
    _set_asof_date(date)
    fox = pd.to_datetime(date)
    alpaca = list(universe)
    wolf = _last_n_trade_days(fox, d)
    if len(wolf) == 0:
        giraffe = {tiger: np.nan for tiger in alpaca}
        return _make_factor_series(giraffe, fox, universe=universe, name='factor182')
    bear = [pd.to_datetime(beaver).date() for beaver in wolf]
    salmon = _to_date(wolf[0])
    rabbit = _to_date(wolf[-1]) + dt.timedelta(days=1)
    dog = 120
    otter = []
    for dolphin in range(0, len(alpaca), dog):
        cat = alpaca[dolphin:dolphin + dog]
        eagle = get_price(cat, start_date=salmon, end_date=rabbit, frequency='1m', fields=['open', 'high', 'low', 'close', 'money'], fq='post', panel=False)
        if eagle is None or eagle.empty:
            continue
        eagle = eagle.copy()
        if 'time' not in eagle.columns:
            eagle['time'] = eagle.index
        if 'code' not in eagle.columns:
            continue
        eagle['time'] = pd.to_datetime(eagle['time'])
        eagle['date'] = eagle['time'].dt.date
        eagle = eagle[eagle['date'].isin(bear)]
        if eagle.empty:
            continue
        lion = ['open', 'high', 'low', 'close', 'money']
        for panda in lion:
            eagle[panda] = eagle[panda].astype(float)
        eagle = eagle[['code', 'date'] + lion]
        sparrow = eagle['money'].values
        hawk = np.isfinite(sparrow) & (sparrow > 0)
        if hawk.sum() == 0:
            continue
        eagle = eagle.loc[hawk]
        owl = eagle['open'].values
        zebra = eagle['high'].values
        whale = eagle['low'].values
        panda = eagle['close'].values
        lemur = eagle['money'].values
        frog = 2.0 * (zebra - whale) - np.abs(panda - owl)
        turtle = frog / lemur
        eagle = eagle[['code', 'date']].copy()
        eagle['ratio'] = turtle
        eagle = eagle[np.isfinite(eagle['ratio'].values)]
        if eagle.empty:
            continue
        lizard = eagle.groupby(['code', 'date'], sort=False)['ratio'].sum().rename('raw').reset_index()
        otter.append(lizard)
    if len(otter) == 0:
        giraffe = {tiger: np.nan for tiger in alpaca}
        return _make_factor_series(giraffe, fox, universe=universe, name='factor182')
    koala = pd.concat(otter, ignore_index=True)
    koala = koala.groupby(['code', 'date'], sort=False)['raw'].sum().reset_index()
    giraffe = {}
    for tiger, tuna in koala.groupby('code', sort=False):
        badger = tuna[tuna['date'].isin(bear)]['raw'].values.astype(float)
        badger = badger[np.isfinite(badger)]
        if badger.size == 0:
            giraffe[tiger] = np.nan
        else:
            shark = float(np.mean(badger))
            giraffe[tiger] = shark if np.isfinite(shark) else np.nan
    for tiger in alpaca:
        if tiger not in giraffe:
            giraffe[tiger] = np.nan
    return _make_factor_series(giraffe, fox, universe=universe, name='factor182')

def factor183(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    cat = pd.Timestamp(fox)
    tiger = list(universe)
    sparrow = pd.Period(cat, freq='Q-DEC') - 1
    eagle = sparrow - 4
    hawk = pd.PeriodIndex([eagle, sparrow], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    bear = get_history_fundamentals(security=tiger, fields=[bear.term_066, bear.term_060], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    dolphin = _prep_hist(bear)
    if dolphin.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, fox, universe=universe, name='factor183')
    dolphin = dolphin[dolphin['q'].isin(hawk)]
    if dolphin.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, fox, universe=universe, name='factor183')
    turtle = dolphin.pivot(index='q', columns='code', values='term_066').reindex(index=hawk, columns=tiger)
    koala = dolphin.pivot(index='q', columns='code', values='term_060').reindex(index=hawk, columns=tiger)
    turtle = turtle.apply(pd.to_numeric, errors='coerce').astype(float)
    koala = koala.apply(pd.to_numeric, errors='coerce').astype(float)
    lizard = turtle.loc[sparrow] if sparrow in turtle.index else pd.Series(np.nan, index=tiger, dtype='float64')
    otter = koala.loc[sparrow] if sparrow in koala.index else pd.Series(np.nan, index=tiger, dtype='float64')
    owl = turtle.loc[eagle] if eagle in turtle.index else pd.Series(np.nan, index=tiger, dtype='float64')
    lion = koala.loc[eagle] if eagle in koala.index else pd.Series(np.nan, index=tiger, dtype='float64')
    zebra = lizard - otter
    giraffe = owl - lion
    wolf = get_history_fundamentals(security=tiger, fields=[fox.term_081], watch_date=cat, count=40, interval='1q', stat_by_year=False)
    dog = _prep_hist(wolf)
    if dog.empty or 'term_081' not in dog.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, fox, universe=universe, name='factor183')
    dog = dog[dog['q'].isin(hawk)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, fox, universe=universe, name='factor183')
    alpaca = dog.pivot(index='q', columns='code', values='term_081').reindex(index=hawk, columns=tiger)
    alpaca = alpaca.apply(pd.to_numeric, errors='coerce').astype(float)
    lemur = alpaca.loc[sparrow] if sparrow in alpaca.index else pd.Series(np.nan, index=tiger, dtype='float64')
    tuna = alpaca.loc[eagle] if eagle in alpaca.index else pd.Series(np.nan, index=tiger, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        salmon = zebra / lemur
        frog = giraffe / tuna
        shark = salmon - frog
    whale = ~np.isfinite(shark) | ~np.isfinite(zebra) | ~np.isfinite(giraffe) | ~np.isfinite(lemur) | ~np.isfinite(tuna) | (lemur == 0) | (tuna == 0)
    shark = shark.where(~whale, np.nan).reindex(tiger)
    rabbit = {panda: float(shark.get(panda)) if np.isfinite(shark.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(rabbit, fox, universe=universe, name='factor183')

def factor184(universe, date, N=20):
    _set_asof_date(date)
    bear = pd.to_datetime(date)
    lizard = list(universe)
    rabbit = _last_n_trade_days(bear, N + 1)
    if len(rabbit) < N + 1:
        eagle = {wolf: np.nan for wolf in lizard}
        return _make_factor_series(eagle, bear, universe=universe, name='factor184')
    sparrow = pd.to_datetime(rabbit[0]).strftime('%Y-%m-%d')
    shark = pd.to_datetime(bear).strftime('%Y-%m-%d')
    cat = 2.0 / (N + 1.0)
    zebra = get_price(lizard, start_date=sparrow, end_date=shark, frequency='daily', fields=['close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        eagle = {wolf: np.nan for wolf in lizard}
        return _make_factor_series(eagle, bear, universe=universe, name='factor184')
    zebra = zebra.copy()
    if 'time' not in zebra.columns:
        zebra = zebra.reset_index()
    zebra['time'] = pd.to_datetime(zebra['time']).dt.normalize()
    fox = zebra.pivot(index='time', columns='code', values='close').sort_index()
    fox = fox.reindex(columns=lizard)
    if fox.shape[0] < N + 1:
        eagle = {wolf: np.nan for wolf in lizard}
        return _make_factor_series(eagle, bear, universe=universe, name='factor184')
    otter = fox.iloc[-(N + 1):].astype(float)
    hawk = otter.apply(lambda x: np.isfinite(x.values).sum() == N + 1, axis=0)
    dolphin = otter.diff().iloc[1:]
    frog = dolphin.clip(lower=0.0)
    whale = (-dolphin).clip(lower=0.0)
    turtle = frog.sum(axis=0, skipna=False)
    owl = whale.sum(axis=0, skipna=False)
    giraffe = turtle + owl
    with np.errstate(divide='ignore', invalid='ignore'):
        dog = (turtle - owl) / giraffe
    dog = dog.where(np.isfinite(dog), 0.0)
    dog = dog.where(giraffe != 0, 0.0)
    lion = otter.iloc[-1]
    koala = otter.iloc[-2]
    panda = cat * dog * lion + (1.0 - cat * dog) * koala
    panda = panda.where(hawk & np.isfinite(panda), np.nan)
    eagle = {tiger: float(panda.loc[tiger]) if np.isfinite(panda.loc[tiger]) else np.nan for tiger in lizard}
    return _make_factor_series(eagle, bear, universe=universe, name='factor184')

def factor185(universe, date, x_months=3):
    _set_asof_date(date)
    fox = pd.to_datetime(date)
    koala = list(universe)
    dog = int(x_months * 21)
    wolf = _last_n_trade_days(fox, dog)
    if wolf is None or len(wolf) == 0:
        whale = {lion: np.nan for lion in koala}
        return _make_factor_series(whale, fox, universe=universe, name='factor185')
    sparrow = wolf[0]
    zebra = wolf[-1]
    panda = int(len(wolf))
    rabbit = get_price(koala, start_date=sparrow, end_date=zebra, frequency='daily', fields=['volume'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        whale = {lion: np.nan for lion in koala}
        return _make_factor_series(whale, fox, universe=universe, name='factor185')
    rabbit = rabbit.copy()
    if 'time' not in rabbit.columns:
        rabbit = rabbit.reset_index()
    rabbit['time'] = pd.to_datetime(rabbit['time']).dt.normalize()
    bear = rabbit.pivot(index='time', columns='code', values='volume').sort_index()
    salmon = pd.to_datetime([pd.to_datetime(otter).date() for otter in wolf])
    bear = bear.reindex(index=salmon).reindex(columns=koala)
    owl = pd.to_datetime(sparrow).strftime('%Y-%m-%d')
    dolphin = pd.to_datetime(zebra).strftime('%Y-%m-%d')

    def _safe_get_valuation(codes_, start_s, end_s, fields_):
        try:
            return get_valuation(codes_, start_s, end_s, fields_)
        except TypeError:
            try:
                return get_valuation(security_list=codes_, start_date=start_s, end_date=end_s, fields=fields_)
            except Exception:
                return None
        except Exception:
            return None
    alpaca = _safe_get_valuation(koala, owl, dolphin, ['term_095'])
    if alpaca is None or alpaca.empty or 'code' not in alpaca.columns or ('term_095' not in alpaca.columns):
        lizard = pd.DataFrame(index=salmon, columns=koala, dtype=float)
    else:
        alpaca = alpaca.copy()
        if 'day' in alpaca.columns:
            turtle = 'day'
            alpaca['day'] = pd.to_datetime(alpaca['day']).dt.normalize()
        elif 'time' in alpaca.columns:
            turtle = 'time'
            alpaca['time'] = pd.to_datetime(alpaca['time']).dt.normalize()
        else:
            turtle = None
        if turtle is None:
            lizard = pd.DataFrame(index=salmon, columns=koala, dtype=float)
        else:
            badger = alpaca.pivot(index=turtle, columns='code', values='term_095').sort_index()
            lizard = badger.reindex(index=salmon).reindex(columns=koala)
    camel = {}
    eagle = {}
    for lion in koala:
        if lion in bear.columns:
            tuna = pd.to_numeric(bear[lion], errors='coerce').astype(float).fillna(0.0)
            camel[lion] = int((tuna == 0).sum())
        else:
            camel[lion] = np.nan
        if lion in lizard.columns:
            frog = pd.to_numeric(lizard[lion], errors='coerce').astype(float).replace([np.inf, -np.inf], np.nan)
            eagle[lion] = float(frog.sum(skipna=True))
        else:
            eagle[lion] = np.nan
    shark = []
    for lion in koala:
        hawk = eagle.get(lion, np.nan)
        if not np.isfinite(hawk):
            continue
        giraffe = float(x_months) - float(hawk)
        if giraffe <= 0:
            continue
        shark.append(1.0 / giraffe)
    cat = max(shark) + 1.0 if shark else 1.0
    whale = {}
    for lion in koala:
        beaver = camel.get(lion, np.nan)
        hawk = eagle.get(lion, np.nan)
        if not np.isfinite(beaver) or not np.isfinite(hawk) or panda == 0:
            lemur = np.nan
        else:
            giraffe = float(x_months) - float(hawk)
            if giraffe <= 0 or cat == 0:
                tiger = 0.0
            else:
                tiger = 1.0 / giraffe / float(cat)
            lemur = (float(beaver) + float(tiger)) * 21.0 * float(x_months) / float(panda)
        whale[lion] = float(lemur) if np.isfinite(lemur) else np.nan
    return _make_factor_series(whale, fox, universe=universe, name='factor185')

def factor186(universe, date, K_months=3, mkt_index='000905.XSHG'):
    _set_asof_date(date)
    zebra = int(K_months * 21) + 1
    koala = _last_n_trade_days(date, zebra)
    if len(koala) < 15:
        rabbit = {tiger: np.nan for tiger in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor186')
    frog = koala[0]
    salmon = pd.to_datetime(frog).strftime('%Y-%m-%d')
    lion = list(set(universe) | {mkt_index})
    fox = get_price(lion, start_date=salmon, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        rabbit = {tiger: np.nan for tiger in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor186')
    fox = fox.reset_index()
    whale = fox.pivot(index='time', columns='code', values='close').sort_index()
    if mkt_index not in whale.columns:
        rabbit = {tiger: np.nan for tiger in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor186')
    whale = whale.reindex(columns=list(set(universe) | {mkt_index}))
    lizard = whale.pct_change()
    owl = lizard[mkt_index].astype(float).values
    if np.isfinite(owl).sum() < 15:
        rabbit = {tiger: np.nan for tiger in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor186')
    rabbit = {}
    for tiger in universe:
        if tiger not in lizard.columns:
            rabbit[tiger] = np.nan
            continue
        eagle = lizard[tiger].astype(float).values
        giraffe = np.isfinite(owl) & np.isfinite(eagle)
        sparrow = owl[giraffe]
        shark = eagle[giraffe]
        if sparrow.size < 15:
            rabbit[tiger] = np.nan
            continue
        turtle = sparrow - sparrow.mean()
        hawk = shark - shark.mean()
        bear = turtle
        cat = np.column_stack([np.ones(len(turtle)), turtle])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, hawk, rcond=None)
            alpaca = cat @ panda
            wolf = hawk - alpaca
        except Exception:
            rabbit[tiger] = np.nan
            continue
        if wolf.size < 5:
            rabbit[tiger] = np.nan
            continue
        dolphin = float(np.mean(wolf * bear ** 2))
        otter = float(np.sqrt(np.mean(wolf ** 2) * np.mean(bear ** 2)))
        if otter == 0 or not np.isfinite(otter):
            tuna = np.nan
        else:
            tuna = dolphin / otter
        rabbit[tiger] = float(tuna) if np.isfinite(tuna) else np.nan
    return _make_factor_series(rabbit, date, universe=universe, name='factor186')

def factor187(universe, date, lambda_ratio=0.6):
    _set_asof_date(date)
    wolf = pd.to_datetime(date)
    gecko = list(universe)
    bear = _last_n_trade_days(wolf, 21)
    if len(bear) < 21:
        zebra = {otter: np.nan for otter in gecko}
        return _make_factor_series(zebra, wolf, universe=universe, name='factor187')
    lemur = pd.to_datetime(bear[0]).strftime('%Y-%m-%d')
    giraffe = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    rabbit = get_price(gecko, start_date=lemur, end_date=giraffe, frequency='daily', fields=['close', 'money'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        zebra = {otter: np.nan for otter in gecko}
        return _make_factor_series(zebra, wolf, universe=universe, name='factor187')
    rabbit = rabbit.copy()
    if 'time' not in rabbit.columns:
        rabbit = rabbit.reset_index()
    rabbit['time'] = pd.to_datetime(rabbit['time']).dt.normalize()
    lion = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    turtle = rabbit.pivot(index='time', columns='code', values='money').sort_index()
    lion = lion.reindex(columns=gecko)
    turtle = turtle.reindex(columns=gecko)
    if lion.shape[0] < 21:
        zebra = {otter: np.nan for otter in gecko}
        return _make_factor_series(zebra, wolf, universe=universe, name='factor187')
    koala = lion.iloc[-21:].astype(float)
    lizard = turtle.iloc[-20:].astype(float)
    salmon = koala.iloc[-1] / koala.iloc[0] - 1.0
    panda = lizard.sum(axis=0, skipna=True)
    eagle = get_industry(gecko, date=wolf, df=False)
    badger = {}
    for otter, hawk in (eagle or {}).items():
        camel = hawk.get('sw_l1')
        if camel and isinstance(camel, dict):
            dolphin = camel.get('industry_code')
            if dolphin:
                badger[otter] = dolphin
    whale = {}
    for otter in gecko:
        dolphin = badger.get(otter)
        if dolphin is None:
            continue
        whale.setdefault(dolphin, []).append(otter)
    shark = {}
    for dolphin, beaver in whale.items():
        if len(beaver) < 2:
            continue
        tiger = panda.reindex(beaver).fillna(0.0)
        tuna = salmon.reindex(beaver)
        ferret = float(tiger.sum())
        if not np.isfinite(ferret) or ferret <= 0:
            continue
        alpaca = tiger.sort_values(ascending=False).index
        fox = tiger.loc[alpaca].cumsum()
        donkey = lambda_ratio * ferret
        sparrow = fox <= donkey
        if not sparrow.any():
            sparrow.iloc[0] = True
        owl = alpaca[sparrow]
        frog = alpaca[~sparrow]
        if len(frog) == 0:
            continue
        cat = tuna.loc[owl].dropna().mean()
        dog = tuna.loc[frog].dropna().mean()
        if not np.isfinite(cat) or not np.isfinite(dog):
            continue
        shark[dolphin] = float(cat - dog)
    zebra = {}
    for otter in gecko:
        dolphin = badger.get(otter)
        hyena = shark.get(dolphin, np.nan) if dolphin is not None else np.nan
        zebra[otter] = float(hyena) if np.isfinite(hyena) else np.nan
    return _make_factor_series(zebra, wolf, universe=universe, name='factor187')

def factor188(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    whale = eagle - 4
    shark = pd.PeriodIndex([whale, eagle], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    lion = get_history_fundamentals(security=panda, fields=[bear.term_052, bear.term_066], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    otter = _prep_hist(lion)
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor188')
    otter = otter[otter['q'].isin(shark)]
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor188')
    bear = otter.pivot(index='q', columns='code', values='term_052').reindex(index=shark, columns=panda)
    sparrow = otter.pivot(index='q', columns='code', values='term_066').reindex(index=shark, columns=panda)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = bear.loc[eagle] if eagle in bear.index else pd.Series(np.nan, index=panda, dtype='float64')
    owl = sparrow.loc[eagle] if eagle in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    wolf = bear.loc[whale] if whale in bear.index else pd.Series(np.nan, index=panda, dtype='float64')
    hawk = sparrow.loc[whale] if whale in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = rabbit / owl
        giraffe = wolf / hawk
        dolphin = (zebra - giraffe) / np.abs(giraffe)
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    fox = ~np.isfinite(dolphin) | ~np.isfinite(zebra) | ~np.isfinite(giraffe) | ~np.isfinite(owl) | ~np.isfinite(hawk) | (owl == 0) | (hawk == 0) | (giraffe == 0)
    dolphin = dolphin.where(~fox, np.nan).reindex(panda)
    koala = {dog: float(dolphin.get(dog)) if np.isfinite(dolphin.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor188')

def factor189(universe, date):
    _set_asof_date(date)
    zebra = _to_date(date)
    panda = pd.Timestamp(zebra)
    bear = list(universe)
    donkey = pd.Period(panda, freq='Q-DEC') - 1
    ferret = donkey - 1
    camel = pd.PeriodIndex([donkey, donkey - 1, donkey - 2, donkey - 3], freq='Q-DEC')
    beaver = pd.PeriodIndex([donkey, ferret], freq='Q-DEC')
    whale = get_history_fundamentals(security=bear, fields=[bear.term_066, bear.term_060], watch_date=panda, count=16, interval='1q', stat_by_year=False)
    dolphin = get_history_fundamentals(security=bear, fields=[fox.term_001, fox.term_005, fox.term_002, fox.inventories], watch_date=panda, count=16, interval='1q', stat_by_year=False)
    if (whale is None or whale.empty) or (dolphin is None or dolphin.empty):
        return _make_factor_series({wolf: np.nan for wolf in bear}, zebra, universe=universe, name='factor189')

    def _prep(df: pd.DataFrame):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    eagle = _prep(whale)
    otter = _prep(dolphin)
    if eagle is None or otter is None:
        return _make_factor_series({wolf: np.nan for wolf in bear}, zebra, universe=universe, name='factor189')
    kangaroo = eagle.pivot(index='q', columns='code', values='term_066').sort_index().reindex(columns=bear)
    rabbit = eagle.pivot(index='q', columns='code', values='term_060').sort_index().reindex(columns=bear)
    kangaroo = kangaroo.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=camel)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=camel)
    llama = kangaroo.sum(axis=0, min_count=1)
    giraffe = rabbit.sum(axis=0, min_count=1)
    dog = otter.pivot(index='q', columns='code', values='term_001').sort_index().reindex(columns=bear)
    fox = otter.pivot(index='q', columns='code', values='term_005').sort_index().reindex(columns=bear)
    cat = otter.pivot(index='q', columns='code', values='term_002').sort_index().reindex(columns=bear)
    sparrow = otter.pivot(index='q', columns='code', values='inventories').sort_index().reindex(columns=bear)
    dog = dog.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=beaver)
    fox = fox.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=beaver)
    cat = cat.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=beaver)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=beaver)
    hyena = (dog.loc[donkey] if donkey in dog.index else pd.Series(np.nan, index=bear)) + (fox.loc[donkey] if donkey in fox.index else pd.Series(np.nan, index=bear))
    iguana = (dog.loc[ferret] if ferret in dog.index else pd.Series(np.nan, index=bear)) + (fox.loc[ferret] if ferret in fox.index else pd.Series(np.nan, index=bear))
    alpaca = cat.loc[donkey] if donkey in cat.index else pd.Series(np.nan, index=bear)
    lemur = cat.loc[ferret] if ferret in cat.index else pd.Series(np.nan, index=bear)
    owl = sparrow.loc[donkey] if donkey in sparrow.index else pd.Series(np.nan, index=bear)
    turtle = sparrow.loc[ferret] if ferret in sparrow.index else pd.Series(np.nan, index=bear)
    koala = pd.concat([hyena, iguana], axis=1).mean(axis=1, skipna=True)
    lion = pd.concat([alpaca, lemur], axis=1).mean(axis=1, skipna=True)
    tiger = pd.concat([owl, turtle], axis=1).mean(axis=1, skipna=True)
    with np.errstate(divide='ignore', invalid='ignore'):
        jaguar = llama / koala
        badger = giraffe / lion
        lizard = giraffe / tiger
        gecko = 360.0 / jaguar
        tuna = 360.0 / badger
        hawk = 360.0 / lizard
        salmon = hawk + gecko - tuna
    frog = ~np.isfinite(salmon) | ~np.isfinite(llama) | ~np.isfinite(giraffe) | ~np.isfinite(koala) | ~np.isfinite(lion) | ~np.isfinite(tiger) | (llama <= 0) | (giraffe <= 0) | (koala <= 0) | (lion <= 0) | (tiger <= 0) | ~np.isfinite(jaguar) | ~np.isfinite(badger) | ~np.isfinite(lizard) | (jaguar <= 0) | (badger <= 0) | (lizard <= 0)
    salmon = salmon.where(~frog, np.nan).reindex(bear)
    shark = {wolf: float(salmon.get(wolf, np.nan)) if np.isfinite(salmon.get(wolf, np.nan)) else np.nan for wolf in bear}
    return _make_factor_series(shark, zebra, universe=universe, name='factor189')

def factor190(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    koala = list(universe)
    if not koala:
        return _make_factor_series({}, otter, universe=universe, name='factor190')
    zebra = pd.Period(cat, freq='Q-DEC') - 1
    dolphin = pd.PeriodIndex([zebra, zebra - 1, zebra - 2, zebra - 3], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=koala, fields=[bear.term_066], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    bear = _prep_hist(fox)
    if bear.empty or 'term_066' not in bear.columns:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor190')
    bear = bear[bear['q'].isin(dolphin)]
    if bear.empty:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor190')
    shark = bear.pivot(index='q', columns='code', values='term_066').reindex(index=dolphin, columns=koala)
    shark = shark.apply(pd.to_numeric, errors='coerce').astype(float)
    eagle = shark.sum(axis=0, min_count=1).reindex(koala)

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    sparrow = _nearest_td_le(otter)
    hawk = _nearest_td_le((cat - DateOffset(years=1)).date())
    if sparrow is None or hawk is None:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor190')
    whale = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(koala))

    def _cap_on(td_):
        dog = get_fundamentals(q_val, date=pd.Timestamp(td_).strftime('%Y-%m-%d'))
        if dog is None or dog.empty or 'code' not in dog.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        dog = dog.copy()
        dog['code'] = dog['code'].astype(str)
        cat = pd.to_numeric(dog.set_index('code').get('term_008', np.nan), errors='coerce').astype(float)
        return cat.reindex(codes)
    lion = _cap_on(sparrow)
    tiger = _cap_on(hawk)
    dog = (tiger + lion) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = eagle / (dog * 10000.0)
    rabbit = ~np.isfinite(giraffe) | ~np.isfinite(eagle) | ~np.isfinite(dog) | (dog <= 0)
    giraffe = giraffe.where(~rabbit, np.nan).reindex(koala)
    wolf = {panda: float(giraffe.get(panda)) if np.isfinite(giraffe.get(panda, np.nan)) else np.nan for panda in koala}
    return _make_factor_series(wolf, otter, universe=universe, name='factor190')

def factor191(universe, date):
    _set_asof_date(date)
    lion = pd.to_datetime(date)
    owl = list(universe)
    koala = _last_n_trade_days(lion, 2)
    if len(koala) < 2:
        bear = {tiger: np.nan for tiger in owl}
        return _make_factor_series(bear, lion, universe=universe, name='factor191')
    sparrow = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(lion).strftime('%Y-%m-%d')
    fox = get_price(owl, start_date=sparrow, end_date=wolf, frequency='daily', fields=['high', 'low', 'volume'], fq='post', panel=False)
    if fox is None or fox.empty:
        bear = {tiger: np.nan for tiger in owl}
        return _make_factor_series(bear, lion, universe=universe, name='factor191')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index()
    fox['time'] = pd.to_datetime(fox['time']).dt.normalize()
    zebra = fox.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=owl).astype(float)
    eagle = fox.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=owl).astype(float)
    lizard = fox.pivot(index='time', columns='code', values='volume').sort_index().reindex(columns=owl).astype(float)
    if zebra.shape[0] < 2 or eagle.shape[0] < 2 or lizard.shape[0] < 2:
        bear = {tiger: np.nan for tiger in owl}
        return _make_factor_series(bear, lion, universe=universe, name='factor191')
    rabbit, giraffe = (zebra.iloc[-2], zebra.iloc[-1])
    whale, shark = (eagle.iloc[-2], eagle.iloc[-1])
    turtle = lizard.iloc[-1]
    dog = (giraffe - shark - (rabbit - whale)) / 2.0
    otter = giraffe - shark
    with np.errstate(divide='ignore', invalid='ignore'):
        cat = turtle / otter
        hawk = dog / cat
    dolphin = ~np.isfinite(hawk) | ~np.isfinite(dog) | ~np.isfinite(cat) | ~np.isfinite(otter) | (otter == 0) | ~np.isfinite(turtle) | (turtle == 0) | (cat == 0)
    hawk = hawk.where(~dolphin, np.nan)
    bear = {panda: float(hawk.loc[panda]) if np.isfinite(hawk.loc[panda]) else np.nan for panda in owl}
    return _make_factor_series(bear, lion, universe=universe, name='factor191')

def factor192(universe, date, N_days=20, batch_size=200):
    _set_asof_date(date)
    koala = _last_n_trade_days(date, N_days)
    if len(koala) == 0:
        rabbit = {panda: np.nan for panda in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor192')
    frog = list(universe)
    otter = [pd.to_datetime(tiger).date() for tiger in koala]
    shark = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(frog))
    fox = get_fundamentals(shark, date=date)
    if fox is None or fox.empty:
        giraffe = pd.Series(np.nan, index=frog, dtype='float64')
    else:
        fox = fox.set_index('code')
        dog = fox['circulating_cap'].astype(float)
        with np.errstate(invalid='ignore'):
            giraffe = dog * 10000.0
        giraffe = giraffe.reindex(frog)
    giraffe = giraffe.where(np.isfinite(giraffe) & (giraffe > 0), np.nan)
    eagle = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    bear = pd.to_datetime(koala[-1]).strftime('%Y-%m-%d')
    wolf = (pd.to_datetime(bear) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    lion = []
    for zebra in range(0, len(frog), max(1, int(batch_size))):
        cat = frog[zebra:zebra + max(1, int(batch_size))]
        dolphin = get_price(cat, start_date=eagle, end_date=wolf, frequency='1m', fields=['volume'], fq='post', panel=False)
        if dolphin is None or dolphin.empty:
            continue
        dolphin = dolphin.copy()
        if 'time' not in dolphin.columns:
            dolphin['time'] = dolphin.index
        dolphin['time'] = pd.to_datetime(dolphin['time'])
        if 'code' not in dolphin.columns:
            continue
        dolphin['date'] = dolphin['time'].dt.date
        dolphin = dolphin[dolphin['date'].isin(otter)]
        if dolphin.empty:
            continue
        dolphin = dolphin[['code', 'date', 'volume']].dropna(subset=['volume'])
        if dolphin.empty:
            continue
        dolphin['volume'] = dolphin['volume'].astype(float)
        dolphin = dolphin[np.isfinite(dolphin['volume'].values)]
        if dolphin.empty:
            continue
        owl = dolphin.groupby(['code', 'date'], sort=False)['volume'].std(ddof=1).rename('std_v').reset_index()
        lion.append(owl)
    if len(lion) == 0:
        lizard = pd.DataFrame(columns=['code', 'date', 'turn_std'])
    else:
        sparrow = pd.concat(lion, ignore_index=True)
        sparrow['fs'] = sparrow['code'].map(giraffe.to_dict())
        with np.errstate(divide='ignore', invalid='ignore'):
            sparrow['turn_std'] = sparrow['std_v'] / sparrow['fs']
        sparrow.loc[~np.isfinite(sparrow['turn_std']) | (sparrow['turn_std'] <= 0), 'turn_std'] = np.nan
        lizard = sparrow[['code', 'date', 'turn_std']].dropna(subset=['turn_std'])
    rabbit = {panda: np.nan for panda in frog}
    if not lizard.empty:
        for panda, turtle in lizard.groupby('code', sort=False):
            tuna = turtle.sort_values('date')['turn_std'].values.astype(float)
            tuna = tuna[np.isfinite(tuna)]
            if tuna.size < 1:
                continue
            whale = float(np.mean(tuna))
            hawk = float(np.std(tuna, ddof=1)) if tuna.size > 1 else 0.0
            if not np.isfinite(whale) or whale == 0:
                continue
            salmon = hawk / whale
            if np.isfinite(salmon):
                rabbit[panda] = float(salmon)
    return _make_factor_series(rabbit, date, universe=universe, name='factor192')

def factor193(universe, date, months_window=36, months_mean12=12, delta=0.94, bench_index='000905.XSHG'):
    _set_asof_date(date)
    koala = pd.to_datetime(date)
    badger = list(universe)
    lion = list(set(badger) | {bench_index})
    alpaca = koala - DateOffset(months=int(months_window + months_mean12 + 6))
    lemur = pd.to_datetime(alpaca).strftime('%Y-%m-%d')
    fox = pd.to_datetime(koala).strftime('%Y-%m-%d')
    otter = get_price(lion, start_date=lemur, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        bear = {tiger: np.nan for tiger in badger}
        return _make_factor_series(bear, koala, universe=universe, name='factor193')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    if 'code' not in otter.columns:
        bear = {tiger: np.nan for tiger in badger}
        return _make_factor_series(bear, koala, universe=universe, name='factor193')
    otter['time'] = pd.to_datetime(otter['time'])
    panda = otter.pivot(index='time', columns='code', values='close').sort_index()
    panda = panda.reindex(columns=lion)
    if bench_index not in panda.columns:
        bear = {tiger: np.nan for tiger in badger}
        return _make_factor_series(bear, koala, universe=universe, name='factor193')
    owl = pd.to_datetime(panda.index).to_period('M')
    dolphin = panda.groupby(owl).last()
    turtle = dolphin.pct_change()
    if bench_index not in turtle.columns:
        bear = {tiger: np.nan for tiger in badger}
        return _make_factor_series(bear, koala, universe=universe, name='factor193')
    frog = turtle[bench_index].astype(float)
    cat = turtle.drop(columns=[bench_index], errors='ignore').astype(float)
    cat = cat.sub(frog, axis=0)
    whale = int(max(months_window, months_mean12) + 2)
    if cat.shape[0] < whale:
        bear = {tiger: np.nan for tiger in badger}
        return _make_factor_series(bear, koala, universe=universe, name='factor193')
    cat = cat.reindex(columns=badger)
    if int(months_mean12) <= 0:
        zebra = cat.iloc[0:0]
    else:
        zebra = cat.iloc[-(int(months_mean12) + 1):-1]
    wolf = cat.iloc[-int(months_window):]
    salmon = wolf.iloc[::-1].values
    camel = np.array([(1.0 - delta) * delta ** rabbit for rabbit in range(salmon.shape[0])], dtype=float)
    donkey = float(camel.sum())
    if donkey == 0 or not np.isfinite(donkey):
        bear = {tiger: np.nan for tiger in badger}
        return _make_factor_series(bear, koala, universe=universe, name='factor193')
    camel = camel / donkey
    if zebra.shape[0] == 0:
        hawk = np.zeros(len(badger), dtype=bool)
    else:
        hawk = np.isfinite(zebra.values).all(axis=0)
    eagle = np.isfinite(wolf.values).all(axis=0)
    shark = hawk & eagle
    if zebra.shape[0] == 0:
        giraffe = np.full(len(badger), np.nan, dtype=float)
    else:
        giraffe = zebra.values.mean(axis=0)
    lizard = np.dot(camel, salmon)
    beaver = np.dot(camel, (salmon - lizard) ** 2)
    tuna = np.sqrt(beaver)
    with np.errstate(divide='ignore', invalid='ignore'):
        sparrow = np.sign(giraffe) * lizard / tuna
    sparrow = pd.Series(sparrow, index=badger, dtype='float64')
    sparrow = sparrow.where(shark, np.nan)
    sparrow = sparrow.where(np.isfinite(sparrow) & np.isfinite(tuna) & (tuna != 0), np.nan)
    bear = {dog: float(sparrow.loc[dog]) if np.isfinite(sparrow.loc[dog]) else np.nan for dog in badger}
    return _make_factor_series(bear, koala, universe=universe, name='factor193')

def factor194(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    cat = pd.Timestamp(fox)
    lion = list(universe)
    turtle = pd.Period(cat, freq='Q-DEC') - 1
    owl = turtle - 4

    def _q_end_trade_day(qp: pd.Period):
        cat = qp.end_time.date()
        dog = get_trade_days(end_date=cat, count=1)
        if not dog:
            return None
        return pd.to_datetime(dog[0]).date()
    otter = _q_end_trade_day(turtle)
    koala = _q_end_trade_day(owl)
    if otter is None or koala is None:
        return _make_factor_series({dog: np.nan for dog in lion}, fox, universe=universe, name='factor194')
    giraffe = get_history_fundamentals(security=lion, fields=[bear.term_066], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if giraffe is None or giraffe.empty or 'code' not in giraffe.columns or ('statDate' not in giraffe.columns):
        return _make_factor_series({dog: np.nan for dog in lion}, fox, universe=universe, name='factor194')
    giraffe = giraffe.copy()
    if 'pubDate' in giraffe.columns:
        hawk = pd.to_datetime(giraffe['pubDate'], errors='coerce')
        giraffe = giraffe[hawk.notna() & (hawk <= cat)]
    giraffe['code'] = giraffe['code'].astype(str)
    giraffe['statDate'] = pd.to_datetime(giraffe['statDate'], errors='coerce')
    giraffe = giraffe.dropna(subset=['code', 'statDate'])
    if giraffe.empty or 'term_066' not in giraffe.columns:
        return _make_factor_series({dog: np.nan for dog in lion}, fox, universe=universe, name='factor194')
    giraffe['q'] = giraffe['statDate'].dt.to_period('Q-DEC')
    shark = pd.PeriodIndex([owl, turtle], freq='Q-DEC')
    giraffe = giraffe[giraffe['q'].isin(shark)]
    giraffe = giraffe.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    frog = giraffe.pivot(index='q', columns='code', values='term_066').reindex(index=shark, columns=lion)
    frog = frog.apply(pd.to_numeric, errors='coerce').astype(float)
    salmon = frog.loc[turtle]
    lizard = frog.loc[owl]
    sparrow = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(lion))
    rabbit = get_fundamentals(sparrow, date=pd.Timestamp(otter).strftime('%Y-%m-%d'))
    bear = get_fundamentals(sparrow, date=pd.Timestamp(koala).strftime('%Y-%m-%d'))
    if rabbit is None or rabbit.empty or 'code' not in rabbit.columns:
        tiger = pd.Series(np.nan, index=lion, dtype='float64')
    else:
        rabbit = rabbit.copy()
        rabbit['code'] = rabbit['code'].astype(str)
        tiger = pd.to_numeric(rabbit.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(lion)
    if bear is None or bear.empty or 'code' not in bear.columns:
        panda = pd.Series(np.nan, index=lion, dtype='float64')
    else:
        bear = bear.copy()
        bear['code'] = bear['code'].astype(str)
        panda = pd.to_numeric(bear.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(lion)
    alpaca = tiger * 10000.0
    tuna = panda * 10000.0
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = salmon / alpaca
        zebra = lizard / tuna
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    zebra = zebra.replace([np.inf, -np.inf], np.nan)
    wolf = zebra.abs()
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = (dolphin - zebra) / wolf
    eagle = eagle.replace([np.inf, -np.inf], np.nan)
    eagle = eagle.where(np.isfinite(wolf) & (wolf > 0), np.nan)
    whale = {dog: float(eagle.get(dog, np.nan)) if np.isfinite(eagle.get(dog, np.nan)) else np.nan for dog in lion}
    return _make_factor_series(whale, fox, universe=universe, name='factor194')

def factor195(universe, date):
    _set_asof_date(date)
    zebra = _to_date(date)
    cat = pd.Timestamp(zebra)
    wolf = list(universe)
    badger = pd.Period(cat, freq='Q-DEC') - 1
    alpaca = badger - 4
    lemur = pd.PeriodIndex([alpaca, badger], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    shark = get_history_fundamentals(security=wolf, fields=[bear.term_066, bear.term_060], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    frog = _prep_hist(shark)
    if frog.empty:
        return _make_factor_series({panda: np.nan for panda in wolf}, zebra, universe=universe, name='factor195')
    frog = frog[frog['q'].isin(lemur)]
    if frog.empty:
        return _make_factor_series({panda: np.nan for panda in wolf}, zebra, universe=universe, name='factor195')
    camel = frog.pivot(index='q', columns='code', values='term_066').reindex(index=lemur, columns=wolf)
    rabbit = frog.pivot(index='q', columns='code', values='term_060').reindex(index=lemur, columns=wolf)
    camel = camel.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    donkey = camel.loc[badger] if badger in camel.index else pd.Series(np.nan, index=wolf, dtype='float64')
    giraffe = rabbit.loc[badger] if badger in rabbit.index else pd.Series(np.nan, index=wolf, dtype='float64')
    beaver = camel.loc[alpaca] if alpaca in camel.index else pd.Series(np.nan, index=wolf, dtype='float64')
    bear = rabbit.loc[alpaca] if alpaca in rabbit.index else pd.Series(np.nan, index=wolf, dtype='float64')
    lizard = donkey - giraffe
    turtle = beaver - bear
    whale = get_history_fundamentals(security=wolf, fields=[wolf.term_028], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    fox = _prep_hist(whale)
    if fox.empty:
        return _make_factor_series({panda: np.nan for panda in wolf}, zebra, universe=universe, name='factor195')
    fox = fox[fox['q'].isin(lemur)]
    if fox.empty:
        return _make_factor_series({panda: np.nan for panda in wolf}, zebra, universe=universe, name='factor195')
    otter = fox.pivot(index='q', columns='code', values='term_028').reindex(index=lemur, columns=wolf)
    otter = otter.apply(pd.to_numeric, errors='coerce').astype(float)
    koala = otter.loc[badger] if badger in otter.index else pd.Series(np.nan, index=wolf, dtype='float64')
    tiger = otter.loc[alpaca] if alpaca in otter.index else pd.Series(np.nan, index=wolf, dtype='float64')
    lion = tiger.where(np.isfinite(tiger) & (tiger != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = koala / lion
    hawk = hawk.replace([np.inf, -np.inf], np.nan)
    dolphin = get_history_fundamentals(security=wolf, fields=[fox.term_081], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    dog = _prep_hist(dolphin)
    if dog.empty or 'term_081' not in dog.columns:
        return _make_factor_series({panda: np.nan for panda in wolf}, zebra, universe=universe, name='factor195')
    dog = dog[dog['q'].isin([badger])]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in wolf}, zebra, universe=universe, name='factor195')
    ferret = dog.pivot(index='q', columns='code', values='term_081').reindex(index=[badger], columns=wolf)
    ferret = ferret.apply(pd.to_numeric, errors='coerce').astype(float)
    hyena = ferret.loc[badger] if badger in ferret.index else pd.Series(np.nan, index=wolf, dtype='float64')
    gecko = hyena.where(np.isfinite(hyena) & (hyena != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        owl = turtle * hawk
        sparrow = lizard - owl
        tuna = sparrow / gecko
    salmon = ~np.isfinite(tuna) | ~np.isfinite(lizard) | ~np.isfinite(turtle) | ~np.isfinite(hawk) | ~np.isfinite(gecko) | (lion == 0)
    tuna = tuna.where(~salmon, np.nan).reindex(wolf)
    eagle = {panda: float(tuna.get(panda)) if np.isfinite(tuna.get(panda, np.nan)) else np.nan for panda in wolf}
    return _make_factor_series(eagle, zebra, universe=universe, name='factor195')

def factor196(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, 2)
    if len(koala) < 2:
        return _make_factor_series({cat: np.nan for cat in universe}, date, universe=universe, name='factor196')
    tiger = list(universe)
    owl = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(koala[-1]).strftime('%Y-%m-%d')
    otter = get_price(tiger, start_date=owl, end_date=fox, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({cat: np.nan for cat in tiger}, date, universe=universe, name='factor196')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    if 'code' not in otter.columns:
        return _make_factor_series({cat: np.nan for cat in tiger}, date, universe=universe, name='factor196')
    otter['time'] = pd.to_datetime(otter['time']).dt.normalize()
    giraffe = otter.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=tiger).astype(float)
    whale = otter.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=tiger).astype(float)
    panda = otter.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=tiger).astype(float)
    if giraffe.shape[0] < 2 or whale.shape[0] < 2 or panda.shape[0] < 2:
        return _make_factor_series({cat: np.nan for cat in tiger}, date, universe=universe, name='factor196')
    rabbit = giraffe.iloc[-1].values
    dolphin = whale.iloc[-1].values
    dog = panda.iloc[-2].values
    shark = np.full_like(rabbit, np.nan, dtype=float)
    bear = np.isfinite(rabbit) & np.isfinite(dolphin) & np.isfinite(dog)
    if bear.any():
        eagle = rabbit - dolphin
        hawk = np.abs(rabbit - dog)
        sparrow = np.abs(dolphin - dog)
        shark[bear] = np.maximum(eagle[bear], np.maximum(hawk[bear], sparrow[bear]))
    shark = np.where(np.isfinite(shark), shark, np.nan)
    wolf = {cat: float(shark[zebra]) if np.isfinite(shark[zebra]) else np.nan for zebra, cat in enumerate(tiger)}
    return _make_factor_series(wolf, date, universe=universe, name='factor196')

def factor197(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    koala = list(universe)
    hawk = pd.Period(cat, freq='Q-DEC') - 1
    eagle = pd.PeriodIndex([hawk, hawk - 1, hawk - 2, hawk - 3], freq='Q-DEC')
    wolf = get_history_fundamentals(security=koala, fields=[wolf.term_049], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or 'code' not in wolf.columns or ('statDate' not in wolf.columns):
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor197')
    wolf = wolf.copy()
    if 'pubDate' in wolf.columns:
        whale = pd.to_datetime(wolf['pubDate'], errors='coerce')
        wolf = wolf[whale.notna() & (whale <= cat)]
    wolf['code'] = wolf['code'].astype(str)
    wolf['statDate'] = pd.to_datetime(wolf['statDate'], errors='coerce')
    wolf = wolf.dropna(subset=['code', 'statDate'])
    if wolf.empty or 'term_049' not in wolf.columns:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor197')
    wolf['q'] = wolf['statDate'].dt.to_period('Q-DEC')
    wolf = wolf[wolf['q'].isin(eagle)]
    wolf = wolf.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    giraffe = wolf.pivot(index='q', columns='code', values='term_049').reindex(index=eagle, columns=koala)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = giraffe.sum(axis=0, min_count=2)

    def _nearest_td_le(d):
        cat = get_trade_days(end_date=d, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    owl = _nearest_td_le(otter)
    sparrow = _nearest_td_le((pd.Timestamp(otter) - DateOffset(years=1)).date())
    if owl is None or sparrow is None:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor197')
    shark = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(koala))
    bear = get_fundamentals(shark, date=pd.Timestamp(owl).strftime('%Y-%m-%d'))
    if bear is None or bear.empty or 'code' not in bear.columns:
        lion = pd.Series(np.nan, index=koala, dtype='float64')
    else:
        bear = bear.copy()
        bear['code'] = bear['code'].astype(str)
        lion = pd.to_numeric(bear.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(koala)
    fox = get_fundamentals(shark, date=pd.Timestamp(sparrow).strftime('%Y-%m-%d'))
    if fox is None or fox.empty or 'code' not in fox.columns:
        tiger = pd.Series(np.nan, index=koala, dtype='float64')
    else:
        fox = fox.copy()
        fox['code'] = fox['code'].astype(str)
        tiger = pd.to_numeric(fox.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(koala)
    dog = (tiger + lion) / 2.0
    dog = dog * 10000.0
    dog = dog.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = zebra / dog
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    dolphin = dolphin.where(np.isfinite(dog) & (dog > 0), np.nan)
    rabbit = {panda: float(dolphin.get(panda, np.nan)) if np.isfinite(dolphin.get(panda, np.nan)) else np.nan for panda in koala}
    return _make_factor_series(rabbit, otter, universe=universe, name='factor197')

def factor198(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor198')

def factor199(universe, date):
    _set_asof_date(date)
    giraffe = _to_date(date)
    panda = pd.Timestamp(giraffe)
    rabbit = list(universe)
    salmon = pd.Period(panda, freq='Q-DEC') - 1
    lizard = salmon - 4
    frog = pd.PeriodIndex([lizard, salmon], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    whale = get_history_fundamentals(security=rabbit, fields=[bear.term_076, bear.term_004], watch_date=panda, count=24, interval='1q', stat_by_year=False)
    sparrow = _prep_hist(whale)
    if sparrow.empty:
        return _make_factor_series({lion: np.nan for lion in rabbit}, giraffe, universe=universe, name='factor199')
    sparrow = sparrow[sparrow['q'].isin(frog)]
    if sparrow.empty:
        return _make_factor_series({lion: np.nan for lion in rabbit}, giraffe, universe=universe, name='factor199')
    tuna = sparrow.pivot(index='q', columns='code', values='term_076').reindex(index=frog, columns=rabbit)
    dog = sparrow.pivot(index='q', columns='code', values='term_004').reindex(index=frog, columns=rabbit)
    tuna = tuna.apply(pd.to_numeric, errors='coerce').astype(float)
    dog = dog.apply(pd.to_numeric, errors='coerce').astype(float)
    lemur = (tuna.loc[salmon] if salmon in tuna.index else pd.Series(np.nan, index=rabbit)) + (dog.loc[salmon] if salmon in dog.index else pd.Series(np.nan, index=rabbit))
    alpaca = (tuna.loc[lizard] if lizard in tuna.index else pd.Series(np.nan, index=rabbit)) + (dog.loc[lizard] if lizard in dog.index else pd.Series(np.nan, index=rabbit))
    dolphin = get_history_fundamentals(security=rabbit, fields=[wolf.term_028], watch_date=panda, count=24, interval='1q', stat_by_year=False)
    bear = _prep_hist(dolphin)
    if bear.empty:
        return _make_factor_series({lion: np.nan for lion in rabbit}, giraffe, universe=universe, name='factor199')
    bear = bear[bear['q'].isin(frog)]
    if bear.empty:
        return _make_factor_series({lion: np.nan for lion in rabbit}, giraffe, universe=universe, name='factor199')
    wolf = bear.pivot(index='q', columns='code', values='term_028').reindex(index=frog, columns=rabbit)
    wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float)
    fox = wolf.loc[salmon] if salmon in wolf.index else pd.Series(np.nan, index=rabbit, dtype='float64')
    koala = wolf.loc[lizard] if lizard in wolf.index else pd.Series(np.nan, index=rabbit, dtype='float64')
    otter = koala.where(np.isfinite(koala) & (koala != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = fox / otter
    hawk = hawk.replace([np.inf, -np.inf], np.nan)
    zebra = get_history_fundamentals(security=rabbit, fields=[fox.term_081], watch_date=panda, count=24, interval='1q', stat_by_year=False)
    tiger = _prep_hist(zebra)
    if tiger.empty or 'term_081' not in tiger.columns:
        return _make_factor_series({lion: np.nan for lion in rabbit}, giraffe, universe=universe, name='factor199')
    tiger = tiger[tiger['q'].isin([salmon])]
    if tiger.empty:
        return _make_factor_series({lion: np.nan for lion in rabbit}, giraffe, universe=universe, name='factor199')
    badger = tiger.pivot(index='q', columns='code', values='term_081').reindex(index=[salmon], columns=rabbit)
    badger = badger.apply(pd.to_numeric, errors='coerce').astype(float)
    camel = badger.loc[salmon] if salmon in badger.index else pd.Series(np.nan, index=rabbit, dtype='float64')
    beaver = camel.where(np.isfinite(camel) & (camel != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = alpaca * hawk
        cat = lemur - shark
        turtle = cat / beaver
    turtle = turtle.replace([np.inf, -np.inf], np.nan)
    owl = ~np.isfinite(turtle) | ~np.isfinite(lemur) | ~np.isfinite(alpaca) | ~np.isfinite(hawk) | ~np.isfinite(beaver)
    turtle = turtle.where(~owl, np.nan).reindex(rabbit)
    eagle = {lion: float(turtle.get(lion)) if np.isfinite(turtle.get(lion, np.nan)) else np.nan for lion in rabbit}
    return _make_factor_series(eagle, giraffe, universe=universe, name='factor199')

def factor200(universe, date):
    _set_asof_date(date)
    panda = get_factor_values(universe, factors=['np_parent_company_owners_ttm', 'term_053', 'term_068'], end_date=date, count=1)
    giraffe = panda.get('np_parent_company_owners_ttm', None)
    bear = panda.get('term_053', None)
    owl = panda.get('term_068', None)
    if owl is None or owl.empty or (giraffe is None and bear is None):
        lion = {cat: np.nan for cat in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor200')
    zebra = giraffe.iloc[-1] if giraffe is not None and (not giraffe.empty) else None
    rabbit = bear.iloc[-1] if bear is not None and (not bear.empty) else None
    turtle = owl.iloc[-1]
    dog = (pd.to_datetime(date) - DateOffset(years=3)).strftime('%Y-%m-%d')
    tiger = get_factor_values(universe, factors=['np_parent_company_owners_ttm', 'term_053', 'term_068'], end_date=dog, count=1)
    dolphin = tiger.get('np_parent_company_owners_ttm', None)
    shark = tiger.get('term_053', None)
    lizard = tiger.get('term_068', None)
    if lizard is None or lizard.empty or (dolphin is None and shark is None):
        lion = {cat: np.nan for cat in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor200')
    whale = dolphin.iloc[-1] if dolphin is not None and (not dolphin.empty) else None
    eagle = shark.iloc[-1] if shark is not None and (not shark.empty) else None
    frog = lizard.iloc[-1]
    lion = {}
    for cat in universe:
        wolf = np.nan
        if zebra is not None:
            wolf = zebra.get(cat, np.nan)
        if not np.isfinite(wolf) and rabbit is not None:
            wolf = rabbit.get(cat, np.nan)
        salmon = turtle.get(cat, np.nan)
        fox = np.nan
        if whale is not None:
            fox = whale.get(cat, np.nan)
        if not np.isfinite(fox) and eagle is not None:
            fox = eagle.get(cat, np.nan)
        sparrow = frog.get(cat, np.nan)
        if not np.isfinite(wolf) or not np.isfinite(salmon) or salmon == 0 or (not np.isfinite(fox)) or (not np.isfinite(sparrow)) or (sparrow == 0):
            tuna = np.nan
        else:
            otter = wolf / salmon
            koala = fox / sparrow
            if not np.isfinite(koala) or koala == 0:
                tuna = np.nan
            else:
                hawk = (otter - koala) / abs(koala) + 1.0
                if not np.isfinite(hawk) or hawk <= 0:
                    tuna = np.nan
                else:
                    tuna = hawk ** (1.0 / 3.0) - 1.0
        lion[cat] = float(tuna) if np.isfinite(tuna) else np.nan
    return _make_factor_series(lion, date, universe=universe, name='factor200')

def factor201(universe, date, N_days=20, batch_size=200):
    _set_asof_date(date)
    rabbit = pd.to_datetime(date)
    camel = list(universe)
    giraffe = _last_n_trade_days(rabbit, int(N_days))
    if len(giraffe) == 0:
        return _make_factor_series({tiger: np.nan for tiger in camel}, date, universe=universe, name='factor201')
    zebra = [pd.to_datetime(fox).date() for fox in giraffe]
    badger = pd.to_datetime(giraffe[0]).strftime('%Y-%m-%d')
    dolphin = (pd.to_datetime(giraffe[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    lemur = []
    lizard = []
    panda = max(1, int(batch_size))
    for hawk in range(0, len(camel), panda):
        dog = camel[hawk:hawk + panda]
        sparrow = get_price(dog, start_date=badger, end_date=dolphin, frequency='1m', fields=['close'], fq='post', panel=False)
        if sparrow is None or sparrow.empty:
            continue
        sparrow = sparrow.copy()
        if 'time' not in sparrow.columns:
            sparrow['time'] = sparrow.index
        if 'code' not in sparrow.columns:
            continue
        sparrow['time'] = pd.to_datetime(sparrow['time'])
        sparrow['date'] = sparrow['time'].dt.date
        sparrow = sparrow[sparrow['date'].isin(zebra)]
        if sparrow.empty:
            continue
        sparrow = sparrow[['code', 'time', 'date', 'close']].dropna(subset=['close'])
        if sparrow.empty:
            continue
        sparrow['close'] = sparrow['close'].astype(float)
        sparrow = sparrow[np.isfinite(sparrow['close'].values)]
        if sparrow.empty:
            continue
        sparrow.sort_values(['code', 'date', 'time'], inplace=True)
        eagle = sparrow.groupby(['code', 'date'], sort=False)['close']
        wolf = eagle.diff()
        bear = wolf.groupby([sparrow['code'], sparrow['date']], sort=False).shift(-1)
        gecko = wolf.values.astype(float)
        narwhal = bear.values.astype(float)
        shark = np.isfinite(gecko) & np.isfinite(narwhal)
        ferret = shark & (gecko > 0)
        donkey = shark & (gecko < 0)
        kangaroo = np.where(ferret, gecko, 0.0)
        raccoon = np.where(ferret, narwhal, 0.0)
        iguana = kangaroo * kangaroo
        penguin = raccoon * raccoon
        mole = kangaroo * raccoon
        salmon = ferret.astype(np.int32)
        jaguar = np.where(donkey, gecko, 0.0)
        quail = np.where(donkey, narwhal, 0.0)
        hyena = jaguar * jaguar
        octopus = quail * quail
        llama = jaguar * quail
        frog = donkey.astype(np.int32)
        beaver = pd.DataFrame({'code': sparrow['code'].values, 'date': sparrow['date'].values, 'sx_p': kangaroo, 'sy_p': raccoon, 'sx2_p': iguana, 'sy2_p': penguin, 'sxy_p': mole, 'n_p': salmon, 'sx_m': jaguar, 'sy_m': quail, 'sx2_m': hyena, 'sy2_m': octopus, 'sxy_m': llama, 'n_m': frog})
        cat = beaver.groupby(['code', 'date'], sort=False).sum(numeric_only=True)

        def _corr_from(agg_df, prefix):
            panda = agg_df[f'n_{prefix}'].astype(float)
            lion = agg_df[f'sx_{prefix}'].astype(float)
            fox = agg_df[f'sy_{prefix}'].astype(float)
            koala = agg_df[f'sx2_{prefix}'].astype(float)
            wolf = agg_df[f'sy2_{prefix}'].astype(float)
            otter = agg_df[f'sxy_{prefix}'].astype(float)
            tiger = panda * otter - lion * fox
            bear = panda * koala - lion * lion
            rabbit = panda * wolf - fox * fox
            dog = np.sqrt(bear * rabbit)
            with np.errstate(divide='ignore', invalid='ignore'):
                cat = tiger / dog
            cat = cat.where((panda >= 3) & np.isfinite(cat) & np.isfinite(dog) & (dog > 0), np.nan)
            return cat
        otter = _corr_from(cat, 'p')
        koala = _corr_from(cat, 'm')
        lemur.append(otter.rename('corr').reset_index())
        lizard.append(koala.rename('corr').reset_index())
    if len(lemur) == 0 and len(lizard) == 0:
        return _make_factor_series({tiger: np.nan for tiger in camel}, date, universe=universe, name='factor201')
    if len(lemur) > 0:
        alpaca = pd.concat(lemur, ignore_index=True).dropna(subset=['corr'])
        tuna = alpaca.groupby('code', sort=False)['corr'].mean().reindex(camel)
    else:
        tuna = pd.Series(np.nan, index=camel, dtype='float64')
    if len(lizard) > 0:
        turtle = pd.concat(lizard, ignore_index=True).dropna(subset=['corr'])
        owl = turtle.groupby('code', sort=False)['corr'].mean().reindex(camel)
    else:
        owl = pd.Series(np.nan, index=camel, dtype='float64')
    turkey = _zscore_series(tuna.astype(float))
    seal = _zscore_series(owl.astype(float))
    lion = turkey - seal
    whale = {tiger: float(lion.loc[tiger]) if np.isfinite(lion.loc[tiger]) else np.nan for tiger in camel}
    return _make_factor_series(whale, date, universe=universe, name='factor201')

def factor202(universe, date, K_months=12, mkt_index='000905.XSHG'):
    _set_asof_date(date)
    tiger = pd.to_datetime(date)
    lizard = list(universe)
    rabbit = int(K_months * 21) + 1
    lion = _last_n_trade_days(tiger, rabbit)
    if len(lion) < 30:
        return _make_factor_series({dog: np.nan for dog in lizard}, tiger, universe=universe, name='factor202')
    turtle = pd.to_datetime(lion[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(tiger).strftime('%Y-%m-%d')
    panda = list(set(lizard) | {mkt_index})
    otter = get_price(panda, start_date=turtle, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({dog: np.nan for dog in lizard}, tiger, universe=universe, name='factor202')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    if 'code' not in otter.columns:
        return _make_factor_series({dog: np.nan for dog in lizard}, tiger, universe=universe, name='factor202')
    zebra = otter.pivot(index='time', columns='code', values='close').sort_index()
    if mkt_index not in zebra.columns:
        return _make_factor_series({dog: np.nan for dog in lizard}, tiger, universe=universe, name='factor202')
    shark = zebra.pct_change()
    whale = shark[mkt_index].astype(float).values
    wolf = {}
    for dog in lizard:
        if dog not in shark.columns:
            wolf[dog] = np.nan
            continue
        dolphin = shark[dog].astype(float).values
        bear = np.isfinite(whale) & np.isfinite(dolphin)
        if bear.sum() < 10:
            wolf[dog] = np.nan
            continue
        sparrow = whale[bear]
        eagle = dolphin[bear]
        owl = sparrow - sparrow.mean()
        koala = float(np.sum(owl * owl))
        if not np.isfinite(koala) or koala == 0:
            wolf[dog] = np.nan
            continue
        hawk = eagle - eagle.mean()
        giraffe = float(np.sum(hawk * owl))
        cat = giraffe / koala
        wolf[dog] = float(cat) if np.isfinite(cat) else np.nan
    return _make_factor_series(wolf, tiger, universe=universe, name='factor202')

def factor203(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor203')

def factor204(universe, date, N=20, batch_size=200):
    _set_asof_date(date)
    hawk = pd.to_datetime(date)
    narwhal = list(universe)
    N = int(N)
    sparrow = _last_n_trade_days(hawk, N + 1)
    if len(sparrow) < N + 1:
        return _make_factor_series({fox: np.nan for fox in narwhal}, date, universe=universe, name='factor204')
    shark = pd.to_datetime(sparrow[1]).strftime('%Y-%m-%d')
    eagle = pd.to_datetime(sparrow[-1]).strftime('%Y-%m-%d')
    frog = (pd.to_datetime(eagle) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    whale = []
    otter = max(1, int(batch_size))
    for badger in range(0, len(narwhal), otter):
        lion = narwhal[badger:badger + otter]
        beaver = get_price(lion, start_date=shark, end_date=frog, frequency='1m', fields=['close', 'volume'], fq='post', panel=False)
        if beaver is None or beaver.empty:
            continue
        beaver = beaver.copy()
        if 'time' not in beaver.columns:
            beaver['time'] = beaver.index
        if 'code' not in beaver.columns:
            continue
        beaver['time'] = pd.to_datetime(beaver['time'])
        beaver['date'] = beaver['time'].dt.date
        beaver = beaver[['code', 'date', 'close', 'volume']].dropna(subset=['close', 'volume'])
        if beaver.empty:
            continue
        beaver['close'] = beaver['close'].astype(float)
        beaver['volume'] = beaver['volume'].astype(float)
        beaver = beaver[np.isfinite(beaver['close'].values) & np.isfinite(beaver['volume'].values)]
        if beaver.empty:
            continue
        beaver['xy'] = beaver['close'] * beaver['volume']
        beaver['x2'] = beaver['close'] * beaver['close']
        beaver['y2'] = beaver['volume'] * beaver['volume']
        tiger = beaver.groupby(['code', 'date'], sort=False).agg(n=('close', 'count'), mx=('close', 'mean'), my=('volume', 'mean'), mxy=('xy', 'mean'), mx2=('x2', 'mean'), my2=('y2', 'mean'))
        donkey = tiger['mxy'] - tiger['mx'] * tiger['my']
        raccoon = tiger['mx2'] - tiger['mx'] * tiger['mx']
        seal = tiger['my2'] - tiger['my'] * tiger['my']
        owl = np.sqrt(raccoon * seal)
        dolphin = donkey / owl
        dolphin[(tiger['n'] < 3) | ~np.isfinite(dolphin) | ~np.isfinite(owl) | (owl <= 0)] = np.nan
        whale.append(dolphin.rename('rho').reset_index())
    if len(whale) == 0:
        koala = pd.Series(np.nan, index=narwhal, dtype='float64')
    else:
        jaguar = pd.concat(whale, ignore_index=True).dropna(subset=['rho'])
        if jaguar.empty:
            koala = pd.Series(np.nan, index=narwhal, dtype='float64')
        else:
            jaguar.sort_values(['code', 'date'], inplace=True)

            def _slope_lastN(sub):
                dog = sub['rho'].values.astype(float)
                dog = dog[np.isfinite(dog)]
                if dog.size < 5:
                    return np.nan
                if dog.size > N:
                    dog = dog[-N:]
                cat = float(dog.size)
                panda = np.arange(1.0, cat + 1.0, dtype=float)
                tiger = float(np.var(panda, ddof=0))
                if not np.isfinite(tiger) or tiger == 0:
                    return np.nan
                return float(np.cov(panda, dog, ddof=0)[0, 1] / tiger)
            koala = jaguar.groupby('code', sort=False).apply(_slope_lastN).reindex(narwhal).astype(float)
    kangaroo = pd.to_datetime(sparrow[0]).strftime('%Y-%m-%d')
    salmon = pd.to_datetime(hawk).strftime('%Y-%m-%d')
    lizard = get_price(narwhal, start_date=kangaroo, end_date=salmon, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if lizard is None or lizard.empty:
        return _make_factor_series({fox: np.nan for fox in narwhal}, date, universe=universe, name='factor204')
    lizard = lizard.copy()
    if 'time' not in lizard.columns:
        lizard = lizard.reset_index()
    if 'code' not in lizard.columns:
        return _make_factor_series({fox: np.nan for fox in narwhal}, date, universe=universe, name='factor204')
    lizard['time'] = pd.to_datetime(lizard['time']).dt.normalize()
    giraffe = lizard.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=narwhal).astype(float)
    quail = lizard.pivot(index='time', columns='code', values='volume').sort_index().reindex(columns=narwhal).astype(float)
    if giraffe.shape[0] < N + 1:
        return _make_factor_series({fox: np.nan for fox in narwhal}, date, universe=universe, name='factor204')
    zebra = giraffe.iloc[-(N + 1):]
    iguana = zebra.pct_change().iloc[1:]
    wolf = zebra.iloc[0]
    bear = zebra.iloc[-1]
    hyena = bear / wolf - 1.0
    octopus = iguana.std(axis=0, ddof=1)
    ferret = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(narwhal))
    turtle = get_fundamentals(ferret, date=hawk)
    if turtle is None or turtle.empty:
        llama = pd.Series(np.nan, index=narwhal, dtype='float64')
    else:
        rabbit = turtle.set_index('code')['circulating_cap'].astype(float).reindex(narwhal)
        owl = (rabbit * 10000.0).where(np.isfinite(rabbit) & (rabbit > 0), np.nan)
        penguin = quail.reindex(index=zebra.index).iloc[-N:]
        with np.errstate(divide='ignore', invalid='ignore'):
            mole = penguin.div(owl, axis=1)
        llama = mole.mean(axis=0, skipna=True).astype(float)
        llama = llama.where(np.isfinite(llama), np.nan)
    camel = koala.notna() & hyena.notna() & llama.notna() & octopus.notna()
    if camel.sum() < 5:
        gecko = pd.Series(np.nan, index=narwhal, dtype='float64')
    else:
        dog = koala[camel].values.astype(float)
        cat = np.column_stack([np.ones(camel.sum(), dtype=float), hyena[camel].values.astype(float), llama[camel].values.astype(float), octopus[camel].values.astype(float)])
        try:
            lemur, panda, panda, panda = np.linalg.lstsq(cat, dog, rcond=None)
            tuna = dog - cat @ lemur
            gecko = pd.Series(np.nan, index=narwhal, dtype='float64')
            gecko.loc[koala[camel].index] = tuna
        except Exception:
            gecko = pd.Series(np.nan, index=narwhal, dtype='float64')
    alpaca = {fox: float(gecko.loc[fox]) if np.isfinite(gecko.loc[fox]) else np.nan for fox in narwhal}
    return _make_factor_series(alpaca, date, universe=universe, name='factor204')

def factor205(universe, date):
    _set_asof_date(date)
    whale = _to_date(date)
    koala = pd.Timestamp(whale)
    dolphin = list(universe)
    tuna = pd.Period(koala, freq='Q-DEC') - 1
    frog = tuna - 4
    salmon = pd.PeriodIndex([frog, tuna], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    shark = get_history_fundamentals(security=dolphin, fields=[fox.term_071, fox.term_081], watch_date=koala, count=24, interval='1q', stat_by_year=False)
    otter = _prep_hist(shark)
    if otter.empty:
        return _make_factor_series({fox: np.nan for fox in dolphin}, whale, universe=universe, name='factor205')
    otter = otter[otter['q'].isin(salmon)]
    if otter.empty:
        return _make_factor_series({fox: np.nan for fox in dolphin}, whale, universe=universe, name='factor205')
    turtle = otter.pivot(index='q', columns='code', values='term_071').reindex(index=salmon, columns=dolphin)
    alpaca = otter.pivot(index='q', columns='code', values='term_081').reindex(index=salmon, columns=dolphin)
    turtle = turtle.apply(pd.to_numeric, errors='coerce').astype(float)
    alpaca = alpaca.apply(pd.to_numeric, errors='coerce').astype(float)
    dog = turtle.loc[tuna] if tuna in turtle.index else pd.Series(np.nan, index=dolphin, dtype='float64')
    cat = turtle.loc[frog] if frog in turtle.index else pd.Series(np.nan, index=dolphin, dtype='float64')
    tiger = alpaca.loc[tuna] if tuna in alpaca.index else pd.Series(np.nan, index=dolphin, dtype='float64')
    eagle = get_history_fundamentals(security=dolphin, fields=[wolf.term_028], watch_date=koala, count=24, interval='1q', stat_by_year=False)
    zebra = _prep_hist(eagle)
    if zebra.empty:
        return _make_factor_series({fox: np.nan for fox in dolphin}, whale, universe=universe, name='factor205')
    zebra = zebra[zebra['q'].isin(salmon)]
    if zebra.empty:
        return _make_factor_series({fox: np.nan for fox in dolphin}, whale, universe=universe, name='factor205')
    giraffe = zebra.pivot(index='q', columns='code', values='term_028').reindex(index=salmon, columns=dolphin)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = giraffe.loc[tuna] if tuna in giraffe.index else pd.Series(np.nan, index=dolphin, dtype='float64')
    wolf = giraffe.loc[frog] if frog in giraffe.index else pd.Series(np.nan, index=dolphin, dtype='float64')
    bear = wolf.where(np.isfinite(wolf) & (wolf != 0), np.nan)
    panda = tiger.where(np.isfinite(tiger) & (tiger != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        sparrow = rabbit / bear
        lion = dog - cat * sparrow
        lizard = -lion / panda
    owl = ~np.isfinite(lizard) | ~np.isfinite(dog) | ~np.isfinite(cat) | ~np.isfinite(sparrow) | ~np.isfinite(panda) | (bear == 0)
    lizard = lizard.where(~owl, np.nan).reindex(dolphin)
    hawk = {fox: float(lizard.get(fox)) if np.isfinite(lizard.get(fox, np.nan)) else np.nan for fox in dolphin}
    return _make_factor_series(hawk, whale, universe=universe, name='factor205')

def factor206(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    dog = pd.Timestamp(koala)
    lion = list(universe)
    eagle = pd.Period(dog, freq='Q-DEC') - 1
    hawk = pd.PeriodIndex([eagle, eagle - 1, eagle - 2, eagle - 3], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=lion, fields=[bear.term_063], watch_date=dog, count=12, interval='1q', stat_by_year=False)
    zebra = _prep_hist(fox)
    if zebra.empty or 'term_063' not in zebra.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor206')
    zebra = zebra[zebra['q'].isin(hawk)]
    if zebra.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor206')
    whale = zebra.pivot(index='q', columns='code', values='term_063').reindex(index=hawk, columns=lion)
    whale = whale.apply(pd.to_numeric, errors='coerce').astype(float)
    wolf = whale.sum(axis=0, min_count=1).reindex(lion)
    otter = get_history_fundamentals(security=lion, fields=[fox.term_082, fox.term_083, fox.term_025], watch_date=dog, count=12, interval='1q', stat_by_year=False)
    panda = _prep_hist(otter)
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor206')
    panda = panda[panda['q'].isin([eagle])]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor206')
    owl = panda.pivot(index='q', columns='code', values='term_082').reindex(index=[eagle], columns=lion)
    lizard = panda.pivot(index='q', columns='code', values='term_083').reindex(index=[eagle], columns=lion)
    rabbit = panda.pivot(index='q', columns='code', values='term_025').reindex(index=[eagle], columns=lion)
    owl = owl.apply(pd.to_numeric, errors='coerce').astype(float)
    lizard = lizard.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = owl.loc[eagle] if eagle in owl.index else pd.Series(np.nan, index=lion, dtype='float64')
    turtle = lizard.loc[eagle] if eagle in lizard.index else pd.Series(np.nan, index=lion, dtype='float64')
    bear = rabbit.loc[eagle] if eagle in rabbit.index else pd.Series(np.nan, index=lion, dtype='float64')
    cat = sparrow - turtle + bear
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = wolf / cat
    dolphin = ~np.isfinite(shark) | ~np.isfinite(wolf) | ~np.isfinite(cat) | (cat == 0)
    shark = shark.where(~dolphin, np.nan).reindex(lion)
    giraffe = {tiger: float(shark.get(tiger)) if np.isfinite(shark.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(giraffe, koala, universe=universe, name='factor206')

def factor207(universe, date):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    giraffe = list(universe)
    rabbit = query(fox.code, fox.total_owner_equities).filter(fox.code.in_(giraffe))
    koala = get_fundamentals(rabbit, date=panda)
    if koala is None or koala.empty:
        otter = pd.Series(np.nan, index=giraffe, dtype='float64')
    else:
        otter = koala.set_index('code')['total_owner_equities'].astype(float).reindex(giraffe)
    bear = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(giraffe))
    lion = get_fundamentals(bear, date=panda)
    if lion is None or lion.empty:
        dog = pd.Series(np.nan, index=giraffe, dtype='float64')
    else:
        dog = lion.set_index('code')['term_008'].astype(float).reindex(giraffe)
    tiger = (dog * 10000.0).where(np.isfinite(dog) & (dog > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = otter / tiger
    wolf = wolf.where(np.isfinite(wolf) & np.isfinite(otter) & np.isfinite(tiger), np.nan)
    fox = {cat: float(wolf.loc[cat]) if np.isfinite(wolf.loc[cat]) else np.nan for cat in giraffe}
    return _make_factor_series(fox, date, universe=universe, name='factor207')

def factor208(universe, date):
    _set_asof_date(date)
    dog = pd.to_datetime(date)
    try:
        tiger = get_factor_values(universe, factors=['roe_ttm'], end_date=dog, count=1)
        wolf = tiger['roe_ttm'].iloc[-1]
    except Exception:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, dog, universe=universe, name='factor208')
    panda = dog - DateOffset(years=1)
    try:
        lion = get_factor_values(universe, factors=['roe_ttm'], end_date=panda, count=1)
        bear = lion['roe_ttm'].iloc[-1]
    except Exception:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, dog, universe=universe, name='factor208')
    koala = {}
    for cat in universe:
        fox = wolf.get(cat, np.nan)
        otter = bear.get(cat, np.nan)
        if not np.isfinite(fox) or not np.isfinite(otter):
            rabbit = np.nan
        else:
            rabbit = fox - otter
        koala[cat] = float(rabbit) if np.isfinite(rabbit) else np.nan
    return _make_factor_series(koala, dog, universe=universe, name='factor208')

def factor209(universe, date, N=25, N1=13):
    _set_asof_date(date)
    tiger = pd.to_datetime(date)
    hawk = list(universe)
    sparrow = int(N + N1 + 5)
    lion = _last_n_trade_days(tiger, sparrow + 1)
    if len(lion) < N + N1 + 2:
        return _make_factor_series({panda: np.nan for panda in hawk}, tiger, universe=universe, name='factor209')
    shark = pd.to_datetime(lion[0]).strftime('%Y-%m-%d')
    rabbit = pd.to_datetime(tiger).strftime('%Y-%m-%d')
    koala = get_price(hawk, start_date=shark, end_date=rabbit, frequency='daily', fields=['close'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({panda: np.nan for panda in hawk}, tiger, universe=universe, name='factor209')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index()
    if 'code' not in koala.columns:
        return _make_factor_series({panda: np.nan for panda in hawk}, tiger, universe=universe, name='factor209')
    koala['time'] = pd.to_datetime(koala['time']).dt.normalize()
    dog = koala.pivot(index='time', columns='code', values='close').sort_index()
    dog = dog.reindex(columns=hawk)
    if dog.shape[0] < N + N1 + 2:
        return _make_factor_series({panda: np.nan for panda in hawk}, tiger, universe=universe, name='factor209')
    dog = dog.astype(float)
    whale = dog.apply(lambda x: np.isfinite(x.values).sum() >= N + N1 + 2, axis=0)
    dolphin = dog.diff()
    bear = dolphin.ewm(span=N, adjust=False).mean()
    wolf = dolphin.abs().ewm(span=N, adjust=False).mean()
    fox = bear.ewm(span=N1, adjust=False).mean()
    otter = wolf.ewm(span=N1, adjust=False).mean()
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = fox / otter * 100.0
    zebra = eagle.iloc[-1].astype(float)
    zebra = zebra.where(whale & np.isfinite(zebra) & np.isfinite(otter.iloc[-1].astype(float)) & (otter.iloc[-1].astype(float) > 0), np.nan)
    giraffe = {cat: float(zebra.loc[cat]) if np.isfinite(zebra.loc[cat]) else np.nan for cat in hawk}
    return _make_factor_series(giraffe, tiger, universe=universe, name='factor209')

def factor210(universe, date, L=20):
    _set_asof_date(date)
    koala = _last_n_trade_days(date, L)
    if len(koala) < L:
        fox = {tiger: np.nan for tiger in universe}
        return _make_factor_series(fox, date, universe=universe, name=f'factor210{L}')
    rabbit = koala[0]
    giraffe = pd.to_datetime(rabbit).strftime('%Y-%m-%d')
    otter = get_price(universe, start_date=giraffe, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        fox = {tiger: np.nan for tiger in universe}
        return _make_factor_series(fox, date, universe=universe, name=f'factor210{L}')
    otter = otter.reset_index()
    cat = otter.pivot(index='time', columns='code', values='close').sort_index()
    if cat.shape[0] < L:
        fox = {tiger: np.nan for tiger in universe}
        return _make_factor_series(fox, date, universe=universe, name=f'factor210{L}')
    panda = cat.iloc[-L:]
    bear = panda.mean(axis=0)
    dog = panda.iloc[-1]
    fox = {}
    for tiger in universe:
        wolf = bear.get(tiger, np.nan)
        lion = dog.get(tiger, np.nan)
        if not np.isfinite(wolf) or not np.isfinite(lion) or lion == 0:
            zebra = np.nan
        else:
            zebra = wolf / lion
        fox[tiger] = float(zebra) if np.isfinite(zebra) else np.nan
    return _make_factor_series(fox, date, universe=universe, name=f'factor210{L}')

def factor211(universe, date, N=20, batch_size=200):
    _set_asof_date(date)
    eagle = _last_n_trade_days(date, N)
    if len(eagle) == 0:
        lizard = {wolf: np.nan for wolf in universe}
        return _make_factor_series(lizard, date, universe=universe, name='factor211')
    whale = pd.to_datetime(eagle[0]).strftime('%Y-%m-%d')
    shark = pd.to_datetime(eagle[-1]).strftime('%Y-%m-%d')
    turtle = (pd.to_datetime(shark) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    giraffe = []
    kangaroo = list(universe)
    for frog in range(0, len(kangaroo), max(1, int(batch_size))):
        tiger = kangaroo[frog:frog + max(1, int(batch_size))]
        tuna = get_price(tiger, start_date=whale, end_date=turtle, frequency='1m', fields=['close', 'volume'], fq='post', panel=False)
        if tuna is None or tuna.empty:
            continue
        tuna = tuna.copy()
        if 'time' not in tuna.columns:
            tuna['time'] = tuna.index
        tuna['time'] = pd.to_datetime(tuna['time'])
        if 'code' not in tuna.columns:
            continue
        tuna['date'] = tuna['time'].dt.date
        tuna = tuna[['code', 'date', 'close', 'volume']].dropna(subset=['close', 'volume'])
        if tuna.empty:
            continue
        tuna['close'] = tuna['close'].astype(float)
        tuna['volume'] = tuna['volume'].astype(float)
        tuna = tuna[np.isfinite(tuna['close'].values) & np.isfinite(tuna['volume'].values)]
        if tuna.empty:
            continue
        tuna['xy'] = tuna['close'] * tuna['volume']
        tuna['x2'] = tuna['close'] * tuna['close']
        tuna['y2'] = tuna['volume'] * tuna['volume']
        cat = tuna.groupby(['code', 'date'], sort=False).agg(n=('close', 'count'), mx=('close', 'mean'), my=('volume', 'mean'), mxy=('xy', 'mean'), mx2=('x2', 'mean'), my2=('y2', 'mean'))
        alpaca = cat['mxy'] - cat['mx'] * cat['my']
        narwhal = cat['mx2'] - cat['mx'] * cat['mx']
        octopus = cat['my2'] - cat['my'] * cat['my']
        sparrow = np.sqrt(narwhal * octopus)
        bear = alpaca / sparrow
        bear[(cat['n'] < 3) | ~np.isfinite(bear) | ~np.isfinite(sparrow) | (sparrow <= 0)] = np.nan
        giraffe.append(bear.rename('corr').reset_index())
    if len(giraffe) == 0:
        panda = pd.Series(np.nan, index=kangaroo, dtype='float64')
        ferret = pd.Series(np.nan, index=kangaroo, dtype='float64')
        jaguar = pd.Series(np.nan, index=kangaroo, dtype='float64')
    else:
        rabbit = pd.concat(giraffe, ignore_index=True)
        rabbit = rabbit.dropna(subset=['corr'])
        dog = {}
        donkey = {}
        iguana = {}
        for wolf in kangaroo:
            gecko = rabbit[rabbit['code'] == wolf]
            if gecko.empty:
                dog[wolf] = np.nan
                donkey[wolf] = np.nan
                iguana[wolf] = np.nan
                continue
            gecko = gecko.sort_values('date')
            zebra = gecko['corr'].values.astype(float)
            zebra = zebra[np.isfinite(zebra)]
            if zebra.size < 3:
                dog[wolf] = np.nan
                donkey[wolf] = np.nan
                iguana[wolf] = np.nan
                continue
            if zebra.size > N:
                zebra = zebra[-N:]
            dog[wolf] = float(np.mean(zebra))
            donkey[wolf] = float(np.std(zebra, ddof=1)) if zebra.size > 1 else 0.0
            salmon = float(zebra.size)
            hyena = np.arange(1.0, salmon + 1.0, dtype=float)
            mole = float(np.var(hyena, ddof=0))
            if not np.isfinite(mole) or mole == 0:
                lion = np.nan
            else:
                lion = float(np.cov(hyena, zebra, ddof=0)[0, 1] / mole)
            iguana[wolf] = lion if np.isfinite(lion) else np.nan
        panda = pd.Series(dog, index=kangaroo, dtype='float64')
        ferret = pd.Series(donkey, index=kangaroo, dtype='float64')
        jaguar = pd.Series(iguana, index=kangaroo, dtype='float64')
    hawk = _last_n_trade_days(date, 21)
    if len(hawk) < 21:
        lizard = {wolf: np.nan for wolf in kangaroo}
        return _make_factor_series(lizard, date, universe=universe, name='factor211')
    beaver = hawk[0]
    camel = pd.to_datetime(beaver).strftime('%Y-%m-%d')
    owl = get_price(kangaroo, start_date=camel, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if owl is None or owl.empty:
        lizard = {wolf: np.nan for wolf in kangaroo}
        return _make_factor_series(lizard, date, universe=universe, name='factor211')
    owl = owl.reset_index()
    fox = owl.pivot(index='time', columns='code', values='close').sort_index()
    if fox.shape[0] < 21:
        lizard = {wolf: np.nan for wolf in kangaroo}
        return _make_factor_series(lizard, date, universe=universe, name='factor211')
    koala = fox.iloc[0]
    otter = fox.iloc[-1]
    badger = otter / koala - 1.0

    def _residual_z(y_s: pd.Series, x_s: pd.Series) -> pd.Series:
        fox = ~y_s.isna() & ~x_s.isna()
        if fox.sum() >= 3:
            dog = y_s[fox].values
            cat = np.column_stack([np.ones(fox.sum()), x_s[fox].values])
            try:
                lion, tiger, tiger, tiger = np.linalg.lstsq(cat, dog, rcond=None)
                panda = cat @ lion
                koala = dog - panda
                otter = pd.Series(np.nan, index=y_s.index, dtype='float64')
                otter.loc[y_s[fox].index] = koala
                return _zscore_series(otter)
            except Exception:
                return _zscore_series(y_s)
        else:
            return _zscore_series(y_s)
    penguin = _residual_z(panda, badger)
    raccoon = _residual_z(ferret, badger)
    lemur = penguin + raccoon
    seal = _zscore_series(jaguar)
    quail = _zscore_series(lemur)
    dolphin = quail + seal
    lizard = {}
    for wolf in kangaroo:
        llama = dolphin.get(wolf, np.nan)
        lizard[wolf] = float(llama) if np.isfinite(llama) else np.nan
    return _make_factor_series(lizard, date, universe=universe, name='factor211')

def factor212(universe, date):
    _set_asof_date(date)
    dog = pd.to_datetime(date)
    try:
        tiger = get_factor_values(universe, factors=['roe_ttm'], end_date=dog, count=1)
        wolf = tiger['roe_ttm'].iloc[-1]
    except Exception:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, dog, universe=universe, name='factor212')
    panda = dog - DateOffset(months=3)
    try:
        lion = get_factor_values(universe, factors=['roe_ttm'], end_date=panda, count=1)
        bear = lion['roe_ttm'].iloc[-1]
    except Exception:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, dog, universe=universe, name='factor212')
    koala = {}
    for cat in universe:
        fox = wolf.get(cat, np.nan)
        otter = bear.get(cat, np.nan)
        if not np.isfinite(fox) or not np.isfinite(otter):
            rabbit = np.nan
        else:
            rabbit = fox - otter
        koala[cat] = float(rabbit) if np.isfinite(rabbit) else np.nan
    return _make_factor_series(koala, dog, universe=universe, name='factor212')

def factor213(universe, date, N_days=20, batch_size=200):
    _set_asof_date(date)
    rabbit = pd.to_datetime(date)
    camel = list(universe)
    giraffe = _last_n_trade_days(rabbit, int(N_days))
    if len(giraffe) == 0:
        return _make_factor_series({tiger: np.nan for tiger in camel}, date, universe=universe, name='factor213')
    zebra = [pd.to_datetime(fox).date() for fox in giraffe]
    badger = pd.to_datetime(giraffe[0]).strftime('%Y-%m-%d')
    dolphin = (pd.to_datetime(giraffe[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    lemur = []
    lizard = []
    panda = max(1, int(batch_size))
    for hawk in range(0, len(camel), panda):
        dog = camel[hawk:hawk + panda]
        sparrow = get_price(dog, start_date=badger, end_date=dolphin, frequency='1m', fields=['volume'], fq='post', panel=False)
        if sparrow is None or sparrow.empty:
            continue
        sparrow = sparrow.copy()
        if 'time' not in sparrow.columns:
            sparrow['time'] = sparrow.index
        if 'code' not in sparrow.columns:
            continue
        sparrow['time'] = pd.to_datetime(sparrow['time'])
        sparrow['date'] = sparrow['time'].dt.date
        sparrow = sparrow[sparrow['date'].isin(zebra)]
        if sparrow.empty:
            continue
        sparrow = sparrow[['code', 'time', 'date', 'volume']].dropna(subset=['volume'])
        if sparrow.empty:
            continue
        sparrow['volume'] = sparrow['volume'].astype(float)
        sparrow = sparrow[np.isfinite(sparrow['volume'].values)]
        if sparrow.empty:
            continue
        sparrow.sort_values(['code', 'date', 'time'], inplace=True)
        eagle = sparrow.groupby(['code', 'date'], sort=False)['volume']
        wolf = eagle.diff()
        bear = wolf.groupby([sparrow['code'], sparrow['date']], sort=False).shift(-1)
        gecko = wolf.values.astype(float)
        narwhal = bear.values.astype(float)
        shark = np.isfinite(gecko) & np.isfinite(narwhal)
        ferret = shark & (gecko > 0)
        donkey = shark & (gecko < 0)
        kangaroo = np.where(ferret, gecko, 0.0)
        raccoon = np.where(ferret, narwhal, 0.0)
        iguana = kangaroo * kangaroo
        penguin = raccoon * raccoon
        mole = kangaroo * raccoon
        salmon = ferret.astype(np.int32)
        jaguar = np.where(donkey, gecko, 0.0)
        quail = np.where(donkey, narwhal, 0.0)
        hyena = jaguar * jaguar
        octopus = quail * quail
        llama = jaguar * quail
        frog = donkey.astype(np.int32)
        beaver = pd.DataFrame({'code': sparrow['code'].values, 'date': sparrow['date'].values, 'sx_p': kangaroo, 'sy_p': raccoon, 'sx2_p': iguana, 'sy2_p': penguin, 'sxy_p': mole, 'n_p': salmon, 'sx_m': jaguar, 'sy_m': quail, 'sx2_m': hyena, 'sy2_m': octopus, 'sxy_m': llama, 'n_m': frog})
        cat = beaver.groupby(['code', 'date'], sort=False).sum(numeric_only=True)

        def _corr_from(agg_df, prefix):
            panda = agg_df[f'n_{prefix}'].astype(float)
            lion = agg_df[f'sx_{prefix}'].astype(float)
            fox = agg_df[f'sy_{prefix}'].astype(float)
            koala = agg_df[f'sx2_{prefix}'].astype(float)
            wolf = agg_df[f'sy2_{prefix}'].astype(float)
            otter = agg_df[f'sxy_{prefix}'].astype(float)
            tiger = panda * otter - lion * fox
            bear = panda * koala - lion * lion
            rabbit = panda * wolf - fox * fox
            dog = np.sqrt(bear * rabbit)
            with np.errstate(divide='ignore', invalid='ignore'):
                cat = tiger / dog
            cat = cat.where((panda >= 3) & np.isfinite(cat) & np.isfinite(dog) & (dog > 0), np.nan)
            return cat
        otter = _corr_from(cat, 'p')
        koala = _corr_from(cat, 'm')
        lemur.append(otter.rename('corr').reset_index())
        lizard.append(koala.rename('corr').reset_index())
    if len(lemur) == 0 and len(lizard) == 0:
        return _make_factor_series({tiger: np.nan for tiger in camel}, date, universe=universe, name='factor213')
    if len(lemur) > 0:
        alpaca = pd.concat(lemur, ignore_index=True).dropna(subset=['corr'])
        tuna = alpaca.groupby('code', sort=False)['corr'].mean().reindex(camel)
    else:
        tuna = pd.Series(np.nan, index=camel, dtype='float64')
    if len(lizard) > 0:
        turtle = pd.concat(lizard, ignore_index=True).dropna(subset=['corr'])
        owl = turtle.groupby('code', sort=False)['corr'].mean().reindex(camel)
    else:
        owl = pd.Series(np.nan, index=camel, dtype='float64')
    turkey = _zscore_series(tuna.astype(float))
    seal = _zscore_series(owl.astype(float))
    lion = turkey - seal
    whale = {tiger: float(lion.loc[tiger]) if np.isfinite(lion.loc[tiger]) else np.nan for tiger in camel}
    return _make_factor_series(whale, date, universe=universe, name='factor213')

def factor214(universe, date, bench_index='000905.XSHG', rf_series=None, months_window=36):
    _set_asof_date(date)
    rabbit = pd.to_datetime(date)
    jaguar = list(universe)
    wolf = list(set(jaguar) | {bench_index})
    frog = int((months_window + 14) * 21)
    giraffe = _last_n_trade_days(rabbit, frog)
    if len(giraffe) < 13 * 21:
        return _make_factor_series({fox: np.nan for fox in jaguar}, rabbit, universe=universe, name='factor214')
    iguana = pd.to_datetime(giraffe[0]).strftime('%Y-%m-%d')
    whale = pd.to_datetime(rabbit).strftime('%Y-%m-%d')
    dolphin = get_price(wolf, start_date=iguana, end_date=whale, frequency='daily', fields=['close'], fq='post', panel=False)
    if dolphin is None or dolphin.empty:
        return _make_factor_series({fox: np.nan for fox in jaguar}, rabbit, universe=universe, name='factor214')
    dolphin = dolphin.copy()
    if 'time' not in dolphin.columns:
        dolphin = dolphin.reset_index()
    if 'code' not in dolphin.columns:
        return _make_factor_series({fox: np.nan for fox in jaguar}, rabbit, universe=universe, name='factor214')
    badger = dolphin.pivot(index='time', columns='code', values='close').sort_index()
    if bench_index not in badger.columns:
        return _make_factor_series({fox: np.nan for fox in jaguar}, rabbit, universe=universe, name='factor214')
    lizard = pd.to_datetime(badger.index).to_period('M')
    owl = badger.groupby(lizard).last()
    turtle = owl.pct_change().dropna(how='all')
    if bench_index not in turtle.columns:
        return _make_factor_series({fox: np.nan for fox in jaguar}, rabbit, universe=universe, name='factor214')
    if rf_series is None:
        donkey = pd.Series(0.0, index=turtle.index)
    else:
        donkey = rf_series.copy()
        if not isinstance(donkey.index, pd.PeriodIndex):
            donkey.index = pd.to_datetime(donkey.index).to_period('M')
        donkey = donkey.reindex(turtle.index).fillna(0.0)
    bear = turtle.index.intersection(donkey.index)
    salmon = int(months_window + 12)
    if len(bear) < salmon:
        return _make_factor_series({fox: np.nan for fox in jaguar}, rabbit, universe=universe, name='factor214')
    bear = bear[-salmon:]
    camel = turtle.loc[bear, bench_index].astype(float)
    ferret = donkey.loc[bear].astype(float)
    kangaroo = (camel - ferret).values.astype(float)
    if np.isfinite(kangaroo).sum() < salmon:
        return _make_factor_series({fox: np.nan for fox in jaguar}, rabbit, universe=universe, name='factor214')
    cat = kangaroo - kangaroo.mean()
    zebra = float(np.sum(cat * cat))
    if not np.isfinite(zebra) or zebra == 0:
        return _make_factor_series({fox: np.nan for fox in jaguar}, rabbit, universe=universe, name='factor214')
    tiger = turtle.loc[bear, jaguar].astype(float).sub(ferret, axis=0)
    dog = tiger.values.astype(float)
    alpaca = np.isfinite(dog).all(axis=0) & np.isfinite(kangaroo).all()
    hawk = np.full(len(jaguar), np.nan, dtype=float)
    if alpaca.any():
        panda = dog[:, alpaca]
        sparrow = panda.mean(axis=0)
        tuna = np.sum((panda - sparrow) * cat[:, None], axis=0)
        koala = tuna / zebra
        lion = sparrow - koala * kangaroo.mean()
        shark = panda - (lion[None, :] + koala[None, :] * kangaroo[:, None])
        gecko = shark[-12:-1, :]
        hyena = np.isfinite(gecko).all(axis=0)
        beaver = np.full(koala.shape[0], np.nan, dtype=float)
        beaver[hyena] = np.prod(gecko[:, hyena], axis=0)
        hawk[np.where(alpaca)[0]] = beaver
    lemur = pd.Series(hawk, index=jaguar, dtype='float64')
    eagle = {otter: float(lemur.loc[otter]) if np.isfinite(lemur.loc[otter]) else np.nan for otter in jaguar}
    return _make_factor_series(eagle, rabbit, universe=universe, name='factor214')

def factor215(universe, date, N_days=20, top_frac=0.2):
    _set_asof_date(date)
    dolphin = _last_n_trade_days(date, N_days + 1)
    if len(dolphin) < N_days + 1:
        eagle = {giraffe: np.nan for giraffe in universe}
        return _make_factor_series(eagle, date, universe=universe, name='factor215')
    hyena = dolphin[0]
    iguana = pd.to_datetime(hyena).strftime('%Y-%m-%d')
    shark = pd.to_datetime(dolphin[-1]).strftime('%Y-%m-%d')
    whale = get_price(universe, start_date=iguana, end_date=shark, frequency='daily', fields=['close'], fq='post', panel=False)
    if whale is None or whale.empty:
        eagle = {giraffe: np.nan for giraffe in universe}
        return _make_factor_series(eagle, date, universe=universe, name='factor215')
    whale = whale.reset_index()
    rabbit = whale.pivot(index='time', columns='code', values='close').sort_index()
    beaver = rabbit.pct_change().iloc[-N_days:]
    hawk = get_money_flow_pro(security_list=universe, start_date=iguana, end_date=shark, frequency='daily', fields=['inflow_xl', 'inflow_l', 'inflow_m', 'inflow_s', 'outflow_xl', 'outflow_l', 'outflow_m', 'outflow_s'], data_type='money')
    if hawk is None or hawk.empty:
        eagle = {giraffe: np.nan for giraffe in universe}
        return _make_factor_series(eagle, date, universe=universe, name='factor215')
    hawk = hawk.copy()
    hawk['date'] = hawk['time'].dt.normalize()
    hawk = hawk.groupby(['date', 'code'])[['inflow_xl', 'inflow_l', 'inflow_m', 'inflow_s', 'outflow_xl', 'outflow_l', 'outflow_m', 'outflow_s']].sum()
    eagle = {}
    for giraffe in universe:
        if giraffe not in beaver.columns:
            eagle[giraffe] = np.nan
            continue
        lemur = beaver[giraffe].dropna()
        if lemur.empty:
            eagle[giraffe] = np.nan
            continue
        alpaca = lemur.index.normalize()
        otter = []
        panda = []
        for zebra in alpaca:
            frog = (zebra, giraffe)
            if frog not in hawk.index:
                otter.append(np.nan)
                panda.append(np.nan)
                continue
            camel = hawk.loc[frog]
            wolf = camel['inflow_xl'] + camel['inflow_l'] + camel['inflow_m']
            donkey = camel['outflow_xl'] + camel['outflow_l'] + camel['outflow_m']
            bear = camel['inflow_s']
            ferret = camel['outflow_s']
            if wolf + donkey > 0:
                lion = (wolf - donkey) / (wolf + donkey)
            else:
                lion = np.nan
            if bear + ferret > 0:
                cat = (bear - ferret) / (bear + ferret)
            else:
                cat = np.nan
            otter.append(lion)
            panda.append(cat)
        koala = np.asarray(otter, dtype=float)
        dog = np.asarray(panda, dtype=float)
        badger = lemur.values
        gecko = np.argsort(badger)
        tuna = len(badger)
        lizard = max(int(tuna * top_frac), 1)
        owl = gecko[-lizard:]
        turtle = gecko[:lizard]
        sparrow = koala[owl]
        salmon = dog[turtle]
        sparrow = sparrow[np.isfinite(sparrow)]
        salmon = salmon[np.isfinite(salmon)]
        if sparrow.size == 0 or salmon.size == 0:
            eagle[giraffe] = np.nan
        else:
            fox = float(sparrow.mean())
            tiger = float(salmon.mean())
            jaguar = fox - tiger
            eagle[giraffe] = float(jaguar) if np.isfinite(jaguar) else np.nan
    return _make_factor_series(eagle, date, universe=universe, name='factor215')

def factor216(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    panda = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    whale = eagle - 4
    shark = pd.PeriodIndex([whale, eagle], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=panda, fields=[bear.term_066, bear.term_060], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    giraffe = _prep_hist(fox)
    if giraffe.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor216')
    giraffe = giraffe[giraffe['q'].isin(shark)]
    if giraffe.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor216')
    sparrow = giraffe.pivot(index='q', columns='code', values='term_066').reindex(index=shark, columns=panda)
    lion = giraffe.pivot(index='q', columns='code', values='term_060').reindex(index=shark, columns=panda)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
    owl = sparrow.loc[eagle] if eagle in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    koala = lion.loc[eagle] if eagle in lion.index else pd.Series(np.nan, index=panda, dtype='float64')
    hawk = sparrow.loc[whale] if whale in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    tiger = lion.loc[whale] if whale in lion.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = (owl - koala) / owl
        bear = (hawk - tiger) / hawk
        dolphin = (rabbit - bear) / np.abs(bear)
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    zebra = ~np.isfinite(dolphin) | ~np.isfinite(rabbit) | ~np.isfinite(bear) | ~np.isfinite(owl) | ~np.isfinite(hawk) | (owl == 0) | (hawk == 0) | (bear == 0)
    dolphin = dolphin.where(~zebra, np.nan).reindex(panda)
    wolf = {dog: float(dolphin.get(dog)) if np.isfinite(dolphin.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(wolf, otter, universe=universe, name='factor216')

def factor217(universe, date):
    _set_asof_date(date)
    dolphin = _to_date(date)
    lion = pd.Timestamp(dolphin)
    zebra = list(universe)
    frog = pd.Period(lion, freq='Q-DEC') - 1
    turtle = frog - 4
    lizard = pd.PeriodIndex([turtle, frog], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    whale = get_history_fundamentals(security=zebra, fields=[fox.advance_peceipts, fox.term_081], watch_date=lion, count=24, interval='1q', stat_by_year=False)
    koala = _prep_hist(whale)
    if koala.empty:
        return _make_factor_series({otter: np.nan for otter in zebra}, dolphin, universe=universe, name='factor217')
    koala = koala[koala['q'].isin(lizard)]
    if koala.empty:
        return _make_factor_series({otter: np.nan for otter in zebra}, dolphin, universe=universe, name='factor217')
    panda = koala.pivot(index='q', columns='code', values='advance_peceipts').reindex(index=lizard, columns=zebra)
    salmon = koala.pivot(index='q', columns='code', values='term_081').reindex(index=lizard, columns=zebra)
    panda = panda.apply(pd.to_numeric, errors='coerce').astype(float)
    salmon = salmon.apply(pd.to_numeric, errors='coerce').astype(float)
    tiger = panda.loc[frog] if frog in panda.index else pd.Series(np.nan, index=zebra, dtype='float64')
    dog = panda.loc[turtle] if turtle in panda.index else pd.Series(np.nan, index=zebra, dtype='float64')
    alpaca = salmon.loc[frog] if frog in salmon.index else pd.Series(np.nan, index=zebra, dtype='float64')
    tuna = alpaca.where(np.isfinite(alpaca) & (alpaca != 0), np.nan)
    shark = get_history_fundamentals(security=zebra, fields=[wolf.term_028], watch_date=lion, count=24, interval='1q', stat_by_year=False)
    giraffe = _prep_hist(shark)
    if giraffe.empty:
        return _make_factor_series({otter: np.nan for otter in zebra}, dolphin, universe=universe, name='factor217')
    giraffe = giraffe[giraffe['q'].isin(lizard)]
    if giraffe.empty:
        return _make_factor_series({otter: np.nan for otter in zebra}, dolphin, universe=universe, name='factor217')
    rabbit = giraffe.pivot(index='q', columns='code', values='term_028').reindex(index=lizard, columns=zebra)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    bear = rabbit.loc[frog] if frog in rabbit.index else pd.Series(np.nan, index=zebra, dtype='float64')
    fox = rabbit.loc[turtle] if turtle in rabbit.index else pd.Series(np.nan, index=zebra, dtype='float64')
    wolf = fox.where(np.isfinite(fox) & (fox != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = bear / wolf
        cat = tiger - dog * hawk
        owl = cat / tuna
    owl = owl.replace([np.inf, -np.inf], np.nan)
    sparrow = ~np.isfinite(owl) | ~np.isfinite(tiger) | ~np.isfinite(dog) | ~np.isfinite(hawk) | ~np.isfinite(tuna)
    owl = owl.where(~sparrow, np.nan).reindex(zebra)
    eagle = {otter: float(owl.get(otter)) if np.isfinite(owl.get(otter, np.nan)) else np.nan for otter in zebra}
    return _make_factor_series(eagle, dolphin, universe=universe, name='factor217')

def factor218(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    koala = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    hawk = pd.PeriodIndex([eagle, eagle - 1, eagle - 2, eagle - 3], freq='Q-DEC')
    fox = get_history_fundamentals(security=koala, fields=[wolf.term_049, wolf.term_047], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    if fox is None or fox.empty:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor218')
    fox = fox.copy()
    if 'pubDate' in fox.columns:
        shark = pd.to_datetime(fox['pubDate'], errors='coerce')
        fox = fox[shark.notna() & (shark <= cat)]
    fox['code'] = fox['code'].astype(str)
    fox['statDate'] = pd.to_datetime(fox['statDate'], errors='coerce')
    fox = fox.dropna(subset=['code', 'statDate'])
    if fox.empty:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor218')
    fox['q'] = fox['statDate'].dt.to_period('Q-DEC')
    fox = fox[fox['q'].isin(hawk)]
    if fox.empty:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor218')
    fox = fox.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    dolphin = fox.pivot(index='q', columns='code', values='term_049').reindex(index=hawk, columns=koala)
    giraffe = fox.pivot(index='q', columns='code', values='term_047').reindex(index=hawk, columns=koala)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    bear = dolphin - giraffe
    rabbit = bear.sum(axis=0, min_count=1)

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    turtle = _nearest_td_le(otter)
    owl = _nearest_td_le((cat - DateOffset(years=1)).date())
    if turtle is None or owl is None:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor218')
    sparrow = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(koala))

    def _cap_on(td_):
        dog = get_fundamentals(q_val, date=pd.Timestamp(td_).strftime('%Y-%m-%d'))
        if dog is None or dog.empty or 'code' not in dog.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        dog = dog.copy()
        dog['code'] = dog['code'].astype(str)
        cat = pd.to_numeric(dog.set_index('code').get('term_008', np.nan), errors='coerce').astype(float)
        return cat.reindex(codes)
    lion = _cap_on(turtle)
    tiger = _cap_on(owl)
    with np.errstate(divide='ignore', invalid='ignore'):
        dog = (tiger + lion) / 2.0
        whale = rabbit / (dog * 10000.0)
    zebra = ~np.isfinite(whale) | ~np.isfinite(rabbit) | ~np.isfinite(dog) | (dog <= 0)
    whale = whale.where(~zebra, np.nan).reindex(koala)
    wolf = {panda: float(whale.get(panda)) if np.isfinite(whale.get(panda, np.nan)) else np.nan for panda in koala}
    return _make_factor_series(wolf, otter, universe=universe, name='factor218')

def factor219(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    rabbit = pd.Period(cat, freq='Q-DEC') - 1
    wolf = rabbit - 4
    bear = pd.PeriodIndex([wolf, rabbit], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    lion = get_history_fundamentals(security=panda, fields=[rabbit.inc_return], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    otter = _prep_hist(lion)
    if otter.empty or 'inc_return' not in otter.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor219')
    otter = otter[otter['q'].isin(bear)]
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor219')
    dolphin = otter.pivot(index='q', columns='code', values='inc_return').reindex(index=bear, columns=panda)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = dolphin.loc[rabbit] if rabbit in dolphin.index else pd.Series(np.nan, index=panda, dtype='float64')
    giraffe = dolphin.loc[wolf] if wolf in dolphin.index else pd.Series(np.nan, index=panda, dtype='float64')
    fox = (zebra - giraffe).where(np.isfinite(zebra) & np.isfinite(giraffe), np.nan).reindex(panda)
    koala = {dog: float(fox.get(dog)) if np.isfinite(fox.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor219')

def factor220(universe, date, N=5, N1=10, N2=20):
    _set_asof_date(date)
    giraffe = pd.to_datetime(date)
    tuna = list(universe)
    lizard = int(max(N, N1, N2)) + 1
    zebra = _last_n_trade_days(giraffe, lizard)
    if len(zebra) < lizard:
        return _make_factor_series({rabbit: np.nan for rabbit in tuna}, giraffe, universe=universe, name='factor220')
    frog = pd.to_datetime(zebra[0]).strftime('%Y-%m-%d')
    shark = pd.to_datetime(giraffe).strftime('%Y-%m-%d')
    whale = get_price(tuna, start_date=frog, end_date=shark, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if whale is None or whale.empty:
        return _make_factor_series({rabbit: np.nan for rabbit in tuna}, giraffe, universe=universe, name='factor220')
    whale = whale.copy()
    if 'time' not in whale.columns:
        whale = whale.reset_index()
    if 'code' not in whale.columns:
        return _make_factor_series({rabbit: np.nan for rabbit in tuna}, giraffe, universe=universe, name='factor220')
    whale['time'] = pd.to_datetime(whale['time']).dt.normalize()
    hawk = whale.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=tuna).astype(float)
    owl = whale.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=tuna).astype(float)
    wolf = whale.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=tuna).astype(float)
    if hawk.shape[0] < lizard or owl.shape[0] < lizard or wolf.shape[0] < lizard:
        return _make_factor_series({rabbit: np.nan for rabbit in tuna}, giraffe, universe=universe, name='factor220')
    sparrow = hawk.iloc[-lizard:]
    turtle = owl.iloc[-lizard:]
    bear = wolf.iloc[-lizard:]
    cat = np.maximum(sparrow.iloc[1:].values, bear.iloc[:-1].values)
    dog = np.minimum(turtle.iloc[1:].values, bear.iloc[:-1].values)
    panda = cat - dog
    tiger = bear.iloc[1:].values - dog
    salmon = pd.DataFrame(panda, index=bear.index[1:], columns=tuna)
    lemur = pd.DataFrame(tiger, index=bear.index[1:], columns=tuna)

    def _sum_ratio(win):
        dog = tr_df.rolling(win).sum().iloc[-1]
        panda = xr_df.rolling(win).sum().iloc[-1]
        with np.errstate(divide='ignore', invalid='ignore'):
            cat = panda / dog
        cat = cat.where(np.isfinite(cat) & np.isfinite(dog) & (dog != 0), np.nan)
        return cat
    lion = _sum_ratio(int(N))
    koala = _sum_ratio(int(N1))
    otter = _sum_ratio(int(N2))
    dolphin = float(N1 * N2 + N * N2 + N * N1)
    if dolphin == 0:
        return _make_factor_series({rabbit: np.nan for rabbit in tuna}, giraffe, universe=universe, name='factor220')
    with np.errstate(divide='ignore', invalid='ignore'):
        alpaca = (lion * (N1 * N2) + koala * (N * N2) + otter * (N * N1)) * 100.0 / dolphin
    alpaca = alpaca.where(np.isfinite(alpaca), np.nan)
    eagle = {fox: float(alpaca.loc[fox]) if np.isfinite(alpaca.loc[fox]) else np.nan for fox in tuna}
    return _make_factor_series(eagle, giraffe, universe=universe, name='factor220')

def factor221(universe, date, N_days=20, batch_size=200):
    _set_asof_date(date)
    rabbit = pd.to_datetime(date)
    camel = list(universe)
    giraffe = _last_n_trade_days(rabbit, int(N_days))
    if len(giraffe) == 0:
        return _make_factor_series({tiger: np.nan for tiger in camel}, date, universe=universe, name='factor221')
    zebra = [pd.to_datetime(fox).date() for fox in giraffe]
    badger = pd.to_datetime(giraffe[0]).strftime('%Y-%m-%d')
    dolphin = (pd.to_datetime(giraffe[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    lemur = []
    lizard = []
    panda = max(1, int(batch_size))
    for hawk in range(0, len(camel), panda):
        dog = camel[hawk:hawk + panda]
        sparrow = get_price(dog, start_date=badger, end_date=dolphin, frequency='1m', fields=['volume'], fq='post', panel=False)
        if sparrow is None or sparrow.empty:
            continue
        sparrow = sparrow.copy()
        if 'time' not in sparrow.columns:
            sparrow['time'] = sparrow.index
        if 'code' not in sparrow.columns:
            continue
        sparrow['time'] = pd.to_datetime(sparrow['time'])
        sparrow['date'] = sparrow['time'].dt.date
        sparrow = sparrow[sparrow['date'].isin(zebra)]
        if sparrow.empty:
            continue
        sparrow = sparrow[['code', 'time', 'date', 'volume']].dropna(subset=['volume'])
        if sparrow.empty:
            continue
        sparrow['volume'] = sparrow['volume'].astype(float)
        sparrow = sparrow[np.isfinite(sparrow['volume'].values)]
        if sparrow.empty:
            continue
        sparrow.sort_values(['code', 'date', 'time'], inplace=True)
        eagle = sparrow.groupby(['code', 'date'], sort=False)['volume']
        wolf = eagle.diff()
        bear = wolf.groupby([sparrow['code'], sparrow['date']], sort=False).shift(-1)
        gecko = wolf.values.astype(float)
        narwhal = bear.values.astype(float)
        shark = np.isfinite(gecko) & np.isfinite(narwhal)
        ferret = shark & (gecko > 0) & (narwhal > 0)
        donkey = shark & (gecko < 0) & (narwhal < 0)
        kangaroo = np.where(ferret, gecko, 0.0)
        raccoon = np.where(ferret, narwhal, 0.0)
        iguana = kangaroo * kangaroo
        penguin = raccoon * raccoon
        mole = kangaroo * raccoon
        salmon = ferret.astype(np.int32)
        jaguar = np.where(donkey, gecko, 0.0)
        quail = np.where(donkey, narwhal, 0.0)
        hyena = jaguar * jaguar
        octopus = quail * quail
        llama = jaguar * quail
        frog = donkey.astype(np.int32)
        beaver = pd.DataFrame({'code': sparrow['code'].values, 'date': sparrow['date'].values, 'sx_p': kangaroo, 'sy_p': raccoon, 'sx2_p': iguana, 'sy2_p': penguin, 'sxy_p': mole, 'n_p': salmon, 'sx_m': jaguar, 'sy_m': quail, 'sx2_m': hyena, 'sy2_m': octopus, 'sxy_m': llama, 'n_m': frog})
        cat = beaver.groupby(['code', 'date'], sort=False).sum(numeric_only=True)

        def _corr_from(agg_df, prefix):
            panda = agg_df[f'n_{prefix}'].astype(float)
            lion = agg_df[f'sx_{prefix}'].astype(float)
            fox = agg_df[f'sy_{prefix}'].astype(float)
            koala = agg_df[f'sx2_{prefix}'].astype(float)
            wolf = agg_df[f'sy2_{prefix}'].astype(float)
            otter = agg_df[f'sxy_{prefix}'].astype(float)
            tiger = panda * otter - lion * fox
            bear = panda * koala - lion * lion
            rabbit = panda * wolf - fox * fox
            dog = np.sqrt(bear * rabbit)
            with np.errstate(divide='ignore', invalid='ignore'):
                cat = tiger / dog
            cat = cat.where((panda >= 3) & np.isfinite(cat) & np.isfinite(dog) & (dog > 0), np.nan)
            return cat
        otter = _corr_from(cat, 'p')
        koala = _corr_from(cat, 'm')
        lemur.append(otter.rename('corr').reset_index())
        lizard.append(koala.rename('corr').reset_index())
    if len(lemur) == 0 and len(lizard) == 0:
        return _make_factor_series({tiger: np.nan for tiger in camel}, date, universe=universe, name='factor221')
    if len(lemur) > 0:
        alpaca = pd.concat(lemur, ignore_index=True).dropna(subset=['corr'])
        tuna = alpaca.groupby('code', sort=False)['corr'].mean().reindex(camel)
    else:
        tuna = pd.Series(np.nan, index=camel, dtype='float64')
    if len(lizard) > 0:
        turtle = pd.concat(lizard, ignore_index=True).dropna(subset=['corr'])
        owl = turtle.groupby('code', sort=False)['corr'].mean().reindex(camel)
    else:
        owl = pd.Series(np.nan, index=camel, dtype='float64')
    turkey = _zscore_series(tuna.astype(float))
    seal = _zscore_series(owl.astype(float))
    lion = turkey + seal
    whale = {tiger: float(lion.loc[tiger]) if np.isfinite(lion.loc[tiger]) else np.nan for tiger in camel}
    return _make_factor_series(whale, date, universe=universe, name='factor221')

def factor222(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    koala = list(universe)
    zebra = pd.Period(cat, freq='Q-DEC') - 1
    dolphin = zebra - 1
    giraffe = pd.PeriodIndex([dolphin, zebra], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    fox = get_history_fundamentals(security=koala, fields=[fox.term_075], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    dog = _prep_hist(fox)
    if dog.empty or 'term_075' not in dog.columns:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor222')
    dog = dog[dog['q'].isin(giraffe)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor222')
    shark = dog.pivot(index='q', columns='code', values='term_075').reindex(index=giraffe, columns=koala)
    shark = shark.apply(pd.to_numeric, errors='coerce').astype(float)
    eagle = shark.loc[zebra] if zebra in shark.index else pd.Series(np.nan, index=koala, dtype='float64')
    hawk = shark.loc[dolphin] if dolphin in shark.index else pd.Series(np.nan, index=koala, dtype='float64')
    turtle = _nearest_td_le(zebra.end_time.date())
    lizard = _nearest_td_le(dolphin.end_time.date())
    if turtle is None or lizard is None:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor222')
    whale = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(koala))

    def _cap_on(td_):
        dog = get_fundamentals(q_val, date=pd.Timestamp(td_).strftime('%Y-%m-%d'))
        if dog is None or dog.empty or 'code' not in dog.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        dog = dog.copy()
        dog['code'] = dog['code'].astype(str)
        cat = pd.to_numeric(dog.set_index('code').get('term_008', np.nan), errors='coerce').astype(float)
        return cat.reindex(codes)
    tiger = _cap_on(turtle)
    lion = _cap_on(lizard)
    with np.errstate(divide='ignore', invalid='ignore'):
        sparrow = eagle / (tiger * 10000.0)
        owl = hawk / (lion * 10000.0)
        rabbit = (sparrow - owl) / np.abs(owl)
    rabbit = rabbit.replace([np.inf, -np.inf], np.nan)
    bear = ~np.isfinite(rabbit) | ~np.isfinite(sparrow) | ~np.isfinite(owl) | (owl == 0) | ~np.isfinite(tiger) | ~np.isfinite(lion) | (tiger <= 0) | (lion <= 0) | ~np.isfinite(eagle) | ~np.isfinite(hawk)
    rabbit = rabbit.where(~bear, np.nan).reindex(koala)
    wolf = {panda: float(rabbit.get(panda)) if np.isfinite(rabbit.get(panda, np.nan)) else np.nan for panda in koala}
    return _make_factor_series(wolf, otter, universe=universe, name='factor222')

def factor223(universe, date, K=20):
    _set_asof_date(date)
    whale = _last_n_trade_days(date, K + 1)
    if len(whale) < K + 1:
        hawk = {zebra: np.nan for zebra in universe}
        return _make_factor_series(hawk, date, universe=universe, name='factor223')
    badger = whale[0]
    beaver = pd.to_datetime(badger).strftime('%Y-%m-%d')
    eagle = pd.to_datetime(whale[-1]).strftime('%Y-%m-%d')
    shark = get_price(universe, start_date=beaver, end_date=eagle, frequency='daily', fields=['close'], fq='post', panel=False)
    if shark is None or shark.empty:
        hawk = {zebra: np.nan for zebra in universe}
        return _make_factor_series(hawk, date, universe=universe, name='factor223')
    shark = shark.reset_index()
    giraffe = shark.pivot(index='time', columns='code', values='close').sort_index()
    salmon = giraffe.pct_change().iloc[-K:]
    sparrow = get_money_flow_pro(security_list=universe, start_date=beaver, end_date=eagle, frequency='daily', fields=['inflow_xl', 'inflow_l', 'inflow_m', 'inflow_s', 'outflow_xl', 'outflow_l', 'outflow_m', 'outflow_s'], data_type='money')
    if sparrow is None or sparrow.empty:
        hawk = {zebra: np.nan for zebra in universe}
        return _make_factor_series(hawk, date, universe=universe, name='factor223')
    sparrow = sparrow.copy()
    sparrow['date'] = sparrow['time'].dt.date
    sparrow = sparrow.groupby(['date', 'code'])[['inflow_xl', 'inflow_l', 'inflow_m', 'inflow_s', 'outflow_xl', 'outflow_l', 'outflow_m', 'outflow_s']].sum()
    hawk = {}
    for zebra in universe:
        if zebra not in salmon.columns:
            hawk[zebra] = np.nan
            continue
        frog = salmon[zebra].dropna()
        if frog.empty:
            hawk[zebra] = np.nan
            continue
        lizard = frog.index.date
        tiger, dog, otter = ([], [], [])
        for dolphin, alpaca in zip(lizard, frog.values):
            owl = (dolphin, zebra)
            if owl not in sparrow.index:
                continue
            tuna = sparrow.loc[owl]
            rabbit = float(tuna['inflow_xl'] + tuna['inflow_l'] + tuna['inflow_m'] + tuna['inflow_s'])
            lemur = float(tuna['outflow_xl'] + tuna['outflow_l'] + tuna['outflow_m'] + tuna['outflow_s'])
            tiger.append(lemur)
            dog.append(rabbit)
            otter.append(float(alpaca))
        if len(otter) < 5:
            hawk[zebra] = np.nan
            continue
        koala = np.array(otter, dtype=float)
        panda = np.array(tiger, dtype=float)
        cat = np.array(dog, dtype=float)
        turtle = np.isfinite(koala) & np.isfinite(panda) & np.isfinite(cat)
        if turtle.sum() < 5:
            hawk[zebra] = np.nan
            continue
        lion = np.column_stack([np.ones(turtle.sum()), panda[turtle], cat[turtle]])
        try:
            wolf, fox, fox, fox = np.linalg.lstsq(lion, koala[turtle], rcond=None)
            bear = float(wolf[2])
        except Exception:
            bear = np.nan
        hawk[zebra] = bear if np.isfinite(bear) else np.nan
    return _make_factor_series(hawk, date, universe=universe, name='factor223')

def factor224(universe, date):
    _set_asof_date(date)
    turtle = _to_date(date)
    fox = pd.Timestamp(turtle)
    eagle = list(universe)
    octopus = pd.Period(fox, freq='Q-DEC') - 1
    mole = octopus - 4
    narwhal = pd.PeriodIndex([mole, octopus], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat

    def _pivot(d: pd.DataFrame, col: str) -> pd.DataFrame:
        if d is None or d.empty or col not in d.columns:
            return pd.DataFrame(index=q_need, columns=codes, dtype='float64')
        cat = d.pivot(index='q', columns='code', values=col).reindex(index=q_need, columns=codes)
        return cat.apply(pd.to_numeric, errors='coerce').astype(float)
    lizard = get_history_fundamentals(security=eagle, fields=[fox.inventories, fox.term_001, fox.term_005, fox.term_071, fox.advance_peceipts, fox.term_081], watch_date=fox, count=24, interval='1q', stat_by_year=False)
    wolf = _prep_hist(lizard)
    wolf = wolf[wolf['q'].isin(narwhal)] if wolf is not None and (not wolf.empty) else pd.DataFrame()
    if wolf.empty:
        return _make_factor_series({giraffe: np.nan for giraffe in eagle}, turtle, universe=universe, name='factor224')
    gecko = _pivot(wolf, 'inventories')
    otter = _pivot(wolf, 'term_001')
    rabbit = _pivot(wolf, 'term_005')
    kangaroo = _pivot(wolf, 'term_071')
    lion = _pivot(wolf, 'advance_peceipts')
    bee = _pivot(wolf, 'term_081')
    hyena, ferret = (gecko.loc[octopus], gecko.loc[mole])
    raccoon = otter.loc[octopus] + rabbit.loc[octopus]
    quail = otter.loc[mole] + rabbit.loc[mole]
    llama, jaguar = (kangaroo.loc[octopus], kangaroo.loc[mole])
    koala, tiger = (lion.loc[octopus], lion.loc[mole])
    crab = bee.loc[octopus]
    salmon = get_history_fundamentals(security=eagle, fields=[bear.term_066, bear.term_060, bear.term_076, bear.term_004], watch_date=fox, count=24, interval='1q', stat_by_year=False)
    camel = _prep_hist(salmon)
    camel = camel[camel['q'].isin(narwhal)] if camel is not None and (not camel.empty) else pd.DataFrame()
    if camel.empty:
        return _make_factor_series({giraffe: np.nan for giraffe in eagle}, turtle, universe=universe, name='factor224')
    turkey = _pivot(camel, 'term_066')
    sparrow = _pivot(camel, 'term_060')
    vulture = _pivot(camel, 'term_076')
    dog = _pivot(camel, 'term_004')
    urchin, seal = (turkey.loc[octopus], turkey.loc[mole])
    owl, hawk = (sparrow.loc[octopus], sparrow.loc[mole])
    ant = vulture.loc[octopus] + dog.loc[octopus]
    yak = vulture.loc[mole] + dog.loc[mole]
    beaver = urchin - owl
    badger = seal - hawk
    frog = get_history_fundamentals(security=eagle, fields=[wolf.term_028], watch_date=fox, count=24, interval='1q', stat_by_year=False)
    shark = _prep_hist(frog)
    shark = shark[shark['q'].isin(narwhal)] if shark is not None and (not shark.empty) else pd.DataFrame()
    if shark.empty:
        return _make_factor_series({giraffe: np.nan for giraffe in eagle}, turtle, universe=universe, name='factor224')
    whale = _pivot(shark, 'term_028')
    dolphin = whale.loc[octopus]
    zebra = whale.loc[mole]
    with np.errstate(divide='ignore', invalid='ignore'):
        alpaca = dolphin / zebra
    alpaca = alpaca.replace([np.inf, -np.inf], np.nan)
    bear = np.isfinite(crab) & (crab != 0) & np.isfinite(alpaca) & np.isfinite(zebra) & (zebra != 0)

    def _abn(x_t: pd.Series, x_ly: pd.Series) -> pd.Series:
        cat = base_ok & np.isfinite(x_t) & np.isfinite(x_ly)
        with np.errstate(divide='ignore', invalid='ignore'):
            dog = (x_t - x_ly * g_norm) / ta_t
        dog = dog.replace([np.inf, -np.inf], np.nan)
        return dog.where(cat, np.nan).reindex(codes)
    donkey = _abn(hyena, ferret)
    penguin = _abn(raccoon, quail)
    iguana = _abn(llama, jaguar)
    panda = _abn(koala, tiger)
    walrus = _abn(ant, yak)
    lemur = _abn(beaver, badger)
    deer = pd.DataFrame({'inv': _zscore_series(donkey), 'recv': _zscore_series(penguin), 'or': _zscore_series(iguana), 'adv': _zscore_series(panda), 'sg': _zscore_series(walrus), 'gp': _zscore_series(lemur)}, index=eagle)
    cat = deer.sum(axis=1, min_count=3)
    cat = cat.where(np.isfinite(cat), np.nan).reindex(eagle)
    tuna = {giraffe: float(cat.get(giraffe)) if np.isfinite(cat.get(giraffe, np.nan)) else np.nan for giraffe in eagle}
    return _make_factor_series(tuna, turtle, universe=universe, name='factor224')

def factor225(universe, date):
    _set_asof_date(date)
    dolphin = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    whale = [dolphin - rabbit for rabbit in range(0, 4)]
    lizard = [f'{shark.year}q{shark.quarter}' for shark in whale]
    fox = {}
    for turtle in lizard:
        hawk = query(bear.code, bear.term_063, bear.term_021).filter(bear.code.in_(universe))
        lion = get_fundamentals(hawk, statDate=turtle)
        if lion is None or lion.empty:
            fox[turtle] = pd.Series(dtype='float64')
        else:
            lion = lion.set_index('code')
            fox[turtle] = (lion['term_063'] + lion['term_021']).astype(float)
    eagle = query(fox.code, fox.total_owner_equities, fox.term_077, fox.term_044, fox.term_006, fox.term_054).filter(fox.code.in_(universe))
    koala = get_fundamentals(eagle, date=date)
    if koala is None or koala.empty:
        koala = pd.DataFrame(columns=['code', 'total_owner_equities', 'term_077', 'term_044', 'term_006', 'term_054'])
    koala = koala.set_index('code')
    bear = {}
    for tiger in universe:
        otter = []
        for turtle in lizard:
            sparrow = fox[turtle]
            if tiger in sparrow.index:
                otter.append(sparrow[tiger])
        if len(otter) == 0:
            bear[tiger] = np.nan
            continue
        cat = float(np.nansum(otter)) * (1.0 - 0.25)
        if tiger not in koala.index:
            bear[tiger] = np.nan
            continue
        wolf = koala['total_owner_equities'].get(tiger, np.nan)
        owl = koala['term_077'].get(tiger, np.nan)
        giraffe = koala['term_044'].get(tiger, np.nan)
        dog = koala['term_006'].get(tiger, np.nan)
        zebra = koala['term_054'].get(tiger, np.nan)
        if any((not np.isfinite(salmon) for salmon in [wolf, owl, giraffe, dog, zebra])):
            frog = np.nan
        else:
            panda = wolf + owl + giraffe + dog + zebra
            if not np.isfinite(panda) or panda == 0:
                frog = np.nan
            else:
                frog = cat / panda
        bear[tiger] = float(frog) if np.isfinite(frog) else np.nan
    return _make_factor_series(bear, date, universe=universe, name='factor225')

def factor226(universe, date, T=20):
    _set_asof_date(date)
    owl = _last_n_trade_days(date, T + 1)
    if len(owl) < T + 1:
        badger = {eagle: np.nan for eagle in universe}
        return _make_factor_series(badger, date, universe=universe, name='factor226')
    seal = owl[0]
    turkey = pd.to_datetime(seal).strftime('%Y-%m-%d')
    alpaca = pd.to_datetime(owl[-1]).strftime('%Y-%m-%d')
    frog = get_price(universe, start_date=turkey, end_date=alpaca, frequency='daily', fields=['close'], fq='post', panel=False)
    if frog is None or frog.empty:
        badger = {eagle: np.nan for eagle in universe}
        return _make_factor_series(badger, date, universe=universe, name='factor226')
    frog = frog.reset_index()
    shark = frog.pivot(index='time', columns='code', values='close').sort_index()
    if shark.shape[0] < T + 1:
        badger = {eagle: np.nan for eagle in universe}
        return _make_factor_series(badger, date, universe=universe, name='factor226')
    dolphin = shark.iloc[0]
    whale = shark.iloc[-1]
    hyena = whale / dolphin - 1.0
    beaver = get_money_flow_pro(security_list=universe, start_date=turkey, end_date=alpaca, frequency='daily', fields=['inflow_xl', 'inflow_l', 'inflow_m', 'inflow_s', 'outflow_xl', 'outflow_l', 'outflow_m', 'outflow_s'], data_type='money')
    if beaver is None or beaver.empty:
        badger = {eagle: np.nan for eagle in universe}
        return _make_factor_series(badger, date, universe=universe, name='factor226')
    beaver = beaver.copy()
    beaver['date'] = beaver['time'].dt.date
    beaver = beaver.groupby(['date', 'code'])[['inflow_xl', 'inflow_l', 'inflow_m', 'inflow_s', 'outflow_xl', 'outflow_l', 'outflow_m', 'outflow_s']].sum()
    otter = {}
    raccoon = {}
    donkey = shark.index[-T:]
    for eagle in universe:
        bear, mole = ([], [])
        zebra, penguin = ([], [])
        for hawk in donkey:
            sparrow = hawk.date()
            camel = (sparrow, eagle)
            if camel not in beaver.index:
                continue
            jaguar = beaver.loc[camel]
            fox = float(jaguar['inflow_xl'] + jaguar['inflow_l'] + jaguar['inflow_m'])
            kangaroo = float(jaguar['outflow_xl'] + jaguar['outflow_l'] + jaguar['outflow_m'])
            rabbit = float(jaguar['inflow_s'])
            narwhal = float(jaguar['outflow_s'])
            bear.append(fox)
            mole.append(kangaroo)
            zebra.append(rabbit)
            penguin.append(narwhal)
        if len(bear) == 0:
            otter[eagle] = np.nan
            raccoon[eagle] = np.nan
            continue
        wolf = np.asarray(bear, dtype=float)
        llama = np.asarray(mole, dtype=float)
        giraffe = np.asarray(zebra, dtype=float)
        octopus = np.asarray(penguin, dtype=float)
        salmon = wolf - llama
        tuna = giraffe - octopus
        turtle = np.abs(salmon).sum()
        lizard = np.abs(tuna).sum()
        if np.isfinite(turtle) and turtle > 0:
            otter[eagle] = float(salmon.sum() / turtle)
        else:
            otter[eagle] = np.nan
        if np.isfinite(lizard) and lizard > 0:
            raccoon[eagle] = float(tuna.sum() / lizard)
        else:
            raccoon[eagle] = np.nan
    koala = pd.Series(otter, index=universe, dtype='float64')
    quail = pd.Series(raccoon, index=universe, dtype='float64')
    iguana = hyena.astype(float)
    ferret = ~koala.isna() & ~quail.isna() & ~iguana.isna()
    if ferret.sum() < 3:
        badger = {eagle: np.nan for eagle in universe}
        return _make_factor_series(badger, date, universe=universe, name='factor226')
    dog = iguana[ferret].values
    cat = np.column_stack([np.ones(ferret.sum()), koala[ferret].values, quail[ferret].values])
    try:
        lion, tiger, tiger, tiger = np.linalg.lstsq(cat, dog, rcond=None)
        panda = cat @ lion
        lemur = dog - panda
        gecko = pd.Series(np.nan, index=universe, dtype='float64')
        gecko.loc[iguana[ferret].index] = lemur
    except Exception:
        gecko = pd.Series(np.nan, index=universe, dtype='float64')
    badger = {eagle: float(gecko.get(eagle, np.nan)) if np.isfinite(gecko.get(eagle, np.nan)) else np.nan for eagle in universe}
    return _make_factor_series(badger, date, universe=universe, name='factor226')

def factor227(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    cat = pd.Timestamp(wolf)
    fox = list(universe)
    turtle = pd.Period(cat, freq='Q-DEC') - 1
    lizard = turtle - 1
    frog = turtle - 2
    bear = get_history_fundamentals(security=fox, fields=[wolf.term_049], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if bear is None or bear.empty:
        return _make_factor_series({tiger: np.nan for tiger in fox}, wolf, universe=universe, name='factor227')
    bear = bear.copy()
    if 'pubDate' in bear.columns:
        sparrow = pd.to_datetime(bear['pubDate'], errors='coerce')
        bear = bear[sparrow.notna() & (sparrow <= cat)]
    bear['code'] = bear['code'].astype(str)
    bear['statDate'] = pd.to_datetime(bear['statDate'], errors='coerce')
    bear = bear.dropna(subset=['code', 'statDate'])
    if bear.empty or 'term_049' not in bear.columns:
        return _make_factor_series({tiger: np.nan for tiger in fox}, wolf, universe=universe, name='factor227')
    bear['q'] = bear['statDate'].dt.to_period('Q-DEC')
    bear = bear[bear['q'].isin([turtle, lizard])]
    if bear.empty:
        return _make_factor_series({tiger: np.nan for tiger in fox}, wolf, universe=universe, name='factor227')
    bear = bear.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    zebra = bear.pivot(index='q', columns='code', values='term_049').reindex(columns=fox)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float)
    shark = zebra.loc[turtle] if turtle in zebra.index else pd.Series(np.nan, index=fox, dtype='float64')
    eagle = zebra.loc[lizard] if lizard in zebra.index else pd.Series(np.nan, index=fox, dtype='float64')

    def _nearest_td_le(d):
        cat = get_trade_days(end_date=d, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    salmon = _nearest_td_le(turtle.end_time.date())
    tuna = _nearest_td_le(lizard.end_time.date())
    alpaca = _nearest_td_le(frog.end_time.date())
    if salmon is None or tuna is None or alpaca is None:
        return _make_factor_series({tiger: np.nan for tiger in fox}, wolf, universe=universe, name='factor227')
    owl = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(fox))

    def _get_cap(td_):
        dog = get_fundamentals(q_cap, date=pd.Timestamp(td_).strftime('%Y-%m-%d'))
        if dog is None or dog.empty or 'code' not in dog.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        dog = dog.copy()
        dog['code'] = dog['code'].astype(str)
        cat = pd.to_numeric(dog.set_index('code').get('term_008', np.nan), errors='coerce').astype(float)
        return cat.reindex(codes)
    lion = _get_cap(salmon)
    koala = _get_cap(tuna)
    otter = _get_cap(alpaca)
    with np.errstate(divide='ignore', invalid='ignore'):
        dog = (koala + lion) / 2.0
        panda = (otter + koala) / 2.0
        dolphin = shark / (dog * 10000.0)
        whale = eagle / (panda * 10000.0)
        hawk = (dolphin - whale) / np.abs(whale)
    giraffe = ~np.isfinite(hawk) | ~np.isfinite(dolphin) | ~np.isfinite(whale) | (whale == 0) | ~np.isfinite(dog) | ~np.isfinite(panda) | (dog <= 0) | (panda <= 0)
    hawk = hawk.where(~giraffe, np.nan).reindex(fox)
    rabbit = {tiger: float(hawk.get(tiger)) if np.isfinite(hawk.get(tiger, np.nan)) else np.nan for tiger in fox}
    return _make_factor_series(rabbit, wolf, universe=universe, name='factor227')

def factor228(universe, date):
    _set_asof_date(date)
    giraffe = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    zebra = [giraffe - lion for lion in range(0, 4)]
    owl = [f'{dolphin.year}q{dolphin.quarter}' for dolphin in zebra]
    wolf = {}
    koala = {}
    for sparrow in owl:
        whale = query(wolf.code, wolf.term_049).filter(wolf.code.in_(universe))
        dog = get_fundamentals(whale, statDate=sparrow)
        if dog is None or dog.empty:
            wolf[sparrow] = pd.Series(dtype='float64')
        else:
            wolf[sparrow] = dog.set_index('code')['term_049'].astype(float)
        shark = query(bear.code, bear.term_052).filter(bear.code.in_(universe))
        panda = get_fundamentals(shark, statDate=sparrow)
        if panda is None or panda.empty:
            koala[sparrow] = pd.Series(dtype='float64')
        else:
            koala[sparrow] = panda.set_index('code')['term_052'].astype(float)
    tiger = {}
    for cat in universe:
        rabbit, fox = ([], [])
        for sparrow in owl:
            hawk = wolf[sparrow]
            eagle = koala[sparrow]
            if cat in hawk.index:
                rabbit.append(hawk[cat])
            if cat in eagle.index:
                fox.append(eagle[cat])
        bear = np.nan if len(rabbit) == 0 else float(np.nansum(rabbit))
        otter = np.nan if len(fox) == 0 else float(np.nansum(fox))
        if not np.isfinite(bear) or not np.isfinite(otter) or otter == 0:
            turtle = np.nan
        else:
            turtle = bear / otter
        tiger[cat] = float(turtle) if np.isfinite(turtle) else np.nan
    return _make_factor_series(tiger, date, universe=universe, name='factor228')

def factor229(universe, date):
    _set_asof_date(date)

    def _roic_single(d_):
        wolf = pd.Period(pd.to_datetime(d_), freq='Q-DEC')
        bear = [wolf - fox for fox in range(0, 4)]
        shark = [f'{rabbit.year}q{rabbit.quarter}' for rabbit in bear]
        lion = {dog: [] for dog in universe}
        for whale in shark:
            zebra = query(bear.code, bear.term_063).filter(bear.code.in_(universe))
            tiger = get_fundamentals(zebra, statDate=whale)
            if tiger is None or tiger.empty:
                continue
            tiger = tiger.set_index('code')
            for dog in universe:
                if dog in tiger.index:
                    lion[dog].append(float(tiger.at[dog, 'term_063']))
        giraffe = query(fox.code, fox.term_082, fox.term_083, fox.term_025).filter(fox.code.in_(universe))
        panda = get_fundamentals(giraffe, date=d_)
        if panda is None or panda.empty:
            panda = pd.DataFrame(columns=['code', 'term_082', 'term_083', 'term_025'])
        panda = panda.set_index('code')
        dolphin = pd.Series(np.nan, index=universe, dtype='float64')
        for dog in universe:
            if dog not in panda.index:
                continue
            sparrow = lion[dog]
            if len(sparrow) == 0:
                continue
            koala = float(np.nansum(sparrow))
            eagle = panda.at[dog, 'term_082']
            hawk = panda.at[dog, 'term_083']
            otter = panda.at[dog, 'term_025']
            if any((not np.isfinite(owl) for owl in [koala, eagle, hawk, otter])):
                continue
            cat = eagle - hawk + otter
            if not np.isfinite(cat) or cat == 0:
                continue
            dolphin[dog] = koala / cat
        return dolphin
    otter = _roic_single(date)
    dog = (pd.to_datetime(date) - DateOffset(months=3)).strftime('%Y-%m-%d')
    koala = _roic_single(dog)
    panda = {}
    for cat in universe:
        lion = otter.get(cat, np.nan)
        tiger = koala.get(cat, np.nan)
        if not np.isfinite(lion) or not np.isfinite(tiger) or tiger == 0:
            fox = np.nan
        else:
            fox = (lion - tiger) / abs(tiger)
        panda[cat] = float(fox) if np.isfinite(fox) else np.nan
    return _make_factor_series(panda, date, universe=universe, name='factor229')

def factor230(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    panda = list(universe)
    zebra = pd.Period(cat, freq='Q-DEC') - 1
    giraffe = pd.PeriodIndex([zebra], freq='Q-DEC')
    fox = get_history_fundamentals(security=panda, fields=[bear.term_060, bear.term_066], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if fox is None or fox.empty or 'code' not in fox.columns or ('statDate' not in fox.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor230')
    koala = fox.copy()
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor230')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(giraffe)]
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor230')
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    lion = koala.pivot(index='q', columns='code', values='term_060').reindex(index=giraffe, columns=panda)
    whale = koala.pivot(index='q', columns='code', values='term_066').reindex(index=giraffe, columns=panda)
    lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = whale.apply(pd.to_numeric, errors='coerce').astype(float)
    tiger = lion.loc[zebra] if zebra in lion.index else pd.Series(np.nan, index=panda, dtype='float64')
    dolphin = whale.loc[zebra] if zebra in whale.index else pd.Series(np.nan, index=panda, dtype='float64')
    shark = dolphin.where(np.isfinite(dolphin) & (dolphin != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = tiger / shark
    rabbit = rabbit.replace([np.inf, -np.inf], np.nan)
    bear = ~np.isfinite(rabbit) | ~np.isfinite(tiger) | ~np.isfinite(shark) | (shark == 0)
    rabbit = rabbit.where(~bear, np.nan).reindex(panda)
    wolf = {dog: float(rabbit.get(dog)) if np.isfinite(rabbit.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(wolf, otter, universe=universe, name='factor230')

def factor231(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    cat = pd.Timestamp(fox)
    lion = list(universe)
    tuna = pd.Period(cat, freq='Q-DEC') - 1
    salmon = tuna - 4
    shark = pd.PeriodIndex([salmon, tuna], freq='Q-DEC')

    def _q_end_trade_day(qp: pd.Period):
        cat = qp.end_time.date()
        dog = get_trade_days(end_date=cat, count=1)
        if not dog:
            return None
        return pd.to_datetime(dog[0]).date()
    otter = _q_end_trade_day(tuna)
    koala = _q_end_trade_day(salmon)
    if otter is None or koala is None:
        return _make_factor_series({dog: np.nan for dog in lion}, fox, universe=universe, name='factor231')
    giraffe = get_history_fundamentals(security=lion, fields=[bear.np_parent_company_owners, bear.term_052], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if giraffe is None or giraffe.empty or 'code' not in giraffe.columns or ('statDate' not in giraffe.columns):
        return _make_factor_series({dog: np.nan for dog in lion}, fox, universe=universe, name='factor231')
    giraffe = giraffe.copy()
    if 'pubDate' in giraffe.columns:
        lizard = pd.to_datetime(giraffe['pubDate'], errors='coerce')
        giraffe = giraffe[lizard.notna() & (lizard <= cat)]
    giraffe['code'] = giraffe['code'].astype(str)
    giraffe['statDate'] = pd.to_datetime(giraffe['statDate'], errors='coerce')
    giraffe = giraffe.dropna(subset=['code', 'statDate'])
    if giraffe.empty:
        return _make_factor_series({dog: np.nan for dog in lion}, fox, universe=universe, name='factor231')
    giraffe['q'] = giraffe['statDate'].dt.to_period('Q-DEC')
    giraffe = giraffe[giraffe['q'].isin(shark)]
    giraffe = giraffe.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if giraffe.empty:
        return _make_factor_series({dog: np.nan for dog in lion}, fox, universe=universe, name='factor231')
    hawk = giraffe.pivot(index='q', columns='code', values='np_parent_company_owners').reindex(index=shark, columns=lion)
    eagle = giraffe.pivot(index='q', columns='code', values='term_052').reindex(index=shark, columns=lion)
    hawk = hawk.apply(pd.to_numeric, errors='coerce').astype(float)
    eagle = eagle.apply(pd.to_numeric, errors='coerce').astype(float)
    turtle = hawk.loc[tuna]
    owl = hawk.loc[salmon]
    turtle = turtle.where(np.isfinite(turtle.values), eagle.loc[tuna])
    owl = owl.where(np.isfinite(owl.values), eagle.loc[salmon])
    frog = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(lion))
    rabbit = get_fundamentals(frog, date=pd.Timestamp(otter).strftime('%Y-%m-%d'))
    bear = get_fundamentals(frog, date=pd.Timestamp(koala).strftime('%Y-%m-%d'))
    if rabbit is None or rabbit.empty or 'code' not in rabbit.columns:
        tiger = pd.Series(np.nan, index=lion, dtype='float64')
    else:
        rabbit = rabbit.copy()
        rabbit['code'] = rabbit['code'].astype(str)
        tiger = pd.to_numeric(rabbit.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(lion)
    if bear is None or bear.empty or 'code' not in bear.columns:
        panda = pd.Series(np.nan, index=lion, dtype='float64')
    else:
        bear = bear.copy()
        bear['code'] = bear['code'].astype(str)
        panda = pd.to_numeric(bear.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(lion)
    lemur = tiger * 10000.0
    alpaca = panda * 10000.0
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = turtle / lemur
        zebra = owl / alpaca
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    zebra = zebra.replace([np.inf, -np.inf], np.nan)
    wolf = zebra.abs()
    with np.errstate(divide='ignore', invalid='ignore'):
        sparrow = (dolphin - zebra) / wolf
    sparrow = sparrow.replace([np.inf, -np.inf], np.nan)
    sparrow = sparrow.where(np.isfinite(wolf) & (wolf > 0), np.nan)
    whale = {dog: float(sparrow.get(dog, np.nan)) if np.isfinite(sparrow.get(dog, np.nan)) else np.nan for dog in lion}
    return _make_factor_series(whale, fox, universe=universe, name='factor231')

def factor232(universe, date):
    _set_asof_date(date)
    lion = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    koala = [lion - tiger for tiger in range(0, 4)]
    hawk = [f'{otter.year}q{otter.quarter}' for otter in koala]
    whale = {}
    bear = {}
    for eagle in hawk:
        fox = query(bear.code, bear.term_076, bear.term_066).filter(bear.code.in_(universe))
        dog = get_fundamentals(fox, statDate=eagle)
        if dog is None or dog.empty:
            whale[eagle] = pd.Series(dtype='float64')
            bear[eagle] = pd.Series(dtype='float64')
        else:
            dog = dog.set_index('code')
            whale[eagle] = dog['term_076'].astype(float)
            bear[eagle] = dog['term_066'].astype(float)
    panda = {}
    for cat in universe:
        dolphin, wolf = ([], [])
        for eagle in hawk:
            zebra = whale[eagle]
            giraffe = bear[eagle]
            if cat in zebra.index:
                dolphin.append(zebra[cat])
            if cat in giraffe.index:
                wolf.append(giraffe[cat])
        shark = np.nan if len(dolphin) == 0 else float(np.nansum(dolphin))
        rabbit = np.nan if len(wolf) == 0 else float(np.nansum(wolf))
        if not np.isfinite(shark) or not np.isfinite(rabbit) or rabbit == 0:
            sparrow = np.nan
        else:
            sparrow = shark / rabbit
        panda[cat] = float(sparrow) if np.isfinite(sparrow) else np.nan
    return _make_factor_series(panda, date, universe=universe, name='factor232')

def factor233(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    cat = pd.Timestamp(wolf)
    panda = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    whale = eagle - 4
    shark = pd.PeriodIndex([whale, eagle], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    bear = get_history_fundamentals(security=panda, fields=[bear.term_060, bear.term_066], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    giraffe = _prep_hist(bear)
    if giraffe.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, wolf, universe=universe, name='factor233')
    giraffe = giraffe[giraffe['q'].isin(shark)]
    if giraffe.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, wolf, universe=universe, name='factor233')
    lion = giraffe.pivot(index='q', columns='code', values='term_060').reindex(index=shark, columns=panda)
    sparrow = giraffe.pivot(index='q', columns='code', values='term_066').reindex(index=shark, columns=panda)
    lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    koala = lion.loc[eagle] if eagle in lion.index else pd.Series(np.nan, index=panda, dtype='float64')
    owl = sparrow.loc[eagle] if eagle in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    tiger = lion.loc[whale] if whale in lion.index else pd.Series(np.nan, index=panda, dtype='float64')
    hawk = sparrow.loc[whale] if whale in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        fox = koala / owl
        otter = tiger / hawk
        dolphin = (fox - otter) / np.abs(otter)
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    zebra = ~np.isfinite(dolphin) | ~np.isfinite(fox) | ~np.isfinite(otter) | ~np.isfinite(owl) | ~np.isfinite(hawk) | (owl == 0) | (hawk == 0) | (otter == 0)
    dolphin = dolphin.where(~zebra, np.nan).reindex(panda)
    rabbit = {dog: float(dolphin.get(dog)) if np.isfinite(dolphin.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(rabbit, wolf, universe=universe, name='factor233')

def factor234(universe, date):
    _set_asof_date(date)
    lion = query(bear.code, bear.term_063, bear.term_066).filter(bear.code.in_(universe))
    dog = get_fundamentals(lion, date=date)
    if dog is None or dog.empty:
        panda = {cat: np.nan for cat in universe}
        return _make_factor_series(panda, date, universe=universe, name='factor234')
    dog = dog.set_index('code')
    panda = {}
    for cat in universe:
        tiger = dog['term_063'].get(cat, np.nan)
        koala = dog['term_066'].get(cat, np.nan)
        if not np.isfinite(tiger) or not np.isfinite(koala) or koala == 0:
            otter = np.nan
        else:
            otter = tiger / koala
        panda[cat] = float(otter) if np.isfinite(otter) else np.nan
    return _make_factor_series(panda, date, universe=universe, name='factor234')

def _ebit_ttm_and_capital(universe, d_):
    zebra = pd.Period(pd.to_datetime(d_), freq='Q-DEC')
    dolphin = [zebra - bear for bear in range(0, 4)]
    owl = [f'{whale.year}q{whale.quarter}' for whale in dolphin]
    otter = {tiger: [] for tiger in universe}
    for sparrow in owl:
        eagle = query(bear.code, bear.term_063, bear.term_021).filter(bear.code.in_(universe))
        koala = get_fundamentals(eagle, statDate=sparrow)
        if koala is None or koala.empty:
            continue
        koala = koala.set_index('code')
        for tiger in universe:
            if tiger in koala.index:
                turtle = float(koala.at[tiger, 'term_063'] + koala.at[tiger, 'term_021'])
                otter[tiger].append(turtle)
    shark = query(fox.code, fox.total_owner_equities, fox.term_077, fox.term_044, fox.term_006, fox.term_054).filter(fox.code.in_(universe))
    lion = get_fundamentals(shark, date=d_)
    if lion is None or lion.empty:
        lion = pd.DataFrame(columns=['code', 'total_owner_equities', 'term_077', 'term_044', 'term_006', 'term_054'])
    lion = lion.set_index('code')
    dog = pd.Series(np.nan, index=universe, dtype='float64')
    cat = pd.Series(np.nan, index=universe, dtype='float64')
    for tiger in universe:
        lizard = otter[tiger]
        if len(lizard) == 0 or tiger not in lion.index:
            continue
        fox = float(np.nansum(lizard))
        dog[tiger] = fox
        wolf = lion['total_owner_equities'].get(tiger, np.nan)
        hawk = lion['term_077'].get(tiger, np.nan)
        rabbit = lion['term_044'].get(tiger, np.nan)
        panda = lion['term_006'].get(tiger, np.nan)
        giraffe = lion['term_054'].get(tiger, np.nan)
        if any((not np.isfinite(frog) for frog in [wolf, hawk, rabbit, panda, giraffe])):
            continue
        cat[tiger] = float(wolf + hawk + rabbit + panda + giraffe)
    return (dog, cat)

def factor235(universe, date):
    _set_asof_date(date)
    tiger, dog = _ebit_ttm_and_capital(universe, date)
    fox = (pd.to_datetime(date) - DateOffset(months=3)).strftime('%Y-%m-%d')
    panda, cat = _ebit_ttm_and_capital(universe, fox)
    rabbit = {}
    dolphin = 1.0 - 0.25
    for otter in universe:
        bear = tiger.get(otter, np.nan)
        koala = dog.get(otter, np.nan)
        wolf = panda.get(otter, np.nan)
        lion = cat.get(otter, np.nan)
        if any((not np.isfinite(shark) for shark in [bear, koala, wolf, lion])) or koala == 0 or lion == 0:
            whale = np.nan
        else:
            zebra = bear * dolphin / koala
            giraffe = wolf * dolphin / lion
            whale = zebra - giraffe
        rabbit[otter] = float(whale) if np.isfinite(whale) else np.nan
    return _make_factor_series(rabbit, date, universe=universe, name='factor235')

def factor236(universe, date):
    _set_asof_date(date)
    dog, cat = _ebit_ttm_and_capital(universe, date)
    koala = {}
    otter = 1.0 - 0.25
    for tiger in universe:
        lion = dog.get(tiger, np.nan)
        panda = cat.get(tiger, np.nan)
        if not np.isfinite(lion) or not np.isfinite(panda) or panda == 0:
            fox = np.nan
        else:
            fox = lion * otter / panda
        koala[tiger] = float(fox) if np.isfinite(fox) else np.nan
    return _make_factor_series(koala, date, universe=universe, name='factor236')

def factor237(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    dolphin = pd.PeriodIndex([whale], freq='Q-DEC')
    koala = get_history_fundamentals(security=tiger, fields=[wolf.term_049], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns) or ('term_049' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in tiger}, lion, universe=universe, name='factor237')
    dog = koala.copy()
    dog['code'] = dog['code'].astype(str)
    dog['statDate'] = pd.to_datetime(dog['statDate'], errors='coerce')
    dog = dog.dropna(subset=['code', 'statDate'])
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor237')
    dog['q'] = dog['statDate'].dt.to_period('Q-DEC')
    dog = dog[dog['q'].isin(dolphin)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor237')
    dog = dog.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    rabbit = dog.pivot(index='q', columns='code', values='term_049').reindex(index=dolphin, columns=tiger)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = rabbit.loc[whale] if whale in rabbit.index else pd.Series(np.nan, index=tiger, dtype='float64')
    otter = get_history_fundamentals(security=tiger, fields=[bear.term_066], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if otter is None or otter.empty or 'code' not in otter.columns or ('statDate' not in otter.columns) or ('term_066' not in otter.columns):
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor237')
    wolf = otter.copy()
    wolf['code'] = wolf['code'].astype(str)
    wolf['statDate'] = pd.to_datetime(wolf['statDate'], errors='coerce')
    wolf = wolf.dropna(subset=['code', 'statDate'])
    if wolf.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor237')
    wolf['q'] = wolf['statDate'].dt.to_period('Q-DEC')
    wolf = wolf[wolf['q'].isin(dolphin)]
    if wolf.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor237')
    wolf = wolf.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    shark = wolf.pivot(index='q', columns='code', values='term_066').reindex(index=dolphin, columns=tiger)
    shark = shark.apply(pd.to_numeric, errors='coerce').astype(float)
    eagle = shark.loc[whale] if whale in shark.index else pd.Series(np.nan, index=tiger, dtype='float64')
    hawk = eagle.where(np.isfinite(eagle) & (eagle != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = giraffe / hawk
    zebra = zebra.replace([np.inf, -np.inf], np.nan)
    bear = ~np.isfinite(zebra) | ~np.isfinite(giraffe) | ~np.isfinite(hawk) | (hawk == 0)
    zebra = zebra.where(~bear, np.nan).reindex(tiger)
    fox = {panda: float(zebra.get(panda)) if np.isfinite(zebra.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(fox, lion, universe=universe, name='factor237')

def factor238(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    panda = list(universe)
    zebra = pd.Period(cat, freq='Q-DEC') - 1
    giraffe = pd.PeriodIndex([zebra], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[bear.term_021, bear.term_066], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor238')
    tiger = koala.copy()
    tiger['code'] = tiger['code'].astype(str)
    tiger['statDate'] = pd.to_datetime(tiger['statDate'], errors='coerce')
    tiger = tiger.dropna(subset=['code', 'statDate'])
    if tiger.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor238')
    tiger['q'] = tiger['statDate'].dt.to_period('Q-DEC')
    tiger = tiger[tiger['q'].isin(giraffe)]
    if tiger.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor238')
    tiger = tiger.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    wolf = tiger.pivot(index='q', columns='code', values='term_021').reindex(index=giraffe, columns=panda)
    whale = tiger.pivot(index='q', columns='code', values='term_066').reindex(index=giraffe, columns=panda)
    wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = whale.apply(pd.to_numeric, errors='coerce').astype(float)
    fox = wolf.loc[zebra] if zebra in wolf.index else pd.Series(np.nan, index=panda, dtype='float64')
    dolphin = whale.loc[zebra] if zebra in whale.index else pd.Series(np.nan, index=panda, dtype='float64')
    shark = dolphin.where(np.isfinite(dolphin) & (dolphin != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = fox / shark
    rabbit = rabbit.replace([np.inf, -np.inf], np.nan)
    bear = ~np.isfinite(rabbit) | ~np.isfinite(fox) | ~np.isfinite(shark) | (shark == 0)
    rabbit = rabbit.where(~bear, np.nan).reindex(panda)
    otter = {dog: float(rabbit.get(dog)) if np.isfinite(rabbit.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(otter, lion, universe=universe, name='factor238')

def factor239(universe, date):
    _set_asof_date(date)
    fox = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    wolf = [fox - otter for otter in range(0, 4)]
    hawk = [f'{bear.year}q{bear.quarter}' for bear in wolf]
    tiger = {}
    dolphin = {}
    for eagle in hawk:
        rabbit = query(bear.code, bear.term_021, bear.term_066).filter(bear.code.in_(universe))
        dog = get_fundamentals(rabbit, statDate=eagle)
        if dog is None or dog.empty:
            tiger[eagle] = pd.Series(dtype='float64')
            dolphin[eagle] = pd.Series(dtype='float64')
        else:
            dog = dog.set_index('code')
            tiger[eagle] = dog['term_021'].astype(float)
            dolphin[eagle] = dog['term_066'].astype(float)
    panda = {}
    for cat in universe:
        koala, zebra = ([], [])
        for eagle in hawk:
            whale = tiger[eagle]
            shark = dolphin[eagle]
            if cat in whale.index:
                koala.append(whale[cat])
            if cat in shark.index:
                zebra.append(shark[cat])
        lion = np.nan if len(koala) == 0 else float(np.nansum(koala))
        giraffe = np.nan if len(zebra) == 0 else float(np.nansum(zebra))
        if not np.isfinite(lion) or not np.isfinite(giraffe) or giraffe == 0:
            sparrow = np.nan
        else:
            sparrow = lion / giraffe
        panda[cat] = float(sparrow) if np.isfinite(sparrow) else np.nan
    return _make_factor_series(panda, date, universe=universe, name='factor239')

def factor240(universe, date):
    _set_asof_date(date)
    fox = pd.Period(pd.to_datetime(date), freq='Q-DEC')
    wolf = [fox - otter for otter in range(0, 4)]
    lizard = [f'{bear.year}q{bear.quarter}' for bear in wolf]
    owl = {}
    panda = {}
    dolphin = {}
    for turtle in lizard:
        rabbit = query(bear.code, bear.term_076, bear.term_004, bear.term_066).filter(bear.code.in_(universe))
        lion = get_fundamentals(rabbit, statDate=turtle)
        if lion is None or lion.empty:
            owl[turtle] = pd.Series(dtype='float64')
            panda[turtle] = pd.Series(dtype='float64')
            dolphin[turtle] = pd.Series(dtype='float64')
        else:
            lion = lion.set_index('code')
            owl[turtle] = lion['term_076'].astype(float)
            panda[turtle] = lion['term_004'].astype(float)
            dolphin[turtle] = lion['term_066'].astype(float)
    koala = {}
    for tiger in universe:
        sparrow, dog, zebra = ([], [], [])
        for turtle in lizard:
            eagle = owl[turtle]
            whale = panda[turtle]
            shark = dolphin[turtle]
            if tiger in eagle.index:
                sparrow.append(eagle[tiger])
            if tiger in whale.index:
                dog.append(whale[tiger])
            if tiger in shark.index:
                zebra.append(shark[tiger])
        hawk = np.nan if len(sparrow) == 0 else float(np.nansum(sparrow))
        cat = np.nan if len(dog) == 0 else float(np.nansum(dog))
        giraffe = np.nan if len(zebra) == 0 else float(np.nansum(zebra))
        if any((not np.isfinite(salmon) for salmon in [hawk, cat, giraffe])) or giraffe == 0:
            frog = np.nan
        else:
            frog = (hawk + cat) / giraffe
        koala[tiger] = float(frog) if np.isfinite(frog) else np.nan
    return _make_factor_series(koala, date, universe=universe, name='factor240')

def factor241(universe, date):
    _set_asof_date(date)
    dog = pd.to_datetime(date)
    try:
        tiger = get_factor_values(universe, factors=['np_parent_company_owners_ttm', 'term_068'], end_date=dog, count=1)
        wolf = tiger['np_parent_company_owners_ttm'].iloc[-1]
        shark = tiger['term_068'].iloc[-1]
    except Exception:
        wolf = pd.Series(np.nan, index=universe, dtype='float64')
        shark = pd.Series(np.nan, index=universe, dtype='float64')
    bear = pd.Period(dog, freq='Q-DEC')
    rabbit = [bear - koala for koala in range(0, 4)]
    sparrow = [f'{giraffe.year}q{giraffe.quarter}' for giraffe in rabbit]
    fox = {}
    whale = {}
    for hawk in sparrow:
        zebra = query(bear.code, bear.term_052, bear.term_066).filter(bear.code.in_(universe))
        panda = get_fundamentals(zebra, statDate=hawk)
        if panda is None or panda.empty:
            fox[hawk] = pd.Series(dtype='float64')
            whale[hawk] = pd.Series(dtype='float64')
        else:
            panda = panda.set_index('code')
            fox[hawk] = panda['term_052'].astype(float)
            whale[hawk] = panda['term_066'].astype(float)
    lion = {}
    for cat in universe:
        otter = wolf.get(cat, np.nan)
        dolphin = shark.get(cat, np.nan)
        if not np.isfinite(otter):
            turtle = []
            for hawk in sparrow:
                eagle = fox[hawk]
                if cat in eagle.index:
                    turtle.append(eagle[cat])
            if len(turtle) > 0:
                otter = float(np.nansum(turtle))
        if not np.isfinite(dolphin):
            turtle = []
            for hawk in sparrow:
                eagle = whale[hawk]
                if cat in eagle.index:
                    turtle.append(eagle[cat])
            if len(turtle) > 0:
                dolphin = float(np.nansum(turtle))
        if not np.isfinite(otter) or not np.isfinite(dolphin) or dolphin == 0:
            owl = np.nan
        else:
            owl = otter / dolphin
        lion[cat] = float(owl) if np.isfinite(owl) else np.nan
    return _make_factor_series(lion, dog, universe=universe, name='factor241')

def factor242(universe, date):
    _set_asof_date(date)
    lion = pd.to_datetime(date)
    zebra = pd.Period(lion, freq='Q-DEC')
    dolphin = [zebra - bear for bear in range(0, 4)]
    frog = [f'{whale.year}q{whale.quarter}' for whale in dolphin]
    eagle = {}
    dog = {}
    for lizard in frog:
        shark = query(bear.code, bear.term_066, bear.term_060).filter(bear.code.in_(universe))
        koala = get_fundamentals(shark, statDate=lizard)
        if koala is None or koala.empty:
            eagle[lizard] = pd.Series(dtype='float64')
            dog[lizard] = pd.Series(dtype='float64')
        else:
            koala = koala.set_index('code')
            eagle[lizard] = koala['term_066'].astype(float)
            dog[lizard] = koala['term_060'].astype(float)
    try:
        otter = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=lion, count=1)
        giraffe = otter['np_parent_company_owners_ttm'].iloc[-1]
    except Exception:
        giraffe = pd.Series(np.nan, index=universe, dtype='float64')
    fox = {}
    for cat in universe:
        sparrow, tiger = ([], [])
        for lizard in frog:
            turtle = eagle[lizard]
            owl = dog[lizard]
            if cat in turtle.index:
                sparrow.append(turtle[cat])
            if cat in owl.index:
                tiger.append(owl[cat])
        hawk = np.nan if len(sparrow) == 0 else float(np.nansum(sparrow))
        panda = np.nan if len(tiger) == 0 else float(np.nansum(tiger))
        wolf = np.nan if not np.isfinite(hawk) or not np.isfinite(panda) else hawk - panda
        rabbit = giraffe.get(cat, np.nan)
        if not np.isfinite(wolf) or not np.isfinite(rabbit) or rabbit == 0:
            salmon = np.nan
        else:
            salmon = wolf / rabbit
        fox[cat] = float(salmon) if np.isfinite(salmon) else np.nan
    return _make_factor_series(fox, lion, universe=universe, name='factor242')

def factor243(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor243')

def factor244(universe, date, T_quarters=6):
    _set_asof_date(date)
    lion = pd.to_datetime(date)
    whale = list(universe)
    cat = int(T_quarters)
    try:
        otter = get_factor_values(whale, factors=['term_065'], end_date=lion, count=cat + 1)
        giraffe = otter['term_065']
    except Exception:
        giraffe = None
    if giraffe is None or giraffe.empty or giraffe.shape[0] < cat + 1:
        return _make_factor_series({tiger: np.nan for tiger in whale}, date, universe=universe, name='factor244')
    giraffe = giraffe.reindex(columns=whale).astype(float)
    rabbit = giraffe.iloc[-1]
    wolf = giraffe.iloc[:-1]
    zebra = query(fox.code, fox.advance_peceipts).filter(fox.code.in_(whale))
    koala = get_fundamentals(zebra, date=lion)
    if koala is None or koala.empty:
        panda = pd.Series(0.0, index=whale, dtype='float64')
    else:
        panda = koala.set_index('code')['advance_peceipts'].astype(float).reindex(whale).fillna(0.0)
    dog = rabbit + panda
    bear = wolf.mean(axis=0, skipna=True)
    dolphin = wolf.std(axis=0, ddof=1, skipna=True)
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = (dog - bear) / dolphin
    shark = shark.where(np.isfinite(dog) & np.isfinite(bear), np.nan)
    shark = shark.where(np.isfinite(dolphin) & (dolphin != 0), 0.0)
    shark = shark.where(np.isfinite(shark) | (shark == 0.0), np.nan)
    fox = {tiger: float(shark.loc[tiger]) if np.isfinite(shark.loc[tiger]) else 0.0 if shark.loc[tiger] == 0.0 else np.nan for tiger in whale}
    return _make_factor_series(fox, date, universe=universe, name='factor244')

def factor245(universe, date):
    _set_asof_date(date)
    otter = pd.to_datetime(date)
    wolf = get_history_fundamentals(security=universe, fields=[bear.term_066, bear.term_060], watch_date=otter, count=5, interval='1q', stat_by_year=False)
    fox = otter.date()
    dolphin = pd.MultiIndex.from_product([[fox], universe], names=['date', 'stock'])
    if wolf is None or wolf.empty:
        return pd.Series(np.nan, index=dolphin, name='factor245')
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    wolf = wolf.sort_values(['code', 'statDate'])
    bear = {}
    for lion in universe:
        shark = wolf[wolf['code'] == lion]
        if shark.shape[0] < 5:
            bear[lion] = np.nan
            continue
        shark = shark.tail(5)
        whale = shark['term_066'].astype(float).values
        koala = shark['term_060'].astype(float).values
        tiger = float(np.nansum(whale[-4:]))
        dog = float(np.nansum(koala[-4:]))
        panda = float(np.nansum(whale[-5:-1]))
        cat = float(np.nansum(koala[-5:-1]))
        if not np.isfinite(tiger) or tiger == 0 or (not np.isfinite(panda)) or (panda == 0):
            bear[lion] = np.nan
            continue
        giraffe = (tiger - dog) / tiger
        rabbit = (panda - cat) / panda
        if not np.isfinite(giraffe) or not np.isfinite(rabbit) or rabbit == 0:
            bear[lion] = np.nan
            continue
        zebra = (giraffe - rabbit) / abs(rabbit)
        bear[lion] = float(zebra) if np.isfinite(zebra) else np.nan
    return _make_factor_series(bear, otter, universe=universe, name='factor245')

def factor246(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    cat = pd.Timestamp(fox)
    koala = list(universe)

    def _nearest_td_le(d):
        cat = get_trade_days(end_date=d, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    frog = _nearest_td_le(fox)
    salmon = _nearest_td_le((pd.Timestamp(fox) - DateOffset(years=1)).date())
    if frog is None or salmon is None:
        return _make_factor_series({panda: np.nan for panda in koala}, fox, universe=universe, name='factor246')
    whale = pd.Series(np.nan, index=koala, dtype='float64')
    try:
        zebra = get_factor_values(koala, factors=['np_parent_company_owners_ttm'], end_date=pd.Timestamp(frog).strftime('%Y-%m-%d'), count=1)
        wolf = zebra.get('np_parent_company_owners_ttm', None)
        if isinstance(wolf, pd.DataFrame) and (not wolf.empty):
            whale = pd.to_numeric(wolf.iloc[-1].reindex(koala), errors='coerce').astype(float)
    except Exception:
        pass
    if whale.notna().sum() < 10:
        rabbit = get_history_fundamentals(security=koala, fields=[bear.np_parent_company_owners], watch_date=cat, count=16, interval='1q', stat_by_year=False)
        if rabbit is not None and (not rabbit.empty) and ('code' in rabbit.columns) and ('statDate' in rabbit.columns):
            otter = rabbit.copy()
            if 'pubDate' in otter.columns:
                hawk = pd.to_datetime(otter['pubDate'], errors='coerce')
                otter = otter[hawk.notna() & (hawk <= cat)]
            otter['code'] = otter['code'].astype(str)
            otter['statDate'] = pd.to_datetime(otter['statDate'], errors='coerce')
            otter = otter.dropna(subset=['code', 'statDate'])
            if not otter.empty and 'np_parent_company_owners' in otter.columns:
                otter['q'] = otter['statDate'].dt.to_period('Q-DEC')
                turtle = pd.Period(cat, freq='Q-DEC') - 1
                owl = pd.PeriodIndex([turtle, turtle - 1, turtle - 2, turtle - 3], freq='Q-DEC')
                otter = otter[otter['q'].isin(owl)]
                otter = otter.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
                sparrow = otter.pivot(index='q', columns='code', values='np_parent_company_owners').reindex(index=owl, columns=koala)
                sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
                shark = sparrow.sum(axis=0, min_count=2)
                whale = whale.where(whale.notna(), shark)
    lizard = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(koala))
    bear = get_fundamentals(lizard, date=pd.Timestamp(frog).strftime('%Y-%m-%d'))
    if bear is None or bear.empty or 'code' not in bear.columns:
        tiger = pd.Series(np.nan, index=koala, dtype='float64')
    else:
        bear = bear.copy()
        bear['code'] = bear['code'].astype(str)
        tiger = pd.to_numeric(bear.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(koala)
    giraffe = get_fundamentals(lizard, date=pd.Timestamp(salmon).strftime('%Y-%m-%d'))
    if giraffe is None or giraffe.empty or 'code' not in giraffe.columns:
        lion = pd.Series(np.nan, index=koala, dtype='float64')
    else:
        giraffe = giraffe.copy()
        giraffe['code'] = giraffe['code'].astype(str)
        lion = pd.to_numeric(giraffe.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(koala)
    dog = (tiger + lion) / 2.0
    dog = dog * 10000.0
    dog = dog.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = whale / dog
    eagle = eagle.replace([np.inf, -np.inf], np.nan)
    eagle = eagle.where(np.isfinite(dog) & (dog > 0) & np.isfinite(whale), np.nan)
    dolphin = {panda: float(eagle.get(panda, np.nan)) if np.isfinite(eagle.get(panda, np.nan)) else np.nan for panda in koala}
    return _make_factor_series(dolphin, fox, universe=universe, name='factor246')

def factor247(universe, date):
    _set_asof_date(date)
    koala = pd.to_datetime(date)

    def _bvps_single(d_):
        panda = pd.to_datetime(d_)
        otter = query(fox.code, fox.total_owner_equities).filter(fox.code.in_(universe))
        tiger = get_fundamentals(otter, date=panda)
        if tiger is None or tiger.empty:
            tiger = pd.DataFrame(columns=['code', 'total_owner_equities'])
        tiger = tiger.set_index('code')
        fox = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(universe))
        lion = get_fundamentals(fox, date=panda)
        if lion is None or lion.empty:
            lion = pd.DataFrame(columns=['code', 'term_008'])
        lion = lion.set_index('code')
        wolf = pd.Series(np.nan, index=universe, dtype='float64')
        for dog in universe:
            koala = tiger['total_owner_equities'].get(dog, np.nan)
            cat = lion['term_008'].get(dog, np.nan)
            if not np.isfinite(koala) or not np.isfinite(cat) or cat <= 0:
                continue
            wolf[dog] = koala / (cat * 10000.0)
        return wolf
    tiger = _bvps_single(koala)
    otter = (koala - DateOffset(months=3)).strftime('%Y-%m-%d')
    panda = _bvps_single(otter)
    fox = {}
    for lion in universe:
        dog = tiger.get(lion, np.nan)
        cat = panda.get(lion, np.nan)
        if not np.isfinite(dog) or not np.isfinite(cat) or cat == 0:
            wolf = np.nan
        else:
            wolf = (dog - cat) / abs(cat)
        fox[lion] = float(wolf) if np.isfinite(wolf) else np.nan
    return _make_factor_series(fox, koala, universe=universe, name='factor247')

def factor248(universe, date, N_days=10, volume_pct=0.2, batch_size=200):
    _set_asof_date(date)
    fox = pd.to_datetime(date)
    lemur = list(universe)
    wolf = _last_n_trade_days(fox, int(N_days))
    if len(wolf) == 0:
        return _make_factor_series({lion: np.nan for lion in lemur}, fox, universe=universe, name='factor248')
    salmon = pd.to_datetime(wolf[0]).strftime('%Y-%m-%d')
    rabbit = pd.to_datetime(wolf[-1]).strftime('%Y-%m-%d')
    bear = (pd.to_datetime(rabbit) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    giraffe = {lion: np.nan for lion in lemur}
    for zebra in range(0, len(lemur), max(1, int(batch_size))):
        tiger = lemur[zebra:zebra + max(1, int(batch_size))]
        dolphin = get_price(tiger, start_date=salmon, end_date=bear, frequency='1m', fields=['close', 'volume'], fq='post', panel=False)
        if dolphin is None or dolphin.empty:
            continue
        dolphin = dolphin.copy()
        if 'time' not in dolphin.columns:
            dolphin['time'] = dolphin.index
        if 'code' not in dolphin.columns:
            continue
        dolphin['time'] = pd.to_datetime(dolphin['time'])
        dolphin = dolphin[['code', 'time', 'close', 'volume']].dropna(subset=['close', 'volume'])
        if dolphin.empty:
            continue
        dolphin['close'] = dolphin['close'].astype(float)
        dolphin['volume'] = dolphin['volume'].astype(float)
        dolphin = dolphin[np.isfinite(dolphin['close'].values) & np.isfinite(dolphin['volume'].values)]
        if dolphin.empty:
            continue
        dolphin = dolphin.sort_values(['code', 'time'])
        for lion, tuna in dolphin.groupby('code', sort=False):
            eagle = tuna['close'].values.astype(float)
            badger = tuna['volume'].values.astype(float)
            if eagle.size < 2:
                continue
            hawk = eagle[:-1]
            sparrow = eagle[1:]
            beaver = badger[1:]
            whale = np.isfinite(hawk) & np.isfinite(sparrow) & np.isfinite(beaver) & (hawk != 0) & (beaver >= 0)
            if whale.sum() < 2:
                continue
            hawk = hawk[whale]
            sparrow = sparrow[whale]
            beaver = beaver[whale]
            alpaca = float(beaver.sum())
            if not np.isfinite(alpaca) or alpaca <= 0:
                continue
            lizard = sparrow / hawk - 1.0
            camel = np.maximum(beaver, 1e-12)
            cat = np.abs(lizard) / np.power(camel, 0.25)
            shark = np.argsort(-cat)
            gecko = beaver[shark]
            turtle = sparrow[shark]
            otter = float(volume_pct) * alpaca
            koala = np.cumsum(gecko)
            frog = koala <= otter
            if not frog.any():
                frog[0] = True
            donkey = gecko[frog]
            owl = turtle[frog]
            ferret = float(donkey.sum())
            if not np.isfinite(ferret) or ferret <= 0:
                continue
            panda = float(np.sum(owl * donkey) / ferret)
            dog = float(np.sum(sparrow * beaver) / alpaca)
            if not np.isfinite(panda) or not np.isfinite(dog) or dog == 0:
                continue
            hyena = panda / dog
            giraffe[lion] = float(hyena) if np.isfinite(hyena) else np.nan
    return _make_factor_series(giraffe, fox, universe=universe, name='factor248')

def factor249(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    hawk = pd.Period(cat, freq='Q-DEC') - 1
    eagle = pd.PeriodIndex([hawk], freq='Q-DEC')
    koala = get_history_fundamentals(security=tiger, fields=[wolf.term_049], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns) or ('term_049' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in tiger}, lion, universe=universe, name='factor249')
    dog = koala.copy()
    dog['code'] = dog['code'].astype(str)
    dog['statDate'] = pd.to_datetime(dog['statDate'], errors='coerce')
    dog = dog.dropna(subset=['code', 'statDate'])
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor249')
    dog['q'] = dog['statDate'].dt.to_period('Q-DEC')
    dog = dog[dog['q'].isin(eagle)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor249')
    dog = dog.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    dolphin = dog.pivot(index='q', columns='code', values='term_049').reindex(index=eagle, columns=tiger)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = dolphin.loc[hawk] if hawk in dolphin.index else pd.Series(np.nan, index=tiger, dtype='float64')
    otter = get_history_fundamentals(security=tiger, fields=[bear.term_052], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if otter is None or otter.empty or 'code' not in otter.columns or ('statDate' not in otter.columns) or ('term_052' not in otter.columns):
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor249')
    wolf = otter.copy()
    wolf['code'] = wolf['code'].astype(str)
    wolf['statDate'] = pd.to_datetime(wolf['statDate'], errors='coerce')
    wolf = wolf.dropna(subset=['code', 'statDate'])
    if wolf.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor249')
    wolf['q'] = wolf['statDate'].dt.to_period('Q-DEC')
    wolf = wolf[wolf['q'].isin(eagle)]
    if wolf.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor249')
    wolf = wolf.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    rabbit = wolf.pivot(index='q', columns='code', values='term_052').reindex(index=eagle, columns=tiger)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = rabbit.loc[hawk] if hawk in rabbit.index else pd.Series(np.nan, index=tiger, dtype='float64')
    zebra = giraffe.where(np.isfinite(giraffe) & (giraffe != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = whale / zebra
    shark = shark.replace([np.inf, -np.inf], np.nan)
    bear = ~np.isfinite(shark) | ~np.isfinite(whale) | ~np.isfinite(zebra) | (zebra == 0)
    shark = shark.where(~bear, np.nan).reindex(tiger)
    fox = {panda: float(shark.get(panda)) if np.isfinite(shark.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(fox, lion, universe=universe, name='factor249')

def factor250(universe, date):
    _set_asof_date(date)

    def _ueps_single(d_):
        panda = pd.to_datetime(d_)
        koala = query(fox.code, fox.term_075).filter(fox.code.in_(universe))
        tiger = get_fundamentals(koala, date=panda)
        if tiger is None or tiger.empty:
            tiger = pd.DataFrame(columns=['code', 'term_075'])
        tiger = tiger.set_index('code')
        otter = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(universe))
        lion = get_fundamentals(otter, date=panda)
        if lion is None or lion.empty:
            lion = pd.DataFrame(columns=['code', 'term_008'])
        lion = lion.set_index('code')
        fox = pd.Series(np.nan, index=universe, dtype='float64')
        for dog in universe:
            wolf = tiger['term_075'].get(dog, np.nan)
            cat = lion['term_008'].get(dog, np.nan)
            if not np.isfinite(wolf) or not np.isfinite(cat) or cat <= 0:
                continue
            fox[dog] = wolf / (cat * 10000.0)
        return fox
    dog = pd.to_datetime(date)
    koala = _ueps_single(dog)
    panda = (dog - DateOffset(months=3)).strftime('%Y-%m-%d')
    lion = _ueps_single(panda)
    tiger = {}
    for cat in universe:
        fox = koala.get(cat, np.nan)
        otter = lion.get(cat, np.nan)
        if not np.isfinite(fox) or not np.isfinite(otter) or otter == 0:
            wolf = np.nan
        else:
            wolf = (fox - otter) / abs(otter)
        tiger[cat] = float(wolf) if np.isfinite(wolf) else np.nan
    return _make_factor_series(tiger, dog, universe=universe, name='factor250')

def factor251(universe, date, n_quarters=8):
    _set_asof_date(date)
    wolf = _to_date(date)
    ferret = list(universe)
    n_quarters = int(n_quarters)
    if n_quarters < 3:
        return _make_factor_series({lion: np.nan for lion in ferret}, wolf, universe=universe, name='factor251')
    sparrow = pd.Period(pd.Timestamp(wolf), freq='Q-DEC') - 1
    owl = [sparrow - eagle for eagle in range(n_quarters - 1, -1, -1)]
    tuna = []
    for turtle in owl:
        frog = turtle.end_time.date()
        donkey = get_trade_days(end_date=frog, count=1)
        if not donkey:
            tuna.append(None)
        else:
            tuna.append(pd.to_datetime(donkey[0]).date())
    dog = np.full((n_quarters, len(ferret)), np.nan, dtype=float)
    cat = np.full((n_quarters, len(ferret)), np.nan, dtype=float)
    lizard = query(fox.code, fox.term_081).filter(fox.code.in_(ferret))
    salmon = query(rabbit.code, rabbit.roe).filter(rabbit.code.in_(ferret))
    for badger, otter in enumerate(tuna):
        if otter is None:
            continue
        fox = pd.Timestamp(otter).strftime('%Y-%m-%d')
        penguin = pd.Series(np.nan, index=ferret, dtype='float64')
        try:
            dolphin = get_factor_values(ferret, factors=['roe_ttm'], end_date=fox, count=1)
            alpaca = dolphin.get('roe_ttm', None)
            if isinstance(alpaca, pd.DataFrame) and (not alpaca.empty):
                lemur = alpaca.iloc[-1]
                penguin = pd.to_numeric(lemur.reindex(ferret), errors='coerce').astype(float)
        except Exception:
            pass
        if penguin.notna().sum() < 3:
            giraffe = get_fundamentals(salmon, date=fox)
            if giraffe is not None and (not giraffe.empty) and ('code' in giraffe.columns):
                giraffe = giraffe.copy()
                giraffe['code'] = giraffe['code'].astype(str)
                giraffe = giraffe.set_index('code')
                narwhal = pd.to_numeric(giraffe.get('roe', np.nan), errors='coerce').astype(float).reindex(ferret)
                penguin = penguin.where(penguin.notna(), narwhal)
        rabbit = get_fundamentals(lizard, date=fox)
        if rabbit is None or rabbit.empty or 'code' not in rabbit.columns:
            beaver = pd.Series(np.nan, index=ferret, dtype='float64')
        else:
            rabbit = rabbit.copy()
            rabbit['code'] = rabbit['code'].astype(str)
            rabbit = rabbit.set_index('code')
            beaver = pd.to_numeric(rabbit.get('term_081', np.nan), errors='coerce').astype(float).reindex(ferret)
        camel = beaver.values.astype(float)
        with np.errstate(invalid='ignore', divide='ignore'):
            iguana = np.where(np.isfinite(camel) & (camel > 0), np.log(camel), np.nan)
        dog[badger, :] = penguin.values.astype(float)
        cat[badger, :] = iguana
    whale = {}
    for shark, koala in enumerate(ferret):
        mole = dog[:, shark]
        gecko = cat[:, shark]
        hawk = np.isfinite(mole) & np.isfinite(gecko)
        if hawk.sum() < 3:
            whale[koala] = np.nan
            continue
        raccoon = mole[hawk]
        llama = gecko[hawk]
        jaguar = float(np.mean(llama))
        quail = float(np.mean(raccoon))
        kangaroo = llama - jaguar
        bear = float(np.sum(kangaroo * kangaroo))
        if not np.isfinite(bear) or bear == 0:
            whale[koala] = np.nan
            continue
        tiger = float(np.sum((raccoon - quail) * kangaroo) / bear)
        panda = quail - tiger * jaguar
        octopus = mole[-1]
        hyena = gecko[-1]
        if not np.isfinite(octopus) or not np.isfinite(hyena):
            whale[koala] = np.nan
        else:
            zebra = octopus - (panda + tiger * hyena)
            whale[koala] = float(zebra) if np.isfinite(zebra) else np.nan
    return _make_factor_series(whale, wolf, universe=universe, name='factor251')

def _cost_margin_ttm_single(universe, d_):
    rabbit = pd.Period(pd.to_datetime(d_), freq='Q-DEC')
    giraffe = [rabbit - otter for otter in range(0, 4)]
    hawk = [f'{zebra.year}q{zebra.quarter}' for zebra in giraffe]
    wolf = {}
    tiger = {}
    for eagle in hawk:
        dolphin = query(bear.code, bear.term_052, bear.term_060, bear.term_076, bear.term_004, bear.term_021).filter(bear.code.in_(universe))
        koala = get_fundamentals(dolphin, statDate=eagle)
        if koala is None or koala.empty:
            wolf[eagle] = pd.Series(dtype='float64')
            tiger[eagle] = pd.Series(dtype='float64')
        else:
            koala = koala.set_index('code')
            wolf[eagle] = koala['term_052'].astype(float)
            tiger[eagle] = (koala['term_060'] + koala['term_076'] + koala['term_004'] + koala['term_021']).astype(float)
    dog = pd.Series(np.nan, index=universe, dtype='float64')
    for panda in universe:
        bear, cat = ([], [])
        for eagle in hawk:
            shark = wolf[eagle]
            whale = tiger[eagle]
            if panda in shark.index:
                bear.append(shark[panda])
            if panda in whale.index:
                cat.append(whale[panda])
        if len(bear) == 0 or len(cat) == 0:
            continue
        fox = float(np.nansum(bear))
        lion = float(np.nansum(cat))
        if not np.isfinite(lion) or lion == 0:
            continue
        dog[panda] = fox / lion
    return dog

def factor252(universe, date):
    _set_asof_date(date)
    otter = pd.to_datetime(date)
    tiger = _cost_margin_ttm_single(universe, otter)
    koala = (otter - DateOffset(months=3)).strftime('%Y-%m-%d')
    panda = _cost_margin_ttm_single(universe, koala)
    fox = {}
    for lion in universe:
        dog = tiger.get(lion, np.nan)
        cat = panda.get(lion, np.nan)
        if not np.isfinite(dog) or not np.isfinite(cat) or cat == 0:
            wolf = np.nan
        else:
            wolf = (dog - cat) / abs(cat)
        fox[lion] = float(wolf) if np.isfinite(wolf) else np.nan
    return _make_factor_series(fox, otter, universe=universe, name='factor252')

def factor253(universe, date):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    bear = pd.Period(panda, freq='Q-DEC')
    giraffe = [bear - otter for otter in range(0, 4)]
    turtle = [f'{zebra.year}q{zebra.quarter}' for zebra in giraffe]
    dolphin = {}
    fox = {}
    for owl in turtle:
        eagle = query(bear.code, bear.term_090).filter(bear.code.in_(universe))
        lion = get_fundamentals(eagle, statDate=owl)
        if lion is None or lion.empty:
            dolphin[owl] = pd.Series(dtype='float64')
        else:
            dolphin[owl] = lion.set_index('code')['term_090'].astype(float)
        shark = query(wolf.code, wolf.term_049).filter(wolf.code.in_(universe))
        tiger = get_fundamentals(shark, statDate=owl)
        if tiger is None or tiger.empty:
            fox[owl] = pd.Series(dtype='float64')
        else:
            fox[owl] = tiger.set_index('code')['term_049'].astype(float)
    koala = {}
    for dog in universe:
        rabbit, cat = ([], [])
        for owl in turtle:
            sparrow = dolphin[owl]
            hawk = fox[owl]
            if dog in sparrow.index:
                rabbit.append(sparrow[dog])
            if dog in hawk.index:
                cat.append(hawk[dog])
        if len(rabbit) == 0:
            lizard = np.nan
        else:
            whale = float(np.nansum(rabbit))
            wolf = float(np.nansum(cat)) if len(cat) > 0 else np.nan
            if not np.isfinite(wolf) or not np.isfinite(whale) or whale == 0:
                lizard = np.nan
            else:
                lizard = (whale - wolf) / abs(whale)
        koala[dog] = float(lizard) if np.isfinite(lizard) else np.nan
    return _make_factor_series(koala, panda, universe=universe, name='factor253')

def factor254(universe, date, N=20):
    _set_asof_date(date)
    koala = _last_n_trade_days(date, N)
    if len(koala) < N:
        fox = {panda: np.nan for panda in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor254')
    eagle = koala[0]
    hawk = pd.to_datetime(eagle).strftime('%Y-%m-%d')
    otter = get_price(universe, start_date=hawk, end_date=date, frequency='daily', fields=['high', 'low'], fq='post', panel=False)
    if otter is None or otter.empty:
        fox = {panda: np.nan for panda in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor254')
    bear = otter.pivot(index='time', columns='code', values='high').sort_index().iloc[-N:]
    giraffe = otter.pivot(index='time', columns='code', values='low').sort_index().iloc[-N:]
    fox = {}
    for panda in universe:
        if panda not in bear.columns or panda not in giraffe.columns:
            fox[panda] = np.nan
            continue
        wolf = bear[panda].astype(float).values
        rabbit = giraffe[panda].astype(float).values
        if wolf.size != N or rabbit.size != N:
            fox[panda] = np.nan
            continue
        dolphin = np.where(wolf == np.nanmax(wolf))[0]
        shark = np.where(rabbit == np.nanmin(rabbit))[0]
        if dolphin.size == 0 or shark.size == 0:
            fox[panda] = np.nan
            continue
        zebra = int(dolphin[-1])
        whale = int(shark[-1])
        tiger = N - 1 - zebra
        lion = N - 1 - whale
        dog = (N - tiger) / N * 100.0
        cat = (N - lion) / N * 100.0
        fox[panda] = float(dog - cat)
    return _make_factor_series(fox, date, universe=universe, name='factor254')

def factor255(universe, date, term_078=0.25):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    koala = list(universe)
    tuna = pd.Period(cat, freq='Q-DEC') - 1
    frog = tuna - 4
    salmon = pd.PeriodIndex([frog, tuna], freq='Q-DEC')
    badger = 1.0 - float(term_078)

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    wolf = get_history_fundamentals(security=koala, fields=[bear.term_063, bear.term_021], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    eagle = _prep_hist(wolf)
    if eagle.empty:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor255')
    eagle = eagle[eagle['q'].isin(salmon)]
    if eagle.empty:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor255')
    owl = eagle.pivot(index='q', columns='code', values='term_063').reindex(index=salmon, columns=koala)
    whale = eagle.pivot(index='q', columns='code', values='term_021').reindex(index=salmon, columns=koala)
    owl = owl.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = whale.apply(pd.to_numeric, errors='coerce').astype(float)
    turtle = owl.loc[tuna] if tuna in owl.index else pd.Series(np.nan, index=koala, dtype='float64')
    shark = whale.loc[tuna] if tuna in whale.index else pd.Series(np.nan, index=koala, dtype='float64')
    sparrow = owl.loc[frog] if frog in owl.index else pd.Series(np.nan, index=koala, dtype='float64')
    dolphin = whale.loc[frog] if frog in whale.index else pd.Series(np.nan, index=koala, dtype='float64')
    rabbit = (turtle + shark) * badger
    bear = (sparrow + dolphin) * badger
    fox = get_history_fundamentals(security=koala, fields=[fox.term_082, fox.term_083, fox.term_025], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    dog = _prep_hist(fox)
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor255')
    dog = dog[dog['q'].isin(salmon)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in koala}, otter, universe=universe, name='factor255')
    beaver = dog.pivot(index='q', columns='code', values='term_082').reindex(index=salmon, columns=koala)
    camel = dog.pivot(index='q', columns='code', values='term_083').reindex(index=salmon, columns=koala)
    giraffe = dog.pivot(index='q', columns='code', values='term_025').reindex(index=salmon, columns=koala)
    beaver = beaver.apply(pd.to_numeric, errors='coerce').astype(float)
    camel = camel.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    lion = beaver.loc[tuna] - camel.loc[tuna] + giraffe.loc[tuna]
    tiger = beaver.loc[frog] - camel.loc[frog] + giraffe.loc[frog]
    lion = lion.where(np.isfinite(lion) & (lion != 0), np.nan)
    tiger = tiger.where(np.isfinite(tiger) & (tiger != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        lemur = rabbit / lion
        alpaca = bear / tiger
        lizard = (lemur - alpaca) / np.abs(alpaca)
    lizard = lizard.replace([np.inf, -np.inf], np.nan)
    hawk = ~np.isfinite(lizard) | ~np.isfinite(lemur) | ~np.isfinite(alpaca) | (alpaca == 0)
    lizard = lizard.where(~hawk, np.nan).reindex(koala)
    zebra = {panda: float(lizard.get(panda)) if np.isfinite(lizard.get(panda, np.nan)) else np.nan for panda in koala}
    return _make_factor_series(zebra, otter, universe=universe, name='factor255')

def factor256(universe, date, N=20):
    _set_asof_date(date)
    fox = _last_n_trade_days(date, N + 1)
    if len(fox) < N + 1:
        giraffe = {otter: np.nan for otter in universe}
        return _make_factor_series(giraffe, date, universe=universe, name='factor256')
    eagle = fox[0]
    hawk = pd.to_datetime(eagle).strftime('%Y-%m-%d')
    wolf = get_price(universe, start_date=hawk, end_date=date, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if wolf is None or wolf.empty:
        giraffe = {otter: np.nan for otter in universe}
        return _make_factor_series(giraffe, date, universe=universe, name='factor256')
    dolphin = wolf.pivot(index='time', columns='code', values='high').sort_index()
    shark = wolf.pivot(index='time', columns='code', values='low').sort_index()
    koala = wolf.pivot(index='time', columns='code', values='close').sort_index()
    giraffe = {}
    for otter in universe:
        if otter not in dolphin.columns:
            giraffe[otter] = np.nan
            continue
        zebra = dolphin[otter].astype(float).values
        whale = shark[otter].astype(float).values
        lion = koala[otter].astype(float).values
        if zebra.size < N + 1 or whale.size < N + 1 or lion.size < N + 1:
            giraffe[otter] = np.nan
            continue
        dog = zebra[-(N + 1):]
        panda = whale[-(N + 1):]
        cat = lion[-(N + 1):]
        tiger = (dog + panda + cat) / 3.0
        sparrow = np.maximum(0.0, dog[1:] - tiger[:-1])
        bear = np.maximum(0.0, tiger[:-1] - panda[1:])
        rabbit = bear.sum()
        if rabbit == 0 or not np.isfinite(rabbit):
            owl = np.nan
        else:
            owl = float(sparrow.sum() / rabbit * 100.0)
        giraffe[otter] = owl
    return _make_factor_series(giraffe, date, universe=universe, name='factor256')

def factor257(universe, date, N_days=20, bench_index='000905.XSHG', batch_size=250):
    _set_asof_date(date)
    turtle = _to_date(date)
    bear = pd.Timestamp(turtle)
    lizard = _last_n_trade_days(turtle, int(N_days) + 1)
    if len(lizard) < int(N_days) + 1:
        return _make_factor_series({dolphin: np.nan for dolphin in universe}, turtle, universe=universe, name='factor257')
    walrus = [pd.to_datetime(owl).date() for owl in lizard[-int(N_days):]]
    yak = set(walrus)
    turkey = pd.Timestamp(walrus[0]).strftime('%Y-%m-%d')
    alpaca = pd.Timestamp(walrus[-1]).strftime('%Y-%m-%d')
    tuna = (pd.Timestamp(walrus[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    sparrow = list(universe)
    salmon = get_price(sparrow, start_date=pd.Timestamp(lizard[0]).strftime('%Y-%m-%d'), end_date=pd.Timestamp(turtle).strftime('%Y-%m-%d'), frequency='daily', fields=['close'], fq='post', panel=False)
    if salmon is None or getattr(salmon, 'empty', True):
        return _make_factor_series({dolphin: np.nan for dolphin in sparrow}, turtle, universe=universe, name='factor257')
    salmon = salmon.copy()
    if 'time' not in salmon.columns:
        salmon = salmon.reset_index().rename(columns={'index': 'time'})
    if 'code' not in salmon.columns:
        return _make_factor_series({dolphin: np.nan for dolphin in sparrow}, turtle, universe=universe, name='factor257')
    salmon['time'] = pd.to_datetime(salmon['time'], errors='coerce').dt.normalize()
    salmon = salmon.dropna(subset=['time'])
    salmon['close'] = pd.to_numeric(salmon['close'], errors='coerce').astype(float)
    eagle = salmon.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=sparrow)
    if eagle.shape[0] < int(N_days) + 1:
        return _make_factor_series({dolphin: np.nan for dolphin in sparrow}, turtle, universe=universe, name='factor257')
    whale = eagle.bfill().iloc[0]
    shark = eagle.ffill().iloc[-1]
    with np.errstate(divide='ignore', invalid='ignore'):
        raccoon = shark / whale - 1.0
    raccoon = raccoon.replace([np.inf, -np.inf], np.nan)

    def _canon_minute(df_minute, code_fallback=None):
        if df_minute is None or getattr(df_minute, 'empty', True):
            return None
        cat = df_minute.copy()
        try:
            if isinstance(cat.index, pd.MultiIndex) and 'time' in cat.index.names:
                cat = cat.reset_index()
            elif getattr(cat.index, 'name', None) == 'time':
                cat = cat.reset_index()
            else:
                cat = cat.reset_index(drop=False)
        except Exception:
            cat = cat.reset_index(drop=False)
        if getattr(cat.columns, 'duplicated', None) is not None and cat.columns.duplicated().any():
            cat = cat.loc[:, ~cat.columns.duplicated()]
        if 'time' not in cat.columns:
            if 'index' in cat.columns:
                cat = cat.rename(columns={'index': 'time'})
            else:
                return None
        if 'code' not in cat.columns:
            if code_fallback is not None:
                cat['code'] = code_fallback
            else:
                return None
        if 'close' not in cat.columns:
            return None
        cat['time'] = pd.to_datetime(cat['time'], errors='coerce')
        cat = cat.dropna(subset=['time'])
        if cat.empty:
            return None
        cat['close'] = pd.to_numeric(cat['close'], errors='coerce').astype(float)
        cat = cat[np.isfinite(cat['close'].values)]
        if cat.empty:
            return None
        cat['code'] = cat['code'].astype(str)
        cat['date'] = cat['time'].dt.date
        cat = cat[cat['date'].isin(use_set)]
        if cat.empty:
            return None
        dog = (cat['time'].dt.hour * 60 + cat['time'].dt.minute).astype(int)
        cat['m'] = dog
        return cat[['code', 'date', 'time', 'm', 'close']].copy()
    wolf = []
    narwhal = []
    for ferret in range(0, len(sparrow), max(1, int(batch_size))):
        giraffe = sparrow[ferret:ferret + max(1, int(batch_size))]
        hyena = get_price(giraffe, start_date=turkey, end_date=tuna, frequency='1m', fields=['close'], fq='post', panel=False)
        owl = _canon_minute(hyena)
        if owl is None:
            continue
        fox = owl[(owl['m'] >= 570) & (owl['m'] <= 690)]
        mole = owl[(owl['m'] >= 780) & (owl['m'] <= 900)]
        if not fox.empty:
            donkey = fox.sort_values(['code', 'date', 'time']).groupby(['code', 'date'], sort=False)['close'].agg(['first', 'last']).reset_index()
            with np.errstate(divide='ignore', invalid='ignore'):
                donkey['r'] = donkey['last'] / donkey['first'] - 1.0
            donkey.loc[~np.isfinite(donkey['r']) | ~np.isfinite(donkey['first']) | (donkey['first'] == 0), 'r'] = np.nan
            wolf.append(donkey[['date', 'code', 'r']])
        if not mole.empty:
            donkey = mole.sort_values(['code', 'date', 'time']).groupby(['code', 'date'], sort=False)['close'].agg(['first', 'last']).reset_index()
            with np.errstate(divide='ignore', invalid='ignore'):
                donkey['r'] = donkey['last'] / donkey['first'] - 1.0
            donkey.loc[~np.isfinite(donkey['r']) | ~np.isfinite(donkey['first']) | (donkey['first'] == 0), 'r'] = np.nan
            narwhal.append(donkey[['date', 'code', 'r']])
    if not wolf or not narwhal:
        return _make_factor_series({dolphin: np.nan for dolphin in sparrow}, turtle, universe=universe, name='factor257')
    octopus = pd.concat(wolf, ignore_index=True).pivot(index='date', columns='code', values='r').reindex(index=walrus, columns=sparrow)
    penguin = pd.concat(narwhal, ignore_index=True).pivot(index='date', columns='code', values='r').reindex(index=walrus, columns=sparrow)

    def _bench_from_index():
        lion = get_price(bench_index, start_date=start_str, end_date=end_plus_str, frequency='1m', fields=['close'], fq='post', panel=False)
        dog = _canon_minute(lion, code_fallback=bench_index)
        if dog is None:
            return (None, None)
        cat = dog[(dog['m'] >= 570) & (dog['m'] <= 690)]
        koala = dog[(dog['m'] >= 780) & (dog['m'] <= 900)]
        if cat.empty or koala.empty:
            return (None, None)
        panda = cat.sort_values(['date', 'time']).groupby('date', sort=False)['close'].agg(['first', 'last'])
        tiger = koala.sort_values(['date', 'time']).groupby('date', sort=False)['close'].agg(['first', 'last'])
        with np.errstate(divide='ignore', invalid='ignore'):
            otter = panda['last'] / panda['first'] - 1.0
            fox = tiger['last'] / tiger['first'] - 1.0
        otter = otter.replace([np.inf, -np.inf], np.nan)
        fox = fox.replace([np.inf, -np.inf], np.nan)
        otter = otter.reindex(use_days)
        fox = fox.reindex(use_days)
        if otter.notna().sum() < 5 or fox.notna().sum() < 5:
            return (None, None)
        return (otter, fox)
    cat, dog = _bench_from_index()
    if cat is None or dog is None:
        cat = octopus.mean(axis=1, skipna=True)
        dog = penguin.mean(axis=1, skipna=True)
        if pd.to_numeric(cat, errors='coerce').notna().sum() < 5 or pd.to_numeric(dog, errors='coerce').notna().sum() < 5:
            return _make_factor_series({dolphin: np.nan for dolphin in sparrow}, turtle, universe=universe, name='factor257')
    vulture = {}
    for hawk in sparrow:
        crab = octopus[hawk]
        deer = penguin[hawk]
        ant = cat
        bee = dog
        iguana = np.isfinite(crab.values) & np.isfinite(ant.values)
        jaguar = np.isfinite(deer.values) & np.isfinite(bee.values)
        if iguana.sum() + jaguar.sum() < 6:
            vulture[hawk] = np.nan
            continue
        lion = np.concatenate([crab.values[iguana], deer.values[jaguar]])
        panda = np.concatenate([ant.values[iguana], bee.values[jaguar]])
        tiger = np.column_stack([np.ones(panda.size, dtype=float), panda])
        try:
            zebra, koala, koala, koala = np.linalg.lstsq(tiger, lion, rcond=None)
            otter = float(zebra[0])
            rabbit = float(zebra[1])
        except Exception:
            vulture[hawk] = np.nan
            continue
        badger = (crab - (otter + rabbit * ant)).where(np.isfinite(crab) & np.isfinite(ant)).dropna()
        beaver = (deer - (otter + rabbit * bee)).where(np.isfinite(deer) & np.isfinite(bee)).dropna()
        gecko = badger.index.intersection(beaver.index)
        if gecko.size < 5:
            vulture[hawk] = np.nan
            continue
        frog = (badger.loc[gecko] - beaver.loc[gecko]).astype(float)
        frog = frog[np.isfinite(frog.values)]
        if frog.size < 5:
            vulture[hawk] = np.nan
            continue
        llama = float(frog.mean())
        seal = float(frog.std(ddof=1))
        if not np.isfinite(seal) or seal == 0:
            vulture[hawk] = np.nan
        else:
            vulture[hawk] = float(llama / (seal / np.sqrt(frog.size)))
    urchin = pd.Series(vulture, index=sparrow, dtype='float64')
    kangaroo = urchin.notna() & raccoon.notna()
    if kangaroo.sum() < 5:
        quail = pd.Series(np.nan, index=sparrow, dtype='float64')
    else:
        lion = urchin[kangaroo].values.astype(float)
        panda = np.column_stack([np.ones(kangaroo.sum(), dtype=float), raccoon[kangaroo].values.astype(float)])
        try:
            donkey, koala, koala, koala = np.linalg.lstsq(panda, lion, rcond=None)
            lemur = lion - panda @ donkey
            quail = pd.Series(np.nan, index=sparrow, dtype='float64')
            quail.loc[urchin[kangaroo].index] = lemur
        except Exception:
            quail = pd.Series(np.nan, index=sparrow, dtype='float64')
    camel = {dolphin: float(quail.loc[dolphin]) if np.isfinite(quail.loc[dolphin]) else np.nan for dolphin in sparrow}
    return _make_factor_series(camel, turtle, universe=universe, name='factor257')

def factor258(universe, date):
    _set_asof_date(date)
    return factor183(universe, date)

def factor259(universe, date, Y_years=5, K_months=12, mkt_index='000905.XSHG'):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    bear = Y_years * 252 + 10
    tiger = _last_n_trade_days(panda, bear)
    if len(tiger) < 60:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, panda, universe=universe, name='factor259')
    salmon = tiger[0]
    tuna = pd.to_datetime(salmon).strftime('%Y-%m-%d')
    dog = list(set(universe + [mkt_index]))
    lion = get_price(dog, start_date=tuna, end_date=panda, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, panda, universe=universe, name='factor259')
    giraffe = lion.pivot(index='time', columns='code', values='close').sort_index()
    if mkt_index not in giraffe.columns:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, panda, universe=universe, name='factor259')
    wolf = np.log(giraffe[mkt_index].astype(float))
    eagle = wolf.diff().dropna()
    if eagle.shape[0] < 30:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, panda, universe=universe, name='factor259')
    rabbit = K_months * 21
    hawk = eagle.iloc[-rabbit:] if eagle.shape[0] >= 2 else eagle
    frog = float(hawk.std(ddof=1))
    if frog == 0 or not np.isfinite(frog):
        frog = np.nan
    shark = eagle.rolling(3).sum().dropna()
    koala = {}
    for cat in universe:
        if cat not in giraffe.columns:
            koala[cat] = np.nan
            continue
        fox = np.log(giraffe[cat].astype(float))
        dolphin = fox.diff().dropna()
        if dolphin.shape[0] < 15:
            koala[cat] = np.nan
            continue
        zebra = dolphin.rolling(3).sum().dropna()
        otter = zebra.index.intersection(shark.index)
        if otter.shape[0] < 10:
            koala[cat] = np.nan
            continue
        owl = zebra.loc[otter].values
        turtle = shark.loc[otter].values
        if owl.std(ddof=1) == 0 or turtle.std(ddof=1) == 0:
            koala[cat] = np.nan
            continue
        try:
            sparrow = float(np.corrcoef(owl, turtle)[0, 1])
        except Exception:
            koala[cat] = np.nan
            continue
        whale = dolphin.iloc[-rabbit:] if dolphin.shape[0] >= 2 else dolphin
        lizard = float(whale.std(ddof=1))
        if not np.isfinite(sparrow) or not np.isfinite(lizard) or (not np.isfinite(frog)) or (frog == 0):
            alpaca = np.nan
        else:
            alpaca = sparrow * (lizard / frog)
        koala[cat] = float(alpaca) if np.isfinite(alpaca) else np.nan
    return _make_factor_series(koala, panda, universe=universe, name='factor259')

def factor260(universe, date, N=20, lam=0.25):
    _set_asof_date(date)
    wolf = _last_n_trade_days(date, N)
    if len(wolf) < N:
        return _make_factor_series({}, date, universe=universe, name='factor260')
    owl = wolf[0]
    rabbit = wolf[-1]
    turtle = pd.to_datetime(owl).strftime('%Y-%m-%d')
    giraffe = pd.to_datetime(rabbit).strftime('%Y-%m-%d')
    bear = get_price(universe, start_date=turtle, end_date=giraffe, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor260')
    bear = bear.copy()
    bear['time'] = pd.to_datetime(bear['time'])
    bear.sort_values(['code', 'time'], inplace=True)
    zebra = {}
    for fox in universe:
        lizard = bear[bear['code'] == fox]
        if lizard.empty:
            continue
        lizard = lizard.tail(N).copy()
        lizard = lizard[['time', 'high', 'low', 'close']].set_index('time')
        lizard = lizard.replace([np.inf, -np.inf], np.nan)
        lizard = lizard.dropna()
        lizard = lizard[lizard['low'] > 0]
        if lizard.shape[0] < max(5, int(N * lam * 2)):
            continue
        dolphin = lizard['high'].astype(float).values
        eagle = lizard['low'].astype(float).values
        otter = lizard['close'].astype(float).values
        tiger = dolphin / eagle - 1.0
        sparrow = np.argsort(-otter)
        cat = tiger.size
        shark = max(int(cat * lam), 1)
        whale = sparrow[:shark]
        hawk = sparrow[-shark:]
        lion = tiger[whale]
        koala = tiger[hawk]
        lion = lion[np.isfinite(lion)]
        koala = koala[np.isfinite(koala)]
        if lion.size == 0 or koala.size == 0:
            continue
        dog = float(lion.mean())
        panda = float(koala.mean())
        frog = dog - panda
        if np.isfinite(frog):
            zebra[fox] = frog
    return _make_factor_series(zebra, date, universe=universe, name='factor260')

def factor261(universe, date, bench_index='000905.XSHG', n_lag=3):
    _set_asof_date(date)
    shark = pd.to_datetime(date)
    badger = shark.replace(day=1).strftime('%Y-%m-%d')
    lemur = shark.strftime('%Y-%m-%d')
    tuna = get_trade_days(start_date=badger, end_date=lemur)
    if len(tuna) < n_lag + 5:
        hawk = {dolphin: np.nan for dolphin in universe}
        return _make_factor_series(hawk, shark, universe=universe, name='factor261')
    sparrow = pd.to_datetime(tuna[0])
    mole = (sparrow - DateOffset(days=n_lag + 1)).strftime('%Y-%m-%d')
    whale = list(set(universe + [bench_index]))
    eagle = get_price(whale, start_date=mole, end_date=lemur, frequency='daily', fields=['close'], fq='post', panel=False)
    if eagle is None or eagle.empty:
        hawk = {dolphin: np.nan for dolphin in universe}
        return _make_factor_series(hawk, shark, universe=universe, name='factor261')
    beaver = eagle.pivot(index='time', columns='code', values='close').sort_index()
    if bench_index not in beaver.columns:
        hawk = {dolphin: np.nan for dolphin in universe}
        return _make_factor_series(hawk, shark, universe=universe, name='factor261')
    salmon = beaver[bench_index].astype(float)
    gecko = salmon.pct_change()
    alpaca = pd.to_datetime(tuna).normalize()
    hawk = {}
    for dolphin in universe:
        if dolphin not in beaver.columns:
            hawk[dolphin] = np.nan
            continue
        hyena = beaver[dolphin].astype(float)
        donkey = hyena.pct_change()
        owl = donkey.index.intersection(gecko.index)
        if len(owl) <= n_lag + 3:
            hawk[dolphin] = np.nan
            continue
        camel = donkey.loc[owl]
        ferret = gecko.loc[owl]
        turtle = pd.to_datetime(owl).normalize()
        lizard = turtle.isin(alpaca)
        tiger = []
        otter = []
        for narwhal in range(len(owl)):
            if not lizard[narwhal]:
                continue
            if narwhal < n_lag:
                continue
            raccoon = camel.iloc[narwhal]
            quail = [ferret.iloc[narwhal - frog] for frog in range(0, n_lag + 1)]
            if not np.isfinite(raccoon) or not np.all(np.isfinite(quail)):
                continue
            tiger.append([1.0] + quail)
            otter.append(raccoon)
        if len(otter) < n_lag + 2:
            hawk[dolphin] = np.nan
            continue
        panda = np.asarray(tiger, dtype=float)
        otter = np.asarray(otter, dtype=float)
        try:
            giraffe, rabbit, rabbit, rabbit = np.linalg.lstsq(panda, otter, rcond=None)
            fox = panda @ giraffe
            iguana = np.sum((otter - fox) ** 2)
            kangaroo = np.sum((otter - otter.mean()) ** 2)
            cat = 1.0 - iguana / kangaroo if kangaroo > 0 else np.nan
        except Exception:
            hawk[dolphin] = np.nan
            continue
        koala = []
        bear = []
        for narwhal in range(len(owl)):
            if not lizard[narwhal]:
                continue
            if narwhal < 1:
                continue
            raccoon = camel.iloc[narwhal]
            penguin = ferret.iloc[narwhal]
            if not np.isfinite(raccoon) or not np.isfinite(penguin):
                continue
            koala.append([1.0, penguin])
            bear.append(raccoon)
        if len(bear) < 3:
            hawk[dolphin] = np.nan
            continue
        lion = np.asarray(koala, dtype=float)
        bear = np.asarray(bear, dtype=float)
        try:
            zebra, rabbit, rabbit, rabbit = np.linalg.lstsq(lion, bear, rcond=None)
            wolf = lion @ zebra
            jaguar = np.sum((bear - wolf) ** 2)
            llama = np.sum((bear - bear.mean()) ** 2)
            dog = 1.0 - jaguar / llama if llama > 0 else np.nan
        except Exception:
            hawk[dolphin] = np.nan
            continue
        if not np.isfinite(cat) or not np.isfinite(dog) or cat == 0:
            octopus = np.nan
        else:
            octopus = 1.0 - dog / cat
        hawk[dolphin] = float(octopus) if np.isfinite(octopus) else np.nan
    return _make_factor_series(hawk, shark, universe=universe, name='factor261')

def factor262(universe, date):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    try:
        lion = get_factor_values(universe, factors=['roe_ttm'], end_date=panda, count=1)
        dog = lion['roe_ttm'].iloc[-1]
    except Exception:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, panda, universe=universe, name='factor262')
    tiger = panda - DateOffset(years=1)
    try:
        koala = get_factor_values(universe, factors=['roe_ttm'], end_date=tiger, count=1)
        fox = koala['roe_ttm'].iloc[-1]
    except Exception:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, panda, universe=universe, name='factor262')
    otter = {}
    for cat in universe:
        bear = dog.get(cat, np.nan)
        wolf = fox.get(cat, np.nan)
        if not np.isfinite(bear) or not np.isfinite(wolf):
            rabbit = np.nan
        else:
            rabbit = bear - wolf
        otter[cat] = float(rabbit) if np.isfinite(rabbit) else np.nan
    return _make_factor_series(otter, panda, universe=universe, name='factor262')

def factor263(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    whale = eagle - 4
    sparrow = pd.PeriodIndex([eagle, eagle - 1, eagle - 2, eagle - 3], freq='Q-DEC')
    hawk = pd.PeriodIndex([whale, whale - 1, whale - 2, whale - 3], freq='Q-DEC')
    shark = pd.PeriodIndex(list(sparrow) + list(hawk) + [eagle, whale], freq='Q-DEC').unique()

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    otter = get_history_fundamentals(security=tiger, fields=[bear.term_052], watch_date=cat, count=40, interval='1q', stat_by_year=False)
    wolf = _prep_hist(otter)
    if wolf.empty or 'term_052' not in wolf.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor263')
    wolf = wolf[wolf['q'].isin(shark)]
    if wolf.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor263')
    rabbit = wolf.pivot(index='q', columns='code', values='term_052').reindex(columns=tiger)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = rabbit.reindex(index=sparrow).sum(axis=0, min_count=1).reindex(tiger)
    giraffe = rabbit.reindex(index=hawk).sum(axis=0, min_count=1).reindex(tiger)
    koala = get_history_fundamentals(security=tiger, fields=[fox.term_081], watch_date=cat, count=40, interval='1q', stat_by_year=False)
    dog = _prep_hist(koala)
    if dog.empty or 'term_081' not in dog.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor263')
    dog = dog[dog['q'].isin([eagle, whale])]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor263')
    frog = dog.pivot(index='q', columns='code', values='term_081').reindex(index=[whale, eagle], columns=tiger)
    frog = frog.apply(pd.to_numeric, errors='coerce').astype(float)
    salmon = frog.loc[eagle] if eagle in frog.index else pd.Series(np.nan, index=tiger, dtype='float64')
    lizard = frog.loc[whale] if whale in frog.index else pd.Series(np.nan, index=tiger, dtype='float64')
    salmon = salmon.where(np.isfinite(salmon) & (salmon > 0), np.nan)
    lizard = lizard.where(np.isfinite(lizard) & (lizard > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        turtle = zebra / salmon
        owl = giraffe / lizard
        dolphin = turtle - owl
    bear = ~np.isfinite(dolphin) | ~np.isfinite(turtle) | ~np.isfinite(owl) | ~np.isfinite(zebra) | ~np.isfinite(giraffe) | ~np.isfinite(salmon) | ~np.isfinite(lizard) | (salmon == 0) | (lizard == 0)
    dolphin = dolphin.where(~bear, np.nan).reindex(tiger)
    fox = {panda: float(dolphin.get(panda)) if np.isfinite(dolphin.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(fox, lion, universe=universe, name='factor263')

def factor264(universe, date):
    _set_asof_date(date)
    otter = pd.to_datetime(date)
    tiger = _cost_margin_ttm_single(universe, otter)
    koala = (otter - DateOffset(years=1)).strftime('%Y-%m-%d')
    panda = _cost_margin_ttm_single(universe, koala)
    fox = {}
    for lion in universe:
        dog = tiger.get(lion, np.nan)
        cat = panda.get(lion, np.nan)
        if not np.isfinite(dog) or not np.isfinite(cat) or cat == 0:
            wolf = np.nan
        else:
            wolf = (dog - cat) / abs(cat)
        fox[lion] = float(wolf) if np.isfinite(wolf) else np.nan
    return _make_factor_series(fox, otter, universe=universe, name='factor264')

def factor265(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    panda = pd.Timestamp(otter)
    koala = list(universe)
    owl = pd.Period(panda, freq='Q-DEC') - 1
    sparrow = pd.PeriodIndex([owl], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=koala, fields=[bear.term_052, bear.term_060, bear.term_076, bear.term_004, bear.term_021], watch_date=panda, count=8, interval='1q', stat_by_year=False)
    giraffe = _prep_hist(fox)
    if giraffe.empty:
        return _make_factor_series({tiger: np.nan for tiger in koala}, otter, universe=universe, name='factor265')
    giraffe = giraffe[giraffe['q'].isin(sparrow)]
    if giraffe.empty:
        return _make_factor_series({tiger: np.nan for tiger in koala}, otter, universe=universe, name='factor265')
    dolphin = giraffe.pivot(index='q', columns='code', values='term_052').reindex(index=sparrow, columns=koala)
    eagle = giraffe.pivot(index='q', columns='code', values='term_060').reindex(index=sparrow, columns=koala)
    lizard = giraffe.pivot(index='q', columns='code', values='term_076').reindex(index=sparrow, columns=koala)
    dog = giraffe.pivot(index='q', columns='code', values='term_004').reindex(index=sparrow, columns=koala)
    rabbit = giraffe.pivot(index='q', columns='code', values='term_021').reindex(index=sparrow, columns=koala)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    eagle = eagle.apply(pd.to_numeric, errors='coerce').astype(float)
    lizard = lizard.apply(pd.to_numeric, errors='coerce').astype(float)
    dog = dog.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = dolphin.loc[owl] if owl in dolphin.index else pd.Series(np.nan, index=koala, dtype='float64')
    shark = eagle.loc[owl] if owl in eagle.index else pd.Series(np.nan, index=koala, dtype='float64')
    turtle = lizard.loc[owl] if owl in lizard.index else pd.Series(np.nan, index=koala, dtype='float64')
    cat = dog.loc[owl] if owl in dog.index else pd.Series(np.nan, index=koala, dtype='float64')
    bear = rabbit.loc[owl] if owl in rabbit.index else pd.Series(np.nan, index=koala, dtype='float64')
    lion = shark + turtle + cat + bear
    lion = lion.where(np.isfinite(lion) & (lion != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = whale / lion
    zebra = ~np.isfinite(hawk) | ~np.isfinite(whale) | ~np.isfinite(lion) | (lion == 0)
    hawk = hawk.where(~zebra, np.nan).reindex(koala)
    wolf = {tiger: float(hawk.get(tiger)) if np.isfinite(hawk.get(tiger, np.nan)) else np.nan for tiger in koala}
    return _make_factor_series(wolf, otter, universe=universe, name='factor265')

def factor266(universe, date, N=20):
    _set_asof_date(date)
    rabbit = _last_n_trade_days(date, N + 1)
    if len(rabbit) < N + 1:
        zebra = {bear: np.nan for bear in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor266')
    dolphin = rabbit[0]
    whale = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    giraffe = get_price(universe, start_date=whale, end_date=date, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if giraffe is None or giraffe.empty:
        zebra = {bear: np.nan for bear in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor266')
    fox = giraffe.pivot(index='time', columns='code', values='close').sort_index()
    sparrow = giraffe.pivot(index='time', columns='code', values='volume').sort_index()
    wolf = fox.iloc[-(N + 1):]
    owl = sparrow.iloc[-(N + 1):]
    zebra = {}
    for bear in universe:
        if bear not in wolf.columns:
            zebra[bear] = np.nan
            continue
        lion = wolf[bear].astype(float).values
        shark = owl[bear].astype(float).values
        if lion.size < N + 1 or shark.size < N + 1:
            zebra[bear] = np.nan
            continue
        otter = lion[:-1]
        koala = lion[1:]
        eagle = shark[1:]
        cat = np.where(koala > otter, eagle, 0.0)
        panda = np.where(koala < otter, eagle, 0.0)
        dog = cat.sum()
        tiger = panda.sum()
        if tiger == 0 or not np.isfinite(tiger):
            hawk = np.nan
        else:
            hawk = float(dog / tiger * 100.0)
        zebra[bear] = hawk
    return _make_factor_series(zebra, date, universe=universe, name='factor266')

def factor267(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    eagle = whale - 1
    hawk = pd.PeriodIndex([whale, whale - 1, whale - 2, whale - 3], freq='Q-DEC')
    shark = pd.PeriodIndex([whale, eagle], freq='Q-DEC')
    fox = get_history_fundamentals(security=lion, fields=[bear.term_063], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    otter = get_history_fundamentals(security=lion, fields=[fox.term_081], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    if (fox is None or fox.empty) or (otter is None or otter.empty):
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor267')

    def _prep(df: pd.DataFrame):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    bear = _prep(fox)
    panda = _prep(otter)
    if bear is None or panda is None:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor267')
    giraffe = bear.pivot(index='q', columns='code', values='term_063').sort_index().reindex(columns=lion)
    sparrow = panda.pivot(index='q', columns='code', values='term_081').sort_index().reindex(columns=lion)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=hawk)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=shark)
    zebra = giraffe.sum(axis=0, min_count=1)
    owl = sparrow.loc[whale] if whale in sparrow.index else pd.Series(np.nan, index=lion, dtype='float64')
    turtle = sparrow.loc[eagle] if eagle in sparrow.index else pd.Series(np.nan, index=lion, dtype='float64')
    dog = (owl + turtle) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = zebra / dog
    rabbit = ~np.isfinite(dolphin) | ~np.isfinite(zebra) | ~np.isfinite(dog) | (dog == 0) | (dog <= 0)
    dolphin = dolphin.where(~rabbit, np.nan).reindex(lion)
    wolf = {tiger: float(dolphin.get(tiger)) if np.isfinite(dolphin.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(wolf, koala, universe=universe, name='factor267')

def factor268(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    try:
        frog = factor267(universe, lion)
    except Exception:
        frog = None
    try:
        koala = (pd.Timestamp(lion) - DateOffset(years=1)).date()
        owl = factor267(universe, koala)
    except Exception:
        owl = None
    if isinstance(frog, pd.Series) and isinstance(owl, pd.Series):
        try:
            salmon = frog.xs(lion, level=0)
            turtle = owl.xs(koala, level=0)
            zebra = int(np.isfinite(salmon.reindex(tiger).values).sum())
        except Exception:
            salmon, turtle, zebra = (None, None, 0)
        if salmon is not None and turtle is not None and (zebra >= 30):
            wolf = salmon.reindex(tiger) - turtle.reindex(tiger)
            wolf = wolf.replace([np.inf, -np.inf], np.nan)
            whale = {panda: float(wolf.loc[panda]) if np.isfinite(wolf.loc[panda]) else np.nan for panda in tiger}
            return _make_factor_series(whale, lion, universe=universe, name='factor268')
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    shark = eagle - 4
    giraffe = pd.PeriodIndex([eagle, shark], freq='Q-DEC')
    fox = get_history_fundamentals(security=tiger, fields=[bear.term_063, bear.term_021], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    otter = get_history_fundamentals(security=tiger, fields=[fox.term_081], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    if fox is None or fox.empty or otter is None or otter.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor268')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    rabbit = _prep(fox)
    dog = _prep(otter)
    if rabbit is None or dog is None:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor268')
    dolphin = rabbit.pivot(index='q', columns='code', values='term_063').sort_index().reindex(index=giraffe, columns=tiger)
    bear = rabbit.pivot(index='q', columns='code', values='term_021').sort_index().reindex(index=giraffe, columns=tiger)
    tuna = dog.pivot(index='q', columns='code', values='term_081').sort_index().reindex(index=giraffe, columns=tiger)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float).fillna(0.0)
    tuna = tuna.apply(pd.to_numeric, errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = (dolphin + bear) / tuna
    hawk = hawk.replace([np.inf, -np.inf], np.nan)
    lizard = hawk.loc[eagle]
    sparrow = hawk.loc[shark]
    wolf = (lizard - sparrow).replace([np.inf, -np.inf], np.nan)
    whale = {panda: float(wolf.get(panda, np.nan)) if np.isfinite(wolf.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(whale, lion, universe=universe, name='factor268')

def factor269(universe, date, bench_index='000905.XSHG', K_months=12):
    _set_asof_date(date)
    otter = pd.to_datetime(date)
    lizard = list(universe)
    fox = _last_n_trade_days(otter, int(K_months) * 21 + 3)
    if len(fox) < 20:
        return _make_factor_series({tiger: np.nan for tiger in lizard}, date, universe=universe, name='factor269')
    turtle = pd.to_datetime(fox[0]).strftime('%Y-%m-%d')
    bear = pd.to_datetime(otter).strftime('%Y-%m-%d')
    koala = list(set(lizard + [bench_index]))
    wolf = get_price(koala, start_date=turtle, end_date=bear, frequency='daily', fields=['close'], fq='post', panel=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({tiger: np.nan for tiger in lizard}, date, universe=universe, name='factor269')
    zebra = wolf.pivot(index='time', columns='code', values='close').sort_index()
    if bench_index not in zebra.columns:
        return _make_factor_series({tiger: np.nan for tiger in lizard}, date, universe=universe, name='factor269')
    whale = zebra[bench_index].astype(float).pct_change().dropna()
    rabbit = {}
    for lion in lizard:
        if lion not in zebra.columns:
            rabbit[lion] = np.nan
            continue
        dolphin = zebra[lion].astype(float).pct_change().dropna()
        giraffe = dolphin.index.intersection(whale.index)
        if len(giraffe) < 15:
            rabbit[lion] = np.nan
            continue
        shark = dolphin.loc[giraffe].values.astype(float)
        eagle = whale.loc[giraffe].values.astype(float)
        if shark.size < 15:
            rabbit[lion] = np.nan
            continue
        frog = shark[1:-1]
        sparrow = eagle[0:-2]
        hawk = eagle[1:-1]
        owl = eagle[2:]
        if frog.size < 5:
            rabbit[lion] = np.nan
            continue
        cat = np.column_stack([np.ones(frog.size, dtype=float), sparrow, hawk, owl])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, frog, rcond=None)
            rabbit[lion] = float(panda[1] + panda[2] + panda[3])
        except Exception:
            rabbit[lion] = np.nan
    return _make_factor_series(rabbit, date, universe=universe, name='factor269')

def factor270(universe, date, N=20):
    _set_asof_date(date)
    tiger = _last_n_trade_days(date, N)
    if len(tiger) < N:
        koala = {panda: np.nan for panda in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor270')
    otter = tiger[0]
    fox = pd.to_datetime(otter).strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=fox, end_date=date, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if lion is None or lion.empty:
        koala = {panda: np.nan for panda in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor270')
    dog = lion.pivot(index='time', columns='code', values='close').sort_index().iloc[-N:]
    giraffe = lion.pivot(index='time', columns='code', values='volume').sort_index().iloc[-N:]
    koala = {}
    for panda in universe:
        if panda not in dog.columns:
            koala[panda] = np.nan
            continue
        cat = dog[panda].astype(float).values
        wolf = giraffe[panda].astype(float).values
        bear = wolf.sum()
        if bear == 0 or not np.isfinite(bear):
            rabbit = np.nan
        else:
            rabbit = float((cat * wolf).sum() / bear)
        koala[panda] = rabbit
    return _make_factor_series(koala, date, universe=universe, name='factor270')

def factor271(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    dolphin = whale - 4
    otter = get_history_fundamentals(security=tiger, fields=[bear.term_063, bear.term_021], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    koala = get_history_fundamentals(security=tiger, fields=[fox.term_081], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    if (otter is None or otter.empty) or (koala is None or koala.empty):
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor271')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    rabbit = _prep(otter)
    dog = _prep(koala)
    if rabbit is None or dog is None:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor271')
    giraffe = rabbit.pivot(index='q', columns='code', values='term_063').sort_index().reindex(columns=tiger)
    wolf = rabbit.pivot(index='q', columns='code', values='term_021').sort_index().reindex(columns=tiger)
    sparrow = dog.pivot(index='q', columns='code', values='term_081').sort_index().reindex(columns=tiger)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    bear = pd.PeriodIndex([whale, dolphin], freq='Q-DEC')
    giraffe = giraffe.reindex(index=bear)
    wolf = wolf.reindex(index=bear)
    sparrow = sparrow.reindex(index=bear)
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = (giraffe + wolf) / sparrow
    shark = shark.replace([np.inf, -np.inf], np.nan)
    hawk = shark.loc[whale]
    eagle = shark.loc[dolphin]
    zebra = (hawk - eagle).replace([np.inf, -np.inf], np.nan)
    fox = {panda: float(zebra.get(panda, np.nan)) if np.isfinite(zebra.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(fox, lion, universe=universe, name='factor271')

def factor272(universe, date, N=20):
    _set_asof_date(date)
    lion = _last_n_trade_days(date, N + 1)
    if len(lion) < N + 1:
        otter = {tiger: np.nan for tiger in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor272')
    whale = lion[0]
    shark = pd.to_datetime(whale).strftime('%Y-%m-%d')
    koala = get_price(universe, start_date=shark, end_date=date, frequency='daily', fields=['close', 'money'], fq='post', panel=False)
    if koala is None or koala.empty:
        otter = {tiger: np.nan for tiger in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor272')
    dog = koala.pivot(index='time', columns='code', values='close').sort_index()
    bear = koala.pivot(index='time', columns='code', values='money').sort_index()
    panda = dog.iloc[-(N + 1):]
    rabbit = bear.iloc[-(N + 1):]
    giraffe = panda.pct_change().iloc[1:]
    rabbit = rabbit.iloc[1:]
    otter = {}
    for tiger in universe:
        if tiger not in giraffe.columns:
            otter[tiger] = np.nan
            continue
        zebra = giraffe[tiger].astype(float)
        cat = rabbit[tiger].astype(float)
        fox = np.abs(zebra) / cat.replace(0, np.nan)
        fox = fox.replace([np.inf, -np.inf], np.nan).dropna()
        if fox.empty:
            eagle = np.nan
        else:
            wolf = fox.mean()
            dolphin = fox.std(ddof=1)
            if wolf == 0 or not np.isfinite(wolf):
                eagle = np.nan
            else:
                eagle = dolphin / wolf
        otter[tiger] = float(eagle) if np.isfinite(eagle) else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor272')

def factor273(universe, date, lookback_corr=250, lookback_spread=60, N_similar=10, block_size=256, min_obs=60):
    _set_asof_date(date)
    shark = pd.to_datetime(date)
    urchin = list(universe)
    if len(urchin) < 2:
        return _make_factor_series({whale: np.nan for whale in urchin}, shark, universe=universe, name='factor273')
    hyena = int(lookback_corr + lookback_spread + 1)
    eagle = _last_n_trade_days(shark, hyena)
    if len(eagle) < hyena:
        return _make_factor_series({whale: np.nan for whale in urchin}, shark, universe=universe, name='factor273')
    penguin = pd.to_datetime(eagle[0]).strftime('%Y-%m-%d')
    turtle = pd.to_datetime(shark).strftime('%Y-%m-%d')
    owl = get_price(urchin, start_date=penguin, end_date=turtle, frequency='daily', fields=['close'], fq='post', panel=False)
    if owl is None or owl.empty:
        return _make_factor_series({whale: np.nan for whale in urchin}, shark, universe=universe, name='factor273')
    owl = owl.copy()
    if 'time' not in owl.columns:
        owl = owl.reset_index()
    if 'code' not in owl.columns:
        return _make_factor_series({whale: np.nan for whale in urchin}, shark, universe=universe, name='factor273')
    giraffe = owl.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=urchin)
    if giraffe.shape[0] < lookback_corr + lookback_spread:
        return _make_factor_series({whale: np.nan for whale in urchin}, shark, universe=universe, name='factor273')
    zebra = giraffe.iloc[-(lookback_corr + lookback_spread):]
    rabbit = zebra.iloc[:lookback_corr]
    llama = rabbit.pct_change().iloc[1:]
    lion = int(llama.shape[0])
    if lion < max(10, int(min_obs)):
        return _make_factor_series({whale: np.nan for whale in urchin}, shark, universe=universe, name='factor273')
    panda = llama.values.astype(float)
    frog = np.isfinite(panda)
    dolphin = frog.sum(axis=0).astype(float)
    raccoon = np.where(frog, panda, 0.0).sum(axis=0)
    ferret = np.full(raccoon.shape, np.nan, dtype=float)
    np.divide(raccoon, dolphin, out=ferret, where=dolphin > 0)
    tiger = panda - ferret[None, :]
    tiger = np.where(frog, tiger, 0.0)
    octopus = (tiger * tiger).sum(axis=0)
    sparrow = dolphin - 1.0
    bee = np.full(octopus.shape, np.nan, dtype=float)
    np.divide(octopus, sparrow, out=bee, where=sparrow > 0)
    quail = np.sqrt(bee)
    ant = np.isfinite(quail) & (quail > 0) & (dolphin >= float(min_obs))
    if ant.sum() < 2:
        return _make_factor_series({whale: np.nan for whale in urchin}, shark, universe=universe, name='factor273')
    koala = np.zeros_like(tiger, dtype=np.float32)
    koala[:, ant] = (tiger[:, ant] / quail[None, ant]).astype(np.float32)
    turkey = {whale: [] for whale in urchin}
    otter = koala.T
    hawk = float(lion - 1)
    if hawk <= 0:
        return _make_factor_series({whale: np.nan for whale in urchin}, shark, universe=universe, name='factor273')
    dog = len(urchin)
    wolf = max(1, int(block_size))
    for lemur in range(0, dog, wolf):
        badger = min(dog, lemur + wolf)
        fox = koala[:, lemur:badger]
        cat = otter @ fox / hawk
        cat = np.asarray(cat, dtype=float)
        for beaver in range(badger - lemur):
            alpaca = lemur + beaver
            if not ant[alpaca]:
                continue
            vulture = cat[:, beaver]
            vulture[alpaca] = -np.inf
            walrus = vulture.copy()
            walrus[~ant] = -np.inf
            camel = int(min(max(1, int(N_similar)), int(ant.sum() - 1)))
            if camel <= 0:
                continue
            tuna = np.argpartition(-walrus, camel)[:camel]
            tuna = tuna[np.argsort(-walrus[tuna])]
            turkey[urchin[alpaca]] = [urchin[seal] for seal in tuna if np.isfinite(walrus[seal])]
    bear = giraffe.iloc[-int(lookback_spread):].astype(float)
    lizard = {}
    for whale in urchin:
        jaguar = turkey.get(whale, [])
        if len(jaguar) == 0:
            lizard[whale] = np.nan
            continue
        iguana = bear[whale]
        kangaroo = bear[jaguar].mean(axis=1, skipna=True)
        donkey = np.isfinite(iguana.values) & np.isfinite(kangaroo.values) & (iguana.values > 0) & (kangaroo.values > 0)
        if donkey.sum() < 10:
            lizard[whale] = np.nan
            continue
        narwhal = (np.log(iguana.values[donkey]) - np.log(kangaroo.values[donkey])).astype(float)
        if narwhal.size < 10:
            lizard[whale] = np.nan
            continue
        salmon = narwhal[:-1]
        if salmon.size < 5:
            lizard[whale] = np.nan
            continue
        gecko = float(salmon.mean())
        mole = float(salmon.std(ddof=1))
        if not np.isfinite(mole) or mole == 0:
            lizard[whale] = np.nan
            continue
        yak = (float(narwhal[-1]) - gecko) / mole
        lizard[whale] = float(yak) if np.isfinite(yak) else np.nan
    return _make_factor_series(lizard, shark, universe=universe, name='factor273')

def factor274(universe, date):
    _set_asof_date(date)
    lion = pd.to_datetime(date)
    dolphin = list(universe)
    koala = get_history_fundamentals(security=dolphin, fields=[rabbit.eps], watch_date=lion, count=12, interval='1q', stat_by_year=False)
    if koala is None or koala.empty:
        return _make_factor_series({panda: np.nan for panda in dolphin}, date, universe=universe, name='factor274')
    koala = koala.copy()
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    koala.sort_values(['code', 'statDate'], inplace=True)
    fox = {panda: np.nan for panda in dolphin}
    for tiger, giraffe in koala.groupby('code', sort=False):
        giraffe = giraffe.drop_duplicates('statDate').tail(12)
        if giraffe.shape[0] < 12:
            continue
        otter = giraffe['eps'].astype(float).values
        zebra = []
        for wolf in range(0, 8):
            cat = otter[11 - wolf]
            dog = otter[7 - wolf]
            if not np.isfinite(cat) or not np.isfinite(dog):
                zebra.append(np.nan)
            else:
                zebra.append(cat - dog)
        zebra = np.asarray(zebra, dtype=float)
        bear = zebra[0]
        whale = zebra[np.isfinite(zebra)]
        if not np.isfinite(bear) or whale.size < 2:
            continue
        rabbit = float(np.std(whale, ddof=1))
        if not np.isfinite(rabbit) or rabbit == 0:
            continue
        fox[tiger] = float(bear / rabbit)
    return _make_factor_series(fox, date, universe=universe, name='factor274')

def factor275(universe, date, N=20):
    _set_asof_date(date)
    giraffe = _last_n_trade_days(date, N + 1)
    if len(giraffe) < N + 1:
        dolphin = {bear: np.nan for bear in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor275')
    owl = giraffe[0]
    turtle = pd.to_datetime(owl).strftime('%Y-%m-%d')
    zebra = get_price(universe, start_date=turtle, end_date=date, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        dolphin = {bear: np.nan for bear in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor275')
    shark = zebra.pivot(index='time', columns='code', values='high').sort_index()
    sparrow = zebra.pivot(index='time', columns='code', values='low').sort_index()
    wolf = zebra.pivot(index='time', columns='code', values='close').sort_index()
    whale = shark.values[-(N + 1):]
    hawk = sparrow.values[-(N + 1):]
    fox = wolf.values[-(N + 1):]
    dolphin = {}
    rabbit = list(shark.columns)
    for eagle, bear in enumerate(rabbit):
        koala = whale[:, eagle]
        otter = hawk[:, eagle]
        lion = fox[:, eagle]
        if koala.size < N + 1 or otter.size < N + 1 or lion.size < N + 1:
            dolphin[bear] = np.nan
            continue
        cat = np.maximum(0.0, koala[1:] - lion[:-1])
        panda = np.maximum(0.0, lion[:-1] - otter[1:])
        dog = cat[-N:].sum()
        tiger = panda[-N:].sum()
        if tiger == 0 or not np.isfinite(tiger):
            lizard = np.nan
        else:
            lizard = float(dog / tiger)
        dolphin[bear] = lizard
    return _make_factor_series(dolphin, date, universe=universe, name='factor275')

def factor276(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    panda = pd.Timestamp(koala)
    lion = list(universe)
    dolphin = pd.Period(panda, freq='Q-DEC') - 1
    whale = dolphin - 1
    rabbit = pd.PeriodIndex([whale, dolphin], freq='Q-DEC')
    fox = get_history_fundamentals(security=lion, fields=[fox.total_owner_equities], watch_date=panda, count=12, interval='1q', stat_by_year=False)
    if fox is None or fox.empty or 'code' not in fox.columns or ('statDate' not in fox.columns):
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor276')
    fox = fox.copy()
    if 'pubDate' in fox.columns:
        zebra = pd.to_datetime(fox['pubDate'], errors='coerce')
        fox = fox[zebra.notna() & (zebra <= panda)]
    fox['code'] = fox['code'].astype(str)
    fox['statDate'] = pd.to_datetime(fox['statDate'], errors='coerce')
    fox = fox.dropna(subset=['code', 'statDate'])
    if fox.empty or 'total_owner_equities' not in fox.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor276')
    fox['q'] = fox['statDate'].dt.to_period('Q-DEC')
    fox = fox[fox['q'].isin(rabbit)]
    fox = fox.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if fox.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor276')
    wolf = fox.pivot(index='q', columns='code', values='total_owner_equities').reindex(index=rabbit, columns=lion)
    wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float)
    dog = wolf.loc[dolphin]
    cat = wolf.loc[whale]
    otter = cat.abs()
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = (dog - cat) / otter
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    giraffe = giraffe.where(np.isfinite(otter) & (otter > 0), np.nan)
    bear = {tiger: float(giraffe.get(tiger, np.nan)) if np.isfinite(giraffe.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(bear, koala, universe=universe, name='factor276')

def factor277(universe, date, alpha=0.5, d=20, batch_size=120):
    _set_asof_date(date)
    bear = pd.to_datetime(date)
    alpaca = list(universe)
    rabbit = _last_n_trade_days(bear, int(d))
    if len(rabbit) == 0:
        return _make_factor_series({lion: np.nan for lion in alpaca}, bear, universe=universe, name='factor277')
    giraffe = [pd.to_datetime(beaver).date() for beaver in rabbit]
    lizard = _to_date(rabbit[0])
    zebra = _to_date(rabbit[-1]) + dt.timedelta(days=1)
    sparrow = []
    for shark in range(0, len(alpaca), max(1, int(batch_size))):
        dog = alpaca[shark:shark + max(1, int(batch_size))]
        eagle = get_price(dog, start_date=lizard, end_date=zebra, frequency='1m', fields=['open', 'high', 'low', 'close', 'volume'], fq='post', panel=False)
        if eagle is None or eagle.empty:
            continue
        eagle = eagle.copy()
        if 'time' not in eagle.columns:
            eagle['time'] = eagle.index
        if 'code' not in eagle.columns:
            continue
        eagle['time'] = pd.to_datetime(eagle['time'])
        eagle['date'] = eagle['time'].dt.date
        eagle = eagle[eagle['date'].isin(giraffe)]
        if eagle.empty:
            continue
        koala = ['open', 'high', 'low', 'close', 'volume']
        eagle = eagle[['code', 'date'] + koala].dropna(subset=['open', 'high', 'low', 'close', 'volume'])
        if eagle.empty:
            continue
        for tiger in koala:
            eagle[tiger] = eagle[tiger].astype(float)
        whale = np.isfinite(eagle['open'].values) & np.isfinite(eagle['high'].values) & np.isfinite(eagle['low'].values) & np.isfinite(eagle['close'].values) & np.isfinite(eagle['volume'].values)
        eagle = eagle.loc[whale]
        if eagle.empty:
            continue
        turtle = np.abs(eagle['high'].values - eagle['low'].values)
        panda = np.abs(eagle['close'].values - eagle['open'].values)
        otter = (turtle > 0) & (panda <= float(alpha) * turtle)
        lemur = eagle['volume'].values.astype(float)
        fox = np.where(otter, lemur, 0.0)
        salmon = eagle[['code', 'date']].copy()
        salmon['cons_v'] = fox
        salmon['tot_v'] = lemur
        cat = salmon.groupby(['code', 'date'], sort=False)[['cons_v', 'tot_v']].sum().reset_index()
        sparrow.append(cat)
    if len(sparrow) == 0:
        return _make_factor_series({lion: np.nan for lion in alpaca}, bear, universe=universe, name='factor277')
    wolf = pd.concat(sparrow, ignore_index=True)
    wolf = wolf.groupby(['code', 'date'], sort=False)[['cons_v', 'tot_v']].sum().reset_index()
    dolphin = {lion: np.nan for lion in alpaca}
    for lion, frog in wolf.groupby('code', sort=False):
        tuna = frog['tot_v'].values.astype(float)
        otter = frog['cons_v'].values.astype(float)
        hawk = np.isfinite(tuna) & np.isfinite(otter) & (tuna > 0)
        if hawk.sum() == 0:
            continue
        owl = otter[hawk] / tuna[hawk]
        owl = owl[np.isfinite(owl)]
        if owl.size == 0:
            continue
        badger = float(np.mean(owl))
        dolphin[lion] = badger if np.isfinite(badger) else np.nan
    return _make_factor_series(dolphin, bear, universe=universe, name='factor277')

def factor278(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    cat = pd.Timestamp(fox)
    lion = list(universe)
    shark = pd.Period(cat, freq='Q-DEC') - 1
    hawk = shark - 1
    sparrow = pd.PeriodIndex([shark, shark - 1, shark - 2, shark - 3], freq='Q-DEC')
    eagle = pd.PeriodIndex([shark, hawk], freq='Q-DEC')
    bear = get_history_fundamentals(security=lion, fields=[bear.term_066, bear.term_060], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    wolf = get_history_fundamentals(security=lion, fields=[fox.term_081], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    if (bear is None or bear.empty) or (wolf is None or wolf.empty):
        return _make_factor_series({tiger: np.nan for tiger in lion}, fox, universe=universe, name='factor278')

    def _prep(df: pd.DataFrame):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    zebra = _prep(bear)
    panda = _prep(wolf)
    if zebra is None or panda is None:
        return _make_factor_series({tiger: np.nan for tiger in lion}, fox, universe=universe, name='factor278')
    owl = zebra.pivot(index='q', columns='code', values='term_066').sort_index().reindex(columns=lion)
    koala = zebra.pivot(index='q', columns='code', values='term_060').sort_index().reindex(columns=lion)
    lizard = panda.pivot(index='q', columns='code', values='term_081').sort_index().reindex(columns=lion)
    owl = owl.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=sparrow)
    koala = koala.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=sparrow)
    lizard = lizard.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=eagle)
    turtle = owl.sum(axis=0, min_count=1)
    otter = koala.sum(axis=0, min_count=1)
    giraffe = turtle - otter
    frog = lizard.loc[shark] if shark in lizard.index else pd.Series(np.nan, index=lion, dtype='float64')
    salmon = lizard.loc[hawk] if hawk in lizard.index else pd.Series(np.nan, index=lion, dtype='float64')
    dog = (frog + salmon) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        whale = giraffe / dog
    dolphin = ~np.isfinite(whale) | ~np.isfinite(giraffe) | ~np.isfinite(dog) | (dog == 0) | ~np.isfinite(turtle) | ~np.isfinite(otter)
    whale = whale.where(~dolphin, np.nan).reindex(lion)
    rabbit = {tiger: float(whale.get(tiger)) if np.isfinite(whale.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(rabbit, fox, universe=universe, name='factor278')

def factor279(universe, date):
    _set_asof_date(date)
    lion = pd.to_datetime(date).strftime('%Y-%m-%d')
    fox = get_money_flow_pro(universe, start_date=lion, end_date=lion, frequency='daily', fields=['inflow_s', 'outflow_s'], data_type='money')
    if fox is None or fox.empty:
        otter = {panda: np.nan for panda in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor279')
    fox = fox.copy()
    fox['date'] = fox['time'].dt.date
    fox = fox.groupby(['date', 'code'])[['inflow_s', 'outflow_s']].sum()
    tiger = pd.to_datetime(date).date()
    otter = {}
    for panda in universe:
        wolf = (tiger, panda)
        if wolf not in fox.index:
            otter[panda] = np.nan
            continue
        bear = fox.loc[wolf]
        cat = float(bear['inflow_s'])
        dog = float(bear['outflow_s'])
        koala = cat + dog
        if koala <= 0 or not np.isfinite(koala):
            rabbit = np.nan
        else:
            rabbit = (cat - dog) / koala
        otter[panda] = float(rabbit) if np.isfinite(rabbit) else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor279')

def factor280(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = [str(cat) for cat in list(universe)]
    rabbit, fox = (tiger.year, tiger.month)
    try:
        prefetch_security_info(panda, asof_date=tiger)
    except Exception:
        pass

    def _ipo_date(code):
        try:
            cat = get_security_info(code)
            return getattr(cat, 'start_date', None)
        except Exception:
            return None
    otter = {cat: _ipo_date(cat) for cat in panda}
    bear = [cat for cat, koala in otter.items() if koala is None]
    if len(bear) == len(panda) and len(panda) > 0:
        try:
            if '_load_security_info_cache' in globals():
                _load_security_info_cache()
            dog = globals().get('_SECURITY_INFO_CACHE', None)
            if isinstance(dog, dict):
                for cat in bear:
                    dog.pop(cat, None)
                prefetch_security_info(bear, asof_date=tiger)
                for cat in bear:
                    otter[cat] = _ipo_date(cat)
                if '_save_security_info_cache' in globals():
                    _save_security_info_cache()
        except Exception:
            pass
    lion = {}
    for cat in panda:
        koala = otter.get(cat, None)
        if koala is None:
            lion[cat] = np.nan
            continue
        try:
            wolf = (rabbit - koala.year) * 12 + (fox - koala.month)
            if wolf < 0:
                wolf = 0
            lion[cat] = float(wolf)
        except Exception:
            lion[cat] = np.nan
    return _make_factor_series(lion, tiger, universe=universe, name='factor280')

def factor281(universe, date):
    _set_asof_date(date)
    dolphin = query(fox.code, fox.term_084, fox.total_owner_equities, fox.term_036, fox.development_expenditure, fox.good_will, fox.term_042, fox.term_015).filter(fox.code.in_(universe))
    koala = get_fundamentals(dolphin, date=date)
    if koala is None or koala.empty:
        bear = {cat: np.nan for cat in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor281')
    koala = koala.set_index('code')
    tiger = ['term_084', 'total_owner_equities']
    panda = ['term_036', 'development_expenditure', 'good_will', 'term_042', 'term_015']
    for dog in tiger + panda:
        if dog not in koala.columns:
            koala[dog] = np.nan
    fox = koala[tiger]
    otter = koala[panda].fillna(0.0)
    bear = {}
    for cat in universe:
        if cat not in fox.index:
            bear[cat] = np.nan
            continue
        shark = float(fox.at[cat, 'term_084'])
        wolf = float(fox.at[cat, 'total_owner_equities'])
        giraffe = float(otter.at[cat, 'term_036'])
        lion = float(otter.at[cat, 'development_expenditure'])
        rabbit = float(otter.at[cat, 'good_will'])
        zebra = float(otter.at[cat, 'term_042'])
        dt = float(otter.at[cat, 'term_015'])
        if np.isnan(shark) or np.isnan(wolf):
            eagle = np.nan
        else:
            whale = wolf - giraffe - lion - rabbit - zebra - dt
            if not np.isfinite(whale) or whale <= 0:
                eagle = np.nan
            else:
                eagle = shark / whale
        bear[cat] = float(eagle) if np.isfinite(eagle) else np.nan
    return _make_factor_series(bear, date, universe=universe, name='factor281')

def factor282(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    eagle = whale - 1
    hawk = pd.PeriodIndex([whale, whale - 1, whale - 2, whale - 3], freq='Q-DEC')
    shark = pd.PeriodIndex([eagle, whale], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=lion, fields=[bear.term_052], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    bear = _prep_hist(fox)
    if bear.empty or 'term_052' not in bear.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor282')
    bear = bear[bear['q'].isin(hawk)]
    if bear.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor282')
    zebra = bear.pivot(index='q', columns='code', values='term_052').reindex(index=hawk, columns=lion)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = zebra.sum(axis=0, min_count=1).reindex(lion)
    otter = get_history_fundamentals(security=lion, fields=[fox.term_081], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    panda = _prep_hist(otter)
    if panda.empty or 'term_081' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor282')
    panda = panda[panda['q'].isin(shark)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor282')
    sparrow = panda.pivot(index='q', columns='code', values='term_081').reindex(index=shark, columns=lion)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    owl = sparrow.loc[whale] if whale in sparrow.index else pd.Series(np.nan, index=lion, dtype='float64')
    turtle = sparrow.loc[eagle] if eagle in sparrow.index else pd.Series(np.nan, index=lion, dtype='float64')
    dog = (owl + turtle) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = giraffe / dog
    rabbit = ~np.isfinite(dolphin) | ~np.isfinite(giraffe) | ~np.isfinite(dog) | (dog <= 0) | (dog == 0)
    dolphin = dolphin.where(~rabbit, np.nan).reindex(lion)
    wolf = {tiger: float(dolphin.get(tiger)) if np.isfinite(dolphin.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(wolf, koala, universe=universe, name='factor282')

def factor283(universe, date):
    _set_asof_date(date)
    koala = query(fox.code, fox.term_081, fox.total_owner_equities).filter(fox.code.in_(universe))
    panda = get_fundamentals(koala, date=date)
    if panda is None or panda.empty:
        lion = {cat: np.nan for cat in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor283')
    panda = panda.set_index('code')
    for dog in ['term_081', 'total_owner_equities']:
        if dog not in panda.columns:
            panda[dog] = np.nan
    lion = {}
    for cat in universe:
        otter = panda['term_081'].get(cat, np.nan)
        tiger = panda['total_owner_equities'].get(cat, np.nan)
        if np.isnan(otter) or np.isnan(tiger) or tiger == 0:
            fox = np.nan
        else:
            fox = otter / tiger
        lion[cat] = float(fox) if np.isfinite(fox) else np.nan
    return _make_factor_series(lion, date, universe=universe, name='factor283')

def factor284(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    hawk = eagle - 1
    sparrow = pd.PeriodIndex([eagle, eagle - 1, eagle - 2, eagle - 3], freq='Q-DEC')
    shark = pd.PeriodIndex([hawk, eagle], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=lion, fields=[bear.term_066], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    zebra = _prep_hist(fox)
    if zebra.empty or 'term_066' not in zebra.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor284')
    zebra = zebra[zebra['q'].isin(sparrow)]
    if zebra.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor284')
    owl = zebra.pivot(index='q', columns='code', values='term_066').reindex(index=sparrow, columns=lion)
    owl = owl.apply(pd.to_numeric, errors='coerce').astype(float)
    turtle = owl.sum(axis=0, min_count=1).reindex(lion)
    otter = get_history_fundamentals(security=lion, fields=[fox.total_owner_equities], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(otter)
    if panda.empty or 'total_owner_equities' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor284')
    panda = panda[panda['q'].isin(shark)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor284')
    wolf = panda.pivot(index='q', columns='code', values='total_owner_equities').reindex(index=shark, columns=lion)
    wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float)
    bear = wolf.loc[eagle] if eagle in wolf.index else pd.Series(np.nan, index=lion, dtype='float64')
    rabbit = wolf.loc[hawk] if hawk in wolf.index else pd.Series(np.nan, index=lion, dtype='float64')
    dog = (bear + rabbit) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        whale = turtle / dog
    dolphin = ~np.isfinite(whale) | ~np.isfinite(turtle) | ~np.isfinite(dog) | (dog == 0)
    whale = whale.where(~dolphin, np.nan).reindex(lion)
    giraffe = {tiger: float(whale.get(tiger)) if np.isfinite(whale.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(giraffe, koala, universe=universe, name='factor284')

def factor285(universe, date):
    dog = pd.to_datetime(date)
    whale = _norm_universe(universe)
    dolphin = query(giraffe.code, giraffe.pe_ratio).filter(giraffe.code.in_(whale))
    panda = get_fundamentals(dolphin, date=dog)
    if panda is None or len(panda) == 0:
        giraffe = pd.Series(np.nan, index=whale)
    else:
        panda = panda.copy()
        panda['code'] = panda['code'].astype(str)
        panda = panda.set_index('code')
        giraffe = pd.to_numeric(panda.get('pe_ratio', np.nan), errors='coerce').reindex(whale)
    wolf = get_factor_values(whale, factors=['np_parent_company_owners_ttm'], end_date=dog, count=1)
    bear = get_factor_values(whale, factors=['np_parent_company_owners_ttm'], end_date=dog - dt.timedelta(days=365), count=1)
    koala = _safe_factor_last_row(wolf, 'np_parent_company_owners_ttm', whale)
    fox = _safe_factor_last_row(bear, 'np_parent_company_owners_ttm', whale)
    rabbit = {}
    for cat in whale:
        shark = np.nan
        try:
            zebra = giraffe.loc[cat]
            tiger = koala.loc[cat]
            lion = fox.loc[cat]
            if pd.notna(zebra) and pd.notna(tiger) and pd.notna(lion) and (lion != 0):
                otter = (tiger - lion) / abs(lion)
                if np.isfinite(otter) and otter != 0:
                    shark = zebra / otter
        except Exception:
            shark = np.nan
        rabbit[cat] = float(shark) if np.isfinite(shark) else np.nan
    return _make_factor_series(rabbit, dog, universe=universe, name='factor285')

def factor286(universe, date):
    _set_asof_date(date)
    tiger = pd.to_datetime(date)
    giraffe = list(universe)
    bear = query(fox.code, fox.term_007).filter(fox.code.in_(giraffe))
    koala = get_fundamentals(bear, date=tiger)
    if koala is None or koala.empty:
        panda = pd.Series(np.nan, index=giraffe, dtype='float64')
    else:
        panda = koala.set_index('code')['term_007'].astype(float).reindex(giraffe)
    rabbit = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(giraffe))
    otter = get_fundamentals(rabbit, date=tiger)
    if otter is None or otter.empty:
        dog = pd.Series(np.nan, index=giraffe, dtype='float64')
    else:
        dog = otter.set_index('code')['term_008'].astype(float).reindex(giraffe)
    lion = (dog * 10000.0).where(np.isfinite(dog) & (dog > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = panda / lion
    wolf = wolf.where(np.isfinite(wolf) & np.isfinite(panda) & np.isfinite(lion), np.nan)
    fox = {cat: float(wolf.loc[cat]) if np.isfinite(wolf.loc[cat]) else np.nan for cat in giraffe}
    return _make_factor_series(fox, date, universe=universe, name='factor286')

def factor287(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    koala = list(universe)
    shark = pd.Period(cat, freq='Q-DEC') - 1
    eagle = shark - 1
    whale = pd.PeriodIndex([eagle, shark], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=koala, fields=[fox.term_081, fox.total_owner_equities], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    tiger = _prep_hist(fox)
    if tiger.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor287')
    tiger = tiger[tiger['q'].isin(whale)]
    if tiger.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor287')
    hawk = tiger.pivot(index='q', columns='code', values='term_081').reindex(index=whale, columns=koala)
    wolf = tiger.pivot(index='q', columns='code', values='total_owner_equities').reindex(index=whale, columns=koala)
    hawk = hawk.apply(pd.to_numeric, errors='coerce').astype(float)
    wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = hawk.loc[shark] if shark in hawk.index else pd.Series(np.nan, index=koala, dtype='float64')
    owl = hawk.loc[eagle] if eagle in hawk.index else pd.Series(np.nan, index=koala, dtype='float64')
    bear = wolf.loc[shark] if shark in wolf.index else pd.Series(np.nan, index=koala, dtype='float64')
    rabbit = wolf.loc[eagle] if eagle in wolf.index else pd.Series(np.nan, index=koala, dtype='float64')
    panda = (sparrow + owl) / 2.0
    dog = (bear + rabbit) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = panda / dog
    zebra = ~np.isfinite(dolphin) | ~np.isfinite(panda) | ~np.isfinite(dog) | (dog == 0)
    dolphin = dolphin.where(~zebra, np.nan).reindex(koala)
    giraffe = {lion: float(dolphin.get(lion)) if np.isfinite(dolphin.get(lion, np.nan)) else np.nan for lion in koala}
    return _make_factor_series(giraffe, otter, universe=universe, name='factor287')

def factor288(universe, date):
    _set_asof_date(date)
    lion = query(fox.code, fox.term_082, fox.term_081).filter(fox.code.in_(universe))
    panda = get_fundamentals(lion, date=date)
    if panda is None or panda.empty:
        tiger = {dog: np.nan for dog in universe}
        return _make_factor_series(tiger, date, universe=universe, name='factor288')
    panda = panda.set_index('code')
    tiger = {}
    for dog in universe:
        cat = panda['term_082'].get(dog, np.nan)
        koala = panda['term_081'].get(dog, np.nan)
        if np.isnan(cat) or np.isnan(koala) or koala == 0:
            otter = np.nan
        else:
            otter = cat / koala
        tiger[dog] = float(otter) if np.isfinite(otter) else np.nan
    return _make_factor_series(tiger, date, universe=universe, name='factor288')

def factor289(universe, date, months=12):
    _set_asof_date(date)
    panda = get_trade_days(end_date=date, count=months * 21 + 1)
    if len(panda) < 12 * 21:
        lion = {dog: np.nan for dog in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor289')
    whale = panda[0]
    shark = pd.to_datetime(whale).strftime('%Y-%m-%d')
    tiger = get_price(universe, start_date=shark, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if tiger is None or tiger.empty:
        lion = {dog: np.nan for dog in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor289')
    cat = tiger.pivot(index='time', columns='code', values='close').sort_index()
    otter = cat.pct_change().dropna(how='all')
    bear = 6 * 21
    koala = 6 * 21
    if otter.shape[0] < bear + koala:
        lion = {dog: np.nan for dog in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor289')
    wolf = otter.iloc[-bear:]
    fox = otter.iloc[-(bear + koala):-bear]
    lion = {}
    for dog in universe:
        if dog not in otter.columns:
            lion[dog] = np.nan
            continue
        dolphin = wolf[dog].dropna()
        zebra = fox[dog].dropna()
        if dolphin.empty or zebra.empty:
            eagle = np.nan
        else:
            giraffe = float(np.prod(1.0 + dolphin.values) - 1.0)
            rabbit = float(np.prod(1.0 + zebra.values) - 1.0)
            eagle = giraffe - rabbit
        lion[dog] = float(eagle) if np.isfinite(eagle) else np.nan
    return _make_factor_series(lion, date, universe=universe, name='factor289')

def factor290(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor290')

def factor291(universe, date):
    _set_asof_date(date)
    rabbit = _to_date(date)
    dog = pd.Timestamp(rabbit)
    bear = list(universe)
    salmon = pd.Period(dog, freq='Q-DEC') - 1
    lizard = salmon - 4
    frog = pd.PeriodIndex([lizard, salmon], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    giraffe = get_history_fundamentals(security=bear, fields=[fox.inventories, fox.term_081], watch_date=dog, count=40, interval='1q', stat_by_year=False)
    panda = _prep_hist(giraffe)
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in bear}, rabbit, universe=universe, name='factor291')
    panda = panda[panda['q'].isin(frog)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in bear}, rabbit, universe=universe, name='factor291')
    hawk = panda.pivot(index='q', columns='code', values='inventories').reindex(index=frog, columns=bear)
    tuna = panda.pivot(index='q', columns='code', values='term_081').reindex(index=frog, columns=bear)
    hawk = hawk.apply(pd.to_numeric, errors='coerce').astype(float)
    tuna = tuna.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = hawk.loc[salmon] if salmon in hawk.index else pd.Series(np.nan, index=bear, dtype='float64')
    eagle = hawk.loc[lizard] if lizard in hawk.index else pd.Series(np.nan, index=bear, dtype='float64')
    lemur = tuna.loc[salmon] if salmon in tuna.index else pd.Series(np.nan, index=bear, dtype='float64')
    alpaca = lemur.where(np.isfinite(lemur) & (lemur != 0), np.nan)
    zebra = get_history_fundamentals(security=bear, fields=[wolf.term_028], watch_date=dog, count=40, interval='1q', stat_by_year=False)
    wolf = _prep_hist(zebra)
    if wolf.empty:
        return _make_factor_series({tiger: np.nan for tiger in bear}, rabbit, universe=universe, name='factor291')
    wolf = wolf[wolf['q'].isin(frog)]
    if wolf.empty:
        return _make_factor_series({tiger: np.nan for tiger in bear}, rabbit, universe=universe, name='factor291')
    otter = wolf.pivot(index='q', columns='code', values='term_028').reindex(index=frog, columns=bear)
    otter = otter.apply(pd.to_numeric, errors='coerce').astype(float)
    fox = otter.loc[salmon] if salmon in otter.index else pd.Series(np.nan, index=bear, dtype='float64')
    lion = otter.loc[lizard] if lizard in otter.index else pd.Series(np.nan, index=bear, dtype='float64')
    koala = lion.where(np.isfinite(lion) & (lion != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = fox / koala
        dolphin = eagle * shark
        cat = sparrow - dolphin
        turtle = -cat / alpaca
    turtle = turtle.replace([np.inf, -np.inf], np.nan)
    owl = ~np.isfinite(turtle) | ~np.isfinite(sparrow) | ~np.isfinite(eagle) | ~np.isfinite(shark) | ~np.isfinite(alpaca)
    turtle = turtle.where(~owl, np.nan).reindex(bear)
    whale = {tiger: float(turtle.get(tiger)) if np.isfinite(turtle.get(tiger, np.nan)) else np.nan for tiger in bear}
    return _make_factor_series(whale, rabbit, universe=universe, name='factor291')

def factor292(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    dolphin = pd.Period(cat, freq='Q-DEC') - 1
    whale = dolphin - 1
    rabbit = pd.PeriodIndex([whale, dolphin], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[fox.total_owner_equities], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor292')
    koala = koala.copy()
    if 'pubDate' in koala.columns:
        zebra = pd.to_datetime(koala['pubDate'], errors='coerce')
        koala = koala[zebra.notna() & (zebra <= cat)]
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty or 'total_owner_equities' not in koala.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor292')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(rabbit)]
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor292')
    otter = koala.pivot(index='q', columns='code', values='total_owner_equities').reindex(index=rabbit, columns=panda)
    otter = otter.apply(pd.to_numeric, errors='coerce').astype(float)
    fox = otter.loc[dolphin]
    wolf = otter.loc[whale]
    lion = wolf.abs()
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = (fox - wolf) / lion
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    giraffe = giraffe.where(np.isfinite(lion) & (lion > 0), np.nan)
    bear = {dog: float(giraffe.get(dog, np.nan)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(bear, tiger, universe=universe, name='factor292')

def factor293(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor293')

def factor294(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    dolphin = pd.Period(cat, freq='Q-DEC') - 1
    zebra = dolphin - 4
    bear = pd.PeriodIndex([zebra, dolphin], freq='Q-DEC')
    fox = get_history_fundamentals(security=panda, fields=[fox.term_084], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if fox is None or fox.empty or 'code' not in fox.columns or ('statDate' not in fox.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor294')
    fox = fox.copy()
    if 'pubDate' in fox.columns:
        giraffe = pd.to_datetime(fox['pubDate'], errors='coerce')
        fox = fox[giraffe.notna() & (giraffe <= cat)]
    fox['code'] = fox['code'].astype(str)
    fox['statDate'] = pd.to_datetime(fox['statDate'], errors='coerce')
    fox = fox.dropna(subset=['code', 'statDate'])
    if fox.empty or 'term_084' not in fox.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor294')
    fox['q'] = fox['statDate'].dt.to_period('Q-DEC')
    fox = fox[fox['q'].isin(bear)]
    fox = fox.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if fox.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor294')
    whale = fox.pivot(index='q', columns='code', values='term_084').reindex(index=bear, columns=panda)
    whale = whale.apply(pd.to_numeric, errors='coerce').astype(float)
    koala = whale.loc[dolphin]
    lion = whale.loc[zebra]
    otter = lion.abs()
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = (koala - lion) / otter
    rabbit = rabbit.replace([np.inf, -np.inf], np.nan)
    rabbit = rabbit.where(np.isfinite(otter) & (otter > 0), np.nan)
    wolf = {dog: float(rabbit.get(dog, np.nan)) if np.isfinite(rabbit.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(wolf, tiger, universe=universe, name='factor294')

def factor295(universe, date):
    _set_asof_date(date)
    koala = list(universe)
    bear = pd.to_datetime(date)
    eagle = query(giraffe.code, giraffe.term_013, giraffe.circulating_cap).filter(giraffe.code.in_(koala))
    try:
        giraffe = get_fundamentals(eagle, date=_r3_safe_date(date))
    except Exception:
        giraffe = None
    if giraffe is None or giraffe.empty:
        giraffe = pd.DataFrame(columns=['code', 'term_013', 'circulating_cap'])
    giraffe = giraffe.set_index('code')
    whale = pd.to_numeric(giraffe.get('term_013', pd.Series(index=koala, dtype=float)), errors='coerce')
    dog = pd.to_numeric(giraffe.get('circulating_cap', pd.Series(index=koala, dtype=float)), errors='coerce')
    fox = bear.date()
    wolf = fox + dt.timedelta(days=1)
    rabbit = _r3_get_price_panel(koala, start_date=fox, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    panda = pd.Series(np.nan, index=koala, dtype='float64')
    if rabbit is not None and (not rabbit.empty) and ('close' in rabbit.columns):
        rabbit['date'] = rabbit['time'].dt.date
        rabbit = rabbit[rabbit['date'] == fox]
        if not rabbit.empty:
            tiger = rabbit.pivot(index='time', columns='code', values='close')
            panda = pd.to_numeric(tiger.ffill().iloc[-1], errors='coerce').reindex(koala)
    zebra = {}
    for lion in koala:
        dolphin = float(whale.get(lion, np.nan))
        if not np.isfinite(dolphin) or dolphin <= 0:
            cat = float(panda.get(lion, np.nan))
            otter = float(dog.get(lion, np.nan))
            if not np.isfinite(cat) or not np.isfinite(otter) or otter <= 0:
                zebra[lion] = np.nan
                continue
            shark = cat * otter * 10000.0
            zebra[lion] = float(np.log(shark)) if shark > 0 else np.nan
        else:
            zebra[lion] = float(np.log(dolphin)) if dolphin > 0 else np.nan
    return _make_factor_series(zebra, date, universe=universe, name='factor295')

def factor296(universe, date, N=20):
    _set_asof_date(date)
    N = int(N)
    if N <= 0:
        return _make_factor_series({}, date, universe=universe, name='factor296')
    giraffe = pd.to_datetime(date)
    zebra = get_trade_days(end_date=giraffe, count=N + 1)
    if len(zebra) < N + 1:
        return _make_factor_series({}, date, universe=universe, name='factor296')
    frog = zebra[0]
    salmon = pd.to_datetime(frog).strftime('%Y-%m-%d')
    dolphin = get_price(universe, start_date=salmon, end_date=giraffe, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if dolphin is None or dolphin.empty:
        return _make_factor_series({}, date, universe=universe, name='factor296')
    hawk = dolphin.pivot(index='time', columns='code', values='high').sort_index()
    turtle = dolphin.pivot(index='time', columns='code', values='low').sort_index()
    fox = dolphin.pivot(index='time', columns='code', values='close').sort_index()
    sparrow = hawk.iloc[-(N + 1):]
    lizard = turtle.iloc[-(N + 1):]
    wolf = fox.iloc[-(N + 1):]
    dog = sparrow.values
    tiger = lizard.values
    cat = wolf.values
    otter = (dog + tiger + cat) / 3.0
    eagle = {}
    rabbit = list(sparrow.columns)
    for owl, bear in enumerate(rabbit):
        koala = otter[:, owl]
        panda = dog[:, owl]
        lion = tiger[:, owl]
        if len(koala) < N + 1:
            eagle[bear] = np.nan
            continue
        tuna = np.maximum(0.0, panda[1:] - koala[:-1])
        whale = np.maximum(0.0, koala[:-1] - lion[1:])
        alpaca = float(np.nansum(tuna))
        shark = float(np.nansum(whale))
        if shark == 0 or np.isnan(shark):
            lemur = np.nan
        else:
            lemur = alpaca / shark * 100.0
        eagle[bear] = float(lemur) if np.isfinite(lemur) else np.nan
    return _make_factor_series(eagle, date, universe=universe, name='factor296')

def factor297(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    cat = pd.Timestamp(wolf)
    koala = list(universe)
    owl = pd.Period(cat, freq='Q-DEC') - 1
    sparrow = owl - 4
    dolphin = pd.PeriodIndex([sparrow, owl], freq='Q-DEC')

    def _q_end_trade_day(qp: pd.Period):
        cat = qp.end_time.date()
        dog = get_trade_days(end_date=cat, count=1)
        if not dog:
            return None
        return pd.to_datetime(dog[0]).date()
    fox = _q_end_trade_day(owl)
    otter = _q_end_trade_day(sparrow)
    if fox is None or otter is None:
        return _make_factor_series({panda: np.nan for panda in koala}, wolf, universe=universe, name='factor297')
    giraffe = get_history_fundamentals(security=koala, fields=[bear.term_052], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if giraffe is None or giraffe.empty or 'code' not in giraffe.columns or ('statDate' not in giraffe.columns):
        return _make_factor_series({panda: np.nan for panda in koala}, wolf, universe=universe, name='factor297')
    giraffe = giraffe.copy()
    if 'pubDate' in giraffe.columns:
        hawk = pd.to_datetime(giraffe['pubDate'], errors='coerce')
        giraffe = giraffe[hawk.notna() & (hawk <= cat)]
    giraffe['code'] = giraffe['code'].astype(str)
    giraffe['statDate'] = pd.to_datetime(giraffe['statDate'], errors='coerce')
    giraffe = giraffe.dropna(subset=['code', 'statDate'])
    if giraffe.empty or 'term_052' not in giraffe.columns:
        return _make_factor_series({panda: np.nan for panda in koala}, wolf, universe=universe, name='factor297')
    giraffe['q'] = giraffe['statDate'].dt.to_period('Q-DEC')
    giraffe = giraffe[giraffe['q'].isin(dolphin)]
    giraffe = giraffe.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if giraffe.empty:
        return _make_factor_series({panda: np.nan for panda in koala}, wolf, universe=universe, name='factor297')
    whale = giraffe.pivot(index='q', columns='code', values='term_052').reindex(index=dolphin, columns=koala)
    whale = whale.apply(pd.to_numeric, errors='coerce').astype(float)
    shark = whale.loc[owl]
    turtle = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(koala))
    rabbit = get_fundamentals(turtle, date=pd.Timestamp(fox).strftime('%Y-%m-%d'))
    bear = get_fundamentals(turtle, date=pd.Timestamp(otter).strftime('%Y-%m-%d'))
    if rabbit is None or rabbit.empty or 'code' not in rabbit.columns:
        lion = pd.Series(np.nan, index=koala, dtype='float64')
    else:
        rabbit = rabbit.copy()
        rabbit['code'] = rabbit['code'].astype(str)
        lion = pd.to_numeric(rabbit.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(koala)
    if bear is None or bear.empty or 'code' not in bear.columns:
        tiger = pd.Series(np.nan, index=koala, dtype='float64')
    else:
        bear = bear.copy()
        bear['code'] = bear['code'].astype(str)
        tiger = pd.to_numeric(bear.set_index('code').get('term_008', np.nan), errors='coerce').astype(float).reindex(koala)
    frog = lion * 10000.0
    lizard = tiger * 10000.0
    dog = (frog + lizard) / 2.0
    dog = dog.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = shark / dog
    eagle = eagle.replace([np.inf, -np.inf], np.nan)
    eagle = eagle.where(np.isfinite(dog) & (dog > 0) & np.isfinite(shark), np.nan)
    zebra = {panda: float(eagle.get(panda, np.nan)) if np.isfinite(eagle.get(panda, np.nan)) else np.nan for panda in koala}
    return _make_factor_series(zebra, wolf, universe=universe, name='factor297')

def factor298(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    dog = list(universe)
    zebra = pd.Period(panda, freq='Q-DEC') - 1
    wolf = zebra - 20
    giraffe = zebra.end_time.date()
    rabbit = wolf.end_time.date()
    sparrow = get_trade_days(end_date=giraffe, count=1)
    hawk = get_trade_days(end_date=rabbit, count=1)
    if not sparrow or not hawk:
        return _make_factor_series({cat: np.nan for cat in dog}, panda, universe=universe, name='factor298')
    eagle = pd.to_datetime(sparrow[0]).date()
    shark = pd.to_datetime(hawk[0]).date()
    bear = query(fox.code, fox.term_084).filter(fox.code.in_(dog))
    koala = get_fundamentals(bear, date=eagle)
    lion = get_fundamentals(bear, date=shark)
    if koala is None or koala.empty or 'code' not in koala.columns:
        whale = pd.Series(np.nan, index=dog, dtype='float64')
    else:
        owl = koala.copy()
        owl['code'] = owl['code'].astype(str)
        whale = pd.to_numeric(owl.set_index('code').get('term_084', np.nan), errors='coerce').astype(float).reindex(dog)
    if lion is None or lion.empty or 'code' not in lion.columns:
        dolphin = pd.Series(np.nan, index=dog, dtype='float64')
    else:
        owl = lion.copy()
        owl['code'] = owl['code'].astype(str)
        dolphin = pd.to_numeric(owl.set_index('code').get('term_084', np.nan), errors='coerce').astype(float).reindex(dog)
    tiger = dolphin.abs()
    tiger = tiger.where(np.isfinite(tiger) & (tiger > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        fox = (whale - dolphin) / tiger
    fox = fox.replace([np.inf, -np.inf], np.nan)
    fox = fox.where(np.isfinite(fox), np.nan).reindex(dog)
    otter = {cat: float(fox.get(cat, np.nan)) if np.isfinite(fox.get(cat, np.nan)) else np.nan for cat in dog}
    return _make_factor_series(otter, panda, universe=universe, name='factor298')

def factor299(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor299')

def _rnoa_q_single(universe, d_):
    panda = pd.to_datetime(d_)
    hawk = list(universe)
    bear = pd.Period(panda, freq='Q-DEC')
    rabbit, giraffe = (bear, bear - 1)
    shark = f'{rabbit.year}q{rabbit.quarter}'
    eagle = f'{giraffe.year}q{giraffe.quarter}'
    dolphin = query(bear.code, bear.term_063).filter(bear.code.in_(hawk))
    koala = get_fundamentals(dolphin, statDate=shark)
    if koala is None or koala.empty:
        koala = pd.DataFrame(columns=['code', 'term_063'])
    koala = koala.set_index('code')
    dog = ['code', 'term_081', 'term_012', 'term_092', 'term_005', 'term_041', 'term_020', 'term_031', 'hold_to_maturity_investments', 'term_077', 'term_044', 'term_006', 'term_093']
    zebra = query(fox.code, fox.term_081, fox.term_012, fox.term_092, fox.term_005, fox.term_041, fox.term_020, fox.term_031, fox.hold_to_maturity_investments, fox.term_077, fox.term_044, fox.term_006, fox.term_093).filter(fox.code.in_(hawk))
    tiger = get_fundamentals(zebra, statDate=shark)
    lion = get_fundamentals(zebra, statDate=eagle)
    if tiger is None or tiger.empty:
        tiger = pd.DataFrame(columns=dog)
    if lion is None or lion.empty:
        lion = pd.DataFrame(columns=dog)
    tiger = tiger.set_index('code')
    lion = lion.set_index('code')

    def _noa_one(df0: pd.DataFrame) -> pd.Series:
        lion = df0.get('term_081', pd.Series(dtype='float64')).astype(float).reindex(universe_list)
        if lion.empty:
            return pd.Series(np.nan, index=universe_list, dtype='float64')

        def get0(col):
            cat = df0.get(col, pd.Series(dtype='float64')).astype(float).reindex(universe_list)
            return cat.fillna(0.0)
        cat = get0('term_012') + get0('term_092') + get0('term_005') + get0('term_041') + get0('term_020') + get0('term_031') + get0('hold_to_maturity_investments')
        tiger = lion - cat
        dog = get0('term_077') + get0('term_044') + get0('term_006') + get0('term_093')
        panda = tiger - dog
        panda = panda.where(np.isfinite(panda), np.nan)
        return panda
    otter = _noa_one(tiger)
    fox = _noa_one(lion)
    cat = (otter + fox) / 2.0
    cat = cat.where(np.isfinite(cat) & (cat != 0), np.nan)
    wolf = koala.get('term_063', pd.Series(dtype='float64')).astype(float).reindex(hawk)
    wolf = wolf.where(np.isfinite(wolf), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        whale = wolf / cat
    whale = whale.where(np.isfinite(whale) & np.isfinite(wolf) & np.isfinite(cat), np.nan)
    return whale

def factor300(universe, date, N_q=6):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    wolf = list(universe)
    N_q = int(N_q)
    koala = get_history_fundamentals(security=wolf, fields=[bear.term_063], watch_date=panda, count=N_q, interval='1q', stat_by_year=False)
    lion = get_history_fundamentals(security=wolf, fields=[fox.term_081, fox.term_012, fox.term_092, fox.term_005, fox.term_001, fox.term_041, fox.term_020, fox.term_031, fox.hold_to_maturity_investments, fox.term_077, fox.term_044, fox.term_006, fox.term_093], watch_date=panda, count=N_q, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or lion is None or lion.empty:
        return _make_factor_series({dog: np.nan for dog in wolf}, panda, universe=universe, name='factor300')
    koala = koala.copy()
    lion = lion.copy()
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    lion['statDate'] = pd.to_datetime(lion['statDate'])
    tiger = pd.merge(koala, lion, on=['code', 'statDate'], how='inner')
    tiger = tiger.sort_values(['code', 'statDate'])

    def _calc(sub):
        sub = sub.drop_duplicates('statDate').tail(N_q)
        if sub.shape[0] < N_q:
            return np.nan
        hawk = sub['term_063'].astype(float).values
        alpaca = sub['term_081'].astype(float).values
        rabbit = sub['term_012'].astype(float).values
        lemur = sub['term_092'].astype(float).values
        wolf = sub['term_005'].astype(float).values
        koala = sub['term_001'].astype(float).values
        whale = sub['term_041'].astype(float).values
        giraffe = sub['term_020'].astype(float).values
        zebra = sub['term_031'].astype(float).values
        dolphin = sub['hold_to_maturity_investments'].astype(float).values
        tuna = sub['term_077'].astype(float).values
        eagle = sub['term_044'].astype(float).values
        bear = sub['term_006'].astype(float).values
        badger = sub['term_093'].astype(float).values
        turtle = alpaca - np.nan_to_num(rabbit, nan=0.0) - np.nan_to_num(lemur, nan=0.0) - np.nan_to_num(wolf, nan=0.0) - np.nan_to_num(koala, nan=0.0) - np.nan_to_num(whale, nan=0.0) - np.nan_to_num(giraffe, nan=0.0) - np.nan_to_num(zebra, nan=0.0) - np.nan_to_num(dolphin, nan=0.0)
        shark = np.nan_to_num(tuna, nan=0.0) + np.nan_to_num(eagle, nan=0.0) + np.nan_to_num(bear, nan=0.0) + np.nan_to_num(badger, nan=0.0)
        cat = turtle - shark
        if cat.size < N_q or hawk.size < N_q:
            return np.nan
        dog = cat[-1]
        lion = cat[-2]
        otter = 0.5 * (dog + lion)
        panda = cat[-5]
        tiger = cat[-6]
        fox = 0.5 * (panda + tiger)
        sparrow = hawk[-1]
        owl = hawk[-5]
        if not np.isfinite(sparrow) or not np.isfinite(owl) or (not np.isfinite(otter)) or (not np.isfinite(fox)):
            return np.nan
        if otter == 0 or fox == 0:
            return np.nan
        frog = sparrow / otter
        salmon = owl / fox
        if not np.isfinite(frog) or not np.isfinite(salmon):
            return np.nan
        lizard = frog - salmon
        return float(lizard) if np.isfinite(lizard) else np.nan
    fox = tiger.groupby('code', sort=False).apply(_calc).reindex(wolf)
    otter = {cat: float(fox.loc[cat]) if np.isfinite(fox.loc[cat]) else np.nan for cat in wolf}
    return _make_factor_series(otter, panda, universe=universe, name='factor300')

def factor301(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    bear = _nearest_td_le(koala)
    rabbit = _nearest_td_le((cat - DateOffset(years=1)).date())
    if bear is None or rabbit is None:
        return _make_factor_series({dog: np.nan for dog in lion}, koala, universe=universe, name='factor301')
    wolf = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(lion))

    def _cap_on(td_):
        dog = get_fundamentals(q_val, date=pd.Timestamp(td_).strftime('%Y-%m-%d'))
        if dog is None or dog.empty or 'code' not in dog.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        dog = dog.copy()
        dog['code'] = dog['code'].astype(str)
        cat = pd.to_numeric(dog.set_index('code').get('term_008', np.nan), errors='coerce').astype(float)
        return cat.reindex(codes)
    panda = _cap_on(bear)
    tiger = _cap_on(rabbit)
    panda = panda.where(np.isfinite(panda) & (panda > 0), np.nan)
    tiger = tiger.where(np.isfinite(tiger) & (tiger > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        fox = np.log(panda / tiger)
    fox = fox.replace([np.inf, -np.inf], np.nan)
    giraffe = np.isfinite(fox) & np.isfinite(panda) & np.isfinite(tiger)
    fox = fox.where(giraffe, np.nan).reindex(lion)
    otter = {dog: float(fox.get(dog)) if np.isfinite(fox.get(dog, np.nan)) else np.nan for dog in lion}
    return _make_factor_series(otter, koala, universe=universe, name='factor301')

def factor302(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor302')

def factor303(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor303')

def factor304(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    dolphin = whale - 4
    fox = pd.PeriodIndex([dolphin, whale], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[bear.term_090], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor304')
    koala = koala.copy()
    if 'pubDate' in koala.columns:
        zebra = pd.to_datetime(koala['pubDate'], errors='coerce')
        koala = koala[zebra.notna() & (zebra <= cat)]
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty or 'term_090' not in koala.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor304')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(fox)]
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor304')
    bear = koala.pivot(index='q', columns='code', values='term_090').reindex(index=fox, columns=panda)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = bear.loc[whale]
    rabbit = bear.loc[dolphin]
    lion = rabbit.abs()
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = (giraffe - rabbit) / lion
    wolf = wolf.replace([np.inf, -np.inf], np.nan)
    wolf = wolf.where(np.isfinite(lion) & (lion > 0), np.nan)
    otter = {dog: float(wolf.get(dog, np.nan)) if np.isfinite(wolf.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(otter, tiger, universe=universe, name='factor304')

def factor305(universe, date, N=20):
    _set_asof_date(date)
    N = int(N)
    if N <= 1:
        return _make_factor_series({panda: np.nan for panda in universe}, date, universe=universe, name='factor305')
    tiger = _to_date(date)
    zebra = list(universe)
    lion = get_trade_days(end_date=tiger, count=2 * N + 6)
    if len(lion) < 2 * N + 2:
        return _make_factor_series({panda: np.nan for panda in zebra}, date, universe=universe, name='factor305')
    rabbit = pd.to_datetime(lion[0]).strftime('%Y-%m-%d')
    otter = pd.to_datetime(tiger).strftime('%Y-%m-%d')
    koala = get_price(zebra, start_date=rabbit, end_date=otter, frequency='daily', fields=['close'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({panda: np.nan for panda in zebra}, date, universe=universe, name='factor305')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index()
    if 'code' not in koala.columns:
        return _make_factor_series({panda: np.nan for panda in zebra}, date, universe=universe, name='factor305')
    koala['time'] = pd.to_datetime(koala['time']).dt.normalize()
    dog = koala.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=zebra).astype(float)
    if N % 2 == 0:
        dolphin = int(N / 2) + 1
        whale = int(N / 2)
    else:
        dolphin = whale = int((N + 1) / 2)
    bear = dog.rolling(dolphin, min_periods=dolphin).mean()
    giraffe = bear.rolling(whale, min_periods=whale).mean()
    wolf = giraffe.iloc[-1]
    wolf = wolf.where(np.isfinite(wolf), np.nan)
    fox = {cat: float(wolf.loc[cat]) if np.isfinite(wolf.loc[cat]) else np.nan for cat in zebra}
    return _make_factor_series(fox, date, universe=universe, name='factor305')

def factor306(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    giraffe = list(universe)
    bear = None
    wolf = None
    try:
        otter = get_factor_values(giraffe, factors=['term_051'], end_date=dog, count=1)
        lion = otter.get('term_051', None) if otter else None
        if lion is not None and (not lion.empty):
            bear = lion.iloc[-1].astype(float).reindex(giraffe)
    except Exception:
        bear = None
    panda = (pd.to_datetime(dog) - DateOffset(years=1)).date()
    try:
        koala = get_factor_values(giraffe, factors=['term_051'], end_date=panda, count=1)
        tiger = koala.get('term_051', None) if koala else None
        if tiger is not None and (not tiger.empty):
            wolf = tiger.iloc[-1].astype(float).reindex(giraffe)
    except Exception:
        wolf = None
    if bear is None or wolf is None:

        def _ocf_ttm_by_quarters(d_eval):
            tiger = pd.Period(pd.to_datetime(d_eval), freq='Q-DEC')
            wolf = [f'{(tiger - panda).year}q{(tiger - panda).quarter}' for panda in range(0, 4)]
            lion = query(wolf.code, wolf.term_049).filter(wolf.code.in_(universe_list))
            koala = pd.Series(0.0, index=universe_list, dtype='float64')
            cat = pd.Series(False, index=universe_list)
            for fox in wolf:
                dog = get_fundamentals(lion, statDate=fox)
                if dog is None or dog.empty:
                    continue
                otter = dog.set_index('code')['term_049'].astype(float).reindex(universe_list)
                cat |= otter.notna()
                koala += otter.fillna(0.0)
            return koala.where(cat, np.nan)
        if bear is None:
            bear = _ocf_ttm_by_quarters(dog)
        if wolf is None:
            wolf = _ocf_ttm_by_quarters(panda)
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = (bear - wolf) / np.abs(wolf)
    rabbit = rabbit.where(np.isfinite(rabbit) & np.isfinite(bear) & np.isfinite(wolf) & (wolf != 0), np.nan)
    fox = {cat: float(rabbit.loc[cat]) if np.isfinite(rabbit.loc[cat]) else np.nan for cat in giraffe}
    return _make_factor_series(fox, date, universe=universe, name='factor306')

def factor307(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    eagle = list(universe)
    giraffe = pd.to_datetime(tiger).replace(day=1).date()
    rabbit = tiger
    lion = get_trade_days(start_date=giraffe, end_date=rabbit)
    if len(lion) == 0:
        return _make_factor_series({panda: np.nan for panda in eagle}, date, universe=universe, name='factor307')
    whale = pd.to_datetime(lion[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(rabbit).strftime('%Y-%m-%d')
    fox = get_price(eagle, start_date=whale, end_date=wolf, frequency='daily', fields=['volume'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({panda: np.nan for panda in eagle}, date, universe=universe, name='factor307')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index()
    if 'code' not in fox.columns:
        return _make_factor_series({panda: np.nan for panda in eagle}, date, universe=universe, name='factor307')
    fox['time'] = pd.to_datetime(fox['time']).dt.normalize()
    hawk = fox.pivot(index='time', columns='code', values='volume').sort_index().reindex(columns=eagle).astype(float)
    dolphin = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(eagle))
    otter = get_fundamentals(dolphin, date=rabbit)
    if otter is None or otter.empty:
        dog = pd.Series(np.nan, index=eagle, dtype='float64')
    else:
        dog = otter.set_index('code')['circulating_cap'].astype(float).reindex(eagle)
    koala = dog * 10000.0
    koala = koala.where(np.isfinite(koala) & (koala > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = hawk / koala
    zebra = shark.mean(axis=0, skipna=True)
    zebra = zebra.where(np.isfinite(zebra), np.nan)
    bear = {cat: float(zebra.loc[cat]) if np.isfinite(zebra.loc[cat]) else np.nan for cat in eagle}
    return _make_factor_series(bear, date, universe=universe, name='factor307')

def factor308(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    shark = pd.Period(cat, freq='Q-DEC') - 1
    hawk = shark - 1
    sparrow = pd.PeriodIndex([shark, shark - 1, shark - 2, shark - 3], freq='Q-DEC')
    eagle = pd.PeriodIndex([shark, hawk], freq='Q-DEC')
    fox = get_history_fundamentals(security=lion, fields=[bear.term_090, bear.term_021, bear.term_035], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    otter = get_history_fundamentals(security=lion, fields=[fox.term_081], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    if (fox is None or fox.empty) or (otter is None or otter.empty):
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor308')

    def _prep(df: pd.DataFrame):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    zebra = _prep(fox)
    panda = _prep(otter)
    if zebra is None or panda is None:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor308')
    salmon = zebra.pivot(index='q', columns='code', values='term_090').sort_index().reindex(columns=lion)
    giraffe = zebra.pivot(index='q', columns='code', values='term_021').sort_index().reindex(columns=lion)
    frog = zebra.pivot(index='q', columns='code', values='term_035').sort_index().reindex(columns=lion)
    salmon = salmon.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=sparrow)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=sparrow)
    frog = frog.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=sparrow)
    wolf = salmon + giraffe + frog
    bear = wolf.sum(axis=0, min_count=1)
    owl = panda.pivot(index='q', columns='code', values='term_081').sort_index().reindex(columns=lion)
    owl = owl.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=eagle)
    turtle = owl.loc[shark] if shark in owl.index else pd.Series(np.nan, index=lion, dtype='float64')
    lizard = owl.loc[hawk] if hawk in owl.index else pd.Series(np.nan, index=lion, dtype='float64')
    dog = (turtle + lizard) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        whale = bear / dog
    dolphin = ~np.isfinite(whale) | ~np.isfinite(bear) | ~np.isfinite(dog) | (dog <= 0) | (dog == 0)
    whale = whale.where(~dolphin, np.nan).reindex(lion)
    rabbit = {tiger: float(whale.get(tiger)) if np.isfinite(whale.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(rabbit, koala, universe=universe, name='factor308')

def factor309(universe, date):
    _set_asof_date(date)
    tiger = pd.to_datetime(date)
    zebra = list(universe)
    lion = get_history_fundamentals(security=zebra, fields=[bear.term_066], watch_date=tiger, count=12, interval='1q', stat_by_year=False)
    if lion is None or lion.empty:
        return _make_factor_series({panda: np.nan for panda in zebra}, date, universe=universe, name='factor309')
    lion = lion.copy()
    lion['statDate'] = pd.to_datetime(lion['statDate'])
    lion = lion.sort_values(['code', 'statDate'])
    koala = {}
    for panda, rabbit in lion.groupby('code', sort=False):
        rabbit = rabbit.drop_duplicates('statDate').tail(12)
        if rabbit.shape[0] < 12:
            koala[panda] = np.nan
            continue
        fox = rabbit['term_066'].astype(float).values
        giraffe = []
        for otter in range(0, 8):
            cat = fox[11 - otter]
            dog = fox[7 - otter]
            if not np.isfinite(cat) or not np.isfinite(dog):
                giraffe.append(np.nan)
            else:
                giraffe.append(cat - dog)
        giraffe = np.asarray(giraffe, dtype=float)
        wolf = giraffe[0]
        dolphin = giraffe[np.isfinite(giraffe)]
        if not np.isfinite(wolf) or dolphin.size < 2:
            koala[panda] = np.nan
            continue
        bear = float(np.std(dolphin, ddof=1))
        if not np.isfinite(bear) or bear == 0:
            koala[panda] = np.nan
        else:
            koala[panda] = float(wolf / bear)
    for panda in zebra:
        koala.setdefault(panda, np.nan)
    return _make_factor_series(koala, date, universe=universe, name='factor309')

def factor310(universe, date, K_months=6):
    _set_asof_date(date)
    tiger = _to_date(date)
    giraffe = list(universe)
    lion = get_trade_days(end_date=tiger, count=int(K_months) * 21 + 1)
    if len(lion) < 2:
        return _make_factor_series({panda: np.nan for panda in giraffe}, date, universe=universe, name='factor310')
    rabbit = pd.to_datetime(lion[0]).strftime('%Y-%m-%d')
    otter = pd.to_datetime(tiger).strftime('%Y-%m-%d')
    koala = get_price(giraffe, start_date=rabbit, end_date=otter, frequency='daily', fields=['close'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({panda: np.nan for panda in giraffe}, date, universe=universe, name='factor310')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index()
    koala['time'] = pd.to_datetime(koala['time']).dt.normalize()
    dog = koala.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=giraffe).astype(float)
    bear = dog.pct_change()
    wolf = bear.max(axis=0, skipna=True)
    wolf = wolf.where(np.isfinite(wolf), np.nan)
    fox = {cat: float(wolf.loc[cat]) if np.isfinite(wolf.loc[cat]) else np.nan for cat in giraffe}
    return _make_factor_series(fox, date, universe=universe, name='factor310')

def factor311(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    hawk = pd.Period(cat, freq='Q-DEC') - 1
    eagle = pd.PeriodIndex([hawk], freq='Q-DEC')
    otter = get_history_fundamentals(security=panda, fields=[bear.term_090, bear.term_021, bear.term_035], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if otter is None or otter.empty or 'code' not in otter.columns or ('statDate' not in otter.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor311')
    fox = otter.copy()
    fox['code'] = fox['code'].astype(str)
    fox['statDate'] = pd.to_datetime(fox['statDate'], errors='coerce')
    fox = fox.dropna(subset=['code', 'statDate'])
    if fox.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor311')
    fox['q'] = fox['statDate'].dt.to_period('Q-DEC')
    fox = fox[fox['q'].isin(eagle)]
    if fox.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor311')
    fox = fox.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    lemur = fox.pivot(index='q', columns='code', values='term_090').reindex(index=eagle, columns=panda).apply(pd.to_numeric, errors='coerce').astype(float)
    dolphin = fox.pivot(index='q', columns='code', values='term_021').reindex(index=eagle, columns=panda).apply(pd.to_numeric, errors='coerce').astype(float)
    turtle = fox.pivot(index='q', columns='code', values='term_035').reindex(index=eagle, columns=panda).apply(pd.to_numeric, errors='coerce').astype(float)
    alpaca = lemur.loc[hawk] if hawk in lemur.index else pd.Series(np.nan, index=panda, dtype='float64')
    zebra = dolphin.loc[hawk] if hawk in dolphin.index else pd.Series(np.nan, index=panda, dtype='float64')
    owl = turtle.loc[hawk] if hawk in turtle.index else pd.Series(np.nan, index=panda, dtype='float64')
    wolf = alpaca + zebra + owl
    koala = get_history_fundamentals(security=panda, fields=[fox.term_082, fox.term_083, fox.term_025], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor311')
    lion = koala.copy()
    lion['code'] = lion['code'].astype(str)
    lion['statDate'] = pd.to_datetime(lion['statDate'], errors='coerce')
    lion = lion.dropna(subset=['code', 'statDate'])
    if lion.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor311')
    lion['q'] = lion['statDate'].dt.to_period('Q-DEC')
    lion = lion[lion['q'].isin(eagle)]
    if lion.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor311')
    lion = lion.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    frog = lion.pivot(index='q', columns='code', values='term_082').reindex(index=eagle, columns=panda).apply(pd.to_numeric, errors='coerce').astype(float)
    tuna = lion.pivot(index='q', columns='code', values='term_083').reindex(index=eagle, columns=panda).apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = lion.pivot(index='q', columns='code', values='term_025').reindex(index=eagle, columns=panda).apply(pd.to_numeric, errors='coerce').astype(float)
    lizard = frog.loc[hawk] if hawk in frog.index else pd.Series(np.nan, index=panda, dtype='float64')
    salmon = tuna.loc[hawk] if hawk in tuna.index else pd.Series(np.nan, index=panda, dtype='float64')
    bear = rabbit.loc[hawk] if hawk in rabbit.index else pd.Series(np.nan, index=panda, dtype='float64')
    sparrow = lizard - salmon + bear
    sparrow = sparrow.where(np.isfinite(sparrow) & (sparrow != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = wolf / sparrow
    shark = shark.replace([np.inf, -np.inf], np.nan)
    whale = ~np.isfinite(shark) | ~np.isfinite(wolf) | ~np.isfinite(sparrow) | (sparrow == 0)
    shark = shark.where(~whale, np.nan).reindex(panda)
    giraffe = {dog: float(shark.get(dog)) if np.isfinite(shark.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(giraffe, tiger, universe=universe, name='factor311')

def factor312(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    dolphin = pd.Period(panda, freq='Q-DEC')
    whale = [dolphin - otter for otter in range(0, 4)]
    frog = [f'{shark.year}q{shark.quarter}' for shark in whale]
    tuna = {}
    giraffe = {}
    wolf = {}
    for lizard in frog:
        hawk = query(bear.code, bear.term_090, bear.term_052).filter(bear.code.in_(universe))
        lion = get_fundamentals(hawk, statDate=lizard)
        if lion is None or lion.empty:
            tuna[lizard] = pd.Series(dtype='float64')
            wolf[lizard] = pd.Series(dtype='float64')
        else:
            lion = lion.set_index('code')
            tuna[lizard] = lion['term_090'].astype(float)
            wolf[lizard] = lion['term_052'].astype(float)
        eagle = query(wolf.code, wolf.term_049).filter(wolf.code.in_(universe))
        tiger = get_fundamentals(eagle, statDate=lizard)
        if tiger is None or tiger.empty:
            giraffe[lizard] = pd.Series(dtype='float64')
        else:
            giraffe[lizard] = tiger.set_index('code')['term_049'].astype(float)
    koala = {}
    for dog in universe:
        salmon, rabbit, fox = ([], [], [])
        for lizard in frog:
            turtle = tuna[lizard]
            owl = giraffe[lizard]
            sparrow = wolf[lizard]
            if dog in turtle.index:
                salmon.append(turtle[dog])
            if dog in owl.index:
                rabbit.append(owl[dog])
            if dog in sparrow.index:
                fox.append(sparrow[dog])
        if len(salmon) == 0 or len(rabbit) == 0 or len(fox) == 0:
            lemur = np.nan
        else:
            alpaca = float(np.nansum(salmon))
            zebra = float(np.nansum(rabbit))
            bear = float(np.nansum(fox))
            if bear == 0 or np.isnan(bear):
                lemur = np.nan
            else:
                cat = alpaca - zebra
                lemur = cat / abs(bear)
        koala[dog] = float(lemur) if np.isfinite(lemur) else np.nan
    return _make_factor_series(koala, date, universe=universe, name='factor312')

def factor313(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    giraffe = pd.Period(panda, freq='Q-DEC')
    zebra = [giraffe - wolf for wolf in range(0, 4)]
    sparrow = [f'{dolphin.year}q{dolphin.quarter}' for dolphin in zebra]
    koala = {}
    for hawk in sparrow:
        whale = query(wolf.code, wolf.term_018).filter(wolf.code.in_(universe))
        tiger = get_fundamentals(whale, statDate=hawk)
        if tiger is None or tiger.empty:
            koala[hawk] = pd.Series(dtype='float64')
        else:
            tiger = tiger.set_index('code')
            koala[hawk] = tiger['term_018'].astype(float)
    shark = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    lion = get_fundamentals(shark, date=panda)
    if lion is None or lion.empty:
        lion = pd.DataFrame(columns=['code', 'term_045'])
    lion = lion.set_index('code')
    rabbit = lion['term_045'].astype(float)
    fox = {}
    for cat in universe:
        dog = []
        for hawk in sparrow:
            eagle = koala[hawk]
            if cat in eagle.index:
                dog.append(eagle[cat])
        if len(dog) == 0:
            fox[cat] = np.nan
            continue
        otter = float(np.nansum(dog))
        bear = rabbit.get(cat, np.nan)
        if np.isnan(bear) or bear <= 0:
            owl = np.nan
        else:
            owl = otter / bear
        fox[cat] = float(owl) if np.isfinite(owl) else np.nan
    return _make_factor_series(fox, date, universe=universe, name='factor313')

def factor314(universe, date):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    giraffe = list(universe)
    wolf = query(fox.code, fox.term_075).filter(fox.code.in_(giraffe))
    lion = get_fundamentals(wolf, date=panda)
    if lion is None or lion.empty:
        rabbit = pd.Series(np.nan, index=giraffe, dtype='float64')
    else:
        rabbit = lion.set_index('code')['term_075'].astype(float).reindex(giraffe)
    bear = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(giraffe))
    koala = get_fundamentals(bear, date=panda)
    if koala is None or koala.empty:
        dog = pd.Series(np.nan, index=giraffe, dtype='float64')
    else:
        dog = koala.set_index('code')['term_008'].astype(float).reindex(giraffe)
    tiger = (dog * 10000.0).where(np.isfinite(dog) & (dog > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        fox = rabbit / tiger
    fox = fox.where(np.isfinite(fox) & np.isfinite(rabbit) & np.isfinite(tiger), np.nan)
    otter = {cat: float(fox.loc[cat]) if np.isfinite(fox.loc[cat]) else np.nan for cat in giraffe}
    return _make_factor_series(otter, date, universe=universe, name='factor314')

def factor315(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    dog = pd.Timestamp(lion)
    tiger = list(universe)
    rabbit = pd.Period(dog, freq='Q-DEC') - 1
    fox = pd.PeriodIndex([rabbit], freq='Q-DEC')
    koala = get_history_fundamentals(security=tiger, fields=[bear.term_072, bear.term_004, bear.term_066], watch_date=dog, count=12, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns):
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor315')
    koala = koala.copy()
    if 'pubDate' in koala.columns:
        bear = pd.to_datetime(koala['pubDate'], errors='coerce')
        koala = koala[bear.notna() & (bear <= dog)]
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor315')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(fox)]
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if koala.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor315')
    dolphin = pd.to_numeric(koala.set_index('code').get('term_066', np.nan), errors='coerce').astype(float).reindex(tiger)
    giraffe = pd.to_numeric(koala.set_index('code').get('term_072', np.nan), errors='coerce').astype(float).reindex(tiger)
    cat = pd.to_numeric(koala.set_index('code').get('term_004', np.nan), errors='coerce').astype(float).reindex(tiger)
    zebra = giraffe.where(np.isfinite(giraffe.values), cat)
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = zebra / dolphin
    wolf = wolf.replace([np.inf, -np.inf], np.nan)
    wolf = wolf.where(np.isfinite(dolphin) & (dolphin != 0) & np.isfinite(zebra), np.nan)
    otter = {panda: float(wolf.get(panda, np.nan)) if np.isfinite(wolf.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(otter, lion, universe=universe, name='factor315')

def factor316(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    rabbit = list(universe)
    try:
        lion = get_factor_values(rabbit, factors=['roe_ttm'], end_date=panda, count=1)
        wolf = lion['roe_ttm'].iloc[-1].astype(float).reindex(rabbit)
    except Exception:
        return _make_factor_series({dog: np.nan for dog in rabbit}, date, universe=universe, name='factor316')
    tiger = (pd.to_datetime(panda) - DateOffset(years=1)).date()
    try:
        koala = get_factor_values(rabbit, factors=['roe_ttm'], end_date=tiger, count=1)
        bear = koala['roe_ttm'].iloc[-1].astype(float).reindex(rabbit)
    except Exception:
        return _make_factor_series({dog: np.nan for dog in rabbit}, date, universe=universe, name='factor316')
    fox = wolf - bear
    fox = fox.where(np.isfinite(fox), np.nan)
    otter = {cat: float(fox.loc[cat]) if np.isfinite(fox.loc[cat]) else np.nan for cat in rabbit}
    return _make_factor_series(otter, date, universe=universe, name='factor316')

def factor317(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    panda = list(universe)
    shark = pd.Period(cat, freq='Q-DEC') - 1
    whale = pd.PeriodIndex([shark], freq='Q-DEC')
    wolf = get_history_fundamentals(security=panda, fields=[bear.term_066, bear.term_060], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or 'code' not in wolf.columns or ('statDate' not in wolf.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, koala, universe=universe, name='factor317')
    bear = wolf.copy()
    bear['code'] = bear['code'].astype(str)
    bear['statDate'] = pd.to_datetime(bear['statDate'], errors='coerce')
    bear = bear.dropna(subset=['code', 'statDate'])
    if bear.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, koala, universe=universe, name='factor317')
    bear['q'] = bear['statDate'].dt.to_period('Q-DEC')
    bear = bear[bear['q'].isin(whale)]
    if bear.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, koala, universe=universe, name='factor317')
    bear = bear.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    hawk = bear.pivot(index='q', columns='code', values='term_066').reindex(index=whale, columns=panda).apply(pd.to_numeric, errors='coerce').astype(float)
    lion = bear.pivot(index='q', columns='code', values='term_060').reindex(index=whale, columns=panda).apply(pd.to_numeric, errors='coerce').astype(float)
    eagle = hawk.loc[shark] if shark in hawk.index else pd.Series(np.nan, index=panda, dtype='float64')
    tiger = lion.loc[shark] if shark in lion.index else pd.Series(np.nan, index=panda, dtype='float64')
    giraffe = eagle - tiger
    fox = get_history_fundamentals(security=panda, fields=[fox.term_081], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    if fox is None or fox.empty or 'code' not in fox.columns or ('statDate' not in fox.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, koala, universe=universe, name='factor317')
    otter = fox.copy()
    otter['code'] = otter['code'].astype(str)
    otter['statDate'] = pd.to_datetime(otter['statDate'], errors='coerce')
    otter = otter.dropna(subset=['code', 'statDate'])
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, koala, universe=universe, name='factor317')
    otter['q'] = otter['statDate'].dt.to_period('Q-DEC')
    otter = otter[otter['q'].isin(whale)]
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, koala, universe=universe, name='factor317')
    otter = otter.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    owl = otter.pivot(index='q', columns='code', values='term_081').reindex(index=whale, columns=panda).apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = owl.loc[shark] if shark in owl.index else pd.Series(np.nan, index=panda, dtype='float64')
    turtle = sparrow.where(np.isfinite(sparrow) & (sparrow != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = giraffe / turtle
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    zebra = ~np.isfinite(dolphin) | ~np.isfinite(giraffe) | ~np.isfinite(turtle) | (turtle == 0)
    dolphin = dolphin.where(~zebra, np.nan).reindex(panda)
    rabbit = {dog: float(dolphin.get(dog)) if np.isfinite(dolphin.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(rabbit, koala, universe=universe, name='factor317')

def factor318(universe, date, N_days=20, batch_size=200):
    _set_asof_date(date)
    wolf = pd.to_datetime(date)
    turtle = list(universe)
    bear = _last_n_trade_days(wolf, int(N_days))
    if len(bear) == 0:
        return _make_factor_series({lion: np.nan for lion in turtle}, date, universe=universe, name='factor318')
    rabbit = [pd.to_datetime(fox).date() for fox in bear]
    owl = pd.to_datetime(bear[0]).strftime('%Y-%m-%d')
    zebra = (pd.to_datetime(bear[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    sparrow = []
    panda = max(1, int(batch_size))
    for whale in range(0, len(turtle), panda):
        dog = turtle[whale:whale + panda]
        shark = get_price(dog, start_date=owl, end_date=zebra, frequency='1m', fields=['close', 'volume'], fq='post', panel=False)
        if shark is None or shark.empty:
            continue
        shark = shark.copy()
        if 'time' not in shark.columns:
            shark['time'] = shark.index
        if 'code' not in shark.columns:
            continue
        shark['time'] = pd.to_datetime(shark['time'])
        shark['date'] = shark['time'].dt.date
        shark = shark[shark['date'].isin(rabbit)]
        if shark.empty:
            continue
        shark = shark[['code', 'date', 'close', 'volume']].dropna(subset=['close', 'volume'])
        if shark.empty:
            continue
        shark['close'] = shark['close'].astype(float)
        shark['volume'] = shark['volume'].astype(float)
        shark = shark[np.isfinite(shark['close'].values) & np.isfinite(shark['volume'].values)]
        if shark.empty:
            continue
        shark['xy'] = shark['close'] * shark['volume']
        shark['x2'] = shark['close'] * shark['close']
        shark['y2'] = shark['volume'] * shark['volume']
        cat = shark.groupby(['code', 'date'], sort=False).agg(n=('close', 'count'), mx=('close', 'mean'), my=('volume', 'mean'), mxy=('xy', 'mean'), mx2=('x2', 'mean'), my2=('y2', 'mean'))
        eagle = cat['mxy'] - cat['mx'] * cat['my']
        lizard = cat['mx2'] - cat['mx'] * cat['mx']
        frog = cat['my2'] - cat['my'] * cat['my']
        giraffe = np.sqrt(lizard * frog)
        koala = eagle / giraffe
        koala[(cat['n'] < 3) | ~np.isfinite(koala) | ~np.isfinite(giraffe) | (giraffe <= 0)] = np.nan
        sparrow.append(koala.rename('corr').reset_index())
    if len(sparrow) == 0:
        return _make_factor_series({lion: np.nan for lion in turtle}, date, universe=universe, name='factor318')
    otter = pd.concat(sparrow, ignore_index=True)
    otter = otter.dropna(subset=['corr'])
    if otter.empty:
        return _make_factor_series({lion: np.nan for lion in turtle}, date, universe=universe, name='factor318')
    hawk = otter.groupby('code', sort=False)['corr'].mean().reindex(turtle)
    hawk = hawk.where(np.isfinite(hawk), np.nan)
    dolphin = {tiger: float(hawk.loc[tiger]) if np.isfinite(hawk.loc[tiger]) else np.nan for tiger in turtle}
    return _make_factor_series(dolphin, date, universe=universe, name='factor318')

def factor319(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    try:
        lion = get_factor_values(universe, factors=['term_068', 'term_061'], end_date=tiger, count=1)
    except Exception:
        return _make_factor_series({}, date, universe=universe, name='factor319')
    fox = lion['term_068'].iloc[-1]
    panda = lion['term_061'].iloc[-1]
    koala = {}
    for cat in universe:
        otter = fox.get(cat, np.nan)
        dog = panda.get(cat, np.nan)
        if np.isnan(otter) or np.isnan(dog) or otter == 0:
            wolf = np.nan
        else:
            wolf = (otter - dog) / otter
        koala[cat] = float(wolf) if np.isfinite(wolf) else np.nan
    return _make_factor_series(koala, date, universe=universe, name='factor319')

def factor320(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    camel = query(giraffe.code, giraffe.pe_ratio, giraffe.term_045).filter(giraffe.code.in_(universe))
    koala = get_fundamentals(camel, date=panda)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor320')
    koala = koala.set_index('code')
    tuna = koala['pe_ratio'].astype(float)
    sparrow = koala['term_045'].astype(float)
    try:
        dolphin = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=panda, count=1)
        turtle = dolphin['np_parent_company_owners_ttm'].iloc[-1]
    except Exception:
        turtle = pd.Series(np.nan, index=universe, dtype=float)
    tiger = panda - DateOffset(years=1)
    try:
        whale = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=tiger, count=1)
        lizard = whale['np_parent_company_owners_ttm'].iloc[-1]
    except Exception:
        lizard = pd.Series(np.nan, index=universe, dtype=float)
    rabbit = {}
    for cat in universe:
        alpaca = tuna.get(cat, np.nan)
        frog = turtle.get(cat, np.nan)
        owl = lizard.get(cat, np.nan)
        if np.isnan(alpaca) or np.isnan(frog) or np.isnan(owl) or (owl == 0):
            rabbit[cat] = np.nan
        else:
            zebra = (frog - owl) / abs(owl)
            if np.isnan(zebra) or zebra == 0:
                rabbit[cat] = np.nan
            else:
                rabbit[cat] = alpaca / zebra
    salmon = pd.Period(panda, freq='Q-DEC')
    lemur = [salmon - eagle for eagle in range(0, 4)]
    gecko = [f'{badger.year}q{badger.quarter}' for badger in lemur]
    otter = {}
    for ferret in gecko:
        beaver = query(wolf.code, wolf.term_018).filter(wolf.code.in_(universe))
        lion = get_fundamentals(beaver, statDate=ferret)
        if lion is None or lion.empty:
            otter[ferret] = pd.Series(dtype='float64')
        else:
            lion = lion.set_index('code')
            otter[ferret] = lion['term_018'].astype(float)
    wolf = {}
    for cat in universe:
        dog = []
        for ferret in gecko:
            donkey = otter[ferret]
            if cat in donkey.index:
                dog.append(donkey[cat])
        if len(dog) == 0:
            wolf[cat] = np.nan
            continue
        fox = float(np.nansum(dog))
        hawk = sparrow.get(cat, np.nan)
        if np.isnan(hawk) or hawk <= 0:
            wolf[cat] = np.nan
        else:
            wolf[cat] = fox / hawk
    shark = {}
    for cat in universe:
        giraffe = rabbit.get(cat, np.nan)
        bear = wolf.get(cat, np.nan)
        if np.isnan(giraffe) or np.isnan(bear) or bear == 0:
            hyena = np.nan
        else:
            hyena = giraffe / bear
        shark[cat] = float(hyena) if np.isfinite(hyena) else np.nan
    return _make_factor_series(shark, date, universe=universe, name='factor320')

def factor321(universe, date, K_months=6):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = get_trade_days(end_date=lion, count=K_months * 21 + 1)
    if len(koala) < 2:
        return _make_factor_series({tiger: np.nan for tiger in universe}, lion, universe=universe, name='factor321')
    dolphin = koala[0]
    whale = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    fox = pd.to_datetime(lion).strftime('%Y-%m-%d')
    otter = get_price(universe, start_date=whale, end_date=fox, frequency='daily', fields=['close', 'money'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({tiger: np.nan for tiger in universe}, lion, universe=universe, name='factor321')
    panda = otter.pivot(index='time', columns='code', values='close').sort_index()
    rabbit = otter.pivot(index='time', columns='code', values='money').sort_index()
    giraffe = panda.pct_change().dropna(how='all')
    rabbit = rabbit.loc[giraffe.index]
    wolf = {}
    for tiger in universe:
        if tiger not in giraffe.columns or tiger not in rabbit.columns:
            wolf[tiger] = np.nan
            continue
        zebra = giraffe[tiger]
        dog = rabbit[tiger]
        bear = ~zebra.isna() & (dog > 0)
        if bear.sum() == 0:
            wolf[tiger] = np.nan
            continue
        cat = (zebra.abs() / dog).where(bear, np.nan).dropna()
        wolf[tiger] = float(cat.mean()) if not cat.empty else np.nan
    return _make_factor_series(wolf, lion, universe=universe, name='factor321')

def factor322(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    wolf = pd.Timestamp(panda).strftime('%Y-%m-%d')
    tiger = (pd.Timestamp(panda) - DateOffset(years=1)).date()
    eagle = get_trade_days(end_date=tiger, count=1)
    if not eagle:
        return _make_factor_series({cat: np.nan for cat in universe}, panda, universe=universe, name='factor322')
    whale = pd.to_datetime(eagle[0]).date()
    shark = pd.Timestamp(whale).strftime('%Y-%m-%d')
    owl = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    koala = get_fundamentals(owl, date=wolf)
    if koala is None or koala.empty or 'code' not in koala.columns:
        sparrow = pd.Series(np.nan, index=list(universe), dtype='float64')
    else:
        koala = koala.copy()
        koala['code'] = koala['code'].astype(str)
        sparrow = pd.to_numeric(koala.set_index('code').get('term_045', np.nan), errors='coerce').reindex(list(universe)).astype(float)
    otter = get_fundamentals(owl, date=shark)
    if otter is None or otter.empty or 'code' not in otter.columns:
        hawk = pd.Series(np.nan, index=list(universe), dtype='float64')
    else:
        otter = otter.copy()
        otter['code'] = otter['code'].astype(str)
        hawk = pd.to_numeric(otter.set_index('code').get('term_045', np.nan), errors='coerce').reindex(list(universe)).astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = np.log(sparrow / hawk)
    zebra = pd.Series(zebra, index=list(universe)).replace([np.inf, -np.inf], np.nan)
    lion = list(get_trade_days(start_date=whale, end_date=panda))
    lion = [pd.to_datetime(frog).date() for frog in lion]
    if len(lion) < 2:
        return _make_factor_series({cat: np.nan for cat in universe}, panda, universe=universe, name='factor322')
    lizard = pd.Timestamp(lion[0]).strftime('%Y-%m-%d')
    fox = get_price(list(universe), start_date=lizard, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or getattr(fox, 'empty', True):
        return _make_factor_series({cat: np.nan for cat in universe}, panda, universe=universe, name='factor322')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index().rename(columns={'index': 'time'})
    if 'code' not in fox.columns:
        return _make_factor_series({cat: np.nan for cat in universe}, panda, universe=universe, name='factor322')
    fox['time'] = pd.to_datetime(fox['time'], errors='coerce').dt.normalize()
    fox = fox.dropna(subset=['time'])
    fox['code'] = fox['code'].astype(str)
    fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
    dog = fox.pivot(index='time', columns='code', values='close').sort_index()
    dog = dog.reindex(index=pd.to_datetime(lion), columns=list(universe))
    turtle = dog.pct_change()
    turtle = turtle.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = np.log1p(turtle)
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    dolphin = giraffe.sum(axis=0, skipna=True)
    dolphin = pd.to_numeric(dolphin, errors='coerce').reindex(list(universe))
    bear = zebra - dolphin
    bear = bear.replace([np.inf, -np.inf], np.nan)
    rabbit = {cat: float(bear.loc[cat]) if np.isfinite(bear.loc[cat]) else np.nan for cat in universe}
    return _make_factor_series(rabbit, panda, universe=universe, name='factor322')

def factor323(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor323')

def factor324(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    sparrow = pd.Period(cat, freq='Q-DEC') - 1
    eagle = sparrow - 4
    hawk = pd.PeriodIndex([eagle, sparrow], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    otter = get_history_fundamentals(security=tiger, fields=[bear.term_066], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    rabbit = _prep_hist(otter)
    if rabbit.empty or 'term_066' not in rabbit.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor324')
    rabbit = rabbit[rabbit['q'].isin(hawk)]
    if rabbit.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor324')
    turtle = rabbit.pivot(index='q', columns='code', values='term_066').reindex(index=hawk, columns=tiger)
    turtle = turtle.apply(pd.to_numeric, errors='coerce').astype(float)
    lizard = turtle.loc[sparrow] if sparrow in turtle.index else pd.Series(np.nan, index=tiger, dtype='float64')
    owl = turtle.loc[eagle] if eagle in turtle.index else pd.Series(np.nan, index=tiger, dtype='float64')
    koala = get_history_fundamentals(security=tiger, fields=[fox.inventories], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    dog = _prep_hist(koala)
    if dog.empty or 'inventories' not in dog.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor324')
    dog = dog[dog['q'].isin(hawk)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor324')
    zebra = dog.pivot(index='q', columns='code', values='inventories').reindex(index=hawk, columns=tiger)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float)
    dolphin = zebra.loc[sparrow] if sparrow in zebra.index else pd.Series(np.nan, index=tiger, dtype='float64')
    giraffe = zebra.loc[eagle] if eagle in zebra.index else pd.Series(np.nan, index=tiger, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = (lizard - owl) / np.abs(owl)
        wolf = (dolphin - giraffe) / np.abs(giraffe)
        shark = bear - wolf
    whale = ~np.isfinite(shark) | ~np.isfinite(lizard) | ~np.isfinite(owl) | ~np.isfinite(dolphin) | ~np.isfinite(giraffe) | (owl == 0) | (giraffe == 0)
    shark = shark.where(~whale, np.nan).reindex(tiger)
    fox = {panda: float(shark.get(panda)) if np.isfinite(shark.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(fox, lion, universe=universe, name='factor324')

def factor325(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor325')

def factor326(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    koala = query(fox.code, fox.term_086, fox.term_081).filter(fox.code.in_(universe))
    panda = get_fundamentals(koala, date=dog)
    if panda is None or panda.empty:
        tiger = {cat: np.nan for cat in universe}
        return _make_factor_series(tiger, dog, universe=universe, name='factor326')
    panda = panda.set_index('code')
    tiger = {}
    for cat in universe:
        lion = panda['term_086'].get(cat, np.nan)
        otter = panda['term_081'].get(cat, np.nan)
        if np.isnan(lion) or np.isnan(otter) or otter == 0:
            fox = np.nan
        else:
            fox = lion / otter
        tiger[cat] = fox
    return _make_factor_series(tiger, dog, universe=universe, name='factor326')

def factor327(universe, date, N=20):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = get_trade_days(end_date=wolf, count=N + 1)
    if len(bear) < N + 1:
        dolphin = {fox: np.nan for fox in universe}
        return _make_factor_series(dolphin, wolf, universe=universe, name='factor327')
    shark = bear[0]
    eagle = pd.to_datetime(shark).strftime('%Y-%m-%d')
    zebra = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    rabbit = get_price(universe, start_date=eagle, end_date=zebra, frequency='daily', fields=['close'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        dolphin = {fox: np.nan for fox in universe}
        return _make_factor_series(dolphin, wolf, universe=universe, name='factor327')
    otter = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    lion = otter.values[-(N + 1):]
    dolphin = {}
    for whale, fox in enumerate(otter.columns):
        koala = lion[:, whale]
        if len(koala) < N + 1:
            dolphin[fox] = np.nan
            continue
        giraffe = koala[1:] - koala[:-1]
        cat = np.maximum(giraffe, 0.0)
        dog = np.maximum(-giraffe, 0.0)
        tiger = cat[-N:].sum()
        panda = dog[-N:].sum()
        if tiger + panda == 0:
            hawk = np.nan
        else:
            hawk = (tiger - panda) / (tiger + panda) * 100.0
        dolphin[fox] = hawk
    return _make_factor_series(dolphin, wolf, universe=universe, name='factor327')

def factor328(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    sparrow = pd.Period(cat, freq='Q-DEC') - 1
    owl = sparrow - 1
    turtle = pd.PeriodIndex([sparrow, sparrow - 1, sparrow - 2, sparrow - 3], freq='Q-DEC')
    hawk = pd.PeriodIndex([owl, sparrow], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=lion, fields=[bear.term_063], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    zebra = _prep_hist(fox)
    if zebra.empty or 'term_063' not in zebra.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor328')
    zebra = zebra[zebra['q'].isin(turtle)]
    if zebra.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor328')
    whale = zebra.pivot(index='q', columns='code', values='term_063').reindex(index=turtle, columns=lion)
    whale = whale.apply(pd.to_numeric, errors='coerce').astype(float)
    shark = whale.sum(axis=0, min_count=1).reindex(lion)
    otter = get_history_fundamentals(security=lion, fields=[fox.equities_parent_company_owners], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(otter)
    if panda.empty or 'equities_parent_company_owners' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor328')
    panda = panda[panda['q'].isin(hawk)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor328')
    wolf = panda.pivot(index='q', columns='code', values='equities_parent_company_owners').reindex(index=hawk, columns=lion)
    wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float)
    bear = wolf.loc[sparrow] if sparrow in wolf.index else pd.Series(np.nan, index=lion, dtype='float64')
    rabbit = wolf.loc[owl] if owl in wolf.index else pd.Series(np.nan, index=lion, dtype='float64')
    dog = (bear + rabbit) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = shark / dog
    dolphin = ~np.isfinite(eagle) | ~np.isfinite(shark) | ~np.isfinite(dog) | (dog == 0)
    eagle = eagle.where(~dolphin, np.nan).reindex(lion)
    giraffe = {tiger: float(eagle.get(tiger)) if np.isfinite(eagle.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(giraffe, koala, universe=universe, name='factor328')

def factor329(universe, date):
    _set_asof_date(date)
    panda = list(universe)
    tiger = _r3_safe_date(date)
    koala = _r3_fundamentals(fox, [fox.term_075], panda, date=tiger)
    otter = _r3_fundamentals(giraffe, [giraffe.term_008], panda, date=tiger)
    lion = _r3_join_code(panda, koala, otter)
    fox = pd.to_numeric(lion.get('term_075', np.nan), errors='coerce')
    dog = pd.to_numeric(lion.get('term_008', np.nan), errors='coerce')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = fox / (dog * 10000.0)
    wolf = wolf.where(np.isfinite(wolf) & (dog > 0), np.nan)
    return _make_factor_series({cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in panda}, tiger, universe=universe, name='factor329')

def factor330(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor330')

def factor331(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    zebra = list(universe)
    rabbit = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(zebra))
    koala = get_fundamentals(rabbit, date=panda)
    if koala is None or koala.empty:
        wolf = pd.Series(np.nan, index=zebra, dtype='float64')
    else:
        wolf = koala.set_index('code')['term_045'].astype(float).reindex(zebra)
    bear = query(fox.code, fox.term_084, fox.term_012, fox.term_092).filter(fox.code.in_(zebra))
    lion = get_fundamentals(bear, date=panda)
    if lion is None or lion.empty:
        tiger = pd.Series(np.nan, index=zebra, dtype='float64')
        dog = pd.Series(np.nan, index=zebra, dtype='float64')
        giraffe = pd.Series(np.nan, index=zebra, dtype='float64')
    else:
        lion = lion.set_index('code')
        tiger = lion['term_084'].astype(float).reindex(zebra)
        dog = lion['term_012'].astype(float).reindex(zebra)
        giraffe = lion['term_092'].astype(float).reindex(zebra)
    otter = wolf + tiger - (dog + giraffe)
    otter = otter.where(np.isfinite(otter), np.nan)
    fox = {cat: float(otter.loc[cat]) if np.isfinite(otter.loc[cat]) else np.nan for cat in zebra}
    return _make_factor_series(fox, date, universe=universe, name='factor331')

def factor332(universe, date, N1=5, N2=10):
    _set_asof_date(date)
    panda = _to_date(date)
    shark = N1 + N2 + 5
    tiger = get_trade_days(end_date=panda, count=shark)
    if len(tiger) < N1 + N2 + 2:
        otter = {dog: np.nan for dog in universe}
        return _make_factor_series(otter, panda, universe=universe, name='factor332')
    wolf = tiger[0]
    bear = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    koala = pd.to_datetime(panda).strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=bear, end_date=koala, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        otter = {dog: np.nan for dog in universe}
        return _make_factor_series(otter, panda, universe=universe, name='factor332')
    cat = lion.pivot(index='time', columns='code', values='close').sort_index()
    otter = {}
    for dog in universe:
        if dog not in cat.columns:
            otter[dog] = np.nan
            continue
        fox = cat[dog].dropna()
        if len(fox) < N1 + N2:
            otter[dog] = np.nan
            continue
        dolphin = fox.rolling(N1).std()
        whale = dolphin.rolling(N2).mean()
        rabbit = float(dolphin.iloc[-1])
        giraffe = float(whale.iloc[-1])
        if giraffe == 0 or np.isnan(rabbit) or np.isnan(giraffe):
            zebra = np.nan
        else:
            zebra = 14.0 / (rabbit / giraffe)
        otter[dog] = float(zebra) if np.isfinite(zebra) else np.nan
    return _make_factor_series(otter, panda, universe=universe, name='factor332')

def factor333(universe, date, K_months=6):
    _set_asof_date(date)
    lion = _to_date(date)
    salmon = list(universe)
    koala = get_trade_days(end_date=lion, count=int(K_months) * 21 + 1)
    if len(koala) < 2:
        return _make_factor_series({tiger: np.nan for tiger in salmon}, date, universe=universe, name='factor333')
    lizard = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    bear = pd.to_datetime(lion).strftime('%Y-%m-%d')
    fox = get_price(salmon, start_date=lizard, end_date=bear, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({tiger: np.nan for tiger in salmon}, date, universe=universe, name='factor333')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index()
    fox['time'] = pd.to_datetime(fox['time']).dt.normalize()
    dog = fox.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=salmon).astype(float)
    owl = dog.pct_change().values
    giraffe = np.isfinite(owl)
    panda = giraffe.sum(axis=0).astype(float)
    frog = np.where(giraffe, owl, 0.0).sum(axis=0)
    eagle = np.full(frog.shape, np.nan, dtype=float)
    np.divide(frog, panda, out=eagle, where=panda > 0)
    wolf = np.where(giraffe, owl - eagle[None, :], 0.0)
    dolphin = (wolf ** 2).sum(axis=0)
    shark = (wolf ** 3).sum(axis=0)
    otter = panda
    zebra = np.full(dolphin.shape, np.nan, dtype=float)
    whale = np.full(shark.shape, np.nan, dtype=float)
    np.divide(dolphin, otter, out=zebra, where=otter > 0)
    np.divide(shark, otter, out=whale, where=otter > 0)
    with np.errstate(divide='ignore', invalid='ignore'):
        turtle = whale / zebra ** 1.5
    hawk = (panda >= 10) & np.isfinite(turtle) & np.isfinite(zebra) & (zebra > 0)
    turtle = np.where(hawk, turtle, np.nan)
    sparrow = pd.Series(turtle, index=salmon, dtype='float64')
    rabbit = {cat: float(sparrow.loc[cat]) if np.isfinite(sparrow.loc[cat]) else np.nan for cat in salmon}
    return _make_factor_series(rabbit, date, universe=universe, name='factor333')

def factor334(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    hawk = list(universe)
    shark = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(hawk))
    otter = get_fundamentals(shark, date=tiger)
    if otter is None or otter.empty:
        zebra = pd.Series(np.nan, index=hawk, dtype='float64')
    else:
        zebra = otter.set_index('code')['term_045'].astype(float).reindex(hawk)
    whale = query(fox.code, fox.term_084, fox.term_012, fox.term_092).filter(fox.code.in_(hawk))
    koala = get_fundamentals(whale, date=tiger)
    if koala is None or koala.empty:
        lion = pd.Series(np.nan, index=hawk, dtype='float64')
        dog = pd.Series(np.nan, index=hawk, dtype='float64')
        eagle = pd.Series(np.nan, index=hawk, dtype='float64')
    else:
        koala = koala.set_index('code')
        lion = koala['term_084'].astype(float).reindex(hawk)
        dog = koala['term_012'].astype(float).reindex(hawk)
        eagle = koala['term_092'].astype(float).reindex(hawk)
    bear = (zebra + lion - (dog + eagle)).astype(float)
    wolf = None
    try:
        rabbit = get_factor_values(hawk, factors=['EBITDA', 'EBIT'], end_date=tiger, count=1)
        if rabbit and 'EBITDA' in rabbit and (rabbit['EBITDA'] is not None) and (not rabbit['EBITDA'].empty):
            fox = rabbit['EBITDA'].iloc[-1].astype(float).reindex(hawk)
            if not fox.isna().all():
                wolf = fox
        if wolf is None and rabbit and ('EBIT' in rabbit) and (rabbit['EBIT'] is not None) and (not rabbit['EBIT'].empty):
            wolf = rabbit['EBIT'].iloc[-1].astype(float).reindex(hawk)
    except Exception:
        wolf = None
    if wolf is None:
        return _make_factor_series({panda: np.nan for panda in hawk}, date, universe=universe, name='factor334')
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = bear / wolf
    dolphin = dolphin.where(np.isfinite(dolphin) & np.isfinite(bear) & np.isfinite(wolf) & (wolf != 0), np.nan)
    giraffe = {cat: float(dolphin.loc[cat]) if np.isfinite(dolphin.loc[cat]) else np.nan for cat in hawk}
    return _make_factor_series(giraffe, date, universe=universe, name='factor334')

def factor335(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor335')

def _rnoa_ttm_single(universe, d_):
    zebra = pd.Period(pd.to_datetime(d_), freq='Q-DEC')
    shark = [zebra - otter for otter in range(0, 4)]
    tuna = [f'{eagle.year}q{eagle.quarter}' for eagle in shark]
    bear = {}
    for lizard in tuna:
        sparrow = query(bear.code, bear.term_063).filter(bear.code.in_(universe))
        tiger = get_fundamentals(sparrow, statDate=lizard)
        if tiger is None or tiger.empty:
            bear[lizard] = pd.Series(dtype='float64')
        else:
            bear[lizard] = tiger.set_index('code')['term_063']
    dolphin, whale = (zebra, zebra - 1)
    frog = f'{dolphin.year}q{dolphin.quarter}'
    salmon = f'{whale.year}q{whale.quarter}'
    hawk = query(fox.code, fox.term_081, fox.term_012, fox.term_092, fox.term_005, fox.term_041, fox.term_020, fox.term_031, fox.hold_to_maturity_investments, fox.term_077, fox.term_044, fox.term_006, fox.term_093).filter(fox.code.in_(universe))
    lion = get_fundamentals(hawk, statDate=frog)
    koala = get_fundamentals(hawk, statDate=salmon)
    cat = ['code', 'term_081', 'term_012', 'term_092', 'term_005', 'term_041', 'term_020', 'term_031', 'hold_to_maturity_investments', 'term_077', 'term_044', 'term_006', 'term_093']
    if lion is None or lion.empty or 'code' not in lion.columns:
        lion = pd.DataFrame(columns=cat)
    if koala is None or koala.empty or 'code' not in koala.columns:
        koala = pd.DataFrame(columns=cat)
    lion = lion.set_index('code')
    koala = koala.set_index('code')

    def _NOA(df_bal, code):
        if code not in df_bal.index:
            return np.nan
        rabbit = df_bal.loc[code]
        zebra = rabbit.get('term_081', np.nan)
        if pd.isna(zebra):
            return np.nan

        def z(x):
            return 0.0 if pd.isna(x) else float(x)
        tiger = z(rabbit.get('term_012', np.nan))
        whale = z(rabbit.get('term_092', np.nan))
        panda = z(rabbit.get('term_005', np.nan))
        otter = z(rabbit.get('term_041', np.nan))
        lion = z(rabbit.get('term_020', np.nan))
        cat = z(rabbit.get('term_031', np.nan))
        koala = z(rabbit.get('hold_to_maturity_investments', np.nan))
        giraffe = z(rabbit.get('term_077', np.nan))
        fox = z(rabbit.get('term_044', np.nan))
        dog = z(rabbit.get('term_006', np.nan))
        dolphin = z(rabbit.get('term_093', np.nan))
        wolf = float(zebra) - (tiger + whale + panda + otter + lion + cat + koala)
        bear = giraffe + fox + dog + dolphin
        return wolf - bear
    owl = pd.Series(np.nan, index=universe, dtype='float64')
    for panda in universe:
        giraffe = []
        for lizard in tuna:
            turtle = bear[lizard]
            if panda in turtle.index:
                giraffe.append(turtle[panda])
        if len(giraffe) == 0:
            continue
        rabbit = float(np.nansum(np.array(giraffe, dtype=float)))
        if not np.isfinite(rabbit):
            continue
        fox = _NOA(lion, panda)
        wolf = _NOA(koala, panda)
        if not np.isfinite(fox) or not np.isfinite(wolf):
            continue
        dog = 0.5 * (fox + wolf)
        if not np.isfinite(dog) or dog == 0.0:
            continue
        alpaca = rabbit / dog
        if np.isfinite(alpaca):
            owl.loc[panda] = float(alpaca)
    return owl

def factor336(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    cat = pd.Timestamp(fox)
    otter = list(universe)
    tuna = pd.Period(cat, freq='Q-DEC') - 1
    alpaca = tuna - 1
    frog = tuna - 4
    salmon = tuna - 5
    whale = pd.PeriodIndex([salmon, frog, alpaca, tuna], freq='Q-DEC')
    bear = get_history_fundamentals(security=otter, fields=[bear.term_063], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    lion = [fox.term_081, fox.term_012, fox.term_092, fox.term_005, fox.term_041, fox.term_020, fox.term_031, fox.hold_to_maturity_investments, fox.term_077, fox.term_044, fox.term_006, fox.term_093]
    wolf = get_history_fundamentals(security=otter, fields=lion, watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if bear is None or bear.empty or wolf is None or wolf.empty:
        return _make_factor_series({koala: np.nan for koala in otter}, fox, universe=universe, name='factor336')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    dolphin = _prep(bear)
    tiger = _prep(wolf)
    if dolphin is None or tiger is None:
        return _make_factor_series({koala: np.nan for koala in otter}, fox, universe=universe, name='factor336')
    hawk = dolphin.pivot(index='q', columns='code', values='term_063').sort_index().reindex(columns=otter)
    hawk = hawk.apply(pd.to_numeric, errors='coerce').astype(float)
    owl = hawk.rolling(4, min_periods=4).sum()
    owl = owl.reindex(index=whale)

    def _pv(colname, fill0=False):
        if colname not in bal.columns:
            cat = pd.DataFrame(np.nan, index=need_q, columns=codes, dtype=float)
        else:
            cat = bal.pivot(index='q', columns='code', values=colname).sort_index().reindex(index=need_q, columns=codes)
            cat = cat.apply(pd.to_numeric, errors='coerce').astype(float)
        return cat.fillna(0.0) if fill0 else cat
    beaver = _pv('term_081', fill0=False)
    giraffe = _pv('term_012', fill0=True) + _pv('term_092', fill0=True) + _pv('term_005', fill0=True) + _pv('term_041', fill0=True) + _pv('term_020', fill0=True) + _pv('term_031', fill0=True) + _pv('hold_to_maturity_investments', fill0=True)
    zebra = _pv('term_077', fill0=True) + _pv('term_044', fill0=True) + _pv('term_006', fill0=True) + _pv('term_093', fill0=True)
    eagle = beaver - giraffe
    shark = eagle - zebra
    shark = shark.where(np.isfinite(beaver) & (beaver > 0), np.nan)
    panda = (shark.loc[tuna] + shark.loc[alpaca]) / 2.0
    dog = (shark.loc[frog] + shark.loc[salmon]) / 2.0
    panda = panda.replace([np.inf, -np.inf], np.nan)
    dog = dog.replace([np.inf, -np.inf], np.nan)
    turtle = owl.loc[tuna] if tuna in owl.index else pd.Series(np.nan, index=otter)
    sparrow = owl.loc[frog] if frog in owl.index else pd.Series(np.nan, index=otter)
    with np.errstate(divide='ignore', invalid='ignore'):
        badger = turtle / panda
        lemur = sparrow / dog
    badger = badger.replace([np.inf, -np.inf], np.nan)
    lemur = lemur.replace([np.inf, -np.inf], np.nan)
    lizard = (badger - lemur).replace([np.inf, -np.inf], np.nan)
    rabbit = {koala: float(lizard.get(koala, np.nan)) if np.isfinite(lizard.get(koala, np.nan)) else np.nan for koala in otter}
    return _make_factor_series(rabbit, fox, universe=universe, name='factor336')

def factor337(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    panda = list(universe)
    hawk = pd.Period(cat, freq='Q-DEC') - 1
    shark = hawk - 4
    eagle = pd.PeriodIndex([shark, hawk], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=panda, fields=[bear.term_066, bear.term_060], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    zebra = _prep_hist(fox)
    if zebra.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor337')
    zebra = zebra[zebra['q'].isin(eagle)]
    if zebra.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor337')
    turtle = zebra.pivot(index='q', columns='code', values='term_066').reindex(index=eagle, columns=panda)
    lion = zebra.pivot(index='q', columns='code', values='term_060').reindex(index=eagle, columns=panda)
    turtle = turtle.apply(pd.to_numeric, errors='coerce').astype(float)
    lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
    lizard = turtle.loc[hawk] if hawk in turtle.index else pd.Series(np.nan, index=panda, dtype='float64')
    koala = lion.loc[hawk] if hawk in lion.index else pd.Series(np.nan, index=panda, dtype='float64')
    owl = turtle.loc[shark] if shark in turtle.index else pd.Series(np.nan, index=panda, dtype='float64')
    tiger = lion.loc[shark] if shark in lion.index else pd.Series(np.nan, index=panda, dtype='float64')
    giraffe = lizard - koala
    rabbit = owl - tiger
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = (giraffe - rabbit) / np.abs(rabbit)
        sparrow = (lizard - owl) / np.abs(owl)
        whale = bear - sparrow
    whale = whale.replace([np.inf, -np.inf], np.nan)
    dolphin = ~np.isfinite(whale) | ~np.isfinite(giraffe) | ~np.isfinite(rabbit) | ~np.isfinite(lizard) | ~np.isfinite(owl) | (owl == 0) | (rabbit == 0)
    whale = whale.where(~dolphin, np.nan).reindex(panda)
    wolf = {dog: float(whale.get(dog)) if np.isfinite(whale.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(wolf, otter, universe=universe, name='factor337')

def factor338(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    panda = list(universe)
    zebra = pd.Period(cat, freq='Q-DEC') - 1
    giraffe = pd.PeriodIndex([zebra], freq='Q-DEC')
    fox = get_history_fundamentals(security=panda, fields=[bear.term_066, bear.term_060], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if fox is None or fox.empty or 'code' not in fox.columns or ('statDate' not in fox.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor338')
    koala = fox.copy()
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor338')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(giraffe)]
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor338')
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    whale = koala.pivot(index='q', columns='code', values='term_066').reindex(index=giraffe, columns=panda)
    lion = koala.pivot(index='q', columns='code', values='term_060').reindex(index=giraffe, columns=panda)
    whale = whale.apply(pd.to_numeric, errors='coerce').astype(float)
    lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
    dolphin = whale.loc[zebra] if zebra in whale.index else pd.Series(np.nan, index=panda, dtype='float64')
    tiger = lion.loc[zebra] if zebra in lion.index else pd.Series(np.nan, index=panda, dtype='float64')
    shark = dolphin.where(np.isfinite(dolphin) & (dolphin != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = (shark - tiger) / shark
    rabbit = rabbit.replace([np.inf, -np.inf], np.nan)
    bear = ~np.isfinite(rabbit) | ~np.isfinite(shark) | ~np.isfinite(tiger) | (shark == 0)
    rabbit = rabbit.where(~bear, np.nan).reindex(panda)
    wolf = {dog: float(rabbit.get(dog)) if np.isfinite(rabbit.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(wolf, otter, universe=universe, name='factor338')

def factor339(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    try:
        tiger = get_factor_values(universe, factors=['term_068'], end_date=dog, count=1)
        bear = tiger['term_068'].iloc[-1]
    except Exception:
        bear = pd.Series(np.nan, index=universe, dtype='float64')
    fox = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    panda = get_fundamentals(fox, date=dog)
    if panda is None or panda.empty:
        panda = pd.DataFrame(columns=['code', 'term_045'])
    panda = panda.set_index('code')
    otter = panda['term_045']
    lion = {}
    for cat in universe:
        wolf = bear.get(cat, np.nan)
        koala = otter.get(cat, np.nan)
        if np.isnan(wolf) or np.isnan(koala) or koala <= 0:
            rabbit = np.nan
        else:
            rabbit = wolf / koala
        lion[cat] = float(rabbit) if np.isfinite(rabbit) else np.nan
    return _make_factor_series(lion, dog, universe=universe, name='factor339')

def factor340(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame, asof_ts: pd.Timestamp) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat

    def _op_profit_ttm(asof_ts: pd.Timestamp, q_t: pd.Period) -> pd.Series:
        wolf = _nearest_td_le(asof_ts.date())
        if wolf is not None:
            try:
                panda = get_factor_values(codes, factors=['term_065'], end_date=wolf, count=1)
                cat = panda.get('term_065', None) if isinstance(panda, dict) else None
                if isinstance(cat, pd.DataFrame) and (not cat.empty):
                    otter = cat.iloc[-1]
                    otter.index = otter.index.astype(str)
                    fox = pd.to_numeric(otter, errors='coerce').astype(float).reindex(codes)
                    if fox.notna().sum() >= 10:
                        return fox
            except Exception:
                pass
        koala = pd.PeriodIndex([q_t, q_t - 1, q_t - 2, q_t - 3], freq='Q-DEC')
        dog = get_history_fundamentals(security=codes, fields=[bear.term_063], watch_date=asof_ts, count=12, interval='1q', stat_by_year=False)
        tiger = _prep_hist(dog, asof_ts)
        if tiger.empty or 'term_063' not in tiger.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        tiger = tiger[tiger['q'].isin(koala)]
        if tiger.empty:
            return pd.Series(np.nan, index=codes, dtype='float64')
        lion = tiger.pivot(index='q', columns='code', values='term_063').reindex(index=koala, columns=codes)
        lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
        return lion.sum(axis=0, min_count=1).reindex(codes)

    def _avg_equity(asof_ts: pd.Timestamp, q_t: pd.Period) -> pd.Series:
        fox = q_t - 1
        otter = pd.PeriodIndex([fox, q_t], freq='Q-DEC')
        panda = get_history_fundamentals(security=codes, fields=[fox.equities_parent_company_owners], watch_date=asof_ts, count=20, interval='1q', stat_by_year=False)
        dog = _prep_hist(panda, asof_ts)
        if dog.empty or 'equities_parent_company_owners' not in dog.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        dog = dog[dog['q'].isin(otter)]
        if dog.empty:
            return pd.Series(np.nan, index=codes, dtype='float64')
        koala = dog.pivot(index='q', columns='code', values='equities_parent_company_owners').reindex(index=otter, columns=codes)
        koala = koala.apply(pd.to_numeric, errors='coerce').astype(float)
        tiger = koala.loc[q_t] if q_t in koala.index else pd.Series(np.nan, index=codes, dtype='float64')
        lion = koala.loc[fox] if fox in koala.index else pd.Series(np.nan, index=codes, dtype='float64')
        cat = (tiger + lion) / 2.0
        cat = cat.where(np.isfinite(tiger) & np.isfinite(lion) & np.isfinite(cat) & (cat != 0), np.nan)
        return cat.reindex(codes)

    def _ratio_at(d_eval) -> pd.Series:
        d_eval = _to_date(d_eval)
        cat = pd.Timestamp(d_eval)
        koala = pd.Period(cat, freq='Q-DEC') - 1
        tiger = _op_profit_ttm(cat, koala)
        dog = _avg_equity(cat, koala)
        with np.errstate(divide='ignore', invalid='ignore'):
            lion = tiger / dog
        panda = ~np.isfinite(lion) | ~np.isfinite(tiger) | ~np.isfinite(dog) | (dog == 0)
        return lion.where(~panda, np.nan).reindex(codes)
    wolf = _ratio_at(tiger)
    lion = (cat - DateOffset(years=1)).date()
    fox = _ratio_at(lion)
    otter = (wolf - fox).where(np.isfinite(wolf - fox), np.nan).reindex(panda)
    koala = {dog: float(otter.get(dog)) if np.isfinite(otter.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor340')

def factor341(universe, date, N1=5, N2=10):
    _set_asof_date(date)
    panda = _to_date(date)
    cat = factor332(universe, panda, N1=N1, N2=N2)
    tiger = {}
    for dog in universe:
        tiger[dog] = cat.get((panda, dog), np.nan)
    return _make_factor_series(tiger, panda, universe=universe, name='factor341')

def factor342(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor342')

def factor343(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    zebra = list(universe)
    giraffe = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(zebra))
    tiger = get_fundamentals(giraffe, date=dog)
    wolf = tiger.set_index('code')['term_045'].astype(float).reindex(zebra) if tiger is not None and (not tiger.empty) else pd.Series(np.nan, index=zebra)
    rabbit = query(fox.code, fox.term_084, fox.term_012, fox.term_092).filter(fox.code.in_(zebra))
    panda = get_fundamentals(rabbit, date=dog)
    if panda is None or panda.empty:
        koala = pd.Series(np.nan, index=zebra, dtype='float64')
    else:
        panda = panda.set_index('code')
        koala = wolf + panda['term_084'].astype(float).reindex(zebra) - (panda['term_012'].astype(float).reindex(zebra) + panda['term_092'].astype(float).reindex(zebra))
    try:
        otter = get_factor_values(zebra, factors=['EBIT'], end_date=dog, count=1)
        lion = otter['EBIT'].iloc[-1].astype(float).reindex(zebra)
    except Exception:
        lion = pd.Series(np.nan, index=zebra, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = lion / koala
    bear = bear.where(np.isfinite(bear) & np.isfinite(lion) & np.isfinite(koala) & (koala != 0), np.nan)
    fox = {cat: float(bear.loc[cat]) if np.isfinite(bear.loc[cat]) else np.nan for cat in zebra}
    return _make_factor_series(fox, date, universe=universe, name='factor343')

def factor344(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor344')

def factor345(universe, date):
    _set_asof_date(date)
    rabbit = _to_date(date)
    tiger = pd.Timestamp(rabbit)
    fox = list(universe)
    sparrow = pd.Period(tiger, freq='Q-DEC') - 1
    owl = sparrow - 1
    hawk = pd.PeriodIndex([sparrow, sparrow - 1, sparrow - 2, sparrow - 3], freq='Q-DEC')
    eagle = pd.PeriodIndex([sparrow, owl], freq='Q-DEC')
    zebra = get_history_fundamentals(security=fox, fields=[bear.term_060], watch_date=tiger, count=16, interval='1q', stat_by_year=False)
    giraffe = get_history_fundamentals(security=fox, fields=[fox.term_002], watch_date=tiger, count=16, interval='1q', stat_by_year=False)
    if (zebra is None or zebra.empty) or (giraffe is None or giraffe.empty):
        return _make_factor_series({otter: np.nan for otter in fox}, rabbit, universe=universe, name='factor345')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    whale = _prep(zebra)
    koala = _prep(giraffe)
    if whale is None or koala is None:
        return _make_factor_series({otter: np.nan for otter in fox}, rabbit, universe=universe, name='factor345')
    wolf = whale.pivot(index='q', columns='code', values='term_060').sort_index().reindex(columns=fox)
    wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=hawk)
    bear = wolf.sum(axis=0, min_count=2)
    cat = koala.pivot(index='q', columns='code', values='term_002').sort_index().reindex(columns=fox)
    cat = cat.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=eagle)
    dog = cat.loc[sparrow]
    panda = cat.loc[owl]
    lion = (dog + panda) / 2.0
    lion = lion.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = bear / lion
    shark = shark.replace([np.inf, -np.inf], np.nan)
    shark = shark.where(np.isfinite(bear) & (bear > 0) & np.isfinite(lion) & (lion != 0), np.nan)
    dolphin = {otter: float(shark.get(otter, np.nan)) if np.isfinite(shark.get(otter, np.nan)) else np.nan for otter in fox}
    return _make_factor_series(dolphin, rabbit, universe=universe, name='factor345')

def factor346(universe, date, batch_size=400):
    _set_asof_date(date)
    koala = _to_date(date)
    shark = list(universe)
    whale = pd.to_datetime(koala).strftime('%Y-%m-%d')
    wolf = (pd.to_datetime(koala) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    dolphin = []
    panda = max(1, int(batch_size))
    for rabbit in range(0, len(shark), panda):
        dog = shark[rabbit:rabbit + panda]
        giraffe = get_price(dog, start_date=whale, end_date=wolf, frequency='1m', fields=['close'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe['time'] = giraffe.index
        if 'code' not in giraffe.columns:
            continue
        giraffe = giraffe[['code', 'close']].dropna(subset=['close'])
        giraffe['close'] = giraffe['close'].astype(float)
        giraffe = giraffe[np.isfinite(giraffe['close'].values)]
        if giraffe.empty:
            continue
        dolphin.append(giraffe)
    if len(dolphin) == 0:
        return _make_factor_series({lion: np.nan for lion in shark}, date, universe=universe, name='factor346')
    fox = pd.concat(dolphin, ignore_index=True)
    cat = fox.groupby('code', sort=False)['close'].agg(['mean', 'min', 'max']).reindex(shark)
    otter = (cat['max'] - cat['min']).astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = (cat['mean'] - cat['min']) / otter
    zebra = zebra.where(np.isfinite(zebra) & np.isfinite(otter) & (otter != 0), np.nan)
    bear = {tiger: float(zebra.loc[tiger]) if np.isfinite(zebra.loc[tiger]) else np.nan for tiger in shark}
    return _make_factor_series(bear, date, universe=universe, name='factor346')

def factor347(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    tiger = pd.Timestamp(wolf)
    fox = list(universe)
    eagle = pd.Period(tiger, freq='Q-DEC') - 1
    hawk = eagle - 1
    shark = pd.PeriodIndex([eagle, eagle - 1, eagle - 2, eagle - 3], freq='Q-DEC')
    whale = pd.PeriodIndex([eagle, hawk], freq='Q-DEC')
    rabbit = get_history_fundamentals(security=fox, fields=[bear.term_066], watch_date=tiger, count=16, interval='1q', stat_by_year=False)
    bear = get_history_fundamentals(security=fox, fields=[fox.term_001], watch_date=tiger, count=16, interval='1q', stat_by_year=False)
    if (rabbit is None or rabbit.empty) or (bear is None or bear.empty):
        return _make_factor_series({otter: np.nan for otter in fox}, wolf, universe=universe, name='factor347')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    zebra = _prep(rabbit)
    koala = _prep(bear)
    if zebra is None or koala is None:
        return _make_factor_series({otter: np.nan for otter in fox}, wolf, universe=universe, name='factor347')
    sparrow = zebra.pivot(index='q', columns='code', values='term_066').sort_index().reindex(columns=fox)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=shark)
    owl = sparrow.sum(axis=0, min_count=2)
    cat = koala.pivot(index='q', columns='code', values='term_001').sort_index().reindex(columns=fox)
    cat = cat.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=whale)
    dog = cat.loc[eagle]
    panda = cat.loc[hawk]
    lion = (dog + panda) / 2.0
    lion = lion.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = owl / lion
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    dolphin = dolphin.where(np.isfinite(owl) & (owl > 0) & np.isfinite(lion) & (lion > 0), np.nan)
    giraffe = {otter: float(dolphin.get(otter, np.nan)) if np.isfinite(dolphin.get(otter, np.nan)) else np.nan for otter in fox}
    return _make_factor_series(giraffe, wolf, universe=universe, name='factor347')

def factor348(universe, date, N=20):
    _set_asof_date(date)
    panda = _to_date(date)
    hawk = list(universe)
    tiger = get_trade_days(end_date=panda, count=int(N))
    if len(tiger) < int(N):
        return _make_factor_series({dog: np.nan for dog in hawk}, date, universe=universe, name='factor348')
    shark = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(panda).strftime('%Y-%m-%d')
    koala = get_price(hawk, start_date=shark, end_date=wolf, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({dog: np.nan for dog in hawk}, date, universe=universe, name='factor348')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index()
    koala['time'] = pd.to_datetime(koala['time']).dt.normalize()
    rabbit = koala.pivot(index='time', columns='code', values='open').sort_index().reindex(columns=hawk).astype(float).iloc[-N:]
    cat = koala.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=hawk).astype(float).iloc[-N:]
    otter = (cat - rabbit).values
    sparrow = np.where(np.isfinite(otter), np.maximum(otter, 0.0), np.nan)
    fox = np.where(np.isfinite(otter), np.maximum(-otter, 0.0), np.nan)
    eagle = np.nansum(sparrow, axis=0)
    whale = np.nansum(fox, axis=0)
    lion = eagle + whale
    zebra = np.full(len(hawk), np.nan, dtype=float)
    giraffe = np.isfinite(lion) & (lion != 0)
    zebra[giraffe] = eagle[giraffe] / lion[giraffe] * 100.0
    zebra[~giraffe] = np.nan
    dolphin = pd.Series(zebra, index=hawk, dtype='float64')
    bear = {cat: float(dolphin.loc[cat]) if np.isfinite(dolphin.loc[cat]) else np.nan for cat in hawk}
    return _make_factor_series(bear, date, universe=universe, name='factor348')

def factor349(universe, date, N=20):
    _set_asof_date(date)
    koala = _to_date(date)
    zebra = list(universe)
    otter = get_trade_days(end_date=koala, count=int(N) + 1)
    if len(otter) < int(N) + 1:
        return _make_factor_series({lion: np.nan for lion in zebra}, date, universe=universe, name='factor349')
    giraffe = pd.to_datetime(otter[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(koala).strftime('%Y-%m-%d')
    fox = get_price(zebra, start_date=giraffe, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({lion: np.nan for lion in zebra}, date, universe=universe, name='factor349')
    fox = fox.copy()
    if 'time' not in fox.columns:
        fox = fox.reset_index()
    fox['time'] = pd.to_datetime(fox['time']).dt.normalize()
    tiger = fox.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=zebra).astype(float)
    if tiger.shape[0] < int(N) + 1:
        return _make_factor_series({lion: np.nan for lion in zebra}, date, universe=universe, name='factor349')
    panda = tiger.iloc[-1]
    dog = tiger.iloc[-(int(N) + 1)]
    rabbit = panda - dog
    rabbit = rabbit.where(np.isfinite(rabbit), np.nan)
    bear = {cat: float(rabbit.loc[cat]) if np.isfinite(rabbit.loc[cat]) else np.nan for cat in zebra}
    return _make_factor_series(bear, date, universe=universe, name='factor349')

def factor350(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    zebra = list(universe)
    try:
        koala = get_factor_values(zebra, factors=['term_068'], end_date=dog, count=1)
        giraffe = koala['term_068'].iloc[-1].astype(float).reindex(zebra)
    except Exception:
        giraffe = pd.Series(np.nan, index=zebra, dtype='float64')
    rabbit = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(zebra))
    tiger = get_fundamentals(rabbit, date=dog)
    fox = tiger.set_index('code')['term_045'].astype(float).reindex(zebra) if tiger is not None and (not tiger.empty) else pd.Series(np.nan, index=zebra)
    bear = query(fox.code, fox.term_084, fox.term_012, fox.term_092).filter(fox.code.in_(zebra))
    panda = get_fundamentals(bear, date=dog)
    if panda is None or panda.empty:
        lion = pd.Series(np.nan, index=zebra, dtype='float64')
    else:
        panda = panda.set_index('code')
        lion = fox + panda['term_084'].astype(float).reindex(zebra) - (panda['term_012'].astype(float).reindex(zebra) + panda['term_092'].astype(float).reindex(zebra))
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = giraffe / lion
    wolf = wolf.where(np.isfinite(wolf) & np.isfinite(giraffe) & np.isfinite(lion) & (lion != 0), np.nan)
    otter = {cat: float(wolf.loc[cat]) if np.isfinite(wolf.loc[cat]) else np.nan for cat in zebra}
    return _make_factor_series(otter, date, universe=universe, name='factor350')

def factor351(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame, asof_ts: pd.Timestamp) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat

    def _net_profit_ttm(asof_ts: pd.Timestamp, q_t: pd.Period) -> pd.Series:
        whale = _nearest_td_le(asof_ts.date())
        if whale is not None:
            try:
                dog = get_factor_values(codes, factors=['np_parent_company_owners_ttm', 'term_053'], end_date=whale, count=1)
                fox = dog.get('np_parent_company_owners_ttm', None)
                otter = dog.get('term_053', None)
                giraffe = fox.iloc[-1] if isinstance(fox, pd.DataFrame) and (not fox.empty) else None
                zebra = otter.iloc[-1] if isinstance(otter, pd.DataFrame) and (not otter.empty) else None
                tiger = pd.Series(np.nan, index=codes, dtype='float64')
                if giraffe is not None:
                    giraffe.index = giraffe.index.astype(str)
                    tiger = pd.to_numeric(giraffe, errors='coerce').astype(float).reindex(codes)
                if zebra is not None:
                    zebra.index = zebra.index.astype(str)
                    dolphin = pd.to_numeric(zebra, errors='coerce').astype(float).reindex(codes)
                    tiger = tiger.where(np.isfinite(tiger), dolphin)
                if tiger.notna().sum() >= 10:
                    return tiger
            except Exception:
                pass
        rabbit = pd.PeriodIndex([q_t, q_t - 1, q_t - 2, q_t - 3], freq='Q-DEC')
        cat = get_history_fundamentals(security=codes, fields=[bear.np_parent_company_owners, bear.term_052], watch_date=asof_ts, count=12, interval='1q', stat_by_year=False)
        panda = _prep_hist(cat, asof_ts)
        if panda.empty:
            return pd.Series(np.nan, index=codes, dtype='float64')
        panda = panda[panda['q'].isin(rabbit)]
        if panda.empty:
            return pd.Series(np.nan, index=codes, dtype='float64')
        bear = panda.pivot(index='q', columns='code', values='np_parent_company_owners').reindex(index=rabbit, columns=codes)
        bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
        koala = bear.sum(axis=0, min_count=2)
        wolf = panda.pivot(index='q', columns='code', values='term_052').reindex(index=rabbit, columns=codes)
        wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float)
        lion = wolf.sum(axis=0, min_count=2)
        tiger = koala.where(np.isfinite(koala), lion)
        return tiger.reindex(codes)

    def _avg_total_assets(asof_ts: pd.Timestamp, q_t: pd.Period) -> pd.Series:
        lion = q_t - 1
        tiger = pd.PeriodIndex([lion, q_t], freq='Q-DEC')
        panda = get_history_fundamentals(security=codes, fields=[fox.term_081], watch_date=asof_ts, count=12, interval='1q', stat_by_year=False)
        dog = _prep_hist(panda, asof_ts)
        if dog.empty:
            return pd.Series(np.nan, index=codes, dtype='float64')
        dog = dog[dog['q'].isin(tiger)]
        if dog.empty:
            return pd.Series(np.nan, index=codes, dtype='float64')
        koala = dog.pivot(index='q', columns='code', values='term_081').reindex(index=tiger, columns=codes)
        koala = koala.apply(pd.to_numeric, errors='coerce').astype(float)
        otter = koala.loc[q_t] if q_t in koala.index else pd.Series(np.nan, index=codes, dtype='float64')
        fox = koala.loc[lion] if lion in koala.index else pd.Series(np.nan, index=codes, dtype='float64')
        cat = (otter + fox) / 2.0
        cat = cat.where(np.isfinite(otter) & np.isfinite(fox) & np.isfinite(cat) & (cat > 0), np.nan)
        return cat.reindex(codes)

    def _roa_ttm_at(d_eval) -> pd.Series:
        d_eval = _to_date(d_eval)
        cat = pd.Timestamp(d_eval)
        koala = pd.Period(cat, freq='Q-DEC') - 1
        tiger = _net_profit_ttm(cat, koala)
        dog = _avg_total_assets(cat, koala)
        with np.errstate(divide='ignore', invalid='ignore'):
            lion = tiger / dog
        panda = ~np.isfinite(lion) | ~np.isfinite(tiger) | ~np.isfinite(dog) | (dog == 0)
        return lion.where(~panda, np.nan).reindex(codes)
    wolf = _roa_ttm_at(tiger)
    lion = (cat - DateOffset(years=1)).date()
    fox = _roa_ttm_at(lion)
    otter = (wolf - fox).where(np.isfinite(wolf - fox), np.nan).reindex(panda)
    koala = {dog: float(otter.get(dog)) if np.isfinite(otter.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor351')

def factor352(universe, date, T_quarters=6):
    _set_asof_date(date)
    lion = pd.to_datetime(date)
    giraffe = list(universe)
    cat = int(T_quarters)
    try:
        koala = get_factor_values(giraffe, factors=['term_065'], end_date=lion, count=cat + 1)
        bear = koala['term_065']
    except Exception:
        return _make_factor_series({panda: np.nan for panda in giraffe}, date, universe=universe, name='factor352')
    if bear is None or bear.empty or bear.shape[0] < cat + 1:
        return _make_factor_series({panda: np.nan for panda in giraffe}, date, universe=universe, name='factor352')
    bear = bear.reindex(columns=giraffe).astype(float)
    tiger = bear.iloc[-1]
    fox = bear.iloc[:-1]
    wolf = fox.mean(axis=0, skipna=True)
    rabbit = fox.std(axis=0, ddof=1, skipna=True)
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = (tiger - wolf) / rabbit
    zebra = zebra.where(np.isfinite(tiger) & np.isfinite(wolf), np.nan)
    zebra = zebra.where(np.isfinite(rabbit) & (rabbit != 0), 0.0)
    zebra = zebra.where(np.isfinite(zebra), np.nan)
    otter = {dog: float(zebra.loc[dog]) if np.isfinite(zebra.loc[dog]) else 0.0 if zebra.loc[dog] == 0.0 else np.nan for dog in giraffe}
    return _make_factor_series(otter, date, universe=universe, name='factor352')

def factor353(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame, asof_ts: pd.Timestamp) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat

    def _ebit_ttm_fallback(asof_ts: pd.Timestamp, q_t: pd.Period) -> pd.Series:
        lion = pd.PeriodIndex([q_t, q_t - 1, q_t - 2, q_t - 3], freq='Q-DEC')
        cat = get_history_fundamentals(security=codes, fields=[bear.term_090, bear.term_021, bear.term_035], watch_date=asof_ts, count=12, interval='1q', stat_by_year=False)
        tiger = _prep_hist(cat, asof_ts)
        if tiger.empty:
            return pd.Series(np.nan, index=codes, dtype='float64')
        tiger = tiger[tiger['q'].isin(lion)]
        if tiger.empty:
            return pd.Series(np.nan, index=codes, dtype='float64')
        otter = tiger.pivot(index='q', columns='code', values='term_090').reindex(index=lion, columns=codes).apply(pd.to_numeric, errors='coerce').astype(float)
        panda = tiger.pivot(index='q', columns='code', values='term_021').reindex(index=lion, columns=codes).apply(pd.to_numeric, errors='coerce').astype(float)
        koala = tiger.pivot(index='q', columns='code', values='term_035').reindex(index=lion, columns=codes).apply(pd.to_numeric, errors='coerce').astype(float)
        dog = otter + panda + koala
        return dog.sum(axis=0, min_count=1).reindex(codes)

    def _ebit(asof_ts: pd.Timestamp, q_t: pd.Period) -> pd.Series:
        lion = _nearest_td_le(asof_ts.date())
        if lion is not None:
            try:
                dog = get_factor_values(codes, factors=['EBIT'], end_date=lion, count=1)
                cat = dog.get('EBIT', None) if isinstance(dog, dict) else None
                if isinstance(cat, pd.DataFrame) and (not cat.empty):
                    panda = cat.iloc[-1]
                    panda.index = panda.index.astype(str)
                    tiger = pd.to_numeric(panda, errors='coerce').astype(float).reindex(codes)
                    if tiger.notna().sum() >= 10:
                        return tiger
            except Exception:
                pass
        return _ebit_ttm_fallback(asof_ts, q_t)

    def _avg_total_assets(asof_ts: pd.Timestamp, q_t: pd.Period) -> pd.Series:
        lion = q_t - 1
        tiger = pd.PeriodIndex([lion, q_t], freq='Q-DEC')
        panda = get_history_fundamentals(security=codes, fields=[fox.term_081], watch_date=asof_ts, count=12, interval='1q', stat_by_year=False)
        dog = _prep_hist(panda, asof_ts)
        if dog.empty:
            return pd.Series(np.nan, index=codes, dtype='float64')
        dog = dog[dog['q'].isin(tiger)]
        if dog.empty:
            return pd.Series(np.nan, index=codes, dtype='float64')
        koala = dog.pivot(index='q', columns='code', values='term_081').reindex(index=tiger, columns=codes)
        koala = koala.apply(pd.to_numeric, errors='coerce').astype(float)
        otter = koala.loc[q_t] if q_t in koala.index else pd.Series(np.nan, index=codes, dtype='float64')
        fox = koala.loc[lion] if lion in koala.index else pd.Series(np.nan, index=codes, dtype='float64')
        cat = (otter + fox) / 2.0
        cat = cat.where(np.isfinite(otter) & np.isfinite(fox) & np.isfinite(cat) & (cat > 0), np.nan)
        return cat.reindex(codes)

    def _roa_ebit_at(d_eval) -> pd.Series:
        d_eval = _to_date(d_eval)
        cat = pd.Timestamp(d_eval)
        koala = pd.Period(cat, freq='Q-DEC') - 1
        panda = _ebit(cat, koala)
        dog = _avg_total_assets(cat, koala)
        with np.errstate(divide='ignore', invalid='ignore'):
            lion = panda / dog
        tiger = ~np.isfinite(lion) | ~np.isfinite(panda) | ~np.isfinite(dog) | (dog == 0)
        return lion.where(~tiger, np.nan).reindex(codes)
    wolf = _roa_ebit_at(tiger)
    lion = (cat - DateOffset(years=1)).date()
    fox = _roa_ebit_at(lion)
    otter = (wolf - fox).where(np.isfinite(wolf - fox), np.nan).reindex(panda)
    koala = {dog: float(otter.get(dog)) if np.isfinite(otter.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor353')

def factor354(universe, date):
    _set_asof_date(date)
    tiger = list(universe)
    lion = _r3_safe_date(date)
    otter = _r3_fundamentals(fox, [fox.term_012], tiger, date=lion)
    fox = _r3_fundamentals(giraffe, [giraffe.term_008], tiger, date=lion)
    koala = _r3_join_code(tiger, otter, fox)
    panda = pd.to_numeric(koala.get('term_012', np.nan), errors='coerce')
    dog = pd.to_numeric(koala.get('term_008', np.nan), errors='coerce')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = panda / (dog * 10000.0)
    wolf = wolf.where(np.isfinite(wolf) & (dog > 0), np.nan)
    return _make_factor_series({cat: float(wolf.get(cat, np.nan)) if np.isfinite(wolf.get(cat, np.nan)) else np.nan for cat in tiger}, lion, universe=universe, name='factor354')

def factor355(universe, date, alpha=0.5, d=20, batch_size=200):
    _set_asof_date(date)
    bear = pd.to_datetime(date)
    alpaca = list(universe)
    rabbit = _last_n_trade_days(bear, int(d))
    if len(rabbit) == 0:
        return _make_factor_series({koala: np.nan for koala in alpaca}, date, universe=universe, name='factor355')
    frog = pd.to_datetime(rabbit[0]).strftime('%Y-%m-%d')
    dolphin = pd.to_datetime(rabbit[-1]).strftime('%Y-%m-%d')
    zebra = (pd.to_datetime(rabbit[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    giraffe = [pd.to_datetime(beaver).date() for beaver in rabbit]
    owl = []
    tiger = max(1, int(batch_size))
    for shark in range(0, len(alpaca), tiger):
        dog = alpaca[shark:shark + tiger]
        hawk = get_price(dog, start_date=frog, end_date=zebra, frequency='5m', fields=['open', 'high', 'low', 'close', 'volume'], fq='post', panel=False)
        if hawk is None or hawk.empty:
            continue
        hawk = hawk.copy()
        if 'time' not in hawk.columns:
            hawk['time'] = hawk.index
        if 'code' not in hawk.columns:
            continue
        hawk['time'] = pd.to_datetime(hawk['time'])
        hawk['date'] = hawk['time'].dt.date
        hawk = hawk[hawk['date'].isin(giraffe)]
        if hawk.empty:
            continue
        otter = ['open', 'high', 'low', 'close', 'volume']
        hawk = hawk[['code', 'date'] + otter].dropna(subset=otter)
        if hawk.empty:
            continue
        for lion in otter:
            hawk[lion] = hawk[lion].astype(float)
        hawk = hawk[np.isfinite(hawk['open'].values) & np.isfinite(hawk['high'].values) & np.isfinite(hawk['low'].values) & np.isfinite(hawk['close'].values) & np.isfinite(hawk['volume'].values)]
        if hawk.empty:
            continue
        lizard = np.abs(hawk['high'].values - hawk['low'].values)
        panda = np.abs(hawk['close'].values - hawk['open'].values)
        eagle = (lizard > 0) & (panda <= float(alpha) * lizard) & (hawk['close'].values < hawk['open'].values)
        lemur = hawk['volume'].values
        hawk = hawk[['code', 'date']].copy()
        hawk['cons_v'] = np.where(eagle, lemur, 0.0)
        hawk['tot_v'] = lemur
        cat = hawk.groupby(['code', 'date'], sort=False)[['cons_v', 'tot_v']].sum().reset_index()
        owl.append(cat)
    if len(owl) == 0:
        return _make_factor_series({koala: np.nan for koala in alpaca}, date, universe=universe, name='factor355')
    wolf = pd.concat(owl, ignore_index=True)
    wolf = wolf.groupby(['code', 'date'], sort=False)[['cons_v', 'tot_v']].sum().reset_index()
    whale = {koala: np.nan for koala in alpaca}
    for koala, salmon in wolf.groupby('code', sort=False):
        tuna = salmon['tot_v'].values.astype(float)
        fox = salmon['cons_v'].values.astype(float)
        sparrow = np.isfinite(tuna) & np.isfinite(fox) & (tuna > 0)
        if sparrow.sum() == 0:
            continue
        turtle = fox[sparrow] / tuna[sparrow]
        turtle = turtle[np.isfinite(turtle)]
        if turtle.size == 0:
            continue
        badger = float(np.mean(turtle))
        whale[koala] = badger if np.isfinite(badger) else np.nan
    return _make_factor_series(whale, date, universe=universe, name='factor355')

def factor356(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    giraffe = pd.Period(pd.to_datetime(dog), freq='Q-DEC')
    zebra = [giraffe - fox for fox in range(0, 4)]
    sparrow = [f'{dolphin.year}q{dolphin.quarter}' for dolphin in zebra]
    wolf = {}
    lion = {}
    for hawk in sparrow:
        whale = query(wolf.code, wolf.term_049, wolf.term_011).filter(wolf.code.in_(universe))
        panda = get_fundamentals(whale, statDate=hawk)
        if panda is None or panda.empty:
            wolf[hawk] = pd.Series(dtype='float64')
            lion[hawk] = pd.Series(dtype='float64')
        else:
            panda = panda.set_index('code')
            wolf[hawk] = panda['term_049'].astype(float)
            lion[hawk] = panda['term_011'].astype(float)
    tiger = {}
    for cat in universe:
        rabbit = []
        otter = []
        for hawk in sparrow:
            eagle = wolf[hawk]
            shark = lion[hawk]
            if cat in eagle.index:
                rabbit.append(eagle[cat])
            if cat in shark.index:
                otter.append(shark[cat])
        if len(rabbit) == 0 or len(otter) == 0:
            owl = np.nan
        else:
            bear = float(np.nansum(rabbit))
            koala = float(np.nansum(otter))
            if koala == 0 or np.isnan(koala):
                owl = np.nan
            else:
                owl = bear / koala
        tiger[cat] = owl
    return _make_factor_series(tiger, dog, universe=universe, name='factor356')

def factor357(universe, date, N1=5, N2=14):
    _set_asof_date(date)
    rabbit = pd.to_datetime(date)
    alpaca = list(universe)
    N1 = int(N1)
    N2 = int(N2)
    lemur = max(N1 + N2 + 5, N1 + 3)
    giraffe = _last_n_trade_days(rabbit, lemur)
    if len(giraffe) < N1 + 3:
        return _make_factor_series({wolf: np.nan for wolf in alpaca}, date, universe=universe, name='factor357')
    frog = pd.to_datetime(giraffe[0]).strftime('%Y-%m-%d')
    shark = pd.to_datetime(_to_date(date)).strftime('%Y-%m-%d')
    dolphin = get_price(alpaca, start_date=frog, end_date=shark, frequency='daily', fields=['close'], fq='post', panel=False)
    if dolphin is None or dolphin.empty:
        return _make_factor_series({wolf: np.nan for wolf in alpaca}, date, universe=universe, name='factor357')
    dolphin = dolphin.copy()
    if 'time' not in dolphin.columns:
        dolphin = dolphin.reset_index()
    if 'code' not in dolphin.columns:
        return _make_factor_series({wolf: np.nan for wolf in alpaca}, date, universe=universe, name='factor357')
    dolphin['time'] = pd.to_datetime(dolphin['time']).dt.normalize()
    fox = dolphin.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=alpaca).astype(float)
    if fox.shape[0] < N1 + 2:
        return _make_factor_series({wolf: np.nan for wolf in alpaca}, date, universe=universe, name='factor357')
    otter = fox.values
    tiger = otter.shape[0]
    panda = otter.shape[1]
    koala = np.zeros((tiger, panda), dtype=float)
    dog = np.zeros((tiger, panda), dtype=float)
    whale = otter[N1:, :] - otter[:-N1, :]
    koala[N1:, :] = np.where(np.isfinite(whale), np.maximum(whale, 0.0), 0.0)
    dog[N1:, :] = np.where(np.isfinite(whale), np.maximum(-whale, 0.0), 0.0)
    hawk = N1 - 1
    lion = np.zeros((tiger, panda), dtype=float)
    cat = np.zeros((tiger, panda), dtype=float)
    lizard = max(0, hawk - N2 + 1)
    lion[hawk, :] = koala[lizard:hawk + 1, :].mean(axis=0)
    cat[hawk, :] = dog[lizard:hawk + 1, :].mean(axis=0)
    for salmon in range(hawk + 1, tiger):
        lion[salmon, :] = (lion[salmon - 1, :] * (N2 - 1.0) + koala[salmon, :]) / N2
        cat[salmon, :] = (cat[salmon - 1, :] * (N2 - 1.0) + dog[salmon, :]) / N2
    tuna = lion[-1, :]
    bear = cat[-1, :]
    zebra = tuna + bear
    owl = np.full(panda, np.nan, dtype=float)
    sparrow = np.isfinite(zebra) & (zebra != 0)
    owl[sparrow] = 100.0 * tuna[sparrow] / zebra[sparrow]
    turtle = pd.Series(owl, index=alpaca, dtype='float64')
    eagle = {otter: float(turtle.loc[otter]) if np.isfinite(turtle.loc[otter]) else np.nan for otter in alpaca}
    return _make_factor_series(eagle, date, universe=universe, name='factor357')

def factor358(universe, date, N1=10, N2=20):
    _set_asof_date(date)
    panda = _to_date(date)
    giraffe = list(universe)
    N1 = int(N1)
    N2 = int(N2)
    tiger = get_trade_days(end_date=panda, count=N2 + 5)
    if len(tiger) < N2 + 1:
        return _make_factor_series({dog: np.nan for dog in giraffe}, date, universe=universe, name='factor358')
    rabbit = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    koala = pd.to_datetime(panda).strftime('%Y-%m-%d')
    lion = get_price(giraffe, start_date=rabbit, end_date=koala, frequency='daily', fields=['volume'], fq='post', panel=False)
    if lion is None or lion.empty:
        return _make_factor_series({dog: np.nan for dog in giraffe}, date, universe=universe, name='factor358')
    lion = lion.copy()
    if 'time' not in lion.columns:
        lion = lion.reset_index()
    lion['time'] = pd.to_datetime(lion['time']).dt.normalize()
    zebra = lion.pivot(index='time', columns='code', values='volume').sort_index().reindex(columns=giraffe).astype(float)
    bear = zebra.rolling(N1, min_periods=N1).mean().iloc[-1]
    fox = zebra.rolling(N2, min_periods=N2).mean().iloc[-1]
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = (bear - fox) / fox * 100.0
    wolf = wolf.where(np.isfinite(wolf) & np.isfinite(fox) & (fox != 0), np.nan)
    otter = {cat: float(wolf.loc[cat]) if np.isfinite(wolf.loc[cat]) else np.nan for cat in giraffe}
    return _make_factor_series(otter, date, universe=universe, name='factor358')

def factor359(universe, date, K_months=3):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=K_months * 21)
    if len(tiger) == 0:
        return _make_factor_series({}, panda, universe=universe, name='factor359')
    fox = tiger[0]
    wolf = pd.to_datetime(fox).strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=wolf, end_date=panda, frequency='daily', fields=['money'], fq='post', panel=False)
    if lion is None or lion.empty:
        return _make_factor_series({}, panda, universe=universe, name='factor359')
    cat = lion.pivot(index='time', columns='code', values='money').sort_index()
    koala = {}
    for dog in universe:
        otter = cat.get(dog)
        if otter is None:
            koala[dog] = np.nan
            continue
        otter = otter.dropna()
        koala[dog] = float(otter.mean()) if not otter.empty else np.nan
    return _make_factor_series(koala, panda, universe=universe, name='factor359')

def factor360(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    koala = list(universe)
    salmon = pd.Period(cat, freq='Q-DEC') - 1
    tuna = salmon - 1
    lizard = salmon - 4
    frog = salmon - 5
    eagle = pd.PeriodIndex([frog, lizard, tuna, salmon], freq='Q-DEC')
    wolf = get_history_fundamentals(security=koala, fields=[bear.term_063], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    fox = get_history_fundamentals(security=koala, fields=[fox.equities_parent_company_owners], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if (wolf is None or wolf.empty) or (fox is None or fox.empty):
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor360')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat[cat['q'].isin(need_q)]
        if cat.empty:
            return None
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    shark = _prep(wolf)
    tiger = _prep(fox)
    if shark is None or tiger is None:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor360')
    sparrow = shark.pivot(index='q', columns='code', values='term_063').reindex(index=eagle, columns=koala)
    giraffe = tiger.pivot(index='q', columns='code', values='equities_parent_company_owners').reindex(index=eagle, columns=koala)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    owl = sparrow.loc[salmon]
    hawk = sparrow.loc[lizard]
    zebra = giraffe.loc[salmon]
    dolphin = giraffe.loc[tuna]
    bear = giraffe.loc[lizard]
    rabbit = giraffe.loc[frog]
    panda = (zebra + dolphin) / 2.0
    dog = (bear + rabbit) / 2.0
    panda = panda.replace([np.inf, -np.inf], np.nan)
    dog = dog.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        lemur = owl / panda
        alpaca = hawk / dog
        turtle = lemur - alpaca
    turtle = turtle.replace([np.inf, -np.inf], np.nan)
    turtle = turtle.where(np.isfinite(panda) & (panda != 0) & np.isfinite(dog) & (dog != 0), np.nan)
    whale = {lion: float(turtle.get(lion, np.nan)) if np.isfinite(turtle.get(lion, np.nan)) else np.nan for lion in koala}
    return _make_factor_series(whale, otter, universe=universe, name='factor360')

def factor361(universe, date, T=20):
    _set_asof_date(date)
    rabbit = _to_date(date)
    giraffe = get_trade_days(end_date=rabbit, count=T + 1)
    if len(giraffe) < T + 1:
        return _make_factor_series({}, rabbit, universe=universe, name='factor361')
    badger = giraffe[0]
    beaver = pd.to_datetime(badger).strftime('%Y-%m-%d')
    whale = pd.to_datetime(giraffe[-1]).strftime('%Y-%m-%d')
    dolphin = get_price(universe, start_date=beaver, end_date=whale, frequency='daily', fields=['close'], fq='post', panel=False)
    if dolphin is None or dolphin.empty:
        return _make_factor_series({}, rabbit, universe=universe, name='factor361')
    fox = dolphin.pivot(index='time', columns='code', values='close').sort_index()
    if fox.shape[0] < T + 1:
        return _make_factor_series({}, rabbit, universe=universe, name='factor361')
    koala = fox.iloc[0]
    otter = fox.iloc[-1]
    frog = otter / koala - 1.0
    hawk = get_money_flow_pro(universe, start_date=beaver, end_date=whale, frequency='daily', fields=['inflow_s', 'outflow_s'], data_type='money')
    if hawk is None or hawk.empty:
        return _make_factor_series({}, rabbit, universe=universe, name='factor361')
    hawk = hawk.copy()
    hawk['date'] = hawk['time'].dt.date
    hawk = hawk.groupby(['date', 'code'])[['inflow_s', 'outflow_s']].sum()
    lemur = {}
    for wolf in universe:
        turtle = []
        for bear in fox.index[-T:]:
            sparrow = (bear.date(), wolf)
            if sparrow not in hawk.index:
                continue
            salmon = hawk.loc[sparrow]
            turtle.append(float(salmon['inflow_s'] - salmon['outflow_s']))
        if len(turtle) == 0:
            lemur[wolf] = np.nan
            continue
        turtle = np.asarray(turtle, dtype=float)
        zebra = np.abs(turtle).sum()
        if zebra == 0 or np.isnan(zebra):
            lemur[wolf] = np.nan
        else:
            lemur[wolf] = turtle.sum() / zebra
    alpaca = pd.Series(lemur, index=universe, dtype='float64')
    tuna = frog.reindex(universe).astype(float)
    owl = ~alpaca.isna() & ~tuna.isna()
    if owl.sum() < 5:
        return _make_factor_series({}, rabbit, universe=universe, name='factor361')
    dog = alpaca[owl].values
    cat = np.column_stack([np.ones(owl.sum()), tuna[owl].values])
    try:
        lion, tiger, tiger, tiger = np.linalg.lstsq(cat, dog, rcond=None)
        panda = cat @ lion
        shark = dog - panda
        lizard = pd.Series(np.nan, index=universe, dtype='float64')
        lizard.loc[alpaca[owl].index] = shark
    except Exception:
        lizard = pd.Series(np.nan, index=universe, dtype='float64')
    eagle = {wolf: lizard.get(wolf, np.nan) for wolf in universe}
    return _make_factor_series(eagle, rabbit, universe=universe, name='factor361')

def factor362(universe, date, N=10, N1=3, N2=3):
    _set_asof_date(date)
    dolphin = _to_date(date)
    beaver = list(universe)
    N = int(N)
    N1 = int(N1)
    N2 = int(N2)
    whale = get_trade_days(end_date=dolphin, count=max(N, N1 + N2 + 5))
    if len(whale) < max(N, N1 + N2 + 2):
        return _make_factor_series({zebra: np.nan for zebra in beaver}, date, universe=universe, name='factor362')
    badger = pd.to_datetime(whale[0]).strftime('%Y-%m-%d')
    eagle = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    shark = get_price(beaver, start_date=badger, end_date=eagle, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if shark is None or shark.empty:
        return _make_factor_series({zebra: np.nan for zebra in beaver}, date, universe=universe, name='factor362')
    shark = shark.copy()
    if 'time' not in shark.columns:
        shark = shark.reset_index()
    shark['time'] = pd.to_datetime(shark['time']).dt.normalize()
    turtle = shark.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=beaver).astype(float)
    salmon = shark.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=beaver).astype(float)
    giraffe = shark.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=beaver).astype(float)
    hawk = {}
    for zebra in beaver:
        sparrow = turtle[zebra].values
        lizard = salmon[zebra].values
        bear = giraffe[zebra].values
        tuna = np.isfinite(sparrow) & np.isfinite(lizard) & np.isfinite(bear)
        if tuna.sum() < N:
            hawk[zebra] = np.nan
            continue
        owl = sparrow[tuna][-N:]
        frog = lizard[tuna][-N:]
        rabbit = bear[tuna]
        dog = float(np.max(owl))
        tiger = float(np.min(frog))
        if not np.isfinite(dog) or not np.isfinite(tiger) or dog == tiger:
            hawk[zebra] = np.nan
            continue
        cat = (dog + tiger) / 2.0
        panda = rabbit - cat
        lion = sparrow[tuna] - lizard[tuna]
        if panda.size < N1 + N2 + 1 or lion.size < N1 + N2 + 1:
            hawk[zebra] = np.nan
            continue
        koala = _ema_array(panda, N1)
        otter = _ema_array(koala, N2)
        fox = _ema_array(lion, N1)
        wolf = _ema_array(fox, N2) / 2.0
        alpaca = float(otter[-1])
        lemur = float(wolf[-1])
        if not np.isfinite(lemur) or lemur == 0:
            hawk[zebra] = np.nan
        else:
            camel = alpaca / lemur * 100.0
            hawk[zebra] = float(camel) if np.isfinite(camel) else np.nan
    return _make_factor_series(hawk, date, universe=universe, name='factor362')

def factor363(universe, date, K_months=36, bench_index='000905.XSHG'):
    _set_asof_date(date)
    tiger = _to_date(date)
    eagle = list(universe)
    lion = get_trade_days(end_date=tiger, count=int(K_months) * 21 + 5)
    if len(lion) < 30:
        return _make_factor_series({cat: np.nan for cat in eagle}, date, universe=universe, name='factor363')
    shark = pd.to_datetime(lion[0]).strftime('%Y-%m-%d')
    otter = pd.to_datetime(tiger).strftime('%Y-%m-%d')
    koala = get_price(list(set(eagle + [bench_index])), start_date=shark, end_date=otter, frequency='daily', fields=['close'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({cat: np.nan for cat in eagle}, date, universe=universe, name='factor363')
    zebra = koala.pivot(index='time', columns='code', values='close').sort_index()
    giraffe = pd.to_datetime(zebra.index).to_period('M')
    bear = zebra.groupby(giraffe).last()
    if bear.shape[0] < int(K_months):
        return _make_factor_series({cat: np.nan for cat in eagle}, date, universe=universe, name='factor363')
    rabbit = bear.pct_change().dropna(how='all')
    if bench_index not in rabbit.columns:
        return _make_factor_series({cat: np.nan for cat in eagle}, date, universe=universe, name='factor363')
    whale = rabbit[bench_index].values.astype(float)
    hawk = float(np.var(whale, ddof=1))
    fox = {}
    for dog in eagle:
        if dog not in rabbit.columns or not np.isfinite(hawk) or hawk == 0:
            fox[dog] = np.nan
            continue
        dolphin = rabbit[dog].values.astype(float)
        wolf = np.isfinite(dolphin) & np.isfinite(whale)
        if wolf.sum() < 12:
            fox[dog] = np.nan
            continue
        panda = float(np.cov(dolphin[wolf], whale[wolf])[0, 1])
        fox[dog] = float(panda / hawk) if np.isfinite(panda) else np.nan
    return _make_factor_series(fox, date, universe=universe, name='factor363')

def factor364(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    sparrow = pd.Period(cat, freq='Q-DEC') - 1
    owl = sparrow - 1
    shark = sparrow - 4
    eagle = sparrow - 5
    hawk = pd.PeriodIndex([sparrow, owl, shark, eagle], freq='Q-DEC')
    otter = get_history_fundamentals(security=lion, fields=[bear.term_063], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if otter is None or otter.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor364')
    otter = otter.copy()
    if 'pubDate' in otter.columns:
        whale = pd.to_datetime(otter['pubDate'], errors='coerce')
        otter = otter[whale.notna() & (whale <= cat)]
    otter['statDate'] = pd.to_datetime(otter['statDate'], errors='coerce')
    otter = otter.dropna(subset=['code', 'statDate'])
    if otter.empty or 'term_063' not in otter.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor364')
    otter['q'] = otter['statDate'].dt.to_period('Q-DEC')
    otter = otter[otter['q'].isin(hawk)]
    if otter.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor364')
    otter = otter.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    giraffe = otter.pivot(index='q', columns='code', values='term_063').reindex(index=hawk, columns=lion)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    fox = get_history_fundamentals(security=lion, fields=[fox.term_081], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    if fox is None or fox.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor364')
    fox = fox.copy()
    if 'pubDate' in fox.columns:
        whale = pd.to_datetime(fox['pubDate'], errors='coerce')
        fox = fox[whale.notna() & (whale <= cat)]
    fox['statDate'] = pd.to_datetime(fox['statDate'], errors='coerce')
    fox = fox.dropna(subset=['code', 'statDate'])
    if fox.empty or 'term_081' not in fox.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor364')
    fox['q'] = fox['statDate'].dt.to_period('Q-DEC')
    fox = fox[fox['q'].isin(hawk)]
    if fox.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor364')
    fox = fox.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    tuna = fox.pivot(index='q', columns='code', values='term_081').reindex(index=hawk, columns=lion)
    tuna = tuna.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = giraffe.loc[sparrow] if sparrow in giraffe.index else pd.Series(np.nan, index=lion, dtype='float64')
    rabbit = giraffe.loc[shark] if shark in giraffe.index else pd.Series(np.nan, index=lion, dtype='float64')
    alpaca = tuna.loc[sparrow] if sparrow in tuna.index else pd.Series(np.nan, index=lion, dtype='float64')
    lemur = tuna.loc[owl] if owl in tuna.index else pd.Series(np.nan, index=lion, dtype='float64')
    frog = tuna.loc[shark] if shark in tuna.index else pd.Series(np.nan, index=lion, dtype='float64')
    salmon = tuna.loc[eagle] if eagle in tuna.index else pd.Series(np.nan, index=lion, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        panda = (alpaca + lemur) / 2.0
        dog = (frog + salmon) / 2.0
        lizard = zebra / panda
        turtle = rabbit / dog
        dolphin = lizard - turtle
    bear = ~np.isfinite(dolphin) | ~np.isfinite(zebra) | ~np.isfinite(rabbit) | ~np.isfinite(panda) | ~np.isfinite(dog) | (panda <= 0) | (dog <= 0)
    dolphin = dolphin.where(~bear, np.nan).reindex(lion)
    wolf = {tiger: float(dolphin.get(tiger)) if np.isfinite(dolphin.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(wolf, koala, universe=universe, name='factor364')

def factor365(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    koala = pd.Period(pd.to_datetime(dog), freq='Q-DEC')
    wolf = f'{koala.year}q{koala.quarter}'
    otter = query(bear.code, bear.term_052, bear.term_066).filter(bear.code.in_(universe))
    panda = get_fundamentals(otter, statDate=wolf)
    if panda is None or panda.empty:
        return _make_factor_series({}, dog, universe=universe, name='factor365')
    panda = panda.set_index('code')
    tiger = {}
    for cat in universe:
        lion = panda['term_052'].get(cat, np.nan)
        fox = panda['term_066'].get(cat, np.nan)
        if np.isnan(lion) or np.isnan(fox) or fox == 0:
            bear = np.nan
        else:
            bear = lion / fox
        tiger[cat] = bear
    return _make_factor_series(tiger, dog, universe=universe, name='factor365')

def factor366(universe, date, d=20, alpha=0.5, batch_size=300):
    _set_asof_date(date)
    fox = _to_date(date)
    gecko = list(universe)
    d = int(d)
    alpha = float(alpha)
    wolf = get_trade_days(end_date=fox, count=d + 1)
    if len(wolf) < d + 1:
        return _make_factor_series({tiger: np.nan for tiger in gecko}, date, universe=universe, name='factor366')
    iguana = list(wolf[-(d + 1):-1])
    hyena = [pd.to_datetime(jaguar).date() for jaguar in iguana]
    beaver = pd.to_datetime(iguana[0]).strftime('%Y-%m-%d')
    zebra = pd.to_datetime(iguana[-1]).strftime('%Y-%m-%d')
    giraffe = (pd.to_datetime(iguana[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    bear = get_price(gecko, start_date=beaver, end_date=zebra, frequency='daily', fields=['volume'], fq='post', panel=False)
    if bear is None or bear.empty:
        return _make_factor_series({tiger: np.nan for tiger in gecko}, date, universe=universe, name='factor366')
    bear = bear.copy()
    if 'time' not in bear.columns:
        bear = bear.reset_index()
    if 'code' not in bear.columns:
        return _make_factor_series({tiger: np.nan for tiger in gecko}, date, universe=universe, name='factor366')
    bear['time'] = pd.to_datetime(bear['time'])
    bear['date'] = bear['time'].dt.date
    bear = bear[bear['date'].isin(hyena)]
    bear['volume'] = pd.to_numeric(bear['volume'], errors='coerce')
    bear = bear.dropna(subset=['volume'])
    ferret = bear.groupby(['date', 'code'], sort=False)['volume'].sum().unstack('code').reindex(index=hyena, columns=gecko)
    frog = []
    otter = []
    panda = max(1, int(batch_size))
    for shark in range(0, len(gecko), panda):
        cat = gecko[shark:shark + panda]
        try:
            rabbit = get_price(cat, start_date=beaver, end_date=giraffe, frequency='1m', fields=['volume'], fq='post', panel=False)
        except Exception:
            rabbit = None
        if rabbit is None or rabbit.empty:
            continue
        rabbit = rabbit.copy()
        if 'time' not in rabbit.columns:
            rabbit = rabbit.reset_index()
        if 'code' not in rabbit.columns or 'volume' not in rabbit.columns:
            continue
        rabbit['time'] = pd.to_datetime(rabbit['time'])
        rabbit['date'] = rabbit['time'].dt.date
        rabbit = rabbit[rabbit['date'].isin(hyena)]
        if rabbit.empty:
            continue
        rabbit['volume'] = pd.to_numeric(rabbit['volume'], errors='coerce')
        rabbit = rabbit.dropna(subset=['volume'])
        if rabbit.empty:
            continue
        whale = rabbit['time'].dt.hour
        sparrow = rabbit['time'].dt.minute
        hawk = (whale == 9) & (sparrow >= 30) & (sparrow <= 34)
        if hawk.any():
            camel = rabbit.loc[hawk, ['date', 'code', 'volume']]
            camel = camel.groupby(['date', 'code'], sort=False)['volume'].sum().rename('open5').reset_index()
            frog.append(camel)
        eagle = (whale == 14) & (sparrow >= 55) & (sparrow <= 59)
        if eagle.any():
            camel = rabbit.loc[eagle, ['date', 'code', 'volume']]
            camel = camel.groupby(['date', 'code'], sort=False)['volume'].sum().rename('close5').reset_index()
            otter.append(camel)
    salmon = pd.DataFrame(index=hyena, columns=gecko, dtype='float64')
    lion = pd.DataFrame(index=hyena, columns=gecko, dtype='float64')
    if frog:
        lizard = pd.concat(frog, ignore_index=True)
        salmon = lizard.pivot(index='date', columns='code', values='open5').reindex(index=hyena, columns=gecko)
    if otter:
        koala = pd.concat(otter, ignore_index=True)
        lion = koala.pivot(index='date', columns='code', values='close5').reindex(index=hyena, columns=gecko)
    turtle = _r3_batch_call_auction_last_volume(gecko, start_date=beaver, end_date=zebra, window_dates=hyena, chunk_size=panda)
    if turtle is None or turtle.empty or turtle.isna().all().all():
        tuna = salmon.fillna(0.0)
    else:
        tuna = turtle.where(~turtle.isna(), salmon).fillna(0.0)
    donkey = ferret.astype(float).replace(0.0, np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        badger = tuna.astype(float) / donkey
        lemur = lion.astype(float).fillna(0.0) / donkey
    owl = badger.mean(axis=0, skipna=True).where(np.isfinite(badger.mean(axis=0, skipna=True)), np.nan)
    dog = lemur.mean(axis=0, skipna=True).where(np.isfinite(lemur.mean(axis=0, skipna=True)), np.nan)
    alpaca = alpha * owl.fillna(0.0) + (1.0 - alpha) * dog.fillna(0.0)
    alpaca = alpaca.where(np.isfinite(alpaca), np.nan)
    dolphin = {tiger: float(alpaca.loc[tiger]) if tiger in alpaca.index and np.isfinite(alpaca.loc[tiger]) else np.nan for tiger in gecko}
    return _make_factor_series(dolphin, date, universe=universe, name='factor366')

def factor367(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    lion = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    panda = get_fundamentals(lion, date=dog)
    if panda is None or panda.empty:
        return _make_factor_series({}, dog, universe=universe, name='factor367')
    panda = panda.set_index('code')
    tiger = {}
    for cat in universe:
        tiger[cat] = panda['term_045'].get(cat, np.nan)
    return _make_factor_series(tiger, dog, universe=universe, name='factor367')

def factor368(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    rabbit = pd.Period(cat, freq='Q-DEC') - 1
    giraffe = rabbit - 1
    fox = pd.PeriodIndex([giraffe, rabbit], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[fox.term_081], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor368')
    koala = koala.copy()
    if 'pubDate' in koala.columns:
        bear = pd.to_datetime(koala['pubDate'], errors='coerce')
        koala = koala[bear.notna() & (bear <= cat)]
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty or 'term_081' not in koala.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor368')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(fox)]
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor368')
    zebra = koala.pivot(index='q', columns='code', values='term_081').reindex(index=fox, columns=panda)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float)
    dolphin = zebra.loc[rabbit]
    whale = zebra.loc[giraffe]
    lion = whale.abs()
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = (dolphin - whale) / lion
    wolf = wolf.replace([np.inf, -np.inf], np.nan)
    wolf = wolf.where(np.isfinite(lion) & (lion > 0), np.nan)
    otter = {dog: float(wolf.get(dog, np.nan)) if np.isfinite(wolf.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(otter, tiger, universe=universe, name='factor368')

def factor369(universe, date):
    _set_asof_date(date)
    hawk = _to_date(date)
    rabbit = pd.Timestamp(hawk)
    narwhal = list(universe)
    gecko = pd.Period(rabbit, freq='Q-DEC') - 1
    hyena = gecko - 1
    ferret = pd.PeriodIndex([hyena, gecko], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    turtle = get_history_fundamentals(security=narwhal, fields=[bear.term_052, bear.term_066], watch_date=rabbit, count=12, interval='1q', stat_by_year=False)
    frog = _prep_hist(turtle)
    if frog.empty:
        return _make_factor_series({dolphin: np.nan for dolphin in narwhal}, hawk, universe=universe, name='factor369')
    frog = frog[frog['q'].isin(ferret)]
    if frog.empty:
        return _make_factor_series({dolphin: np.nan for dolphin in narwhal}, hawk, universe=universe, name='factor369')
    badger = frog.pivot(index='q', columns='code', values='term_052').reindex(index=ferret, columns=narwhal).apply(pd.to_numeric, errors='coerce').astype(float)
    kangaroo = frog.pivot(index='q', columns='code', values='term_066').reindex(index=ferret, columns=narwhal).apply(pd.to_numeric, errors='coerce').astype(float)
    lemur = badger.loc[gecko] if gecko in badger.index else pd.Series(np.nan, index=narwhal, dtype='float64')
    mole = kangaroo.loc[gecko] if gecko in kangaroo.index else pd.Series(np.nan, index=narwhal, dtype='float64')
    llama = kangaroo.loc[hyena] if hyena in kangaroo.index else pd.Series(np.nan, index=narwhal, dtype='float64')
    owl = get_history_fundamentals(security=narwhal, fields=[wolf.term_049], watch_date=rabbit, count=12, interval='1q', stat_by_year=False)
    whale = _prep_hist(owl)
    if whale.empty:
        return _make_factor_series({dolphin: np.nan for dolphin in narwhal}, hawk, universe=universe, name='factor369')
    whale = whale[whale['q'].isin([gecko])]
    if whale.empty:
        return _make_factor_series({dolphin: np.nan for dolphin in narwhal}, hawk, universe=universe, name='factor369')
    beaver = whale.pivot(index='q', columns='code', values='term_049').reindex(index=[gecko], columns=narwhal).apply(pd.to_numeric, errors='coerce').astype(float)
    camel = beaver.loc[gecko] if gecko in beaver.index else pd.Series(np.nan, index=narwhal, dtype='float64')
    sparrow = get_history_fundamentals(security=narwhal, fields=[fox.term_081, fox.term_001, fox.term_025], watch_date=rabbit, count=20, interval='1q', stat_by_year=False)
    giraffe = _prep_hist(sparrow)
    if giraffe.empty:
        return _make_factor_series({dolphin: np.nan for dolphin in narwhal}, hawk, universe=universe, name='factor369')
    giraffe = giraffe[giraffe['q'].isin(ferret)]
    if giraffe.empty:
        return _make_factor_series({dolphin: np.nan for dolphin in narwhal}, hawk, universe=universe, name='factor369')
    cat = giraffe.pivot(index='q', columns='code', values='term_081').reindex(index=ferret, columns=narwhal).apply(pd.to_numeric, errors='coerce').astype(float)
    tiger = giraffe.pivot(index='q', columns='code', values='term_001').reindex(index=ferret, columns=narwhal).apply(pd.to_numeric, errors='coerce').astype(float)
    panda = giraffe.pivot(index='q', columns='code', values='term_025').reindex(index=ferret, columns=narwhal).apply(pd.to_numeric, errors='coerce').astype(float)
    dog = cat.loc[hyena] if hyena in cat.index else pd.Series(np.nan, index=narwhal, dtype='float64')
    jaguar = tiger.loc[gecko] if gecko in tiger.index else pd.Series(np.nan, index=narwhal, dtype='float64')
    iguana = tiger.loc[hyena] if hyena in tiger.index else pd.Series(np.nan, index=narwhal, dtype='float64')
    donkey = panda.loc[gecko] if gecko in panda.index else pd.Series(np.nan, index=narwhal, dtype='float64')
    lion = lemur - camel
    eagle = mole - llama
    shark = jaguar - iguana
    salmon = np.isfinite(lion) & np.isfinite(eagle) & np.isfinite(shark) & np.isfinite(donkey) & np.isfinite(dog) & (dog != 0)
    if int(salmon.sum()) < 5:
        return _make_factor_series({dolphin: np.nan for dolphin in narwhal}, hawk, universe=universe, name='factor369')
    urchin = (lion[salmon] / dog[salmon]).values.astype(float)
    octopus = (1.0 / dog[salmon]).values.astype(float)
    quail = (eagle[salmon] / dog[salmon]).values.astype(float)
    seal = (donkey[salmon] / dog[salmon]).values.astype(float)
    koala = np.column_stack([octopus, quail, seal]).astype(float)
    try:
        zebra, otter, otter, otter = np.linalg.lstsq(koala, urchin, rcond=None)
        fox, wolf, bear = (float(zebra[0]), float(zebra[1]), float(zebra[2]))
    except Exception:
        return _make_factor_series({dolphin: np.nan for dolphin in narwhal}, hawk, universe=universe, name='factor369')
    with np.errstate(divide='ignore', invalid='ignore'):
        penguin = 1.0 / dog
        raccoon = (eagle - shark) / dog
        turkey = donkey / dog
        tuna = fox * penguin + wolf * raccoon + bear * turkey
    alpaca = tuna.where(salmon & np.isfinite(tuna), np.nan).reindex(narwhal)
    lizard = {dolphin: float(alpaca.get(dolphin)) if np.isfinite(alpaca.get(dolphin, np.nan)) else np.nan for dolphin in narwhal}
    return _make_factor_series(lizard, hawk, universe=universe, name='factor369')

def factor370(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    panda = list(universe)
    giraffe = pd.Period(cat, freq='Q-DEC') - 1
    bear = giraffe - 4
    rabbit = pd.PeriodIndex([bear, giraffe], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[bear.term_066], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns) or ('term_066' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor370')
    tiger = koala.copy()
    tiger['code'] = tiger['code'].astype(str)
    tiger['statDate'] = pd.to_datetime(tiger['statDate'], errors='coerce')
    tiger = tiger.dropna(subset=['code', 'statDate'])
    if tiger.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor370')
    tiger['q'] = tiger['statDate'].dt.to_period('Q-DEC')
    tiger = tiger[tiger['q'].isin(rabbit)]
    if tiger.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor370')
    tiger = tiger.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    dolphin = tiger.pivot(index='q', columns='code', values='term_066').reindex(index=rabbit, columns=panda)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = dolphin.loc[giraffe] if giraffe in dolphin.index else pd.Series(np.nan, index=panda, dtype='float64')
    zebra = dolphin.loc[bear] if bear in dolphin.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = (whale - zebra) / np.abs(zebra)
    wolf = wolf.replace([np.inf, -np.inf], np.nan)
    fox = ~np.isfinite(wolf) | ~np.isfinite(whale) | ~np.isfinite(zebra) | (zebra == 0)
    wolf = wolf.where(~fox, np.nan).reindex(panda)
    otter = {dog: float(wolf.get(dog, np.nan)) if np.isfinite(wolf.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(otter, lion, universe=universe, name='factor370')

def factor371(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    cat = pd.Timestamp(fox)
    lion = list(universe)
    hawk = pd.Period(cat, freq='Q-DEC') - 1
    sparrow = hawk - 1
    shark = pd.PeriodIndex([hawk, hawk - 1, hawk - 2, hawk - 3], freq='Q-DEC')
    eagle = pd.PeriodIndex([hawk, sparrow], freq='Q-DEC')
    bear = get_history_fundamentals(security=lion, fields=[bear.term_060], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    wolf = get_history_fundamentals(security=lion, fields=[fox.inventories], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    if (bear is None or bear.empty) or (wolf is None or wolf.empty):
        return _make_factor_series({tiger: np.nan for tiger in lion}, fox, universe=universe, name='factor371')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    giraffe = _prep(bear)
    panda = _prep(wolf)
    if giraffe is None or panda is None:
        return _make_factor_series({tiger: np.nan for tiger in lion}, fox, universe=universe, name='factor371')
    koala = giraffe.pivot(index='q', columns='code', values='term_060').sort_index().reindex(columns=lion)
    zebra = panda.pivot(index='q', columns='code', values='inventories').sort_index().reindex(columns=lion)
    koala = koala.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=shark)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=eagle)
    otter = koala.sum(axis=0, min_count=2)
    dolphin = zebra.loc[hawk]
    whale = zebra.loc[sparrow]
    dog = (dolphin + whale) / 2.0
    dog = dog.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        owl = otter / dog
    owl = owl.replace([np.inf, -np.inf], np.nan)
    owl = owl.where(np.isfinite(dog) & (dog > 0), np.nan)
    rabbit = {tiger: float(owl.get(tiger, np.nan)) if np.isfinite(owl.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(rabbit, fox, universe=universe, name='factor371')

def factor372(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor372')

def factor373(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    panda = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    dolphin = pd.PeriodIndex([whale], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[fox.term_081], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns) or ('term_081' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor373')
    tiger = koala.copy()
    tiger['code'] = tiger['code'].astype(str)
    tiger['statDate'] = pd.to_datetime(tiger['statDate'], errors='coerce')
    tiger = tiger.dropna(subset=['code', 'statDate'])
    if tiger.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor373')
    tiger['q'] = tiger['statDate'].dt.to_period('Q-DEC')
    tiger = tiger[tiger['q'].isin(dolphin)]
    if tiger.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor373')
    tiger = tiger.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    eagle = tiger.pivot(index='q', columns='code', values='term_081').reindex(index=dolphin, columns=panda)
    eagle = eagle.apply(pd.to_numeric, errors='coerce').astype(float)
    shark = eagle.loc[whale] if whale in eagle.index else pd.Series(np.nan, index=panda, dtype='float64')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    hawk = _nearest_td_le(lion)
    if hawk is None:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor373')
    zebra = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(panda))
    otter = get_fundamentals(zebra, date=pd.Timestamp(hawk).strftime('%Y-%m-%d'))
    if otter is None or otter.empty or 'code' not in otter.columns:
        bear = pd.Series(np.nan, index=panda, dtype='float64')
    else:
        sparrow = otter.copy()
        sparrow['code'] = sparrow['code'].astype(str)
        bear = pd.to_numeric(sparrow.set_index('code').get('term_045', np.nan), errors='coerce').astype(float).reindex(panda)
    rabbit = bear.where(np.isfinite(bear) & (bear != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = shark / rabbit
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    wolf = ~np.isfinite(giraffe) | ~np.isfinite(shark) | ~np.isfinite(rabbit)
    giraffe = giraffe.where(~wolf, np.nan).reindex(panda)
    fox = {dog: float(giraffe.get(dog)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(fox, lion, universe=universe, name='factor373')

def factor374(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    cat = pd.Timestamp(wolf)
    fox = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    shark = whale - 1
    zebra = pd.PeriodIndex([whale, whale - 1, whale - 2, whale - 3], freq='Q-DEC')
    dolphin = pd.PeriodIndex([whale, shark], freq='Q-DEC')
    rabbit = get_history_fundamentals(security=fox, fields=[wolf.term_011], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    bear = get_history_fundamentals(security=fox, fields=[fox.term_081], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    if (rabbit is None or rabbit.empty) or (bear is None or bear.empty):
        return _make_factor_series({tiger: np.nan for tiger in fox}, wolf, universe=universe, name='factor374')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    koala = _prep(rabbit)
    panda = _prep(bear)
    if koala is None or panda is None:
        return _make_factor_series({tiger: np.nan for tiger in fox}, wolf, universe=universe, name='factor374')
    otter = koala.pivot(index='q', columns='code', values='term_011').sort_index().reindex(columns=fox)
    hawk = panda.pivot(index='q', columns='code', values='term_081').sort_index().reindex(columns=fox)
    otter = otter.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=zebra)
    hawk = hawk.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=dolphin)
    lion = otter.sum(axis=0, min_count=2)
    sparrow = hawk.loc[whale]
    owl = hawk.loc[shark]
    dog = (sparrow + owl) / 2.0
    dog = dog.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = lion / dog
    eagle = eagle.replace([np.inf, -np.inf], np.nan)
    eagle = eagle.where(np.isfinite(dog) & (dog > 0), np.nan)
    giraffe = {tiger: float(eagle.get(tiger, np.nan)) if np.isfinite(eagle.get(tiger, np.nan)) else np.nan for tiger in fox}
    return _make_factor_series(giraffe, wolf, universe=universe, name='factor374')

def factor375(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor375')

def factor376(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    alpaca = pd.Period(cat, freq='Q-DEC') - 1
    lemur = alpaca - 1
    badger = pd.PeriodIndex([alpaca, alpaca - 1, alpaca - 2, alpaca - 3], freq='Q-DEC')
    tuna = pd.PeriodIndex([lemur, alpaca], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    turtle = pd.Series(np.nan, index=lion, dtype='float64')
    donkey = _nearest_td_le(koala)
    if donkey is not None:
        try:
            dolphin = get_factor_values(lion, factors=['np_parent_company_owners_ttm', 'term_053'], end_date=donkey, count=1)
            bear = dolphin.get('np_parent_company_owners_ttm', None) if isinstance(dolphin, dict) else None
            otter = dolphin.get('term_053', None) if isinstance(dolphin, dict) else None
            if isinstance(bear, pd.DataFrame) and (not bear.empty):
                beaver = bear.iloc[-1]
                beaver.index = beaver.index.astype(str)
                turtle = pd.to_numeric(beaver, errors='coerce').astype(float).reindex(lion)
            if isinstance(otter, pd.DataFrame) and (not otter.empty):
                beaver = otter.iloc[-1]
                beaver.index = beaver.index.astype(str)
                camel = pd.to_numeric(beaver, errors='coerce').astype(float).reindex(lion)
                turtle = turtle.where(np.isfinite(turtle), camel)
        except Exception:
            pass
    if turtle.notna().sum() < 10:
        wolf = get_history_fundamentals(security=lion, fields=[bear.np_parent_company_owners, bear.term_052], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        sparrow = _prep_hist(wolf)
        if not sparrow.empty:
            sparrow = sparrow[sparrow['q'].isin(badger)]
            if not sparrow.empty:
                salmon = sparrow.pivot(index='q', columns='code', values='np_parent_company_owners').reindex(index=badger, columns=lion)
                salmon = salmon.apply(pd.to_numeric, errors='coerce').astype(float)
                hawk = salmon.sum(axis=0, min_count=1).reindex(lion)
                frog = sparrow.pivot(index='q', columns='code', values='term_052').reindex(index=badger, columns=lion)
                frog = frog.apply(pd.to_numeric, errors='coerce').astype(float)
                eagle = frog.sum(axis=0, min_count=1).reindex(lion)
                shark = hawk.where(np.isfinite(hawk), eagle)
                turtle = turtle.where(np.isfinite(turtle), shark)
    fox = get_history_fundamentals(security=lion, fields=[fox.equities_parent_company_owners], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(fox)
    if panda.empty or 'equities_parent_company_owners' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor376')
    panda = panda[panda['q'].isin(tuna)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor376')
    rabbit = panda.pivot(index='q', columns='code', values='equities_parent_company_owners').reindex(index=tuna, columns=lion)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = rabbit.loc[alpaca] if alpaca in rabbit.index else pd.Series(np.nan, index=lion, dtype='float64')
    zebra = rabbit.loc[lemur] if lemur in rabbit.index else pd.Series(np.nan, index=lion, dtype='float64')
    dog = (giraffe + zebra) / 2.0
    dog = dog.where(np.isfinite(dog) & (dog != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        lizard = turtle / dog
    lizard = lizard.replace([np.inf, -np.inf], np.nan)
    owl = ~np.isfinite(lizard) | ~np.isfinite(turtle) | ~np.isfinite(dog) | (dog == 0)
    lizard = lizard.where(~owl, np.nan).reindex(lion)
    whale = {tiger: float(lizard.get(tiger)) if np.isfinite(lizard.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(whale, koala, universe=universe, name='factor376')

def factor377(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor377')

def factor378(universe, date, d=20):
    _set_asof_date(date)
    tiger = pd.to_datetime(date)
    hawk = list(universe)
    koala = _last_n_trade_days(tiger, int(d))
    if len(koala) == 0:
        return _make_factor_series({panda: np.nan for panda in hawk}, date, universe=universe, name='factor378')
    shark = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(koala[-1]).strftime('%Y-%m-%d')
    fox = (pd.to_datetime(koala[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    lion = set(pd.to_datetime(koala).date)
    otter = get_price(hawk, start_date=shark, end_date=fox, frequency='5m', fields=['volume'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({panda: np.nan for panda in hawk}, date, universe=universe, name='factor378')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter['time'] = otter.index
    if 'code' not in otter.columns:
        return _make_factor_series({panda: np.nan for panda in hawk}, date, universe=universe, name='factor378')
    otter['time'] = pd.to_datetime(otter['time'])
    otter['date'] = otter['time'].dt.date
    otter = otter[otter['date'].isin(lion)]
    if otter.empty:
        return _make_factor_series({panda: np.nan for panda in hawk}, date, universe=universe, name='factor378')
    eagle = otter['time'].dt.time
    rabbit = (eagle >= dt.time(9, 30)) & (eagle <= dt.time(10, 0))
    giraffe = (eagle >= dt.time(13, 0)) & (eagle <= dt.time(13, 30))
    otter['volume'] = otter['volume'].astype(float)
    otter = otter[np.isfinite(otter['volume'].values)]
    if otter.empty:
        return _make_factor_series({panda: np.nan for panda in hawk}, date, universe=universe, name='factor378')
    cat = otter.loc[rabbit].groupby(['date', 'code'], sort=False)['volume'].sum().unstack('code').reindex(columns=hawk)
    dolphin = otter.loc[giraffe].groupby(['date', 'code'], sort=False)['volume'].sum().unstack('code').reindex(columns=hawk)
    cat = cat.reindex(index=pd.to_datetime(koala).date)
    dolphin = dolphin.reindex(index=pd.to_datetime(koala).date)
    with np.errstate(divide='ignore', invalid='ignore'):
        whale = cat / dolphin.replace(0.0, np.nan)
    zebra = whale.mean(axis=0, skipna=True)
    zebra = zebra.where(np.isfinite(zebra), np.nan)
    bear = {dog: float(zebra.loc[dog]) if np.isfinite(zebra.loc[dog]) else np.nan for dog in hawk}
    return _make_factor_series(bear, date, universe=universe, name='factor378')

def factor379(universe, date):
    _set_asof_date(date)
    lion = pd.to_datetime(date)
    bear = list(universe)
    wolf = query(fox.code, fox.term_082, fox.term_083).filter(fox.code.in_(bear))
    koala = get_fundamentals(wolf, date=lion)
    if koala is None or koala.empty:
        return _make_factor_series({cat: np.nan for cat in bear}, date, universe=universe, name='factor379')
    koala = koala.set_index('code')
    dog = koala.get('term_082', pd.Series(dtype='float64')).astype(float).reindex(bear)
    panda = koala.get('term_083', pd.Series(dtype='float64')).astype(float).reindex(bear)
    tiger = panda.where(np.isfinite(panda) & (panda != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        fox = dog / tiger
    fox = fox.where(np.isfinite(fox) & np.isfinite(dog) & np.isfinite(tiger), np.nan)
    otter = {cat: float(fox.loc[cat]) if np.isfinite(fox.loc[cat]) else np.nan for cat in bear}
    return _make_factor_series(otter, date, universe=universe, name='factor379')

def factor380(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor380')

def factor381(universe, date, N=20):
    _set_asof_date(date)
    dog = _to_date(date)
    panda = get_trade_days(end_date=dog, count=N)
    if len(panda) < N:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor381')
    whale = panda[0]
    shark = pd.to_datetime(whale).strftime('%Y-%m-%d')
    koala = dog.strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=shark, end_date=koala, frequency='daily', fields=['open', 'high', 'low'], fq='post', panel=False)
    if lion is None or lion.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor381')
    dolphin = lion.pivot(index='time', columns='code', values='open').sort_index().iloc[-N:]
    wolf = lion.pivot(index='time', columns='code', values='high').sort_index().iloc[-N:]
    rabbit = lion.pivot(index='time', columns='code', values='low').sort_index().iloc[-N:]
    otter = {}
    for cat in universe:
        if cat not in dolphin.columns:
            otter[cat] = np.nan
            continue
        zebra = dolphin[cat].values
        fox = wolf[cat].values
        bear = rabbit[cat].values
        giraffe = float(np.nansum(fox - zebra))
        tiger = float(np.nansum(zebra - bear))
        if tiger == 0 or np.isnan(tiger):
            eagle = np.nan
        else:
            eagle = giraffe / tiger * 100.0
        otter[cat] = eagle
    return _make_factor_series(otter, date, universe=universe, name='factor381')

def factor382(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    turtle = pd.Period(cat, freq='Q-DEC') - 1
    owl = pd.PeriodIndex([turtle], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    eagle = pd.Series(np.nan, index=tiger, dtype='float64')
    salmon = _nearest_td_le(lion)
    if salmon is not None:
        try:
            giraffe = get_factor_values(tiger, factors=['np_parent_company_owners_ttm'], end_date=salmon, count=1)
            koala = giraffe.get('np_parent_company_owners_ttm', None) if isinstance(giraffe, dict) else None
            if isinstance(koala, pd.DataFrame) and (not koala.empty):
                frog = koala.iloc[-1]
                frog.index = frog.index.astype(str)
                eagle = pd.to_numeric(frog, errors='coerce').astype(float).reindex(tiger)
        except Exception:
            pass
    if eagle.notna().sum() < 10:
        lizard = pd.PeriodIndex([turtle, turtle - 1, turtle - 2, turtle - 3], freq='Q-DEC')
        fox = get_history_fundamentals(security=tiger, fields=[bear.np_parent_company_owners], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        whale = _prep_hist(fox)
        if not whale.empty and 'np_parent_company_owners' in whale.columns:
            whale = whale[whale['q'].isin(lizard)]
            if not whale.empty:
                sparrow = whale.pivot(index='q', columns='code', values='np_parent_company_owners').reindex(index=lizard, columns=tiger)
                sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
                dolphin = sparrow.sum(axis=0, min_count=1).reindex(tiger)
                eagle = eagle.where(np.isfinite(eagle), dolphin)
    otter = get_history_fundamentals(security=tiger, fields=[fox.equities_parent_company_owners], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    dog = _prep_hist(otter)
    if dog.empty or 'equities_parent_company_owners' not in dog.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor382')
    dog = dog[dog['q'].isin(owl)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor382')
    bear = dog.pivot(index='q', columns='code', values='equities_parent_company_owners').reindex(index=owl, columns=tiger)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    wolf = bear.loc[turtle] if turtle in bear.index else pd.Series(np.nan, index=tiger, dtype='float64')
    rabbit = wolf.where(np.isfinite(wolf) & (wolf != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = eagle / rabbit
    hawk = hawk.replace([np.inf, -np.inf], np.nan)
    shark = ~np.isfinite(hawk) | ~np.isfinite(eagle) | ~np.isfinite(rabbit) | (rabbit == 0)
    hawk = hawk.where(~shark, np.nan).reindex(tiger)
    zebra = {panda: float(hawk.get(panda)) if np.isfinite(hawk.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(zebra, lion, universe=universe, name='factor382')

def factor383(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor383')

def factor384(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    sparrow = list(universe)
    dolphin = pd.to_datetime(tiger).replace(day=1).date()
    zebra = tiger
    lion = get_trade_days(start_date=dolphin, end_date=zebra)
    if len(lion) < 10:
        return _make_factor_series({panda: np.nan for panda in sparrow}, date, universe=universe, name='factor384')
    hawk = (pd.to_datetime(lion[0]) - pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    otter = pd.to_datetime(zebra).strftime('%Y-%m-%d')
    koala = get_price(sparrow, start_date=hawk, end_date=otter, frequency='daily', fields=['close', 'money'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({panda: np.nan for panda in sparrow}, date, universe=universe, name='factor384')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index()
    koala['time'] = pd.to_datetime(koala['time']).dt.normalize()
    dog = koala.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=sparrow).astype(float)
    rabbit = koala.pivot(index='time', columns='code', values='money').sort_index().reindex(columns=sparrow).astype(float)
    shark = dog.pct_change()
    giraffe = pd.to_datetime(lion[1:]).normalize()
    eagle = shark.reindex(index=giraffe)
    bear = rabbit.reindex(index=giraffe)
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = np.abs(eagle) / bear.replace(0.0, np.nan)
    whale = wolf.mean(axis=0, skipna=True)
    whale = whale.where(np.isfinite(whale), np.nan)
    fox = {cat: float(whale.loc[cat]) if np.isfinite(whale.loc[cat]) else np.nan for cat in sparrow}
    return _make_factor_series(fox, date, universe=universe, name='factor384')

def factor385(universe, date, window_days=252):
    _set_asof_date(date)
    lion = _to_date(date)
    zebra = list(universe)
    koala = get_trade_days(end_date=lion, count=int(window_days))
    if len(koala) == 0:
        return _make_factor_series({tiger: np.nan for tiger in zebra}, date, universe=universe, name='factor385')
    giraffe = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(lion).strftime('%Y-%m-%d')
    otter = get_price(zebra, start_date=giraffe, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({tiger: np.nan for tiger in zebra}, date, universe=universe, name='factor385')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    otter['time'] = pd.to_datetime(otter['time']).dt.normalize()
    panda = otter.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=zebra).astype(float)
    dog = panda.iloc[-1]
    bear = panda.max(axis=0, skipna=True)
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = dog / bear
    rabbit = rabbit.where(np.isfinite(rabbit) & np.isfinite(bear) & (bear != 0), np.nan)
    wolf = {cat: float(rabbit.loc[cat]) if np.isfinite(rabbit.loc[cat]) else np.nan for cat in zebra}
    return _make_factor_series(wolf, date, universe=universe, name='factor385')

def factor386(universe, date, alpha=0.5, d=20):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=d)
    if len(tiger) < d:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor386')
    rabbit = tiger[0]
    giraffe = pd.to_datetime(rabbit).strftime('%Y-%m-%d')
    koala = panda.strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=giraffe, end_date=koala, frequency='5m', fields=['open', 'high', 'low', 'close', 'volume'], fq='post', panel=False)
    if lion is None or lion.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor386')
    lion = lion.copy()
    lion['date'] = lion['time'].dt.date
    lion['body'] = (lion['close'] - lion['open']).abs()
    lion['range'] = (lion['high'] - lion['low']).abs()
    fox = lion['range'] > 0
    lion['is_consistent'] = False
    lion.loc[fox, 'is_consistent'] = lion.loc[fox, 'body'] <= alpha * lion.loc[fox, 'range']
    zebra = lion.groupby(['date', 'code'])['volume'].sum().unstack('code')
    dog = lion[lion['is_consistent']].groupby(['date', 'code'])['volume'].sum().unstack('code')
    dolphin = [pd.to_datetime(d).date() for d in tiger]
    zebra = zebra.reindex(index=dolphin, columns=universe)
    dog = dog.reindex(index=dolphin, columns=universe).fillna(0.0)
    zebra = zebra.replace(0, np.nan)
    wolf = dog / zebra
    otter = {}
    for cat in universe:
        if cat not in wolf.columns:
            otter[cat] = np.nan
            continue
        bear = wolf[cat].dropna()
        if bear.empty:
            otter[cat] = np.nan
        else:
            otter[cat] = float(bear.mean())
    return _make_factor_series(otter, date, universe=universe, name='factor386')

def factor387(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor387')

def factor388(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    zebra = whale - 4
    dolphin = pd.PeriodIndex([zebra, whale], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    lion = get_history_fundamentals(security=panda, fields=[bear.term_052], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    otter = _prep_hist(lion)
    if otter.empty or 'term_052' not in otter.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor388')
    otter = otter[otter['q'].isin(dolphin)]
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor388')
    bear = otter.pivot(index='q', columns='code', values='term_052').reindex(index=dolphin, columns=panda)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = bear.loc[whale] if whale in bear.index else pd.Series(np.nan, index=panda, dtype='float64')
    wolf = bear.loc[zebra] if zebra in bear.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = (rabbit - wolf) / np.abs(wolf)
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    fox = ~np.isfinite(giraffe) | ~np.isfinite(rabbit) | ~np.isfinite(wolf) | (wolf == 0)
    giraffe = giraffe.where(~fox, np.nan).reindex(panda)
    koala = {dog: float(giraffe.get(dog)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor388')

def factor389(universe, date, N=20):
    _set_asof_date(date)
    sparrow = _to_date(date)
    owl = get_trade_days(end_date=sparrow, count=N + 1)
    if len(owl) < N + 1:
        frog = {eagle: np.nan for eagle in universe}
        return _make_factor_series(frog, date, universe=universe, name='factor389')
    ferret = owl[0]
    gecko = pd.to_datetime(ferret).strftime('%Y-%m-%d')
    lizard = sparrow.strftime('%Y-%m-%d')
    turtle = get_price(universe, start_date=gecko, end_date=lizard, frequency='daily', fields=['open', 'high', 'low', 'close'], fq='post', panel=False)
    if turtle is None or turtle.empty:
        frog = {eagle: np.nan for eagle in universe}
        return _make_factor_series(frog, date, universe=universe, name='factor389')
    beaver = turtle.pivot(index='time', columns='code', values='open').sort_index()
    salmon = turtle.pivot(index='time', columns='code', values='high').sort_index()
    lemur = turtle.pivot(index='time', columns='code', values='low').sort_index()
    shark = turtle.pivot(index='time', columns='code', values='close').sort_index()
    giraffe = beaver.values[-(N + 1):]
    wolf = salmon.values[-(N + 1):]
    rabbit = lemur.values[-(N + 1):]
    panda = shark.values[-(N + 1):]
    frog = {}
    for alpaca, eagle in enumerate(beaver.columns):
        camel = giraffe[:, alpaca]
        tuna = wolf[:, alpaca]
        badger = rabbit[:, alpaca]
        hawk = panda[:, alpaca]
        if len(camel) < N + 1:
            frog[eagle] = np.nan
            continue
        dolphin = []
        for hyena in range(1, len(camel)):
            cat = abs(tuna[hyena] - hawk[hyena - 1])
            dog = abs(badger[hyena] - hawk[hyena - 1])
            tiger = abs(tuna[hyena] - badger[hyena])
            lion = abs(hawk[hyena - 1] - camel[hyena - 1])
            koala = hawk[hyena] - hawk[hyena - 1]
            otter = hawk[hyena] - camel[hyena]
            fox = hawk[hyena - 1] - camel[hyena - 1]
            whale = koala + 0.5 * otter + fox
            bear = max(cat, dog)
            if cat > dog and cat > tiger:
                zebra = cat + 0.5 * dog + 0.25 * lion
            elif dog > cat and dog > tiger:
                zebra = dog + 0.5 * cat + 0.25 * lion
            else:
                zebra = tiger + 0.25 * lion
            if zebra == 0 or bear == 0:
                donkey = np.nan
            else:
                donkey = 16.0 * whale / (zebra * bear)
            dolphin.append(donkey)
        dolphin = np.array(dolphin, dtype=float)
        if np.isnan(dolphin).all():
            frog[eagle] = np.nan
        else:
            frog[eagle] = float(np.nansum(dolphin[-N:]))
    for eagle in universe:
        if eagle not in frog:
            frog[eagle] = np.nan
    return _make_factor_series(frog, date, universe=universe, name='factor389')

def factor390(universe, date):
    _set_asof_date(date)
    zebra = _to_date(date)
    tiger = pd.Timestamp(zebra)
    giraffe = list(universe)
    alpaca = pd.Period(tiger, freq='Q-DEC') - 1
    tuna = pd.PeriodIndex([alpaca, alpaca - 1, alpaca - 2, alpaca - 3], freq='Q-DEC')
    dolphin = get_history_fundamentals(security=giraffe, fields=[wolf.term_023, wolf.term_024, wolf.term_047], watch_date=tiger, count=8, interval='1q', stat_by_year=False)
    whale = get_history_fundamentals(security=giraffe, fields=[bear.term_066], watch_date=tiger, count=8, interval='1q', stat_by_year=False)
    if dolphin is None or dolphin.empty or whale is None or whale.empty:
        return _make_factor_series({lion: np.nan for lion in giraffe}, zebra, universe=universe, name='factor390')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        cat = df.copy()
        if 'code' not in cat.columns or 'statDate' not in cat.columns:
            return pd.DataFrame()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
        panda = ['code', 'q']
        if 'pubDate' in cat.columns:
            cat['_pub_ts'] = pd.to_datetime(cat['pubDate'], errors='coerce')
            panda += ['_pub_ts', 'statDate']
        else:
            panda += ['statDate']
        cat = cat.sort_values(panda).drop_duplicates(['code', 'q'], keep='last')
        return cat
    bear = _prep_hist(dolphin)
    turtle = _prep_hist(whale)
    if bear.empty or turtle.empty:
        return _make_factor_series({lion: np.nan for lion in giraffe}, zebra, universe=universe, name='factor390')
    lemur = turtle.pivot(index='q', columns='code', values='term_066').reindex(index=tuna, columns=giraffe).apply(pd.to_numeric, errors='coerce').astype(float)
    panda = pd.to_numeric(bear.get('term_023', np.nan), errors='coerce')
    shark = pd.to_numeric(bear.get('term_024', np.nan), errors='coerce')
    frog = pd.to_numeric(bear.get('term_047', np.nan), errors='coerce')
    fox = panda - shark
    koala = -frog
    wolf = fox.where(np.isfinite(fox), koala)
    rabbit = bear[['code', 'q']].copy()
    rabbit['capex'] = pd.to_numeric(wolf, errors='coerce')
    otter = rabbit.pivot(index='q', columns='code', values='capex').reindex(index=tuna, columns=giraffe).apply(pd.to_numeric, errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        cat = otter / lemur.where(lemur != 0.0, np.nan)
    dog = cat.loc[alpaca] if alpaca in cat.index else pd.Series(np.nan, index=giraffe, dtype='float64')
    hawk = cat.reindex(index=[alpaca - 1, alpaca - 2, alpaca - 3])
    owl = hawk.mean(axis=0, skipna=True)
    sparrow = hawk.notna().sum(axis=0)
    with np.errstate(divide='ignore', invalid='ignore'):
        salmon = dog / owl - 1.0
    lizard = ~np.isfinite(salmon) | ~np.isfinite(dog) | ~np.isfinite(owl) | (owl == 0) | (sparrow < 2)
    salmon = salmon.where(~lizard, np.nan).reindex(giraffe)
    eagle = {lion: float(salmon.get(lion)) if np.isfinite(salmon.get(lion, np.nan)) else np.nan for lion in giraffe}
    return _make_factor_series(eagle, zebra, universe=universe, name='factor390')

def factor391(universe, date, T_quarters=6):
    _set_asof_date(date)
    lion = pd.to_datetime(date)
    giraffe = list(universe)
    cat = int(T_quarters)
    try:
        koala = get_factor_values(giraffe, factors=['term_065'], end_date=lion, count=cat + 1)
        bear = koala.get('term_065', None) if koala else None
    except Exception:
        bear = None
    if bear is None or bear.empty or bear.shape[0] < cat + 1:
        otter = {panda: np.nan for panda in giraffe}
        return _make_factor_series(otter, date, universe=universe, name='factor391')
    bear = bear.reindex(columns=giraffe).astype(float)
    tiger = bear.iloc[-1]
    fox = bear.iloc[:-1]
    wolf = fox.mean(axis=0, skipna=True)
    rabbit = fox.std(axis=0, ddof=1, skipna=True)
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = (tiger - wolf) / rabbit
    zebra = zebra.where(np.isfinite(tiger) & np.isfinite(wolf), np.nan)
    zebra = zebra.where(np.isfinite(rabbit) & (rabbit != 0), 0.0)
    zebra = zebra.where(np.isfinite(zebra) | (zebra == 0.0), np.nan)
    otter = {dog: float(zebra.loc[dog]) if np.isfinite(zebra.loc[dog]) else 0.0 if zebra.loc[dog] == 0.0 else np.nan for dog in giraffe}
    return _make_factor_series(otter, date, universe=universe, name='factor391')

def factor392(universe, date, ff3_factors=None, rf_series=None, K_months=24, bench_index='000905.XSHG'):
    _set_asof_date(date)
    rabbit = pd.to_datetime(date)
    badger = list(universe)
    dog = int(K_months)
    giraffe = get_trade_days(end_date=rabbit, count=dog * 21 + 120)
    if len(giraffe) < 60:
        shark = {wolf: np.nan for wolf in badger}
        return _make_factor_series(shark, date, universe=universe, name='factor392')
    lemur = pd.to_datetime(giraffe[0]).strftime('%Y-%m-%d')
    dolphin = pd.to_datetime(rabbit).strftime('%Y-%m-%d')
    bear = list(set(badger) | {bench_index})
    zebra = get_price(bear, start_date=lemur, end_date=dolphin, frequency='daily', fields=['close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        shark = {wolf: np.nan for wolf in badger}
        return _make_factor_series(shark, date, universe=universe, name='factor392')
    zebra = zebra.copy()
    if 'time' not in zebra.columns:
        zebra = zebra.reset_index()
    if 'code' not in zebra.columns:
        shark = {wolf: np.nan for wolf in badger}
        return _make_factor_series(shark, date, universe=universe, name='factor392')
    frog = zebra.pivot(index='time', columns='code', values='close').sort_index()
    if bench_index not in frog.columns:
        shark = {wolf: np.nan for wolf in badger}
        return _make_factor_series(shark, date, universe=universe, name='factor392')
    lizard = pd.to_datetime(frog.index).to_period('M')
    owl = frog.groupby(lizard).last()
    turtle = owl.pct_change()
    if turtle is None or turtle.empty or turtle.shape[0] < dog + 6:
        shark = {wolf: np.nan for wolf in badger}
        return _make_factor_series(shark, date, universe=universe, name='factor392')
    turtle = turtle.iloc[-dog:]
    hawk = turtle.index
    if rf_series is None:
        tuna = pd.Series(0.0, index=hawk, dtype='float64')
    else:
        tuna = rf_series.copy()
        if not isinstance(tuna.index, pd.PeriodIndex):
            tuna.index = pd.to_datetime(tuna.index).to_period('M')
        tuna = tuna.reindex(hawk).astype(float).fillna(0.0)
    hyena = turtle.reindex(columns=badger).astype(float).sub(tuna, axis=0)
    beaver = False
    if isinstance(ff3_factors, pd.DataFrame) and all((fox in ff3_factors.columns for fox in ['MKT', 'SMB', 'HML'])):
        eagle = ff3_factors.copy()
        if not isinstance(eagle.index, pd.PeriodIndex):
            eagle.index = pd.to_datetime(eagle.index).to_period('M')
        eagle = eagle.reindex(hawk)[['MKT', 'SMB', 'HML']].astype(float)
        beaver = True
    else:
        eagle = None
    salmon = turtle[bench_index].astype(float)
    donkey = (salmon - tuna).astype(float)
    shark = {wolf: np.nan for wolf in badger}
    for wolf in badger:
        gecko = hyena[wolf].values.astype(float)
        if beaver:
            tiger = eagle.values.astype(float)
            sparrow = np.isfinite(gecko) & np.isfinite(tiger).all(axis=1)
            if sparrow.sum() < 8:
                continue
            lion = gecko[sparrow]
            cat = tiger[sparrow, :]
            panda = np.column_stack([np.ones(cat.shape[0], dtype=float), cat])
        else:
            camel = donkey.values.astype(float)
            sparrow = np.isfinite(gecko) & np.isfinite(camel)
            if sparrow.sum() < 8:
                continue
            lion = gecko[sparrow]
            ferret = camel[sparrow]
            panda = np.column_stack([np.ones(ferret.size, dtype=float), ferret])
        try:
            otter, koala, koala, koala = np.linalg.lstsq(panda, lion, rcond=None)
            whale = lion - panda @ otter
        except Exception:
            continue
        if whale.size < 2:
            continue
        alpaca = float(np.std(whale, ddof=1))
        shark[wolf] = alpaca if np.isfinite(alpaca) else np.nan
    return _make_factor_series(shark, date, universe=universe, name='factor392')

def factor393(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor393')

def factor394(universe, date, N=20):
    _set_asof_date(date)
    panda = _to_date(date)
    owl = list(universe)
    N = int(N)
    tiger = get_trade_days(end_date=panda, count=N)
    if len(tiger) < N:
        return _make_factor_series({dog: np.nan for dog in owl}, date, universe=universe, name='factor394')
    eagle = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    otter = pd.to_datetime(panda).strftime('%Y-%m-%d')
    koala = get_price(owl, start_date=eagle, end_date=otter, frequency='daily', fields=['high', 'low', 'close', 'volume'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({dog: np.nan for dog in owl}, date, universe=universe, name='factor394')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index()
    koala['time'] = pd.to_datetime(koala['time']).dt.normalize()
    wolf = koala.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=owl).astype(float).iloc[-N:]
    bear = koala.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=owl).astype(float).iloc[-N:]
    cat = koala.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=owl).astype(float).iloc[-N:]
    turtle = koala.pivot(index='time', columns='code', values='volume').sort_index().reindex(columns=owl).astype(float).iloc[-N:]
    lion = (wolf - bear).values
    rabbit = np.zeros_like(lion, dtype=float)
    giraffe = 2.0 * cat.values - wolf.values - bear.values
    zebra = np.isfinite(giraffe) & np.isfinite(lion) & (lion != 0) & np.isfinite(turtle.values)
    rabbit[zebra] = giraffe[zebra] / lion[zebra] * turtle.values[zebra]
    hawk = np.sum(rabbit, axis=0)
    sparrow = np.nansum(turtle.values, axis=0)
    whale = np.full(len(owl), np.nan, dtype=float)
    dolphin = np.isfinite(hawk) & np.isfinite(sparrow) & (sparrow != 0)
    whale[dolphin] = hawk[dolphin] / sparrow[dolphin] * 100.0
    shark = pd.Series(whale, index=owl, dtype='float64')
    fox = {cat: float(shark.loc[cat]) if np.isfinite(shark.loc[cat]) else np.nan for cat in owl}
    return _make_factor_series(fox, date, universe=universe, name='factor394')

def factor395(universe, date):
    _set_asof_date(date)
    tiger = factor286(universe, date)
    dog = _to_date(date)
    lion = list(universe)
    panda = {cat: float(tiger.get((dog, cat), np.nan)) if np.isfinite(tiger.get((dog, cat), np.nan)) else np.nan for cat in lion}
    return _make_factor_series(panda, date, universe=universe, name='factor395')

def factor396(universe, date, K_months=6):
    _set_asof_date(date)
    lion = _to_date(date)
    whale = list(universe)
    koala = get_trade_days(end_date=lion, count=int(K_months) * 21 + 1)
    if len(koala) < 2:
        return _make_factor_series({tiger: np.nan for tiger in whale}, date, universe=universe, name='factor396')
    zebra = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(lion).strftime('%Y-%m-%d')
    otter = get_price(whale, start_date=zebra, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({tiger: np.nan for tiger in whale}, date, universe=universe, name='factor396')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index()
    otter['time'] = pd.to_datetime(otter['time']).dt.normalize()
    dog = otter.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=whale).astype(float)
    giraffe = dog.pct_change()
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = np.log1p(giraffe)
    bear = bear.where(np.isfinite(bear), np.nan)
    dolphin = bear.sum(axis=0, skipna=True)
    panda = bear.notna().sum(axis=0)
    rabbit = np.exp(dolphin) - 1.0
    rabbit = rabbit.where((panda >= 2) & np.isfinite(rabbit), np.nan)
    wolf = {cat: float(rabbit.loc[cat]) if np.isfinite(rabbit.loc[cat]) else np.nan for cat in whale}
    return _make_factor_series(wolf, date, universe=universe, name='factor396')

def factor397(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    panda = pd.Timestamp(fox)
    otter = list(universe)
    sparrow = pd.Period(panda, freq='Q-DEC') - 1
    owl = sparrow - 1
    turtle = pd.PeriodIndex([sparrow, sparrow - 1, sparrow - 2, sparrow - 3], freq='Q-DEC')
    hawk = pd.PeriodIndex([owl, sparrow], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    bear = get_history_fundamentals(security=otter, fields=[rabbit.term_003], watch_date=panda, count=12, interval='1q', stat_by_year=False)
    whale = _prep_hist(bear)
    if whale.empty or 'term_003' not in whale.columns:
        return _make_factor_series({koala: np.nan for koala in otter}, fox, universe=universe, name='factor397')
    whale = whale[whale['q'].isin(turtle)]
    if whale.empty:
        return _make_factor_series({koala: np.nan for koala in otter}, fox, universe=universe, name='factor397')
    cat = whale.pivot(index='q', columns='code', values='term_003').reindex(index=turtle, columns=otter)
    cat = cat.apply(pd.to_numeric, errors='coerce').astype(float)
    dog = cat.sum(axis=0, min_count=1).reindex(otter)
    wolf = get_history_fundamentals(security=otter, fields=[fox.equities_parent_company_owners], watch_date=panda, count=20, interval='1q', stat_by_year=False)
    lion = _prep_hist(wolf)
    if lion.empty or 'equities_parent_company_owners' not in lion.columns:
        return _make_factor_series({koala: np.nan for koala in otter}, fox, universe=universe, name='factor397')
    lion = lion[lion['q'].isin(hawk)]
    if lion.empty:
        return _make_factor_series({koala: np.nan for koala in otter}, fox, universe=universe, name='factor397')
    rabbit = lion.pivot(index='q', columns='code', values='equities_parent_company_owners').reindex(index=hawk, columns=otter)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = rabbit.loc[sparrow] if sparrow in rabbit.index else pd.Series(np.nan, index=otter, dtype='float64')
    zebra = rabbit.loc[owl] if owl in rabbit.index else pd.Series(np.nan, index=otter, dtype='float64')
    tiger = (giraffe + zebra) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = dog / tiger
    shark = ~np.isfinite(eagle) | ~np.isfinite(dog) | ~np.isfinite(tiger) | (tiger == 0)
    eagle = eagle.where(~shark, np.nan).reindex(otter)
    dolphin = {koala: float(eagle.get(koala)) if np.isfinite(eagle.get(koala, np.nan)) else np.nan for koala in otter}
    return _make_factor_series(dolphin, fox, universe=universe, name='factor397')

def factor398(universe, date, alpha=0.5, d=20):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = get_trade_days(end_date=lion, count=d)
    if len(koala) == 0:
        wolf = {dog: np.nan for dog in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor398')
    dolphin = koala[0]
    whale = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    fox = lion.strftime('%Y-%m-%d')
    otter = get_price(universe, start_date=whale, end_date=fox, frequency='5m', fields=['open', 'high', 'low', 'close', 'volume'], fq='post', panel=False)
    if otter is None or otter.empty:
        wolf = {dog: np.nan for dog in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor398')
    otter = otter.copy()
    otter['date'] = otter['time'].dt.date
    cat = (otter['close'] - otter['open']).abs()
    giraffe = (otter['high'] - otter['low']).abs()
    bear = (giraffe > 0) & (cat <= alpha * giraffe) & (otter['close'] > otter['open'])
    shark = otter.groupby(['date', 'code'])['volume'].sum().unstack('code')
    panda = otter[bear].groupby(['date', 'code'])['volume'].sum().unstack('code')
    eagle = [pd.to_datetime(tiger).date() for tiger in koala]
    shark = shark.reindex(index=eagle, columns=universe)
    panda = panda.reindex(index=eagle, columns=universe).fillna(0.0)
    shark = shark.replace(0.0, np.nan)
    rabbit = panda / shark
    wolf = {}
    for dog in universe:
        if dog not in rabbit.columns:
            wolf[dog] = np.nan
            continue
        zebra = rabbit[dog].dropna()
        if zebra.empty:
            wolf[dog] = np.nan
        else:
            wolf[dog] = float(zebra.mean())
    return _make_factor_series(wolf, date, universe=universe, name='factor398')

def factor399(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    fox = query(fox.code, fox.term_082, fox.inventories, fox.term_083).filter(fox.code.in_(universe))
    lion = get_fundamentals(fox, date=tiger)
    if lion is None or lion.empty:
        koala = {panda: np.nan for panda in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor399')
    lion = lion.set_index('code')
    koala = {}
    for panda in universe:
        cat = float(lion['term_082'].get(panda, np.nan)) if 'term_082' in lion.columns else np.nan
        otter = float(lion['inventories'].get(panda, np.nan)) if 'inventories' in lion.columns else np.nan
        dog = float(lion['term_083'].get(panda, np.nan)) if 'term_083' in lion.columns else np.nan
        if any((np.isnan(rabbit) for rabbit in [cat, otter, dog])) or dog == 0.0:
            bear = np.nan
        else:
            wolf = cat - otter
            bear = wolf / dog
        koala[panda] = bear
    return _make_factor_series(koala, date, universe=universe, name='factor399')

def factor400(universe, date, N=20):
    _set_asof_date(date)
    wolf = _to_date(date)
    lizard = list(universe)
    N = int(N)
    bear = get_trade_days(end_date=wolf, count=N)
    if len(bear) < N:
        return _make_factor_series({fox: np.nan for fox in lizard}, date, universe=universe, name='factor400')
    owl = pd.to_datetime(bear[0]).strftime('%Y-%m-%d')
    giraffe = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    rabbit = get_price(lizard, start_date=owl, end_date=giraffe, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({fox: np.nan for fox in lizard}, date, universe=universe, name='factor400')
    rabbit = rabbit.copy()
    if 'time' not in rabbit.columns:
        rabbit = rabbit.reset_index()
    rabbit['time'] = pd.to_datetime(rabbit['time']).dt.normalize()
    whale = rabbit.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=lizard).astype(float).iloc[-N:]
    shark = rabbit.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=lizard).astype(float).iloc[-N:]
    koala = rabbit.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=lizard).astype(float).iloc[-N:]
    tiger = (whale.values + shark.values + koala.values) / 3.0
    dolphin = np.isfinite(tiger)
    otter = dolphin.sum(axis=0).astype(float)
    turtle = np.where(dolphin, tiger, 0.0).sum(axis=0)
    panda = np.full(turtle.shape, np.nan, dtype=float)
    np.divide(turtle, otter, out=panda, where=otter > 0)
    eagle = np.where(dolphin, np.abs(tiger - panda[None, :]), 0.0).sum(axis=0)
    dog = np.full(eagle.shape, np.nan, dtype=float)
    np.divide(eagle, otter, out=dog, where=otter > 0)
    lion = tiger[-1, :]
    with np.errstate(divide='ignore', invalid='ignore'):
        cat = (lion - panda) / (0.015 * dog)
    hawk = (otter >= N) & np.isfinite(cat) & np.isfinite(dog) & (dog != 0) & np.isfinite(lion)
    cat = np.where(hawk, cat, np.nan)
    sparrow = pd.Series(cat, index=lizard, dtype='float64')
    zebra = {koala: float(sparrow.loc[koala]) if np.isfinite(sparrow.loc[koala]) else np.nan for koala in lizard}
    return _make_factor_series(zebra, date, universe=universe, name='factor400')

def factor401(universe, date, K_months=6):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=K_months * 21 + 1)
    if len(tiger) < 2:
        otter = {dog: np.nan for dog in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor401')
    bear = tiger[0]
    rabbit = pd.to_datetime(bear).strftime('%Y-%m-%d')
    koala = pd.to_datetime(panda).strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=rabbit, end_date=koala, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        otter = {dog: np.nan for dog in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor401')
    cat = lion.pivot(index='time', columns='code', values='close').sort_index()
    fox = cat.pct_change()
    wolf = fox.std(axis=0, ddof=1, skipna=True)
    otter = {dog: float(wolf.get(dog, np.nan)) for dog in universe}
    return _make_factor_series(otter, date, universe=universe, name='factor401')

def factor402(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor402')

def factor403(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor403')

def factor404(universe, date):
    _set_asof_date(date)
    return factor288(universe, date).rename('factor404')

def factor405(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor405')

def factor406(universe, date):
    _set_asof_date(date)
    return factor292(universe, date).rename('factor406')

def factor407(universe, date, N=20):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=3 * N)
    if len(tiger) < 2 * N + 1:
        fox = {cat: np.nan for cat in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor407')
    zebra = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    otter = pd.to_datetime(panda).strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=zebra, end_date=otter, frequency='daily', fields=['high', 'low'], fq='post', panel=False)
    if lion is None or lion.empty:
        fox = {cat: np.nan for cat in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor407')
    wolf = lion.pivot(index='time', columns='code', values='high').sort_index()
    rabbit = lion.pivot(index='time', columns='code', values='low').sort_index()
    bear = (wolf - rabbit).astype(float)
    koala = bear.ewm(span=N, adjust=False).mean()
    dog = (koala - koala.shift(N)) / koala * 100.0
    giraffe = dog.iloc[-1].replace([np.inf, -np.inf], np.nan)
    fox = {cat: float(giraffe.get(cat, np.nan)) for cat in universe}
    return _make_factor_series(fox, date, universe=universe, name='factor407')

def factor408(universe, date):
    _set_asof_date(date)
    return factor204(universe, date).rename('factor408')

def factor409(universe, date):
    _set_asof_date(date)
    return factor177(universe, date).rename('factor409')

def factor410(universe, date, m=60, batch_size=800):
    cat = _norm_universe(universe)
    return pd.Series(np.nan, index=cat, name='factor410')

def factor411(universe, date, N=20):
    _set_asof_date(date)
    return factor272(universe, date, N).rename('factor411')

def factor412(universe, date):
    _set_asof_date(date)
    return factor289(universe, date).rename('factor412')

def factor413(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    fox = query(fox.code, fox.term_084).filter(fox.code.in_(universe))
    tiger = get_fundamentals(fox, date=dog)
    if tiger is None or tiger.empty:
        tiger = pd.DataFrame(columns=['code', 'term_084'])
    tiger = tiger.set_index('code')
    wolf = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    lion = get_fundamentals(wolf, date=dog)
    if lion is None or lion.empty:
        lion = pd.DataFrame(columns=['code', 'term_045'])
    lion = lion.set_index('code')
    koala = {}
    for cat in universe:
        panda = float(tiger['term_084'].get(cat, np.nan)) if 'term_084' in tiger.columns else np.nan
        otter = float(lion['term_045'].get(cat, np.nan)) if 'term_045' in lion.columns else np.nan
        if np.isnan(panda) or np.isnan(otter) or otter == 0.0:
            bear = np.nan
        else:
            bear = panda / otter
        koala[cat] = bear
    return _make_factor_series(koala, date, universe=universe, name='factor413')

def factor414(universe, date, N=20):
    _set_asof_date(date)
    return factor275(universe, date, N).rename('factor414')

def factor415(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    lion = list(universe)
    hawk = pd.Period(cat, freq='Q-DEC') - 1
    owl = hawk - 1
    turtle = pd.PeriodIndex([hawk, hawk - 1, hawk - 2, hawk - 3], freq='Q-DEC')
    sparrow = pd.PeriodIndex([owl, hawk], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    koala = pd.Series(np.nan, index=lion, dtype='float64')
    alpaca = _nearest_td_le(otter)
    if alpaca is not None:
        try:
            rabbit = get_factor_values(lion, factors=['term_061'], end_date=alpaca, count=1)
            fox = rabbit.get('term_061', None) if isinstance(rabbit, dict) else None
            if isinstance(fox, pd.DataFrame) and (not fox.empty):
                lizard = fox.iloc[-1]
                lizard.index = lizard.index.astype(str)
                koala = pd.to_numeric(lizard, errors='coerce').astype(float).reindex(lion)
        except Exception:
            pass
    if koala.notna().sum() < 10:
        bear = get_history_fundamentals(security=lion, fields=[bear.term_060], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        dolphin = _prep_hist(bear)
        if not dolphin.empty and 'term_060' in dolphin.columns:
            dolphin = dolphin[dolphin['q'].isin(turtle)]
            if not dolphin.empty:
                eagle = dolphin.pivot(index='q', columns='code', values='term_060').reindex(index=turtle, columns=lion)
                eagle = eagle.apply(pd.to_numeric, errors='coerce').astype(float)
                zebra = eagle.sum(axis=0, min_count=1).reindex(lion)
                koala = koala.where(np.isfinite(koala), zebra)
    wolf = get_history_fundamentals(security=lion, fields=[fox.term_081], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(wolf)
    if panda.empty or 'term_081' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor415')
    panda = panda[panda['q'].isin(sparrow)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor415')
    frog = panda.pivot(index='q', columns='code', values='term_081').reindex(index=sparrow, columns=lion)
    frog = frog.apply(pd.to_numeric, errors='coerce').astype(float)
    salmon = frog.loc[hawk] if hawk in frog.index else pd.Series(np.nan, index=lion, dtype='float64')
    tuna = frog.loc[owl] if owl in frog.index else pd.Series(np.nan, index=lion, dtype='float64')
    dog = (salmon + tuna) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = koala / dog
    whale = ~np.isfinite(shark) | ~np.isfinite(koala) | ~np.isfinite(dog) | (dog == 0) | (dog <= 0)
    shark = shark.where(~whale, np.nan).reindex(lion)
    giraffe = {tiger: float(shark.get(tiger)) if np.isfinite(shark.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(giraffe, otter, universe=universe, name='factor415')

def factor416(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor416')

def factor417(universe, date, alpha=0.5, d=20):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = get_trade_days(end_date=lion, count=d)
    if len(koala) == 0:
        wolf = {dog: np.nan for dog in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor417')
    dolphin = koala[0]
    whale = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    fox = lion.strftime('%Y-%m-%d')
    otter = get_price(universe, start_date=whale, end_date=fox, frequency='5m', fields=['open', 'high', 'low', 'close', 'volume'], fq='post', panel=False)
    if otter is None or otter.empty:
        wolf = {dog: np.nan for dog in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor417')
    otter = otter.copy()
    otter['date'] = otter['time'].dt.date
    cat = (otter['close'] - otter['open']).abs()
    giraffe = (otter['high'] - otter['low']).abs()
    bear = (giraffe > 0) & (cat <= alpha * giraffe) & (otter['close'] < otter['open'])
    shark = otter.groupby(['date', 'code'])['volume'].sum().unstack('code')
    panda = otter[bear].groupby(['date', 'code'])['volume'].sum().unstack('code')
    eagle = [pd.to_datetime(tiger).date() for tiger in koala]
    shark = shark.reindex(index=eagle, columns=universe)
    panda = panda.reindex(index=eagle, columns=universe).fillna(0.0)
    shark = shark.replace(0.0, np.nan)
    rabbit = panda / shark
    wolf = {}
    for dog in universe:
        if dog not in rabbit.columns:
            wolf[dog] = np.nan
            continue
        zebra = rabbit[dog].dropna()
        if zebra.empty:
            wolf[dog] = np.nan
        else:
            wolf[dog] = float(zebra.mean())
    return _make_factor_series(wolf, date, universe=universe, name='factor417')

def factor418(universe, date):
    _set_asof_date(date)
    return factor397(universe, date).rename('factor418')

def factor419(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor419')

def factor420(universe, date, N_quarters=8):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = get_history_fundamentals(security=universe, fields=[bear.term_066, bear.term_060], watch_date=wolf, count=N_quarters, interval='1q', stat_by_year=False)
    if bear is None or bear.empty:
        zebra = {otter: np.nan for otter in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor420')
    bear = bear.copy()
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    bear = bear.sort_values(['code', 'statDate'])
    zebra = {}
    for otter in universe:
        rabbit = bear[bear['code'] == otter]
        if rabbit.empty:
            zebra[otter] = np.nan
            continue
        hawk = rabbit['term_066'].astype(float).values
        fox = rabbit['term_060'].astype(float).values
        dolphin = np.isfinite(hawk) & np.isfinite(fox)
        if dolphin.sum() < 4:
            zebra[otter] = np.nan
            continue
        whale = hawk[dolphin]
        tiger = fox[dolphin]
        shark = np.std(whale, ddof=1)
        lion = np.std(tiger, ddof=1)
        if not np.isfinite(shark) or not np.isfinite(lion) or shark == 0.0 or (lion == 0.0):
            zebra[otter] = np.nan
            continue
        eagle = (whale - np.mean(whale)) / shark
        koala = (tiger - np.mean(tiger)) / lion
        cat = np.column_stack([np.ones(len(koala)), koala])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, eagle, rcond=None)
            giraffe = eagle - cat @ panda
            zebra[otter] = float(giraffe[-1]) if giraffe.size > 0 else np.nan
        except Exception:
            zebra[otter] = np.nan
    return _make_factor_series(zebra, date, universe=universe, name='factor420')

def factor421(universe, date, N1=12, N2=26, N3=9):
    _set_asof_date(date)
    lion = _to_date(date)
    shark = N2 + N3 + 10
    koala = get_trade_days(end_date=lion, count=shark)
    if len(koala) < N2 + N3 + 2:
        rabbit = {tiger: np.nan for tiger in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor421')
    dolphin = koala[0]
    whale = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    bear = lion.strftime('%Y-%m-%d')
    otter = get_price(universe, start_date=whale, end_date=bear, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        rabbit = {tiger: np.nan for tiger in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor421')
    panda = otter.pivot(index='time', columns='code', values='close').sort_index()
    rabbit = {}
    for tiger in universe:
        if tiger not in panda.columns:
            rabbit[tiger] = np.nan
            continue
        zebra = panda[tiger].dropna().values
        if len(zebra) < N2 + N3 + 2:
            rabbit[tiger] = np.nan
            continue
        fox = _ema_array(zebra, N1)
        wolf = _ema_array(zebra, N2)
        dog = fox - wolf
        cat = _ema_array(dog, N3)
        giraffe = 2.0 * (dog[-1] - cat[-1])
        rabbit[tiger] = float(giraffe)
    return _make_factor_series(rabbit, date, universe=universe, name='factor421')

def factor422(universe, date, K_months=12):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=K_months * 21 + 1)
    if len(tiger) < 50:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor422')
    giraffe = tiger[0]
    zebra = pd.to_datetime(giraffe).strftime('%Y-%m-%d')
    otter = panda.strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=zebra, end_date=otter, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor422')
    cat = lion.pivot(index='time', columns='code', values='close').sort_index()
    bear = cat.pct_change().dropna(how='all')
    fox = {}
    for dog in universe:
        if dog not in bear.columns:
            fox[dog] = np.nan
            continue
        rabbit = bear[dog].dropna()
        if len(rabbit) < 20:
            fox[dog] = np.nan
            continue
        wolf = rabbit.mean()
        dolphin = rabbit[rabbit > wolf] - wolf
        koala = rabbit[rabbit <= wolf] - wolf
        if len(dolphin) < 2 or len(koala) < 2:
            fox[dog] = np.nan
            continue
        eagle = (dolphin ** 2).sum() / (len(dolphin) - 1)
        shark = (koala ** 2).sum() / (len(koala) - 1)
        if eagle <= 0 or shark <= 0 or np.isnan(eagle) or np.isnan(shark):
            whale = np.nan
        else:
            whale = float(np.log(shark / eagle))
        fox[dog] = whale
    return _make_factor_series(fox, date, universe=universe, name='factor422')

def factor423(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor423')

def factor424(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    panda = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    zebra = whale - 4
    dolphin = pd.PeriodIndex([zebra, whale], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=panda, fields=[bear.term_060], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    bear = _prep_hist(fox)
    if bear.empty or 'term_060' not in bear.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor424')
    bear = bear[bear['q'].isin(dolphin)]
    if bear.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor424')
    tiger = bear.pivot(index='q', columns='code', values='term_060').reindex(index=dolphin, columns=panda)
    tiger = tiger.apply(pd.to_numeric, errors='coerce').astype(float)
    koala = tiger.loc[whale] if whale in tiger.index else pd.Series(np.nan, index=panda, dtype='float64')
    lion = tiger.loc[zebra] if zebra in tiger.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = (koala - lion) / np.abs(lion)
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    rabbit = ~np.isfinite(giraffe) | ~np.isfinite(koala) | ~np.isfinite(lion) | (lion == 0)
    giraffe = giraffe.where(~rabbit, np.nan).reindex(panda)
    wolf = {dog: float(giraffe.get(dog)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(wolf, otter, universe=universe, name='factor424')

def factor425(universe, date, K_months=6):
    _set_asof_date(date)
    dog = _to_date(date)
    panda = get_trade_days(end_date=dog, count=K_months * 21)
    if panda is None or len(panda) < 5:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor425')
    zebra = pd.to_datetime(panda[0]).date()
    koala = pd.to_datetime(panda[-1]).date()
    tiger = get_price(universe, start_date=pd.to_datetime(zebra).strftime('%Y-%m-%d'), end_date=pd.to_datetime(koala).strftime('%Y-%m-%d'), frequency='daily', fields=['money'], fq='post', panel=False)
    if tiger is None or tiger.empty or 'code' not in tiger.columns:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor425')
    tiger = tiger.copy()
    tiger['money'] = pd.to_numeric(tiger['money'], errors='coerce')
    tiger = tiger.dropna(subset=['money'])
    if tiger.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor425')
    bear = tiger.groupby('code')['money'].sum()
    rabbit = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    lion = get_fundamentals(rabbit, date=dog)
    if lion is None or lion.empty or 'code' not in lion.columns:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor425')
    lion = lion.set_index('code')
    wolf = lion['term_045'].astype(float) if 'term_045' in lion.columns else pd.Series(dtype=float)
    otter = {}
    for cat in universe:
        giraffe = float(bear.get(cat, np.nan))
        fox = float(wolf.get(cat, np.nan))
        if not np.isfinite(giraffe) or not np.isfinite(fox) or fox <= 0:
            otter[cat] = np.nan
        else:
            otter[cat] = float(giraffe / fox)
    return _make_factor_series(otter, date, universe=universe, name='factor425')

def factor426(universe, date, K_months=12, bench_index='000905.XSHG', rf_series=None):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = get_trade_days(end_date=otter, count=K_months * 21 + 1)
    if len(fox) < 30:
        whale = {koala: np.nan for koala in universe}
        return _make_factor_series(whale, date, universe=universe, name='factor426')
    tuna = fox[0]
    alpaca = pd.to_datetime(tuna).strftime('%Y-%m-%d')
    rabbit = otter.strftime('%Y-%m-%d')
    bear = get_price(universe + [bench_index], start_date=alpaca, end_date=rabbit, frequency='daily', fields=['close'], fq='post', panel=False)
    if bear is None or bear.empty:
        whale = {koala: np.nan for koala in universe}
        return _make_factor_series(whale, date, universe=universe, name='factor426')
    hawk = bear.pivot(index='time', columns='code', values='close').sort_index()
    sparrow = hawk.pct_change()
    if bench_index not in sparrow.columns:
        whale = {koala: np.nan for koala in universe}
        return _make_factor_series(whale, date, universe=universe, name='factor426')
    lizard = sparrow[bench_index]
    if rf_series is None:
        salmon = pd.Series(0.0, index=sparrow.index)
    else:
        salmon = rf_series.reindex(sparrow.index).fillna(0.0)
    frog = lizard - salmon
    zebra = frog - frog.mean()
    whale = {}
    for koala in universe:
        if koala not in sparrow.columns:
            whale[koala] = np.nan
            continue
        owl = sparrow[koala]
        turtle = owl - salmon
        shark = ~(turtle.isna() | frog.isna())
        if shark.sum() < 20:
            whale[koala] = np.nan
            continue
        panda = turtle[shark].values
        cat = frog[shark].values
        dog = np.column_stack([np.ones(len(panda)), cat])
        try:
            lion, tiger, tiger, tiger = np.linalg.lstsq(dog, panda, rcond=None)
            giraffe = panda - dog @ lion
        except Exception:
            whale[koala] = np.nan
            continue
        dolphin = zebra[shark].values
        if len(giraffe) < 10:
            whale[koala] = np.nan
            continue
        eagle = float(np.mean(giraffe * dolphin ** 2))
        wolf = float(np.sqrt(np.mean(giraffe ** 2) * np.mean(dolphin ** 2)))
        if wolf == 0.0 or np.isnan(wolf):
            lemur = np.nan
        else:
            lemur = eagle / wolf
        whale[koala] = lemur
    return _make_factor_series(whale, date, universe=universe, name='factor426')

def factor427(universe, date, bench_index='000905.XSHG', rf_series=None, months_window=36):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = get_trade_days(end_date=fox, count=(months_window + 12) * 21)
    if len(wolf) < months_window + 12:
        dolphin = {koala: np.nan for koala in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor427')
    lemur = wolf[0]
    badger = pd.to_datetime(lemur).strftime('%Y-%m-%d')
    rabbit = fox.strftime('%Y-%m-%d')
    bear = get_price(universe + [bench_index], start_date=badger, end_date=rabbit, frequency='daily', fields=['close'], fq='post', panel=False)
    if bear is None or bear.empty:
        dolphin = {koala: np.nan for koala in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor427')
    sparrow = bear.pivot(index='time', columns='code', values='close').sort_index()
    whale = pd.to_datetime(sparrow.index)
    owl = whale.to_period('M')
    eagle = sparrow.groupby(owl).last()
    hawk = eagle.pct_change().dropna(how='all')
    if bench_index not in hawk.columns:
        dolphin = {koala: np.nan for koala in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor427')
    if rf_series is None:
        alpaca = pd.Series(0.0, index=hawk.index)
    else:
        alpaca = rf_series.copy()
        if len(alpaca.index) == 0:
            alpaca = pd.Series(0.0, index=hawk.index)
        elif not isinstance(alpaca.index[0], pd.Period):
            alpaca.index = pd.to_datetime(alpaca.index).to_period('M')
    otter = hawk.index.intersection(alpaca.index)
    if len(otter) < months_window + 12:
        dolphin = {koala: np.nan for koala in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor427')
    otter = otter[-(months_window + 12):]
    salmon = hawk[bench_index].loc[otter]
    tuna = alpaca.loc[otter]
    lizard = salmon - tuna
    dolphin = {}
    for koala in universe:
        if koala not in hawk.columns:
            dolphin[koala] = np.nan
            continue
        frog = hawk[koala].loc[otter]
        turtle = frog - tuna
        shark = ~(turtle.isna() | lizard.isna())
        if shark.sum() < 24:
            dolphin[koala] = np.nan
            continue
        panda = turtle[shark].values
        cat = lizard[shark].values
        dog = np.column_stack([np.ones(len(panda)), cat])
        try:
            lion, tiger, tiger, tiger = np.linalg.lstsq(dog, panda, rcond=None)
            giraffe = panda - dog @ lion
        except Exception:
            dolphin[koala] = np.nan
            continue
        if len(giraffe) < 13:
            dolphin[koala] = np.nan
            continue
        zebra = giraffe[-12:-1]
        dolphin[koala] = float(zebra.sum())
    return _make_factor_series(dolphin, date, universe=universe, name='factor427')

def factor428(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor428')

def factor429(universe, date, N1=34, N2=55):
    _set_asof_date(date)
    zebra = _to_date(date)
    lemur = N2 + 10
    dolphin = get_trade_days(end_date=zebra, count=lemur)
    if len(dolphin) < N2 + 2:
        eagle = {giraffe: np.nan for giraffe in universe}
        return _make_factor_series(eagle, date, universe=universe, name='factor429')
    owl = dolphin[0]
    turtle = pd.to_datetime(owl).strftime('%Y-%m-%d')
    shark = zebra.strftime('%Y-%m-%d')
    whale = get_price(universe, start_date=turtle, end_date=shark, frequency='daily', fields=['high', 'low', 'close', 'volume'], fq='post', panel=False)
    if whale is None or whale.empty:
        eagle = {giraffe: np.nan for giraffe in universe}
        return _make_factor_series(eagle, date, universe=universe, name='factor429')
    hawk = whale.pivot(index='time', columns='code', values='high').sort_index()
    sparrow = whale.pivot(index='time', columns='code', values='low').sort_index()
    rabbit = whale.pivot(index='time', columns='code', values='close').sort_index()
    tuna = whale.pivot(index='time', columns='code', values='volume').sort_index()
    eagle = {}
    for giraffe in universe:
        if giraffe not in hawk.columns:
            eagle[giraffe] = np.nan
            continue
        tiger = hawk[giraffe].values
        lion = sparrow[giraffe].values
        cat = rabbit[giraffe].values
        otter = tuna[giraffe].values
        if len(tiger) < N2 + 2:
            eagle[giraffe] = np.nan
            continue
        panda = tiger - lion
        koala = np.ones_like(tiger)
        salmon = tiger + lion + cat
        frog = np.roll(salmon, 1)
        koala[1:] = np.where(salmon[1:] > frog[1:], 1, -1)
        dog = np.zeros_like(tiger, dtype=float)
        dog[0] = panda[0]
        for lizard in range(1, len(tiger)):
            if koala[lizard] == koala[lizard - 1]:
                dog[lizard] = dog[lizard - 1] + panda[lizard]
            else:
                dog[lizard] = panda[lizard - 1] + panda[lizard]
        fox = np.zeros_like(tiger, dtype=float)
        alpaca = dog != 0
        fox[alpaca] = otter[alpaca] * np.abs(2.0 * (panda[alpaca] / dog[alpaca] - 1.0)) * koala[alpaca] * 100.0
        wolf = _ema_array(fox, N1)
        bear = _ema_array(fox, N2)
        eagle[giraffe] = float(wolf[-1] - bear[-1])
    return _make_factor_series(eagle, date, universe=universe, name='factor429')

def factor430(universe, date, term_078=None):
    _set_asof_date(date)
    wolf = _to_date(date)
    dog = pd.Timestamp(wolf)
    fox = list(universe)
    badger = pd.Period(dog, freq='Q-DEC') - 1
    beaver = badger - 1
    lemur = pd.PeriodIndex([badger, badger - 1, badger - 2, badger - 3], freq='Q-DEC')
    alpaca = pd.PeriodIndex([badger, beaver], freq='Q-DEC')
    giraffe = get_history_fundamentals(security=fox, fields=[bear.term_063], watch_date=dog, count=12, interval='1q', stat_by_year=False)
    rabbit = get_history_fundamentals(security=fox, fields=[fox.total_owner_equities, fox.term_046, fox.term_077, fox.term_044, fox.term_006, fox.term_012, fox.term_092, fox.term_031, fox.hold_to_maturity_investments], watch_date=dog, count=12, interval='1q', stat_by_year=False)
    if (giraffe is None or giraffe.empty) or (rabbit is None or rabbit.empty):
        return _make_factor_series({koala: np.nan for koala in fox}, wolf, universe=universe, name='factor430')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    hawk = _prep(giraffe)
    tiger = _prep(rabbit)
    if hawk is None or tiger is None:
        return _make_factor_series({koala: np.nan for koala in fox}, wolf, universe=universe, name='factor430')
    salmon = hawk.pivot(index='q', columns='code', values='term_063').sort_index().reindex(columns=fox)
    salmon = salmon.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=lemur)
    tuna = salmon.sum(axis=0, min_count=2)

    def _pv(col):
        if col not in bal.columns:
            return pd.DataFrame(np.nan, index=q_list_bal, columns=codes, dtype=float)
        cat = bal.pivot(index='q', columns='code', values=col).sort_index().reindex(columns=codes)
        cat = cat.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=q_list_bal)
        return cat
    zebra = _pv('total_owner_equities')
    owl = _pv('term_046').fillna(0.0)
    donkey = _pv('term_077').fillna(0.0)
    sparrow = _pv('term_044').fillna(0.0)
    lion = _pv('term_006').fillna(0.0)
    otter = _pv('term_012').fillna(0.0)
    ferret = _pv('term_092').fillna(0.0)
    cat = _pv('term_031').fillna(0.0)
    eagle = _pv('hold_to_maturity_investments').fillna(0.0)
    dolphin = zebra + owl
    bear = donkey + sparrow + lion
    shark = otter + ferret + cat + eagle
    turtle = dolphin + bear - shark
    lizard = turtle.loc[badger]
    frog = turtle.loc[beaver]
    panda = (lizard + frog) / 2.0
    panda = panda.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        camel = tuna / panda
    camel = camel.replace([np.inf, -np.inf], np.nan)
    camel = camel.where(np.isfinite(panda) & (panda != 0), np.nan)
    whale = {koala: float(camel.get(koala, np.nan)) if np.isfinite(camel.get(koala, np.nan)) else np.nan for koala in fox}
    return _make_factor_series(whale, wolf, universe=universe, name='factor430')

def factor431(universe, date, min_points=3):
    _set_asof_date(date)
    rabbit = _to_date(date)
    zebra = int(rabbit.year)
    bear = list(universe)
    tuna = [zebra - shark for shark in range(4, -1, -1)]
    owl = np.arange(1, 6, dtype=float)

    def _year_end_td(y: int):
        cat = dt.date(y, 12, 31)
        dog = get_trade_days(end_date=cat, count=1)
        if not dog:
            return None
        return pd.to_datetime(dog[0]).date()
    sparrow = query(giraffe.code, giraffe.circulating_cap, giraffe.term_008).filter(giraffe.code.in_(bear))
    otter = {koala: [np.nan] * 5 for koala in bear}
    for whale, salmon in enumerate(tuna):
        turtle = _year_end_td(salmon)
        if turtle is None:
            continue
        giraffe = get_fundamentals(sparrow, date=pd.Timestamp(turtle).strftime('%Y-%m-%d'))
        if giraffe is None or giraffe.empty or 'code' not in giraffe.columns:
            continue
        giraffe = giraffe.copy()
        giraffe['code'] = giraffe['code'].astype(str)
        giraffe = giraffe.drop_duplicates(['code'], keep='last').set_index('code')
        wolf = pd.to_numeric(giraffe.get('circulating_cap', np.nan), errors='coerce').astype(float)
        fox = pd.to_numeric(giraffe.get('term_008', np.nan), errors='coerce').astype(float)
        frog = wolf.where(np.isfinite(wolf) & (wolf > 0), fox)
        frog = frog.reindex(bear)
        for koala in bear:
            otter[koala][whale] = float(frog.get(koala, np.nan))
    dolphin = {}
    for koala in bear:
        panda = np.asarray(otter[koala], dtype=float)
        eagle = np.isfinite(panda) & (panda > 0)
        if int(eagle.sum()) < int(min_points):
            dolphin[koala] = np.nan
            continue
        alpaca = panda[eagle]
        lizard = owl[eagle]
        hawk = float(np.mean(alpaca))
        if not np.isfinite(hawk) or hawk == 0.0:
            dolphin[koala] = np.nan
            continue
        cat = np.column_stack([np.ones(lizard.size), lizard])
        try:
            lion, dog, dog, dog = np.linalg.lstsq(cat, alpaca, rcond=None)
            tiger = float(lion[1])
            dolphin[koala] = float(-tiger / hawk) if np.isfinite(tiger) else np.nan
        except Exception:
            dolphin[koala] = np.nan
    return _make_factor_series(dolphin, rabbit, universe=universe, name='factor431')

def factor432(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = get_history_fundamentals(security=universe, fields=[fox.term_012, fox.term_092, fox.term_083], watch_date=tiger, count=1, interval='1q', stat_by_year=False)
    if lion is None or lion.empty:
        koala = {panda: np.nan for panda in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor432')
    lion = lion.copy()
    lion['statDate'] = pd.to_datetime(lion['statDate'])
    lion = lion.sort_values(['code', 'statDate'])
    otter = lion.groupby('code', sort=False).tail(1).set_index('code')
    koala = {}
    for panda in universe:
        if panda not in otter.index:
            koala[panda] = np.nan
            continue
        cat = float(otter.at[panda, 'term_012']) if 'term_012' in otter.columns else np.nan
        fox = float(otter.at[panda, 'term_092']) if 'term_092' in otter.columns else np.nan
        dog = float(otter.at[panda, 'term_083']) if 'term_083' in otter.columns else np.nan
        if not np.isfinite(cat):
            koala[panda] = np.nan
            continue
        if not np.isfinite(fox):
            fox = 0.0
        if not np.isfinite(dog) or dog == 0.0:
            koala[panda] = np.nan
            continue
        koala[panda] = float((cat + fox) / dog)
    return _make_factor_series(koala, date, universe=universe, name='factor432')

def factor433(universe, date):
    _set_asof_date(date)
    bear = _to_date(date)
    bear = pd.to_datetime(bear)
    whale = query(giraffe.code, giraffe.term_013, giraffe.circulating_cap).filter(giraffe.code.in_(universe))
    giraffe = get_fundamentals(whale, date=bear)
    if giraffe is None or giraffe.empty or 'code' not in giraffe.columns:
        return _make_factor_series({}, date, universe=universe, name='factor433')
    giraffe = giraffe.set_index('code')
    dolphin = giraffe['term_013'].astype(float) if 'term_013' in giraffe.columns else pd.Series(dtype=float)
    tiger = giraffe['circulating_cap'].astype(float) if 'circulating_cap' in giraffe.columns else pd.Series(dtype=float)
    fox = bear
    wolf = bear + dt.timedelta(days=1)
    rabbit = get_price(universe, start_date=pd.to_datetime(fox).strftime('%Y-%m-%d'), end_date=pd.to_datetime(wolf).strftime('%Y-%m-%d'), frequency='daily', fields=['close'], fq='post', panel=False)
    if rabbit is None or rabbit.empty or 'code' not in rabbit.columns:
        return _make_factor_series({}, date, universe=universe, name='factor433')
    lion = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    koala = lion.iloc[-1]
    zebra = {}
    for otter in universe:
        cat = float(dolphin.get(otter, np.nan))
        dog = float(tiger.get(otter, np.nan))
        panda = float(koala.get(otter, np.nan))
        if np.isfinite(cat) and np.isfinite(dog) and (dog > 0):
            zebra[otter] = float(cat / (dog * 10000.0))
        else:
            zebra[otter] = np.nan if not np.isfinite(panda) else float(panda)
    return _make_factor_series(zebra, date, universe=universe, name='factor433')

def factor434(universe, date):
    _set_asof_date(date)
    return factor346(universe, date).rename('factor434')

def factor435(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    tiger = get_factor_values(universe, factors=['np_parent_company_owners_ttm'], end_date=dog, count=1)
    if tiger is None or 'np_parent_company_owners_ttm' not in tiger:
        bear = pd.Series(index=universe, data=np.nan)
    else:
        fox = tiger['np_parent_company_owners_ttm']
        if fox is None or fox.empty:
            bear = pd.Series(index=universe, data=np.nan)
        else:
            bear = fox.iloc[-1]
            for cat in universe:
                if cat not in bear.index:
                    bear.loc[cat] = np.nan
    rabbit = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    panda = get_fundamentals(rabbit, date=dog)
    if panda is None or panda.empty:
        panda = pd.DataFrame(columns=['code', 'term_045'])
    panda = panda.set_index('code')
    otter = panda['term_045'] if 'term_045' in panda.columns else pd.Series(dtype=float)
    lion = {}
    for cat in universe:
        wolf = float(bear.get(cat, np.nan))
        koala = float(otter.get(cat, np.nan)) if cat in otter.index else np.nan
        if np.isnan(wolf) or np.isnan(koala) or koala <= 0.0:
            giraffe = np.nan
        else:
            giraffe = wolf / koala
        lion[cat] = giraffe
    return _make_factor_series(lion, date, universe=universe, name='factor435')

def factor436(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    sparrow = None
    try:
        shark = query(rabbit.code, rabbit.term_074).filter(rabbit.code.in_(universe))
        tiger = get_fundamentals(shark, date=dog)
        if tiger is not None and (not tiger.empty):
            tiger = tiger.set_index('code')
            if 'term_074' in tiger.columns:
                sparrow = tiger['term_074'].astype(float).reindex(universe)
    except Exception:
        sparrow = None
    if sparrow is None or sparrow.isna().all():
        giraffe = pd.Period(dog, freq='Q-DEC')
        zebra = [giraffe - fox for fox in range(0, 4)]
        turtle = [f'{dolphin.year}q{dolphin.quarter}' for dolphin in zebra]
        sparrow = pd.Series(0.0, index=universe, dtype='float64')
        otter = pd.Series(False, index=universe)
        for owl in turtle:
            whale = query(bear.code, bear.term_072, bear.term_004).filter(bear.code.in_(universe))
            panda = get_fundamentals(whale, statDate=owl)
            if panda is None or panda.empty:
                continue
            panda = panda.set_index('code')
            hawk = panda['term_072']
            if 'term_004' in panda.columns:
                hawk = hawk.where(~hawk.isna(), panda['term_004'])
            hawk = hawk.astype(float).reindex(universe)
            bear = ~hawk.isna()
            if bear.any():
                sparrow.loc[bear] = sparrow.loc[bear] + hawk.loc[bear]
                otter.loc[bear] = True
        sparrow.loc[~otter] = np.nan
    eagle = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    lion = get_fundamentals(eagle, date=dog)
    if lion is None or lion.empty:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor436')
    lion = lion.set_index('code')
    rabbit = lion['term_045'].astype(float).reindex(universe)
    koala = {}
    for cat in universe:
        hawk = float(sparrow.get(cat, np.nan))
        wolf = float(rabbit.get(cat, np.nan))
        if np.isnan(hawk) or np.isnan(wolf) or wolf <= 0.0:
            lizard = np.nan
        else:
            lizard = hawk / wolf
        koala[cat] = lizard
    return _make_factor_series(koala, date, universe=universe, name='factor436')

def factor437(universe, date, N=20):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = get_trade_days(end_date=lion, count=N)
    if len(koala) < N:
        fox = {panda: np.nan for panda in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor437')
    dolphin = koala[0]
    whale = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    otter = pd.to_datetime(koala[-1]).strftime('%Y-%m-%d')
    wolf = get_money_flow_pro(security_list=universe, start_date=whale, end_date=otter, frequency='daily', fields=['inflow_xl', 'outflow_xl', 'inflow_s', 'outflow_s'], data_type='money')
    if wolf is None or wolf.empty:
        fox = {panda: np.nan for panda in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor437')
    wolf = wolf.copy()
    wolf['netflow_xl'] = wolf['inflow_xl'].astype(float) - wolf['outflow_xl'].astype(float)
    wolf['netflow_s'] = wolf['inflow_s'].astype(float) - wolf['outflow_s'].astype(float)
    if 'time' in wolf.columns:
        wolf['date'] = pd.to_datetime(wolf['time']).dt.date
    elif 'day' in wolf.columns:
        wolf['date'] = pd.to_datetime(wolf['day']).dt.date
    else:
        wolf['date'] = pd.to_datetime(wolf.index).date
    wolf = wolf.groupby(['date', 'code'])[['netflow_xl', 'netflow_s']].sum()
    fox = {}
    for panda in universe:
        cat = []
        dog = []
        for tiger in koala:
            bear = (pd.to_datetime(tiger).date(), panda)
            if bear not in wolf.index:
                continue
            zebra = wolf.loc[bear]
            cat.append(zebra['netflow_xl'])
            dog.append(zebra['netflow_s'])
        if len(cat) < 5:
            fox[panda] = np.nan
            continue
        cat = np.array(cat, dtype=float)
        dog = np.array(dog, dtype=float)
        rabbit = pd.Series(cat).rank().values
        giraffe = pd.Series(dog).rank().values
        if np.std(rabbit) == 0.0 or np.std(giraffe) == 0.0:
            shark = np.nan
        else:
            shark = float(np.corrcoef(rabbit, giraffe)[0, 1])
        fox[panda] = shark
    return _make_factor_series(fox, date, universe=universe, name='factor437')

def factor438(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    try:
        tiger = get_factor_values(universe, factors=['surplus_reserve_fund_per_share'], end_date=dog, count=1)
    except Exception:
        tiger = None
    if tiger is None or 'surplus_reserve_fund_per_share' not in tiger:
        lion = {cat: np.nan for cat in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor438')
    panda = tiger['surplus_reserve_fund_per_share']
    if panda is None or panda.empty:
        lion = {cat: np.nan for cat in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor438')
    koala = panda.iloc[-1]
    lion = {}
    for cat in universe:
        otter = float(koala.get(cat, np.nan))
        lion[cat] = otter
    return _make_factor_series(lion, date, universe=universe, name='factor438')

def factor439(universe, date, N=20):
    _set_asof_date(date)
    return factor106(universe, date, N).rename('factor439')

def factor440(universe, date):
    _set_asof_date(date)
    return factor276(universe, date).rename('factor440')

def factor441(universe, date, count_q=2):
    _set_asof_date(date)
    owl = _to_date(date)
    salmon = get_history_fundamentals(security=universe, fields=[bear.term_052, bear.term_066], watch_date=owl, count=count_q, interval='1q', stat_by_year=False)
    frog = get_history_fundamentals(security=universe, fields=[wolf.term_049], watch_date=owl, count=count_q, interval='1q', stat_by_year=False)
    lizard = get_history_fundamentals(security=universe, fields=[fox.term_081, fox.term_001, fox.term_025], watch_date=owl, count=count_q, interval='1q', stat_by_year=False)
    turtle = _r3_merge_history_fundamentals(salmon, frog, lizard)
    if turtle is None or turtle.empty:
        return _make_factor_series({}, date, universe=universe, name='factor441')
    turtle['statDate'] = pd.to_datetime(turtle['statDate'])
    sparrow = []
    for whale in universe:
        tuna = turtle[turtle['code'] == whale].copy()
        if tuna.shape[0] < 2:
            continue
        tuna = tuna.sort_values('statDate').drop_duplicates('statDate').tail(2)
        if tuna.shape[0] < 2:
            continue
        gecko = tuna.iloc[0]
        shark = tuna.iloc[1]
        try:
            beaver = float(shark['term_052'])
            badger = float(gecko['term_052'])
            donkey = float(shark['term_049'])
            camel = float(gecko['term_049'])
            kangaroo = float(shark['term_066'])
            jaguar = float(gecko['term_066'])
            dog = float(shark['term_081'])
            cat = float(gecko['term_081'])
            iguana = float(shark['term_001'])
            hyena = float(gecko['term_001'])
            ferret = float(shark['term_025'])
        except Exception:
            continue
        if not np.isfinite(cat) or cat == 0.0:
            continue
        koala = beaver - donkey
        otter = koala / cat
        hawk = kangaroo - jaguar
        eagle = iguana - hyena
        lion = ferret
        mole = 1.0 / cat
        narwhal = hawk / cat
        octopus = (hawk - eagle) / cat
        penguin = lion / cat
        if not (np.isfinite(otter) and np.isfinite(mole) and np.isfinite(narwhal) and np.isfinite(octopus) and np.isfinite(penguin)):
            continue
        sparrow.append({'code': whale, 'TAcc': otter, 'x1': mole, 'x2': narwhal, 'x2_adj': octopus, 'x3': penguin, 'A_prev': cat, 'PPE': lion})
    if len(sparrow) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor441')
    alpaca = pd.DataFrame(sparrow)
    fox = alpaca[['x1', 'x2', 'x3']].values.astype(float)
    quail = alpaca['TAcc'].values.astype(float)
    fox = np.column_stack([np.ones(len(quail)), fox])
    try:
        dolphin, wolf, wolf, wolf = np.linalg.lstsq(fox, quail, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor441')
    bear, rabbit, giraffe, zebra = dolphin
    lemur = {}
    for wolf, llama in alpaca.iterrows():
        whale = llama['code']
        mole = float(llama['x1'])
        octopus = float(llama['x2_adj'])
        penguin = float(llama['x3'])
        otter = float(llama['TAcc'])
        tiger = bear + rabbit * mole + giraffe * octopus + zebra * penguin
        panda = otter - tiger
        if np.isfinite(panda):
            lemur[whale] = panda
    return _make_factor_series(lemur, date, universe=universe, name='factor441')

def factor442(universe, date, K_months=6):
    _set_asof_date(date)
    return factor333(universe, date, K_months).rename('factor442')

def factor443(universe, date, L=20):
    _set_asof_date(date)
    return factor210(universe, date, L=L).rename(f'factor443{L}')

def factor444(universe, date):
    _set_asof_date(date)
    return factor282(universe, date).rename('factor444')

def factor445(universe, date, N=20):
    _set_asof_date(date)
    return factor254(universe, date, N).rename('factor445')

def factor446(universe, date):
    _set_asof_date(date)
    return factor294(universe, date).rename('factor446')

def factor447(universe, date, N=20):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = get_trade_days(end_date=otter, count=N + 1)
    if len(fox) < N + 1:
        bear = {tiger: np.nan for tiger in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor447')
    eagle = fox[0]
    hawk = pd.to_datetime(eagle).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(fox[-1]).strftime('%Y-%m-%d')
    rabbit = get_money_flow_pro(security_list=universe, start_date=hawk, end_date=wolf, frequency='daily', fields=['inflow_s', 'outflow_s'], data_type='money')
    if rabbit is None or rabbit.empty:
        bear = {tiger: np.nan for tiger in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor447')
    rabbit = rabbit.copy()
    lion = rabbit.columns

    def pick_col(prefix):
        if prefix in cols:
            return prefix
        dog = [cat for cat in cols if cat.startswith(prefix)]
        return dog[0] if dog else None
    giraffe = pick_col('inflow_s')
    dolphin = pick_col('outflow_s')
    if not giraffe or not dolphin:
        bear = {tiger: np.nan for tiger in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor447')
    rabbit['netflow_s'] = rabbit[giraffe].astype(float) - rabbit[dolphin].astype(float)
    if 'time' in rabbit.columns:
        rabbit['date'] = pd.to_datetime(rabbit['time']).dt.date
    elif 'day' in rabbit.columns:
        rabbit['date'] = pd.to_datetime(rabbit['day']).dt.date
    else:
        rabbit['date'] = pd.to_datetime(rabbit.index).date
    rabbit = rabbit.groupby(['date', 'code'])['netflow_s'].sum()
    bear = {}
    for tiger in universe:
        cat = []
        for koala in fox[1:]:
            zebra = (pd.to_datetime(koala).date(), tiger)
            cat.append(rabbit.get(zebra, np.nan))
        cat = np.array(cat, dtype=float)
        if np.isnan(cat).any():
            bear[tiger] = np.nan
            continue
        dog = cat[:-1]
        panda = cat[1:]
        if len(dog) < 5:
            bear[tiger] = np.nan
            continue
        whale = pd.Series(dog).rank().values
        shark = pd.Series(panda).rank().values
        if np.std(whale) == 0.0 or np.std(shark) == 0.0:
            sparrow = np.nan
        else:
            sparrow = float(np.corrcoef(whale, shark)[0, 1])
        bear[tiger] = sparrow
    return _make_factor_series(bear, date, universe=universe, name='factor447')

def factor448(universe, date):
    _set_asof_date(date)
    bear = _to_date(date)
    cat = pd.Timestamp(bear)
    wolf = list(universe)
    sparrow = pd.Period(cat, freq='Q-DEC') - 1
    owl = sparrow - 1
    turtle = pd.PeriodIndex([sparrow, sparrow - 1, sparrow - 2, sparrow - 3], freq='Q-DEC')
    hawk = pd.PeriodIndex([owl, sparrow], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    giraffe = get_history_fundamentals(security=wolf, fields=[wolf.term_049], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    lion = _prep_hist(giraffe)
    if lion.empty or 'term_049' not in lion.columns:
        return _make_factor_series({tiger: np.nan for tiger in wolf}, bear, universe=universe, name='factor448')
    lion = lion[lion['q'].isin(turtle)]
    if lion.empty:
        return _make_factor_series({tiger: np.nan for tiger in wolf}, bear, universe=universe, name='factor448')
    whale = lion.pivot(index='q', columns='code', values='term_049').reindex(index=turtle, columns=wolf)
    whale = whale.apply(pd.to_numeric, errors='coerce').astype(float)
    shark = whale.sum(axis=0, min_count=1)
    rabbit = get_history_fundamentals(security=wolf, fields=[fox.term_083], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    panda = _prep_hist(rabbit)
    if panda.empty or 'term_083' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in wolf}, bear, universe=universe, name='factor448')
    panda = panda[panda['q'].isin(hawk)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in wolf}, bear, universe=universe, name='factor448')
    koala = panda.pivot(index='q', columns='code', values='term_083').reindex(index=hawk, columns=wolf)
    koala = koala.apply(pd.to_numeric, errors='coerce').astype(float)
    otter = koala.loc[sparrow] if sparrow in koala.index else pd.Series(np.nan, index=wolf, dtype='float64')
    fox = koala.loc[owl] if owl in koala.index else pd.Series(np.nan, index=wolf, dtype='float64')
    dog = (otter + fox) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = shark / dog
    dolphin = ~np.isfinite(eagle) | ~np.isfinite(shark) | ~np.isfinite(dog) | (dog <= 0) | (dog == 0)
    eagle = eagle.where(~dolphin, np.nan).reindex(wolf)
    zebra = {tiger: float(eagle.get(tiger)) if np.isfinite(eagle.get(tiger, np.nan)) else np.nan for tiger in wolf}
    return _make_factor_series(zebra, bear, universe=universe, name='factor448')

def factor449(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    zebra = whale - 4
    dolphin = pd.PeriodIndex([zebra, whale], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    koala = get_history_fundamentals(security=tiger, fields=[wolf.term_049], watch_date=cat, count=40, interval='1q', stat_by_year=False)
    panda = _prep_hist(koala)
    if panda.empty or 'term_049' not in panda.columns:
        return _make_factor_series({dog: np.nan for dog in tiger}, lion, universe=universe, name='factor449')
    panda = panda[panda['q'].isin(dolphin)]
    if panda.empty:
        return _make_factor_series({dog: np.nan for dog in tiger}, lion, universe=universe, name='factor449')
    bear = panda.pivot(index='q', columns='code', values='term_049').reindex(index=dolphin, columns=tiger)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = bear.loc[whale] if whale in bear.index else pd.Series(np.nan, index=tiger, dtype='float64')
    wolf = bear.loc[zebra] if zebra in bear.index else pd.Series(np.nan, index=tiger, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = (rabbit - wolf) / np.abs(wolf)
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    fox = ~np.isfinite(giraffe) | ~np.isfinite(rabbit) | ~np.isfinite(wolf) | (wolf == 0)
    giraffe = giraffe.where(~fox, np.nan).reindex(tiger)
    otter = {dog: float(giraffe.get(dog)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in tiger}
    return _make_factor_series(otter, lion, universe=universe, name='factor449')

def factor450(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor450')

def factor451(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    cat = pd.Timestamp(wolf)
    fox = list(universe)
    turtle = pd.Period(cat, freq='Q-DEC') - 1
    lizard = turtle - 1
    frog = pd.PeriodIndex([turtle, turtle - 1, turtle - 2, turtle - 3], freq='Q-DEC')
    owl = pd.PeriodIndex([lizard, turtle], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    salmon = pd.Series(np.nan, index=fox, dtype='float64')
    alpaca = _nearest_td_le(wolf)
    if alpaca is not None:
        try:
            zebra = get_factor_values(fox, factors=['term_068'], end_date=alpaca, count=1)
            bear = zebra.get('term_068', None) if isinstance(zebra, dict) else None
            if isinstance(bear, pd.DataFrame) and (not bear.empty):
                tuna = bear.iloc[-1]
                tuna.index = tuna.index.astype(str)
                salmon = pd.to_numeric(tuna, errors='coerce').astype(float).reindex(fox)
        except Exception:
            pass
    if salmon.notna().sum() < 10:
        giraffe = get_history_fundamentals(security=fox, fields=[bear.term_066], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        shark = _prep_hist(giraffe)
        if not shark.empty and 'term_066' in shark.columns:
            shark = shark[shark['q'].isin(frog)]
            if not shark.empty:
                sparrow = shark.pivot(index='q', columns='code', values='term_066').reindex(index=frog, columns=fox)
                sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
                whale = sparrow.sum(axis=0, min_count=1).reindex(fox)
                salmon = salmon.where(np.isfinite(salmon), whale)
    rabbit = get_history_fundamentals(security=fox, fields=[fox.term_082], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(rabbit)
    if panda.empty or 'term_082' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in fox}, wolf, universe=universe, name='factor451')
    panda = panda[panda['q'].isin(owl)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in fox}, wolf, universe=universe, name='factor451')
    lion = panda.pivot(index='q', columns='code', values='term_082').reindex(index=owl, columns=fox)
    lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
    koala = lion.loc[turtle] if turtle in lion.index else pd.Series(np.nan, index=fox, dtype='float64')
    otter = lion.loc[lizard] if lizard in lion.index else pd.Series(np.nan, index=fox, dtype='float64')
    dog = (koala + otter) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = salmon / dog
    eagle = ~np.isfinite(hawk) | ~np.isfinite(salmon) | ~np.isfinite(dog) | (dog == 0)
    hawk = hawk.where(~eagle, np.nan).reindex(fox)
    dolphin = {tiger: float(hawk.get(tiger)) if np.isfinite(hawk.get(tiger, np.nan)) else np.nan for tiger in fox}
    return _make_factor_series(dolphin, wolf, universe=universe, name='factor451')

def factor452(universe, date, K_months=6):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = get_trade_days(end_date=fox, count=K_months * 21)
    if len(wolf) == 0:
        dolphin = {otter: np.nan for otter in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor452')
    shark = pd.to_datetime(wolf[0]).strftime('%Y-%m-%d')
    zebra = pd.to_datetime(wolf[-1]).strftime('%Y-%m-%d')
    rabbit = get_price(universe, start_date=shark, end_date=zebra, frequency='daily', fields=['volume'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        dolphin = {otter: np.nan for otter in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor452')
    hawk = rabbit.pivot(index='time', columns='code', values='volume').sort_index()
    whale = query(giraffe.code, giraffe.term_008, giraffe.circulating_cap).filter(giraffe.code.in_(universe))
    giraffe = get_fundamentals(whale, date=fox)
    if giraffe is None or giraffe.empty:
        giraffe = pd.DataFrame(columns=['code', 'term_008', 'circulating_cap'])
    giraffe = giraffe.set_index('code')
    lion = giraffe['term_008'].astype(float) if 'term_008' in giraffe.columns else pd.Series(dtype=float)
    koala = giraffe['circulating_cap'].astype(float) if 'circulating_cap' in giraffe.columns else pd.Series(dtype=float)
    dog = int(hawk.shape[0]) if hawk is not None else 0
    if dog <= 0:
        dolphin = {otter: np.nan for otter in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor452')
    dolphin = {}
    for otter in universe:
        if otter not in hawk.columns:
            dolphin[otter] = np.nan
            continue
        tiger = float(lion.get(otter, np.nan))
        if not np.isfinite(tiger) or tiger <= 0.0:
            tiger = float(koala.get(otter, np.nan))
        if not np.isfinite(tiger) or tiger <= 0.0:
            dolphin[otter] = np.nan
            continue
        eagle = hawk[otter].astype(float)
        sparrow = float((eagle / (tiger * 10000.0)).sum(skipna=True))
        owl = int((eagle == 0).sum())
        if not np.isfinite(sparrow) or sparrow <= 0.0:
            dolphin[otter] = np.nan
            continue
        bear = max(1.0 / sparrow, 1.0) + 1.0
        panda = 1.0 / sparrow / bear
        cat = (owl + panda) * (21.0 * K_months) / float(dog)
        dolphin[otter] = float(cat)
    return _make_factor_series(dolphin, date, universe=universe, name='factor452')

def factor453(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor453')

def factor454(universe, date, N_quarters=8):
    _set_asof_date(date)
    fox = _to_date(date)
    rabbit = get_history_fundamentals(security=universe, fields=[bear.term_052, bear.term_055], watch_date=fox, count=N_quarters, interval='1q', stat_by_year=False)
    bear = get_history_fundamentals(security=universe, fields=[wolf.staff_behalf_paid], watch_date=fox, count=N_quarters, interval='1q', stat_by_year=False)
    wolf = _r3_merge_history_fundamentals(rabbit, bear)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor454')
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])

    def _zscore(x):
        if x is None:
            return None
        x = np.asarray(x, dtype=float)
        dog = np.isfinite(x)
        if dog.sum() < 2:
            return None
        cat = float(np.mean(x[dog]))
        tiger = float(np.std(x[dog], ddof=1))
        if not np.isfinite(tiger) or tiger == 0.0:
            return None
        panda = np.full_like(x, np.nan, dtype=float)
        panda[dog] = (x[dog] - cat) / tiger
        return panda
    zebra = {}
    for otter in universe:
        giraffe = wolf[wolf['code'] == otter]
        if giraffe.empty:
            zebra[otter] = np.nan
            continue
        giraffe = giraffe.sort_values('statDate').drop_duplicates('statDate').tail(N_quarters)
        tiger = giraffe['term_052'].astype(float).values
        dog = giraffe['term_055'].astype(float).values
        panda = giraffe['staff_behalf_paid'].astype(float).values
        dolphin = np.isfinite(tiger) & np.isfinite(dog) & np.isfinite(panda)
        if dolphin.sum() < 3:
            zebra[otter] = np.nan
            continue
        turtle = tiger[dolphin]
        eagle = dog[dolphin]
        sparrow = panda[dolphin]
        lizard = _zscore(turtle)
        hawk = _zscore(eagle)
        owl = _zscore(sparrow)
        if lizard is None or hawk is None or owl is None:
            zebra[otter] = np.nan
            continue
        cat = np.column_stack([np.ones(len(lizard)), hawk, owl])
        try:
            koala, lion, lion, lion = np.linalg.lstsq(cat, lizard, rcond=None)
        except np.linalg.LinAlgError:
            zebra[otter] = np.nan
            continue
        whale = lizard - cat.dot(koala)
        shark = float(whale[-1]) if whale.size > 0 else np.nan
        zebra[otter] = shark if np.isfinite(shark) else np.nan
    return _make_factor_series(zebra, date, universe=universe, name='factor454')

def factor455(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor455')

def factor456(universe, date):
    _set_asof_date(date)
    return factor320(universe, date).rename('factor456')

def factor457(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor457')

def factor458(universe, date):
    lion = _to_date(date)
    fox = get_history_fundamentals(security=universe, fields=[rabbit.eps], watch_date=lion, count=12, interval='1q', stat_by_year=False)
    otter = get_history_fundamentals(security=universe, fields=[bear.basic_eps, bear.term_052], watch_date=lion, count=12, interval='1q', stat_by_year=False)
    koala = _r3_merge_history_fundamentals(fox, otter)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor458')
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    shark = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(universe))
    try:
        wolf = get_fundamentals(shark, date=lion)
    except Exception:
        wolf = None
    panda = None
    if wolf is not None and (not wolf.empty) and ('code' in wolf.columns) and ('term_008' in wolf.columns):
        wolf = wolf.set_index('code')
        panda = wolf['term_008'].astype(float).reindex(universe)
    giraffe = {}
    for tiger in universe:
        bear = koala[koala['code'] == tiger].copy()
        if bear.empty:
            giraffe[tiger] = np.nan
            continue
        bear = bear.sort_values('statDate').drop_duplicates('statDate')
        if bear.shape[0] < 12:
            giraffe[tiger] = np.nan
            continue
        rabbit = bear['eps'] if 'eps' in bear.columns else pd.Series([np.nan] * bear.shape[0])
        dog = bear['basic_eps'] if 'basic_eps' in bear.columns else pd.Series([np.nan] * bear.shape[0])
        whale = bear['term_052'] if 'term_052' in bear.columns else pd.Series([np.nan] * bear.shape[0])
        rabbit = pd.to_numeric(rabbit, errors='coerce').values.astype(float)
        dog = pd.to_numeric(dog, errors='coerce').values.astype(float)
        whale = pd.to_numeric(whale, errors='coerce').values.astype(float)
        cat = rabbit.copy()
        zebra = ~np.isfinite(cat)
        if zebra.any():
            cat[zebra] = dog[zebra]
        dolphin = ~np.isfinite(cat)
        if dolphin.any() and panda is not None and (tiger in panda.index):
            hawk = float(panda.loc[tiger]) * 10000.0
            if np.isfinite(hawk) and hawk > 0:
                cat[dolphin] = whale[dolphin] / hawk
        if cat.size < 12:
            giraffe[tiger] = np.nan
            continue
        owl = cat[-8:] - cat[-12:-4]
        sparrow = owl[-1]
        turtle = owl[np.isfinite(owl)]
        if not np.isfinite(sparrow) or turtle.size < 2:
            giraffe[tiger] = np.nan
            continue
        eagle = float(np.std(turtle, ddof=1))
        if not np.isfinite(eagle) or eagle == 0.0:
            giraffe[tiger] = np.nan
            continue
        giraffe[tiger] = float(sparrow / eagle)
    return _make_factor_series(giraffe, date, universe=universe, name='factor458')

def factor459(universe, date, N=5):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = get_trade_days(end_date=koala, count=N * 6)
    if len(otter) < N + 3:
        bear = {lion: np.nan for lion in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor459')
    giraffe = otter[0]
    zebra = pd.to_datetime(giraffe).strftime('%Y-%m-%d')
    wolf = koala.strftime('%Y-%m-%d')
    fox = get_price(universe, start_date=zebra, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        bear = {lion: np.nan for lion in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor459')
    tiger = fox.pivot(index='time', columns='code', values='close').sort_index()
    bear = {}
    for lion in universe:
        if lion not in tiger.columns:
            bear[lion] = np.nan
            continue
        rabbit = tiger[lion].dropna().values
        if len(rabbit) < N + 3:
            bear[lion] = np.nan
            continue
        cat = _ema_array(rabbit, N)
        dog = _ema_array(cat, N)
        panda = _ema_array(dog, N)
        bear[lion] = float(3.0 * cat[-1] - 3.0 * dog[-1] + panda[-1])
    return _make_factor_series(bear, date, universe=universe, name='factor459')

def factor460(universe, date, K=20):
    _set_asof_date(date)
    return factor223(universe, date, K=K).rename('factor460')

def factor461(universe, date):
    _set_asof_date(date)
    return factor329(universe, date).rename('factor461')

def factor462(universe, date):
    _set_asof_date(date)
    return factor251(universe, date).rename('factor462')

def factor463(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    lion = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    whale = eagle - 4
    shark = pd.PeriodIndex([whale, eagle], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=lion, fields=[fox.inventories, fox.term_081], watch_date=cat, count=40, interval='1q', stat_by_year=False)
    panda = _prep_hist(fox)
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor463')
    panda = panda[panda['q'].isin(shark)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor463')
    rabbit = panda.pivot(index='q', columns='code', values='inventories').reindex(index=shark, columns=lion)
    sparrow = panda.pivot(index='q', columns='code', values='term_081').reindex(index=shark, columns=lion)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = rabbit.loc[eagle] if eagle in rabbit.index else pd.Series(np.nan, index=lion, dtype='float64')
    bear = rabbit.loc[whale] if whale in rabbit.index else pd.Series(np.nan, index=lion, dtype='float64')
    owl = sparrow.loc[eagle] if eagle in sparrow.index else pd.Series(np.nan, index=lion, dtype='float64')
    hawk = sparrow.loc[whale] if whale in sparrow.index else pd.Series(np.nan, index=lion, dtype='float64')
    koala = giraffe - bear
    dog = (owl + hawk) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = koala / dog
    zebra = ~np.isfinite(dolphin) | ~np.isfinite(koala) | ~np.isfinite(dog) | (dog == 0)
    dolphin = dolphin.where(~zebra, np.nan).reindex(lion)
    wolf = {tiger: float(dolphin.get(tiger)) if np.isfinite(dolphin.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(wolf, otter, universe=universe, name='factor463')

def factor464(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor464')

def factor465(universe, date, N_days=20, freq='1m', code_chunk=400, large_threshold=800):
    _set_asof_date(date)
    import datetime as dt
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, int(N_days) + 1)
    if len(otter) < int(N_days) + 1:
        zebra = {dog: np.nan for dog in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor465')
    tuna = [pd.to_datetime(alpaca).date() for alpaca in otter[-int(N_days):]]
    sparrow = tuna[0]
    rabbit = tuna[-1] + dt.timedelta(days=1)
    frog = set(tuna)
    salmon = freq
    if salmon == '1m' and len(universe) >= int(large_threshold):
        salmon = '5m'
    owl = pd.to_datetime(sparrow).strftime('%Y-%m-%d')
    giraffe = pd.to_datetime(rabbit).strftime('%Y-%m-%d')
    bear = []
    for dolphin in range(0, len(universe), int(code_chunk)):
        lizard = list(universe[dolphin:dolphin + int(code_chunk)])
        wolf = get_price(lizard, start_date=owl, end_date=giraffe, frequency=salmon, fields=['close'], fq='post', panel=False)
        if wolf is None or wolf.empty:
            continue
        bear.append(wolf)
    if not bear:
        zebra = {dog: np.nan for dog in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor465')
    fox = pd.concat(bear, axis=0, ignore_index=True)
    if 'time' not in fox.columns or 'code' not in fox.columns or 'close' not in fox.columns:
        zebra = {dog: np.nan for dog in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor465')
    fox = fox.copy()
    fox['time'] = pd.to_datetime(fox['time'])
    fox['date'] = fox['time'].dt.date
    fox = fox[fox['date'].isin(frog)]
    if fox.empty:
        zebra = {dog: np.nan for dog in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor465')
    fox = fox.sort_values(['code', 'date', 'time'])
    fox['dP'] = fox.groupby(['code', 'date'], sort=False)['close'].diff()
    fox = fox[np.isfinite(fox['dP'].values)]
    tiger = {}
    panda = {}
    for dog in universe:
        turtle = fox[fox['code'] == dog]
        if turtle.empty:
            tiger[dog] = np.nan
            panda[dog] = np.nan
            continue
        lion = turtle['dP'].astype(float).values
        if lion.size < 3:
            tiger[dog] = np.nan
            panda[dog] = np.nan
            continue
        alpaca = lion[:-1]
        lemur = lion[1:]
        shark = (alpaca > 0) & (lemur > 0)
        if shark.sum() >= 3 and np.std(alpaca[shark], ddof=1) > 0 and (np.std(lemur[shark], ddof=1) > 0):
            try:
                tiger[dog] = float(np.corrcoef(alpaca[shark], lemur[shark])[0, 1])
            except Exception:
                tiger[dog] = np.nan
        else:
            tiger[dog] = np.nan
        whale = (alpaca > 0) & (lemur < 0)
        if whale.sum() >= 3 and np.std(alpaca[whale], ddof=1) > 0 and (np.std(lemur[whale], ddof=1) > 0):
            try:
                panda[dog] = float(np.corrcoef(alpaca[whale], lemur[whale])[0, 1])
            except Exception:
                panda[dog] = np.nan
        else:
            panda[dog] = np.nan
    hawk = pd.Series(tiger, index=universe, dtype='float64')
    eagle = pd.Series(panda, index=universe, dtype='float64')

    def _zscore_or_raw(s):
        tiger = s.copy()
        cat = tiger.notna()
        if cat.sum() < 3:
            return tiger
        dog = tiger[cat].mean()
        panda = tiger[cat].std(ddof=1)
        if not np.isfinite(panda) or panda == 0.0:
            tiger.loc[cat] = 0.0
            return tiger
        tiger.loc[cat] = (tiger.loc[cat] - dog) / panda
        return tiger
    beaver = _zscore_or_raw(hawk)
    badger = _zscore_or_raw(eagle)
    cat = (beaver + badger).replace([np.inf, -np.inf], np.nan)
    zebra = {dog: float(cat.get(dog, np.nan)) for dog in universe}
    return _make_factor_series(zebra, date, universe=universe, name='factor465')

def factor466(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor466')

def factor467(universe, date):
    _set_asof_date(date)
    return factor278(universe, date).rename('factor467')

def factor468(universe, date, N1=20, N2=5):
    _set_asof_date(date)
    wolf = _to_date(date)
    camel = N1 + N2 + 5
    bear = get_trade_days(end_date=wolf, count=camel)
    if len(bear) < N1 + N2 + 2:
        dolphin = {fox: np.nan for fox in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor468')
    salmon = bear[0]
    tuna = pd.to_datetime(salmon).strftime('%Y-%m-%d')
    zebra = wolf.strftime('%Y-%m-%d')
    rabbit = get_price(universe, start_date=tuna, end_date=zebra, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        dolphin = {fox: np.nan for fox in universe}
        return _make_factor_series(dolphin, date, universe=universe, name='factor468')
    whale = rabbit.pivot(index='time', columns='code', values='high').sort_index()
    shark = rabbit.pivot(index='time', columns='code', values='low').sort_index()
    otter = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    dolphin = {}
    for fox in universe:
        if fox not in whale.columns:
            dolphin[fox] = np.nan
            continue
        dog = whale[fox].values
        panda = shark[fox].values
        cat = otter[fox].values
        if len(dog) < N1 + N2:
            dolphin[fox] = np.nan
            continue
        lion = np.zeros_like(dog, dtype=float)
        koala = np.zeros_like(dog, dtype=float)
        for alpaca in range(1, len(dog)):
            sparrow = dog[alpaca] - panda[alpaca]
            owl = abs(cat[alpaca - 1] - dog[alpaca])
            turtle = abs(cat[alpaca - 1] - panda[alpaca])
            lemur = max(sparrow, owl, turtle)
            lion[alpaca] = lemur
            giraffe = cat[alpaca] - cat[alpaca - 1]
            if giraffe > 0.0:
                koala[alpaca] = lemur / giraffe if giraffe != 0.0 else lemur
            else:
                koala[alpaca] = lemur
        tiger = np.full_like(dog, np.nan, dtype=float)
        for alpaca in range(N1 - 1, len(dog)):
            beaver = koala[alpaca - N1 + 1:alpaca + 1]
            eagle = beaver.max()
            hawk = beaver.min()
            if eagle > hawk:
                tiger[alpaca] = (koala[alpaca] - hawk) / (eagle - hawk) * 100.0
            else:
                tiger[alpaca] = (koala[alpaca] - hawk) * 100.0
        badger = ~np.isnan(tiger)
        if badger.sum() < N2:
            dolphin[fox] = np.nan
            continue
        frog = tiger[badger]
        lizard = _ema_array(frog, N2)
        dolphin[fox] = float(lizard[-1])
    return _make_factor_series(dolphin, date, universe=universe, name='factor468')

def factor469(universe, date, n=20):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=n + 1)
    if len(tiger) < n + 1:
        wolf = {dog: np.nan for dog in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor469')
    dolphin = tiger[0]
    whale = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    fox = panda.strftime('%Y-%m-%d')
    koala = get_price(universe, start_date=whale, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if koala is None or koala.empty:
        wolf = {dog: np.nan for dog in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor469')
    cat = koala.pivot(index='time', columns='code', values='close').sort_index()
    giraffe = cat.pct_change().iloc[-n:]
    wolf = {}
    for dog in universe:
        if dog not in giraffe.columns:
            wolf[dog] = np.nan
            continue
        zebra = giraffe[dog].dropna()
        if len(zebra) < n:
            wolf[dog] = np.nan
            continue
        sparrow = zebra.values
        bear = sparrow.mean()
        otter = sparrow - bear
        eagle = (otter ** 3).sum()
        shark = (otter ** 2).sum()
        if shark <= 0.0 or np.isnan(shark) or n < 3:
            hawk = np.nan
        else:
            rabbit = -(n * (n - 1)) ** 1.5 * eagle
            lion = (n - 1) * (n - 2) * shark ** 1.5
            hawk = float(rabbit / lion)
        wolf[dog] = hawk
    return _make_factor_series(wolf, date, universe=universe, name='factor469')

def factor470(universe, date):
    _set_asof_date(date)
    return factor262(universe, date).rename('factor470')

def factor471(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor471')

def factor472(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    koala = query(fox.code, fox.term_083, fox.term_084).filter(fox.code.in_(universe))
    tiger = get_fundamentals(koala, date=panda)
    if tiger is None or tiger.empty:
        lion = {dog: np.nan for dog in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor472')
    tiger = tiger.set_index('code')
    lion = {}
    for dog in universe:
        cat = float(tiger['term_083'].get(dog, np.nan)) if 'term_083' in tiger.columns else np.nan
        otter = float(tiger['term_084'].get(dog, np.nan)) if 'term_084' in tiger.columns else np.nan
        if np.isnan(cat) or np.isnan(otter) or otter == 0.0:
            fox = np.nan
        else:
            fox = cat / otter
        lion[dog] = fox
    return _make_factor_series(lion, date, universe=universe, name='factor472')

def factor473(universe, date):
    _set_asof_date(date)
    return factor279(universe, date).rename('factor473')

def factor474(universe, date, N_days=20, code_chunk=400, freq_small='1m', freq_large='5m', large_threshold=800):
    _set_asof_date(date)
    import datetime as dt
    otter = _to_date(date)
    fox = get_trade_days(end_date=otter, count=int(N_days))
    if len(fox) < int(N_days):
        zebra = {tiger: np.nan for tiger in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor474')
    badger = [pd.to_datetime(ferret).date() for ferret in fox]
    beaver = set(badger)
    salmon = badger[0]
    rabbit = badger[-1] + dt.timedelta(days=1)
    tuna = pd.to_datetime(salmon).strftime('%Y-%m-%d')
    giraffe = pd.to_datetime(rabbit).strftime('%Y-%m-%d')
    lizard = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(universe))
    wolf = get_fundamentals(lizard, date=otter)
    if wolf is None or wolf.empty:
        zebra = {tiger: np.nan for tiger in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor474')
    wolf = wolf.set_index('code')
    cat = wolf['circulating_cap'].astype(float).reindex(universe) if 'circulating_cap' in wolf.columns else pd.Series(np.nan, index=universe)
    dog = cat.to_dict()
    dolphin = freq_large if len(universe) >= int(large_threshold) else freq_small
    koala = []
    for shark in range(0, len(universe), int(code_chunk)):
        lemur = list(universe[shark:shark + int(code_chunk)])
        bear = get_price(lemur, start_date=tuna, end_date=giraffe, frequency=dolphin, fields=['volume'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        bear['time'] = pd.to_datetime(bear['time'])
        bear['date'] = bear['time'].dt.date
        bear = bear[bear['date'].isin(beaver)]
        if bear.empty:
            continue
        bear['cap'] = bear['code'].map(dog)
        donkey = bear['volume'].astype(float)
        panda = bear['cap'].astype(float)
        camel = pd.Series(np.nan, index=bear.index, dtype='float64')
        turtle = np.isfinite(donkey.values) & np.isfinite(panda.values) & (panda.values > 0.0)
        camel.loc[turtle] = donkey.loc[turtle].values / (panda.loc[turtle].values * 10000.0)
        bear['turn'] = camel
        frog = bear.groupby(['date', 'code'], sort=False)['turn'].std(ddof=1)
        if frog is not None and (not frog.empty):
            koala.append(frog)
    if not koala:
        zebra = {tiger: np.nan for tiger in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor474')
    lion = pd.concat(koala).groupby(level=[0, 1], sort=False).mean()
    whale = lion.groupby(level=1, sort=False)
    hawk = whale.mean()
    alpaca = whale.std(ddof=1)
    owl = whale.count()
    zebra = {}
    for tiger in universe:
        eagle = float(hawk.get(tiger, np.nan))
        frog = float(alpaca.get(tiger, np.nan))
        sparrow = int(owl.get(tiger, 0))
        if sparrow < 3 or not np.isfinite(eagle) or eagle == 0.0 or (not np.isfinite(frog)):
            zebra[tiger] = np.nan
        else:
            zebra[tiger] = float(frog / eagle)
    return _make_factor_series(zebra, date, universe=universe, name='factor474')

def factor475(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    otter = query(fox.code, fox.term_084, fox.total_owner_equities).filter(fox.code.in_(universe))
    tiger = get_fundamentals(otter, date=panda)
    if tiger is None or tiger.empty:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor475')
    tiger = tiger.set_index('code')
    koala = {}
    for cat in universe:
        dog = float(tiger['term_084'].get(cat, np.nan)) if 'term_084' in tiger.columns else np.nan
        lion = float(tiger['total_owner_equities'].get(cat, np.nan)) if 'total_owner_equities' in tiger.columns else np.nan
        if np.isnan(dog) or np.isnan(lion) or lion == 0.0:
            fox = np.nan
        else:
            fox = dog / lion
        koala[cat] = fox
    return _make_factor_series(koala, date, universe=universe, name='factor475')

def factor476(universe, date):
    _set_asof_date(date)
    return factor308(universe, date).rename('factor476')

def factor477(universe, date, K_months=12, bench_index='000905.XSHG', rf_series=None):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=K_months * 21 + 1)
    if len(tiger) < 50:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor477')
    eagle = tiger[0]
    hawk = pd.to_datetime(eagle).strftime('%Y-%m-%d')
    koala = panda.strftime('%Y-%m-%d')
    shark = list(dict.fromkeys(list(universe) + [bench_index]))
    lion = get_price(shark, start_date=hawk, end_date=koala, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty or bench_index not in lion['code'].unique():
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor477')
    wolf = lion.pivot(index='time', columns='code', values='close').sort_index()
    bear = wolf.pct_change()
    if bench_index not in bear.columns:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor477')
    zebra = bear[bench_index]
    if rf_series is None:
        whale = pd.Series(0.0, index=bear.index)
    else:
        whale = rf_series.copy()
        whale.index = pd.to_datetime(whale.index)
        whale = whale.reindex(bear.index).fillna(0.0)
    dolphin = zebra - whale
    otter = {}
    for cat in universe:
        if cat not in bear.columns:
            otter[cat] = np.nan
            continue
        rabbit = bear[cat]
        giraffe = rabbit - whale
        fox = ~(giraffe.isna() | dolphin.isna())
        if fox.sum() < 30:
            otter[cat] = np.nan
            continue
        turtle = giraffe[fox].values
        owl = dolphin[fox].values
        sparrow = np.var(owl, ddof=1)
        if sparrow == 0.0 or np.isnan(sparrow):
            otter[cat] = np.nan
            continue
        dog = np.cov(turtle, owl)[0, 1]
        otter[cat] = float(dog / sparrow)
    return _make_factor_series(otter, date, universe=universe, name='factor477')

def factor478(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    koala = list(universe)
    sparrow = pd.Period(cat, freq='Q-DEC') - 1
    owl = sparrow - 1
    eagle = sparrow - 4
    hawk = sparrow - 5
    giraffe = pd.PeriodIndex([hawk, eagle, owl, sparrow], freq='Q-DEC')
    wolf = get_history_fundamentals(security=koala, fields=[bear.term_052], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    fox = get_history_fundamentals(security=koala, fields=[fox.term_081], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if (wolf is None or wolf.empty) or (fox is None or fox.empty):
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor478')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat[cat['q'].isin(need_q)]
        if cat.empty:
            return None
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    rabbit = _prep(wolf)
    tiger = _prep(fox)
    if rabbit is None or tiger is None:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor478')
    dolphin = rabbit.pivot(index='q', columns='code', values='term_052').reindex(index=giraffe, columns=koala)
    tuna = tiger.pivot(index='q', columns='code', values='term_081').reindex(index=giraffe, columns=koala)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    tuna = tuna.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = dolphin.loc[sparrow]
    zebra = dolphin.loc[eagle]
    alpaca = tuna.loc[sparrow]
    lemur = tuna.loc[owl]
    frog = tuna.loc[eagle]
    salmon = tuna.loc[hawk]
    panda = (alpaca + lemur) / 2.0
    dog = (frog + salmon) / 2.0
    panda = panda.replace([np.inf, -np.inf], np.nan)
    dog = dog.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        lizard = whale / panda
        turtle = zebra / dog
        shark = lizard - turtle
    shark = shark.replace([np.inf, -np.inf], np.nan)
    shark = shark.where(np.isfinite(panda) & (panda != 0) & np.isfinite(dog) & (dog != 0), np.nan)
    bear = {lion: float(shark.get(lion, np.nan)) if np.isfinite(shark.get(lion, np.nan)) else np.nan for lion in koala}
    return _make_factor_series(bear, otter, universe=universe, name='factor478')

def factor479(universe, date, delta=0.94):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=60 * 21 + 10)
    if len(tiger) < 24 * 21:
        otter = {dog: np.nan for dog in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor479')
    hawk = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    koala = pd.to_datetime(panda).strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=hawk, end_date=koala, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        otter = {dog: np.nan for dog in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor479')
    rabbit = lion.pivot(index='time', columns='code', values='close').sort_index()
    giraffe = pd.to_datetime(rabbit.index).to_period('M')
    wolf = rabbit.groupby(giraffe).last()
    bear = wolf.pct_change().dropna(how='all')
    if bear.shape[0] < 13:
        otter = {dog: np.nan for dog in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor479')
    cat = 1.0 - float(delta)
    zebra = bear.ewm(alpha=cat, adjust=False).mean()
    whale = ((bear - zebra) ** 2).ewm(alpha=cat, adjust=False).mean()
    eagle = np.sqrt(whale)
    if bear.shape[0] < 13:
        fox = pd.Series(index=bear.columns, data=np.nan, dtype='float64')
    else:
        fox = bear.iloc[-13:-1].mean(axis=0, skipna=True)
    dolphin = zebra.iloc[-1]
    shark = eagle.iloc[-1]
    sparrow = np.sign(fox) * (dolphin / shark.replace(0.0, np.nan))
    sparrow = sparrow.replace([np.inf, -np.inf], np.nan)
    otter = {dog: float(sparrow.get(dog, np.nan)) for dog in universe}
    return _make_factor_series(otter, date, universe=universe, name='factor479')

def factor480(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor480')

def factor481(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    dolphin = tiger.replace(day=1).strftime('%Y-%m-%d')
    zebra = tiger.strftime('%Y-%m-%d')
    lion = get_trade_days(start_date=dolphin, end_date=zebra)
    if len(lion) < 5:
        fox = {panda: np.nan for panda in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor481')
    hawk = (pd.to_datetime(lion[0]) - DateOffset(days=1)).strftime('%Y-%m-%d')
    otter = get_price(universe, start_date=hawk, end_date=zebra, frequency='daily', fields=['close', 'money'], fq='post', panel=False)
    if otter is None or otter.empty:
        fox = {panda: np.nan for panda in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor481')
    dog = otter.pivot(index='time', columns='code', values='close').sort_index()
    giraffe = otter.pivot(index='time', columns='code', values='money').sort_index()
    whale = dog.pct_change().dropna(how='all')
    giraffe = giraffe.loc[whale.index]
    koala = [pd.to_datetime(sparrow) for sparrow in lion[1:]]
    shark = whale.loc[koala]
    rabbit = giraffe.loc[koala]
    fox = {}
    for panda in universe:
        if panda not in shark.columns or panda not in rabbit.columns:
            fox[panda] = np.nan
            continue
        eagle = shark[panda]
        cat = rabbit[panda]
        bear = (eagle < 0) & (cat > 0)
        if bear.sum() == 0:
            fox[panda] = np.nan
            continue
        wolf = (eagle.abs() / cat).where(bear, np.nan).dropna()
        fox[panda] = float(wolf.mean()) if not wolf.empty else np.nan
    return _make_factor_series(fox, date, universe=universe, name='factor481')

def factor482(universe, date, lookback_days=252):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = get_trade_days(end_date=tiger, count=lookback_days + 1)
    if len(lion) < 2:
        wolf = {dog: np.nan for dog in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor482')
    zebra = pd.to_datetime(lion[0]).strftime('%Y-%m-%d')
    fox = pd.to_datetime(tiger).strftime('%Y-%m-%d')
    koala = get_price(universe, start_date=zebra, end_date=fox, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if koala is None or koala.empty:
        wolf = {dog: np.nan for dog in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor482')
    cat = koala.pivot(index='time', columns='code', values='close').sort_index().astype(float)
    dolphin = koala.pivot(index='time', columns='code', values='volume').sort_index().astype(float)
    otter = cat.diff()
    giraffe = otter.apply(np.sign)
    giraffe = giraffe.fillna(0.0)
    panda = giraffe * dolphin
    rabbit = panda.cumsum(axis=0)
    bear = rabbit.iloc[-1].replace([np.inf, -np.inf], np.nan)
    wolf = {dog: float(bear.get(dog, np.nan)) for dog in universe}
    return _make_factor_series(wolf, date, universe=universe, name='factor482')

def factor483(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor483')

def factor484(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    lion = list(universe)
    owl = pd.Period(cat, freq='Q-DEC') - 1
    hawk = owl - 4
    sparrow = pd.PeriodIndex([hawk, owl], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=lion, fields=[fox.term_085, fox.term_043, fox.term_031, fox.hold_to_maturity_investments, fox.term_081], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    panda = _prep_hist(fox)
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor484')
    panda = panda[panda['q'].isin(sparrow)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor484')
    salmon = panda.pivot(index='q', columns='code', values='term_085').reindex(index=sparrow, columns=lion)
    zebra = panda.pivot(index='q', columns='code', values='term_043').reindex(index=sparrow, columns=lion)
    bear = panda.pivot(index='q', columns='code', values='term_031').reindex(index=sparrow, columns=lion)
    rabbit = panda.pivot(index='q', columns='code', values='hold_to_maturity_investments').reindex(index=sparrow, columns=lion)
    lizard = panda.pivot(index='q', columns='code', values='term_081').reindex(index=sparrow, columns=lion)
    salmon = salmon.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    lizard = lizard.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = zebra.fillna(0.0)
    bear = bear.fillna(0.0)
    rabbit = rabbit.fillna(0.0)
    whale = salmon - (zebra + bear + rabbit)
    shark = whale.loc[owl] if owl in whale.index else pd.Series(np.nan, index=lion, dtype='float64')
    dolphin = whale.loc[hawk] if hawk in whale.index else pd.Series(np.nan, index=lion, dtype='float64')
    frog = lizard.loc[owl] if owl in lizard.index else pd.Series(np.nan, index=lion, dtype='float64')
    turtle = lizard.loc[hawk] if hawk in lizard.index else pd.Series(np.nan, index=lion, dtype='float64')
    koala = shark - dolphin
    dog = (frog + turtle) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = koala / dog
    giraffe = ~np.isfinite(eagle) | ~np.isfinite(shark) | ~np.isfinite(dolphin) | ~np.isfinite(dog) | (dog == 0) | (dog <= 0)
    eagle = eagle.where(~giraffe, np.nan).reindex(lion)
    wolf = {tiger: float(eagle.get(tiger)) if np.isfinite(eagle.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(wolf, otter, universe=universe, name='factor484')

def factor485(universe, date):
    _set_asof_date(date)
    return factor284(universe, date).rename('factor485')

def factor486(universe, date, N=20):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = get_trade_days(end_date=wolf, count=N + 1)
    if len(bear) < N + 1:
        zebra = {otter: np.nan for otter in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor486')
    hawk = pd.to_datetime(bear[0]).strftime('%Y-%m-%d')
    giraffe = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    rabbit = get_price(universe, start_date=hawk, end_date=giraffe, frequency='daily', fields=['high', 'low', 'close', 'volume'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        zebra = {otter: np.nan for otter in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor486')
    dolphin = rabbit.pivot(index='time', columns='code', values='high').sort_index().iloc[-(N + 1):].astype(float)
    whale = rabbit.pivot(index='time', columns='code', values='low').sort_index().iloc[-(N + 1):].astype(float)
    koala = rabbit.pivot(index='time', columns='code', values='close').sort_index().iloc[-(N + 1):].astype(float)
    sparrow = rabbit.pivot(index='time', columns='code', values='volume').sort_index().iloc[-(N + 1):].astype(float)
    lion = (dolphin + whale + koala) / 3.0
    cat = lion * sparrow
    fox = lion.diff()
    eagle = fox > 0
    tiger = cat.where(eagle).sum(axis=0, skipna=True)
    panda = cat.where(~eagle).sum(axis=0, skipna=True)
    dog = tiger / panda.replace(0.0, np.nan)
    shark = 100.0 - 100.0 / (1.0 + dog)
    shark = shark.replace([np.inf, -np.inf], np.nan)
    zebra = {otter: float(shark.get(otter, np.nan)) for otter in universe}
    return _make_factor_series(zebra, date, universe=universe, name='factor486')

def factor487(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    dolphin = whale - 4
    rabbit = pd.PeriodIndex([dolphin, whale], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[fox.inventories], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor487')
    koala = koala.copy()
    if 'pubDate' in koala.columns:
        zebra = pd.to_datetime(koala['pubDate'], errors='coerce')
        koala = koala[zebra.notna() & (zebra <= cat)]
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty or 'inventories' not in koala.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor487')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(rabbit)]
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor487')
    wolf = koala.pivot(index='q', columns='code', values='inventories').reindex(index=rabbit, columns=panda)
    wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float)
    bear = wolf.loc[whale]
    fox = wolf.loc[dolphin]
    lion = fox.abs()
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = (bear - fox) / lion
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    giraffe = giraffe.where(np.isfinite(lion) & (lion > 0), np.nan)
    otter = {dog: float(giraffe.get(dog, np.nan)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(otter, tiger, universe=universe, name='factor487')

def factor488(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor488')

def factor489(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    koala = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    panda = get_fundamentals(koala, date=dog)
    if panda is None or panda.empty:
        tiger = {cat: np.nan for cat in universe}
        return _make_factor_series(tiger, date, universe=universe, name='factor489')
    panda = panda.set_index('code')
    tiger = {}
    for cat in universe:
        lion = float(panda['term_045'].get(cat, np.nan)) if 'term_045' in panda.columns else np.nan
        if np.isnan(lion) or lion <= 0.0:
            otter = np.nan
        else:
            otter = float(np.log(lion))
        tiger[cat] = otter
    return _make_factor_series(tiger, date, universe=universe, name='factor489')

def factor490(universe, date, count_q=2):
    _set_asof_date(date)
    shark = _to_date(date)
    hawk = get_history_fundamentals(security=universe, fields=[fox.term_082, fox.term_012, fox.term_083, fox.term_077, fox.term_079, fox.term_081], watch_date=shark, count=count_q, interval='1q', stat_by_year=False)
    if hawk is None or hawk.empty:
        owl = {wolf: np.nan for wolf in universe}
        return _make_factor_series(owl, date, universe=universe, name='factor490')
    hawk = hawk.copy()
    hawk['statDate'] = pd.to_datetime(hawk['statDate'])
    hawk = hawk.sort_values(['code', 'statDate'])
    owl = {}
    for wolf in universe:
        sparrow = hawk[hawk['code'] == wolf].drop_duplicates('statDate', keep='last').tail(2)
        if sparrow.shape[0] < 2:
            owl[wolf] = np.nan
            continue
        turtle = sparrow.iloc[0]
        bear = sparrow.iloc[1]
        tiger = float(bear.get('term_082', np.nan))
        panda = float(turtle.get('term_082', np.nan))
        koala = float(bear.get('term_012', np.nan))
        lion = float(turtle.get('term_012', np.nan))
        fox = float(bear.get('term_083', np.nan))
        otter = float(turtle.get('term_083', np.nan))
        frog = float(bear.get('term_077', np.nan))
        lizard = float(turtle.get('term_077', np.nan))
        lemur = float(bear.get('term_079', np.nan))
        alpaca = float(turtle.get('term_079', np.nan))
        tuna = float(bear.get('term_081', np.nan))
        salmon = float(turtle.get('term_081', np.nan))
        if not all((np.isfinite(badger) for badger in [tiger, panda, koala, lion, fox, otter, frog, lizard, lemur, alpaca, tuna, salmon])):
            owl[wolf] = np.nan
            continue
        rabbit = tiger - panda
        zebra = koala - lion
        giraffe = fox - otter
        dolphin = frog - lizard
        whale = lemur - alpaca
        dog = (tuna + salmon) / 2.0
        if not np.isfinite(dog) or dog == 0.0:
            owl[wolf] = np.nan
            continue
        eagle = 0.0
        cat = (rabbit - zebra - (giraffe - dolphin - whale) - eagle) / dog
        owl[wolf] = float(cat) if np.isfinite(cat) else np.nan
    return _make_factor_series(owl, date, universe=universe, name='factor490')

def factor491(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    hawk = None
    try:
        lion = get_factor_values(universe, factors=['term_073'], end_date=dog, count=1)
        if lion and 'term_073' in lion:
            turtle = lion['term_073'].iloc[-1]
            if not turtle.isna().all():
                hawk = turtle.astype(float)
    except Exception:
        hawk = None
    if hawk is None:
        giraffe = pd.Period(dog, freq='Q-DEC')
        zebra = [giraffe - bear for bear in range(0, 4)]
        salmon = [f'{dolphin.year}q{dolphin.quarter}' for dolphin in zebra]
        hawk = pd.Series(0.0, index=universe, dtype='float64')
        fox = pd.Series(False, index=universe)
        for frog in salmon:
            whale = query(bear.code, bear.term_072, bear.term_004).filter(bear.code.in_(universe))
            panda = get_fundamentals(whale, statDate=frog)
            if panda is None or panda.empty:
                continue
            panda = panda.set_index('code')
            eagle = panda['term_072'].where(~panda['term_072'].isna(), panda['term_004']).astype(float).reindex(universe)
            rabbit = ~eagle.isna()
            if rabbit.any():
                hawk.loc[rabbit] = hawk.loc[rabbit] + eagle.loc[rabbit]
                fox.loc[rabbit] = True
        hawk.loc[~fox] = np.nan
    owl = None
    try:
        koala = get_factor_values(universe, factors=['term_068'], end_date=dog, count=1)
        if koala and 'term_068' in koala:
            lizard = koala['term_068'].iloc[-1]
            if not lizard.isna().all():
                owl = lizard.astype(float)
    except Exception:
        owl = None
    if owl is None:
        giraffe = pd.Period(dog, freq='Q-DEC')
        zebra = [giraffe - bear for bear in range(0, 4)]
        salmon = [f'{dolphin.year}q{dolphin.quarter}' for dolphin in zebra]
        owl = pd.Series(0.0, index=universe, dtype='float64')
        wolf = pd.Series(False, index=universe)
        for frog in salmon:
            shark = query(bear.code, bear.term_066).filter(bear.code.in_(universe))
            tiger = get_fundamentals(shark, statDate=frog)
            if tiger is None or tiger.empty:
                continue
            tiger = tiger.set_index('code')
            sparrow = tiger['term_066'].astype(float).reindex(universe)
            rabbit = ~sparrow.isna()
            if rabbit.any():
                owl.loc[rabbit] = owl.loc[rabbit] + sparrow.loc[rabbit]
                wolf.loc[rabbit] = True
        owl.loc[~wolf] = np.nan
    otter = {}
    for cat in universe:
        eagle = float(hawk.get(cat, np.nan))
        sparrow = float(owl.get(cat, np.nan))
        if np.isnan(eagle) or np.isnan(sparrow) or sparrow == 0.0:
            tuna = np.nan
        else:
            tuna = eagle / sparrow
        otter[cat] = tuna
    return _make_factor_series(otter, date, universe=universe, name='factor491')

def factor492(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    koala = list(universe)
    lizard = pd.Period(cat, freq='Q-DEC') - 1
    frog = lizard - 1
    hawk = lizard - 4
    sparrow = lizard - 5
    owl = pd.PeriodIndex([hawk, lizard], freq='Q-DEC')
    turtle = pd.PeriodIndex([sparrow, hawk, frog, lizard], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    wolf = get_history_fundamentals(security=koala, fields=[bear.term_063, bear.term_055], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    zebra = _prep_hist(wolf)
    if zebra.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor492')
    zebra = zebra[zebra['q'].isin(owl)]
    if zebra.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor492')
    shark = zebra.pivot(index='q', columns='code', values='term_063').reindex(index=owl, columns=koala)
    whale = zebra.pivot(index='q', columns='code', values='term_055').reindex(index=owl, columns=koala)
    shark = shark.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = whale.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = (shark.loc[lizard] if lizard in shark.index else pd.Series(np.nan, index=koala)) + (whale.loc[lizard] if lizard in whale.index else pd.Series(np.nan, index=koala))
    bear = (shark.loc[hawk] if hawk in shark.index else pd.Series(np.nan, index=koala)) + (whale.loc[hawk] if hawk in whale.index else pd.Series(np.nan, index=koala))
    fox = get_history_fundamentals(security=koala, fields=[fox.term_081], watch_date=cat, count=40, interval='1q', stat_by_year=False)
    tiger = _prep_hist(fox)
    if tiger.empty or 'term_081' not in tiger.columns:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor492')
    tiger = tiger[tiger['q'].isin(turtle)]
    if tiger.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor492')
    badger = tiger.pivot(index='q', columns='code', values='term_081').reindex(index=turtle, columns=koala)
    badger = badger.apply(pd.to_numeric, errors='coerce').astype(float)
    beaver = badger.loc[lizard] if lizard in badger.index else pd.Series(np.nan, index=koala, dtype='float64')
    camel = badger.loc[frog] if frog in badger.index else pd.Series(np.nan, index=koala, dtype='float64')
    alpaca = badger.loc[hawk] if hawk in badger.index else pd.Series(np.nan, index=koala, dtype='float64')
    lemur = badger.loc[sparrow] if sparrow in badger.index else pd.Series(np.nan, index=koala, dtype='float64')
    panda = (beaver + camel) / 2.0
    dog = (alpaca + lemur) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        tuna = rabbit / panda
        salmon = bear / dog
        eagle = tuna - salmon
    dolphin = ~np.isfinite(eagle) | ~np.isfinite(rabbit) | ~np.isfinite(bear) | ~np.isfinite(panda) | ~np.isfinite(dog) | (panda == 0) | (dog == 0) | (panda <= 0) | (dog <= 0)
    eagle = eagle.where(~dolphin, np.nan).reindex(koala)
    giraffe = {lion: float(eagle.get(lion)) if np.isfinite(eagle.get(lion, np.nan)) else np.nan for lion in koala}
    return _make_factor_series(giraffe, otter, universe=universe, name='factor492')

def factor493(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_history_fundamentals(security=universe, fields=[fox.term_077, fox.term_044, fox.term_006, fox.total_owner_equities], watch_date=panda, count=1, interval='1q', stat_by_year=False)
    if tiger is None or tiger.empty:
        koala = {dog: np.nan for dog in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor493')
    tiger = tiger.copy()
    tiger['statDate'] = pd.to_datetime(tiger['statDate'])
    tiger = tiger.sort_values(['code', 'statDate'])
    otter = tiger.groupby('code', sort=False).tail(1).set_index('code')
    koala = {}
    for dog in universe:
        if dog not in otter.index:
            koala[dog] = np.nan
            continue
        wolf = float(otter.at[dog, 'term_077']) if 'term_077' in otter.columns else np.nan
        fox = float(otter.at[dog, 'term_044']) if 'term_044' in otter.columns else np.nan
        cat = float(otter.at[dog, 'term_006']) if 'term_006' in otter.columns else np.nan
        lion = float(otter.at[dog, 'total_owner_equities']) if 'total_owner_equities' in otter.columns else np.nan
        if not np.isfinite(lion) or lion == 0.0:
            koala[dog] = np.nan
            continue
        wolf = 0.0 if not np.isfinite(wolf) else wolf
        fox = 0.0 if not np.isfinite(fox) else fox
        cat = 0.0 if not np.isfinite(cat) else cat
        bear = (wolf + fox + cat) / lion
        koala[dog] = float(bear) if np.isfinite(bear) else np.nan
    return _make_factor_series(koala, date, universe=universe, name='factor493')

def factor494(universe, date, K_months=3):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=K_months * 21)
    if len(tiger) == 0:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor494')
    bear = tiger[0]
    rabbit = pd.to_datetime(bear).strftime('%Y-%m-%d')
    otter = pd.to_datetime(tiger[-1]).strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=rabbit, end_date=otter, frequency='daily', fields=['volume'], fq='post', panel=False)
    if lion is None or lion.empty:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor494')
    zebra = lion.pivot(index='time', columns='code', values='volume').sort_index()
    wolf = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(universe))
    koala = get_fundamentals(wolf, date=panda)
    if koala is None or koala.empty:
        koala = pd.DataFrame(columns=['code', 'circulating_cap'])
    koala = koala.set_index('code')
    fox = {}
    for dog in universe:
        if dog not in zebra.columns:
            fox[dog] = np.nan
            continue
        cat = float(koala['circulating_cap'].get(dog, np.nan)) if 'circulating_cap' in koala.columns else np.nan
        if np.isnan(cat) or cat <= 0.0:
            fox[dog] = np.nan
            continue
        giraffe = zebra[dog] / (cat * 10000.0)
        fox[dog] = float(giraffe.mean())
    return _make_factor_series(fox, date, universe=universe, name='factor494')

def factor495(universe, date, max_years=5):
    _set_asof_date(date)
    dog = _to_date(date)
    panda = get_trade_days(end_date=dog, count=max_years * 12 * 21 + 5)
    if len(panda) < 24 * 21:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor495')
    sparrow = panda[0]
    owl = pd.to_datetime(sparrow).strftime('%Y-%m-%d')
    lion = dog.strftime('%Y-%m-%d')
    tiger = get_price(universe, start_date=owl, end_date=lion, frequency='daily', fields=['close'], fq='post', panel=False)
    if tiger is None or tiger.empty:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor495')
    giraffe = tiger.pivot(index='time', columns='code', values='close').sort_index()
    otter = pd.to_datetime(giraffe.index)
    zebra = otter.to_period('M')
    wolf = giraffe.groupby(zebra).last()
    bear = wolf.pct_change().dropna(how='all')
    if bear.shape[0] < 13:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor495')
    fox = bear.index[-1]
    rabbit = fox - 12
    turtle = [24, 36, 48, 60]
    koala = {}
    for cat in universe:
        if cat not in bear.columns:
            koala[cat] = np.nan
            continue
        eagle = bear[cat]
        if rabbit not in eagle.index:
            koala[cat] = np.nan
            continue
        whale = eagle[rabbit]
        shark = []
        for lizard in turtle:
            dolphin = fox - lizard
            if dolphin in eagle.index:
                shark.append(eagle[dolphin])
        if shark:
            hawk = float(np.mean(shark))
            koala[cat] = float(whale + hawk)
        else:
            koala[cat] = float(whale)
    return _make_factor_series(koala, date, universe=universe, name='factor495')

def factor496(universe, date):
    _set_asof_date(date)
    return factor267(universe, date).rename('factor496')

def factor497(universe, date, K_months=12, bench_index='000905.XSHG', rf_series=None):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=K_months * 21 + 1)
    if len(tiger) < 50:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor497')
    owl = tiger[0]
    turtle = pd.to_datetime(owl).strftime('%Y-%m-%d')
    koala = panda.strftime('%Y-%m-%d')
    sparrow = list(dict.fromkeys(list(universe) + [bench_index]))
    lion = get_price(sparrow, start_date=turtle, end_date=koala, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty or bench_index not in lion['code'].unique():
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor497')
    bear = lion.pivot(index='time', columns='code', values='close').sort_index()
    rabbit = bear.pct_change()
    if bench_index not in rabbit.columns:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor497')
    whale = rabbit[bench_index]
    if rf_series is None:
        hawk = pd.Series(0.0, index=rabbit.index)
    else:
        hawk = rf_series.copy()
        hawk.index = pd.to_datetime(hawk.index)
        hawk = hawk.reindex(rabbit.index).fillna(0.0)
    eagle = whale - hawk
    wolf = eagle.mean()
    fox = eagle < wolf
    shark = eagle[fox]
    otter = {}
    for cat in universe:
        if cat not in rabbit.columns:
            otter[cat] = np.nan
            continue
        giraffe = rabbit[cat]
        dolphin = giraffe - hawk
        zebra = dolphin[fox]
        if len(zebra) < 10 or len(shark) < 10:
            otter[cat] = np.nan
            continue
        dog = np.cov(zebra.values, shark.values)[0, 1]
        frog = np.var(shark.values, ddof=1)
        if frog == 0.0 or np.isnan(frog):
            lizard = np.nan
        else:
            lizard = dog / frog
        otter[cat] = float(lizard)
    return _make_factor_series(otter, date, universe=universe, name='factor497')

def factor498(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor498')

def factor499(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor499')

def factor500(universe, date, L_list=(3, 5, 10, 20, 50, 100, 200)):
    _set_asof_date(date)
    lion = _to_date(date)
    whale = lion.replace(day=1).strftime('%Y-%m-%d')
    dolphin = lion.strftime('%Y-%m-%d')
    koala = get_trade_days(start_date=whale, end_date=dolphin)
    if len(koala) == 0:
        bear = {tiger: np.nan for tiger in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor500')
    rabbit = koala[-1]
    zebra = max(L_list)
    otter = get_trade_days(end_date=rabbit, count=zebra)
    if len(otter) < zebra:
        bear = {tiger: np.nan for tiger in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor500')
    eagle = otter[0]
    hawk = pd.to_datetime(eagle).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(rabbit).strftime('%Y-%m-%d')
    fox = get_price(universe, start_date=hawk, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        bear = {tiger: np.nan for tiger in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor500')
    panda = fox.pivot(index='time', columns='code', values='close').sort_index()
    bear = {}
    for tiger in universe:
        if tiger not in panda.columns:
            bear[tiger] = np.nan
            continue
        shark = panda[tiger].dropna()
        if len(shark) < zebra:
            bear[tiger] = np.nan
            continue
        dog = shark.iloc[-1]
        if np.isnan(dog) or dog <= 0.0:
            bear[tiger] = np.nan
            continue
        giraffe = []
        for cat in L_list:
            sparrow = shark.iloc[-cat:]
            giraffe.append(sparrow.mean() / dog)
        bear[tiger] = float(np.mean(giraffe))
    return _make_factor_series(bear, date, universe=universe, name='factor500')

def factor501(universe, date):
    _set_asof_date(date)
    return factor329(universe, date).rename('factor501')

def factor502(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor502')

def factor503(universe, date, N=20):
    _set_asof_date(date)
    return factor327(universe, date, N=N).rename('factor503')

def factor504(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_history_fundamentals(security=universe, fields=[bear.term_052, bear.asset_impairment_loss, bear.term_072], watch_date=panda, count=4, interval='1q', stat_by_year=False)
    if tiger is None or tiger.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor504')
    tiger = tiger.copy()
    tiger['statDate'] = pd.to_datetime(tiger['statDate'])
    tiger = tiger.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    dolphin = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    lion = get_fundamentals(dolphin, date=panda)
    if lion is None or lion.empty:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor504')
    lion = lion.set_index('code')
    bear = lion['term_045'].astype(float).reindex(universe) if 'term_045' in lion.columns else pd.Series(np.nan, index=universe)
    rabbit = int(min_valid_quarters)
    otter = {}
    for dog in universe:
        koala = tiger[tiger['code'] == dog]
        if koala.empty:
            otter[dog] = np.nan
            continue
        zebra = koala['term_052'].astype(float).to_numpy()[-4:]
        fox = koala['asset_impairment_loss'].astype(float).to_numpy()[-4:]
        whale = koala['term_072'].astype(float).to_numpy()[-4:]
        giraffe = np.isfinite(zebra)
        if giraffe.sum() < rabbit:
            otter[dog] = np.nan
            continue
        fox = np.where(np.isfinite(fox), fox, 0.0)
        whale = np.where(np.isfinite(whale), whale, 0.0)
        shark = np.where(giraffe, zebra + fox + whale, np.nan)
        eagle = float(np.nansum(shark))
        wolf = float(bear.get(dog, np.nan))
        if not np.isfinite(eagle) or not np.isfinite(wolf) or wolf <= 0.0:
            otter[dog] = np.nan
        else:
            otter[dog] = float(eagle / wolf)
    return _make_factor_series(otter, date, universe=universe, name='factor504')

def factor505(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor505')

def factor506(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    dog = pd.Timestamp(fox)
    koala = list(universe)
    lizard = pd.Period(dog, freq='Q-DEC') - 1
    owl = lizard - 4
    turtle = pd.PeriodIndex([owl, lizard], freq='Q-DEC')
    wolf = get_history_fundamentals(security=koala, fields=[fox.total_owner_equities, fox.term_046, fox.term_077, fox.term_044, fox.term_006, fox.term_012, fox.term_092, fox.term_031, fox.hold_to_maturity_investments, fox.term_081], watch_date=dog, count=40, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or 'code' not in wolf.columns or ('statDate' not in wolf.columns):
        return _make_factor_series({tiger: np.nan for tiger in koala}, fox, universe=universe, name='factor506')
    otter = wolf.copy()
    otter['code'] = otter['code'].astype(str)
    otter['statDate'] = pd.to_datetime(otter['statDate'], errors='coerce')
    otter = otter.dropna(subset=['code', 'statDate'])
    if otter.empty:
        return _make_factor_series({tiger: np.nan for tiger in koala}, fox, universe=universe, name='factor506')
    otter['q'] = otter['statDate'].dt.to_period('Q-DEC')
    otter = otter[otter['q'].isin(turtle)]
    if otter.empty:
        return _make_factor_series({tiger: np.nan for tiger in koala}, fox, universe=universe, name='factor506')
    otter = otter.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')

    def _pivot(col):
        if col not in d.columns:
            return pd.DataFrame(index=q_need, columns=codes, dtype='float64')
        cat = d.pivot(index='q', columns='code', values=col).reindex(index=q_need, columns=codes)
        return cat.apply(pd.to_numeric, errors='coerce').astype(float)
    bear = _pivot('total_owner_equities')
    shark = _pivot('term_046').fillna(0.0)
    frog = _pivot('term_077').fillna(0.0)
    whale = _pivot('term_044').fillna(0.0)
    panda = _pivot('term_006').fillna(0.0)
    lion = _pivot('term_012').fillna(0.0)
    lemur = _pivot('term_092').fillna(0.0)
    giraffe = _pivot('term_031').fillna(0.0)
    zebra = _pivot('hold_to_maturity_investments').fillna(0.0)
    salmon = _pivot('term_081')

    def _noa_at(q):
        tiger = eq_p.loc[q] if q in eq_p.index else pd.Series(np.nan, index=codes, dtype='float64')
        zebra = ta_p.loc[q] if q in ta_p.index else pd.Series(np.nan, index=codes, dtype='float64')
        tiger = tiger.where(np.isfinite(tiger), np.nan)
        bear = mi_p.loc[q] if q in mi_p.index else pd.Series(0.0, index=codes, dtype='float64')
        giraffe = st_p.loc[q] if q in st_p.index else pd.Series(0.0, index=codes, dtype='float64')
        wolf = lt_p.loc[q] if q in lt_p.index else pd.Series(0.0, index=codes, dtype='float64')
        cat = bd_p.loc[q] if q in bd_p.index else pd.Series(0.0, index=codes, dtype='float64')
        dog = ca_p.loc[q] if q in ca_p.index else pd.Series(0.0, index=codes, dtype='float64')
        dolphin = tr_p.loc[q] if q in tr_p.index else pd.Series(0.0, index=codes, dtype='float64')
        otter = hfs_p.loc[q] if q in hfs_p.index else pd.Series(0.0, index=codes, dtype='float64')
        fox = htm_p.loc[q] if q in htm_p.index else pd.Series(0.0, index=codes, dtype='float64')
        lion = tiger + bear
        panda = giraffe + wolf + cat
        koala = dog + dolphin + otter + fox
        rabbit = lion + panda - koala
        rabbit = rabbit.where(np.isfinite(tiger), np.nan)
        return (rabbit.reindex(codes), zebra.reindex(codes))
    hawk, alpaca = _noa_at(lizard)
    eagle, cat = _noa_at(owl)
    tuna = alpaca.where(np.isfinite(alpaca) & (alpaca != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        sparrow = (hawk - eagle) / tuna
    sparrow = sparrow.replace([np.inf, -np.inf], np.nan)
    dolphin = ~np.isfinite(sparrow) | ~np.isfinite(hawk) | ~np.isfinite(eagle) | ~np.isfinite(tuna)
    sparrow = sparrow.where(~dolphin, np.nan).reindex(koala)
    rabbit = {tiger: float(sparrow.get(tiger)) if np.isfinite(sparrow.get(tiger, np.nan)) else np.nan for tiger in koala}
    return _make_factor_series(rabbit, fox, universe=universe, name='factor506')

def factor507(universe, date, term_078=0.25):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    alpaca = pd.Period(cat, freq='Q-DEC') - 1
    lemur = alpaca - 1
    salmon = alpaca - 4
    tuna = alpaca - 5
    hawk = pd.PeriodIndex([alpaca, lemur, salmon, tuna], freq='Q-DEC')
    bear = get_history_fundamentals(security=list(universe), fields=[bear.term_063], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    wolf = get_history_fundamentals(security=list(universe), fields=[fox.total_owner_equities, fox.term_077, fox.term_044, fox.term_006, fox.term_012], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    fox = _r3_merge_history_fundamentals(bear, wolf)
    if fox is None or fox.empty:
        return _make_factor_series({}, otter, universe=universe, name='factor507')
    fox = fox.copy()
    if 'pubDate' in fox.columns:
        frog = pd.to_datetime(fox['pubDate'], errors='coerce')
        fox = fox[frog.notna() & (frog <= cat)]
    fox['statDate'] = pd.to_datetime(fox['statDate'], errors='coerce')
    fox = fox.dropna(subset=['code', 'statDate'])
    if fox.empty:
        return _make_factor_series({}, otter, universe=universe, name='factor507')
    fox['q'] = fox['statDate'].dt.to_period('Q-DEC')
    fox = fox[fox['q'].isin(hawk)]
    if fox.empty:
        return _make_factor_series({}, otter, universe=universe, name='factor507')

    def _pv(field):
        if field not in df_all.columns:
            return pd.DataFrame(index=list(universe), columns=need_q, dtype='float64')
        cat = df_all.pivot_table(index='code', columns='q', values=field, aggfunc='last')
        cat = cat.reindex(index=list(universe), columns=need_q)
        return cat.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = _pv('term_063')
    rabbit = _pv('total_owner_equities')
    camel = _pv('term_077')
    eagle = _pv('term_044')
    tiger = _pv('term_006')
    koala = _pv('term_012')
    camel = camel.fillna(0.0)
    eagle = eagle.fillna(0.0)
    tiger = tiger.fillna(0.0)
    koala = koala.fillna(0.0)

    def _ic(eq_, st_, lt_, bd_, ca_):
        return eq_ + st_ + lt_ + bd_ - ca_
    whale = _ic(rabbit[alpaca], camel[alpaca], eagle[alpaca], tiger[alpaca], koala[alpaca])
    shark = _ic(rabbit[lemur], camel[lemur], eagle[lemur], tiger[lemur], koala[lemur])
    zebra = _ic(rabbit[salmon], camel[salmon], eagle[salmon], tiger[salmon], koala[salmon])
    dolphin = _ic(rabbit[tuna], camel[tuna], eagle[tuna], tiger[tuna], koala[tuna])
    panda = (whale + shark) / 2.0
    dog = (zebra + dolphin) / 2.0
    turtle = sparrow[alpaca]
    owl = sparrow[salmon]
    with np.errstate(divide='ignore', invalid='ignore'):
        beaver = turtle * (1.0 - float(term_078)) / panda.replace(0.0, np.nan)
        badger = owl * (1.0 - float(term_078)) / dog.replace(0.0, np.nan)
    lizard = (beaver - badger).replace([np.inf, -np.inf], np.nan)
    giraffe = {lion: float(lizard.loc[lion]) if np.isfinite(lizard.loc[lion]) else np.nan for lion in universe}
    return _make_factor_series(giraffe, otter, universe=universe, name='factor507')

def factor508(universe, date, N_quarters=8):
    _set_asof_date(date)
    return factor420(universe, date, N_quarters=N_quarters).rename('factor508')

def factor509(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor509')

def factor510(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor510')

def factor511(universe, date, lookback_days=252):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = get_trade_days(end_date=tiger, count=lookback_days + 1)
    if len(lion) < 2:
        fox = {panda: np.nan for panda in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor511')
    rabbit = lion[0]
    giraffe = pd.to_datetime(rabbit).strftime('%Y-%m-%d')
    otter = tiger.strftime('%Y-%m-%d')
    koala = get_price(universe, start_date=giraffe, end_date=otter, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if koala is None or koala.empty:
        fox = {panda: np.nan for panda in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor511')
    dog = koala.pivot(index='time', columns='code', values='close').sort_index()
    whale = koala.pivot(index='time', columns='code', values='volume').sort_index()
    fox = {}
    for panda in universe:
        if panda not in dog.columns:
            fox[panda] = np.nan
            continue
        cat = dog[panda].values
        dolphin = whale[panda].values
        if len(cat) < 2:
            fox[panda] = np.nan
            continue
        bear = np.zeros_like(cat, dtype=float)
        if cat[0] != 0.0:
            bear[1] = (cat[1] - cat[0]) / cat[0] * dolphin[1]
        else:
            bear[1] = 0.0
        for zebra in range(2, len(cat)):
            if cat[zebra - 1] == 0.0 or np.isnan(cat[zebra - 1]):
                wolf = 0.0
            else:
                wolf = (cat[zebra] - cat[zebra - 1]) / cat[zebra - 1] * dolphin[zebra]
            bear[zebra] = bear[zebra - 1] + wolf
        fox[panda] = float(bear[-1])
    return _make_factor_series(fox, date, universe=universe, name='factor511')

def factor512(universe, date):
    _set_asof_date(date)
    return factor328(universe, date).rename('factor512')

def factor513(universe, date, max_years=5):
    _set_asof_date(date)
    dog = _to_date(date)
    panda = get_trade_days(end_date=dog, count=max_years * 12 * 21 + 5)
    if len(panda) < 12 * 21 + 5:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor513')
    whale = panda[0]
    shark = pd.to_datetime(whale).strftime('%Y-%m-%d')
    lion = dog.strftime('%Y-%m-%d')
    tiger = get_price(universe, start_date=shark, end_date=lion, frequency='daily', fields=['close'], fq='post', panel=False)
    if tiger is None or tiger.empty:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor513')
    giraffe = tiger.pivot(index='time', columns='code', values='close').sort_index()
    otter = pd.to_datetime(giraffe.index)
    zebra = otter.to_period('M')
    bear = giraffe.groupby(zebra).last()
    rabbit = bear.pct_change().dropna(how='all')
    if rabbit.shape[0] < 12:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor513')
    wolf = rabbit.index[-1]
    fox = rabbit.index[-12:]
    eagle = fox[:-1]
    koala = {}
    for cat in universe:
        if cat not in rabbit.columns:
            koala[cat] = np.nan
            continue
        dolphin = rabbit[cat].reindex(eagle).dropna()
        if dolphin.empty:
            koala[cat] = np.nan
        else:
            koala[cat] = float(dolphin.mean())
    return _make_factor_series(koala, date, universe=universe, name='factor513')

def factor514(universe, date):
    _set_asof_date(date)
    return factor343(universe, date).rename('factor514')

def factor515(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = pd.Timestamp(koala)
    lion = list(universe)
    turtle = pd.Period(cat, freq='Q-DEC') - 1
    lizard = turtle - 1
    frog = pd.PeriodIndex([turtle, turtle - 1, turtle - 2, turtle - 3], freq='Q-DEC')
    owl = pd.PeriodIndex([lizard, turtle], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    salmon = pd.Series(np.nan, index=lion, dtype='float64')
    alpaca = _nearest_td_le(koala)
    if alpaca is not None:
        try:
            zebra = get_factor_values(lion, factors=['term_068'], end_date=alpaca, count=1)
            otter = zebra.get('term_068', None) if isinstance(zebra, dict) else None
            if isinstance(otter, pd.DataFrame) and (not otter.empty):
                tuna = otter.iloc[-1]
                tuna.index = tuna.index.astype(str)
                salmon = pd.to_numeric(tuna, errors='coerce').astype(float).reindex(lion)
        except Exception:
            pass
    if salmon.notna().sum() < 10:
        wolf = get_history_fundamentals(security=lion, fields=[bear.term_066], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        shark = _prep_hist(wolf)
        if not shark.empty and 'term_066' in shark.columns:
            shark = shark[shark['q'].isin(frog)]
            if not shark.empty:
                sparrow = shark.pivot(index='q', columns='code', values='term_066').reindex(index=frog, columns=lion)
                sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
                whale = sparrow.sum(axis=0, min_count=1).reindex(lion)
                salmon = salmon.where(np.isfinite(salmon), whale)
    fox = get_history_fundamentals(security=lion, fields=[fox.term_025], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(fox)
    if panda.empty or 'term_025' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor515')
    panda = panda[panda['q'].isin(owl)]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, koala, universe=universe, name='factor515')
    bear = panda.pivot(index='q', columns='code', values='term_025').reindex(index=owl, columns=lion)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = bear.loc[turtle] if turtle in bear.index else pd.Series(np.nan, index=lion, dtype='float64')
    giraffe = bear.loc[lizard] if lizard in bear.index else pd.Series(np.nan, index=lion, dtype='float64')
    dog = (rabbit + giraffe) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = salmon / dog
    eagle = ~np.isfinite(hawk) | ~np.isfinite(salmon) | ~np.isfinite(dog) | (dog == 0)
    hawk = hawk.where(~eagle, np.nan).reindex(lion)
    dolphin = {tiger: float(hawk.get(tiger)) if np.isfinite(hawk.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(dolphin, koala, universe=universe, name='factor515')

def factor516(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor516')

def factor517(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor517')

def factor518(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor518')

def factor519(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = get_history_fundamentals(security=universe, fields=[bear.term_052, bear.term_060, bear.term_076, bear.term_004, bear.term_021], watch_date=wolf, count=4, interval='1q', stat_by_year=False)
    if bear is None or bear.empty:
        giraffe = {tiger: np.nan for tiger in universe}
        return _make_factor_series(giraffe, date, universe=universe, name='factor519')
    bear = bear.copy()
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    bear = bear.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    whale = int(min_valid_quarters)
    giraffe = {}
    for fox in universe:
        rabbit = bear[bear['code'] == fox]
        if rabbit.shape[0] < whale:
            giraffe[fox] = np.nan
            continue
        shark = rabbit['term_052'].astype(float).to_numpy()[-4:]
        sparrow = rabbit['term_060'].astype(float).to_numpy()[-4:]
        owl = rabbit['term_076'].astype(float).to_numpy()[-4:]
        cat = rabbit['term_004'].astype(float).to_numpy()[-4:]
        zebra = rabbit['term_021'].astype(float).to_numpy()[-4:]
        lion = np.zeros_like(sparrow, dtype=float)
        otter = np.zeros_like(sparrow, dtype=bool)
        for dog in [sparrow, owl, cat, zebra]:
            dolphin = np.isfinite(dog)
            lion[dolphin] += dog[dolphin]
            otter |= dolphin
        hawk = np.isfinite(shark)
        panda = hawk & otter
        if panda.sum() < whale:
            giraffe[fox] = np.nan
            continue
        eagle = float(np.nansum(shark[panda]))
        koala = float(np.nansum(lion[panda]))
        if not np.isfinite(koala) or koala == 0.0:
            giraffe[fox] = np.nan
        else:
            giraffe[fox] = float(eagle / koala)
    return _make_factor_series(giraffe, date, universe=universe, name='factor519')

def factor520(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = get_history_fundamentals(security=universe, fields=[bear.term_052], watch_date=lion, count=8, interval='1q', stat_by_year=False)
    if koala is None or koala.empty:
        fox = {cat: np.nan for cat in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor520')
    koala = koala.copy()
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    koala = koala.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    fox = {}
    wolf = int(min_valid_quarters)
    for dog in universe:
        otter = koala[koala['code'] == dog]
        if otter.shape[0] < 5:
            fox[dog] = np.nan
            continue
        dolphin = otter['term_052'].astype(float).to_numpy()
        if dolphin.size < 5:
            fox[dog] = np.nan
            continue
        panda = dolphin[-4:]
        bear = dolphin[-5:-1]
        tiger = panda[np.isfinite(panda)]
        rabbit = bear[np.isfinite(bear)]
        if tiger.size < wolf or rabbit.size < wolf:
            fox[dog] = np.nan
            continue
        giraffe = float(np.nansum(panda))
        zebra = float(np.nansum(bear))
        if not np.isfinite(zebra) or zebra == 0.0:
            fox[dog] = np.nan
        else:
            fox[dog] = float((giraffe - zebra) / abs(zebra))
    return _make_factor_series(fox, date, universe=universe, name='factor520')

def factor521(universe, date, lookback_days=60):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=int(lookback_days) + 1)
    if len(tiger) < int(lookback_days) + 1:
        bear = {cat: np.nan for cat in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor521')
    hawk = pd.to_datetime(tiger)
    dog = pd.to_datetime(tiger[0]).date()
    wolf = get_factor_values(universe, factors=['term_053'], end_date=panda, count=int(lookback_days) + 1)
    if wolf is None or 'term_053' not in wolf or wolf['term_053'] is None or wolf['term_053'].empty:
        bear = {cat: np.nan for cat in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor521')
    dolphin = wolf['term_053'].copy()
    dolphin.index = pd.to_datetime(dolphin.index)
    dolphin = dolphin.reindex(hawk)
    whale = dolphin.iloc[-1].reindex(universe).astype(float)
    zebra = dolphin.iloc[0].reindex(universe).astype(float)
    eagle = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    koala = get_fundamentals(eagle, date=panda)
    lion = get_fundamentals(eagle, date=dog)
    if koala is None or koala.empty:
        koala = pd.DataFrame(columns=['code', 'term_045'])
    if lion is None or lion.empty:
        lion = pd.DataFrame(columns=['code', 'term_045'])
    koala = koala.set_index('code')
    lion = lion.set_index('code')
    giraffe = koala['term_045'].astype(float).reindex(universe) if 'term_045' in koala.columns else pd.Series(np.nan, index=universe)
    rabbit = lion['term_045'].astype(float).reindex(universe) if 'term_045' in lion.columns else pd.Series(np.nan, index=universe)
    fox = (whale / giraffe.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    otter = (zebra / rabbit.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    shark = (fox - otter).replace([np.inf, -np.inf], np.nan)
    bear = {cat: float(shark.get(cat, np.nan)) for cat in universe}
    return _make_factor_series(bear, date, universe=universe, name='factor521')

def factor522(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor522')

def factor523(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    turtle = pd.Period(cat, freq='Q-DEC') - 1
    lizard = pd.PeriodIndex([turtle, turtle - 1, turtle - 2, turtle - 3], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    wolf = pd.Series(np.nan, index=panda, dtype='float64')
    tuna = _nearest_td_le(tiger)
    if tuna is not None:
        try:
            bear = get_factor_values(panda, factors=['ebit_ttm'], end_date=tuna, count=1)
            lion = bear.get('ebit_ttm', None) if isinstance(bear, dict) else None
            if isinstance(lion, pd.DataFrame) and (not lion.empty):
                frog = lion.iloc[-1]
                frog.index = frog.index.astype(str)
                wolf = pd.to_numeric(frog, errors='coerce').astype(float).reindex(panda)
        except Exception:
            pass
    if wolf.notna().sum() < 10:
        otter = get_history_fundamentals(security=panda, fields=[bear.term_090, bear.term_021, bear.term_035], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        whale = _prep_hist(otter)
        if not whale.empty:
            whale = whale[whale['q'].isin(lizard)]
            if not whale.empty:
                alpaca = whale.pivot(index='q', columns='code', values='term_090').reindex(index=lizard, columns=panda).apply(pd.to_numeric, errors='coerce').astype(float)
                dolphin = whale.pivot(index='q', columns='code', values='term_021').reindex(index=lizard, columns=panda).apply(pd.to_numeric, errors='coerce').astype(float)
                salmon = whale.pivot(index='q', columns='code', values='term_035').reindex(index=lizard, columns=panda).apply(pd.to_numeric, errors='coerce').astype(float)
                zebra = (alpaca + dolphin + salmon).sum(axis=0, min_count=1).reindex(panda)
                wolf = wolf.where(np.isfinite(wolf), zebra)
    hawk = pd.Series(np.nan, index=panda, dtype='float64')
    if tuna is not None:
        try:
            rabbit = get_factor_values(panda, factors=['term_022'], end_date=tuna, count=1)
            koala = rabbit.get('term_022', None) if isinstance(rabbit, dict) else None
            if isinstance(koala, pd.DataFrame) and (not koala.empty):
                frog = koala.iloc[-1]
                frog.index = frog.index.astype(str)
                hawk = pd.to_numeric(frog, errors='coerce').astype(float).reindex(panda)
        except Exception:
            pass
    if hawk.notna().sum() < 10:
        fox = get_history_fundamentals(security=panda, fields=[bear.term_021], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        shark = _prep_hist(fox)
        if not shark.empty:
            shark = shark[shark['q'].isin(lizard)]
            if not shark.empty:
                dolphin = shark.pivot(index='q', columns='code', values='term_021').reindex(index=lizard, columns=panda)
                dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
                zebra = dolphin.sum(axis=0, min_count=1).reindex(panda)
                hawk = hawk.where(np.isfinite(hawk), zebra)
    eagle = hawk.where(np.isfinite(hawk) & (hawk != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        owl = wolf / eagle
    owl = owl.replace([np.inf, -np.inf], np.nan)
    sparrow = ~np.isfinite(owl) | ~np.isfinite(wolf) | ~np.isfinite(eagle) | (eagle == 0)
    owl = owl.where(~sparrow, np.nan).reindex(panda)
    giraffe = {dog: float(owl.get(dog)) if np.isfinite(owl.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(giraffe, tiger, universe=universe, name='factor523')

def factor524(universe, date):
    _set_asof_date(date)
    bear = _to_date(date)
    tiger = pd.Timestamp(bear)
    fox = list(universe)
    badger = pd.Period(tiger, freq='Q-DEC') - 1
    alpaca = badger - 4
    lemur = pd.PeriodIndex([alpaca, badger], freq='Q-DEC')
    rabbit = get_history_fundamentals(security=fox, fields=[bear.term_052, bear.term_060, bear.term_076, bear.term_004, bear.term_021], watch_date=tiger, count=24, interval='1q', stat_by_year=False)
    if rabbit is None or rabbit.empty or 'code' not in rabbit.columns or ('statDate' not in rabbit.columns):
        return _make_factor_series({lion: np.nan for lion in fox}, bear, universe=universe, name='factor524')
    wolf = rabbit.copy()
    wolf['code'] = wolf['code'].astype(str)
    wolf['statDate'] = pd.to_datetime(wolf['statDate'], errors='coerce')
    wolf = wolf.dropna(subset=['code', 'statDate'])
    if wolf.empty:
        return _make_factor_series({lion: np.nan for lion in fox}, bear, universe=universe, name='factor524')
    wolf['q'] = wolf['statDate'].dt.to_period('Q-DEC')
    wolf = wolf[wolf['q'].isin(lemur)]
    if wolf.empty:
        return _make_factor_series({lion: np.nan for lion in fox}, bear, universe=universe, name='factor524')
    wolf = wolf.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')

    def _pivot(col):
        if col not in d.columns:
            return pd.DataFrame(index=q_need, columns=codes, dtype='float64')
        cat = d.pivot(index='q', columns='code', values=col).reindex(index=q_need, columns=codes)
        return cat.apply(pd.to_numeric, errors='coerce').astype(float)
    owl = _pivot('term_052')
    frog = _pivot('term_060')
    camel = _pivot('term_076')
    dog = _pivot('term_004')
    dolphin = _pivot('term_021')
    turtle = owl.loc[badger] if badger in owl.index else pd.Series(np.nan, index=fox, dtype='float64')
    salmon = frog.loc[badger] if badger in frog.index else pd.Series(np.nan, index=fox, dtype='float64')
    donkey = camel.loc[badger] if badger in camel.index else pd.Series(np.nan, index=fox, dtype='float64')
    panda = dog.loc[badger] if badger in dog.index else pd.Series(np.nan, index=fox, dtype='float64')
    whale = dolphin.loc[badger] if badger in dolphin.index else pd.Series(np.nan, index=fox, dtype='float64')
    sparrow = owl.loc[alpaca] if alpaca in owl.index else pd.Series(np.nan, index=fox, dtype='float64')
    lizard = frog.loc[alpaca] if alpaca in frog.index else pd.Series(np.nan, index=fox, dtype='float64')
    beaver = camel.loc[alpaca] if alpaca in camel.index else pd.Series(np.nan, index=fox, dtype='float64')
    cat = dog.loc[alpaca] if alpaca in dog.index else pd.Series(np.nan, index=fox, dtype='float64')
    zebra = dolphin.loc[alpaca] if alpaca in dolphin.index else pd.Series(np.nan, index=fox, dtype='float64')
    otter = salmon + donkey + panda + whale
    koala = lizard + beaver + cat + zebra
    otter = otter.where(np.isfinite(otter) & (otter != 0), np.nan)
    koala = koala.where(np.isfinite(koala) & (koala != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = turtle / otter
        eagle = sparrow / koala
        tuna = (hawk - eagle) / np.abs(eagle)
    tuna = tuna.replace([np.inf, -np.inf], np.nan)
    shark = ~np.isfinite(tuna) | ~np.isfinite(hawk) | ~np.isfinite(eagle) | (eagle == 0)
    tuna = tuna.where(~shark, np.nan).reindex(fox)
    giraffe = {lion: float(tuna.get(lion)) if np.isfinite(tuna.get(lion, np.nan)) else np.nan for lion in fox}
    return _make_factor_series(giraffe, bear, universe=universe, name='factor524')

def factor525(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    bear = None
    rabbit = None
    try:
        fox = get_factor_values(universe, factors=['term_053', 'term_051'], end_date=lion, count=1)
        if fox is not None:
            if 'term_053' in fox and fox['term_053'] is not None and (not fox['term_053'].empty):
                bear = fox['term_053'].iloc[-1].reindex(universe).astype(float)
            if 'term_051' in fox and fox['term_051'] is not None and (not fox['term_051'].empty):
                rabbit = fox['term_051'].iloc[-1].reindex(universe).astype(float)
    except Exception:
        bear, rabbit = (None, None)
    if bear is None or rabbit is None:
        wolf = {panda: np.nan for panda in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor525')
    koala = get_history_fundamentals(security=universe, fields=[fox.term_081], watch_date=lion, count=2, interval='1q', stat_by_year=False)
    if koala is None or koala.empty:
        wolf = {panda: np.nan for panda in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor525')
    koala = koala.copy()
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    koala = koala.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    dolphin = pd.Series(np.nan, index=universe, dtype='float64')
    zebra = pd.Series(np.nan, index=universe, dtype='float64')
    for tiger in universe:
        otter = koala[koala['code'] == tiger].tail(2)
        if otter.shape[0] < 2:
            continue
        zebra.loc[tiger] = float(otter.iloc[0].get('term_081', np.nan))
        dolphin.loc[tiger] = float(otter.iloc[1].get('term_081', np.nan))
    dog = ((dolphin + zebra) / 2.0).replace(0.0, np.nan)
    cat = (bear - rabbit).replace([np.inf, -np.inf], np.nan)
    giraffe = (cat / dog).replace([np.inf, -np.inf], np.nan)
    wolf = {panda: float(giraffe.get(panda, np.nan)) for panda in universe}
    return _make_factor_series(wolf, date, universe=universe, name='factor525')

def factor526(universe, date, d=20, code_chunk=200, day_chunk=5):
    _set_asof_date(date)
    import datetime as dt
    rabbit = _to_date(date)
    giraffe = get_trade_days(end_date=rabbit, count=int(d))
    if len(giraffe) == 0:
        whale = {koala: np.nan for koala in universe}
        return _make_factor_series(whale, date, universe=universe, name='factor526')
    badger = [pd.to_datetime(camel).date() for camel in giraffe]
    beaver = set(badger)
    tuna = []
    for eagle in range(0, len(badger), int(day_chunk)):
        otter = badger[eagle]
        fox = badger[min(eagle + int(day_chunk) - 1, len(badger) - 1)] + dt.timedelta(days=1)
        frog = pd.to_datetime(otter).strftime('%Y-%m-%d')
        dolphin = pd.to_datetime(fox).strftime('%Y-%m-%d')
        for shark in range(0, len(universe), int(code_chunk)):
            salmon = list(universe[shark:shark + int(code_chunk)])
            zebra = get_price(salmon, start_date=frog, end_date=dolphin, frequency='1m', fields=['open', 'high', 'low', 'close', 'money'], fq='post', panel=False)
            if zebra is None or zebra.empty:
                zebra = get_price(salmon, start_date=frog, end_date=dolphin, frequency='5m', fields=['open', 'high', 'low', 'close', 'money'], fq='post', panel=False)
            if zebra is None or zebra.empty:
                continue
            zebra = zebra.copy()
            zebra['date'] = pd.to_datetime(zebra['time']).dt.date
            zebra = zebra[zebra['date'].isin(beaver)]
            if zebra.empty:
                continue
            lion = zebra['open'].astype(float)
            dog = zebra['high'].astype(float)
            panda = zebra['low'].astype(float)
            cat = zebra['close'].astype(float)
            tiger = zebra['money'].astype(float)
            lizard = 2.0 * (dog - panda) - (cat - lion).abs()
            alpaca = pd.Series(np.nan, index=zebra.index, dtype='float64')
            turtle = np.isfinite(lizard.values) & np.isfinite(tiger.values) & (tiger.values > 0.0)
            alpaca.loc[turtle] = lizard.loc[turtle].values / tiger.loc[turtle].values
            zebra['term'] = alpaca
            lemur = zebra.groupby(['date', 'code'], sort=False)['term'].sum(min_count=1)
            if lemur is not None and (not lemur.empty):
                tuna.append(lemur)
    if not tuna:
        whale = {koala: np.nan for koala in universe}
        return _make_factor_series(whale, date, universe=universe, name='factor526')
    wolf = pd.concat(tuna).groupby(level=[0, 1], sort=False).sum()
    bear = wolf.unstack('code').reindex(index=badger, columns=universe)
    owl = bear.notna().sum(axis=0)
    hawk = bear.mean(axis=0, skipna=True)
    sparrow = max(3, int(len(badger) * 0.5))
    hawk.loc[owl < sparrow] = np.nan
    whale = {koala: float(hawk.get(koala, np.nan)) for koala in universe}
    return _make_factor_series(whale, date, universe=universe, name='factor526')

def factor527(universe, date):
    _set_asof_date(date)
    return factor326(universe, date).rename('factor527')

def factor528(universe, date, N=20):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = get_trade_days(end_date=bear, count=N + 1)
    if len(rabbit) < N + 1:
        whale = {wolf: np.nan for wolf in universe}
        return _make_factor_series(whale, date, universe=universe, name='factor528')
    hawk = rabbit[0]
    sparrow = pd.to_datetime(hawk).strftime('%Y-%m-%d')
    dolphin = bear.strftime('%Y-%m-%d')
    giraffe = get_price(universe, start_date=sparrow, end_date=dolphin, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if giraffe is None or giraffe.empty:
        whale = {wolf: np.nan for wolf in universe}
        return _make_factor_series(whale, date, universe=universe, name='factor528')
    shark = giraffe.pivot(index='time', columns='code', values='high').sort_index().iloc[-(N + 1):]
    eagle = giraffe.pivot(index='time', columns='code', values='low').sort_index().iloc[-(N + 1):]
    fox = giraffe.pivot(index='time', columns='code', values='close').sort_index().iloc[-(N + 1):]
    whale = {}
    for wolf in universe:
        if wolf not in shark.columns:
            whale[wolf] = np.nan
            continue
        tiger = shark[wolf].values
        koala = eagle[wolf].values
        panda = fox[wolf].values
        if len(tiger) < N + 1:
            whale[wolf] = np.nan
            continue
        lion = np.max(tiger[-N:])
        otter = np.min(koala[-N:])
        cat = np.abs(lion - otter)
        zebra = np.abs(panda[1:] - panda[:-1])
        dog = zebra[-N:].sum()
        if dog == 0.0 or np.isnan(cat) or np.isnan(dog):
            owl = 0.0
        else:
            owl = float(cat / dog)
        whale[wolf] = owl
    return _make_factor_series(whale, date, universe=universe, name='factor528')

def factor529(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor529')

def factor530(universe, date):
    _set_asof_date(date)
    return factor354(universe, date).rename('factor530')

def factor531(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor531')

def factor532(universe, date, window_days=250, N_neighbors=10, std_window=60, cap_window=150, min_std_obs=20):
    _set_asof_date(date)
    dolphin = _to_date(date)
    kangaroo = int(window_days + std_window + 2)
    whale = get_trade_days(end_date=dolphin, count=kangaroo)
    if len(whale) < kangaroo:
        owl = {otter: np.nan for otter in universe}
        return _make_factor_series(owl, date, universe=universe, name='factor532')
    crab = pd.to_datetime(whale[0]).strftime('%Y-%m-%d')
    sparrow = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    eagle = get_price(universe, start_date=crab, end_date=sparrow, frequency='daily', fields=['close'], fq='post', panel=False)
    if eagle is None or eagle.empty:
        owl = {otter: np.nan for otter in universe}
        return _make_factor_series(owl, date, universe=universe, name='factor532')
    wolf = eagle.pivot(index='time', columns='code', values='close').sort_index().astype(float)
    if wolf.shape[0] < int(window_days + std_window + 1):
        owl = {otter: np.nan for otter in universe}
        return _make_factor_series(owl, date, universe=universe, name='factor532')
    seal = wolf.pct_change()
    vulture = seal.iloc[-(int(window_days) + int(std_window)):-int(std_window)]
    bear = wolf.iloc[-int(std_window):]
    rabbit = wolf.iloc[-1]
    raccoon = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    hawk = get_fundamentals(raccoon, date=dolphin)
    if hawk is None or hawk.empty:
        owl = {otter: np.nan for otter in universe}
        return _make_factor_series(owl, date, universe=universe, name='factor532')
    hawk = hawk.set_index('code')
    camel = hawk['term_045'].astype(float).reindex(universe) if 'term_045' in hawk.columns else pd.Series(np.nan, index=universe)
    mouse = camel[np.isfinite(camel.values) & (camel.values > 0)].sort_values()
    turkey = mouse.index.tolist()
    if len(turkey) < 5:
        owl = {otter: np.nan for otter in universe}
        return _make_factor_series(owl, date, universe=universe, name='factor532')
    panda = vulture.reindex(columns=turkey).to_numpy(dtype=float)
    tiger, dog = panda.shape
    urchin = pd.Series(np.nan, index=universe, dtype='float64')
    for lizard in range(dog):
        lemur = max(0, lizard - int(cap_window))
        turtle = min(dog - 1, lizard + int(cap_window))
        fox = list(range(lemur, turtle + 1))
        if lizard in fox:
            fox.remove(lizard)
        if not fox:
            continue
        rat = panda[:, lizard]
        koala = panda[:, fox]
        if koala.size == 0:
            continue
        gecko = np.isfinite(rat)
        hyena = np.isfinite(koala)
        lion = hyena & gecko[:, None]
        jaguar = lion.sum(axis=0).astype(float)
        octopus = jaguar >= 3
        if not octopus.any():
            continue
        sheep = rat * rat
        deer = (rat[:, None] * lion).sum(axis=0)
        horse = (koala * lion).sum(axis=0)
        elk = (sheep[:, None] * lion).sum(axis=0)
        mink = (koala * koala * lion).sum(axis=0)
        goat = (rat[:, None] * koala * lion).sum(axis=0)
        donkey = np.zeros_like(jaguar)
        ferret = np.zeros_like(jaguar)
        donkey[octopus] = deer[octopus] / jaguar[octopus]
        ferret[octopus] = horse[octopus] / jaguar[octopus]
        zebra = goat - jaguar * donkey * ferret
        newt = elk - jaguar * donkey * donkey
        pig = mink - jaguar * ferret * ferret
        shark = np.sqrt(newt * pig)
        giraffe = np.full_like(jaguar, np.nan, dtype=float)
        narwhal = octopus & np.isfinite(shark) & (shark > 0)
        giraffe[narwhal] = zebra[narwhal] / shark[narwhal]
        if not np.isfinite(giraffe).any():
            continue
        cat = len(fox)
        tuna = int(N_neighbors)
        if tuna <= 0:
            continue
        tuna = min(tuna, cat)
        frog = np.where(np.isfinite(giraffe))[0]
        if frog.size == 0:
            continue
        ant = frog[np.argsort(giraffe[frog])[::-1][:tuna]]
        llama = [turkey[fox[salmon]] for salmon in ant.tolist()]
        if not llama:
            continue
        quail = rabbit.reindex(llama).dropna()
        if quail.empty:
            continue
        walrus = float(quail.mean())
        if np.isfinite(walrus) and walrus > 0.0:
            urchin.loc[turkey[lizard]] = walrus
    badger = np.log(bear.where(bear > 0.0))
    beaver = np.log(urchin.where(urchin > 0.0))
    penguin = badger.sub(beaver, axis=1)
    mole = penguin.notna().sum(axis=0)
    iguana = penguin.mean(axis=0, skipna=True)
    yak = penguin.std(axis=0, ddof=1, skipna=True).replace(0.0, np.nan)
    alpaca = penguin.iloc[-1]
    bee = ((alpaca - iguana) / yak).replace([np.inf, -np.inf], np.nan)
    bee.loc[mole < int(min_std_obs)] = np.nan
    owl = {otter: float(bee.get(otter, np.nan)) for otter in universe}
    return _make_factor_series(owl, date, universe=universe, name='factor532')

def factor533(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    otter = _to_date(date)
    sparrow = None
    try:
        giraffe = get_factor_values(universe, factors=['term_068'], end_date=otter, count=1)
        if giraffe is not None and 'term_068' in giraffe and (giraffe['term_068'] is not None) and (not giraffe['term_068'].empty):
            sparrow = giraffe['term_068'].iloc[-1].reindex(universe).astype(float)
    except Exception:
        sparrow = None
    if sparrow is None:
        bear = get_history_fundamentals(security=universe, fields=[bear.term_066], watch_date=otter, count=4, interval='1q', stat_by_year=False)
        if bear is None or bear.empty:
            zebra = {tiger: np.nan for tiger in universe}
            return _make_factor_series(zebra, date, universe=universe, name='factor533')
        bear = bear.copy()
        bear['statDate'] = pd.to_datetime(bear['statDate'])
        bear = bear.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        sparrow = pd.Series(np.nan, index=universe, dtype='float64')
        shark = int(min_valid_quarters)
        for koala in universe:
            rabbit = bear[bear['code'] == koala]
            owl = rabbit['term_066'].astype(float).to_numpy()[-4:]
            if np.isfinite(owl).sum() < shark:
                continue
            sparrow.loc[koala] = float(np.nansum(owl))
    hawk = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    wolf = get_fundamentals(hawk, date=otter)
    if wolf is None or wolf.empty:
        zebra = {tiger: np.nan for tiger in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor533')
    wolf = wolf.set_index('code')
    whale = wolf['term_045'].astype(float).reindex(universe) if 'term_045' in wolf.columns else pd.Series(np.nan, index=universe)
    fox = get_history_fundamentals(security=universe, fields=[fox.term_077, fox.term_044, fox.term_006, fox.term_012], watch_date=otter, count=1, interval='1q', stat_by_year=False)
    if fox is None or fox.empty:
        dog = pd.DataFrame(index=universe)
    else:
        fox = fox.copy()
        fox['statDate'] = pd.to_datetime(fox['statDate'])
        fox = fox.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        dog = fox.set_index('code').reindex(universe)
    turtle = dog.get('term_077', pd.Series(np.nan, index=universe)).astype(float).fillna(0.0)
    dolphin = dog.get('term_044', pd.Series(np.nan, index=universe)).astype(float).fillna(0.0)
    panda = dog.get('term_006', pd.Series(np.nan, index=universe)).astype(float).fillna(0.0)
    lion = dog.get('term_012', pd.Series(np.nan, index=universe)).astype(float).fillna(0.0)
    cat = (whale + turtle + dolphin + panda - lion).replace([np.inf, -np.inf], np.nan)
    eagle = (sparrow / cat.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    zebra = {tiger: float(eagle.get(tiger, np.nan)) for tiger in universe}
    return _make_factor_series(zebra, date, universe=universe, name='factor533')

def factor534(universe, date, K_days=10, freq_prefer='5m'):
    _set_asof_date(date)
    dog = _to_date(date)
    panda = get_trade_days(end_date=dog, count=int(K_days))
    if len(panda) == 0:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor534')
    bear = pd.to_datetime(panda[0]).strftime('%Y-%m-%d')
    lion = pd.to_datetime(panda[-1]).strftime('%Y-%m-%d')
    rabbit = set((pd.to_datetime(giraffe).date() for giraffe in panda))

    def _pull(freq):
        return get_price(universe, start_date=start_str, end_date=end_str, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
    tiger = _pull(freq_prefer)
    if tiger is None or tiger.empty:
        tiger = _pull('1m' if freq_prefer != '1m' else '5m')
    if tiger is None or tiger.empty:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor534')
    tiger = tiger.copy()
    tiger['time'] = pd.to_datetime(tiger['time'])
    tiger['date'] = tiger['time'].dt.date
    tiger = tiger[tiger['date'].isin(rabbit)]
    if tiger.empty:
        koala = {cat: np.nan for cat in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor534')
    tiger = tiger.sort_values(['code', 'date', 'time'])

    def _sc(g):
        koala = g['close'].to_numpy(dtype=float)
        dolphin = g['volume'].to_numpy(dtype=float)
        if koala.size < 3:
            return np.nan
        giraffe = koala[1:] / koala[:-1] - 1.0
        tiger = dolphin[1:]
        cat = koala[1:]
        bear = np.isfinite(giraffe) & np.isfinite(tiger) & np.isfinite(cat) & (tiger > 0.0)
        if bear.sum() < 2:
            return np.nan
        giraffe = giraffe[bear]
        tiger = tiger[bear]
        cat = cat[bear]
        panda = np.abs(giraffe) / np.power(tiger, 0.25)
        if not np.isfinite(panda).any() or tiger.sum() <= 0.0:
            return np.nan
        rabbit = np.argsort(-panda)
        lion = tiger[rabbit]
        dog = cat[rabbit]
        zebra = lion.sum()
        if zebra <= 0.0:
            return np.nan
        otter = np.cumsum(lion)
        fox = 0.2 * zebra
        wolf = otter <= fox
        if wolf.sum() == 0:
            wolf[0] = True
        whale = lion[wolf].sum()
        if whale <= 0.0:
            return np.nan
        eagle = (dog[wolf] * lion[wolf]).sum() / whale
        shark = (cat * tiger).sum() / tiger.sum()
        if not np.isfinite(shark) or shark == 0.0:
            return np.nan
        return float(eagle / shark)
    wolf = tiger.groupby(['code', 'date'], sort=False).apply(_sc)
    wolf = wolf.unstack('code').reindex(columns=universe)
    fox = wolf.notna().sum(axis=0)
    otter = wolf.mean(axis=0, skipna=True)
    otter.loc[fox < 3] = np.nan
    koala = {cat: float(otter.get(cat, np.nan)) for cat in universe}
    return _make_factor_series(koala, date, universe=universe, name='factor534')

def factor535(universe, date, N1=10, N2=20, N=5):
    _set_asof_date(date)
    return factor148(universe, date, N1=N1, N2=N2, N=N).rename('factor535')

def factor536(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    lion = _to_date(date)
    giraffe = None
    panda = None
    try:
        fox = get_factor_values(universe, factors=['term_068', 'term_061'], end_date=lion, count=1)
        if fox is not None:
            if 'term_068' in fox and fox['term_068'] is not None and (not fox['term_068'].empty):
                giraffe = fox['term_068'].iloc[-1].reindex(universe).astype(float)
            if 'term_061' in fox and fox['term_061'] is not None and (not fox['term_061'].empty):
                panda = fox['term_061'].iloc[-1].reindex(universe).astype(float)
    except Exception:
        giraffe, panda = (None, None)
    if giraffe is None or panda is None:
        koala = get_history_fundamentals(security=universe, fields=[bear.term_066, bear.term_060], watch_date=lion, count=4, interval='1q', stat_by_year=False)
        if koala is None or koala.empty:
            wolf = {cat: np.nan for cat in universe}
            return _make_factor_series(wolf, date, universe=universe, name='factor536')
        koala = koala.copy()
        koala['statDate'] = pd.to_datetime(koala['statDate'])
        koala = koala.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        giraffe = pd.Series(np.nan, index=universe, dtype='float64')
        panda = pd.Series(np.nan, index=universe, dtype='float64')
        rabbit = int(min_valid_quarters)
        for dog in universe:
            otter = koala[koala['code'] == dog]
            if otter.shape[0] < 3:
                continue
            zebra = otter['term_066'].astype(float).to_numpy()[-4:]
            tiger = otter['term_060'].astype(float).to_numpy()[-4:]
            if np.isfinite(zebra).sum() < rabbit:
                continue
            giraffe.loc[dog] = float(np.nansum(zebra))
            if np.isfinite(tiger).sum() < rabbit:
                continue
            panda.loc[dog] = float(np.nansum(tiger))
    bear = ((giraffe - panda) / giraffe.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    wolf = {cat: float(bear.get(cat, np.nan)) for cat in universe}
    return _make_factor_series(wolf, date, universe=universe, name='factor536')

def factor537(universe, date, months_hist=12, lookback_days=420):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = get_trade_days(end_date=koala, count=int(lookback_days))
    if len(otter) < 40:
        bear = {dog: np.nan for dog in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor537')
    owl = pd.to_datetime(otter[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(koala).strftime('%Y-%m-%d')
    fox = get_price(universe, start_date=owl, end_date=wolf, frequency='daily', fields=['close', 'money'], fq='post', panel=False)
    if fox is None or fox.empty:
        bear = {dog: np.nan for dog in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor537')
    panda = fox.pivot(index='time', columns='code', values='close').sort_index().astype(float)
    shark = fox.pivot(index='time', columns='code', values='money').sort_index().astype(float)
    sparrow = panda.pct_change()
    turtle = (sparrow.abs() / shark.where(shark > 0.0)).replace([np.inf, -np.inf], np.nan)
    whale = pd.to_datetime(turtle.index).to_period('M')
    zebra = turtle.groupby(whale).mean()
    lion = pd.to_datetime(koala).to_period('M')
    if lion not in zebra.index:
        bear = {dog: np.nan for dog in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor537')
    tiger = zebra.loc[lion].reindex(universe)
    giraffe = [lion - dolphin for dolphin in range(1, int(months_hist) + 1)]
    rabbit = zebra.reindex(giraffe)
    cat = rabbit.mean(axis=0, skipna=True)
    eagle = rabbit.notna().sum(axis=0)
    hawk = (-(tiger - cat)).replace([np.inf, -np.inf], np.nan)
    hawk.loc[eagle < max(3, int(months_hist * 0.5))] = np.nan
    bear = {dog: float(hawk.get(dog, np.nan)) for dog in universe}
    return _make_factor_series(bear, date, universe=universe, name='factor537')

def factor538(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    panda = pd.Timestamp(fox)
    otter = list(universe)
    sparrow = pd.Period(panda, freq='Q-DEC') - 1
    owl = pd.PeriodIndex([sparrow, sparrow - 1, sparrow - 2, sparrow - 3], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    turtle = pd.Series(np.nan, index=otter, dtype='float64')
    frog = _nearest_td_le(fox)
    if frog is not None:
        try:
            giraffe = get_factor_values(otter, factors=['term_068'], end_date=frog, count=1)
            wolf = giraffe.get('term_068', None) if isinstance(giraffe, dict) else None
            if isinstance(wolf, pd.DataFrame) and (not wolf.empty):
                lizard = wolf.iloc[-1]
                lizard.index = lizard.index.astype(str)
                turtle = pd.to_numeric(lizard, errors='coerce').astype(float).reindex(otter)
        except Exception:
            pass
    if turtle.notna().sum() < 10:
        rabbit = get_history_fundamentals(security=otter, fields=[bear.term_066], watch_date=panda, count=12, interval='1q', stat_by_year=False)
        whale = _prep_hist(rabbit)
        if not whale.empty and 'term_066' in whale.columns:
            whale = whale[whale['q'].isin(owl)]
            if not whale.empty:
                hawk = whale.pivot(index='q', columns='code', values='term_066').reindex(index=owl, columns=otter)
                hawk = hawk.apply(pd.to_numeric, errors='coerce').astype(float)
                dolphin = hawk.sum(axis=0, min_count=1).reindex(otter)
                turtle = turtle.where(np.isfinite(turtle), dolphin)
    bear = get_history_fundamentals(security=otter, fields=[fox.term_001, fox.term_005], watch_date=panda, count=20, interval='1q', stat_by_year=False)
    tiger = _prep_hist(bear)
    if tiger.empty:
        return _make_factor_series({koala: np.nan for koala in otter}, fox, universe=universe, name='factor538')
    tiger = tiger[tiger['q'].isin([sparrow])]
    if tiger.empty:
        return _make_factor_series({koala: np.nan for koala in otter}, fox, universe=universe, name='factor538')
    dog = tiger.pivot(index='q', columns='code', values='term_001').reindex(index=[sparrow], columns=otter)
    lion = tiger.pivot(index='q', columns='code', values='term_005').reindex(index=[sparrow], columns=otter)
    dog = dog.apply(pd.to_numeric, errors='coerce').astype(float)
    lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
    cat = (dog.loc[sparrow] if sparrow in dog.index else pd.Series(np.nan, index=otter, dtype='float64')) + (lion.loc[sparrow] if sparrow in lion.index else pd.Series(np.nan, index=otter, dtype='float64'))
    cat = cat.where(np.isfinite(cat) & (cat != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = turtle / cat
    eagle = eagle.replace([np.inf, -np.inf], np.nan)
    shark = ~np.isfinite(eagle) | ~np.isfinite(turtle) | ~np.isfinite(cat) | (cat == 0)
    eagle = eagle.where(~shark, np.nan).reindex(otter)
    zebra = {koala: float(eagle.get(koala)) if np.isfinite(eagle.get(koala, np.nan)) else np.nan for koala in otter}
    return _make_factor_series(zebra, fox, universe=universe, name='factor538')

def factor539(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    try:
        panda = get_factor_values(universe, factors=['term_053', 'term_051'], end_date=dog, count=1)
    except Exception:
        panda = None
    if panda is None or 'term_053' not in panda or 'term_051' not in panda:
        tiger = {cat: np.nan for cat in universe}
        return _make_factor_series(tiger, date, universe=universe, name='factor539')
    lion = panda['term_053'].iloc[-1].reindex(universe).astype(float) if panda['term_053'] is not None and (not panda['term_053'].empty) else pd.Series(np.nan, index=universe)
    koala = panda['term_051'].iloc[-1].reindex(universe).astype(float) if panda['term_051'] is not None and (not panda['term_051'].empty) else pd.Series(np.nan, index=universe)
    otter = ((lion - koala) / lion.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    tiger = {cat: float(otter.get(cat, np.nan)) for cat in universe}
    return _make_factor_series(tiger, date, universe=universe, name='factor539')

def factor540(universe, date, bench_index='000905.XSHG', Y_years=5, K_months=12):
    _set_asof_date(date)
    dog = _to_date(date)
    panda = get_trade_days(end_date=dog, count=Y_years * 252 + 5)
    if len(panda) < 252 * 2:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor540')
    lizard = panda[0]
    tuna = pd.to_datetime(lizard).strftime('%Y-%m-%d')
    koala = dog.strftime('%Y-%m-%d')
    sparrow = list(dict.fromkeys(list(universe) + [bench_index]))
    lion = get_price(sparrow, start_date=tuna, end_date=koala, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty or bench_index not in lion['code'].unique():
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor540')
    rabbit = lion.pivot(index='time', columns='code', values='close').sort_index()
    giraffe = rabbit.pct_change()
    wolf = np.log(1.0 + giraffe)
    fox = wolf.rolling(3).sum().dropna(how='all')
    if fox.empty or bench_index not in fox.columns:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor540')
    dolphin = fox[bench_index]
    tiger = get_trade_days(end_date=dog, count=K_months * 21)
    if len(tiger) < 30:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor540')
    frog = tiger[0]
    salmon = pd.to_datetime(frog)
    bear = wolf.loc[salmon:koala]
    if bear.empty or bench_index not in bear.columns:
        otter = {cat: np.nan for cat in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor540')
    eagle = bear[bench_index]
    eagle = eagle.dropna()
    turtle = eagle.std(ddof=1)
    if turtle == 0.0 or np.isnan(turtle):
        turtle = np.nan
    otter = {}
    for cat in universe:
        if cat not in fox.columns or cat not in bear.columns:
            otter[cat] = np.nan
            continue
        zebra = fox[cat].dropna()
        whale = dolphin.reindex(zebra.index).dropna()
        zebra = zebra.reindex(whale.index).dropna()
        if len(zebra) < 60:
            otter[cat] = np.nan
            continue
        hawk = np.corrcoef(zebra.values, whale.values)[0, 1]
        shark = bear[cat].dropna()
        if len(shark) < 20:
            otter[cat] = np.nan
            continue
        owl = shark.std(ddof=1)
        if np.isnan(turtle) or np.isnan(owl) or np.isnan(hawk) or (turtle == 0.0):
            alpaca = np.nan
        else:
            alpaca = hawk * (owl / turtle)
        otter[cat] = alpaca
    return _make_factor_series(otter, date, universe=universe, name='factor540')

def factor541(universe, date):
    _set_asof_date(date)
    return factor241(universe, date).rename('factor541')

def factor542(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    panda = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    whale = eagle - 4
    shark = pd.PeriodIndex([whale, eagle], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[bear.term_063, bear.term_066], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor542')
    tiger = koala.copy()
    tiger['code'] = tiger['code'].astype(str)
    tiger['statDate'] = pd.to_datetime(tiger['statDate'], errors='coerce')
    tiger = tiger.dropna(subset=['code', 'statDate'])
    if tiger.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor542')
    tiger['q'] = tiger['statDate'].dt.to_period('Q-DEC')
    tiger = tiger[tiger['q'].isin(shark)]
    if tiger.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor542')
    tiger = tiger.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    giraffe = tiger.pivot(index='q', columns='code', values='term_063').reindex(index=shark, columns=panda)
    sparrow = tiger.pivot(index='q', columns='code', values='term_066').reindex(index=shark, columns=panda)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = giraffe.loc[eagle] if eagle in giraffe.index else pd.Series(np.nan, index=panda, dtype='float64')
    owl = sparrow.loc[eagle] if eagle in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    rabbit = giraffe.loc[whale] if whale in giraffe.index else pd.Series(np.nan, index=panda, dtype='float64')
    hawk = sparrow.loc[whale] if whale in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = zebra / owl
        wolf = rabbit / hawk
        dolphin = (bear - wolf) / np.abs(wolf)
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    fox = ~np.isfinite(dolphin) | ~np.isfinite(bear) | ~np.isfinite(wolf) | ~np.isfinite(owl) | ~np.isfinite(hawk) | (owl == 0) | (hawk == 0) | (wolf == 0)
    dolphin = dolphin.where(~fox, np.nan).reindex(panda)
    otter = {dog: float(dolphin.get(dog)) if np.isfinite(dolphin.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(otter, lion, universe=universe, name='factor542')

def factor543(universe, date, T_quarters=6):
    _set_asof_date(date)
    return factor244(universe, date).rename('factor543')

def factor544(universe, date):
    _set_asof_date(date)
    return factor145(universe, date).rename('factor544')

def factor545(universe, date, N=14):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = get_trade_days(end_date=wolf, count=N + 1)
    if len(bear) < N + 1:
        zebra = {fox: np.nan for fox in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor545')
    salmon = bear[0]
    tuna = pd.to_datetime(salmon)
    rabbit = get_price(list(universe), start_date=tuna, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        zebra = {fox: np.nan for fox in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor545')
    rabbit = rabbit.copy()
    if 'time' not in rabbit.columns:
        rabbit = rabbit.reset_index()
    if 'code' not in rabbit.columns:
        zebra = {fox: np.nan for fox in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor545')
    koala = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    otter = koala.tail(N + 1)
    giraffe = otter.diff().iloc[1:]
    dolphin = giraffe.clip(lower=0.0)
    whale = (-giraffe).clip(lower=0.0)
    tiger = dolphin.mean(axis=0)
    lion = whale.mean(axis=0)
    frog = pd.Series(np.nan, index=koala.columns, dtype='float64')
    sparrow = np.isfinite(tiger.values)
    owl = np.isfinite(lion.values)
    turtle = sparrow & owl
    dog = tiger.copy()
    panda = lion.copy()
    shark = turtle & (panda == 0.0) & (dog > 0.0)
    frog.loc[shark] = 100.0
    eagle = turtle & (dog == 0.0) & (panda > 0.0)
    frog.loc[eagle] = 0.0
    hawk = turtle & ~shark & ~eagle & (panda != 0.0)
    cat = dog[hawk] / panda[hawk]
    frog.loc[hawk] = 100.0 - 100.0 / (1.0 + cat)
    alpaca = list(universe)
    lizard = {fox: float(frog.get(fox, np.nan)) if np.isfinite(frog.get(fox, np.nan)) else np.nan for fox in alpaca}
    return _make_factor_series(lizard, date, universe=universe, name='factor545')

def factor546(universe, date, bench_index='000905.XSHG', N_days=20, freq_prefer='5m'):
    _set_asof_date(date)
    rabbit = _to_date(date)
    if isinstance(bench_index, str) and (bench_index.lower() == 'market' or bench_index == '000905.XSHG'):
        bench_index = cat
    giraffe = get_trade_days(end_date=rabbit, count=int(N_days))
    if len(giraffe) < int(N_days):
        sparrow = {otter: np.nan for otter in universe}
        return _make_factor_series(sparrow, date, universe=universe, name='factor546')
    jaguar = [pd.to_datetime(llama).date() for llama in giraffe]
    kangaroo = set(jaguar)
    hyena = pd.to_datetime(giraffe[0]).strftime('%Y-%m-%d')
    hawk = pd.to_datetime(giraffe[-1]).strftime('%Y-%m-%d')
    donkey = list(dict.fromkeys(list(universe) + [bench_index]))

    def _pull(freq):
        return get_price(sec_list, start_date=start_str, end_date=end_str, frequency=freq, fields=['close'], fq='post', panel=False)
    shark = _pull(freq_prefer)
    if shark is None or shark.empty:
        shark = _pull('1m' if freq_prefer != '1m' else '5m')
    if shark is None or shark.empty:
        sparrow = {otter: np.nan for otter in universe}
        return _make_factor_series(sparrow, date, universe=universe, name='factor546')
    shark = shark.copy()
    shark = _fa__ensure_time_code(shark)
    if shark is None or shark.empty or 'time' not in shark.columns:
        sparrow = {otter: np.nan for otter in universe}
        return _make_factor_series(sparrow, date, universe=universe, name='factor546')
    if 'code' not in shark.columns:
        sparrow = {otter: np.nan for otter in universe}
        return _make_factor_series(sparrow, date, universe=universe, name='factor546')
    shark['time'] = pd.to_datetime(shark['time'])
    shark['close'] = pd.to_numeric(shark['close'], errors='coerce').astype(float)
    shark['date'] = shark['time'].dt.date
    shark = shark[shark['date'].isin(kangaroo)]
    if shark.empty:
        sparrow = {otter: np.nan for otter in universe}
        return _make_factor_series(sparrow, date, universe=universe, name='factor546')
    if bench_index not in shark['code'].unique().tolist():
        if bench_index != cat:
            bench_index = cat
        donkey = list(dict.fromkeys(list(universe) + [bench_index]))
        eagle = _pull(freq_prefer)
        if eagle is None or eagle.empty:
            eagle = _pull('1m' if freq_prefer != '1m' else '5m')
        if eagle is not None and (not eagle.empty):
            eagle = _fa__ensure_time_code(eagle.copy())
            if eagle is not None and (not eagle.empty) and ('time' in eagle.columns) and ('code' in eagle.columns):
                eagle['time'] = pd.to_datetime(eagle['time'])
                eagle['close'] = pd.to_numeric(eagle['close'], errors='coerce').astype(float)
                eagle['date'] = eagle['time'].dt.date
                eagle = eagle[eagle['date'].isin(kangaroo)]
                if not eagle.empty:
                    shark = eagle
    shark['hour'] = shark['time'].dt.hour
    shark['session'] = np.where(shark['hour'] < 12, 'am', 'pm')
    shark = shark.sort_values(['code', 'date', 'time'])
    lizard = shark.groupby(['date', 'code'], sort=False)['close'].first().astype(float)
    wolf = shark.groupby(['date', 'code'], sort=False)['close'].last().astype(float)
    turtle = shark[shark['session'] == 'am'].groupby(['date', 'code'], sort=False)['close'].last().astype(float)
    salmon = (turtle / lizard - 1.0).replace([np.inf, -np.inf], np.nan)
    alpaca = (wolf / turtle - 1.0).replace([np.inf, -np.inf], np.nan)
    tuna = salmon.unstack('code')
    lemur = alpaca.unstack('code')
    gecko = pd.MultiIndex.from_product([jaguar, ['am', 'pm']], names=['date', 'seg'])
    cat = pd.DataFrame(index=gecko, columns=donkey, dtype='float64')
    for ferret, whale in [('am', tuna), ('pm', lemur)]:
        if whale is None or whale.empty:
            continue
        whale = whale.reindex(index=jaguar, columns=donkey)
        cat.loc[(slice(None), ferret), :] = whale.to_numpy()
    if bench_index not in cat.columns:
        sparrow = {otter: np.nan for otter in universe}
        return _make_factor_series(sparrow, date, universe=universe, name='factor546')
    panda = cat[bench_index]
    iguana = pd.Series(np.nan, index=list(universe), dtype='float64')
    for bear in universe:
        if bear not in cat.columns:
            continue
        mole = cat[bear]
        dolphin = pd.DataFrame({'y': mole, 'x': panda}).replace([np.inf, -np.inf], np.nan).dropna()
        if dolphin.shape[0] < max(10, int(N_days)):
            continue
        dog = np.column_stack([np.ones(dolphin.shape[0]), dolphin['x'].values.astype(float)])
        tiger = dolphin['y'].values.astype(float)
        try:
            koala, lion, lion, lion = np.linalg.lstsq(dog, tiger, rcond=None)
            badger = tiger - dog.dot(koala)
            iguana.loc[bear] = float(np.mean(badger ** 2))
        except Exception:
            continue
    zebra = get_price(donkey, start_date=hyena, end_date=hawk, frequency='daily', fields=['close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        camel = pd.Series(np.nan, index=list(universe), dtype='float64')
    else:
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            zebra = zebra.reset_index().rename(columns={'index': 'time'})
        fox = zebra.pivot(index='time', columns='code', values='close').sort_index()
        fox = fox.reindex(index=pd.to_datetime(jaguar))
        with np.errstate(divide='ignore', invalid='ignore'):
            camel = (fox.iloc[-1] / fox.iloc[0] - 1.0).replace([np.inf, -np.inf], np.nan)
    owl = iguana.notna() & camel.notna()
    if owl.sum() < 5:
        frog = {otter: float(iguana.get(otter, np.nan)) for otter in universe}
        return _make_factor_series(frog, date, universe=universe, name='factor546')
    mole = iguana[owl].values.astype(float)
    llama = camel[owl].values.astype(float)
    dog = np.column_stack([np.ones_like(llama), llama])
    try:
        koala, lion, lion, lion = np.linalg.lstsq(dog, mole, rcond=None)
        narwhal = dog.dot(koala)
        badger = mole - narwhal
        beaver = pd.Series(np.nan, index=iguana.index)
        beaver.loc[iguana[owl].index] = badger
    except Exception:
        beaver = iguana.copy()
    sparrow = {otter: float(beaver.get(otter, np.nan)) if np.isfinite(beaver.get(otter, np.nan)) else np.nan for otter in universe}
    return _make_factor_series(sparrow, date, universe=universe, name='factor546')

def factor547(universe, date):
    _set_asof_date(date)
    return factor301(universe, date).rename('factor547')

def factor548(universe, date):
    _set_asof_date(date)
    cat = factor490(universe, date)
    dog = -cat
    dog.name = 'factor548'
    return dog

def factor549(universe, date):
    _set_asof_date(date)
    fox = factor541(universe, date)
    rabbit = factor444(universe, date)
    koala = factor536(universe, date)
    panda = factor548(universe, date)
    wolf = fox.droplevel(0)
    giraffe = rabbit.droplevel(0)
    otter = koala.droplevel(0)
    tiger = panda.droplevel(0)
    dog = pd.DataFrame({'net_margin': wolf, 'roa': giraffe, 'gm': otter, 'earn_quality': tiger}).reindex(universe)

    def zscore_col(col: pd.Series):
        tiger = col.copy()
        dog = tiger.notna()
        if dog.sum() < 3:
            return pd.Series(np.nan, index=tiger.index)
        cat = tiger[dog].mean()
        panda = tiger[dog].std(ddof=1)
        if panda == 0.0 or np.isnan(panda):
            lion = pd.Series(0.0, index=tiger.index)
            lion[~dog] = np.nan
            return lion
        lion = pd.Series(np.nan, index=tiger.index)
        lion[dog] = (tiger[dog] - cat) / panda
        return lion
    zebra = dog.apply(zscore_col, axis=0)
    bear = zebra.sum(axis=1, min_count=1)
    lion = {cat: float(bear.get(cat, np.nan)) for cat in universe}
    return _make_factor_series(lion, date, universe=universe, name='factor549')

def factor550(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    panda = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    whale = eagle - 4
    shark = pd.PeriodIndex([whale, eagle], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[bear.term_052, bear.term_066], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor550')
    tiger = koala.copy()
    tiger['code'] = tiger['code'].astype(str)
    tiger['statDate'] = pd.to_datetime(tiger['statDate'], errors='coerce')
    tiger = tiger.dropna(subset=['code', 'statDate'])
    if tiger.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor550')
    tiger['q'] = tiger['statDate'].dt.to_period('Q-DEC')
    tiger = tiger[tiger['q'].isin(shark)]
    if tiger.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor550')
    tiger = tiger.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    giraffe = tiger.pivot(index='q', columns='code', values='term_052').reindex(index=shark, columns=panda)
    sparrow = tiger.pivot(index='q', columns='code', values='term_066').reindex(index=shark, columns=panda)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = giraffe.loc[eagle] if eagle in giraffe.index else pd.Series(np.nan, index=panda, dtype='float64')
    owl = sparrow.loc[eagle] if eagle in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    rabbit = giraffe.loc[whale] if whale in giraffe.index else pd.Series(np.nan, index=panda, dtype='float64')
    hawk = sparrow.loc[whale] if whale in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = zebra / owl
        wolf = rabbit / hawk
        dolphin = (bear - wolf) / np.abs(wolf)
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    fox = ~np.isfinite(dolphin) | ~np.isfinite(bear) | ~np.isfinite(wolf) | ~np.isfinite(owl) | ~np.isfinite(hawk) | (owl == 0) | (hawk == 0) | (wolf == 0)
    dolphin = dolphin.where(~fox, np.nan).reindex(panda)
    otter = {dog: float(dolphin.get(dog)) if np.isfinite(dolphin.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(otter, lion, universe=universe, name='factor550')

def factor551(universe, date):
    _set_asof_date(date)
    return factor429(universe, date).rename('factor551')

def factor552(universe, date):
    _set_asof_date(date)
    return factor283(universe, date).rename('factor552')

def factor553(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor553')

def factor554(universe, date, T=20):
    _set_asof_date(date)
    return factor361(universe, date, T=T).rename('factor554')

def factor555(universe, date):
    _set_asof_date(date)
    return factor242(universe, date).rename('factor555')

def factor556(universe, date):
    _set_asof_date(date)
    return factor309(universe, date).rename('factor556')

def factor557(universe, date, K_months=6, bench_index='000905.XSHG', rf_series=None):
    _set_asof_date(date)
    return factor269(universe, date, K_months=K_months, bench_index=bench_index).rename('factor557')

def factor558(universe, date):
    _set_asof_date(date)
    whale = _to_date(date)
    otter = pd.Timestamp(whale)
    giraffe = list(universe)
    beaver = pd.Period(otter, freq='Q-DEC') - 1
    camel = beaver - 1
    badger = pd.PeriodIndex([beaver, beaver - 1, beaver - 2, beaver - 3], freq='Q-DEC')
    lemur = pd.PeriodIndex([beaver, camel], freq='Q-DEC')
    eagle = get_history_fundamentals(security=giraffe, fields=[bear.term_066, bear.term_060], watch_date=otter, count=16, interval='1q', stat_by_year=False)
    shark = get_history_fundamentals(security=giraffe, fields=[fox.term_001, fox.term_005, fox.term_002, fox.inventories], watch_date=otter, count=16, interval='1q', stat_by_year=False)
    if (eagle is None or eagle.empty) or (shark is None or shark.empty):
        return _make_factor_series({bear: np.nan for bear in giraffe}, whale, universe=universe, name='factor558')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    sparrow = _prep(eagle)
    fox = _prep(shark)
    if sparrow is None or fox is None:
        return _make_factor_series({bear: np.nan for bear in giraffe}, whale, universe=universe, name='factor558')
    ferret = sparrow.pivot(index='q', columns='code', values='term_066').sort_index().reindex(columns=giraffe)
    zebra = sparrow.pivot(index='q', columns='code', values='term_060').sort_index().reindex(columns=giraffe)
    ferret = ferret.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=badger)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=badger)
    gecko = ferret.sum(axis=0, min_count=2)
    dolphin = zebra.sum(axis=0, min_count=2)

    def _pv(col):
        if col not in bal.columns:
            return pd.DataFrame(np.nan, index=q_list_bal, columns=codes, dtype=float)
        cat = bal.pivot(index='q', columns='code', values=col).sort_index().reindex(columns=codes)
        cat = cat.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=q_list_bal)
        return cat
    tiger = _pv('term_001')
    wolf = _pv('term_005')
    cat = _pv('term_002')
    owl = _pv('inventories')
    koala = tiger.loc[beaver].fillna(0.0) + wolf.loc[beaver].fillna(0.0)
    panda = cat.loc[beaver]
    turtle = (owl.loc[beaver] + owl.loc[camel]) / 2.0
    tuna = pd.Series(np.nan, index=giraffe, dtype='float64')
    salmon = gecko.notna() & dolphin.notna() & np.isfinite(koala.values) & np.isfinite(panda.values) & np.isfinite(turtle.values) & (koala.values > 0) & (panda.values > 0) & (turtle.values > 0)
    if salmon.sum() < 1:
        return _make_factor_series({bear: np.nan for bear in giraffe}, whale, universe=universe, name='factor558')
    with np.errstate(divide='ignore', invalid='ignore'):
        donkey = gecko / koala
        alpaca = dolphin / panda
        frog = dolphin / turtle
        lion = 360.0 / donkey
        dog = 360.0 / alpaca
        lizard = 360.0 / frog
        rabbit = lizard + lion - dog
    rabbit = rabbit.replace([np.inf, -np.inf], np.nan)
    tuna.loc[salmon] = rabbit.loc[salmon]
    hawk = {bear: float(tuna.get(bear, np.nan)) if np.isfinite(tuna.get(bear, np.nan)) else np.nan for bear in giraffe}
    return _make_factor_series(hawk, whale, universe=universe, name='factor558')

def factor559(universe, date):
    _set_asof_date(date)
    return factor115(universe, date).rename('factor559')

def factor560(universe, date, N=20, lam=0.25):
    _set_asof_date(date)
    return factor260(universe, date, N=N, lam=lam).rename('factor560')

def factor561(universe, date, K_months=6):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=K_months * 21)
    if len(tiger) == 0:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor561')
    bear = tiger[0]
    rabbit = pd.to_datetime(bear).strftime('%Y-%m-%d')
    otter = pd.to_datetime(tiger[-1]).strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=rabbit, end_date=otter, frequency='daily', fields=['volume'], fq='post', panel=False)
    if lion is None or lion.empty:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor561')
    zebra = lion.pivot(index='time', columns='code', values='volume').sort_index()
    wolf = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(universe))
    koala = get_fundamentals(wolf, date=panda)
    if koala is None or koala.empty:
        koala = pd.DataFrame(columns=['code', 'circulating_cap'])
    koala = koala.set_index('code')
    fox = {}
    for dog in universe:
        if dog not in zebra.columns:
            fox[dog] = np.nan
            continue
        cat = float(koala['circulating_cap'].get(dog, np.nan)) if 'circulating_cap' in koala.columns else np.nan
        if np.isnan(cat) or cat <= 0.0:
            fox[dog] = np.nan
            continue
        giraffe = zebra[dog] / (cat * 10000.0)
        giraffe = giraffe.replace([np.inf, -np.inf], np.nan).dropna()
        if len(giraffe) < 2:
            fox[dog] = np.nan
        else:
            fox[dog] = float(giraffe.std(ddof=1))
    return _make_factor_series(fox, date, universe=universe, name='factor561')

def factor562(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    frog = pd.Period(cat, freq='Q-DEC') - 1
    salmon = frog - 1
    lizard = frog - 4

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame, asof_ts_local: pd.Timestamp) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts_local)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    tuna = pd.Series(np.nan, index=tiger, dtype='float64')
    alpaca = pd.Series(np.nan, index=tiger, dtype='float64')
    badger = _nearest_td_le(frog.end_time.date())
    beaver = _nearest_td_le(salmon.end_time.date())
    if badger is not None and beaver is not None:
        try:
            zebra = get_factor_values(tiger, factors=['roe_ttm'], end_date=badger, count=1)
            dolphin = get_factor_values(tiger, factors=['roe_ttm'], end_date=beaver, count=1)
            wolf = zebra.get('roe_ttm', None) if isinstance(zebra, dict) else None
            fox = dolphin.get('roe_ttm', None) if isinstance(dolphin, dict) else None
            if isinstance(wolf, pd.DataFrame) and (not wolf.empty):
                lemur = wolf.iloc[-1]
                lemur.index = lemur.index.astype(str)
                tuna = pd.to_numeric(lemur, errors='coerce').astype(float).reindex(tiger)
            if isinstance(fox, pd.DataFrame) and (not fox.empty):
                lemur = fox.iloc[-1]
                lemur.index = lemur.index.astype(str)
                alpaca = pd.to_numeric(lemur, errors='coerce').astype(float).reindex(tiger)
        except Exception:
            pass
    if tuna.notna().sum() < 10 or alpaca.notna().sum() < 10:
        otter = get_history_fundamentals(security=tiger, fields=[rabbit.roe], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        hawk = _prep_hist(otter, cat)
        if not hawk.empty and 'roe' in hawk.columns:
            hawk = hawk[hawk['q'].isin([salmon, frog])]
            if not hawk.empty:
                turtle = hawk.pivot(index='q', columns='code', values='roe').reindex(index=[salmon, frog], columns=tiger)
                turtle = turtle.apply(pd.to_numeric, errors='coerce').astype(float)
                if frog in turtle.index:
                    tuna = tuna.where(np.isfinite(tuna), turtle.loc[frog])
                if salmon in turtle.index:
                    alpaca = alpaca.where(np.isfinite(alpaca), turtle.loc[salmon])
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = (tuna - alpaca) / np.abs(alpaca)
    eagle = eagle.replace([np.inf, -np.inf], np.nan)
    koala = get_history_fundamentals(security=tiger, fields=[fox.total_owner_equities], watch_date=cat, count=40, interval='1q', stat_by_year=False)
    dog = _prep_hist(koala, cat)
    if dog is None or dog.empty or 'total_owner_equities' not in dog.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor562')
    dog = dog[dog['q'].isin([lizard, frog])]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor562')
    rabbit = dog.pivot(index='q', columns='code', values='total_owner_equities').reindex(index=[lizard, frog], columns=tiger)
    rabbit = rabbit.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = rabbit.loc[frog] if frog in rabbit.index else pd.Series(np.nan, index=tiger, dtype='float64')
    bear = rabbit.loc[lizard] if lizard in rabbit.index else pd.Series(np.nan, index=tiger, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = (giraffe - bear) / bear
    shark = shark.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        owl = eagle - shark
    sparrow = ~np.isfinite(owl) | ~np.isfinite(eagle) | ~np.isfinite(shark) | (alpaca == 0) | (bear == 0)
    owl = owl.where(~sparrow, np.nan).reindex(tiger)
    whale = {panda: float(owl.get(panda)) if np.isfinite(owl.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(whale, lion, universe=universe, name='factor562')

def factor563(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = get_trade_days(end_date=otter, count=2)
    if len(fox) < 2:
        rabbit = {koala: np.nan for koala in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor563')
    eagle = fox[0]
    hawk = pd.to_datetime(eagle).strftime('%Y-%m-%d')
    bear = otter.strftime('%Y-%m-%d')
    wolf = get_price(universe, start_date=hawk, end_date=bear, frequency='daily', fields=['high', 'low', 'volume'], fq='post', panel=False)
    if wolf is None or wolf.empty:
        rabbit = {koala: np.nan for koala in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor563')
    giraffe = wolf.pivot(index='time', columns='code', values='high').sort_index()
    whale = wolf.pivot(index='time', columns='code', values='low').sort_index()
    sparrow = wolf.pivot(index='time', columns='code', values='volume').sort_index()
    if giraffe.shape[0] < 2:
        rabbit = {koala: np.nan for koala in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor563')
    dog = giraffe.values
    panda = whale.values
    lion = sparrow.values
    rabbit = {}
    for dolphin, koala in enumerate(giraffe.columns):
        zebra = dog[:, dolphin]
        shark = panda[:, dolphin]
        owl = lion[:, dolphin]
        turtle = zebra[-1] - shark[-1]
        tiger = (zebra[-1] - shark[-1] - (zebra[-2] - shark[-2])) / 2.0
        if turtle == 0.0 or np.isnan(turtle) or owl[-1] == 0.0:
            rabbit[koala] = np.nan
        else:
            cat = owl[-1] / turtle
            rabbit[koala] = float(tiger / cat)
    return _make_factor_series(rabbit, date, universe=universe, name='factor563')

def factor564(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    cat = pd.Timestamp(fox)
    panda = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    whale = eagle - 4
    shark = pd.PeriodIndex([whale, eagle], freq='Q-DEC')
    wolf = get_history_fundamentals(security=panda, fields=[bear.term_066, bear.term_060], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or 'code' not in wolf.columns or ('statDate' not in wolf.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, fox, universe=universe, name='factor564')
    otter = wolf.copy()
    otter['code'] = otter['code'].astype(str)
    otter['statDate'] = pd.to_datetime(otter['statDate'], errors='coerce')
    otter = otter.dropna(subset=['code', 'statDate'])
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, fox, universe=universe, name='factor564')
    otter['q'] = otter['statDate'].dt.to_period('Q-DEC')
    otter = otter[otter['q'].isin(shark)]
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, fox, universe=universe, name='factor564')
    otter = otter.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    sparrow = otter.pivot(index='q', columns='code', values='term_066').reindex(index=shark, columns=panda)
    lion = otter.pivot(index='q', columns='code', values='term_060').reindex(index=shark, columns=panda)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
    owl = sparrow.loc[eagle] if eagle in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    koala = lion.loc[eagle] if eagle in lion.index else pd.Series(np.nan, index=panda, dtype='float64')
    hawk = sparrow.loc[whale] if whale in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    tiger = lion.loc[whale] if whale in lion.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = (owl - koala) / owl
        rabbit = (hawk - tiger) / hawk
        dolphin = (giraffe - rabbit) / np.abs(rabbit)
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    zebra = ~np.isfinite(dolphin) | ~np.isfinite(giraffe) | ~np.isfinite(rabbit) | ~np.isfinite(owl) | ~np.isfinite(hawk) | (owl == 0) | (hawk == 0) | (rabbit == 0)
    dolphin = dolphin.where(~zebra, np.nan).reindex(panda)
    bear = {dog: float(dolphin.get(dog)) if np.isfinite(dolphin.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(bear, fox, universe=universe, name='factor564')

def factor565(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    shark = None
    try:
        bear = get_factor_values(universe, factors=['term_053'], end_date=lion, count=1)
        if bear is not None and 'term_053' in bear:
            wolf = bear['term_053']
            if wolf is not None and (not wolf.empty):
                shark = wolf.iloc[-1]
    except Exception:
        shark = None
    if shark is None:
        eagle = pd.Period(lion, freq='Q-DEC')
        sparrow = [eagle - zebra for zebra in range(0, 4)]
        badger = [f'{owl.year}q{owl.quarter}' for owl in sparrow]
        shark = pd.Series(0.0, index=universe, dtype='float64')
        giraffe = pd.Series(False, index=universe)
        for lemur in badger:
            lizard = query(bear.code, bear.term_052).filter(bear.code.in_(universe))
            koala = get_fundamentals(lizard, statDate=lemur)
            if koala is None or koala.empty:
                continue
            koala = koala.set_index('code')
            salmon = koala['term_052'].astype(float).reindex(universe)
            dolphin = ~salmon.isna()
            if dolphin.any():
                shark.loc[dolphin] = shark.loc[dolphin] + salmon.loc[dolphin]
                giraffe.loc[dolphin] = True
        shark.loc[~giraffe] = np.nan
    frog = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(universe))
    fox = get_fundamentals(frog, date=lion)
    if fox is None or fox.empty:
        fox = pd.DataFrame(columns=['code', 'term_008'])
    fox = fox.set_index('code')
    hawk = pd.Period(lion, freq='Q-DEC') - 1
    turtle = hawk.end_time
    otter = get_fundamentals(frog, date=turtle)
    if otter is None or otter.empty:
        otter = pd.DataFrame(columns=['code', 'term_008'])
    otter = otter.set_index('code')
    rabbit = {}
    for tiger in universe:
        whale = float(shark.get(tiger, np.nan))
        panda = float(fox['term_008'].get(tiger, np.nan)) if 'term_008' in fox.columns else np.nan
        dog = float(otter['term_008'].get(tiger, np.nan)) if 'term_008' in otter.columns else np.nan
        if np.isnan(whale) or np.isnan(panda) or panda <= 0.0:
            rabbit[tiger] = np.nan
            continue
        alpaca = panda * 10000.0
        if np.isnan(dog) or dog <= 0.0:
            tuna = alpaca
        else:
            tuna = dog * 10000.0
        cat = (alpaca + tuna) / 2.0
        if cat == 0.0:
            rabbit[tiger] = np.nan
        else:
            rabbit[tiger] = float(whale / cat)
    return _make_factor_series(rabbit, date, universe=universe, name='factor565')

def factor566(universe, date, K_days=20, top_frac=0.2):
    _set_asof_date(date)
    zebra = _to_date(date)
    dolphin = get_trade_days(end_date=zebra, count=K_days + 1)
    if len(dolphin) < K_days + 1:
        sparrow = {bear: np.nan for bear in universe}
        return _make_factor_series(sparrow, date, universe=universe, name='factor566')
    ferret = dolphin[0]
    gecko = pd.to_datetime(ferret).strftime('%Y-%m-%d')
    hawk = pd.to_datetime(dolphin[-1]).strftime('%Y-%m-%d')
    eagle = get_price(universe, start_date=gecko, end_date=hawk, frequency='daily', fields=['close'], fq='post', panel=False)
    if eagle is None or eagle.empty:
        sparrow = {bear: np.nan for bear in universe}
        return _make_factor_series(sparrow, date, universe=universe, name='factor566')
    wolf = eagle.pivot(index='time', columns='code', values='close').sort_index()
    badger = wolf.pct_change().iloc[-K_days:]
    owl = get_money_flow_pro(security_list=universe, start_date=gecko, end_date=hawk, frequency='daily', fields=['inflow_xl', 'outflow_xl', 'inflow_l', 'outflow_l', 'inflow_m', 'outflow_m', 'inflow_s', 'outflow_s'], data_type='money')
    if owl is None or owl.empty:
        sparrow = {bear: np.nan for bear in universe}
        return _make_factor_series(sparrow, date, universe=universe, name='factor566')
    owl = owl.copy()
    if 'time' in owl.columns:
        owl['date'] = pd.to_datetime(owl['time']).dt.date
    elif 'day' in owl.columns:
        owl['date'] = pd.to_datetime(owl['day']).dt.date
    else:
        owl['date'] = pd.to_datetime(owl.index).date
    owl = owl.groupby(['date', 'code'], sort=False)[['inflow_xl', 'outflow_xl', 'inflow_l', 'outflow_l', 'inflow_m', 'outflow_m', 'inflow_s', 'outflow_s']].sum()
    sparrow = {}
    for bear in universe:
        if bear not in badger.columns:
            sparrow[bear] = np.nan
            continue
        alpaca = badger[bear].dropna()
        if alpaca.empty:
            sparrow[bear] = np.nan
            continue
        frog = len(alpaca)
        turtle = max(1, int(frog * float(top_frac)))
        lemur = alpaca.sort_values()
        tiger = lemur.index[:turtle]
        panda = lemur.index[-turtle:]
        dog = {}
        cat = {}
        for giraffe in badger.index:
            lizard = (pd.to_datetime(giraffe).date(), bear)
            if lizard not in owl.index:
                continue
            beaver = owl.loc[lizard]
            otter = float(beaver['inflow_xl'] + beaver['inflow_l'] + beaver['inflow_m'])
            camel = float(beaver['outflow_xl'] + beaver['outflow_l'] + beaver['outflow_m'])
            fox = float(beaver['inflow_s'])
            donkey = float(beaver['outflow_s'])
            whale = otter + camel
            shark = fox + donkey
            koala = (otter - camel) / whale if whale > 0 else np.nan
            lion = (fox - donkey) / shark if shark > 0 else np.nan
            dog[giraffe] = koala
            cat[giraffe] = lion
        if not dog:
            sparrow[bear] = np.nan
            continue
        tuna = np.array([dog.get(rabbit, np.nan) for rabbit in panda], dtype=float)
        salmon = np.array([cat.get(rabbit, np.nan) for rabbit in tiger], dtype=float)
        if np.isnan(tuna).all() or np.isnan(salmon).all():
            sparrow[bear] = np.nan
        else:
            sparrow[bear] = float(np.nanmean(tuna) - np.nanmean(salmon))
    return _make_factor_series(sparrow, date, universe=universe, name='factor566')

def factor567(universe, date, lookback_trading_days=252, index_symbol='000905.XSHG'):
    _set_asof_date(date)
    rabbit = _to_date(date)
    giraffe = get_trade_days(end_date=rabbit, count=lookback_trading_days + 1)
    if len(giraffe) < lookback_trading_days + 1:
        shark = {lion: np.nan for lion in universe}
        return _make_factor_series(shark, date, universe=universe, name='factor567')
    wolf = pd.to_datetime(giraffe[0]).date()
    bear = pd.to_datetime(rabbit).date() + dt.timedelta(days=1)
    turtle = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    dolphin = get_fundamentals(turtle, date=rabbit)
    whale = get_fundamentals(turtle, date=wolf)
    if (dolphin is None or dolphin.empty) or (whale is None or whale.empty):
        shark = {lion: np.nan for lion in universe}
        return _make_factor_series(shark, date, universe=universe, name='factor567')
    dolphin = dolphin.set_index('code')
    whale = whale.set_index('code')
    sparrow = dolphin['term_045'].astype(float) if 'term_045' in dolphin.columns else pd.Series(dtype='float64')
    hawk = whale['term_045'].astype(float) if 'term_045' in whale.columns else pd.Series(dtype='float64')
    zebra = get_price([index_symbol] + list(universe), start_date=pd.to_datetime(wolf).strftime('%Y-%m-%d'), end_date=pd.to_datetime(bear).strftime('%Y-%m-%d'), frequency='daily', fields=['close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        shark = {lion: np.nan for lion in universe}
        return _make_factor_series(shark, date, universe=universe, name='factor567')
    koala = zebra.pivot(index='time', columns='code', values='close').sort_index()
    if index_symbol not in koala.columns:
        shark = {lion: np.nan for lion in universe}
        return _make_factor_series(shark, date, universe=universe, name='factor567')
    tuna = koala[index_symbol].pct_change()
    owl = float(np.nanmean(tuna.values)) if tuna.notna().sum() > 0 else np.nan
    lizard = koala.pct_change()
    if lizard.shape[0] < 5:
        shark = {lion: np.nan for lion in universe}
        return _make_factor_series(shark, date, universe=universe, name='factor567')
    salmon = lizard[index_symbol]
    alpaca = float(np.nanvar(salmon.values, ddof=1)) if salmon.notna().sum() > 2 else np.nan
    shark = {}
    for otter in universe:
        cat = float(sparrow.get(otter, np.nan))
        dog = float(hawk.get(otter, np.nan))
        if not np.isfinite(cat) or not np.isfinite(dog) or cat <= 0.0 or (dog <= 0.0):
            shark[otter] = np.nan
            continue
        eagle = float(np.log(cat / dog))
        if not np.isfinite(owl) or not np.isfinite(alpaca) or alpaca <= 0:
            shark[otter] = np.nan
            continue
        if otter not in lizard.columns:
            shark[otter] = np.nan
            continue
        frog = lizard[otter]
        fox = float(np.nanmean((frog - frog.mean()) * (salmon - salmon.mean()))) if frog.notna().sum() > 2 and salmon.notna().sum() > 2 else np.nan
        panda = fox / alpaca if np.isfinite(fox) and np.isfinite(alpaca) and (alpaca > 0) else np.nan
        if not np.isfinite(panda):
            shark[otter] = np.nan
            continue
        tiger = panda * owl
        shark[otter] = float(eagle - tiger)
    return _make_factor_series(shark, date, universe=universe, name='factor567')

def factor568(universe, date, lookback_trading_days=252):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = get_trade_days(end_date=otter, count=lookback_trading_days + 1)
    if len(fox) < lookback_trading_days + 1:
        giraffe = {panda: np.nan for panda in universe}
        return _make_factor_series(giraffe, date, universe=universe, name='factor568')
    koala = pd.to_datetime(fox[0]).date()
    eagle = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    wolf = get_fundamentals(eagle, date=otter)
    bear = get_fundamentals(eagle, date=koala)
    if (wolf is None or wolf.empty) or (bear is None or bear.empty):
        giraffe = {panda: np.nan for panda in universe}
        return _make_factor_series(giraffe, date, universe=universe, name='factor568')
    wolf = wolf.set_index('code')
    bear = bear.set_index('code')
    shark = wolf['term_045'].astype(float) if 'term_045' in wolf.columns else pd.Series(dtype='float64')
    whale = bear['term_045'].astype(float) if 'term_045' in bear.columns else pd.Series(dtype='float64')
    rabbit = get_price(universe, start_date=pd.to_datetime(koala).strftime('%Y-%m-%d'), end_date=pd.to_datetime(otter).strftime('%Y-%m-%d'), frequency='daily', fields=['close'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        giraffe = {panda: np.nan for panda in universe}
        return _make_factor_series(giraffe, date, universe=universe, name='factor568')
    tiger = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    if tiger.shape[0] < 5:
        giraffe = {panda: np.nan for panda in universe}
        return _make_factor_series(giraffe, date, universe=universe, name='factor568')
    hawk = tiger.pct_change()
    zebra = np.log1p(hawk).sum(axis=0, skipna=True).replace([np.inf, -np.inf], np.nan)
    giraffe = {}
    for lion in universe:
        cat = float(shark.get(lion, np.nan))
        dog = float(whale.get(lion, np.nan))
        dolphin = float(zebra.get(lion, np.nan))
        if not np.isfinite(cat) or not np.isfinite(dog) or cat <= 0.0 or (dog <= 0.0) or (not np.isfinite(dolphin)):
            giraffe[lion] = np.nan
        else:
            giraffe[lion] = float(np.log(cat / dog) - dolphin)
    return _make_factor_series(giraffe, date, universe=universe, name='factor568')

def factor569(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor569')

def factor570(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    sparrow = pd.Period(cat, freq='Q-DEC') - 1
    eagle = sparrow - 4
    hawk = pd.PeriodIndex([eagle, sparrow], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    otter = get_history_fundamentals(security=tiger, fields=[bear.term_066], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    rabbit = _prep_hist(otter)
    if rabbit.empty or 'term_066' not in rabbit.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor570')
    rabbit = rabbit[rabbit['q'].isin(hawk)]
    if rabbit.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor570')
    turtle = rabbit.pivot(index='q', columns='code', values='term_066').reindex(index=hawk, columns=tiger)
    turtle = turtle.apply(pd.to_numeric, errors='coerce').astype(float)
    lizard = turtle.loc[sparrow] if sparrow in turtle.index else pd.Series(np.nan, index=tiger, dtype='float64')
    owl = turtle.loc[eagle] if eagle in turtle.index else pd.Series(np.nan, index=tiger, dtype='float64')
    koala = get_history_fundamentals(security=tiger, fields=[fox.inventories], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    dog = _prep_hist(koala)
    if dog.empty or 'inventories' not in dog.columns:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor570')
    dog = dog[dog['q'].isin(hawk)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor570')
    zebra = dog.pivot(index='q', columns='code', values='inventories').reindex(index=hawk, columns=tiger)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float)
    dolphin = zebra.loc[sparrow] if sparrow in zebra.index else pd.Series(np.nan, index=tiger, dtype='float64')
    giraffe = zebra.loc[eagle] if eagle in zebra.index else pd.Series(np.nan, index=tiger, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = (lizard - owl) / np.abs(owl)
        wolf = (dolphin - giraffe) / np.abs(giraffe)
        shark = bear - wolf
    whale = ~np.isfinite(shark) | ~np.isfinite(lizard) | ~np.isfinite(owl) | ~np.isfinite(dolphin) | ~np.isfinite(giraffe) | (owl == 0) | (giraffe == 0)
    shark = shark.where(~whale, np.nan).reindex(tiger)
    fox = {panda: float(shark.get(panda)) if np.isfinite(shark.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(fox, lion, universe=universe, name='factor570')

def factor571(universe, date, K_months=24, tail_frac=0.1):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=K_months * 21 + 1)
    if len(tiger) < 50:
        otter = {dog: np.nan for dog in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor571')
    zebra = tiger[0]
    dolphin = pd.to_datetime(zebra).strftime('%Y-%m-%d')
    koala = panda.strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=dolphin, end_date=koala, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        otter = {dog: np.nan for dog in universe}
        return _make_factor_series(otter, date, universe=universe, name='factor571')
    cat = lion.pivot(index='time', columns='code', values='close').sort_index()
    rabbit = cat.pct_change().dropna(how='all')
    otter = {}
    for dog in universe:
        if dog not in rabbit.columns:
            otter[dog] = np.nan
            continue
        giraffe = rabbit[dog].dropna()
        if len(giraffe) < 30:
            otter[dog] = np.nan
            continue
        bear = giraffe[giraffe < 0.0]
        if bear.empty:
            otter[dog] = np.nan
            continue
        wolf = max(5, int(len(bear) * tail_frac))
        wolf = min(wolf, len(bear))
        whale = np.sort(bear.values)[:wolf]
        shark = -whale
        shark = np.sort(shark)
        if shark[0] <= 0.0 or np.isnan(shark).any():
            otter[dog] = np.nan
            continue
        eagle = shark[0]
        fox = float(np.mean(np.log(shark / eagle)))
        otter[dog] = fox
    return _make_factor_series(otter, date, universe=universe, name='factor571')

def factor572(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    dolphin = None
    try:
        koala = get_factor_values(universe, factors=['term_065'], end_date=dog, count=1)
        if koala is not None and 'term_065' in koala:
            tiger = koala['term_065']
            if tiger is not None and (not tiger.empty):
                dolphin = tiger.iloc[-1]
    except Exception:
        dolphin = None
    if dolphin is None:
        whale = pd.Period(dog, freq='Q-DEC')
        shark = [whale - rabbit for rabbit in range(0, 4)]
        frog = [f'{eagle.year}q{eagle.quarter}' for eagle in shark]
        dolphin = pd.Series(0.0, index=universe, dtype='float64')
        wolf = pd.Series(False, index=universe)
        for lizard in frog:
            hawk = query(bear.code, bear.term_063).filter(bear.code.in_(universe))
            panda = get_fundamentals(hawk, statDate=lizard)
            if panda is None or panda.empty:
                continue
            panda = panda.set_index('code')
            turtle = panda['term_063'].astype(float).reindex(universe)
            giraffe = ~turtle.isna()
            if giraffe.any():
                dolphin.loc[giraffe] = dolphin.loc[giraffe] + turtle.loc[giraffe]
                wolf.loc[giraffe] = True
        dolphin.loc[~wolf] = np.nan
    sparrow = None
    try:
        otter = get_factor_values(universe, factors=['term_068'], end_date=dog, count=1)
        if otter is not None and 'term_068' in otter:
            lion = otter['term_068']
            if lion is not None and (not lion.empty):
                sparrow = lion.iloc[-1]
    except Exception:
        sparrow = None
    if sparrow is None:
        whale = pd.Period(dog, freq='Q-DEC')
        shark = [whale - rabbit for rabbit in range(0, 4)]
        frog = [f'{eagle.year}q{eagle.quarter}' for eagle in shark]
        sparrow = pd.Series(0.0, index=universe, dtype='float64')
        bear = pd.Series(False, index=universe)
        for lizard in frog:
            hawk = query(bear.code, bear.term_066).filter(bear.code.in_(universe))
            panda = get_fundamentals(hawk, statDate=lizard)
            if panda is None or panda.empty:
                continue
            panda = panda.set_index('code')
            turtle = panda['term_066'].astype(float).reindex(universe)
            giraffe = ~turtle.isna()
            if giraffe.any():
                sparrow.loc[giraffe] = sparrow.loc[giraffe] + turtle.loc[giraffe]
                bear.loc[giraffe] = True
        sparrow.loc[~bear] = np.nan
    fox = {}
    for cat in universe:
        zebra = float(dolphin.get(cat, np.nan))
        owl = float(sparrow.get(cat, np.nan))
        if np.isnan(zebra) or np.isnan(owl) or owl == 0.0:
            salmon = np.nan
        else:
            salmon = zebra / owl
        fox[cat] = salmon
    return _make_factor_series(fox, date, universe=universe, name='factor572')

def factor573(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor573')

def factor574(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor574')

def factor575(universe, date, N=12, M=6):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = get_trade_days(end_date=koala, count=N + M + 2)
    if len(otter) < N + M + 2:
        bear = {lion: np.nan for lion in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor575')
    zebra = otter[0]
    dolphin = pd.to_datetime(zebra).strftime('%Y-%m-%d')
    wolf = koala.strftime('%Y-%m-%d')
    fox = get_price(universe, start_date=dolphin, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        bear = {lion: np.nan for lion in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor575')
    tiger = fox.pivot(index='time', columns='code', values='close').sort_index()
    bear = {}
    for lion in universe:
        if lion not in tiger.columns:
            bear[lion] = np.nan
            continue
        giraffe = tiger[lion].dropna()
        if len(giraffe) < N + M + 1:
            bear[lion] = np.nan
            continue
        giraffe = giraffe.iloc[-(N + M + 1):]
        cat = []
        for whale in range(N, len(giraffe)):
            panda = giraffe.iloc[whale]
            dog = giraffe.iloc[whale - N]
            if dog == 0.0 or np.isnan(dog):
                cat.append(np.nan)
            else:
                cat.append((panda - dog) / dog)
        cat = np.array(cat, dtype=float)
        if len(cat) < M:
            bear[lion] = np.nan
            continue
        rabbit = cat[-M:]
        if np.isnan(rabbit).all():
            bear[lion] = np.nan
        else:
            bear[lion] = float(np.nanmean(rabbit))
    return _make_factor_series(bear, date, universe=universe, name='factor575')

def factor576(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    giraffe = pd.Period(cat, freq='Q-DEC') - 1
    rabbit = giraffe - 4
    fox = pd.PeriodIndex([rabbit, giraffe], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[bear.term_035], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor576')
    koala = koala.copy()
    if 'pubDate' in koala.columns:
        bear = pd.to_datetime(koala['pubDate'], errors='coerce')
        koala = koala[bear.notna() & (bear <= cat)]
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty or 'term_035' not in koala.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor576')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(fox)]
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor576')
    dolphin = koala.pivot(index='q', columns='code', values='term_035').reindex(index=fox, columns=panda)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = dolphin.loc[giraffe]
    zebra = dolphin.loc[rabbit]
    lion = zebra.abs()
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf = (whale - zebra) / lion
    wolf = wolf.replace([np.inf, -np.inf], np.nan)
    wolf = wolf.where(np.isfinite(lion) & (lion > 0), np.nan)
    otter = {dog: float(wolf.get(dog, np.nan)) if np.isfinite(wolf.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(otter, tiger, universe=universe, name='factor576')

def factor577(universe, date, K_months=6):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=K_months * 21)
    if len(tiger) == 0:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor577')
    giraffe = tiger[0]
    zebra = pd.to_datetime(giraffe).strftime('%Y-%m-%d')
    otter = pd.to_datetime(tiger[-1]).strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=zebra, end_date=otter, frequency='daily', fields=['volume'], fq='post', panel=False)
    if lion is None or lion.empty:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor577')
    whale = lion.pivot(index='time', columns='code', values='volume').sort_index()
    bear = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(universe))
    koala = get_fundamentals(bear, date=panda)
    if koala is None or koala.empty:
        koala = pd.DataFrame(columns=['code', 'circulating_cap'])
    koala = koala.set_index('code')
    fox = {}
    for dog in universe:
        if dog not in whale.columns:
            fox[dog] = np.nan
            continue
        cat = float(koala['circulating_cap'].get(dog, np.nan)) if 'circulating_cap' in koala.columns else np.nan
        if np.isnan(cat) or cat <= 0.0:
            fox[dog] = np.nan
            continue
        dolphin = whale[dog] / (cat * 10000.0)
        dolphin = dolphin.replace([np.inf, -np.inf], np.nan).dropna()
        if len(dolphin) < 5:
            fox[dog] = np.nan
            continue
        wolf = float(dolphin.mean())
        rabbit = float(dolphin.std(ddof=1))
        if wolf == 0.0 or np.isnan(wolf):
            fox[dog] = np.nan
        else:
            fox[dog] = rabbit / wolf
    return _make_factor_series(fox, date, universe=universe, name='factor577')

def factor578(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    tiger = list(universe)
    salmon = pd.Period(cat, freq='Q-DEC') - 1
    tuna = salmon - 1
    lizard = pd.PeriodIndex([salmon, salmon - 1, salmon - 2, salmon - 3, salmon - 4], freq='Q-DEC')
    frog = pd.PeriodIndex([salmon, tuna], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    otter = get_history_fundamentals(security=tiger, fields=[bear.term_090, bear.term_021, bear.term_035], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    shark = _prep_hist(otter)
    if shark.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor578')
    shark = shark[shark['q'].isin(lizard)]
    if shark.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor578')
    hyena = shark.pivot(index='q', columns='code', values='term_090').reindex(index=lizard, columns=tiger)
    giraffe = shark.pivot(index='q', columns='code', values='term_021').reindex(index=lizard, columns=tiger)
    beaver = shark.pivot(index='q', columns='code', values='term_035').reindex(index=lizard, columns=tiger)
    hyena = hyena.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    beaver = beaver.apply(pd.to_numeric, errors='coerce').astype(float)
    fox = hyena + giraffe + beaver
    bear = fox.reindex(index=[salmon, salmon - 1, salmon - 2, salmon - 3]).sum(axis=0, min_count=1)
    wolf = fox.reindex(index=[salmon - 1, salmon - 2, salmon - 3, salmon - 4]).sum(axis=0, min_count=1)
    koala = get_history_fundamentals(security=tiger, fields=[fox.term_081, fox.term_036, fox.good_will], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    dog = _prep_hist(koala)
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor578')
    dog = dog[dog['q'].isin(frog)]
    if dog.empty:
        return _make_factor_series({panda: np.nan for panda in tiger}, lion, universe=universe, name='factor578')
    alpaca = dog.pivot(index='q', columns='code', values='term_081').reindex(index=frog, columns=tiger)
    eagle = dog.pivot(index='q', columns='code', values='term_036').reindex(index=frog, columns=tiger)
    zebra = dog.pivot(index='q', columns='code', values='good_will').reindex(index=frog, columns=tiger)
    alpaca = alpaca.apply(pd.to_numeric, errors='coerce').astype(float)
    eagle = eagle.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float)
    badger = alpaca.loc[salmon] if salmon in alpaca.index else pd.Series(np.nan, index=tiger, dtype='float64')
    sparrow = eagle.loc[salmon] if salmon in eagle.index else pd.Series(np.nan, index=tiger, dtype='float64')
    whale = zebra.loc[salmon] if salmon in zebra.index else pd.Series(np.nan, index=tiger, dtype='float64')
    lemur = alpaca.loc[tuna] if tuna in alpaca.index else pd.Series(np.nan, index=tiger, dtype='float64')
    hawk = eagle.loc[tuna] if tuna in eagle.index else pd.Series(np.nan, index=tiger, dtype='float64')
    dolphin = zebra.loc[tuna] if tuna in zebra.index else pd.Series(np.nan, index=tiger, dtype='float64')
    donkey = badger - sparrow - whale
    camel = lemur - hawk - dolphin
    with np.errstate(divide='ignore', invalid='ignore'):
        gecko = bear / donkey
        ferret = wolf / camel
        turtle = (gecko - ferret) / np.abs(ferret)
    owl = ~np.isfinite(turtle) | ~np.isfinite(bear) | ~np.isfinite(wolf) | ~np.isfinite(donkey) | ~np.isfinite(camel) | (donkey == 0) | (camel == 0) | (donkey <= 0) | (camel <= 0) | ~np.isfinite(ferret) | (ferret == 0)
    turtle = turtle.where(~owl, np.nan).reindex(tiger)
    rabbit = {panda: float(turtle.get(panda)) if np.isfinite(turtle.get(panda, np.nan)) else np.nan for panda in tiger}
    return _make_factor_series(rabbit, lion, universe=universe, name='factor578')

def factor579(universe, date):
    _set_asof_date(date)
    bear = _to_date(date)
    hawk = pd.Period(bear, freq='Q-DEC')
    owl = [hawk - shark for shark in range(0, 4)]
    badger = [f'{turtle.year}q{turtle.quarter}' for turtle in owl]
    dog = pd.Series(0.0, index=universe, dtype='float64')
    whale = pd.Series(False, index=universe)
    for lemur in badger:
        frog = query(rabbit.code, rabbit.term_003).filter(rabbit.code.in_(universe))
        zebra = get_fundamentals(frog, statDate=lemur)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.set_index('code')
        panda = zebra['term_003'].astype(float).reindex(universe)
        eagle = ~panda.isna()
        if eagle.any():
            dog.loc[eagle] = dog.loc[eagle] + panda.loc[eagle]
            whale.loc[eagle] = True
    dog.loc[~whale] = np.nan
    salmon = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(universe))
    giraffe = get_fundamentals(salmon, date=bear)
    if giraffe is None or giraffe.empty:
        giraffe = pd.DataFrame(columns=['code', 'term_008'])
    giraffe = giraffe.set_index('code')
    fox = giraffe['term_008'].astype(float) if 'term_008' in giraffe.columns else pd.Series(np.nan, index=universe)
    sparrow = hawk - 1
    lizard = sparrow.end_time
    rabbit = get_fundamentals(salmon, date=lizard)
    if rabbit is None or rabbit.empty:
        rabbit = pd.DataFrame(columns=['code', 'term_008'])
    rabbit = rabbit.set_index('code')
    koala = rabbit['term_008'].astype(float) if 'term_008' in rabbit.columns else pd.Series(np.nan, index=universe)
    dolphin = {}
    for wolf in universe:
        cat = float(dog.get(wolf, np.nan))
        lion = float(fox.get(wolf, np.nan))
        if np.isnan(cat) or np.isnan(lion) or lion <= 0.0:
            dolphin[wolf] = np.nan
            continue
        alpaca = lion * 10000.0
        otter = float(koala.get(wolf, np.nan))
        if np.isnan(otter) or otter <= 0.0:
            tuna = alpaca
        else:
            tuna = otter * 10000.0
        tiger = (alpaca + tuna) / 2.0
        if tiger == 0.0:
            dolphin[wolf] = np.nan
        else:
            dolphin[wolf] = float(cat / tiger)
    return _make_factor_series(dolphin, date, universe=universe, name='factor579')

def factor580(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor580')

def factor581(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor581')

def factor582(universe, date, N=20):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = get_trade_days(end_date=koala, count=N)
    if len(otter) < N:
        rabbit = {lion: np.nan for lion in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor582')
    dolphin = otter[0]
    whale = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    bear = koala.strftime('%Y-%m-%d')
    fox = get_price(universe, start_date=whale, end_date=bear, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if fox is None or fox.empty:
        rabbit = {lion: np.nan for lion in universe}
        return _make_factor_series(rabbit, date, universe=universe, name='factor582')
    zebra = fox.pivot(index='time', columns='code', values='open').sort_index().iloc[-N:]
    tiger = fox.pivot(index='time', columns='code', values='close').sort_index().iloc[-N:]
    rabbit = {}
    for lion in universe:
        if lion not in zebra.columns:
            rabbit[lion] = np.nan
            continue
        giraffe = zebra[lion].values
        panda = tiger[lion].values
        shark = np.maximum(panda - giraffe, 0.0)
        wolf = np.maximum(giraffe - panda, 0.0)
        dog = shark.sum()
        cat = wolf.sum()
        if dog + cat == 0.0:
            eagle = 100.0
        else:
            eagle = float(100.0 * dog / (dog + cat))
        rabbit[lion] = eagle
    return _make_factor_series(rabbit, date, universe=universe, name='factor582')

def factor583(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor583')

def factor584(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    panda = pd.Timestamp(wolf)
    fox = list(universe)
    salmon = pd.Period(panda, freq='Q-DEC') - 1
    tuna = pd.PeriodIndex([salmon, salmon - 1, salmon - 2, salmon - 3], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    zebra = pd.Series(np.nan, index=fox, dtype='float64')
    camel = _nearest_td_le(wolf)
    if camel is not None:
        try:
            shark = get_factor_values(fox, factors=['ebit_ttm'], end_date=camel, count=1)
            bear = shark.get('ebit_ttm', None) if isinstance(shark, dict) else None
            if isinstance(bear, pd.DataFrame) and (not bear.empty):
                alpaca = bear.iloc[-1]
                alpaca.index = alpaca.index.astype(str)
                lemur = pd.to_numeric(alpaca, errors='coerce').astype(float).reindex(fox)
                if lemur.notna().sum() >= 10:
                    zebra = lemur
        except Exception:
            pass
    if zebra.notna().sum() < 10:
        giraffe = get_history_fundamentals(security=fox, fields=[bear.term_063, bear.term_021], watch_date=panda, count=12, interval='1q', stat_by_year=False)
        owl = _prep_hist(giraffe)
        if not owl.empty:
            owl = owl[owl['q'].isin(tuna)]
            if not owl.empty:
                lizard = owl.pivot(index='q', columns='code', values='term_063').reindex(index=tuna, columns=fox)
                sparrow = owl.pivot(index='q', columns='code', values='term_021').reindex(index=tuna, columns=fox)
                lizard = lizard.apply(pd.to_numeric, errors='coerce').astype(float)
                sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
                hawk = (lizard + sparrow).sum(axis=0, min_count=1).reindex(fox)
                zebra = zebra.where(np.isfinite(zebra), hawk)
    rabbit = get_history_fundamentals(security=fox, fields=[fox.term_082, fox.term_083, fox.term_025], watch_date=panda, count=20, interval='1q', stat_by_year=False)
    tiger = _prep_hist(rabbit)
    if tiger.empty:
        return _make_factor_series({lion: np.nan for lion in fox}, wolf, universe=universe, name='factor584')
    tiger = tiger[tiger['q'].isin([salmon])]
    if tiger.empty:
        return _make_factor_series({lion: np.nan for lion in fox}, wolf, universe=universe, name='factor584')
    badger = tiger.pivot(index='q', columns='code', values='term_082').reindex(index=[salmon], columns=fox).apply(pd.to_numeric, errors='coerce').astype(float)
    beaver = tiger.pivot(index='q', columns='code', values='term_083').reindex(index=[salmon], columns=fox).apply(pd.to_numeric, errors='coerce').astype(float)
    whale = tiger.pivot(index='q', columns='code', values='term_025').reindex(index=[salmon], columns=fox).apply(pd.to_numeric, errors='coerce').astype(float)
    koala = badger.loc[salmon] if salmon in badger.index else pd.Series(np.nan, index=fox, dtype='float64')
    otter = beaver.loc[salmon] if salmon in beaver.index else pd.Series(np.nan, index=fox, dtype='float64')
    dolphin = whale.loc[salmon] if salmon in whale.index else pd.Series(np.nan, index=fox, dtype='float64')
    cat = koala - otter
    dog = cat + dolphin
    dog = dog.where(np.isfinite(dog) & (dog != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        frog = zebra / dog
    turtle = ~np.isfinite(frog) | ~np.isfinite(zebra) | ~np.isfinite(dog) | (dog == 0)
    frog = frog.where(~turtle, np.nan).reindex(fox)
    eagle = {lion: float(frog.get(lion)) if np.isfinite(frog.get(lion, np.nan)) else np.nan for lion in fox}
    return _make_factor_series(eagle, wolf, universe=universe, name='factor584')

def factor585(universe, date, T=20):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = get_trade_days(end_date=bear, count=T + 20)
    if len(rabbit) < T + 20:
        shark = {fox: np.nan for fox in universe}
        return _make_factor_series(shark, date, universe=universe, name='factor585')
    giraffe = rabbit[-(T + 1):]
    salmon = giraffe[0]
    tuna = pd.to_datetime(salmon).strftime('%Y-%m-%d')
    dolphin = pd.to_datetime(giraffe[-1]).strftime('%Y-%m-%d')
    zebra = get_price(universe, start_date=tuna, end_date=dolphin, frequency='daily', fields=['close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        shark = {fox: np.nan for fox in universe}
        return _make_factor_series(shark, date, universe=universe, name='factor585')
    otter = zebra.pivot(index='time', columns='code', values='close').sort_index()
    lizard = otter.pct_change().iloc[-T:]
    eagle = get_money_flow_pro(security_list=universe, start_date=tuna, end_date=dolphin, frequency='daily', fields=['inflow_s', 'outflow_s'], data_type='money')
    if eagle is None or eagle.empty:
        shark = {fox: np.nan for fox in universe}
        return _make_factor_series(shark, date, universe=universe, name='factor585')
    eagle = eagle.copy()
    if 'time' in eagle.columns:
        eagle['date'] = pd.to_datetime(eagle['time']).dt.date
    elif 'day' in eagle.columns:
        eagle['date'] = pd.to_datetime(eagle['day']).dt.date
    else:
        eagle['date'] = pd.to_datetime(eagle.index).date
    eagle = eagle.groupby(['date', 'code'], sort=False)[['inflow_s', 'outflow_s']].sum()
    shark = {}
    for fox in universe:
        if fox not in lizard.columns:
            shark[fox] = np.nan
            continue
        turtle = []
        cat = []
        for wolf in lizard.index:
            turtle.append(lizard.at[wolf, fox])
            hawk = (pd.to_datetime(wolf).date(), fox)
            if hawk not in eagle.index:
                cat.append(np.nan)
                continue
            frog = eagle.loc[hawk]
            cat.append(float(frog['inflow_s'] - frog['outflow_s']))
        turtle = np.array(turtle, dtype=float)
        cat = np.array(cat, dtype=float)
        sparrow = ~(np.isnan(turtle) | np.isnan(cat))
        if sparrow.sum() < 5:
            shark[fox] = np.nan
            continue
        owl = float(np.abs(cat[sparrow]).sum())
        if owl == 0.0 or not np.isfinite(owl):
            shark[fox] = np.nan
            continue
        dog = cat[sparrow] / owl
        tiger = turtle[sparrow]
        panda = np.column_stack([np.ones(len(tiger)), dog])
        try:
            koala, lion, lion, lion = np.linalg.lstsq(panda, tiger, rcond=None)
            whale = tiger - panda @ koala
            shark[fox] = float(whale[-1]) if whale.size > 0 else np.nan
        except Exception:
            shark[fox] = np.nan
    return _make_factor_series(shark, date, universe=universe, name='factor585')

def factor586(universe, date, K_months=6, top_n=1):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_trade_days(end_date=panda, count=K_months * 21 + 1)
    if len(tiger) < 2:
        koala = {dog: np.nan for dog in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor586')
    wolf = tiger[0]
    bear = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=bear, end_date=panda, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        koala = {dog: np.nan for dog in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor586')
    cat = lion.pivot(index='time', columns='code', values='close').sort_index()
    otter = cat.pct_change().dropna(how='all')
    koala = {}
    for dog in universe:
        if dog not in otter.columns:
            koala[dog] = np.nan
            continue
        fox = otter[dog].dropna()
        if fox.empty:
            koala[dog] = np.nan
            continue
        if top_n <= 1:
            koala[dog] = float(fox.max())
        else:
            rabbit = np.sort(fox.values)[-top_n:]
            koala[dog] = float(rabbit.mean())
    return _make_factor_series(koala, date, universe=universe, name='factor586')

def factor587(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    sparrow = None
    try:
        koala = get_factor_values(universe, factors=['term_068'], end_date=dog, count=1)
        if koala is not None and 'term_068' in koala:
            lion = koala['term_068']
            if lion is not None and (not lion.empty):
                sparrow = lion.iloc[-1]
    except Exception:
        sparrow = None
    if sparrow is None:
        zebra = pd.Period(dog, freq='Q-DEC')
        dolphin = [zebra - wolf for wolf in range(0, 4)]
        lizard = [f'{whale.year}q{whale.quarter}' for whale in dolphin]
        sparrow = pd.Series(0.0, index=universe, dtype='float64')
        fox = pd.Series(False, index=universe)
        for turtle in lizard:
            shark = query(bear.code, bear.term_066).filter(bear.code.in_(universe))
            panda = get_fundamentals(shark, statDate=turtle)
            if panda is None or panda.empty:
                continue
            panda = panda.set_index('code')
            owl = panda['term_066'].astype(float).reindex(universe)
            rabbit = ~owl.isna()
            if rabbit.any():
                sparrow.loc[rabbit] = sparrow.loc[rabbit] + owl.loc[rabbit]
                fox.loc[rabbit] = True
        sparrow.loc[~fox] = np.nan
    eagle = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    tiger = get_fundamentals(eagle, date=dog)
    if tiger is None or tiger.empty:
        tiger = pd.DataFrame(columns=['code', 'term_045'])
    tiger = tiger.set_index('code')
    giraffe = tiger['term_045'].astype(float) if 'term_045' in tiger.columns else pd.Series(np.nan, index=universe)
    otter = {}
    for cat in universe:
        hawk = float(sparrow.get(cat, np.nan))
        bear = float(giraffe.get(cat, np.nan))
        if np.isnan(hawk) or np.isnan(bear) or bear <= 0.0:
            frog = np.nan
        else:
            frog = hawk / bear
        otter[cat] = frog
    return _make_factor_series(otter, date, universe=universe, name='factor587')

def factor588(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor588')

def factor589(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    fox = _to_date(date)
    koala = None
    try:
        giraffe = get_factor_values(universe, factors=['term_061'], end_date=fox, count=1)
        if giraffe is not None and 'term_061' in giraffe and (giraffe['term_061'] is not None) and (not giraffe['term_061'].empty):
            koala = giraffe['term_061'].iloc[-1].reindex(universe).astype(float)
    except Exception:
        koala = None
    if koala is None:
        bear = get_history_fundamentals(security=universe, fields=[bear.term_060], watch_date=fox, count=4, interval='1q', stat_by_year=False)
        if bear is None or bear.empty:
            zebra = {tiger: np.nan for tiger in universe}
            return _make_factor_series(zebra, date, universe=universe, name='factor589')
        bear = bear.copy()
        bear['statDate'] = pd.to_datetime(bear['statDate'])
        bear = bear.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        dolphin = int(min_valid_quarters)
        koala = pd.Series(np.nan, index=universe, dtype='float64')
        for lion in universe:
            rabbit = bear[bear['code'] == lion]
            whale = rabbit['term_060'].astype(float).to_numpy()[-4:]
            if np.isfinite(whale).sum() < dolphin:
                continue
            koala.loc[lion] = float(np.nansum(whale))
    wolf = get_history_fundamentals(security=universe, fields=[fox.term_002, fox.term_056], watch_date=fox, count=2, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty:
        zebra = {tiger: np.nan for tiger in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor589')
    wolf = wolf.copy()
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    wolf = wolf.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    zebra = {}
    for lion in universe:
        rabbit = wolf[wolf['code'] == lion].tail(2)
        if rabbit.shape[0] < 2:
            zebra[lion] = np.nan
            continue

        def _ap(row):
            cat = float(row.get('term_002', np.nan))
            dog = float(row.get('term_056', np.nan))
            panda = False
            tiger = 0.0
            if np.isfinite(cat):
                tiger += cat
                panda = True
            if np.isfinite(dog):
                tiger += dog
                panda = True
            return tiger if panda else np.nan
        cat = _ap(rabbit.iloc[0])
        dog = _ap(rabbit.iloc[1])
        panda = (cat + dog) / 2.0 if np.isfinite(cat) and np.isfinite(dog) else np.nan
        otter = float(koala.get(lion, np.nan))
        if not np.isfinite(otter) or not np.isfinite(panda) or panda == 0.0:
            zebra[lion] = np.nan
        else:
            zebra[lion] = float(otter / panda)
    return _make_factor_series(zebra, date, universe=universe, name='factor589')

def factor590(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    cat = pd.Timestamp(tiger)
    panda = list(universe)
    rabbit = pd.Period(cat, freq='Q-DEC') - 1
    bear = rabbit - 4
    otter = pd.PeriodIndex([bear, rabbit], freq='Q-DEC')
    lion = get_history_fundamentals(security=panda, fields=[fox.term_084], watch_date=cat, count=16, interval='1q', stat_by_year=False)
    if lion is None or lion.empty or 'code' not in lion.columns or ('statDate' not in lion.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor590')
    lion = lion.copy()
    if 'pubDate' in lion.columns:
        wolf = pd.to_datetime(lion['pubDate'], errors='coerce')
        lion = lion[wolf.notna() & (wolf <= cat)]
    lion['code'] = lion['code'].astype(str)
    lion['statDate'] = pd.to_datetime(lion['statDate'], errors='coerce')
    lion = lion.dropna(subset=['code', 'statDate'])
    if lion.empty or 'term_084' not in lion.columns:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor590')
    lion['q'] = lion['statDate'].dt.to_period('Q-DEC')
    lion = lion[lion['q'].isin(otter)]
    lion = lion.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    if lion.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, tiger, universe=universe, name='factor590')
    zebra = lion.pivot(index='q', columns='code', values='term_084').reindex(index=otter, columns=panda)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float)
    dolphin = zebra.loc[rabbit]
    giraffe = zebra.loc[bear]
    with np.errstate(divide='ignore', invalid='ignore'):
        fox = np.log(dolphin / giraffe)
    fox = fox.replace([np.inf, -np.inf], np.nan)
    fox = fox.where(np.isfinite(dolphin) & (dolphin > 0) & np.isfinite(giraffe) & (giraffe > 0), np.nan)
    koala = {dog: float(fox.get(dog, np.nan)) if np.isfinite(fox.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(koala, tiger, universe=universe, name='factor590')

def factor591(universe, date, months_window=25, lookback_days=900):
    _set_asof_date(date)
    rabbit = _to_date(date)
    giraffe = get_trade_days(end_date=rabbit, count=int(lookback_days))
    if len(giraffe) < 120:
        shark = {otter: np.nan for otter in universe}
        return _make_factor_series(shark, date, universe=universe, name='factor591')
    tuna = pd.to_datetime(giraffe[0]).strftime('%Y-%m-%d')
    whale = pd.to_datetime(rabbit).strftime('%Y-%m-%d')
    zebra = get_price(universe, start_date=tuna, end_date=whale, frequency='daily', fields=['close', 'money'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        shark = {otter: np.nan for otter in universe}
        return _make_factor_series(shark, date, universe=universe, name='factor591')
    fox = zebra.pivot(index='time', columns='code', values='close').sort_index().astype(float)
    turtle = zebra.pivot(index='time', columns='code', values='money').sort_index().astype(float)
    frog = fox.pct_change()
    alpaca = (frog.abs() / turtle.where(turtle > 0.0)).replace([np.inf, -np.inf], np.nan)
    owl = pd.to_datetime(alpaca.index).to_period('M')
    hawk = alpaca.groupby(owl).mean()
    bear = pd.to_datetime(rabbit).to_period('M')
    lizard = pd.period_range(end=bear, periods=int(months_window), freq='M')
    eagle = hawk.reindex(lizard)
    shark = {}
    for wolf in universe:
        salmon = eagle[wolf].astype(float)
        beaver = salmon.to_numpy()
        if beaver.size < 6:
            shark[wolf] = np.nan
            continue
        lemur = beaver[:-1]
        donkey = beaver[1:]
        sparrow = np.isfinite(lemur) & np.isfinite(donkey)
        if sparrow.sum() < 5:
            shark[wolf] = np.nan
            continue
        cat = np.column_stack([np.ones(sparrow.sum()), lemur[sparrow]])
        dog = donkey[sparrow]
        try:
            koala, panda, panda, panda = np.linalg.lstsq(cat, dog, rcond=None)
            tiger, lion = (float(koala[0]), float(koala[1]))
        except Exception:
            shark[wolf] = np.nan
            continue
        camel = beaver[-1]
        badger = beaver[-2]
        if not np.isfinite(camel) or not np.isfinite(badger):
            shark[wolf] = np.nan
            continue
        dolphin = float(camel - (tiger + lion * badger))
        shark[wolf] = dolphin if np.isfinite(dolphin) else np.nan
    return _make_factor_series(shark, date, universe=universe, name='factor591')

def factor592(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = get_history_fundamentals(security=universe, fields=[bear.term_076, bear.term_004, bear.term_066], watch_date=lion, count=4, interval='1q', stat_by_year=False)
    if koala is None or koala.empty:
        fox = {panda: np.nan for panda in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor592')
    koala = koala.copy()
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    koala = koala.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    wolf = int(min_valid_quarters)
    fox = {}
    for tiger in universe:
        otter = koala[koala['code'] == tiger]
        if otter.empty:
            fox[tiger] = np.nan
            continue
        zebra = otter['term_076'].astype(float).to_numpy()[-4:]
        cat = otter['term_004'].astype(float).to_numpy()[-4:]
        bear = otter['term_066'].astype(float).to_numpy()[-4:]
        rabbit = np.isfinite(bear)
        if rabbit.sum() < wolf:
            fox[tiger] = np.nan
            continue
        zebra = np.where(np.isfinite(zebra), zebra, 0.0)
        cat = np.where(np.isfinite(cat), cat, 0.0)
        dolphin = float(np.nansum(zebra[rabbit]))
        dog = float(np.nansum(cat[rabbit]))
        giraffe = float(np.nansum(bear[rabbit]))
        if not np.isfinite(giraffe) or giraffe == 0.0:
            fox[tiger] = np.nan
        else:
            fox[tiger] = float((dolphin + dog) / giraffe)
    return _make_factor_series(fox, date, universe=universe, name='factor592')

def factor593(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor593')

def factor594(universe, date, N1=12, N2=26, M=9):
    _set_asof_date(date)
    dog = _to_date(date)
    whale = N2 + M + 10
    panda = get_trade_days(end_date=dog, count=whale)
    if len(panda) < N2 + M + 2:
        fox = {cat: np.nan for cat in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor594')
    giraffe = panda[0]
    zebra = pd.to_datetime(giraffe).strftime('%Y-%m-%d')
    otter = dog.strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=zebra, end_date=otter, frequency='daily', fields=['volume'], fq='post', panel=False)
    if lion is None or lion.empty:
        fox = {cat: np.nan for cat in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor594')
    dolphin = lion.pivot(index='time', columns='code', values='volume').sort_index()
    fox = {}
    for cat in universe:
        if cat not in dolphin.columns:
            fox[cat] = np.nan
            continue
        bear = dolphin[cat].dropna().values
        if len(bear) < N2 + M + 2:
            fox[cat] = np.nan
            continue
        rabbit = _ema_array(bear, N1)
        wolf = _ema_array(bear, N2)
        koala = rabbit - wolf
        tiger = _ema_array(koala, M)
        fox[cat] = float(koala[-1] - tiger[-1])
    return _make_factor_series(fox, date, universe=universe, name='factor594')

def factor595(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor595')

def factor596(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    cat = pd.Timestamp(fox)
    panda = list(universe)
    eagle = pd.Period(cat, freq='Q-DEC') - 1
    whale = eagle - 4
    shark = pd.PeriodIndex([whale, eagle], freq='Q-DEC')
    wolf = get_history_fundamentals(security=panda, fields=[bear.term_060, bear.term_066], watch_date=cat, count=24, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or 'code' not in wolf.columns or ('statDate' not in wolf.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, fox, universe=universe, name='factor596')
    otter = wolf.copy()
    otter['code'] = otter['code'].astype(str)
    otter['statDate'] = pd.to_datetime(otter['statDate'], errors='coerce')
    otter = otter.dropna(subset=['code', 'statDate'])
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, fox, universe=universe, name='factor596')
    otter['q'] = otter['statDate'].dt.to_period('Q-DEC')
    otter = otter[otter['q'].isin(shark)]
    if otter.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, fox, universe=universe, name='factor596')
    otter = otter.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    tiger = otter.pivot(index='q', columns='code', values='term_060').reindex(index=shark, columns=panda)
    sparrow = otter.pivot(index='q', columns='code', values='term_066').reindex(index=shark, columns=panda)
    tiger = tiger.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = tiger.loc[eagle] if eagle in tiger.index else pd.Series(np.nan, index=panda, dtype='float64')
    owl = sparrow.loc[eagle] if eagle in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    giraffe = tiger.loc[whale] if whale in tiger.index else pd.Series(np.nan, index=panda, dtype='float64')
    hawk = sparrow.loc[whale] if whale in sparrow.index else pd.Series(np.nan, index=panda, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        koala = zebra / owl
        lion = giraffe / hawk
        dolphin = (koala - lion) / np.abs(lion)
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    rabbit = ~np.isfinite(dolphin) | ~np.isfinite(koala) | ~np.isfinite(lion) | ~np.isfinite(owl) | ~np.isfinite(hawk) | (owl == 0) | (hawk == 0) | (lion == 0)
    dolphin = dolphin.where(~rabbit, np.nan).reindex(panda)
    bear = {dog: float(dolphin.get(dog)) if np.isfinite(dolphin.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(bear, fox, universe=universe, name='factor596')

def factor597(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor597')

def factor598(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor598')

def factor599(universe, date, n=60, use_log=True):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = get_trade_days(end_date=koala, count=n)
    if len(otter) < n:
        bear = {lion: np.nan for lion in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor599')
    zebra = otter[0]
    dolphin = pd.to_datetime(zebra).strftime('%Y-%m-%d')
    wolf = koala.strftime('%Y-%m-%d')
    fox = get_price(universe, start_date=dolphin, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        bear = {lion: np.nan for lion in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor599')
    tiger = fox.pivot(index='time', columns='code', values='close').sort_index().iloc[-n:]
    whale = np.arange(1, n + 1, dtype=float)
    cat = np.column_stack([np.ones(n), whale, whale ** 2])
    bear = {}
    for lion in universe:
        if lion not in tiger.columns:
            bear[lion] = np.nan
            continue
        giraffe = tiger[lion].dropna()
        if len(giraffe) < n:
            bear[lion] = np.nan
            continue
        shark = giraffe.values
        if use_log:
            shark = np.log(shark)
        if np.any(~np.isfinite(shark)):
            bear[lion] = np.nan
            continue
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, shark, rcond=None)
            rabbit = panda[2]
            bear[lion] = float(rabbit)
        except Exception:
            bear[lion] = np.nan
    return _make_factor_series(bear, date, universe=universe, name='factor599')

def factor600(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor600')

def factor601(universe, date, bench_index='000905.XSHG', n_lag=3, r2_floor=1e-06):
    _set_asof_date(date)
    eagle = _to_date(date)
    badger = dt.date(eagle.year, eagle.month, 1)
    tuna = eagle
    hawk = get_trade_days(start_date=badger - dt.timedelta(days=int(n_lag) + 10), end_date=tuna)
    if hawk is None or len(hawk) < int(n_lag) + 8:
        turtle = {shark: np.nan for shark in universe}
        return _make_factor_series(turtle, date, universe=universe, name='factor601')
    octopus = pd.to_datetime(hawk[0]).strftime('%Y-%m-%d')
    owl = pd.to_datetime(tuna).strftime('%Y-%m-%d')
    jaguar = list(dict.fromkeys(list(universe) + [bench_index]))
    sparrow = get_price(jaguar, start_date=octopus, end_date=owl, frequency='daily', fields=['close'], fq='post', panel=False)
    if sparrow is None or sparrow.empty:
        turtle = {shark: np.nan for shark in universe}
        return _make_factor_series(turtle, date, universe=universe, name='factor601')
    whale = sparrow.pivot(index='time', columns='code', values='close').sort_index()
    if bench_index not in whale.columns:
        turtle = {shark: np.nan for shark in universe}
        return _make_factor_series(turtle, date, universe=universe, name='factor601')
    iguana = whale.pct_change()
    gecko = iguana[bench_index]
    beaver = pd.Timestamp(badger)
    alpaca = pd.Timestamp(tuna)
    lemur = (gecko.index >= beaver) & (gecko.index <= alpaca)
    salmon = gecko.index[lemur]
    if salmon.size <= int(n_lag) + 2:
        turtle = {shark: np.nan for shark in universe}
        return _make_factor_series(turtle, date, universe=universe, name='factor601')
    lizard = gecko.index
    cat = gecko.values
    turtle = {}
    for shark in universe:
        if shark not in iguana.columns:
            turtle[shark] = np.nan
            continue
        donkey = iguana[shark].values
        fox = []
        tiger = []
        bear = []
        koala = []
        for penguin in salmon:
            camel = lizard.get_loc(penguin)
            if isinstance(camel, slice) or camel <= int(n_lag):
                continue
            ferret = donkey[camel]
            hyena = cat[camel]
            if not np.isfinite(ferret) or not np.isfinite(hyena):
                continue
            frog = cat[camel - 1:camel - int(n_lag) - 1:-1]
            if frog.size != int(n_lag) or not np.all(np.isfinite(frog)):
                continue
            tiger.append([1.0, hyena] + frog.tolist())
            fox.append(ferret)
            koala.append([1.0, hyena])
            bear.append(ferret)
        if len(fox) < int(n_lag) + 3:
            turtle[shark] = np.nan
            continue
        wolf = np.asarray(fox, dtype=float)
        lion = np.asarray(tiger, dtype=float)
        rabbit = np.asarray(bear, dtype=float)
        otter = np.asarray(koala, dtype=float)
        try:
            zebra, giraffe, giraffe, giraffe = np.linalg.lstsq(lion, wolf, rcond=None)
            quail = lion @ zebra
            kangaroo = float(np.sum((wolf - quail) ** 2))
            seal = float(np.mean(wolf))
            mole = float(np.sum((wolf - seal) ** 2))
            if not np.isfinite(mole) or mole <= 0.0:
                turtle[shark] = np.nan
                continue
            dog = 1.0 - kangaroo / mole
        except Exception:
            turtle[shark] = np.nan
            continue
        try:
            dolphin, giraffe, giraffe, giraffe = np.linalg.lstsq(otter, rabbit, rcond=None)
            raccoon = otter @ dolphin
            llama = float(np.sum((rabbit - raccoon) ** 2))
            turkey = float(np.mean(rabbit))
            narwhal = float(np.sum((rabbit - turkey) ** 2))
            if not np.isfinite(narwhal) or narwhal <= 0.0:
                turtle[shark] = np.nan
                continue
            panda = 1.0 - llama / narwhal
        except Exception:
            turtle[shark] = np.nan
            continue
        if not np.isfinite(dog) or not np.isfinite(panda) or dog <= float(r2_floor):
            turtle[shark] = np.nan
        else:
            turtle[shark] = float(1.0 - panda / dog)
    return _make_factor_series(turtle, date, universe=universe, name='factor601')

def factor602(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    panda = get_history_fundamentals(security=list(universe), fields=[fox.term_025, fox.term_081], watch_date=dog, count=1, interval='1q', stat_by_year=False)
    if panda is None or panda.empty:
        lion = {cat: np.nan for cat in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor602')
    panda = panda.copy()
    panda['statDate'] = pd.to_datetime(panda['statDate'])
    koala = panda.sort_values(['code', 'statDate']).groupby('code', sort=False).tail(1).set_index('code')
    tiger = pd.to_numeric(koala.get('term_025', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(universe)
    fox = pd.to_numeric(koala.get('term_081', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(universe)
    otter = (tiger / fox.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    lion = {cat: float(otter.get(cat, np.nan)) for cat in universe}
    return _make_factor_series(lion, date, universe=universe, name='factor602')

def factor603(universe, date, window_days=40):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = get_trade_days(end_date=koala, count=window_days + 1)
    if otter is None or len(otter) < window_days + 1:
        return _make_factor_series({}, date, universe=universe, name='factor603')
    dolphin = pd.to_datetime(otter[0]).date()
    zebra = pd.to_datetime(otter[-1]).date()
    rabbit = '000905.XSHG'
    hawk = [rabbit] + list(universe)
    fox = get_price(hawk, start_date=pd.to_datetime(dolphin).strftime('%Y-%m-%d'), end_date=pd.to_datetime(zebra).strftime('%Y-%m-%d'), frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty or 'code' not in fox.columns:
        return _make_factor_series({}, date, universe=universe, name='factor603')
    tiger = fox.pivot(index='time', columns='code', values='close').sort_index()
    if rabbit not in tiger.columns or tiger.shape[0] < 5:
        return _make_factor_series({}, date, universe=universe, name='factor603')
    eagle = tiger.pct_change()
    shark = eagle[rabbit]
    bear = {}
    for lion in universe:
        if lion not in eagle.columns:
            continue
        whale = eagle[lion]
        giraffe = whale.notna() & shark.notna()
        if giraffe.sum() < 10:
            continue
        turtle = whale[giraffe].values.astype(float)
        owl = shark[giraffe].values.astype(float)
        cat = np.column_stack([np.ones_like(owl), owl])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, turtle, rcond=None)
        except np.linalg.LinAlgError:
            continue
        wolf = turtle - cat.dot(panda)
        sparrow = float(np.nansum(wolf))
        if np.isfinite(sparrow):
            bear[lion] = sparrow
    return _make_factor_series(bear, date, universe=universe, name='factor603')

def factor604(universe, date, N=20):
    _set_asof_date(date)
    fox = get_trade_days(end_date=date, count=N + 1)
    if fox is None or len(fox) < N + 1:
        bear = {otter: np.nan for otter in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor604')
    eagle = fox[0]
    hawk = pd.to_datetime(eagle).strftime('%Y-%m-%d')
    wolf = get_price(universe, start_date=hawk, end_date=date, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if wolf is None or wolf.empty:
        bear = {otter: np.nan for otter in universe}
        return _make_factor_series(bear, date, universe=universe, name='factor604')
    rabbit = wolf.pivot(index='time', columns='code', values='high').sort_index()
    zebra = wolf.pivot(index='time', columns='code', values='low').sort_index()
    koala = wolf.pivot(index='time', columns='code', values='close').sort_index()
    bear = {}
    for otter in universe:
        if otter not in rabbit.columns or otter not in zebra.columns or otter not in koala.columns:
            bear[otter] = np.nan
            continue
        dog = rabbit[otter].values
        panda = zebra[otter].values
        cat = koala[otter].values
        if len(dog) < N + 1:
            bear[otter] = np.nan
            continue
        tiger = []
        for giraffe in range(1, len(dog)):
            dolphin = dog[giraffe] - panda[giraffe]
            whale = abs(dog[giraffe] - cat[giraffe - 1])
            shark = abs(panda[giraffe] - cat[giraffe - 1])
            tiger.append(max(dolphin, whale, shark))
        tiger = np.array(tiger, dtype=float)
        lion = _ema_array(tiger, N)
        if lion is None or len(lion) == 0:
            bear[otter] = np.nan
        else:
            bear[otter] = float(lion[-1])
    return _make_factor_series(bear, date, universe=universe, name='factor604')

def factor605(universe, date, min_valid_quarters=3, lookback_trade_days_1y=260):
    _set_asof_date(date)
    koala = _to_date(date)
    dolphin = None
    try:
        rabbit = get_factor_values(list(universe), factors=['term_053'], end_date=koala, count=1)
        if rabbit is not None and 'term_053' in rabbit and (rabbit['term_053'] is not None) and (not rabbit['term_053'].empty):
            dolphin = rabbit['term_053'].iloc[-1].reindex(universe).astype(float)
    except Exception:
        dolphin = None
    if dolphin is None:
        bear = get_history_fundamentals(security=list(universe), fields=[bear.term_052], watch_date=koala, count=4, interval='1q', stat_by_year=False)
        if bear is None or bear.empty:
            giraffe = {tiger: np.nan for tiger in universe}
            return _make_factor_series(giraffe, date, universe=universe, name='factor605')
        bear = bear.copy()
        bear['statDate'] = pd.to_datetime(bear['statDate'])
        bear = bear.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        dolphin = pd.Series(np.nan, index=universe, dtype='float64')
        zebra = int(min_valid_quarters)
        for tiger in universe:
            sparrow = bear[bear['code'] == tiger]['term_052'].astype(float).to_numpy()[-4:]
            if np.isfinite(sparrow).sum() < zebra:
                continue
            dolphin.loc[tiger] = float(np.nansum(sparrow))
    otter = get_trade_days(end_date=koala, count=int(lookback_trade_days_1y))
    lion = pd.to_datetime(otter[0]).date() if otter is not None and len(otter) > 0 else None
    shark = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(list(universe)))
    wolf = get_fundamentals(shark, date=koala)
    if wolf is None or wolf.empty:
        panda = pd.Series(np.nan, index=universe, dtype='float64')
    else:
        wolf = wolf.set_index('code')
        panda = wolf['term_008'].astype(float).reindex(universe)
    if lion is None:
        dog = panda.copy()
    else:
        fox = get_fundamentals(shark, date=lion)
        if fox is None or fox.empty:
            dog = panda.copy()
        else:
            fox = fox.set_index('code')
            dog = fox['term_008'].astype(float).reindex(universe)
    hawk = panda * 10000.0
    eagle = dog * 10000.0
    cat = (hawk + eagle) / 2.0
    whale = (dolphin / cat.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    giraffe = {tiger: float(whale.get(tiger, np.nan)) for tiger in universe}
    return _make_factor_series(giraffe, date, universe=universe, name='factor605')

def factor606(universe, date, T=20):
    _set_asof_date(date)
    whale = _to_date(date)
    shark = get_trade_days(end_date=whale, count=int(T) + 1)
    if shark is None or len(shark) < int(T) + 1:
        owl = {zebra: np.nan for zebra in universe}
        return _make_factor_series(owl, date, universe=universe, name='factor606')
    camel = pd.to_datetime(shark[0]).date()
    hawk = pd.to_datetime(shark[-1]).date()
    donkey = pd.to_datetime(camel).strftime('%Y-%m-%d')
    sparrow = pd.to_datetime(hawk).strftime('%Y-%m-%d')
    eagle = get_price(list(universe), start_date=donkey, end_date=sparrow, frequency='daily', fields=['close'], fq='post', panel=False)
    if eagle is None or eagle.empty:
        owl = {zebra: np.nan for zebra in universe}
        return _make_factor_series(owl, date, universe=universe, name='factor606')
    giraffe = eagle.pivot(index='time', columns='code', values='close').sort_index()
    tuna = giraffe.pct_change().iloc[-int(T):]
    alpaca = [pd.to_datetime(ferret).date() for ferret in tuna.index]
    turtle = get_money_flow_pro(security_list=list(universe), start_date=donkey, end_date=sparrow, frequency='daily', fields=['inflow_xl', 'outflow_xl', 'inflow_l', 'outflow_l', 'inflow_m', 'outflow_m', 'inflow_s', 'outflow_s'], data_type='money')
    if turtle is None or turtle.empty:
        owl = {zebra: np.nan for zebra in universe}
        return _make_factor_series(owl, date, universe=universe, name='factor606')
    turtle = turtle.copy()
    if 'time' in turtle.columns:
        turtle['date'] = pd.to_datetime(turtle['time']).dt.date
    elif 'day' in turtle.columns:
        turtle['date'] = pd.to_datetime(turtle['day']).dt.date
    else:
        turtle['date'] = pd.to_datetime(turtle.index).date
    frog = ['inflow_xl', 'outflow_xl', 'inflow_l', 'outflow_l', 'inflow_m', 'outflow_m', 'inflow_s', 'outflow_s']
    for rabbit in frog:
        if rabbit not in turtle.columns:
            owl = {zebra: np.nan for zebra in universe}
            return _make_factor_series(owl, date, universe=universe, name='factor606')
    turtle = turtle.groupby(['date', 'code'], sort=False)[frog].sum()
    owl = {}
    for zebra in universe:
        if zebra not in tuna.columns:
            owl[zebra] = np.nan
            continue
        salmon = tuna[zebra].astype(float)
        otter, tiger, dog = ([], [], [])
        for dolphin in alpaca:
            if (dolphin, zebra) not in turtle.index:
                continue
            badger = turtle.loc[dolphin, zebra]
            bear = float(badger['inflow_xl'] + badger['inflow_l'] + badger['inflow_m'] + badger['inflow_s'])
            beaver = float(badger['outflow_xl'] + badger['outflow_l'] + badger['outflow_m'] + badger['outflow_s'])
            lemur = float(salmon.get(pd.to_datetime(dolphin), np.nan))
            if not np.isfinite(lemur) or not np.isfinite(bear) or (not np.isfinite(beaver)):
                continue
            otter.append(lemur)
            tiger.append(beaver)
            dog.append(bear)
        if len(otter) < 6:
            owl[zebra] = np.nan
            continue
        koala = np.asarray(otter, dtype=float)
        panda = np.asarray(tiger, dtype=float)
        cat = np.asarray(dog, dtype=float)
        lizard = np.isfinite(koala) & np.isfinite(panda) & np.isfinite(cat)
        if lizard.sum() < 6:
            owl[zebra] = np.nan
            continue
        koala = koala[lizard]
        panda = panda[lizard]
        cat = cat[lizard]
        lion = np.column_stack([np.ones(len(koala)), panda, cat])
        try:
            wolf, fox, fox, fox = np.linalg.lstsq(lion, koala, rcond=None)
            owl[zebra] = float(wolf[1])
        except Exception:
            owl[zebra] = np.nan
    return _make_factor_series(owl, date, universe=universe, name='factor606')

def factor607(universe, date):
    _set_asof_date(date)
    shark = pd.to_datetime(date)
    ferret = pd.Period(shark, freq='Q-DEC')
    gecko, hyena = (ferret, ferret - 4)
    octopus = f'{gecko.year}q{gecko.quarter}'
    penguin = f'{hyena.year}q{hyena.quarter}'
    iguana = query(fox.code, fox.inventories, fox.term_001, fox.advance_payment, fox.term_071, fox.advance_peceipts, fox.term_081).filter(fox.code.in_(universe))
    eagle = get_fundamentals(iguana, statDate=octopus)
    lizard = get_fundamentals(iguana, statDate=penguin)
    if eagle is None or eagle.empty:
        eagle = pd.DataFrame(columns=['code', 'inventories', 'term_001', 'advance_payment', 'term_071', 'advance_peceipts', 'term_081'])
    if lizard is None or lizard.empty:
        lizard = pd.DataFrame(columns=['code', 'inventories', 'term_001', 'advance_payment', 'term_071', 'advance_peceipts', 'term_081'])
    eagle = eagle.set_index('code')
    lizard = lizard.set_index('code')
    kangaroo = query(bear.code, bear.term_076, bear.term_004, bear.term_066, bear.term_060).filter(bear.code.in_(universe))
    owl = get_fundamentals(kangaroo, statDate=octopus)
    turtle = get_fundamentals(kangaroo, statDate=penguin)
    if owl is None or owl.empty:
        owl = pd.DataFrame(columns=['code', 'term_076', 'term_004', 'term_066', 'term_060'])
    if turtle is None or turtle.empty:
        turtle = pd.DataFrame(columns=['code', 'term_076', 'term_004', 'term_066', 'term_060'])
    owl = owl.set_index('code')
    turtle = turtle.set_index('code')
    jaguar = query(wolf.code, wolf.term_028).filter(wolf.code.in_(universe))
    hawk = get_fundamentals(jaguar, statDate=octopus)
    sparrow = get_fundamentals(jaguar, statDate=penguin)
    if hawk is None or hawk.empty:
        hawk = pd.DataFrame(columns=['code', 'term_028'])
    if sparrow is None or sparrow.empty:
        sparrow = pd.DataFrame(columns=['code', 'term_028'])
    hawk = hawk.set_index('code')
    sparrow = sparrow.set_index('code')
    tiger = []
    dog = []
    lion = []
    cat = []
    koala = []
    panda = []
    for dolphin in universe:
        if dolphin not in eagle.index or dolphin not in lizard.index or dolphin not in owl.index or (dolphin not in turtle.index) or (dolphin not in hawk.index) or (dolphin not in sparrow.index):
            tiger.append(np.nan)
            dog.append(np.nan)
            lion.append(np.nan)
            cat.append(np.nan)
            koala.append(np.nan)
            panda.append(np.nan)
            continue
        quail = eagle.at[dolphin, 'term_081']
        badger = eagle.at[dolphin, 'inventories']
        lemur = lizard.at[dolphin, 'inventories']
        rabbit = eagle.at[dolphin, 'term_001'] + eagle.at[dolphin, 'advance_payment']
        bear = lizard.at[dolphin, 'term_001'] + lizard.at[dolphin, 'advance_payment']
        donkey = eagle.at[dolphin, 'term_071']
        camel = lizard.at[dolphin, 'term_071']
        fox = eagle.at[dolphin, 'advance_peceipts']
        otter = lizard.at[dolphin, 'advance_peceipts']
        narwhal = owl.at[dolphin, 'term_076'] + owl.at[dolphin, 'term_004']
        mole = turtle.at[dolphin, 'term_076'] + turtle.at[dolphin, 'term_004']
        alpaca = owl.at[dolphin, 'term_066'] - owl.at[dolphin, 'term_060']
        tuna = turtle.at[dolphin, 'term_066'] - turtle.at[dolphin, 'term_060']
        zebra = hawk.at[dolphin, 'term_028']
        giraffe = sparrow.at[dolphin, 'term_028']
        raccoon = [quail, badger, lemur, rabbit, bear, donkey, camel, fox, otter, narwhal, mole, alpaca, tuna, zebra, giraffe]
        if any((np.isnan(seal) for seal in raccoon)) or giraffe == 0 or quail == 0:
            tiger.append(np.nan)
            dog.append(np.nan)
            lion.append(np.nan)
            cat.append(np.nan)
            koala.append(np.nan)
            panda.append(np.nan)
            continue
        beaver = zebra / giraffe
        llama = 1.0 / quail
        tiger.append(-(badger - lemur * beaver) * llama)
        dog.append(-(rabbit - bear * beaver) * llama)
        lion.append(-(donkey - camel * beaver) * llama)
        cat.append(-(fox - otter * beaver) * llama)
        koala.append(-(narwhal - mole * beaver) * llama)
        panda.append((alpaca - tuna * beaver) * llama)
    frog = pd.DataFrame({'INV': tiger, 'AR': dog, 'OREC': lion, 'ADV': cat, 'SGADMIN': koala, 'GP': panda}, index=universe)

    def zscore_col(s):
        s = s.copy()
        dog = ~s.isna()
        if dog.sum() < 3:
            s[dog] = np.nan
            return s
        cat = s[dog].mean()
        panda = s[dog].std(ddof=1)
        if panda == 0 or np.isnan(panda):
            s[dog] = 0.0
        else:
            s[dog] = (s[dog] - cat) / panda
        return s
    for whale in frog.columns:
        frog[whale] = zscore_col(frog[whale])
    wolf = frog.sum(axis=1)
    salmon = {dolphin: wolf.get(dolphin, np.nan) for dolphin in universe}
    return _make_factor_series(salmon, date, universe=universe, name='factor607')

def factor608(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor608')

def factor609(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor609')

def factor610(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    lion = get_history_fundamentals(security=list(universe), fields=[fox.term_084, fox.total_owner_equities, fox.term_036, fox.development_expenditure, fox.good_will, fox.term_042, fox.term_015], watch_date=panda, count=1, interval='1q', stat_by_year=False)
    if lion is None or lion.empty:
        fox = {cat: np.nan for cat in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor610')
    lion = lion.copy()
    lion['statDate'] = pd.to_datetime(lion['statDate'])
    rabbit = lion.sort_values(['code', 'statDate']).groupby('code', sort=False).tail(1).set_index('code')
    dog = pd.to_numeric(rabbit.get('term_084', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(universe)
    otter = pd.to_numeric(rabbit.get('total_owner_equities', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(universe)

    def _opt(col):
        return pd.to_numeric(last.get(col, pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(universe).fillna(0.0)
    bear = _opt('term_036')
    tiger = _opt('development_expenditure')
    wolf = _opt('good_will')
    giraffe = _opt('term_042')
    koala = _opt('term_015')
    dolphin = (otter - bear - tiger - wolf - giraffe - koala).replace(0.0, np.nan)
    zebra = (dog / dolphin).replace([np.inf, -np.inf], np.nan)
    zebra.loc[~np.isfinite(otter.values) | ~np.isfinite(dog.values)] = np.nan
    fox = {cat: float(zebra.get(cat, np.nan)) for cat in universe}
    return _make_factor_series(fox, date, universe=universe, name='factor610')

def factor611(universe, date):
    _set_asof_date(date)
    cat = factor337(universe, date)
    cat = cat.copy()
    cat.name = 'factor611'
    return cat

def factor612(universe, date, N=10, N1=3, N2=3):
    _set_asof_date(date)
    cat = factor362(universe, date, N=N, N1=N1, N2=N2)
    cat = cat.copy()
    cat.name = 'factor612'
    return cat

def factor613(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor613')

def factor614(universe, date, cap_window=200, top_k=50, ret_days=22):
    _set_asof_date(date)
    wolf = list(universe)
    rabbit = _to_date(date)
    hawk = ['roe_ttm', 'roa_ttm', 'gross_income_ratio', 'term_064', 'term_080', 'debt_to_asset_ratio', 'current_ratio', 'term_067', 'total_asset_growth_rate', 'term_050']
    eagle = get_factor_values(wolf, factors=hawk, end_date=rabbit, count=1)
    cat = pd.DataFrame(index=wolf, columns=hawk, dtype='float64')
    for owl in hawk:
        zebra = eagle.get(owl, None)
        if zebra is None or zebra.empty:
            cat[owl] = np.nan
        else:
            cat[owl] = zebra.iloc[-1].reindex(wolf).astype(float)
    for bear in cat.columns:
        cat[bear] = _zscore_series(cat[bear])
    tiger = np.nan_to_num(cat.values.astype(float), nan=0.0)
    badger = np.linalg.norm(tiger, axis=1)
    badger = np.where(badger > 0.0, badger, np.nan)
    ferret = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(wolf))
    dolphin = get_fundamentals(ferret, date=rabbit)
    if dolphin is None or dolphin.empty:
        sparrow = {fox: np.nan for fox in wolf}
        return _make_factor_series(sparrow, date, universe=universe, name='factor614')
    dolphin = dolphin.set_index('code')
    lemur = dolphin['term_045'].astype(float).reindex(wolf)
    narwhal = lemur[np.isfinite(lemur.values) & (lemur.values > 0)].sort_values()
    gecko = narwhal.index.tolist()
    donkey = {lion: lizard for lizard, lion in enumerate(gecko)}
    giraffe = get_trade_days(end_date=rabbit, count=int(ret_days))
    if giraffe is None or len(giraffe) < 2:
        sparrow = {fox: np.nan for fox in wolf}
        return _make_factor_series(sparrow, date, universe=universe, name='factor614')
    llama = pd.to_datetime(giraffe[0]).strftime('%Y-%m-%d')
    shark = pd.to_datetime(giraffe[-1]).strftime('%Y-%m-%d')
    whale = get_price(wolf, start_date=llama, end_date=shark, frequency='daily', fields=['close'], fq='post', panel=False)
    if whale is None or whale.empty:
        sparrow = {fox: np.nan for fox in wolf}
        return _make_factor_series(sparrow, date, universe=universe, name='factor614')
    otter = whale.pivot(index='time', columns='code', values='close').sort_index()
    if otter.shape[0] < 2:
        sparrow = {fox: np.nan for fox in wolf}
        return _make_factor_series(sparrow, date, universe=universe, name='factor614')
    panda = (otter.iloc[-1] / otter.iloc[0] - 1.0).reindex(wolf).astype(float).values
    frog = {lion: lizard for lizard, lion in enumerate(wolf)}
    dog = pd.Series(np.nan, index=wolf, dtype='float64')
    for fox in gecko:
        lizard = frog.get(fox, None)
        if lizard is None:
            continue
        if not np.isfinite(badger[lizard]):
            continue
        camel = donkey[fox]
        alpaca = max(0, camel - int(cap_window))
        turtle = min(len(gecko) - 1, camel + int(cap_window))
        koala = gecko[alpaca:turtle + 1]
        koala = [lion for lion in koala if lion != fox]
        if not koala:
            continue
        salmon = lizard
        penguin = tiger[salmon]
        kangaroo = []
        iguana = []
        for lion in koala:
            tuna = frog.get(lion, None)
            if tuna is None or not np.isfinite(badger[tuna]) or (not np.isfinite(panda[tuna])):
                continue
            jaguar = float(np.dot(penguin, tiger[tuna]) / (badger[salmon] * badger[tuna]))
            if not np.isfinite(jaguar):
                continue
            octopus = max(jaguar, 0.0)
            if octopus <= 0.0:
                continue
            kangaroo.append(octopus)
            iguana.append(float(panda[tuna]))
        if len(kangaroo) == 0:
            continue
        if len(kangaroo) > int(top_k):
            beaver = np.argpartition(np.array(kangaroo), -int(top_k))[-int(top_k):]
            octopus = np.array(kangaroo)[beaver]
            hyena = np.array(iguana)[beaver]
        else:
            octopus = np.array(kangaroo)
            hyena = np.array(iguana)
        mole = float(octopus.sum())
        if mole <= 0.0 or not np.isfinite(mole):
            continue
        dog.loc[fox] = float((octopus * hyena).sum() / mole)
    sparrow = {fox: float(dog.get(fox, np.nan)) for fox in universe}
    return _make_factor_series(sparrow, date, universe=universe, name='factor614')

def factor615(universe, date):
    _set_asof_date(date)
    lion = list(universe)
    try:
        otter = get_factor_values(lion, factors=['net_asset_per_share'], end_date=date, count=260)
    except Exception:
        fox = {tiger: np.nan for tiger in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor615')
    cat = otter['net_asset_per_share']
    if cat is None or cat.empty or cat.shape[0] < 2:
        fox = {tiger: np.nan for tiger in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor615')
    panda = cat.iloc[-1]
    wolf = cat.index[-1]
    rabbit = wolf - DateOffset(years=1)
    koala = np.abs(cat.index - rabbit)
    bear = int(koala.argmin())
    dog = cat.iloc[bear]
    fox = {}
    for tiger in lion:
        zebra = panda.get(tiger, np.nan)
        giraffe = dog.get(tiger, np.nan)
        if np.isnan(zebra) or np.isnan(giraffe) or giraffe == 0:
            fox[tiger] = np.nan
        else:
            fox[tiger] = (zebra - giraffe) / abs(giraffe)
    return _make_factor_series(fox, date, universe=universe, name='factor615')

def factor616(universe, date, K_days=20):
    _set_asof_date(date)
    tiger = '000905.XSHG'
    fox = _to_date(date)
    bear = get_trade_days(end_date=fox, count=int(K_days) + 2)
    if bear is None or len(bear) < int(K_days) + 2:
        alpaca = np.nan
        return _make_factor_series({lion: alpaca for lion in universe}, date, universe=universe, name='factor616')
    salmon = [pd.to_datetime(lemur) for lemur in bear]
    tuna = pd.to_datetime(salmon).normalize()
    frog = tuna[0].strftime('%Y-%m-%d')
    zebra = tuna[-1].strftime('%Y-%m-%d')
    rabbit = get_price(tiger, start_date=frog, end_date=zebra, frequency='daily', fields=['close'], fq='post', panel=False)
    if rabbit is None or (hasattr(rabbit, 'empty') and rabbit.empty):
        alpaca = np.nan
        return _make_factor_series({lion: alpaca for lion in universe}, date, universe=universe, name='factor616')
    if isinstance(rabbit, pd.Series):
        shark = rabbit.copy()
    else:
        giraffe = rabbit.copy()
        if 'close' not in giraffe.columns:
            if giraffe.shape[1] == 1:
                shark = giraffe.iloc[:, 0]
            else:
                alpaca = np.nan
                return _make_factor_series({lion: alpaca for lion in universe}, date, universe=universe, name='factor616')
        elif 'time' in giraffe.columns:
            shark = giraffe.set_index('time')['close']
        elif 'day' in giraffe.columns:
            shark = giraffe.set_index('day')['close']
        elif 'date' in giraffe.columns:
            shark = giraffe.set_index('date')['close']
        else:
            shark = giraffe['close']
            shark.index = giraffe.index
    shark = shark.dropna()
    if shark.empty:
        alpaca = np.nan
        return _make_factor_series({lion: alpaca for lion in universe}, date, universe=universe, name='factor616')
    shark.index = pd.to_datetime(shark.index).normalize()
    shark = shark.groupby(shark.index, sort=False).last()
    shark = shark.reindex(tuna)
    sparrow = shark.pct_change()
    if sparrow.notna().sum() < int(K_days) + 1:
        alpaca = np.nan
        return _make_factor_series({lion: alpaca for lion in universe}, date, universe=universe, name='factor616')
    lizard = sparrow.iloc[-(int(K_days) + 1):]
    dog = lizard.iloc[:-1]
    if dog.size < 5:
        alpaca = np.nan
        return _make_factor_series({lion: alpaca for lion in universe}, date, universe=universe, name='factor616')
    dolphin = get_money_flow_pro(security_list=list(universe), start_date=frog, end_date=zebra, frequency='daily', fields=['inflow_s', 'outflow_s'], data_type='money')
    if dolphin is None or dolphin.empty:
        alpaca = np.nan
        return _make_factor_series({lion: alpaca for lion in universe}, date, universe=universe, name='factor616')
    dolphin = dolphin.copy()
    if 'time' in dolphin.columns:
        dolphin['date'] = pd.to_datetime(dolphin['time']).dt.normalize()
    elif 'day' in dolphin.columns:
        dolphin['date'] = pd.to_datetime(dolphin['day']).dt.normalize()
    else:
        dolphin['date'] = pd.to_datetime(dolphin.index).normalize()
    if 'inflow_s' not in dolphin.columns or 'outflow_s' not in dolphin.columns:
        alpaca = np.nan
        return _make_factor_series({lion: alpaca for lion in universe}, date, universe=universe, name='factor616')
    dolphin['net_s'] = pd.to_numeric(dolphin['inflow_s'], errors='coerce').astype(float) - pd.to_numeric(dolphin['outflow_s'], errors='coerce').astype(float)
    hawk = dolphin.groupby('date', sort=False)['net_s'].sum()
    hawk = hawk.reindex(tuna)
    wolf = {koala: whale for whale, koala in enumerate(tuna)}
    panda = []
    for otter in dog.index:
        whale = wolf.get(otter, None)
        if whale is None or whale + 1 >= len(tuna):
            panda.append(np.nan)
        else:
            panda.append(float(hawk.iloc[whale + 1]))
    panda = np.asarray(panda, dtype=float)
    cat = dog.values.astype(float)
    eagle = np.isfinite(cat) & np.isfinite(panda)
    if eagle.sum() < 5:
        alpaca = np.nan
    else:
        owl = pd.Series(cat[eagle]).rank().values
        turtle = pd.Series(panda[eagle]).rank().values
        if np.std(owl) == 0.0 or np.std(turtle) == 0.0:
            alpaca = np.nan
        else:
            alpaca = float(np.corrcoef(owl, turtle)[0, 1])
    return _make_factor_series({lion: alpaca for lion in universe}, date, universe=universe, name='factor616')

def factor617(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor617')

def factor618(universe, date, term_078=0.25):
    _set_asof_date(date)
    fox = _to_date(date)
    dog = pd.Timestamp(fox)
    otter = list(universe)
    badger = pd.Period(dog, freq='Q-DEC') - 1
    beaver = pd.PeriodIndex([badger, badger - 1, badger - 2, badger - 3], freq='Q-DEC')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    dolphin = pd.Series(np.nan, index=otter, dtype='float64')
    hyena = _nearest_td_le(fox)
    if hyena is not None:
        try:
            eagle = get_factor_values(otter, factors=['ebit_ttm'], end_date=hyena, count=1)
            bear = eagle.get('ebit_ttm', None) if isinstance(eagle, dict) else None
            if isinstance(bear, pd.DataFrame) and (not bear.empty):
                camel = bear.iloc[-1]
                camel.index = camel.index.astype(str)
                donkey = pd.to_numeric(camel, errors='coerce').astype(float).reindex(otter)
                if donkey.notna().sum() >= 10:
                    dolphin = donkey
        except Exception:
            pass
    if dolphin.notna().sum() < 10:
        giraffe = get_history_fundamentals(security=otter, fields=[bear.term_063, bear.term_021], watch_date=dog, count=12, interval='1q', stat_by_year=False)
        lizard = _prep_hist(giraffe)
        if not lizard.empty:
            lizard = lizard[lizard['q'].isin(beaver)]
            if not lizard.empty:
                alpaca = lizard.pivot(index='q', columns='code', values='term_063').reindex(index=beaver, columns=otter)
                owl = lizard.pivot(index='q', columns='code', values='term_021').reindex(index=beaver, columns=otter)
                alpaca = alpaca.apply(pd.to_numeric, errors='coerce').astype(float)
                owl = owl.apply(pd.to_numeric, errors='coerce').astype(float)
                zebra = alpaca + owl
                sparrow = zebra.sum(axis=0, min_count=1).reindex(otter)
                dolphin = dolphin.where(np.isfinite(dolphin), sparrow)
    rabbit = get_history_fundamentals(security=otter, fields=[fox.total_owner_equities, fox.term_077, fox.term_044, fox.term_006], watch_date=dog, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(rabbit)
    if panda.empty:
        return _make_factor_series({koala: np.nan for koala in otter}, fox, universe=universe, name='factor618')
    panda = panda[panda['q'].isin([badger])]
    if panda.empty:
        return _make_factor_series({koala: np.nan for koala in otter}, fox, universe=universe, name='factor618')
    shark = panda.pivot(index='q', columns='code', values='total_owner_equities').reindex(index=[badger], columns=otter)
    gecko = panda.pivot(index='q', columns='code', values='term_077').reindex(index=[badger], columns=otter)
    tuna = panda.pivot(index='q', columns='code', values='term_044').reindex(index=[badger], columns=otter)
    lion = panda.pivot(index='q', columns='code', values='term_006').reindex(index=[badger], columns=otter)
    shark = shark.apply(pd.to_numeric, errors='coerce').astype(float)
    gecko = gecko.apply(pd.to_numeric, errors='coerce').astype(float)
    tuna = tuna.apply(pd.to_numeric, errors='coerce').astype(float)
    lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = shark.loc[badger] if badger in shark.index else pd.Series(np.nan, index=otter, dtype='float64')
    ferret = (gecko.loc[badger] if badger in gecko.index else pd.Series(np.nan, index=otter, dtype='float64')).fillna(0.0)
    salmon = (tuna.loc[badger] if badger in tuna.index else pd.Series(np.nan, index=otter, dtype='float64')).fillna(0.0)
    tiger = (lion.loc[badger] if badger in lion.index else pd.Series(np.nan, index=otter, dtype='float64')).fillna(0.0)
    whale = whale.where(np.isfinite(whale), np.nan)
    wolf = ferret + salmon + tiger
    turtle = whale + wolf
    turtle = turtle.where(np.isfinite(turtle) & (turtle != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        cat = dolphin * (1.0 - float(term_078))
        lemur = cat / turtle
    frog = ~np.isfinite(lemur) | ~np.isfinite(cat) | ~np.isfinite(turtle) | (turtle == 0)
    lemur = lemur.where(~frog, np.nan).reindex(otter)
    hawk = {koala: float(lemur.get(koala)) if np.isfinite(lemur.get(koala, np.nan)) else np.nan for koala in otter}
    return _make_factor_series(hawk, fox, universe=universe, name='factor618')

def factor619(universe, date, bench_index='000905.XSHG', n=60):
    _set_asof_date(date)
    panda = get_trade_days(end_date=date, count=n + 1)
    if panda is None or len(panda) < n + 1:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor619')
    shark = panda[0]
    eagle = pd.to_datetime(shark).strftime('%Y-%m-%d')
    lion = get_price(list(universe) + [bench_index], start_date=eagle, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor619')
    cat = lion.pivot(index='time', columns='code', values='close').sort_index()
    rabbit = cat.pct_change().iloc[-n:]
    if bench_index not in rabbit.columns:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor619')
    dolphin = rabbit[bench_index].dropna()
    fox = {}
    for dog in universe:
        if dog not in rabbit.columns:
            fox[dog] = np.nan
            continue
        giraffe = rabbit[dog].dropna()
        wolf = giraffe.index.intersection(dolphin.index)
        if len(wolf) < 10:
            fox[dog] = np.nan
            continue
        hawk = giraffe.loc[wolf]
        sparrow = dolphin.loc[wolf]
        zebra = hawk.mean()
        whale = sparrow.mean()
        koala = hawk - zebra
        otter = sparrow - whale
        bear = (koala * otter ** 2).sum()
        tiger = (otter ** 3).sum()
        if tiger == 0 or np.isnan(tiger):
            fox[dog] = np.nan
        else:
            fox[dog] = float(bear / tiger)
    return _make_factor_series(fox, date, universe=universe, name='factor619')

def factor620(universe, date, N=20):
    _set_asof_date(date)
    koala = get_trade_days(end_date=date, count=N + 1)
    if koala is None or len(koala) < N + 1:
        fox = {lion: np.nan for lion in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor620')
    bear = koala[0]
    rabbit = pd.to_datetime(bear).strftime('%Y-%m-%d')
    otter = get_price(list(universe), start_date=rabbit, end_date=date, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if otter is None or otter.empty:
        fox = {lion: np.nan for lion in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor620')
    panda = otter.pivot(index='time', columns='code', values='close').sort_index()
    dolphin = otter.pivot(index='time', columns='code', values='volume').sort_index()
    fox = {}
    for lion in universe:
        if lion not in panda.columns or lion not in dolphin.columns:
            fox[lion] = np.nan
            continue
        tiger = panda[lion].values
        whale = dolphin[lion].values
        if len(tiger) < N + 1:
            fox[lion] = np.nan
            continue
        cat = []
        dog = []
        for wolf in range(1, len(tiger)):
            if np.isnan(tiger[wolf]) or np.isnan(tiger[wolf - 1]) or np.isnan(whale[wolf]):
                cat.append(0.0)
                dog.append(0.0)
                continue
            if tiger[wolf] > tiger[wolf - 1]:
                cat.append(whale[wolf])
                dog.append(0.0)
            elif tiger[wolf] < tiger[wolf - 1]:
                cat.append(0.0)
                dog.append(whale[wolf])
            else:
                cat.append(0.0)
                dog.append(0.0)
        cat = np.array(cat[-N:], dtype=float)
        dog = np.array(dog[-N:], dtype=float)
        giraffe = cat.sum()
        zebra = dog.sum()
        if zebra == 0:
            fox[lion] = 0.0
        else:
            fox[lion] = float(giraffe / zebra * 100.0)
    return _make_factor_series(fox, date, universe=universe, name='factor620')

def factor621(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor621')

def factor622(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    lion = list(universe)
    koala = _to_date(date)
    zebra = None
    try:
        bear = get_factor_values(lion, factors=['term_068'], end_date=koala, count=1)
        if bear is not None and 'term_068' in bear and (bear['term_068'] is not None) and (not bear['term_068'].empty):
            zebra = bear['term_068'].iloc[-1].reindex(lion).astype(float)
    except Exception:
        zebra = None
    if zebra is None:
        fox = get_history_fundamentals(security=lion, fields=[bear.term_066], watch_date=koala, count=4, interval='1q', stat_by_year=False)
        if fox is None or fox.empty:
            rabbit = {tiger: np.nan for tiger in lion}
            return _make_factor_series(rabbit, date, universe=universe, name='factor622')
        fox = fox.copy()
        fox['statDate'] = pd.to_datetime(fox['statDate'])
        fox = fox.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        zebra = pd.Series(np.nan, index=lion, dtype='float64')
        giraffe = int(min_valid_quarters)
        for tiger in lion:
            whale = fox[fox['code'] == tiger]['term_066'].astype(float).to_numpy()[-4:]
            if np.isfinite(whale).sum() < giraffe:
                continue
            zebra.loc[tiger] = float(np.nansum(whale))
    otter = get_history_fundamentals(security=lion, fields=[fox.term_001, fox.term_005], watch_date=koala, count=2, interval='1q', stat_by_year=False)
    if otter is None or otter.empty:
        rabbit = {tiger: np.nan for tiger in lion}
        return _make_factor_series(rabbit, date, universe=universe, name='factor622')
    otter = otter.copy()
    otter['statDate'] = pd.to_datetime(otter['statDate'])
    otter = otter.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    rabbit = {}
    for tiger in lion:
        wolf = otter[otter['code'] == tiger].tail(2)
        if wolf.shape[0] < 2:
            rabbit[tiger] = np.nan
            continue

        def _ar(row):
            cat = float(row.get('term_001', np.nan))
            dog = float(row.get('term_005', np.nan))
            if not np.isfinite(cat) and (not np.isfinite(dog)):
                return np.nan
            cat = 0.0 if not np.isfinite(cat) else cat
            dog = 0.0 if not np.isfinite(dog) else dog
            return cat + dog
        cat = _ar(wolf.iloc[0])
        dog = _ar(wolf.iloc[1])
        panda = (cat + dog) / 2.0 if np.isfinite(cat) and np.isfinite(dog) else np.nan
        dolphin = float(zebra.get(tiger, np.nan))
        if not np.isfinite(dolphin) or not np.isfinite(panda) or panda == 0.0:
            rabbit[tiger] = np.nan
        else:
            rabbit[tiger] = float(dolphin / panda)
    return _make_factor_series(rabbit, date, universe=universe, name='factor622')

def factor623(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor623')

def factor624(universe, date, min_valid_quarters=1):
    _set_asof_date(date)
    panda = list(universe)
    tiger = _to_date(date)
    lion = get_history_fundamentals(security=panda, fields=[wolf.term_018], watch_date=tiger, count=4, interval='1q', stat_by_year=False)
    if lion is None or lion.empty:
        fox = {cat: np.nan for cat in panda}
        return _make_factor_series(fox, date, universe=universe, name='factor624')
    lion = lion.copy()
    lion['statDate'] = pd.to_datetime(lion['statDate'])
    lion = lion.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    zebra = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(panda))
    koala = get_fundamentals(zebra, date=tiger)
    if koala is None or koala.empty:
        fox = {cat: np.nan for cat in panda}
        return _make_factor_series(fox, date, universe=universe, name='factor624')
    koala = koala.set_index('code')
    rabbit = koala['term_045'].astype(float).reindex(panda)
    fox = {}
    giraffe = int(min_valid_quarters)
    for dog in panda:
        dolphin = lion[lion['code'] == dog]['term_018'].astype(float).to_numpy()[-4:]
        dolphin = np.abs(dolphin)
        wolf = int(np.isfinite(dolphin).sum())
        if wolf < giraffe:
            fox[dog] = np.nan
            continue
        otter = float(np.nansum(dolphin))
        bear = float(rabbit.get(dog, np.nan))
        if not np.isfinite(bear) or bear <= 0.0:
            fox[dog] = np.nan
        else:
            fox[dog] = float(otter / bear)
    return _make_factor_series(fox, date, universe=universe, name='factor624')

def factor625(universe, date):
    _set_asof_date(date)
    panda = pd.to_datetime(date)
    bear = panda.replace(day=1)
    wolf = panda
    tiger = get_trade_days(start_date=bear, end_date=wolf)
    if tiger is None or len(tiger) == 0:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor625')
    giraffe = tiger[0]
    zebra = pd.to_datetime(giraffe).strftime('%Y-%m-%d')
    otter = panda.strftime('%Y-%m-%d')
    lion = get_price(universe, start_date=zebra, end_date=otter, frequency='daily', fields=['volume'], fq='post', panel=False)
    if lion is None or lion.empty:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor625')
    whale = lion.pivot(index='time', columns='code', values='volume').sort_index()
    rabbit = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(universe))
    koala = get_fundamentals(rabbit, date=date)
    if koala is None or koala.empty:
        koala = pd.DataFrame(columns=['code', 'circulating_cap'])
    koala = koala.set_index('code')
    fox = {}
    for dog in universe:
        if dog not in whale.columns:
            fox[dog] = np.nan
            continue
        cat = koala['circulating_cap'].get(dog, np.nan)
        if np.isnan(cat) or cat <= 0:
            fox[dog] = np.nan
            continue
        dolphin = whale[dog] / (cat * 10000.0)
        dolphin = dolphin.replace([np.inf, -np.inf], np.nan).dropna()
        if dolphin.empty:
            fox[dog] = np.nan
        else:
            fox[dog] = float(dolphin.mean())
    return _make_factor_series(fox, date, universe=universe, name='factor625')

def factor626(universe, date, bench_index='000905.XSHG', rf_series=None, tail_frac=0.05, lookback_days=252):
    _set_asof_date(date)
    dog = list(universe)
    tiger = get_trade_days(end_date=date, count=lookback_days + 1)
    if tiger is None or len(tiger) < 50:
        otter = {cat: np.nan for cat in dog}
        return _make_factor_series(otter, date, universe=universe, name='factor626')
    whale = tiger[0]
    shark = pd.to_datetime(whale).strftime('%Y-%m-%d')
    koala = pd.to_datetime(tiger[-1]).strftime('%Y-%m-%d')
    lion = get_price(dog + [bench_index], start_date=shark, end_date=koala, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        otter = {cat: np.nan for cat in dog}
        return _make_factor_series(otter, date, universe=universe, name='factor626')
    rabbit = lion.pivot(index='time', columns='code', values='close').sort_index()
    zebra = rabbit.pct_change()
    if bench_index not in zebra.columns:
        otter = {cat: np.nan for cat in dog}
        return _make_factor_series(otter, date, universe=universe, name='factor626')
    giraffe = zebra[bench_index]
    if rf_series is None:
        dolphin = pd.Series(0.0, index=giraffe.index)
    else:
        dolphin = rf_series.reindex(giraffe.index).fillna(0.0)
    lizard = giraffe - dolphin
    lizard = lizard.dropna()
    bear = len(lizard)
    if bear < 20:
        otter = {cat: np.nan for cat in dog}
        return _make_factor_series(otter, date, universe=universe, name='factor626')
    fox = max(5, int(tail_frac * bear))
    fox = min(fox, bear)
    frog = lizard.sort_values()
    eagle = frog.index[:fox]
    salmon = lizard.loc[eagle]
    otter = {}
    for cat in dog:
        if cat not in zebra.columns:
            otter[cat] = np.nan
            continue
        sparrow = zebra[cat] - dolphin
        owl = sparrow.loc[eagle]
        wolf = ~(owl.isna() | salmon.isna())
        if wolf.sum() < 5:
            otter[cat] = np.nan
            continue
        turtle = owl[wolf].values
        tuna = salmon[wolf].values
        hawk = np.var(tuna, ddof=1)
        if hawk == 0 or np.isnan(hawk):
            otter[cat] = np.nan
        else:
            panda = np.cov(turtle, tuna)[0, 1]
            otter[cat] = float(panda / hawk)
    return _make_factor_series(otter, date, universe=universe, name='factor626')

def factor627(universe, date):
    _set_asof_date(date)
    dolphin = _to_date(date)
    dog = pd.Timestamp(dolphin)
    bear = list(universe)
    lemur = pd.Period(dog, freq='Q-DEC') - 1
    tuna = lemur - 4
    alpaca = pd.PeriodIndex([tuna, lemur], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    eagle = get_history_fundamentals(security=bear, fields=[bear.term_066, bear.term_060], watch_date=dog, count=24, interval='1q', stat_by_year=False)
    lizard = _prep_hist(eagle)
    if lizard.empty:
        return _make_factor_series({tiger: np.nan for tiger in bear}, dolphin, universe=universe, name='factor627')
    lizard = lizard[lizard['q'].isin(alpaca)]
    if lizard.empty:
        return _make_factor_series({tiger: np.nan for tiger in bear}, dolphin, universe=universe, name='factor627')
    beaver = lizard.pivot(index='q', columns='code', values='term_066').reindex(index=alpaca, columns=bear)
    giraffe = lizard.pivot(index='q', columns='code', values='term_060').reindex(index=alpaca, columns=bear)
    beaver = beaver.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = giraffe.apply(pd.to_numeric, errors='coerce').astype(float)
    camel = beaver.loc[lemur] if lemur in beaver.index else pd.Series(np.nan, index=bear, dtype='float64')
    zebra = giraffe.loc[lemur] if lemur in giraffe.index else pd.Series(np.nan, index=bear, dtype='float64')
    badger = beaver.loc[tuna] if tuna in beaver.index else pd.Series(np.nan, index=bear, dtype='float64')
    rabbit = giraffe.loc[tuna] if tuna in giraffe.index else pd.Series(np.nan, index=bear, dtype='float64')
    turtle = camel - zebra
    owl = badger - rabbit
    shark = get_history_fundamentals(security=bear, fields=[wolf.term_028], watch_date=dog, count=24, interval='1q', stat_by_year=False)
    wolf = _prep_hist(shark)
    if wolf.empty:
        return _make_factor_series({tiger: np.nan for tiger in bear}, dolphin, universe=universe, name='factor627')
    wolf = wolf[wolf['q'].isin(alpaca)]
    if wolf.empty:
        return _make_factor_series({tiger: np.nan for tiger in bear}, dolphin, universe=universe, name='factor627')
    otter = wolf.pivot(index='q', columns='code', values='term_028').reindex(index=alpaca, columns=bear)
    otter = otter.apply(pd.to_numeric, errors='coerce').astype(float)
    fox = otter.loc[lemur] if lemur in otter.index else pd.Series(np.nan, index=bear, dtype='float64')
    lion = otter.loc[tuna] if tuna in otter.index else pd.Series(np.nan, index=bear, dtype='float64')
    koala = lion.where(np.isfinite(lion) & (lion != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        sparrow = fox / koala
    sparrow = sparrow.replace([np.inf, -np.inf], np.nan)
    whale = get_history_fundamentals(security=bear, fields=[fox.term_081], watch_date=dog, count=24, interval='1q', stat_by_year=False)
    panda = _prep_hist(whale)
    if panda.empty or 'term_081' not in panda.columns:
        return _make_factor_series({tiger: np.nan for tiger in bear}, dolphin, universe=universe, name='factor627')
    panda = panda[panda['q'].isin([lemur])]
    if panda.empty:
        return _make_factor_series({tiger: np.nan for tiger in bear}, dolphin, universe=universe, name='factor627')
    donkey = panda.pivot(index='q', columns='code', values='term_081').reindex(index=[lemur], columns=bear)
    donkey = donkey.apply(pd.to_numeric, errors='coerce').astype(float)
    gecko = donkey.loc[lemur] if lemur in donkey.index else pd.Series(np.nan, index=bear, dtype='float64')
    ferret = gecko.where(np.isfinite(gecko) & (gecko != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        cat = turtle - owl * sparrow
        salmon = cat / ferret
    salmon = salmon.replace([np.inf, -np.inf], np.nan)
    frog = ~np.isfinite(salmon) | ~np.isfinite(turtle) | ~np.isfinite(owl) | ~np.isfinite(sparrow) | ~np.isfinite(ferret)
    salmon = salmon.where(~frog, np.nan).reindex(bear)
    hawk = {tiger: float(salmon.get(tiger)) if np.isfinite(salmon.get(tiger, np.nan)) else np.nan for tiger in bear}
    return _make_factor_series(hawk, dolphin, universe=universe, name='factor627')

def factor628(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    koala = query(fox.code, fox.term_081, fox.total_owner_equities).filter(fox.code.in_(dog))
    panda = get_fundamentals(koala, date=date)
    if panda is None or panda.empty:
        lion = {cat: np.nan for cat in dog}
        return _make_factor_series(lion, date, universe=universe, name='factor628')
    panda = panda.set_index('code')
    lion = {}
    for cat in dog:
        otter = panda['term_081'].get(cat, np.nan)
        tiger = panda['total_owner_equities'].get(cat, np.nan)
        if np.isnan(otter) or np.isnan(tiger) or tiger == 0:
            lion[cat] = np.nan
        else:
            lion[cat] = otter / tiger
    return _make_factor_series(lion, date, universe=universe, name='factor628')

def factor629(universe, date, max_lag=10):
    _set_asof_date(date)
    lion = list(universe)
    try:
        koala = get_factor_values(lion, factors=['term_053'], end_date=date, count=max_lag)
        fox = koala['term_053']
    except Exception:
        fox = None
    otter = {}
    if fox is None or fox.empty:
        otter = {tiger: np.nan for tiger in lion}
        return _make_factor_series(otter, date, universe=universe, name='factor629')
    for tiger in lion:
        bear = fox[tiger].dropna().values
        if len(bear) < 5:
            otter[tiger] = np.nan
            continue
        giraffe = bear[1:]
        rabbit = bear[:-1]
        cat = np.column_stack([np.ones(len(rabbit)), rabbit])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, giraffe, rcond=None)
            wolf = panda[1]
            otter[tiger] = float(wolf)
        except Exception:
            otter[tiger] = np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor629')

def factor630(universe, date, N=20, lam=0.6, industry_name='sw_l1'):
    _set_asof_date(date)
    otter = list(universe)
    bear = get_trade_days(end_date=date, count=N + 1)
    if bear is None or len(bear) < N + 1:
        zebra = {koala: np.nan for koala in otter}
        return _make_factor_series(zebra, date, universe=universe, name='factor630')
    salmon = bear[0]
    tuna = pd.to_datetime(salmon).strftime('%Y-%m-%d')
    giraffe = pd.to_datetime(bear[-1]).strftime('%Y-%m-%d')
    rabbit = get_price(otter, start_date=tuna, end_date=giraffe, frequency='daily', fields=['close', 'money'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        zebra = {koala: np.nan for koala in otter}
        return _make_factor_series(zebra, date, universe=universe, name='factor630')
    lion = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    sparrow = rabbit.pivot(index='time', columns='code', values='money').sort_index()
    turtle = lion.pct_change().iloc[-N:]
    badger = sparrow.iloc[-N:]
    shark = get_industries(name=industry_name, date=date)
    dolphin = {}
    if shark is not None and (not shark.empty):
        for whale in shark.index:
            alpaca = get_industry_stocks(whale, date=date)
            if alpaca:
                eagle = list(set(alpaca) & set(otter))
                if eagle:
                    dolphin[whale] = eagle
    zebra = {koala: np.nan for koala in otter}
    for whale, alpaca in dolphin.items():
        tiger = [frog for frog in alpaca if frog in turtle.columns]
        if len(tiger) < 2:
            continue
        beaver = badger[tiger].mean(axis=0)
        beaver = beaver.dropna()
        if beaver.empty:
            continue
        camel = beaver.sort_values(ascending=False)
        lemur = camel.sum()
        if lemur <= 0:
            continue
        fox = camel.cumsum()
        wolf = lam * lemur
        hawk = camel[fox <= wolf].index.tolist()
        if not hawk:
            hawk = [camel.index[0]]
        owl = [frog for frog in tiger if frog not in hawk]
        if not owl:
            continue
        lizard = turtle[tiger].mean(axis=0)
        dog = lizard[hawk].mean()
        panda = lizard[owl].mean()
        if np.isnan(dog) or np.isnan(panda):
            continue
        cat = float(dog - panda)
        for frog in tiger:
            zebra[frog] = cat
    return _make_factor_series(zebra, date, universe=universe, name='factor630')

def factor631(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor631')

def factor632(universe, date, N=23, M=8, use_ma=True):
    _set_asof_date(date)
    rabbit = list(universe)
    giraffe = get_trade_days(end_date=date, count=N + M)
    if giraffe is None or len(giraffe) < N + M:
        dolphin = {bear: np.nan for bear in rabbit}
        return _make_factor_series(dolphin, date, universe=universe, name='factor632')
    salmon = giraffe[0]
    tuna = pd.to_datetime(salmon).strftime('%Y-%m-%d')
    zebra = get_price(rabbit, start_date=tuna, end_date=date, frequency='daily', fields=['open', 'high', 'low'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        dolphin = {bear: np.nan for bear in rabbit}
        return _make_factor_series(dolphin, date, universe=universe, name='factor632')
    turtle = zebra.pivot(index='time', columns='code', values='open').sort_index()
    whale = zebra.pivot(index='time', columns='code', values='high').sort_index()
    hawk = zebra.pivot(index='time', columns='code', values='low').sort_index()
    dolphin = {}
    for bear in rabbit:
        if bear not in turtle.columns or bear not in whale.columns or bear not in hawk.columns:
            dolphin[bear] = np.nan
            continue
        koala = turtle[bear].values.astype(float)
        tiger = whale[bear].values.astype(float)
        lion = hawk[bear].values.astype(float)
        if len(koala) < N + M:
            dolphin[bear] = np.nan
            continue
        panda = np.zeros_like(koala, dtype=float)
        dog = np.zeros_like(koala, dtype=float)
        for alpaca in range(1, len(koala)):
            lizard = koala[alpaca]
            frog = koala[alpaca - 1]
            shark = tiger[alpaca]
            sparrow = lion[alpaca]
            if np.isnan(lizard) or np.isnan(frog) or np.isnan(shark) or np.isnan(sparrow):
                panda[alpaca] = 0.0
                dog[alpaca] = 0.0
                continue
            if lizard < frog:
                panda[alpaca] = 0.0
            else:
                panda[alpaca] = max(shark - lizard, lizard - frog)
            if lizard >= frog:
                dog[alpaca] = 0.0
            else:
                dog[alpaca] = max(lizard - sparrow, lizard - frog)
        panda = panda[-(N + M):]
        dog = dog[-(N + M):]
        cat = np.zeros_like(panda, dtype=float)
        for alpaca in range(N - 1, len(panda)):
            fox = panda[alpaca - N + 1:alpaca + 1].sum()
            otter = dog[alpaca - N + 1:alpaca + 1].sum()
            if fox > otter and fox != 0:
                cat[alpaca] = (fox - otter) / fox
            elif fox == otter:
                cat[alpaca] = 0.0
            elif otter != 0:
                cat[alpaca] = (fox - otter) / otter
            else:
                cat[alpaca] = 0.0
        eagle = turtle.index[-(N + M):]
        wolf = pd.Series(cat, index=eagle)
        if use_ma:
            owl = wolf.rolling(M).mean().iloc[-1]
            dolphin[bear] = float(owl) if not np.isnan(owl) else np.nan
        else:
            dolphin[bear] = float(wolf.iloc[-1])
    return _make_factor_series(dolphin, date, universe=universe, name='factor632')

def factor633(universe, date, K_days=21):
    _set_asof_date(date)
    fox = list(universe)
    bear = get_trade_days(end_date=date, count=K_days)
    if bear is None or len(bear) == 0:
        dolphin = {otter: np.nan for otter in fox}
        return _make_factor_series(dolphin, date, universe=universe, name='factor633')
    lizard = bear[0]
    frog = pd.to_datetime(lizard).strftime('%Y-%m-%d')
    zebra = pd.to_datetime(bear[-1]).strftime('%Y-%m-%d')
    rabbit = get_price(fox, start_date=frog, end_date=zebra, frequency='daily', fields=['volume'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        dolphin = {otter: np.nan for otter in fox}
        return _make_factor_series(dolphin, date, universe=universe, name='factor633')
    tuna = rabbit.pivot(index='time', columns='code', values='volume').sort_index()
    sparrow = query(giraffe.code, giraffe.circulating_cap, giraffe.term_045).filter(giraffe.code.in_(fox))
    giraffe = get_fundamentals(sparrow, date=date)
    if giraffe is None or giraffe.empty:
        dolphin = {otter: np.nan for otter in fox}
        return _make_factor_series(dolphin, date, universe=universe, name='factor633')
    giraffe = giraffe.set_index('code')
    eagle = []
    shark = []
    wolf = []
    for otter in fox:
        if otter not in tuna.columns:
            continue
        koala = giraffe['circulating_cap'].get(otter, np.nan)
        hawk = giraffe['term_045'].get(otter, np.nan)
        if any((np.isnan(alpaca) for alpaca in [koala, hawk])) or koala <= 0 or hawk <= 0:
            continue
        salmon = (tuna[otter] / (koala * 10000.0)).replace([np.inf, -np.inf], np.nan).dropna()
        if len(salmon) < 5:
            continue
        tiger = salmon.mean()
        if tiger <= 0:
            continue
        eagle.append(np.log(tiger))
        shark.append(np.log(hawk))
        wolf.append(otter)
    if len(wolf) < 3:
        dolphin = {otter: np.nan for otter in fox}
        return _make_factor_series(dolphin, date, universe=universe, name='factor633')
    cat = np.column_stack([np.ones(len(wolf)), shark])
    dog = np.array(eagle)
    lion, panda, panda, panda = np.linalg.lstsq(cat, dog, rcond=None)
    lemur = cat @ lion
    turtle = dog - lemur
    owl = {otter: turtle[whale] for whale, otter in enumerate(wolf)}
    dolphin = {otter: owl.get(otter, np.nan) for otter in fox}
    return _make_factor_series(dolphin, date, universe=universe, name='factor633')

def factor634(universe, date, term_078=0.25):
    _set_asof_date(date)
    otter = _to_date(date)
    dog = pd.Timestamp(otter)
    koala = list(universe)
    tuna = pd.Period(dog, freq='Q-DEC') - 1
    salmon = pd.PeriodIndex([tuna], freq='Q-DEC')
    lemur = 1.0 - float(term_078)

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    bear = get_history_fundamentals(security=koala, fields=[bear.term_063, bear.term_021], watch_date=dog, count=8, interval='1q', stat_by_year=False)
    eagle = _prep_hist(bear)
    if eagle.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor634')
    eagle = eagle[eagle['q'].isin(salmon)]
    if eagle.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor634')
    lizard = eagle.pivot(index='q', columns='code', values='term_063').reindex(index=salmon, columns=koala)
    shark = eagle.pivot(index='q', columns='code', values='term_021').reindex(index=salmon, columns=koala)
    lizard = lizard.apply(pd.to_numeric, errors='coerce').astype(float)
    shark = shark.apply(pd.to_numeric, errors='coerce').astype(float)
    turtle = lizard.loc[tuna] if tuna in lizard.index else pd.Series(np.nan, index=koala, dtype='float64')
    whale = shark.loc[tuna] if tuna in shark.index else pd.Series(np.nan, index=koala, dtype='float64')
    rabbit = turtle + whale
    cat = rabbit * lemur
    wolf = get_history_fundamentals(security=koala, fields=[fox.total_owner_equities, fox.term_077, fox.term_044, fox.term_006], watch_date=dog, count=20, interval='1q', stat_by_year=False)
    panda = _prep_hist(wolf)
    if panda.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor634')
    panda = panda[panda['q'].isin(salmon)]
    if panda.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor634')

    def _pivot(col):
        if col not in bal.columns:
            return pd.DataFrame(index=q_need, columns=codes, dtype='float64')
        cat = bal.pivot(index='q', columns='code', values=col).reindex(index=q_need, columns=codes)
        return cat.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = _pivot('total_owner_equities')
    alpaca = _pivot('term_077').fillna(0.0)
    owl = _pivot('term_044').fillna(0.0)
    tiger = _pivot('term_006').fillna(0.0)
    giraffe = zebra.loc[tuna] if tuna in zebra.index else pd.Series(np.nan, index=koala, dtype='float64')
    giraffe = giraffe.where(np.isfinite(giraffe), np.nan)
    fox = alpaca.loc[tuna] + owl.loc[tuna] + tiger.loc[tuna] if tuna in alpaca.index else pd.Series(0.0, index=koala, dtype='float64')
    sparrow = giraffe + fox
    sparrow = sparrow.where(np.isfinite(sparrow) & (sparrow != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        frog = cat / sparrow
    frog = frog.replace([np.inf, -np.inf], np.nan)
    hawk = ~np.isfinite(frog) | ~np.isfinite(cat) | ~np.isfinite(sparrow) | (sparrow == 0)
    frog = frog.where(~hawk, np.nan).reindex(koala)
    dolphin = {lion: float(frog.get(lion)) if np.isfinite(frog.get(lion, np.nan)) else np.nan for lion in koala}
    return _make_factor_series(dolphin, otter, universe=universe, name='factor634')

def factor635(universe, date):
    _set_asof_date(date)
    koala = list(universe)
    eagle = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(koala))
    fox = get_fundamentals(eagle, date=date)
    if fox is None or fox.empty:
        rabbit = {lion: np.nan for lion in koala}
        return _make_factor_series(rabbit, date, universe=universe, name='factor635')
    fox = fox.set_index('code')
    zebra = []
    dolphin = []
    otter = []
    for lion in koala:
        shark = fox['term_045'].get(lion, np.nan)
        if np.isnan(shark) or shark <= 0:
            continue
        giraffe = np.log(shark)
        zebra.append(giraffe)
        dolphin.append(giraffe ** 3)
        otter.append(lion)
    if len(otter) < 3:
        rabbit = {lion: np.nan for lion in koala}
        return _make_factor_series(rabbit, date, universe=universe, name='factor635')
    cat = np.column_stack([np.ones(len(otter)), zebra])
    dog = np.array(dolphin)
    tiger, panda, panda, panda = np.linalg.lstsq(cat, dog, rcond=None)
    wolf = dog - cat @ tiger
    bear = pd.Series(wolf, index=otter)
    whale = bear.mean()
    hawk = bear.std(ddof=1)
    if hawk == 0 or np.isnan(hawk):
        sparrow = bear * 0
    else:
        sparrow = (bear - whale) / hawk
    rabbit = {lion: sparrow.get(lion, np.nan) for lion in koala}
    return _make_factor_series(rabbit, date, universe=universe, name='factor635')

def factor636(universe, date, min_valid_quarters=3, lookback_trade_days_1y=260):
    _set_asof_date(date)
    lion = list(universe)
    otter = _to_date(date)
    eagle = None
    try:
        giraffe = get_factor_values(lion, factors=['term_068'], end_date=otter, count=1)
        if giraffe is not None and 'term_068' in giraffe and (giraffe['term_068'] is not None) and (not giraffe['term_068'].empty):
            eagle = giraffe['term_068'].iloc[-1].reindex(lion).astype(float)
    except Exception:
        eagle = None
    if eagle is None:
        rabbit = get_history_fundamentals(security=lion, fields=[bear.term_066], watch_date=otter, count=4, interval='1q', stat_by_year=False)
        if rabbit is None or rabbit.empty:
            zebra = {cat: np.nan for cat in lion}
            return _make_factor_series(zebra, date, universe=universe, name='factor636')
        rabbit = rabbit.copy()
        rabbit['statDate'] = pd.to_datetime(rabbit['statDate'])
        rabbit = rabbit.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        eagle = pd.Series(np.nan, index=lion, dtype='float64')
        dolphin = int(min_valid_quarters)
        for tiger in lion:
            sparrow = rabbit[rabbit['code'] == tiger]['term_066'].astype(float).to_numpy()[-4:]
            if np.isfinite(sparrow).sum() < dolphin:
                continue
            eagle.loc[tiger] = float(np.nansum(sparrow))
    fox = get_trade_days(end_date=otter, count=int(lookback_trade_days_1y))
    koala = pd.to_datetime(fox[0]).date() if fox is not None and len(fox) > 0 else None
    shark = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(lion))
    bear = get_fundamentals(shark, date=otter)
    if bear is None or bear.empty:
        panda = pd.Series(np.nan, index=lion, dtype='float64')
    else:
        bear = bear.set_index('code')
        panda = bear['term_008'].astype(float).reindex(lion)
    if koala is None:
        dog = panda.copy()
    else:
        wolf = get_fundamentals(shark, date=koala)
        if wolf is None or wolf.empty:
            dog = panda.copy()
        else:
            wolf = wolf.set_index('code')
            dog = wolf['term_008'].astype(float).reindex(lion)
    hawk = (panda + dog) / 2.0 * 10000.0
    whale = (eagle / hawk.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    zebra = {cat: float(whale.get(cat, np.nan)) for cat in lion}
    return _make_factor_series(zebra, date, universe=universe, name='factor636')

def factor637(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor637')

def factor638(universe, date):
    _set_asof_date(date)
    shark = _to_date(date)
    bear = pd.Timestamp(shark)
    whale = list(universe)
    beaver = pd.Period(bear, freq='Q-DEC') - 1
    camel = beaver - 1
    tuna = beaver - 4
    alpaca = beaver - 5
    badger = pd.PeriodIndex([beaver, tuna], freq='Q-DEC')
    lemur = pd.PeriodIndex([beaver, camel, tuna, alpaca], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    sparrow = get_history_fundamentals(security=whale, fields=[bear.term_035, bear.term_076, bear.term_004, bear.term_066], watch_date=bear, count=12, interval='1q', stat_by_year=False)
    salmon = _prep_hist(sparrow)
    if salmon.empty:
        return _make_factor_series({dolphin: np.nan for dolphin in whale}, shark, universe=universe, name='factor638')
    salmon = salmon[salmon['q'].isin(badger)]
    if salmon.empty:
        return _make_factor_series({dolphin: np.nan for dolphin in whale}, shark, universe=universe, name='factor638')
    seal = salmon.pivot(index='q', columns='code', values='term_035').reindex(index=badger, columns=whale)
    octopus = salmon.pivot(index='q', columns='code', values='term_066').reindex(index=badger, columns=whale)
    penguin = salmon.pivot(index='q', columns='code', values='term_076').reindex(index=badger, columns=whale)
    koala = salmon.pivot(index='q', columns='code', values='term_004').reindex(index=badger, columns=whale)
    seal = seal.apply(pd.to_numeric, errors='coerce').astype(float)
    octopus = octopus.apply(pd.to_numeric, errors='coerce').astype(float)
    penguin = penguin.apply(pd.to_numeric, errors='coerce').astype(float)
    koala = koala.apply(pd.to_numeric, errors='coerce').astype(float)
    turkey = seal.loc[beaver] if beaver in seal.index else pd.Series(np.nan, index=whale, dtype='float64')
    llama = octopus.loc[beaver] if beaver in octopus.index else pd.Series(np.nan, index=whale, dtype='float64')
    raccoon = seal.loc[tuna] if tuna in seal.index else pd.Series(np.nan, index=whale, dtype='float64')
    kangaroo = octopus.loc[tuna] if tuna in octopus.index else pd.Series(np.nan, index=whale, dtype='float64')
    quail = penguin.loc[beaver] if beaver in penguin.index else pd.Series(np.nan, index=whale, dtype='float64')
    otter = koala.loc[beaver] if beaver in koala.index else pd.Series(np.nan, index=whale, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        dog = turkey / llama
        cat = raccoon / kangaroo
        panda = (quail + otter) / llama
        lion = dog - cat
    dog = dog.replace([np.inf, -np.inf], np.nan)
    panda = panda.replace([np.inf, -np.inf], np.nan)
    lion = lion.replace([np.inf, -np.inf], np.nan)

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0])
    vulture = _nearest_td_le(beaver.end_time.date())
    urchin = _nearest_td_le(tuna.end_time.date())
    if vulture is None or urchin is None:
        return _make_factor_series({dolphin: np.nan for dolphin in whale}, shark, universe=universe, name='factor638')
    turtle = get_factor_values(whale, factors=['term_068'], end_date=vulture, count=1)
    owl = get_factor_values(whale, factors=['term_068'], end_date=urchin, count=1)
    try:
        narwhal = turtle['term_068'].iloc[-1].reindex(whale).astype(float)
    except Exception:
        narwhal = pd.Series(np.nan, index=whale, dtype='float64')
    try:
        mole = owl['term_068'].iloc[-1].reindex(whale).astype(float)
    except Exception:
        mole = pd.Series(np.nan, index=whale, dtype='float64')
    hawk = get_history_fundamentals(security=whale, fields=[fox.term_001, fox.term_005], watch_date=bear, count=12, interval='1q', stat_by_year=False)
    fox = _prep_hist(hawk)
    if fox.empty:
        return _make_factor_series({dolphin: np.nan for dolphin in whale}, shark, universe=universe, name='factor638')
    fox = fox[fox['q'].isin(lemur)]
    if fox.empty:
        return _make_factor_series({dolphin: np.nan for dolphin in whale}, shark, universe=universe, name='factor638')
    wolf = fox.pivot(index='q', columns='code', values='term_001').reindex(index=lemur, columns=whale)
    zebra = fox.pivot(index='q', columns='code', values='term_005').reindex(index=lemur, columns=whale)
    wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float)
    zebra = zebra.apply(pd.to_numeric, errors='coerce').astype(float)
    iguana = (wolf.loc[beaver] if beaver in wolf.index else pd.Series(np.nan, index=whale)) + (zebra.loc[beaver] if beaver in zebra.index else pd.Series(np.nan, index=whale))
    jaguar = (wolf.loc[camel] if camel in wolf.index else pd.Series(np.nan, index=whale)) + (zebra.loc[camel] if camel in zebra.index else pd.Series(np.nan, index=whale))
    gecko = (wolf.loc[tuna] if tuna in wolf.index else pd.Series(np.nan, index=whale)) + (zebra.loc[tuna] if tuna in zebra.index else pd.Series(np.nan, index=whale))
    hyena = (wolf.loc[alpaca] if alpaca in wolf.index else pd.Series(np.nan, index=whale)) + (zebra.loc[alpaca] if alpaca in zebra.index else pd.Series(np.nan, index=whale))
    giraffe = pd.concat([iguana, jaguar], axis=1).mean(axis=1, skipna=True)
    rabbit = pd.concat([gecko, hyena], axis=1).mean(axis=1, skipna=True)
    giraffe = giraffe.where(np.isfinite(giraffe) & (giraffe != 0), np.nan)
    rabbit = rabbit.where(np.isfinite(rabbit) & (rabbit != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        ferret = narwhal / giraffe
        donkey = mole / rabbit
        tiger = ferret - donkey
    tiger = tiger.replace([np.inf, -np.inf], np.nan)
    eagle = pd.DataFrame({'a1': dog, 'a2': panda, 'a3': tiger, 'a4': lion}, index=whale)
    eagle['a1'] = _zscore_series(eagle['a1'])
    eagle['a2'] = _zscore_series(eagle['a2'])
    eagle['a3'] = _zscore_series(eagle['a3'])
    eagle['a4'] = _zscore_series(eagle['a4'])
    frog = eagle.sum(axis=1, skipna=False)
    lizard = {dolphin: float(frog.get(dolphin)) if np.isfinite(frog.get(dolphin, np.nan)) else np.nan for dolphin in whale}
    return _make_factor_series(lizard, shark, universe=universe, name='factor638')

def factor639(universe, date, lookback_trade_days_1y=260):
    _set_asof_date(date)
    dog = list(universe)
    tiger = _to_date(date)
    whale = query(giraffe.code, giraffe.pe_ratio).filter(giraffe.code.in_(dog))
    koala = get_fundamentals(whale, date=tiger)
    if koala is None or koala.empty:
        dolphin = pd.Series(np.nan, index=dog, dtype='float64')
    else:
        koala = koala.set_index('code')
        dolphin = koala['pe_ratio'].astype(float).reindex(dog)
    lion = get_trade_days(end_date=tiger, count=int(lookback_trade_days_1y))
    panda = pd.to_datetime(lion[0]).date() if lion is not None and len(lion) > 0 else None
    fox = get_factor_values(dog, factors=['term_053'], end_date=tiger, count=1)
    if fox is None or 'term_053' not in fox or fox['term_053'] is None or fox['term_053'].empty:
        wolf = {cat: np.nan for cat in dog}
        return _make_factor_series(wolf, date, universe=universe, name='factor639')
    giraffe = fox['term_053'].iloc[-1].reindex(dog).astype(float)
    if panda is None:
        rabbit = giraffe.copy()
    else:
        otter = get_factor_values(dog, factors=['term_053'], end_date=panda, count=1)
        if otter is None or 'term_053' not in otter or otter['term_053'] is None or otter['term_053'].empty:
            rabbit = giraffe.copy()
        else:
            rabbit = otter['term_053'].iloc[-1].reindex(dog).astype(float)
    bear = ((giraffe - rabbit) / np.abs(rabbit).replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    zebra = (dolphin / bear.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    wolf = {cat: float(zebra.get(cat, np.nan)) for cat in dog}
    return _make_factor_series(wolf, date, universe=universe, name='factor639')

def factor640(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor640')

def factor641(universe, date, n_years=3):
    _set_asof_date(date)
    koala = list(universe)
    otter = pd.to_datetime(date)
    fox = 252 * (n_years + 2)
    try:
        rabbit = get_factor_values(koala, factors=['term_048'], end_date=otter, count=fox)
        wolf = rabbit['term_048']
    except Exception:
        wolf = None
    if wolf is None or wolf.empty:
        shark = pd.Period(otter, freq='Q-DEC')

        def _net_invest_ttm(per):
            panda = [per - dog for dog in range(0, 4)]
            fox = [f'{tiger.year}q{tiger.quarter}' for tiger in panda]
            koala = pd.Series(0.0, index=codes, dtype='float64')
            for otter in fox:
                lion = query(wolf.code, wolf.term_047).filter(wolf.code.in_(codes))
                cat = get_fundamentals(lion, statDate=otter)
                if cat is None or cat.empty:
                    continue
                cat = cat.set_index('code')
                koala = koala.add(cat['term_047'].reindex(codes).fillna(0.0), fill_value=0.0)
            return koala
        whale = _net_invest_ttm(shark)
        dolphin = _net_invest_ttm(shark - 4 * n_years)
        tiger = -whale
        panda = -dolphin
        giraffe = {}
        for lion in koala:
            dog = tiger.get(lion, np.nan)
            cat = panda.get(lion, np.nan)
            if np.isnan(dog) or np.isnan(cat) or cat == 0:
                giraffe[lion] = np.nan
            else:
                giraffe[lion] = (dog - cat) / abs(cat)
        return _make_factor_series(giraffe, date, universe=universe, name='factor641')
    wolf = wolf.reindex(columns=koala)
    if wolf.shape[0] < 2:
        giraffe = {lion: np.nan for lion in koala}
        return _make_factor_series(giraffe, date, universe=universe, name='factor641')
    tiger = -wolf.iloc[-1]
    hawk = otter - DateOffset(years=n_years)
    zebra = pd.to_datetime(wolf.index)
    bear = np.abs(zebra - hawk)
    eagle = int(np.argmin(bear))
    panda = -wolf.iloc[eagle]
    giraffe = {}
    for lion in koala:
        dog = tiger.get(lion, np.nan)
        cat = panda.get(lion, np.nan)
        if np.isnan(dog) or np.isnan(cat) or cat == 0:
            giraffe[lion] = np.nan
        else:
            giraffe[lion] = (dog - cat) / abs(cat)
    return _make_factor_series(giraffe, date, universe=universe, name='factor641')

def factor642(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    panda = list(universe)
    zebra = pd.Period(cat, freq='Q-DEC') - 1
    giraffe = pd.PeriodIndex([zebra], freq='Q-DEC')
    fox = get_history_fundamentals(security=panda, fields=[bear.term_060, bear.term_066], watch_date=cat, count=8, interval='1q', stat_by_year=False)
    if fox is None or fox.empty or 'code' not in fox.columns or ('statDate' not in fox.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor642')
    koala = fox.copy()
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor642')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(giraffe)]
    if koala.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, otter, universe=universe, name='factor642')
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    lion = koala.pivot(index='q', columns='code', values='term_060').reindex(index=giraffe, columns=panda)
    whale = koala.pivot(index='q', columns='code', values='term_066').reindex(index=giraffe, columns=panda)
    lion = lion.apply(pd.to_numeric, errors='coerce').astype(float)
    whale = whale.apply(pd.to_numeric, errors='coerce').astype(float)
    tiger = lion.loc[zebra] if zebra in lion.index else pd.Series(np.nan, index=panda, dtype='float64')
    dolphin = whale.loc[zebra] if zebra in whale.index else pd.Series(np.nan, index=panda, dtype='float64')
    shark = dolphin.where(np.isfinite(dolphin) & (dolphin != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = tiger / shark
    rabbit = rabbit.replace([np.inf, -np.inf], np.nan)
    bear = ~np.isfinite(rabbit) | ~np.isfinite(tiger) | ~np.isfinite(shark) | (shark == 0)
    rabbit = rabbit.where(~bear, np.nan).reindex(panda)
    wolf = {dog: float(rabbit.get(dog)) if np.isfinite(rabbit.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(wolf, otter, universe=universe, name='factor642')

def factor643(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor643')

def factor644(universe, date, K_months=6):
    _set_asof_date(date)
    dog = list(universe)
    panda = get_trade_days(end_date=date, count=K_months * 21)
    if panda is None or len(panda) == 0:
        koala = {cat: np.nan for cat in dog}
        return _make_factor_series(koala, date, universe=universe, name='factor644')
    wolf = panda[0]
    bear = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    lion = pd.to_datetime(panda[-1]).strftime('%Y-%m-%d')
    tiger = get_price(dog, start_date=bear, end_date=lion, frequency='daily', fields=['money'], fq='post', panel=False)
    if tiger is None or tiger.empty:
        koala = {cat: np.nan for cat in dog}
        return _make_factor_series(koala, date, universe=universe, name='factor644')
    otter = tiger.pivot(index='time', columns='code', values='money').sort_index()
    koala = {}
    for cat in dog:
        if cat not in otter.columns:
            koala[cat] = np.nan
            continue
        fox = otter[cat].dropna()
        if fox.empty:
            koala[cat] = np.nan
        else:
            koala[cat] = float(fox.mean())
    return _make_factor_series(koala, date, universe=universe, name='factor644')

def factor645(universe, date):
    _set_asof_date(date)
    giraffe = _to_date(date)
    lion = pd.Timestamp(giraffe)
    wolf = list(universe)
    frog = pd.Period(lion, freq='Q-DEC') - 1
    salmon = frog - 1
    lizard = pd.PeriodIndex([frog, frog - 1, frog - 2, frog - 3], freq='Q-DEC')
    turtle = pd.PeriodIndex([frog, salmon], freq='Q-DEC')
    whale = get_history_fundamentals(security=wolf, fields=[bear.term_060], watch_date=lion, count=16, interval='1q', stat_by_year=False)
    dolphin = get_history_fundamentals(security=wolf, fields=[fox.term_002, fox.term_056], watch_date=lion, count=16, interval='1q', stat_by_year=False)
    if (whale is None or whale.empty) or (dolphin is None or dolphin.empty):
        return _make_factor_series({fox: np.nan for fox in wolf}, giraffe, universe=universe, name='factor645')

    def _prep(df):
        cat = df.copy()
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return None
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    eagle = _prep(whale)
    otter = _prep(dolphin)
    if eagle is None or otter is None:
        return _make_factor_series({fox: np.nan for fox in wolf}, giraffe, universe=universe, name='factor645')
    bear = eagle.pivot(index='q', columns='code', values='term_060').sort_index().reindex(columns=wolf)
    bear = bear.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=lizard)
    rabbit = bear.sum(axis=0, min_count=2)

    def _pv(col):
        if col not in bal.columns:
            return pd.DataFrame(np.nan, index=q_ap, columns=codes, dtype=float)
        cat = bal.pivot(index='q', columns='code', values=col).sort_index().reindex(columns=codes)
        cat = cat.apply(pd.to_numeric, errors='coerce').astype(float).reindex(index=q_ap)
        return cat
    dog = _pv('term_002')
    hawk = _pv('term_056').fillna(0.0)
    cat = dog + hawk
    panda = cat.loc[frog]
    tiger = cat.loc[salmon]
    koala = (panda + tiger) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = 360.0 * koala / rabbit
    zebra = zebra.replace([np.inf, -np.inf], np.nan)
    sparrow = np.isfinite(rabbit.values) & (rabbit.values > 0) & np.isfinite(koala.values) & (koala.values > 0)
    owl = pd.Series(np.nan, index=wolf, dtype='float64')
    owl.loc[sparrow] = zebra.loc[sparrow]
    shark = {fox: float(owl.get(fox, np.nan)) if np.isfinite(owl.get(fox, np.nan)) else np.nan for fox in wolf}
    return _make_factor_series(shark, giraffe, universe=universe, name='factor645')

def factor646(universe, date, n_months=120, min_months=24):
    _set_asof_date(date)
    lion = list(universe)
    koala = _to_date(date)
    fox = int(n_months) * 21 + 10
    otter = get_trade_days(end_date=koala, count=fox)
    if otter is None or len(otter) < int(min_months) * 21:
        rabbit = {dog: np.nan for dog in lion}
        return _make_factor_series(rabbit, date, universe=universe, name='factor646')
    lizard = pd.to_datetime(otter[0]).strftime('%Y-%m-%d')
    bear = pd.to_datetime(koala).strftime('%Y-%m-%d')
    wolf = get_price(lion, start_date=lizard, end_date=bear, frequency='daily', fields=['close'], fq='post', panel=False)
    if wolf is None or wolf.empty:
        rabbit = {dog: np.nan for dog in lion}
        return _make_factor_series(rabbit, date, universe=universe, name='factor646')
    panda = wolf.pivot(index='time', columns='code', values='close').sort_index()
    sparrow = panda.pct_change()
    if sparrow.shape[0] < 2:
        rabbit = {dog: np.nan for dog in lion}
        return _make_factor_series(rabbit, date, universe=universe, name='factor646')
    whale = pd.to_datetime(sparrow.index).to_period('M')
    shark = pd.Index(sorted(whale.unique()))[-int(n_months):]
    if shark.size < int(min_months):
        rabbit = {dog: np.nan for dog in lion}
        return _make_factor_series(rabbit, date, universe=universe, name='factor646')
    owl = (1.0 + sparrow).groupby(whale).prod(min_count=1) - 1.0
    owl = owl.reindex(index=shark, columns=lion)
    giraffe = pd.Series(np.nan, index=shark, dtype='float64')
    for zebra in shark:
        dolphin = whale == zebra
        turtle = sparrow.loc[dolphin]
        if turtle is None or turtle.empty:
            continue
        salmon = turtle.values.reshape(-1)
        salmon = salmon[np.isfinite(salmon)]
        if salmon.size < 20:
            continue
        hawk = float(np.percentile(salmon, 25))
        if not np.isfinite(hawk) or hawk == 0.0:
            continue
        frog = salmon[salmon < hawk]
        if frog.size == 0:
            continue
        giraffe.loc[zebra] = float(np.mean(frog / hawk))
    if giraffe.notna().sum() < int(min_months):
        rabbit = {dog: np.nan for dog in lion}
        return _make_factor_series(rabbit, date, universe=universe, name='factor646')
    alpaca = giraffe.values.astype(float)
    rabbit = {}
    for tiger in lion:
        badger = owl[tiger].values.astype(float)
        eagle = np.isfinite(badger) & np.isfinite(alpaca)
        if eagle.sum() < int(min_months):
            rabbit[tiger] = np.nan
            continue
        tuna = alpaca[eagle]
        beaver = badger[eagle]
        lemur = float(np.var(tuna, ddof=1))
        if not np.isfinite(lemur) or lemur == 0.0:
            rabbit[tiger] = np.nan
            continue
        cat = float(np.cov(tuna, beaver, ddof=1)[0, 1] / lemur)
        rabbit[tiger] = cat if np.isfinite(cat) else np.nan
    return _make_factor_series(rabbit, date, universe=universe, name='factor646')

def factor647(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    otter = list(universe)
    fox = _to_date(date)
    frog = None
    try:
        giraffe = get_factor_values(otter, factors=['term_068'], end_date=fox, count=1)
        if giraffe is not None and 'term_068' in giraffe and (giraffe['term_068'] is not None) and (not giraffe['term_068'].empty):
            frog = giraffe['term_068'].iloc[-1].reindex(otter).astype(float)
    except Exception:
        frog = None
    if frog is None:
        rabbit = get_history_fundamentals(security=otter, fields=[bear.term_066], watch_date=fox, count=4, interval='1q', stat_by_year=False)
        if rabbit is None or rabbit.empty:
            zebra = {tiger: np.nan for tiger in otter}
            return _make_factor_series(zebra, date, universe=universe, name='factor647')
        rabbit = rabbit.copy()
        rabbit['statDate'] = pd.to_datetime(rabbit['statDate'])
        rabbit = rabbit.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        frog = pd.Series(np.nan, index=otter, dtype='float64')
        owl = int(min_valid_quarters)
        for koala in otter:
            alpaca = rabbit[rabbit['code'] == koala]['term_066'].astype(float).to_numpy()[-4:]
            if np.isfinite(alpaca).sum() < owl:
                continue
            frog.loc[koala] = float(np.nansum(alpaca))
    lizard = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(otter))
    bear = get_fundamentals(lizard, date=fox)
    if bear is None or bear.empty:
        zebra = {tiger: np.nan for tiger in otter}
        return _make_factor_series(zebra, date, universe=universe, name='factor647')
    bear = bear.set_index('code')
    sparrow = bear['term_045'].astype(float).reindex(otter)
    wolf = get_history_fundamentals(security=otter, fields=[fox.term_077, fox.term_044, fox.term_006, fox.term_012, fox.term_092, fox.term_031, fox.hold_to_maturity_investments], watch_date=fox, count=1, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty:
        dog = pd.DataFrame(index=otter)
    else:
        wolf = wolf.copy()
        wolf['statDate'] = pd.to_datetime(wolf['statDate'])
        dog = wolf.sort_values(['code', 'statDate']).groupby('code', sort=False).tail(1).set_index('code').reindex(otter)
    salmon = pd.to_numeric(dog.get('term_077', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(otter)
    hawk = pd.to_numeric(dog.get('term_044', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(otter)
    panda = pd.to_numeric(dog.get('term_006', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(otter)
    lion = pd.to_numeric(dog.get('term_012', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(otter).fillna(0.0)
    tuna = pd.to_numeric(dog.get('term_092', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(otter).fillna(0.0)
    shark = pd.to_numeric(dog.get('term_031', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(otter).fillna(0.0)
    eagle = pd.to_numeric(dog.get('hold_to_maturity_investments', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(otter).fillna(0.0)
    whale = salmon + hawk + panda
    dolphin = lion + tuna + shark + eagle
    cat = (whale - dolphin + sparrow).replace(0.0, np.nan)
    turtle = (frog / cat).replace([np.inf, -np.inf], np.nan)
    turtle.loc[~np.isfinite(whale.values) | ~np.isfinite(sparrow.values)] = np.nan
    zebra = {tiger: float(turtle.get(tiger, np.nan)) for tiger in otter}
    return _make_factor_series(zebra, date, universe=universe, name='factor647')

def factor648(universe, date, span=9, sum_window=25):
    _set_asof_date(date)
    koala = list(universe)
    shark = span * 4 + sum_window
    otter = get_trade_days(end_date=date, count=shark)
    if otter is None or len(otter) < span * 2 + sum_window:
        bear = {lion: np.nan for lion in koala}
        return _make_factor_series(bear, date, universe=universe, name='factor648')
    dolphin = otter[0]
    whale = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    fox = get_price(koala, start_date=whale, end_date=date, frequency='daily', fields=['high', 'low'], fq='post', panel=False)
    if fox is None or fox.empty:
        bear = {lion: np.nan for lion in koala}
        return _make_factor_series(bear, date, universe=universe, name='factor648')
    rabbit = fox.pivot(index='time', columns='code', values='high').sort_index()
    giraffe = fox.pivot(index='time', columns='code', values='low').sort_index()
    bear = {}
    for lion in koala:
        if lion not in rabbit.columns or lion not in giraffe.columns:
            bear[lion] = np.nan
            continue
        panda = rabbit[lion].values.astype(float)
        tiger = giraffe[lion].values.astype(float)
        wolf = panda - tiger
        if len(wolf) < span * 2 + sum_window:
            bear[lion] = np.nan
            continue
        cat = _ema_array(wolf, span)
        dog = _ema_array(cat, span)
        zebra = cat / dog
        if len(zebra) < sum_window:
            bear[lion] = np.nan
        else:
            bear[lion] = float(np.nansum(zebra[-sum_window:]))
    return _make_factor_series(bear, date, universe=universe, name='factor648')

def factor649(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor649')

def factor650(universe, date, months=12, excl_last_month=True):
    _set_asof_date(date)
    panda = list(universe)
    hawk = months * 21 + 5
    lion = get_trade_days(end_date=date, count=hawk)
    if lion is None or len(lion) < 2 * 21:
        wolf = {dog: np.nan for dog in panda}
        return _make_factor_series(wolf, date, universe=universe, name='factor650')
    bear = get_trade_days(end_date=date, count=21)
    if bear is None or len(bear) == 0:
        wolf = {dog: np.nan for dog in panda}
        return _make_factor_series(wolf, date, universe=universe, name='factor650')
    tiger = bear[0]
    shark = lion[0]
    eagle = pd.to_datetime(shark).strftime('%Y-%m-%d')
    otter = pd.to_datetime(tiger) - DateOffset(days=1)
    fox = otter.strftime('%Y-%m-%d')
    koala = get_price(panda, start_date=eagle, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if koala is None or koala.empty:
        wolf = {dog: np.nan for dog in panda}
        return _make_factor_series(wolf, date, universe=universe, name='factor650')
    giraffe = koala.pivot(index='time', columns='code', values='close').sort_index()
    dolphin = giraffe.pct_change().dropna(how='all')
    wolf = {}
    for dog in panda:
        if dog not in dolphin.columns:
            wolf[dog] = np.nan
            continue
        whale = dolphin[dog].dropna()
        if whale.empty:
            wolf[dog] = np.nan
            continue
        cat = (1.0 + whale).prod() - 1.0
        zebra = (whale > 0).mean()
        rabbit = (whale < 0).mean()
        if np.isnan(cat) or np.isnan(zebra) or np.isnan(rabbit):
            wolf[dog] = np.nan
        else:
            wolf[dog] = np.sign(cat) * (rabbit - zebra)
    return _make_factor_series(wolf, date, universe=universe, name='factor650')

def factor651(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = pd.Timestamp(lion)
    panda = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    dolphin = pd.PeriodIndex([whale], freq='Q-DEC')
    koala = get_history_fundamentals(security=panda, fields=[fox.term_081], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    if koala is None or koala.empty or 'code' not in koala.columns or ('statDate' not in koala.columns) or ('term_081' not in koala.columns):
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor651')
    tiger = koala.copy()
    tiger['code'] = tiger['code'].astype(str)
    tiger['statDate'] = pd.to_datetime(tiger['statDate'], errors='coerce')
    tiger = tiger.dropna(subset=['code', 'statDate'])
    if tiger.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor651')
    tiger['q'] = tiger['statDate'].dt.to_period('Q-DEC')
    tiger = tiger[tiger['q'].isin(dolphin)]
    if tiger.empty:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor651')
    tiger = tiger.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    eagle = tiger.pivot(index='q', columns='code', values='term_081').reindex(index=dolphin, columns=panda)
    eagle = eagle.apply(pd.to_numeric, errors='coerce').astype(float)
    shark = eagle.loc[whale] if whale in eagle.index else pd.Series(np.nan, index=panda, dtype='float64')
    hawk = get_trade_days(end_date=lion, count=1)
    if not hawk:
        return _make_factor_series({dog: np.nan for dog in panda}, lion, universe=universe, name='factor651')
    sparrow = pd.to_datetime(hawk[0]).date()
    zebra = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(panda))
    otter = get_fundamentals(zebra, date=pd.Timestamp(sparrow).strftime('%Y-%m-%d'))
    if otter is None or otter.empty or 'code' not in otter.columns:
        bear = pd.Series(np.nan, index=panda, dtype='float64')
    else:
        owl = otter.copy()
        owl['code'] = owl['code'].astype(str)
        bear = pd.to_numeric(owl.set_index('code').get('term_045', np.nan), errors='coerce').astype(float).reindex(panda)
    rabbit = bear.where(np.isfinite(bear) & (bear != 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = shark / rabbit
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    wolf = ~np.isfinite(giraffe) | ~np.isfinite(shark) | ~np.isfinite(rabbit)
    giraffe = giraffe.where(~wolf, np.nan).reindex(panda)
    fox = {dog: float(giraffe.get(dog)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(fox, lion, universe=universe, name='factor651')

def factor652(universe, date, M_days=20, freq='5m', code_chunk=200, large_threshold=800):
    _set_asof_date(date)
    panda = list(universe)
    koala = _to_date(date)
    otter = get_trade_days(end_date=koala, count=int(M_days))
    if otter is None or len(otter) == 0:
        giraffe = {dog: np.nan for dog in panda}
        return _make_factor_series(giraffe, date, universe=universe, name='factor652')
    lemur = freq
    if lemur == '1m' and len(panda) >= int(large_threshold):
        lemur = '5m'
    lizard = pd.to_datetime(otter[0]).date()
    bear = pd.to_datetime(otter[-1]).date()
    frog = pd.to_datetime(lizard).strftime('%Y-%m-%d')
    rabbit = pd.to_datetime(bear + dt.timedelta(days=1)).strftime('%Y-%m-%d')
    tuna = [pd.to_datetime(badger).date() for badger in otter]
    alpaca = set(tuna)
    owl = []
    for zebra in range(0, len(panda), int(code_chunk)):
        salmon = panda[zebra:zebra + int(code_chunk)]
        wolf = get_price(salmon, start_date=frog, end_date=rabbit, frequency=lemur, fields=['close'], fq='post', panel=False)
        if wolf is None or wolf.empty:
            continue
        wolf = wolf.copy()
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['date'] = wolf['time'].dt.date
        wolf = wolf[wolf['date'].isin(alpaca)]
        if wolf.empty:
            continue
        wolf = wolf.sort_values(['code', 'date', 'time'])
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf = wolf[np.isfinite(wolf['close'].values)]
        if wolf.empty:
            continue
        wolf['log_close'] = np.log(wolf['close'])
        wolf['log_prev'] = wolf.groupby(['code', 'date'], sort=False)['log_close'].shift(1)
        wolf['r'] = wolf['log_close'] - wolf['log_prev']
        wolf = wolf[np.isfinite(wolf['r'].values)]
        if wolf.empty:
            continue
        wolf['r2'] = wolf['r'] * wolf['r']
        wolf['r3'] = wolf['r2'] * wolf['r']
        cat = wolf.groupby(['code', 'date'], sort=False).agg(n=('r', 'count'), s1=('r', 'sum'), s2=('r2', 'sum'), s3=('r3', 'sum'))
        hawk = cat['n'].astype(float)
        eagle = cat['s1'] / hawk
        dolphin = cat['s2'] - hawk * eagle ** 2
        whale = cat['s3'] - 3.0 * eagle * cat['s2'] + 3.0 * eagle ** 2 * cat['s1'] - hawk * eagle ** 3
        fox = np.power(dolphin, 1.5)
        turtle = np.sqrt(hawk) * whale / fox
        turtle[(cat['n'] < 3) | ~np.isfinite(turtle) | ~np.isfinite(fox) | (fox <= 0.0)] = np.nan
        owl.append(turtle.rename('rskew'))
    if not owl:
        giraffe = {dog: np.nan for dog in panda}
        return _make_factor_series(giraffe, date, universe=universe, name='factor652')
    tiger = pd.concat(owl).groupby(level=[0, 1], sort=False).mean()
    lion = tiger.unstack('date').reindex(index=panda, columns=tuna)
    shark = lion.mean(axis=1, skipna=True)
    sparrow = lion.notna().sum(axis=1)
    shark.loc[sparrow < max(3, int(M_days * 0.5))] = np.nan
    giraffe = {dog: float(shark.get(dog, np.nan)) for dog in panda}
    return _make_factor_series(giraffe, date, universe=universe, name='factor652')

def factor653(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor653')

def factor654(universe, date, N1=14, N2=11, N3=10):
    _set_asof_date(date)
    otter = list(universe)
    hawk = max(N1, N2) + N3 + 5
    fox = get_trade_days(end_date=date, count=hawk)
    if fox is None or len(fox) < max(N1, N2) + N3 + 1:
        rabbit = {koala: np.nan for koala in otter}
        return _make_factor_series(rabbit, date, universe=universe, name='factor654')
    whale = fox[0]
    shark = pd.to_datetime(whale).strftime('%Y-%m-%d')
    bear = get_price(otter, start_date=shark, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if bear is None or bear.empty:
        rabbit = {koala: np.nan for koala in otter}
        return _make_factor_series(rabbit, date, universe=universe, name='factor654')
    lion = bear.pivot(index='time', columns='code', values='close').sort_index()
    rabbit = {}
    for koala in otter:
        if koala not in lion.columns:
            rabbit[koala] = np.nan
            continue
        dolphin = lion[koala].dropna()
        if len(dolphin) < max(N1, N2) + N3 + 1:
            rabbit[koala] = np.nan
            continue
        tiger = dolphin.values.astype(float)
        if len(tiger) <= max(N1, N2):
            rabbit[koala] = np.nan
            continue
        cat = (tiger[N1:] - tiger[:-N1]) / tiger[:-N1] * 100.0
        dog = (tiger[N2:] - tiger[:-N2]) / tiger[:-N2] * 100.0
        zebra = min(len(cat), len(dog))
        if zebra < N3:
            rabbit[koala] = np.nan
            continue
        cat = cat[-zebra:]
        dog = dog[-zebra:]
        panda = cat + dog
        giraffe = panda[-N3:]
        eagle = np.arange(N3, 0, -1, dtype=float)
        wolf = eagle.sum()
        if wolf == 0:
            rabbit[koala] = np.nan
        else:
            sparrow = (giraffe * eagle).sum() / wolf
            rabbit[koala] = float(sparrow)
    return _make_factor_series(rabbit, date, universe=universe, name='factor654')

def factor655(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor655')

def factor656(universe, date):
    _set_asof_date(date)
    fox = list(universe)
    try:
        zebra = get_factor_values(fox, factors=['term_053'], end_date=date, count=260)
        eagle = zebra['term_053']
    except Exception:
        eagle = None
    if eagle is None or eagle.empty or eagle.shape[0] < 2:
        dolphin = {otter: np.nan for otter in fox}
        return _make_factor_series(dolphin, date, universe=universe, name='factor656')
    turtle = eagle.iloc[-1]
    shark = eagle.index[-1]
    alpaca = pd.to_datetime(shark) - DateOffset(years=1)
    whale = pd.to_datetime(eagle.index)
    lizard = int(np.abs(whale - alpaca).argmin())
    hawk = eagle.iloc[lizard]
    frog = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(fox))
    giraffe = get_fundamentals(frog, date=date)
    if giraffe is None or giraffe.empty:
        giraffe = pd.DataFrame(columns=['code', 'term_008'])
    giraffe = giraffe.set_index('code')
    wolf = pd.to_datetime(date)
    bear = wolf - DateOffset(years=1)
    rabbit = get_fundamentals(frog, date=bear.strftime('%Y-%m-%d'))
    if rabbit is None or rabbit.empty:
        rabbit = pd.DataFrame(columns=['code', 'term_008'])
    rabbit = rabbit.set_index('code')
    dolphin = {}
    for otter in fox:
        sparrow = turtle.get(otter, np.nan)
        owl = hawk.get(otter, np.nan)
        koala = giraffe['term_008'].get(otter, np.nan)
        lion = rabbit['term_008'].get(otter, np.nan)
        if any((np.isnan(lemur) for lemur in [sparrow, owl, koala])) or koala <= 0:
            dolphin[otter] = np.nan
            continue
        tuna = koala * 10000.0
        salmon = tuna if np.isnan(lion) or lion <= 0 else lion * 10000.0
        panda = (tuna + salmon) / 2.0
        tiger = panda
        if panda == 0 or tiger == 0 or owl == 0:
            dolphin[otter] = np.nan
        else:
            dog = sparrow / panda
            cat = owl / tiger
            dolphin[otter] = (dog - cat) / abs(cat)
    return _make_factor_series(dolphin, date, universe=universe, name='factor656')

def factor657(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    panda = list(universe)
    tiger = _to_date(date)
    lion = get_history_fundamentals(security=panda, fields=[bear.term_035, bear.term_090], watch_date=tiger, count=4, interval='1q', stat_by_year=False)
    if lion is None or lion.empty:
        otter = {cat: np.nan for cat in panda}
        return _make_factor_series(otter, date, universe=universe, name='factor657')
    lion = lion.copy()
    lion['statDate'] = pd.to_datetime(lion['statDate'])
    lion = lion.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    fox = int(min_valid_quarters)
    otter = {}
    for dog in panda:
        koala = lion[lion['code'] == dog]
        rabbit = koala['term_035'].astype(float).to_numpy()[-4:]
        wolf = koala['term_090'].astype(float).to_numpy()[-4:]
        if np.isfinite(rabbit).sum() < fox or np.isfinite(wolf).sum() < fox:
            otter[dog] = np.nan
            continue
        giraffe = float(np.nansum(rabbit))
        bear = float(np.nansum(wolf))
        if not np.isfinite(bear) or bear == 0.0:
            otter[dog] = np.nan
        else:
            otter[dog] = float(giraffe / bear)
    return _make_factor_series(otter, date, universe=universe, name='factor657')

def factor658(universe, date, L=252, alpha=0.95):
    _set_asof_date(date)
    panda = list(universe)
    tiger = get_trade_days(end_date=date, count=L + 1)
    if tiger is None or len(tiger) < L + 1:
        koala = {dog: np.nan for dog in panda}
        return _make_factor_series(koala, date, universe=universe, name='factor658')
    bear = tiger[0]
    rabbit = pd.to_datetime(bear).strftime('%Y-%m-%d')
    lion = get_price(panda, start_date=rabbit, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        koala = {dog: np.nan for dog in panda}
        return _make_factor_series(koala, date, universe=universe, name='factor658')
    cat = lion.pivot(index='time', columns='code', values='close').sort_index()
    fox = cat.pct_change().iloc[1:]
    koala = {}
    for dog in panda:
        if dog not in fox.columns:
            koala[dog] = np.nan
            continue
        wolf = fox[dog].dropna()
        if len(wolf) < 20:
            koala[dog] = np.nan
            continue
        otter = np.quantile(wolf, 1 - alpha)
        koala[dog] = float(-otter)
    return _make_factor_series(koala, date, universe=universe, name='factor658')

def factor659(universe, date):
    _set_asof_date(date)
    koala = list(universe)
    otter = _to_date(date)
    dog = pd.Timestamp(otter)
    owl = pd.Period(otter, freq='Q-DEC') - 1
    sparrow = owl - 1
    hawk = owl - 4
    giraffe = [fox.term_077, fox.term_093, fox.term_056, fox.term_054, fox.term_044, fox.term_006, fox.term_081]
    fox = get_history_fundamentals(security=koala, fields=giraffe, watch_date=dog, count=12, interval='1q', stat_by_year=False)
    if fox is None or fox.empty or 'code' not in fox.columns or ('statDate' not in fox.columns):
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor659')
    fox = fox.copy()
    if 'pubDate' in fox.columns:
        eagle = pd.to_datetime(fox['pubDate'], errors='coerce')
        fox = fox[eagle.notna() & (eagle <= dog)]
    fox['code'] = fox['code'].astype(str)
    fox['statDate'] = pd.to_datetime(fox['statDate'], errors='coerce')
    fox = fox.dropna(subset=['code', 'statDate'])
    if fox.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor659')
    fox['q'] = fox['statDate'].dt.to_period('Q')
    fox = fox.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')

    def _pv(colname):
        if colname not in df.columns:
            return pd.DataFrame(np.nan, index=pd.PeriodIndex([q_t, q_p, q_ly], freq='Q-DEC'), columns=codes)
        cat = df.pivot(index='q', columns='code', values=colname).sort_index()
        cat = cat.reindex(index=pd.PeriodIndex([q_t, q_p, q_ly], freq='Q-DEC'), columns=codes)
        cat = cat.apply(pd.to_numeric, errors='coerce').astype(float)
        return cat
    turtle = _pv('term_077')
    tuna = _pv('term_093')
    whale = _pv('term_056')
    dolphin = _pv('term_054')
    zebra = _pv('term_044')
    tiger = _pv('term_006')
    lizard = _pv('term_081')
    cat = turtle.fillna(0.0) + tuna.fillna(0.0) + whale.fillna(0.0) + dolphin.fillna(0.0) + zebra.fillna(0.0) + tiger.fillna(0.0)
    rabbit = cat.loc[owl]
    bear = cat.loc[hawk]
    salmon = lizard.loc[owl]
    frog = lizard.loc[sparrow]
    panda = (salmon + frog) / 2.0
    panda = panda.replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = (rabbit - bear) / panda
    shark = shark.replace([np.inf, -np.inf], np.nan)
    shark = shark.where(np.isfinite(panda) & (panda > 0), np.nan)
    wolf = {lion: float(shark.get(lion, np.nan)) if np.isfinite(shark.get(lion, np.nan)) else np.nan for lion in koala}
    return _make_factor_series(wolf, otter, universe=universe, name='factor659')

def factor660(universe, date, K_months=6):
    _set_asof_date(date)
    dog = list(universe)
    panda = get_trade_days(end_date=date, count=K_months * 21)
    if panda is None or len(panda) == 0:
        koala = {cat: np.nan for cat in dog}
        return _make_factor_series(koala, date, universe=universe, name='factor660')
    wolf = panda[0]
    bear = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    lion = pd.to_datetime(panda[-1]).strftime('%Y-%m-%d')
    tiger = get_price(dog, start_date=bear, end_date=lion, frequency='daily', fields=['money'], fq='post', panel=False)
    if tiger is None or tiger.empty:
        koala = {cat: np.nan for cat in dog}
        return _make_factor_series(koala, date, universe=universe, name='factor660')
    otter = tiger.pivot(index='time', columns='code', values='money').sort_index()
    koala = {}
    for cat in dog:
        if cat not in otter.columns:
            koala[cat] = np.nan
            continue
        fox = otter[cat].dropna()
        if len(fox) < 5:
            koala[cat] = np.nan
        else:
            koala[cat] = float(fox.std(ddof=1))
    return _make_factor_series(koala, date, universe=universe, name='factor660')

def factor661(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor661')

def factor662(universe, date, N=20):
    _set_asof_date(date)
    wolf = list(universe)
    bear = get_trade_days(end_date=date, count=N + 1)
    if bear is None or len(bear) < N + 1:
        giraffe = {fox: np.nan for fox in wolf}
        return _make_factor_series(giraffe, date, universe=universe, name='factor662')
    dolphin = bear[0]
    whale = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    rabbit = get_price(wolf, start_date=whale, end_date=date, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        giraffe = {fox: np.nan for fox in wolf}
        return _make_factor_series(giraffe, date, universe=universe, name='factor662')
    otter = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    shark = rabbit.pivot(index='time', columns='code', values='volume').sort_index()
    giraffe = {}
    for fox in wolf:
        if fox not in otter.columns or fox not in shark.columns:
            giraffe[fox] = np.nan
            continue
        cat = otter[fox].values.astype(float)
        koala = shark[fox].values.astype(float)
        if len(cat) < N + 1:
            giraffe[fox] = np.nan
            continue
        tiger = np.zeros_like(koala, float)
        dog = np.zeros_like(koala, float)
        for zebra in range(1, len(cat)):
            if np.isnan(cat[zebra]) or np.isnan(cat[zebra - 1]) or np.isnan(koala[zebra]):
                tiger[zebra] = 0.0
                dog[zebra] = 0.0
                continue
            if cat[zebra] > cat[zebra - 1]:
                tiger[zebra] = koala[zebra]
                dog[zebra] = 0.0
            elif cat[zebra] < cat[zebra - 1]:
                tiger[zebra] = 0.0
                dog[zebra] = koala[zebra]
            else:
                tiger[zebra] = koala[zebra] / 2.0
                dog[zebra] = koala[zebra] / 2.0
        tiger = tiger[-N:]
        dog = dog[-N:]
        lion = tiger.mean()
        panda = dog.mean()
        if lion + panda > 0:
            giraffe[fox] = float(100.0 * lion / (lion + panda))
        else:
            giraffe[fox] = 0.0
    return _make_factor_series(giraffe, date, universe=universe, name='factor662')

def factor663(universe, date):
    _set_asof_date(date)
    panda = list(universe)
    tiger = _to_date(date)
    lion = get_history_fundamentals(security=panda, fields=[fox.term_081, fox.term_082, fox.total_owner_equities], watch_date=tiger, count=1, interval='1q', stat_by_year=False)
    if lion is None or lion.empty:
        otter = {cat: np.nan for cat in panda}
        return _make_factor_series(otter, date, universe=universe, name='factor663')
    lion = lion.copy()
    lion['statDate'] = pd.to_datetime(lion['statDate'])
    fox = lion.sort_values(['code', 'statDate']).groupby('code', sort=False).tail(1).set_index('code')
    bear = pd.to_numeric(fox.get('term_081', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(panda)
    dog = pd.to_numeric(fox.get('term_082', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(panda)
    koala = pd.to_numeric(fox.get('total_owner_equities', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(panda)
    wolf = ((bear - dog) / koala.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    otter = {cat: float(wolf.get(cat, np.nan)) for cat in panda}
    return _make_factor_series(otter, date, universe=universe, name='factor663')

def factor664(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor664')

def factor665(universe, date):
    _set_asof_date(date)
    lion = list(universe)
    try:
        rabbit = get_factor_values(lion, factors=['term_051'], end_date=date, count=1)
        whale = rabbit['term_051'].iloc[-1].reindex(lion)
    except Exception:
        shark = pd.Period(pd.to_datetime(date), freq='Q-DEC')
        eagle = [shark - zebra for zebra in range(0, 4)]
        salmon = [f'{hawk.year}q{hawk.quarter}' for hawk in eagle]
        whale = pd.Series(0.0, index=lion, dtype='float64')
        for frog in salmon:
            sparrow = query(wolf.code, wolf.term_049).filter(wolf.code.in_(lion))
            fox = get_fundamentals(sparrow, statDate=frog)
            if fox is None or fox.empty:
                continue
            fox = fox.set_index('code')
            whale = whale.add(fox['term_049'].reindex(lion).fillna(0.0), fill_value=0.0)
    owl = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(lion))
    bear = get_fundamentals(owl, date=date)
    if bear is None or bear.empty:
        bear = pd.DataFrame(columns=['code', 'term_008'])
    bear = bear.set_index('code')
    koala = pd.to_datetime(date)
    otter = koala - DateOffset(years=1)
    wolf = get_fundamentals(owl, date=otter.strftime('%Y-%m-%d'))
    if wolf is None or wolf.empty:
        wolf = pd.DataFrame(columns=['code', 'term_008'])
    wolf = wolf.set_index('code')
    giraffe = {}
    for tiger in lion:
        dolphin = whale.get(tiger, np.nan)
        panda = bear['term_008'].get(tiger, np.nan)
        dog = wolf['term_008'].get(tiger, np.nan)
        if np.isnan(dolphin) or np.isnan(panda) or panda <= 0:
            giraffe[tiger] = np.nan
            continue
        lizard = panda * 10000.0
        turtle = lizard if np.isnan(dog) or dog <= 0 else dog * 10000.0
        cat = (lizard + turtle) / 2.0
        if cat == 0:
            giraffe[tiger] = np.nan
        else:
            giraffe[tiger] = dolphin / cat
    return _make_factor_series(giraffe, date, universe=universe, name='factor665')

def factor666(universe, date, N=12):
    _set_asof_date(date)
    panda = list(universe)
    lion = get_trade_days(end_date=date, count=N)
    if lion is None or len(lion) < N:
        otter = {dog: np.nan for dog in panda}
        return _make_factor_series(otter, date, universe=universe, name='factor666')
    bear = lion[0]
    rabbit = pd.to_datetime(bear).strftime('%Y-%m-%d')
    koala = get_price(panda, start_date=rabbit, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if koala is None or koala.empty:
        otter = {dog: np.nan for dog in panda}
        return _make_factor_series(otter, date, universe=universe, name='factor666')
    cat = koala.pivot(index='time', columns='code', values='close').sort_index().iloc[-N:]
    otter = {}
    for dog in panda:
        if dog not in cat.columns:
            otter[dog] = np.nan
            continue
        fox = cat[dog].dropna()
        if len(fox) < N:
            otter[dog] = np.nan
            continue
        wolf = fox.mean()
        tiger = fox.iloc[-1]
        if wolf == 0 or np.isnan(tiger) or np.isnan(wolf):
            otter[dog] = 0.0
        else:
            otter[dog] = float(100.0 * (tiger - wolf) / wolf)
    return _make_factor_series(otter, date, universe=universe, name='factor666')

def factor667(universe, date, M_days=20, freq='5m', code_chunk=200, large_threshold=800, min_days=10):
    _set_asof_date(date)
    panda = list(universe)
    koala = _to_date(date)
    otter = get_trade_days(end_date=koala, count=int(M_days))
    if otter is None or len(otter) == 0:
        rabbit = {dog: np.nan for dog in panda}
        return _make_factor_series(rabbit, date, universe=universe, name='factor667')
    lizard = freq
    if lizard == '1m' and len(panda) >= int(large_threshold):
        lizard = '5m'
    owl = [pd.to_datetime(frog).date() for frog in otter]
    turtle = set(owl)
    eagle = owl[0]
    wolf = owl[-1]
    hawk = pd.to_datetime(eagle).strftime('%Y-%m-%d')
    bear = pd.to_datetime(wolf + dt.timedelta(days=1)).strftime('%Y-%m-%d')
    whale = []
    for giraffe in range(0, len(panda), int(code_chunk)):
        sparrow = panda[giraffe:giraffe + int(code_chunk)]
        fox = get_price(sparrow, start_date=hawk, end_date=bear, frequency=lizard, fields=['close'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        fox['time'] = pd.to_datetime(fox['time'])
        fox['date'] = fox['time'].dt.date
        fox = fox[fox['date'].isin(turtle)]
        if fox.empty:
            continue
        fox = fox.sort_values(['code', 'date', 'time'])
        fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
        fox = fox[np.isfinite(fox['close'].values)]
        if fox.empty:
            continue
        fox['log_close'] = np.log(fox['close'])
        fox['log_prev'] = fox.groupby(['code', 'date'], sort=False)['log_close'].shift(1)
        fox['r'] = fox['log_close'] - fox['log_prev']
        fox = fox[np.isfinite(fox['r'].values)]
        if fox.empty:
            continue
        fox['r2'] = fox['r'] * fox['r']
        fox['r2_pos'] = fox['r2'].where(fox['r'] > 0.0, 0.0)
        cat = fox.groupby(['code', 'date'], sort=False).agg(den=('r2', 'sum'), num=('r2_pos', 'sum'))
        shark = cat['num'] / cat['den']
        shark[~np.isfinite(shark) | ~np.isfinite(cat['den']) | (cat['den'] <= 0.0)] = np.nan
        whale.append(shark.rename('ratio'))
    if not whale:
        rabbit = {dog: np.nan for dog in panda}
        return _make_factor_series(rabbit, date, universe=universe, name='factor667')
    tiger = pd.concat(whale).groupby(level=[0, 1], sort=False).mean()
    lion = tiger.unstack('date').reindex(index=panda, columns=owl)
    zebra = lion.mean(axis=1, skipna=True)
    dolphin = lion.notna().sum(axis=1)
    zebra.loc[dolphin < int(min_days)] = np.nan
    rabbit = {dog: float(zebra.get(dog, np.nan)) for dog in panda}
    return _make_factor_series(rabbit, date, universe=universe, name='factor667')

def factor668(universe, date):
    _set_asof_date(date)
    bear = _to_date(date)
    cat = pd.Timestamp(bear)
    otter = list(universe)

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    alpaca = pd.Period(cat, freq='Q-DEC') - 1
    lemur = pd.PeriodIndex([alpaca, alpaca - 1, alpaca - 2, alpaca - 3], freq='Q-DEC')
    giraffe = get_history_fundamentals(security=otter, fields=[bear.term_066, bear.term_060], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    owl = _prep_hist(giraffe)
    if owl.empty:
        return _make_factor_series({lion: np.nan for lion in otter}, bear, universe=universe, name='factor668')
    owl = owl[owl['q'].isin(lemur)]
    if owl.empty:
        return _make_factor_series({lion: np.nan for lion in otter}, bear, universe=universe, name='factor668')
    camel = owl.pivot(index='q', columns='code', values='term_066').reindex(index=lemur, columns=otter)
    fox = owl.pivot(index='q', columns='code', values='term_060').reindex(index=lemur, columns=otter)
    camel = camel.apply(pd.to_numeric, errors='coerce').astype(float)
    fox = fox.apply(pd.to_numeric, errors='coerce').astype(float)
    donkey = camel.sum(axis=0, min_count=1).reindex(otter)
    wolf = fox.sum(axis=0, min_count=1).reindex(otter)
    eagle = (donkey - wolf).reindex(otter)
    rabbit = get_history_fundamentals(security=otter, fields=[fox.term_077, fox.term_044, fox.term_006, fox.term_093, fox.term_012, fox.term_092, fox.term_031, fox.hold_to_maturity_investments], watch_date=cat, count=12, interval='1q', stat_by_year=False)
    dog = _prep_hist(rabbit)
    if dog.empty:
        return _make_factor_series({lion: np.nan for lion in otter}, bear, universe=universe, name='factor668')
    dog = dog[dog['q'].isin([alpaca])]
    if dog.empty:
        return _make_factor_series({lion: np.nan for lion in otter}, bear, universe=universe, name='factor668')
    panda = dog.set_index('code')

    def _col(name, fill0=False):
        if name in bal_idx.columns:
            cat = pd.to_numeric(bal_idx[name], errors='coerce').astype(float)
        else:
            cat = pd.Series(np.nan, index=bal_idx.index, dtype='float64')
        cat = cat.reindex(codes)
        return cat.fillna(0.0) if fill0 else cat
    ferret = _col('term_077', fill0=False)
    lizard = _col('term_044', fill0=False)
    tiger = _col('term_006', fill0=False)
    jaguar = _col('term_093', fill0=True)
    koala = _col('term_012', fill0=True)
    gecko = _col('term_092', fill0=True)
    hawk = _col('term_031', fill0=True)
    sparrow = _col('hold_to_maturity_investments', fill0=True)
    shark = ferret + lizard + tiger + jaguar
    whale = koala + gecko + hawk + sparrow
    beaver = np.isfinite(ferret) & np.isfinite(lizard) & np.isfinite(tiger)
    shark = shark.where(beaver, np.nan)
    whale = whale.where(beaver, np.nan)
    hyena = _nearest_td_le(bear)
    if hyena is None:
        return _make_factor_series({lion: np.nan for lion in otter}, bear, universe=universe, name='factor668')
    iguana = pd.Timestamp(hyena).strftime('%Y-%m-%d')
    badger = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(otter))
    zebra = get_fundamentals(badger, date=iguana)
    if zebra is None or zebra.empty or 'code' not in zebra.columns:
        frog = pd.Series(np.nan, index=otter, dtype='float64')
    else:
        zebra = zebra.copy()
        zebra['code'] = zebra['code'].astype(str)
        frog = pd.to_numeric(zebra.set_index('code').get('term_045', np.nan), errors='coerce').astype(float).reindex(otter)
    with np.errstate(divide='ignore', invalid='ignore'):
        salmon = shark - whale + frog
        tuna = eagle / salmon
    turtle = ~np.isfinite(tuna) | ~np.isfinite(eagle) | ~np.isfinite(salmon) | (salmon == 0)
    tuna = tuna.where(~turtle, np.nan).reindex(otter)
    dolphin = {lion: float(tuna.get(lion)) if np.isfinite(tuna.get(lion, np.nan)) else np.nan for lion in otter}
    return _make_factor_series(dolphin, bear, universe=universe, name='factor668')

def factor669(universe, date):
    _set_asof_date(date)
    lizard = _to_date(date)
    hawk = pd.Timestamp(lizard)
    owl = list(universe)
    beaver = pd.Period(hawk, freq='Q-DEC') - 1
    lemur = beaver - 4
    badger = pd.PeriodIndex([lemur, beaver], freq='Q-DEC')
    salmon = get_history_fundamentals(security=owl, fields=[fox.term_082, fox.term_012, fox.term_083, fox.term_056, fox.term_054], watch_date=hawk, count=40, interval='1q', stat_by_year=False)
    if salmon is None or salmon.empty or 'code' not in salmon.columns or ('statDate' not in salmon.columns):
        return _make_factor_series({sparrow: np.nan for sparrow in owl}, lizard, universe=universe, name='factor669')
    turtle = salmon.copy()
    turtle['code'] = turtle['code'].astype(str)
    turtle['statDate'] = pd.to_datetime(turtle['statDate'], errors='coerce')
    turtle = turtle.dropna(subset=['code', 'statDate'])
    if turtle.empty:
        return _make_factor_series({sparrow: np.nan for sparrow in owl}, lizard, universe=universe, name='factor669')
    turtle['q'] = turtle['statDate'].dt.to_period('Q-DEC')
    turtle = turtle[turtle['q'].isin(badger)]
    if turtle.empty:
        return _make_factor_series({sparrow: np.nan for sparrow in owl}, lizard, universe=universe, name='factor669')
    turtle = turtle.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')

    def _pivot(col):
        if col not in d.columns:
            return pd.DataFrame(index=q_need, columns=codes, dtype='float64')
        cat = d.pivot(index='q', columns='code', values=col).reindex(index=q_need, columns=codes)
        return cat.apply(pd.to_numeric, errors='coerce').astype(float)
    dog = _pivot('term_082')
    fox = _pivot('term_012')
    lion = _pivot('term_083')
    dolphin = _pivot('term_056').fillna(0.0)
    rabbit = _pivot('term_054').fillna(0.0)
    panda = dog.loc[beaver] if beaver in dog.index else pd.Series(np.nan, index=owl, dtype='float64')
    wolf = fox.loc[beaver] if beaver in fox.index else pd.Series(np.nan, index=owl, dtype='float64')
    koala = lion.loc[beaver] if beaver in lion.index else pd.Series(np.nan, index=owl, dtype='float64')
    whale = dolphin.loc[beaver] if beaver in dolphin.index else pd.Series(0.0, index=owl, dtype='float64')
    giraffe = rabbit.loc[beaver] if beaver in rabbit.index else pd.Series(0.0, index=owl, dtype='float64')
    cat = dog.loc[lemur] if lemur in dog.index else pd.Series(np.nan, index=owl, dtype='float64')
    otter = fox.loc[lemur] if lemur in fox.index else pd.Series(np.nan, index=owl, dtype='float64')
    tiger = lion.loc[lemur] if lemur in lion.index else pd.Series(np.nan, index=owl, dtype='float64')
    zebra = dolphin.loc[lemur] if lemur in dolphin.index else pd.Series(0.0, index=owl, dtype='float64')
    bear = rabbit.loc[lemur] if lemur in rabbit.index else pd.Series(0.0, index=owl, dtype='float64')
    donkey = np.isfinite(panda) & np.isfinite(wolf) & np.isfinite(koala)
    camel = np.isfinite(cat) & np.isfinite(otter) & np.isfinite(tiger)
    eagle = panda - wolf - (koala - whale - giraffe)
    shark = cat - otter - (tiger - zebra - bear)
    eagle = eagle.where(donkey, np.nan)
    shark = shark.where(camel, np.nan)
    frog = shark.abs()
    frog = frog.where(np.isfinite(frog) & (frog > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        alpaca = (eagle - shark) / frog
    alpaca = alpaca.replace([np.inf, -np.inf], np.nan)
    ferret = np.isfinite(alpaca) & np.isfinite(frog) & (frog > 0)
    alpaca = alpaca.where(ferret, np.nan).reindex(owl)
    tuna = {sparrow: float(alpaca.get(sparrow)) if np.isfinite(alpaca.get(sparrow, np.nan)) else np.nan for sparrow in owl}
    return _make_factor_series(tuna, lizard, universe=universe, name='factor669')

def factor670(universe, date):
    _set_asof_date(date)
    panda = list(universe)
    tiger = pd.to_datetime(date)
    bear, fox = (tiger.year, tiger.month)
    try:
        prefetch_security_info(panda, asof_date=tiger.date())
    except Exception:
        pass
    lion = {}
    for dog in panda:
        try:
            koala = get_security_info(dog)
            otter = getattr(koala, 'start_date', None)
            if otter is None:
                lion[dog] = np.nan
                continue
            rabbit, wolf = (otter.year, otter.month)
            cat = (bear - rabbit) * 12 + (fox - wolf)
            if cat < 0:
                cat = 0
            lion[dog] = int(cat)
        except Exception:
            lion[dog] = np.nan
    return _make_factor_series(lion, date, universe=universe, name='factor670')

def factor671(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    lion = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    dolphin = pd.PeriodIndex([whale], freq='Q-DEC')
    fox = get_history_fundamentals(security=lion, fields=[fox.total_owner_equities], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    if fox is None or fox.empty or 'code' not in fox.columns or ('statDate' not in fox.columns) or ('total_owner_equities' not in fox.columns):
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor671')
    koala = fox.copy()
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor671')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(dolphin)]
    if koala.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor671')
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    panda = koala.pivot(index='q', columns='code', values='total_owner_equities').reindex(index=dolphin, columns=lion)
    panda = panda.apply(pd.to_numeric, errors='coerce').astype(float)
    dog = panda.loc[whale] if whale in panda.index else pd.Series(np.nan, index=lion, dtype='float64')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    eagle = _nearest_td_le(otter)
    if eagle is None:
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor671')
    shark = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(lion))
    wolf = get_fundamentals(shark, date=pd.Timestamp(eagle).strftime('%Y-%m-%d'))
    if wolf is None or wolf.empty or 'code' not in wolf.columns:
        giraffe = pd.Series(np.nan, index=lion, dtype='float64')
    else:
        hawk = wolf.copy()
        hawk['code'] = hawk['code'].astype(str)
        giraffe = pd.to_numeric(hawk.set_index('code').get('term_045', np.nan), errors='coerce').astype(float).reindex(lion)
    giraffe = giraffe.where(np.isfinite(giraffe) & (giraffe > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = dog / giraffe
    zebra = zebra.replace([np.inf, -np.inf], np.nan)
    rabbit = ~np.isfinite(zebra) | ~np.isfinite(dog) | ~np.isfinite(giraffe) | (giraffe <= 0)
    zebra = zebra.where(~rabbit, np.nan).reindex(lion)
    bear = {tiger: float(zebra.get(tiger)) if np.isfinite(zebra.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(bear, otter, universe=universe, name='factor671')

def factor672(universe, date, L=252, alpha=0.95):
    _set_asof_date(date)
    panda = list(universe)
    tiger = get_trade_days(end_date=date, count=L + 1)
    if tiger is None or len(tiger) < L + 1:
        koala = {dog: np.nan for dog in panda}
        return _make_factor_series(koala, date, universe=universe, name='factor672')
    wolf = tiger[0]
    bear = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    lion = get_price(panda, start_date=bear, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        koala = {dog: np.nan for dog in panda}
        return _make_factor_series(koala, date, universe=universe, name='factor672')
    cat = lion.pivot(index='time', columns='code', values='close').sort_index()
    otter = cat.pct_change().iloc[-L:]
    koala = {}
    for dog in panda:
        fox = otter[dog].dropna()
        if len(fox) < 20:
            koala[dog] = np.nan
            continue
        giraffe = np.quantile(fox, 1 - alpha)
        rabbit = fox[fox <= giraffe]
        if rabbit.empty:
            koala[dog] = np.nan
        else:
            koala[dog] = float(rabbit.mean())
    return _make_factor_series(koala, date, universe=universe, name='factor672')

def factor673(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    cat = pd.Timestamp(fox)
    koala = list(universe)

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    shark = pd.Series(np.nan, index=koala, dtype='float64')
    camel = _nearest_td_le(fox)
    if camel is not None:
        try:
            giraffe = get_factor_values(koala, factors=['term_026'], end_date=pd.Timestamp(camel), count=1)
            wolf = giraffe.get('term_026', None) if isinstance(giraffe, dict) else None
            if isinstance(wolf, pd.DataFrame) and (not wolf.empty):
                salmon = wolf.iloc[-1]
                salmon.index = salmon.index.astype(str)
                shark = pd.to_numeric(salmon, errors='coerce').astype(float).reindex(koala)
        except Exception:
            pass
        if shark.notna().sum() < 10:
            try:
                zebra = get_factor_values(koala, factors=['term_051'], end_date=pd.Timestamp(camel), count=1)
                bear = zebra.get('term_051', None) if isinstance(zebra, dict) else None
                if isinstance(bear, pd.DataFrame) and (not bear.empty):
                    salmon = bear.iloc[-1]
                    salmon.index = salmon.index.astype(str)
                    tuna = pd.to_numeric(salmon, errors='coerce').astype(float).reindex(koala)
                    shark = shark.where(np.isfinite(shark), tuna)
            except Exception:
                pass
    if shark.notna().sum() < 10:
        turtle = pd.Period(cat, freq='Q-DEC') - 1
        lizard = pd.PeriodIndex([turtle, turtle - 1, turtle - 2, turtle - 3], freq='Q-DEC')
        rabbit = get_history_fundamentals(security=koala, fields=[wolf.term_049], watch_date=cat, count=12, interval='1q', stat_by_year=False)
        if rabbit is not None and (not rabbit.empty):
            otter = rabbit.copy()
            otter['code'] = otter['code'].astype(str)
            otter['statDate'] = pd.to_datetime(otter['statDate'], errors='coerce')
            otter = otter.dropna(subset=['code', 'statDate'])
            if not otter.empty:
                otter['q'] = otter['statDate'].dt.to_period('Q-DEC')
                if 'pubDate' in otter.columns:
                    sparrow = pd.to_datetime(otter['pubDate'], errors='coerce')
                    otter = otter[sparrow.notna() & (sparrow <= cat)]
                otter = otter[otter['q'].isin(lizard)]
                if not otter.empty:
                    otter = otter.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
                    owl = otter.pivot(index='q', columns='code', values='term_049').reindex(index=lizard, columns=koala)
                    owl = owl.apply(pd.to_numeric, errors='coerce').astype(float)
                    whale = owl.sum(axis=0, min_count=1).reindex(koala)
                    shark = shark.where(np.isfinite(shark), whale)
    beaver = _nearest_td_le(fox)
    badger = _nearest_td_le((cat - DateOffset(years=1)).date())
    if beaver is None or badger is None:
        return _make_factor_series({panda: np.nan for panda in koala}, fox, universe=universe, name='factor673')
    frog = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(koala))

    def _cap_on(td_):
        dog = get_fundamentals(q_val, date=pd.Timestamp(td_).strftime('%Y-%m-%d'))
        if dog is None or dog.empty or 'code' not in dog.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        dog = dog.copy()
        dog['code'] = dog['code'].astype(str)
        cat = pd.to_numeric(dog.set_index('code').get('term_008', np.nan), errors='coerce').astype(float)
        return cat.reindex(codes)
    lion = _cap_on(beaver)
    tiger = _cap_on(badger)
    lemur = lion * 10000.0
    alpaca = tiger * 10000.0
    dog = (lemur + alpaca) / 2.0
    dog = dog.where(np.isfinite(dog) & (dog > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = shark / dog
    eagle = ~np.isfinite(hawk) | ~np.isfinite(shark) | ~np.isfinite(dog) | (dog == 0)
    hawk = hawk.where(~eagle, np.nan).reindex(koala)
    dolphin = {panda: float(hawk.get(panda)) if np.isfinite(hawk.get(panda, np.nan)) else np.nan for panda in koala}
    return _make_factor_series(dolphin, fox, universe=universe, name='factor673')

def factor674(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    panda = _to_date(date)
    tiger = get_history_fundamentals(security=dog, fields=[fox.term_084, fox.term_081], watch_date=panda, count=1, interval='1q', stat_by_year=False)
    if tiger is None or tiger.empty:
        lion = {cat: np.nan for cat in dog}
        return _make_factor_series(lion, date, universe=universe, name='factor674')
    tiger = tiger.copy()
    tiger['statDate'] = pd.to_datetime(tiger['statDate'])
    koala = tiger.sort_values(['code', 'statDate']).groupby('code', sort=False).tail(1).set_index('code')
    wolf = pd.to_numeric(koala.get('term_084', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(dog)
    fox = pd.to_numeric(koala.get('term_081', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(dog)
    otter = (wolf / fox.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    lion = {cat: float(otter.get(cat, np.nan)) for cat in dog}
    return _make_factor_series(lion, date, universe=universe, name='factor674')

def factor675(universe, date, T=20, freq='5m', code_chunk=200, large_threshold=800):
    _set_asof_date(date)
    dog = list(universe)
    panda = _to_date(date)
    lion = get_trade_days(end_date=panda, count=int(T))
    if lion is None or len(lion) == 0:
        bear = {cat: np.nan for cat in dog}
        return _make_factor_series(bear, date, universe=universe, name='factor675')
    salmon = freq
    if salmon == '1m' and len(dog) >= int(large_threshold):
        salmon = '5m'
    lizard = [pd.to_datetime(tuna).date() for tuna in lion]
    frog = set(lizard)
    shark = pd.to_datetime(lizard[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(lizard[-1]).strftime('%Y-%m-%d')
    koala = get_price(dog, start_date=shark, end_date=wolf, frequency='daily', fields=['volume'], fq='post', panel=False)
    if koala is None or koala.empty:
        bear = {cat: np.nan for cat in dog}
        return _make_factor_series(bear, date, universe=universe, name='factor675')
    tiger = koala.pivot(index='time', columns='code', values='volume').sort_index()
    tiger.index = pd.to_datetime(tiger.index).date
    tiger = tiger.reindex(index=lizard, columns=dog)
    turtle = []
    for rabbit in range(0, len(dog), int(code_chunk)):
        eagle = dog[rabbit:rabbit + int(code_chunk)]
        otter = get_price(eagle, start_date=shark, end_date=wolf, frequency=salmon, fields=['volume'], fq='post', panel=False)
        if otter is None or otter.empty:
            continue
        otter = otter.copy()
        otter['time'] = pd.to_datetime(otter['time'])
        otter['date'] = otter['time'].dt.date
        otter = otter[otter['date'].isin(frog)]
        if otter.empty:
            continue
        hawk = otter['time'].dt.time
        giraffe = (hawk >= dt.time(14, 30)) & (hawk <= dt.time(15, 0))
        fox = otter.loc[giraffe]
        if fox.empty:
            continue
        whale = fox.groupby(['date', 'code'], sort=False)['volume'].sum()
        turtle.append(whale)
    if not turtle:
        bear = {cat: np.nan for cat in dog}
        return _make_factor_series(bear, date, universe=universe, name='factor675')
    sparrow = pd.concat(turtle).groupby(level=[0, 1], sort=False).sum()
    owl = sparrow.unstack('code').reindex(index=lizard, columns=dog).fillna(0.0)
    dolphin = owl / tiger.replace(0.0, np.nan)
    zebra = dolphin.mean(axis=0, skipna=True)
    bear = {cat: float(zebra.get(cat, np.nan)) for cat in dog}
    return _make_factor_series(bear, date, universe=universe, name='factor675')

def factor676(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor676')

def factor677(universe, date, N=10, M=10):
    _set_asof_date(date)
    lion = list(universe)
    koala = get_trade_days(end_date=date, count=N + M + 5)
    if koala is None or len(koala) < N + M + 2:
        wolf = {tiger: np.nan for tiger in lion}
        return _make_factor_series(wolf, date, universe=universe, name='factor677')
    giraffe = koala[0]
    zebra = pd.to_datetime(giraffe).strftime('%Y-%m-%d')
    otter = get_price(lion, start_date=zebra, end_date=date, frequency='daily', fields=['high', 'low'], fq='post', panel=False)
    if otter is None or otter.empty:
        wolf = {tiger: np.nan for tiger in lion}
        return _make_factor_series(wolf, date, universe=universe, name='factor677')
    bear = otter.pivot(index='time', columns='code', values='high').sort_index()
    rabbit = otter.pivot(index='time', columns='code', values='low').sort_index()
    wolf = {}
    for tiger in lion:
        if tiger not in bear.columns or tiger not in rabbit.columns:
            wolf[tiger] = np.nan
            continue
        fox = (bear[tiger] - rabbit[tiger]).values.astype(float)
        cat = _ema_array(fox, N)
        if cat is None or len(cat) < M + 1:
            wolf[tiger] = np.nan
            continue
        panda = cat[-1]
        dog = cat[-(M + 1)]
        if dog == 0 or np.isnan(panda) or np.isnan(dog):
            wolf[tiger] = 0.0
        else:
            wolf[tiger] = float(100.0 * (panda - dog) / dog)
    return _make_factor_series(wolf, date, universe=universe, name='factor677')

def factor678(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    panda = list(universe)
    lion = _to_date(date)
    koala = get_history_fundamentals(security=panda, fields=[bear.diluted_eps], watch_date=lion, count=8, interval='1q', stat_by_year=False)
    if koala is None or koala.empty:
        otter = {cat: np.nan for cat in panda}
        return _make_factor_series(otter, date, universe=universe, name='factor678')
    koala = koala.copy()
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    koala = koala.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    wolf = int(min_valid_quarters)
    otter = {}
    for dog in panda:
        giraffe = koala[koala['code'] == dog]['diluted_eps'].astype(float).to_numpy()
        if giraffe.size < 8:
            otter[dog] = np.nan
            continue
        giraffe = giraffe[-8:]
        fox = giraffe[:4]
        tiger = giraffe[4:]
        if np.isfinite(fox).sum() < wolf or np.isfinite(tiger).sum() < wolf:
            otter[dog] = np.nan
            continue
        bear = float(np.nansum(fox))
        rabbit = float(np.nansum(tiger))
        if not np.isfinite(bear) or bear == 0.0:
            otter[dog] = np.nan
        else:
            otter[dog] = float((rabbit - bear) / abs(bear))
    return _make_factor_series(otter, date, universe=universe, name='factor678')

def factor679(universe, date, max_lag=10):
    _set_asof_date(date)
    lion = list(universe)
    try:
        koala = get_factor_values(lion, factors=['term_053'], end_date=date, count=max_lag)
        fox = koala['term_053']
    except Exception:
        fox = None
    otter = {}
    if fox is None or fox.empty:
        otter = {tiger: np.nan for tiger in lion}
        return _make_factor_series(otter, date, universe=universe, name='factor679')
    for tiger in lion:
        bear = fox[tiger].dropna().values
        if len(bear) < 5:
            otter[tiger] = np.nan
            continue
        giraffe = bear[1:]
        rabbit = bear[:-1]
        cat = np.column_stack([np.ones(len(rabbit)), rabbit])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, giraffe, rcond=None)
            wolf = giraffe - cat @ panda
            if len(wolf) < 3:
                otter[tiger] = np.nan
            else:
                otter[tiger] = float(np.std(wolf, ddof=1))
        except Exception:
            otter[tiger] = np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor679')

def factor680(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor680')

def factor681(universe, date, industry_name='sw_l1', eps=1.0):
    _set_asof_date(date)
    rabbit = _to_date(date)
    giraffe = pd.Timestamp(rabbit).strftime('%Y-%m-%d')
    wolf = list(universe)
    narwhal = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(wolf))
    whale = get_fundamentals(narwhal, date=giraffe)
    if whale is None or whale.empty or 'code' not in whale.columns or ('term_045' not in whale.columns):
        return _make_factor_series({fox: np.nan for fox in wolf}, rabbit, universe=universe, name='factor681')
    whale = whale.copy()
    whale['code'] = whale['code'].astype(str)
    donkey = pd.to_numeric(whale.set_index('code')['term_045'], errors='coerce').astype(float).reindex(wolf)
    llama = query(fox.code, fox.total_owner_equities, fox.term_084, fox.term_081).filter(fox.code.in_(wolf))
    zebra = get_fundamentals(llama, date=giraffe)
    if zebra is None or zebra.empty or 'code' not in zebra.columns:
        return _make_factor_series({fox: np.nan for fox in wolf}, rabbit, universe=universe, name='factor681')
    zebra = zebra.copy()
    zebra['code'] = zebra['code'].astype(str)
    zebra = zebra.set_index('code')
    koala = pd.to_numeric(zebra.get('total_owner_equities', np.nan), errors='coerce').astype(float).reindex(wolf)
    turkey = pd.to_numeric(zebra.get('term_084', np.nan), errors='coerce').astype(float).reindex(wolf)
    raccoon = pd.to_numeric(zebra.get('term_081', np.nan), errors='coerce').astype(float).reindex(wolf)
    mole = query(bear.code, bear.term_052).filter(bear.code.in_(wolf))
    dolphin = get_fundamentals(mole, date=giraffe)
    if dolphin is None or dolphin.empty or 'code' not in dolphin.columns or ('term_052' not in dolphin.columns):
        return _make_factor_series({fox: np.nan for fox in wolf}, rabbit, universe=universe, name='factor681')
    dolphin = dolphin.copy()
    dolphin['code'] = dolphin['code'].astype(str)
    kangaroo = pd.to_numeric(dolphin.set_index('code')['term_052'], errors='coerce').astype(float).reindex(wolf)
    turtle = get_industry(security=wolf, date=rabbit, df=True)
    if turtle is None or getattr(turtle, 'empty', True):
        lizard = {fox: None for fox in wolf}
        salmon = []
    else:
        turtle = turtle.copy()
        if 'date' in turtle.columns:
            turtle = turtle.drop(columns=['date'], errors='ignore')
        if 'type' in turtle.columns:
            turtle = turtle[turtle['type'].astype(str) == str(industry_name)]
        if turtle.empty or 'code' not in turtle.columns or 'industry_code' not in turtle.columns:
            lizard = {fox: None for fox in wolf}
            salmon = []
        else:
            turtle['code'] = turtle['code'].astype(str)
            turtle['industry_code'] = turtle['industry_code'].astype(str)
            lizard = turtle.drop_duplicates('code', keep='last').set_index('code')['industry_code'].to_dict()
            salmon = sorted({lizard.get(fox) for fox in wolf if lizard.get(fox) is not None})
    owl = {sparrow: tuna for tuna, sparrow in enumerate(salmon)}
    gecko = len(salmon)
    camel = []
    dog = []
    bear = []
    for fox in wolf:
        ferret = donkey.get(fox, np.nan)
        otter = koala.get(fox, np.nan)
        urchin = turkey.get(fox, np.nan)
        seal = raccoon.get(fox, np.nan)
        jaguar = kangaroo.get(fox, np.nan)
        if not np.isfinite(ferret) or ferret <= 0:
            continue
        if not np.isfinite(otter) or otter <= 0:
            continue
        if not np.isfinite(seal) or seal <= 0:
            continue
        if not np.isfinite(urchin):
            continue
        if not np.isfinite(jaguar):
            continue
        beaver = float(np.log(ferret))
        lion = float(np.log(otter))
        iguana = max(float(jaguar), 0.0)
        hyena = max(-float(jaguar), 0.0)
        badger = float(np.log(iguana + float(eps)))
        lemur = float(np.log(hyena + float(eps)))
        alpaca = float(urchin) / float(seal)
        frog = np.zeros(gecko, dtype=float)
        eagle = lizard.get(fox, None)
        if eagle is not None and eagle in owl:
            frog[owl[eagle]] = 1.0
        quail = np.concatenate([[1.0], frog, [lion, badger, lemur, alpaca]])
        camel.append(beaver)
        dog.append(quail)
        bear.append(fox)
    if len(bear) < 10:
        return _make_factor_series({fox: np.nan for fox in wolf}, rabbit, universe=universe, name='factor681')
    cat = np.vstack(dog)
    vulture = np.array(camel, dtype=float)
    try:
        tiger, panda, panda, panda = np.linalg.lstsq(cat, vulture, rcond=None)
        penguin = vulture - cat.dot(tiger)
        octopus = {bear[hawk]: float(penguin[hawk]) for hawk in range(len(bear)) if np.isfinite(penguin[hawk])}
    except Exception:
        octopus = {}
    shark = {fox: octopus.get(fox, np.nan) for fox in wolf}
    return _make_factor_series(shark, rabbit, universe=universe, name='factor681')

def factor682(universe, date):
    _set_asof_date(date)
    tiger = list(universe)
    lion = _to_date(date)
    zebra = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(tiger))
    otter = get_fundamentals(zebra, date=lion)
    if otter is None or otter.empty:
        fox = {dog: np.nan for dog in tiger}
        return _make_factor_series(fox, date, universe=universe, name='factor682')
    otter = otter.set_index('code')
    bear = otter['term_045'].astype(float).reindex(tiger)
    koala = get_history_fundamentals(security=tiger, fields=[fox.term_084, fox.term_012, fox.term_092], watch_date=lion, count=1, interval='1q', stat_by_year=False)
    if koala is None or koala.empty:
        fox = {dog: np.nan for dog in tiger}
        return _make_factor_series(fox, date, universe=universe, name='factor682')
    koala = koala.copy()
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    wolf = koala.sort_values(['code', 'statDate']).groupby('code', sort=False).tail(1).set_index('code')
    dolphin = pd.to_numeric(wolf.get('term_084', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(tiger)
    panda = pd.to_numeric(wolf.get('term_012', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(tiger).fillna(0.0)
    whale = pd.to_numeric(wolf.get('term_092', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(tiger).fillna(0.0)
    cat = (bear + dolphin - (panda + whale)).replace([np.inf, -np.inf], np.nan)
    giraffe = pd.Series(np.nan, index=tiger, dtype='float64')
    rabbit = np.isfinite(cat.values) & (cat.values > 0.0)
    giraffe.loc[rabbit] = np.log(cat.loc[rabbit].values)
    fox = {dog: float(giraffe.get(dog, np.nan)) for dog in tiger}
    return _make_factor_series(fox, date, universe=universe, name='factor682')

def factor683(universe, date):
    _set_asof_date(date)
    lion = list(universe)
    koala = _to_date(date)
    otter = get_history_fundamentals(security=lion, fields=[fox.term_082, fox.term_012, fox.term_092, fox.term_081], watch_date=koala, count=5, interval='1q', stat_by_year=False)
    if otter is None or otter.empty:
        wolf = {dog: np.nan for dog in lion}
        return _make_factor_series(wolf, date, universe=universe, name='factor683')
    otter = otter.copy()
    otter['statDate'] = pd.to_datetime(otter['statDate'])
    otter = otter.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    wolf = {}
    for tiger in lion:
        fox = otter[otter['code'] == tiger]
        if fox.shape[0] < 5:
            wolf[tiger] = np.nan
            continue
        zebra = fox['term_082'].astype(float).to_numpy()[-5:]
        panda = fox['term_012'].astype(float).to_numpy()[-5:]
        dolphin = fox['term_092'].astype(float).to_numpy()[-5:]
        giraffe = fox['term_081'].astype(float).to_numpy()[-5:]
        if not np.isfinite(giraffe[-1]) or not np.isfinite(giraffe[-2]) or giraffe[-1] == 0.0:
            wolf[tiger] = np.nan
            continue

        def _ola(i):
            if not np.isfinite(tca[i]):
                return np.nan
            cat = 0.0 if not np.isfinite(term_009[i]) else term_009[i]
            dog = 0.0 if not np.isfinite(trad[i]) else trad[i]
            return float(tca[i] - cat - dog)
        rabbit = _ola(-1)
        bear = _ola(0)
        if not np.isfinite(rabbit) or not np.isfinite(bear):
            wolf[tiger] = np.nan
            continue
        cat = (giraffe[-1] + giraffe[-2]) / 2.0
        if not np.isfinite(cat) or cat == 0.0:
            wolf[tiger] = np.nan
        else:
            wolf[tiger] = float((rabbit - bear) / cat)
    return _make_factor_series(wolf, date, universe=universe, name='factor683')

def factor684(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    lion = list(universe)
    rabbit = query(fox.code, fox.term_082).filter(fox.code.in_(lion))
    bear = query(fox.code, fox.term_001, fox.term_005).filter(fox.code.in_(lion))
    try:
        fox = get_fundamentals(rabbit, date=koala)
    except Exception:
        fox = pd.DataFrame(columns=['code', 'term_082'])
    try:
        otter = get_fundamentals(bear, date=koala)
    except Exception:
        otter = pd.DataFrame(columns=['code', 'term_001', 'term_005'])
    if fox is None or fox.empty or 'code' not in fox.columns:
        fox = pd.DataFrame(columns=['code', 'term_082'])
    if otter is None or otter.empty or 'code' not in otter.columns:
        otter = pd.DataFrame(columns=['code', 'term_001', 'term_005'])
    fox = fox.set_index('code') if 'code' in fox.columns else pd.DataFrame(index=pd.Index([], name='code'))
    otter = otter.set_index('code') if 'code' in otter.columns else pd.DataFrame(index=pd.Index([], name='code'))
    dog = pd.DataFrame(index=pd.Index(lion, name='code'))
    dog = dog.join(fox[['term_082']] if 'term_082' in fox.columns else pd.DataFrame(index=dog.index), how='left')
    dog = dog.join(otter[['term_001', 'term_005']] if 'term_001' in otter.columns or 'term_005' in otter.columns else pd.DataFrame(index=dog.index), how='left')
    giraffe = pd.to_numeric(dog.get('term_082', np.nan), errors='coerce')
    cat = pd.to_numeric(dog.get('term_001', np.nan), errors='coerce')
    panda = pd.to_numeric(dog.get('term_005', np.nan), errors='coerce')
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = (cat + panda) / giraffe
    zebra = zebra.where(np.isfinite(zebra) & (giraffe != 0), np.nan)
    wolf = {tiger: float(zebra.get(tiger)) if np.isfinite(zebra.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(wolf, date, universe=universe, name='factor684')

def factor685(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor685')

def factor686(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor686')

def factor687(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    panda = _to_date(date)
    try:
        tiger = get_factor_values(dog, factors=['term_051', 'term_053'], end_date=panda, count=1)
    except Exception:
        tiger = None
    if tiger is None or 'term_051' not in tiger or 'term_053' not in tiger:
        lion = {cat: np.nan for cat in dog}
        return _make_factor_series(lion, date, universe=universe, name='factor687')
    otter = tiger['term_051'].iloc[-1].reindex(dog).astype(float) if tiger['term_051'] is not None and (not tiger['term_051'].empty) else pd.Series(np.nan, index=dog)
    koala = tiger['term_053'].iloc[-1].reindex(dog).astype(float) if tiger['term_053'] is not None and (not tiger['term_053'].empty) else pd.Series(np.nan, index=dog)
    fox = (otter / koala.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    lion = {cat: float(fox.get(cat, np.nan)) for cat in dog}
    return _make_factor_series(lion, date, universe=universe, name='factor687')

def factor688(universe, date, N1=10, N2=3):
    _set_asof_date(date)
    bear = list(universe)
    lizard = N1 * 4 + N2 + 5
    rabbit = get_trade_days(end_date=date, count=lizard)
    if rabbit is None or len(rabbit) < N1 + N2 + 5:
        dolphin = {wolf: np.nan for wolf in bear}
        return _make_factor_series(dolphin, date, universe=universe, name='factor688')
    sparrow = rabbit[0]
    owl = pd.to_datetime(sparrow).strftime('%Y-%m-%d')
    zebra = get_price(bear, start_date=owl, end_date=date, frequency='daily', fields=['high', 'low', 'close', 'volume'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        dolphin = {wolf: np.nan for wolf in bear}
        return _make_factor_series(dolphin, date, universe=universe, name='factor688')
    whale = zebra.pivot(index='time', columns='code', values='high').sort_index()
    shark = zebra.pivot(index='time', columns='code', values='low').sort_index()
    fox = zebra.pivot(index='time', columns='code', values='close').sort_index()
    turtle = zebra.pivot(index='time', columns='code', values='volume').sort_index()
    dolphin = {}
    for wolf in bear:
        if wolf not in whale.columns or wolf not in turtle.columns:
            dolphin[wolf] = np.nan
            continue
        tiger = whale[wolf].values.astype(float)
        lion = shark[wolf].values.astype(float)
        cat = fox[wolf].values.astype(float)
        otter = turtle[wolf].values.astype(float)
        giraffe = tiger + lion
        hawk = np.zeros_like(cat, dtype=float)
        eagle = giraffe != 0
        hawk[eagle] = otter[eagle] * (2 * cat[eagle] - tiger[eagle] - lion[eagle]) / giraffe[eagle]
        if len(hawk) < N1 + N2 + 2:
            dolphin[wolf] = np.nan
            continue
        koala = pd.Series(hawk).rolling(N1).sum().values
        koala = np.nan_to_num(koala)
        panda = _ema_array(koala, N1)
        dog = _ema_array(koala, N2)
        dolphin[wolf] = float(panda[-1] - dog[-1])
    return _make_factor_series(dolphin, date, universe=universe, name='factor688')

def factor689(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    lion = list(universe)
    turtle = pd.Period(cat, freq='Q-DEC') - 1
    owl = pd.PeriodIndex([turtle], freq='Q-DEC')
    wolf = get_history_fundamentals(security=lion, fields=[fox.total_owner_equities, fox.term_077, fox.term_044, fox.term_006, fox.term_093, fox.term_012, fox.term_092, fox.term_031, fox.hold_to_maturity_investments], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or 'code' not in wolf.columns or ('statDate' not in wolf.columns):
        return _make_factor_series({panda: np.nan for panda in lion}, otter, universe=universe, name='factor689')
    koala = wolf.copy()
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty:
        return _make_factor_series({panda: np.nan for panda in lion}, otter, universe=universe, name='factor689')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(owl)]
    if koala.empty:
        return _make_factor_series({panda: np.nan for panda in lion}, otter, universe=universe, name='factor689')
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')

    def _pivot(col):
        if col not in d.columns:
            return pd.DataFrame(index=q_need, columns=codes, dtype='float64')
        cat = d.pivot(index='q', columns='code', values=col).reindex(index=q_need, columns=codes)
        return cat.apply(pd.to_numeric, errors='coerce').astype(float)
    rabbit = _pivot('total_owner_equities')
    lizard = _pivot('term_077').fillna(0.0)
    hawk = _pivot('term_044').fillna(0.0)
    dog = _pivot('term_006').fillna(0.0)
    salmon = _pivot('term_093').fillna(0.0)
    tiger = _pivot('term_012').fillna(0.0)
    frog = _pivot('term_092').fillna(0.0)
    whale = _pivot('term_031').fillna(0.0)
    shark = _pivot('hold_to_maturity_investments').fillna(0.0)
    bear = rabbit.loc[turtle] if turtle in rabbit.index else pd.Series(np.nan, index=lion, dtype='float64')
    bear = bear.where(np.isfinite(bear), np.nan)
    fox = lizard.loc[turtle] + hawk.loc[turtle] + dog.loc[turtle] + salmon.loc[turtle] if turtle in lizard.index else pd.Series(np.nan, index=lion, dtype='float64')
    dolphin = tiger.loc[turtle] + frog.loc[turtle] + whale.loc[turtle] + shark.loc[turtle] if turtle in tiger.index else pd.Series(np.nan, index=lion, dtype='float64')
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = fox / (fox + bear)
        zebra = dolphin / (dolphin + bear)
        sparrow = eagle - zebra
    sparrow = sparrow.replace([np.inf, -np.inf], np.nan)
    sparrow = sparrow.where(np.isfinite(bear), np.nan).reindex(lion)
    giraffe = {panda: float(sparrow.get(panda)) if np.isfinite(sparrow.get(panda, np.nan)) else np.nan for panda in lion}
    return _make_factor_series(giraffe, otter, universe=universe, name='factor689')

def factor690(universe, date, K_months=6):
    _set_asof_date(date)
    dog = list(universe)
    panda = get_trade_days(end_date=date, count=K_months * 21)
    if panda is None or len(panda) == 0:
        koala = {cat: np.nan for cat in dog}
        return _make_factor_series(koala, date, universe=universe, name='factor690')
    rabbit = panda[0]
    giraffe = pd.to_datetime(rabbit).strftime('%Y-%m-%d')
    lion = pd.to_datetime(panda[-1]).strftime('%Y-%m-%d')
    tiger = get_price(dog, start_date=giraffe, end_date=lion, frequency='daily', fields=['money'], fq='post', panel=False)
    if tiger is None or tiger.empty:
        koala = {cat: np.nan for cat in dog}
        return _make_factor_series(koala, date, universe=universe, name='factor690')
    otter = tiger.pivot(index='time', columns='code', values='money').sort_index()
    koala = {}
    for cat in dog:
        if cat not in otter.columns:
            koala[cat] = np.nan
            continue
        wolf = otter[cat].dropna()
        if len(wolf) < 5:
            koala[cat] = np.nan
            continue
        fox = wolf.mean()
        bear = wolf.std(ddof=1)
        if fox == 0 or np.isnan(fox):
            koala[cat] = 0.0
        else:
            koala[cat] = float(bear / fox)
    return _make_factor_series(koala, date, universe=universe, name='factor690')

def factor691(universe, date, N_months=12, skip_months=1, lookback_days=None, min_cross_section=3):
    _set_asof_date(date)
    koala = list(universe)
    otter = _to_date(date)
    if lookback_days is None:
        lookback_days = int((N_months + skip_months + 2) * 21)
    fox = get_trade_days(end_date=otter, count=int(lookback_days))
    if fox is None or len(fox) < 40:
        zebra = {tiger: np.nan for tiger in koala}
        return _make_factor_series(zebra, date, universe=universe, name='factor691')
    turtle = pd.to_datetime(fox[0]).strftime('%Y-%m-%d')
    giraffe = pd.to_datetime(otter).strftime('%Y-%m-%d')
    rabbit = get_price(koala, start_date=turtle, end_date=giraffe, frequency='daily', fields=['close'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        zebra = {tiger: np.nan for tiger in koala}
        return _make_factor_series(zebra, date, universe=universe, name='factor691')
    lion = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    eagle = lion.pct_change()
    hawk = eagle.rank(axis=1, method='average', na_option='keep')
    cat = eagle.notna().sum(axis=1).astype(float)
    whale = (cat + 1.0) / 2.0
    bear = (cat + 1.0) * (cat - 1.0) / 12.0
    bear = bear.where(bear > 0.0, np.nan)
    wolf = np.sqrt(bear)
    sparrow = hawk.sub(whale, axis=0).div(wolf, axis=0)
    if min_cross_section is not None and int(min_cross_section) > 0:
        panda = cat < float(min_cross_section)
        if panda.any():
            sparrow.loc[panda, :] = np.nan
    dolphin = pd.to_datetime(sparrow.index).to_period('M')
    owl = sparrow.groupby(dolphin).mean()
    dog = owl.index.tolist()
    if len(dog) < int(N_months) + int(skip_months):
        zebra = {tiger: np.nan for tiger in koala}
        return _make_factor_series(zebra, date, universe=universe, name='factor691')
    if int(skip_months) > 0:
        lizard = dog[-(int(N_months) + int(skip_months)):-int(skip_months)]
    else:
        lizard = dog[-int(N_months):]
    shark = owl.loc[lizard].mean(axis=0, skipna=True).reindex(koala)
    shark = shark.replace([np.inf, -np.inf], np.nan)
    zebra = {tiger: float(shark.get(tiger, np.nan)) for tiger in koala}
    return _make_factor_series(zebra, date, universe=universe, name='factor691')

def factor692(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    tiger = list(universe)
    lion = _to_date(date)
    otter = get_history_fundamentals(security=tiger, fields=[wolf.term_028], watch_date=lion, count=4, interval='1q', stat_by_year=False)
    fox = get_history_fundamentals(security=tiger, fields=[bear.term_066], watch_date=lion, count=4, interval='1q', stat_by_year=False)
    koala = _r3_merge_history_fundamentals(otter, fox)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor692')
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    rabbit = int(min_valid_quarters)
    bear = {}
    for panda in tiger:
        wolf = koala[koala['code'] == panda]
        dog = wolf['term_028'].astype(float).to_numpy()[-4:]
        zebra = wolf['term_066'].astype(float).to_numpy()[-4:]
        if np.isfinite(dog).sum() < rabbit or np.isfinite(zebra).sum() < rabbit:
            bear[panda] = np.nan
            continue
        cat = float(np.nansum(dog))
        giraffe = float(np.nansum(zebra))
        if not np.isfinite(giraffe) or giraffe == 0.0:
            bear[panda] = np.nan
        else:
            bear[panda] = float(cat / giraffe)
    return _make_factor_series(bear, date, universe=universe, name='factor692')

def factor693(universe, date):
    _set_asof_date(date)
    tiger = pd.to_datetime(date)
    panda = list(universe)
    giraffe = tiger.to_period('M')
    zebra = giraffe - 1
    whale = zebra.to_timestamp('M').replace(day=1)
    dolphin = zebra.to_timestamp('M')
    rabbit = get_trade_days(start_date=whale, end_date=dolphin)
    if rabbit is None or len(rabbit) < 2:
        fox = {dog: np.nan for dog in panda}
        return _make_factor_series(fox, date, universe=universe, name='factor693')
    eagle = rabbit[0]
    koala = rabbit[-1]
    hawk = pd.to_datetime(eagle).strftime('%Y-%m-%d')
    otter = pd.to_datetime(koala).strftime('%Y-%m-%d')
    lion = get_price(panda, start_date=hawk, end_date=otter, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        fox = {dog: np.nan for dog in panda}
        return _make_factor_series(fox, date, universe=universe, name='factor693')
    cat = lion.pivot(index='time', columns='code', values='close').sort_index()
    wolf = cat.iloc[0]
    bear = cat.iloc[-1]
    shark = bear / wolf - 1.0
    fox = {dog: -float(shark.get(dog, np.nan)) for dog in panda}
    return _make_factor_series(fox, date, universe=universe, name='factor693')

def factor694(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor694')

def factor695(universe, date, N1=5, N2=16, N3=17):
    _set_asof_date(date)
    otter = list(universe)
    hawk = N1 + N2 + N3 + 10
    fox = get_trade_days(end_date=date, count=hawk)
    if fox is None or len(fox) < hawk:
        bear = {koala: np.nan for koala in otter}
        return _make_factor_series(bear, date, universe=universe, name='factor695')
    shark = fox[0]
    eagle = pd.to_datetime(shark).strftime('%Y-%m-%d')
    wolf = get_price(otter, start_date=eagle, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if wolf is None or wolf.empty:
        bear = {koala: np.nan for koala in otter}
        return _make_factor_series(bear, date, universe=universe, name='factor695')
    tiger = wolf.pivot(index='time', columns='code', values='close').sort_index()
    bear = {}
    for koala in otter:
        if koala not in tiger.columns:
            bear[koala] = np.nan
            continue
        dolphin = tiger[koala].dropna()
        if len(dolphin) < N1 + N2 + N3:
            bear[koala] = np.nan
            continue
        lion = dolphin.values.astype(float)
        whale = pd.Series(lion).rolling(N1).mean().values
        cat = np.zeros_like(lion, dtype=float)
        zebra = whale != 0
        cat[zebra] = (lion[zebra] - whale[zebra]) / whale[zebra]
        dog = np.full_like(cat, np.nan, dtype=float)
        for rabbit in range(len(cat)):
            giraffe = rabbit - N2
            if giraffe < 0:
                continue
            if np.isnan(cat[rabbit]) or np.isnan(cat[giraffe]):
                continue
            dog[rabbit] = cat[rabbit] - cat[giraffe]
        panda = np.full_like(dog, np.nan, dtype=float)
        for rabbit, sparrow in enumerate(dog):
            if np.isnan(sparrow):
                continue
            if rabbit == 0 or np.isnan(panda[rabbit - 1]):
                panda[rabbit] = sparrow
            else:
                panda[rabbit] = (sparrow + (N3 - 1) * panda[rabbit - 1]) / N3
        bear[koala] = float(panda[-1])
    return _make_factor_series(bear, date, universe=universe, name='factor695')

def factor696(universe, date):
    _set_asof_date(date)
    lion = list(universe)
    koala = _to_date(date)
    try:
        wolf = get_factor_values(lion, factors=['term_051'], end_date=koala, count=1)
    except Exception:
        wolf = None
    if wolf is None or 'term_051' not in wolf or wolf['term_051'] is None or wolf['term_051'].empty:
        bear = {panda: np.nan for panda in lion}
        return _make_factor_series(bear, date, universe=universe, name='factor696')
    rabbit = wolf['term_051'].iloc[-1].reindex(lion).astype(float)
    otter = get_history_fundamentals(security=lion, fields=[fox.term_081], watch_date=koala, count=2, interval='1q', stat_by_year=False)
    if otter is None or otter.empty:
        bear = {panda: np.nan for panda in lion}
        return _make_factor_series(bear, date, universe=universe, name='factor696')
    otter = otter.copy()
    otter['statDate'] = pd.to_datetime(otter['statDate'])
    otter = otter.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    zebra = pd.Series(np.nan, index=lion, dtype='float64')
    for tiger in lion:
        fox = otter[otter['code'] == tiger].tail(2)
        if fox.shape[0] < 2:
            continue
        cat = float(fox.iloc[0].get('term_081', np.nan))
        dog = float(fox.iloc[1].get('term_081', np.nan))
        if np.isfinite(cat) and np.isfinite(dog):
            zebra.loc[tiger] = (cat + dog) / 2.0
    giraffe = (rabbit / zebra.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    bear = {panda: float(giraffe.get(panda, np.nan)) for panda in lion}
    return _make_factor_series(bear, date, universe=universe, name='factor696')

def factor697(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor697')

def factor698(universe, date, window_days=60):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = get_trade_days(end_date=koala, count=window_days + 1)
    if otter is None or len(otter) < window_days + 1:
        return _make_factor_series({}, date, universe=universe, name='factor698')
    dolphin = pd.to_datetime(otter[0]).date()
    zebra = pd.to_datetime(otter[-1]).date()
    rabbit = '000905.XSHG'
    hawk = [rabbit] + list(universe)
    fox = get_price(hawk, start_date=pd.to_datetime(dolphin).strftime('%Y-%m-%d'), end_date=pd.to_datetime(zebra).strftime('%Y-%m-%d'), frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty or 'code' not in fox.columns:
        return _make_factor_series({}, date, universe=universe, name='factor698')
    tiger = fox.pivot(index='time', columns='code', values='close').sort_index()
    if rabbit not in tiger.columns or tiger.shape[0] < 5:
        return _make_factor_series({}, date, universe=universe, name='factor698')
    eagle = tiger.pct_change()
    shark = eagle[rabbit]
    bear = {}
    for lion in universe:
        if lion not in eagle.columns:
            continue
        whale = eagle[lion]
        giraffe = whale.notna() & shark.notna()
        if giraffe.sum() < 10:
            continue
        turtle = whale[giraffe].values.astype(float)
        owl = shark[giraffe].values.astype(float)
        cat = np.column_stack([np.ones_like(owl), owl])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, turtle, rcond=None)
        except np.linalg.LinAlgError:
            continue
        wolf = turtle - cat.dot(panda)
        if wolf.size < 2:
            continue
        sparrow = float(np.nanstd(wolf, ddof=1))
        if np.isfinite(sparrow):
            bear[lion] = sparrow
    return _make_factor_series(bear, date, universe=universe, name='factor698')

def factor699(universe, date, bench_index='000905.XSHG', months=3, k=1.5):
    _set_asof_date(date)
    fox = list(universe)
    wolf = get_trade_days(end_date=date, count=months * 21 + 1)
    if wolf is None or len(wolf) < 40:
        giraffe = {otter: np.nan for otter in fox}
        return _make_factor_series(giraffe, date, universe=universe, name='factor699')
    owl = wolf[0]
    turtle = pd.to_datetime(owl).strftime('%Y-%m-%d')
    bear = get_price(fox + [bench_index], start_date=turtle, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if bear is None or bear.empty:
        giraffe = {otter: np.nan for otter in fox}
        return _make_factor_series(giraffe, date, universe=universe, name='factor699')
    dolphin = bear.pivot(index='time', columns='code', values='close').sort_index()
    whale = dolphin.pct_change()
    if bench_index not in whale.columns:
        giraffe = {otter: np.nan for otter in fox}
        return _make_factor_series(giraffe, date, universe=universe, name='factor699')
    hawk = whale[bench_index]
    giraffe = {}
    for otter in fox:
        if otter not in whale.columns:
            giraffe[otter] = np.nan
            continue
        shark = whale[otter]
        zebra = ~(hawk.isna() | shark.isna())
        if zebra.sum() < 20:
            giraffe[otter] = np.nan
            continue
        eagle = hawk[zebra].values
        frog = shark[zebra].values
        tiger = np.column_stack([np.ones(len(eagle)), eagle, eagle ** 2])
        try:
            koala, lion, lion, lion = np.linalg.lstsq(tiger, frog, rcond=None)
            rabbit = frog - tiger @ koala
            if rabbit.size < 3:
                giraffe[otter] = np.nan
                continue
            sparrow = np.std(rabbit, ddof=1)
            if sparrow == 0 or np.isnan(sparrow):
                giraffe[otter] = np.nan
                continue
            lizard = rabbit / sparrow
            cat = len(lizard)
            panda = (lizard >= k).sum() / cat
            dog = (lizard <= -k).sum() / cat
            giraffe[otter] = float(panda - dog)
        except Exception:
            giraffe[otter] = np.nan
    return _make_factor_series(giraffe, date, universe=universe, name='factor699')

def factor700(universe, date):
    _set_asof_date(date)
    tiger = list(universe)
    lion = pd.to_datetime(date)
    otter = pd.Period(lion, freq='Q-DEC')

    def _quality_score(universe, end_date):
        fox = ['roe_ttm', 'roa_ttm', 'gross_income_ratio', 'term_064', 'debt_to_asset_ratio', 'current_ratio', 'term_050']
        try:
            otter = get_factor_values(universe, factors=fox, end_date=end_date, count=1)
        except Exception:
            return {panda: np.nan for panda in universe}
        lion = {}
        for wolf in fox:
            koala = otter.get(wolf, None)
            if koala is None or koala.empty:
                lion[wolf] = pd.Series(np.nan, index=universe)
            else:
                bear = koala.iloc[-1]
                lion[wolf] = bear.reindex(universe)
        cat = pd.DataFrame(lion, index=universe)

        def zscore_col(s):
            s = s.copy()
            dog = ~s.isna()
            if dog.sum() < 3:
                return s * np.nan
            cat = s[dog].mean()
            panda = s[dog].std(ddof=1)
            if panda == 0 or np.isnan(panda):
                s[dog] = 0.0
            else:
                s[dog] = (s[dog] - cat) / panda
            return s
        for tiger in cat.columns:
            cat[tiger] = zscore_col(cat[tiger])
        if 'debt_to_asset_ratio' in cat.columns:
            cat['debt_to_asset_ratio'] = -cat['debt_to_asset_ratio']
        dog = cat.sum(axis=1)
        return {panda: dog.get(panda, np.nan) for panda in universe}
    rabbit = pd.Period(otter).end_time.strftime('%Y-%m-%d')
    bear = pd.Period(otter - 4).end_time.strftime('%Y-%m-%d')
    dog = _quality_score(tiger, rabbit)
    cat = _quality_score(tiger, bear)
    koala = {}
    for panda in tiger:
        wolf = dog.get(panda, np.nan)
        fox = cat.get(panda, np.nan)
        if np.isnan(wolf) or np.isnan(fox) or fox == 0:
            koala[panda] = np.nan
        else:
            koala[panda] = (wolf - fox) / abs(fox)
    return _make_factor_series(koala, date, universe=universe, name='factor700')

def factor701(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    lion = get_history_fundamentals(security=panda, fields=[bear.term_076, bear.term_066], watch_date=tiger, count=4, interval='1q', stat_by_year=False)
    if lion is None or lion.empty:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor701')
    lion = lion.copy()
    lion['statDate'] = pd.to_datetime(lion['statDate'])
    lion = lion.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    fox = int(min_valid_quarters)
    otter = {}
    for dog in panda:
        koala = lion[lion['code'] == dog].tail(4)
        rabbit = pd.to_numeric(koala.get('term_076', pd.Series(dtype='float64')), errors='coerce').astype(float).to_numpy()
        wolf = pd.to_numeric(koala.get('term_066', pd.Series(dtype='float64')), errors='coerce').astype(float).to_numpy()
        if np.isfinite(rabbit).sum() < fox or np.isfinite(wolf).sum() < fox:
            otter[dog] = np.nan
            continue
        giraffe = float(np.nansum(rabbit))
        bear = float(np.nansum(wolf))
        if not np.isfinite(bear) or bear == 0.0:
            otter[dog] = np.nan
        else:
            otter[dog] = float(giraffe / bear)
    return _make_factor_series(otter, date, universe=universe, name='factor701')

def factor702(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor702')

def factor703(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    koala = _to_date(date)
    lion = list(universe)
    hawk = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(lion))
    fox = get_fundamentals(hawk, date=koala)
    if fox is None or fox.empty:
        return _make_factor_series({dog: np.nan for dog in lion}, date, universe=universe, name='factor703')
    fox = fox.set_index('code')
    shark = pd.to_numeric(fox.get('term_045', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion)
    otter = get_history_fundamentals(security=lion, fields=[fox.term_084, fox.term_012, fox.term_092], watch_date=koala, count=1, interval='1q', stat_by_year=False)
    if otter is None or otter.empty:
        return _make_factor_series({dog: np.nan for dog in lion}, date, universe=universe, name='factor703')
    otter = otter.copy()
    otter['statDate'] = pd.to_datetime(otter['statDate'])
    whale = otter.sort_values(['code', 'statDate']).groupby('code', sort=False).tail(1).set_index('code')
    sparrow = pd.to_numeric(whale.get('term_084', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion)
    panda = pd.to_numeric(whale.get('term_012', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion).fillna(0.0)
    owl = pd.to_numeric(whale.get('term_092', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion).fillna(0.0)
    cat = (shark + sparrow - (panda + owl)).replace([np.inf, -np.inf], np.nan)
    rabbit = None
    try:
        zebra = get_factor_values(lion, factors=['EBITDA'], end_date=koala, count=1)
        if zebra is not None and 'EBITDA' in zebra and (zebra['EBITDA'] is not None) and (not zebra['EBITDA'].empty):
            rabbit = zebra['EBITDA'].iloc[-1].reindex(lion).astype(float)
            if rabbit.isna().all():
                rabbit = None
    except Exception:
        rabbit = None
    if rabbit is None:
        wolf = get_history_fundamentals(security=lion, fields=[bear.term_063], watch_date=koala, count=4, interval='1q', stat_by_year=False)
        if wolf is None or wolf.empty:
            return _make_factor_series({dog: np.nan for dog in lion}, date, universe=universe, name='factor703')
        wolf = wolf.copy()
        wolf['statDate'] = pd.to_datetime(wolf['statDate'])
        wolf = wolf.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        eagle = int(min_valid_quarters)
        rabbit = pd.Series(np.nan, index=lion, dtype='float64')
        for tiger in lion:
            turtle = wolf[wolf['code'] == tiger].tail(4)['term_063'].astype(float).to_numpy()
            if np.isfinite(turtle).sum() < eagle:
                continue
            rabbit.loc[tiger] = float(np.nansum(turtle))
    dolphin = {}
    for tiger in lion:
        giraffe = float(cat.get(tiger, np.nan))
        bear = float(rabbit.get(tiger, np.nan))
        if not np.isfinite(giraffe) or not np.isfinite(bear) or bear == 0.0 or (giraffe <= 0.0):
            dolphin[tiger] = np.nan
        else:
            dolphin[tiger] = float(giraffe / bear)
    return _make_factor_series(dolphin, date, universe=universe, name='factor703')

def factor704(universe, date, bench_index='000905.XSHG', months=3, k=1.5):
    _set_asof_date(date)
    cat = factor699(universe, date, bench_index=bench_index, months=months, k=k)
    cat = cat.copy()
    cat.name = 'factor704'
    return cat

def factor705(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    zebra = None
    wolf = None
    try:
        otter = get_factor_values(panda, factors=['term_051', 'term_022'], end_date=tiger, count=1)
        if otter is not None:
            if 'term_051' in otter and otter['term_051'] is not None and (not otter['term_051'].empty):
                zebra = otter['term_051'].iloc[-1].reindex(panda).astype(float)
                if zebra.isna().all():
                    zebra = None
            if 'term_022' in otter and otter['term_022'] is not None and (not otter['term_022'].empty):
                wolf = otter['term_022'].iloc[-1].reindex(panda).astype(float)
                if wolf.isna().all():
                    wolf = None
    except Exception:
        zebra = None
        wolf = None
    rabbit = int(min_valid_quarters)
    if zebra is None:
        koala = get_history_fundamentals(security=panda, fields=[wolf.term_049], watch_date=tiger, count=4, interval='1q', stat_by_year=False)
        if koala is None or koala.empty:
            return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor705')
        koala = koala.copy()
        koala['statDate'] = pd.to_datetime(koala['statDate'])
        koala = koala.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        zebra = pd.Series(np.nan, index=panda, dtype='float64')
        for dog in panda:
            dolphin = koala[koala['code'] == dog].tail(4)['term_049'].astype(float).to_numpy()
            if np.isfinite(dolphin).sum() < rabbit:
                continue
            zebra.loc[dog] = float(np.nansum(dolphin))
    if wolf is None:
        lion = get_history_fundamentals(security=panda, fields=[bear.term_021], watch_date=tiger, count=4, interval='1q', stat_by_year=False)
        if lion is None or lion.empty:
            return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor705')
        lion = lion.copy()
        lion['statDate'] = pd.to_datetime(lion['statDate'])
        lion = lion.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        wolf = pd.Series(np.nan, index=panda, dtype='float64')
        for dog in panda:
            dolphin = lion[lion['code'] == dog].tail(4)['term_021'].astype(float).to_numpy()
            if np.isfinite(dolphin).sum() < rabbit:
                continue
            wolf.loc[dog] = float(np.nansum(dolphin))
    fox = {}
    for dog in panda:
        giraffe = float(zebra.get(dog, np.nan))
        bear = float(wolf.get(dog, np.nan))
        if not np.isfinite(giraffe) or not np.isfinite(bear) or bear == 0.0:
            fox[dog] = np.nan
        else:
            fox[dog] = float(giraffe / bear)
    return _make_factor_series(fox, date, universe=universe, name='factor705')

def factor706(universe, date, N=12):
    _set_asof_date(date)
    lion = _to_date(date)
    tiger = list(universe)
    koala = get_trade_days(end_date=lion, count=N + 1)
    if koala is None or len(koala) < N + 1:
        return _make_factor_series({dog: np.nan for dog in tiger}, date, universe=universe, name='factor706')
    giraffe = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(koala[-1]).strftime('%Y-%m-%d')
    otter = get_price(tiger, start_date=giraffe, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({dog: np.nan for dog in tiger}, date, universe=universe, name='factor706')
    panda = otter.pivot(index='time', columns='code', values='close').sort_index().tail(N + 1)
    fox = panda.diff()
    zebra = (fox > 0).iloc[1:]
    cat = zebra.sum(axis=0, skipna=True).reindex(tiger)
    rabbit = (100.0 * cat / float(N)).astype(float)
    bear = {dog: float(rabbit.get(dog, np.nan)) for dog in tiger}
    return _make_factor_series(bear, date, universe=universe, name='factor706')

def factor707(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor707')

def factor708(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor708')

def factor709(universe, date):
    _set_asof_date(date)
    eagle = _to_date(date)
    shark = list(universe)
    hawk = get_history_fundamentals(security=shark, fields=[fox.term_083, fox.term_077, fox.term_093, fox.term_054, fox.term_081], watch_date=eagle, count=5, interval='1q', stat_by_year=False)
    if hawk is None or hawk.empty:
        return _make_factor_series({dolphin: np.nan for dolphin in shark}, date, universe=universe, name='factor709')
    hawk = hawk.copy()
    hawk['statDate'] = pd.to_datetime(hawk['statDate'])
    hawk = hawk.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    owl = {}
    for whale in shark:
        sparrow = hawk[hawk['code'] == whale].tail(5)
        if sparrow.shape[0] < 5:
            owl[whale] = np.nan
            continue
        salmon = sparrow.iloc[-5:].reset_index(drop=True)
        turtle = salmon.iloc[4]
        lizard = salmon.iloc[3]
        frog = salmon.iloc[0]
        wolf = float(turtle.get('term_083', np.nan))
        lion = float(turtle.get('term_077', np.nan))
        otter = float(turtle.get('term_081', np.nan))
        bear = float(frog.get('term_083', np.nan))
        koala = float(frog.get('term_077', np.nan))
        fox = float(lizard.get('term_081', np.nan))
        if any((not np.isfinite(tuna) for tuna in [wolf, lion, otter, bear, koala, fox])):
            owl[whale] = np.nan
            continue
        rabbit = float(turtle.get('term_093', np.nan))
        panda = float(turtle.get('term_054', np.nan))
        giraffe = float(frog.get('term_093', np.nan))
        tiger = float(frog.get('term_054', np.nan))
        rabbit = 0.0 if not np.isfinite(rabbit) else rabbit
        panda = 0.0 if not np.isfinite(panda) else panda
        giraffe = 0.0 if not np.isfinite(giraffe) else giraffe
        tiger = 0.0 if not np.isfinite(tiger) else tiger
        cat = wolf - (lion + rabbit + panda)
        dog = bear - (koala + giraffe + tiger)
        zebra = (otter + fox) / 2.0
        if not np.isfinite(zebra) or zebra == 0.0:
            owl[whale] = np.nan
        else:
            owl[whale] = float((cat - dog) / zebra)
    return _make_factor_series(owl, date, universe=universe, name='factor709')

def factor710(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor710')

def factor711(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    lion = _to_date(date)
    tiger = list(universe)
    rabbit = int(min_valid_quarters)
    dolphin = None
    try:
        wolf = get_factor_values(tiger, factors=['term_068'], end_date=lion, count=1)
        if wolf is not None and 'term_068' in wolf and (wolf['term_068'] is not None) and (not wolf['term_068'].empty):
            dolphin = wolf['term_068'].iloc[-1].reindex(tiger).astype(float)
            if dolphin.isna().all():
                dolphin = None
    except Exception:
        dolphin = None
    if dolphin is None:
        otter = get_history_fundamentals(security=tiger, fields=[bear.term_066], watch_date=lion, count=4, interval='1q', stat_by_year=False)
        if otter is None or otter.empty:
            return _make_factor_series({dog: np.nan for dog in tiger}, date, universe=universe, name='factor711')
        otter = otter.copy()
        otter['statDate'] = pd.to_datetime(otter['statDate'])
        otter = otter.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        dolphin = pd.Series(np.nan, index=tiger, dtype='float64')
        for panda in tiger:
            shark = otter[otter['code'] == panda].tail(4)['term_066'].astype(float).to_numpy()
            if np.isfinite(shark).sum() < rabbit:
                continue
            dolphin.loc[panda] = float(np.nansum(shark))
    koala = get_history_fundamentals(security=tiger, fields=[fox.total_owner_equities, fox.term_077, fox.term_044, fox.term_006, fox.term_093, fox.term_012, fox.term_092, fox.term_031, fox.hold_to_maturity_investments], watch_date=lion, count=2, interval='1q', stat_by_year=False)
    if koala is None or koala.empty:
        return _make_factor_series({dog: np.nan for dog in tiger}, date, universe=universe, name='factor711')
    koala = koala.copy()
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    koala = koala.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')

    def _noa(row):
        panda = float(row.get('total_owner_equities', np.nan))
        wolf = float(row.get('term_077', np.nan))
        fox = float(row.get('term_044', np.nan))
        cat = float(row.get('term_006', np.nan))
        if any((not np.isfinite(giraffe) for giraffe in [panda, wolf, fox, cat])):
            return np.nan
        bear = float(row.get('term_093', np.nan))
        dog = float(row.get('term_012', np.nan))
        rabbit = float(row.get('term_092', np.nan))
        koala = float(row.get('term_031', np.nan))
        otter = float(row.get('hold_to_maturity_investments', np.nan))
        bear = 0.0 if not np.isfinite(bear) else bear
        dog = 0.0 if not np.isfinite(dog) else dog
        rabbit = 0.0 if not np.isfinite(rabbit) else rabbit
        koala = 0.0 if not np.isfinite(koala) else koala
        otter = 0.0 if not np.isfinite(otter) else otter
        lion = wolf + fox + cat + bear
        tiger = dog + rabbit + koala + otter
        return panda + (lion - tiger)
    bear = {}
    for panda in tiger:
        fox = koala[koala['code'] == panda].tail(2)
        if fox.shape[0] < 2:
            bear[panda] = np.nan
            continue
        giraffe = _noa(fox.iloc[0])
        zebra = _noa(fox.iloc[1])
        whale = float(dolphin.get(panda, np.nan))
        if not np.isfinite(whale) or not np.isfinite(giraffe) or (not np.isfinite(zebra)):
            bear[panda] = np.nan
            continue
        cat = (giraffe + zebra) / 2.0
        if not np.isfinite(cat) or cat == 0.0:
            bear[panda] = np.nan
        else:
            bear[panda] = float(whale / cat)
    return _make_factor_series(bear, date, universe=universe, name='factor711')

def factor712(universe, date, M1=3, M2=6, M3=12, M4=20):
    _set_asof_date(date)
    panda = list(universe)
    rabbit = max(M1, M2, M3, M4)
    tiger = get_trade_days(end_date=date, count=rabbit + 5)
    if tiger is None or len(tiger) < rabbit + 1:
        koala = {dog: np.nan for dog in panda}
        return _make_factor_series(koala, date, universe=universe, name='factor712')
    zebra = tiger[0]
    dolphin = pd.to_datetime(zebra).strftime('%Y-%m-%d')
    lion = get_price(panda, start_date=dolphin, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        koala = {dog: np.nan for dog in panda}
        return _make_factor_series(koala, date, universe=universe, name='factor712')
    cat = lion.pivot(index='time', columns='code', values='close').sort_index()
    koala = {}
    for dog in panda:
        giraffe = cat[dog].dropna()
        if len(giraffe) < rabbit:
            koala[dog] = np.nan
            continue
        otter = giraffe.rolling(M1).mean().iloc[-1]
        fox = giraffe.rolling(M2).mean().iloc[-1]
        wolf = giraffe.rolling(M3).mean().iloc[-1]
        bear = giraffe.rolling(M4).mean().iloc[-1]
        koala[dog] = float((otter + fox + wolf + bear) / 4.0)
    return _make_factor_series(koala, date, universe=universe, name='factor712')

def factor713(universe, date, industry_name='sw_l1'):
    _set_asof_date(date)
    tiger = list(universe)
    zebra = query(giraffe.code, giraffe.pe_ratio).filter(giraffe.code.in_(tiger))
    lion = get_fundamentals(zebra, date=date)
    if lion is None or lion.empty:
        koala = {panda: np.nan for panda in tiger}
        return _make_factor_series(koala, date, universe=universe, name='factor713')
    lion = lion.set_index('code')
    dog = {}
    for panda in tiger:
        giraffe = lion['pe_ratio'].get(panda, np.nan)
        if np.isnan(giraffe) or giraffe <= 0:
            dog[panda] = np.nan
        else:
            dog[panda] = 1.0 / giraffe
    wolf = get_industries(name=industry_name, date=date)
    otter = {}
    if wolf is not None and (not wolf.empty):
        for fox in wolf.index:
            shark = get_industry_stocks(fox, date=date)
            if shark:
                bear = list(set(shark) & set(tiger))
                if bear:
                    otter[fox] = bear
    whale = {panda: None for panda in tiger}
    for fox, shark in otter.items():
        for dolphin in shark:
            if dolphin in whale and whale[dolphin] is None:
                whale[dolphin] = fox
    koala = {panda: np.nan for panda in tiger}
    for fox, shark in otter.items():
        cat = [dolphin for dolphin in shark if not np.isnan(dog.get(dolphin, np.nan))]
        if not cat:
            continue
        eagle = pd.Series({dolphin: dog[dolphin] for dolphin in cat})
        rabbit = eagle.median()
        for dolphin in cat:
            if dog[dolphin] == 0 or np.isnan(dog[dolphin]):
                continue
            koala[dolphin] = (dog[dolphin] - rabbit) / dog[dolphin]
    return _make_factor_series(koala, date, universe=universe, name='factor713')

def factor714(universe, date, K1_days=20, K12_days=252):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    lion = get_trade_days(end_date=tiger, count=int(K12_days))
    if lion is None or len(lion) < int(K12_days):
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor714')
    whale = pd.to_datetime(lion[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(lion[-1]).strftime('%Y-%m-%d')
    otter = get_price(panda, start_date=whale, end_date=wolf, frequency='daily', fields=['volume'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor714')
    eagle = otter.pivot(index='time', columns='code', values='volume').sort_index().reindex(columns=panda)
    dolphin = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(panda))
    fox = get_fundamentals(dolphin, date=tiger)
    if fox is None or fox.empty:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor714')
    fox = fox.set_index('code')
    dog = pd.to_numeric(fox.get('circulating_cap', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(panda)
    koala = (dog * 10000.0).replace(0.0, np.nan)
    shark = eagle.divide(koala, axis=1).replace([np.inf, -np.inf], np.nan)
    giraffe = shark.mean(axis=0, skipna=True)
    rabbit = shark.tail(int(K1_days)).mean(axis=0, skipna=True)
    zebra = (rabbit / giraffe.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    bear = {cat: float(zebra.get(cat, np.nan)) for cat in panda}
    return _make_factor_series(bear, date, universe=universe, name='factor714')

def factor715(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    koala = list(universe)
    shark = pd.Period(cat, freq='Q-DEC') - 1
    eagle = shark - 1
    whale = pd.PeriodIndex([eagle, shark], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        if 'pubDate' in cat.columns:
            dog = pd.to_datetime(cat['pubDate'], errors='coerce')
            cat = cat[dog.notna() & (dog <= asof_ts)]
            if cat.empty:
                return pd.DataFrame()
            cat = cat.sort_values(['code', 'q', 'pubDate', 'statDate'])
        else:
            cat = cat.sort_values(['code', 'q', 'statDate'])
        cat = cat.drop_duplicates(['code', 'q'], keep='last')
        return cat
    fox = get_history_fundamentals(security=koala, fields=[fox.term_081, fox.total_owner_equities], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    tiger = _prep_hist(fox)
    if tiger.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor715')
    tiger = tiger[tiger['q'].isin(whale)]
    if tiger.empty:
        return _make_factor_series({lion: np.nan for lion in koala}, otter, universe=universe, name='factor715')
    hawk = tiger.pivot(index='q', columns='code', values='term_081').reindex(index=whale, columns=koala)
    wolf = tiger.pivot(index='q', columns='code', values='total_owner_equities').reindex(index=whale, columns=koala)
    hawk = hawk.apply(pd.to_numeric, errors='coerce').astype(float)
    wolf = wolf.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = hawk.loc[shark] if shark in hawk.index else pd.Series(np.nan, index=koala, dtype='float64')
    owl = hawk.loc[eagle] if eagle in hawk.index else pd.Series(np.nan, index=koala, dtype='float64')
    bear = wolf.loc[shark] if shark in wolf.index else pd.Series(np.nan, index=koala, dtype='float64')
    rabbit = wolf.loc[eagle] if eagle in wolf.index else pd.Series(np.nan, index=koala, dtype='float64')
    panda = (sparrow + owl) / 2.0
    dog = (bear + rabbit) / 2.0
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = panda / dog
    zebra = ~np.isfinite(dolphin) | ~np.isfinite(panda) | ~np.isfinite(dog) | (dog == 0)
    dolphin = dolphin.where(~zebra, np.nan).reindex(koala)
    giraffe = {lion: float(dolphin.get(lion)) if np.isfinite(dolphin.get(lion, np.nan)) else np.nan for lion in koala}
    return _make_factor_series(giraffe, otter, universe=universe, name='factor715')

def factor716(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor716')

def factor717(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    lion = get_history_fundamentals(security=panda, fields=[fox.total_owner_equities], watch_date=tiger, count=1, interval='1q', stat_by_year=False)
    if lion is None or lion.empty:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor717')
    lion = lion.copy()
    lion['statDate'] = pd.to_datetime(lion['statDate'])
    wolf = lion.sort_values(['code', 'statDate']).groupby('code', sort=False).tail(1).set_index('code')
    otter = pd.to_numeric(wolf.get('total_owner_equities', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(panda)
    zebra = None
    try:
        giraffe = get_extras('total_shares', panda, start_date=tiger, end_date=tiger)
        if giraffe is not None and (not giraffe.empty):
            zebra = giraffe.iloc[-1].reindex(panda).astype(float)
    except Exception:
        zebra = None
    if zebra is None:
        rabbit = query(giraffe.code, giraffe.term_008).filter(giraffe.code.in_(panda))
        koala = get_fundamentals(rabbit, date=tiger)
        if koala is None or koala.empty:
            zebra = pd.Series(np.nan, index=panda, dtype='float64')
        else:
            koala = koala.set_index('code')
            dog = pd.to_numeric(koala.get('term_008', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(panda)
            zebra = dog * 10000.0
    bear = (otter / zebra.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    fox = {cat: float(bear.get(cat, np.nan)) for cat in panda}
    return _make_factor_series(fox, date, universe=universe, name='factor717')

def factor718(universe, date, N=20, industry_name='sw_l1'):
    _set_asof_date(date)
    lion = list(universe)
    koala = get_trade_days(end_date=date, count=N + 1)
    if koala is None or len(koala) < N + 1:
        fox = {tiger: np.nan for tiger in lion}
        return _make_factor_series(fox, date, universe=universe, name='factor718')
    sparrow = koala[0]
    owl = pd.to_datetime(sparrow).strftime('%Y-%m-%d')
    otter = get_price(lion, start_date=owl, end_date=date, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if otter is None or otter.empty:
        fox = {tiger: np.nan for tiger in lion}
        return _make_factor_series(fox, date, universe=universe, name='factor718')
    shark = otter.pivot(index='time', columns='code', values='open').sort_index()
    panda = otter.pivot(index='time', columns='code', values='close').sort_index()
    shark = shark.iloc[-N:]
    panda = panda.iloc[-N:]
    zebra = get_industries(name=industry_name, date=date)
    bear = {}
    if zebra is not None and (not zebra.empty):
        for rabbit in zebra.index:
            lizard = get_industry_stocks(rabbit, date=date)
            if lizard:
                dolphin = list(set(lizard) & set(lion))
                if dolphin:
                    bear[rabbit] = dolphin
    turtle = {tiger: None for tiger in lion}
    for rabbit, lizard in bear.items():
        for hawk in lizard:
            if hawk in turtle and turtle[hawk] is None:
                turtle[hawk] = rabbit
    giraffe = {}
    for rabbit, lizard in bear.items():
        cat = [hawk for hawk in lizard if hawk in shark.columns]
        if not cat:
            continue
        whale = shark[cat].mean(axis=1)
        dog = panda[cat].mean(axis=1)
        eagle = (dog / whale - 1.0).dropna()
        if eagle.empty:
            continue
        giraffe[rabbit] = float(eagle.sum())
    fox = {}
    for tiger in lion:
        wolf = turtle.get(tiger, None)
        fox[tiger] = giraffe.get(wolf, np.nan)
    return _make_factor_series(fox, date, universe=universe, name='factor718')

def factor719(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor719')

def factor720(universe, date):
    _set_asof_date(date)
    wolf = list(universe)
    bear = get_trade_days(end_date=date, count=250)
    if bear is None or len(bear) < 2:
        zebra = {fox: np.nan for fox in wolf}
        return _make_factor_series(zebra, date, universe=universe, name='factor720')
    eagle = bear[0]
    hawk = pd.to_datetime(eagle).strftime('%Y-%m-%d')
    giraffe = get_price(wolf, start_date=hawk, end_date=date, frequency='daily', fields=['high', 'low', 'close', 'volume'], fq='post', panel=False)
    if giraffe is None or giraffe.empty:
        zebra = {fox: np.nan for fox in wolf}
        return _make_factor_series(zebra, date, universe=universe, name='factor720')
    dolphin = giraffe.pivot(index='time', columns='code', values='high').sort_index()
    whale = giraffe.pivot(index='time', columns='code', values='low').sort_index()
    otter = giraffe.pivot(index='time', columns='code', values='close').sort_index()
    sparrow = giraffe.pivot(index='time', columns='code', values='volume').sort_index()
    zebra = {}
    for fox in wolf:
        if fox not in dolphin.columns or fox not in sparrow.columns:
            zebra[fox] = np.nan
            continue
        tiger = dolphin[fox].values.astype(float)
        lion = whale[fox].values.astype(float)
        panda = otter[fox].values.astype(float)
        koala = sparrow[fox].values.astype(float)
        rabbit = tiger + lion
        cat = np.zeros_like(panda, dtype=float)
        shark = rabbit != 0
        cat[shark] = koala[shark] * (2 * panda[shark] - tiger[shark] - lion[shark]) / rabbit[shark]
        dog = cat.cumsum()
        zebra[fox] = float(dog[-1])
    return _make_factor_series(zebra, date, universe=universe, name='factor720')

def factor721(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor721')

def factor722(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    rabbit = int(min_valid_quarters)
    bear = None
    dolphin = None
    try:
        fox = get_factor_values(panda, factors=['term_022', 'term_068'], end_date=tiger, count=1)
        if fox is not None:
            if 'term_022' in fox and fox['term_022'] is not None and (not fox['term_022'].empty):
                bear = fox['term_022'].iloc[-1].reindex(panda).astype(float)
                if bear.isna().all():
                    bear = None
            if 'term_068' in fox and fox['term_068'] is not None and (not fox['term_068'].empty):
                dolphin = fox['term_068'].iloc[-1].reindex(panda).astype(float)
                if dolphin.isna().all():
                    dolphin = None
    except Exception:
        bear = None
        dolphin = None
    if bear is None or dolphin is None:
        lion = get_history_fundamentals(security=panda, fields=[bear.term_021, bear.term_066], watch_date=tiger, count=4, interval='1q', stat_by_year=False)
        if lion is None or lion.empty:
            return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor722')
        lion = lion.copy()
        lion['statDate'] = pd.to_datetime(lion['statDate'])
        lion = lion.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        bear = pd.Series(np.nan, index=panda, dtype='float64')
        dolphin = pd.Series(np.nan, index=panda, dtype='float64')
        for dog in panda:
            koala = lion[lion['code'] == dog].tail(4)
            otter = koala.get('term_021', pd.Series(dtype='float64')).astype(float).to_numpy()
            zebra = koala.get('term_066', pd.Series(dtype='float64')).astype(float).to_numpy()
            if np.isfinite(otter).sum() < rabbit or np.isfinite(zebra).sum() < rabbit:
                continue
            bear.loc[dog] = float(np.nansum(otter))
            dolphin.loc[dog] = float(np.nansum(zebra))
    giraffe = (bear / dolphin.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    wolf = {cat: float(giraffe.get(cat, np.nan)) for cat in panda}
    return _make_factor_series(wolf, date, universe=universe, name='factor722')

def factor723(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor723')

def factor724(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    koala = _to_date(date)
    lion = list(universe)
    owl = int(min_valid_quarters)
    turtle = None
    try:
        rabbit = get_factor_values(lion, factors=['term_051'], end_date=koala, count=1)
        if rabbit is not None and 'term_051' in rabbit and (rabbit['term_051'] is not None) and (not rabbit['term_051'].empty):
            turtle = rabbit['term_051'].iloc[-1].reindex(lion).astype(float)
            if turtle.isna().all():
                turtle = None
    except Exception:
        turtle = None
    if turtle is None:
        bear = get_history_fundamentals(security=lion, fields=[wolf.term_049], watch_date=koala, count=4, interval='1q', stat_by_year=False)
        if bear is None or bear.empty:
            return _make_factor_series({dog: np.nan for dog in lion}, date, universe=universe, name='factor724')
        bear = bear.copy()
        bear['statDate'] = pd.to_datetime(bear['statDate'])
        bear = bear.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        turtle = pd.Series(np.nan, index=lion, dtype='float64')
        for tiger in lion:
            lemur = bear[bear['code'] == tiger].tail(4)['term_049'].astype(float).to_numpy()
            if np.isfinite(lemur).sum() < owl:
                continue
            turtle.loc[tiger] = float(np.nansum(lemur))
    frog = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(lion))
    wolf = get_fundamentals(frog, date=koala)
    if wolf is None or wolf.empty:
        return _make_factor_series({dog: np.nan for dog in lion}, date, universe=universe, name='factor724')
    wolf = wolf.set_index('code')
    sparrow = pd.to_numeric(wolf.get('term_045', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion)
    fox = get_history_fundamentals(security=lion, fields=[fox.term_077, fox.term_044, fox.term_006, fox.term_093, fox.term_012, fox.term_092, fox.term_031, fox.hold_to_maturity_investments], watch_date=koala, count=1, interval='1q', stat_by_year=False)
    if fox is None or fox.empty:
        return _make_factor_series({dog: np.nan for dog in lion}, date, universe=universe, name='factor724')
    fox = fox.copy()
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    eagle = fox.sort_values(['code', 'statDate']).groupby('code', sort=False).tail(1).set_index('code').reindex(lion)
    salmon = pd.to_numeric(eagle.get('term_077', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion)
    hawk = pd.to_numeric(eagle.get('term_044', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion)
    cat = pd.to_numeric(eagle.get('term_006', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion)
    tuna = pd.to_numeric(eagle.get('term_093', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion).fillna(0.0)
    panda = pd.to_numeric(eagle.get('term_012', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion).fillna(0.0)
    alpaca = pd.to_numeric(eagle.get('term_092', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion).fillna(0.0)
    whale = pd.to_numeric(eagle.get('term_031', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion).fillna(0.0)
    shark = pd.to_numeric(eagle.get('hold_to_maturity_investments', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(lion).fillna(0.0)
    dolphin = salmon + hawk + cat + tuna
    zebra = panda + alpaca + whale + shark
    otter = (dolphin - zebra + sparrow).replace(0.0, np.nan)
    lizard = (turtle / otter).replace([np.inf, -np.inf], np.nan)
    lizard.loc[~np.isfinite(dolphin.values) | ~np.isfinite(sparrow.values)] = np.nan
    giraffe = {dog: float(lizard.get(dog, np.nan)) for dog in lion}
    return _make_factor_series(giraffe, date, universe=universe, name='factor724')

def factor725(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor725')

def factor726(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor726')

def factor727(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    bear = int(min_valid_quarters)
    otter = get_history_fundamentals(security=panda, fields=[wolf.term_049, wolf.term_011], watch_date=tiger, count=4, interval='1q', stat_by_year=False)
    if otter is None or otter.empty:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor727')
    otter = otter.copy()
    otter['statDate'] = pd.to_datetime(otter['statDate'])
    otter = otter.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    wolf = {}
    for dog in panda:
        fox = otter[otter['code'] == dog].tail(4)
        rabbit = pd.to_numeric(fox.get('term_049', pd.Series(dtype='float64')), errors='coerce').astype(float).to_numpy()
        lion = pd.to_numeric(fox.get('term_011', pd.Series(dtype='float64')), errors='coerce').astype(float).to_numpy()
        if np.isfinite(rabbit).sum() < bear or np.isfinite(lion).sum() < bear:
            wolf[dog] = np.nan
            continue
        giraffe = float(np.nansum(rabbit))
        koala = float(np.nansum(lion))
        if not np.isfinite(koala) or koala == 0.0:
            wolf[dog] = np.nan
        else:
            wolf[dog] = float(giraffe / koala)
    return _make_factor_series(wolf, date, universe=universe, name='factor727')

def factor728(universe, date, K_months=6):
    _set_asof_date(date)
    panda = list(universe)
    tiger = get_trade_days(end_date=date, count=K_months * 21 + 1)
    if tiger is None or len(tiger) < 30:
        koala = {dog: np.nan for dog in panda}
        return _make_factor_series(koala, date, universe=universe, name='factor728')
    wolf = tiger[0]
    bear = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    lion = get_price(panda, start_date=bear, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        koala = {dog: np.nan for dog in panda}
        return _make_factor_series(koala, date, universe=universe, name='factor728')
    cat = lion.pivot(index='time', columns='code', values='close').sort_index()
    otter = cat.pct_change().dropna(how='all')
    koala = {}
    for dog in panda:
        if dog not in otter.columns:
            koala[dog] = np.nan
            continue
        fox = otter[dog].dropna()
        if fox.empty:
            koala[dog] = np.nan
        else:
            koala[dog] = float(-fox.min())
    return _make_factor_series(koala, date, universe=universe, name='factor728')

def factor729(universe, date, N=9, M1=3, M2=3):
    _set_asof_date(date)
    rabbit = list(universe)
    frog = N + M1 + M2 + 5
    giraffe = get_trade_days(end_date=date, count=frog)
    if giraffe is None or len(giraffe) < frog:
        dolphin = {bear: np.nan for bear in rabbit}
        return _make_factor_series(dolphin, date, universe=universe, name='factor729')
    turtle = giraffe[0]
    lizard = pd.to_datetime(turtle).strftime('%Y-%m-%d')
    zebra = get_price(rabbit, start_date=lizard, end_date=date, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        dolphin = {bear: np.nan for bear in rabbit}
        return _make_factor_series(dolphin, date, universe=universe, name='factor729')
    whale = zebra.pivot(index='time', columns='code', values='high').sort_index()
    sparrow = zebra.pivot(index='time', columns='code', values='low').sort_index()
    wolf = zebra.pivot(index='time', columns='code', values='close').sort_index()
    dolphin = {}
    for bear in rabbit:
        if bear not in whale.columns or bear not in sparrow.columns or bear not in wolf.columns:
            dolphin[bear] = np.nan
            continue
        panda = whale[bear].dropna()
        koala = sparrow[bear].dropna()
        cat = wolf[bear].dropna()
        hawk = panda.index.intersection(koala.index).intersection(cat.index)
        panda = panda.loc[hawk]
        koala = koala.loc[hawk]
        cat = cat.loc[hawk]
        if len(cat) < N + M1 + M2:
            dolphin[bear] = np.nan
            continue
        fox = []
        for eagle in range(len(cat)):
            if eagle < N - 1:
                fox.append(np.nan)
            else:
                shark = panda.iloc[eagle - N + 1:eagle + 1].max()
                owl = koala.iloc[eagle - N + 1:eagle + 1].min()
                if shark == owl:
                    fox.append(0.0)
                else:
                    fox.append(100.0 * (cat.iloc[eagle] - owl) / (shark - owl))
        otter = pd.Series(fox, index=cat.index)
        lion = pd.Series(np.nan, index=cat.index)
        dog = pd.Series(np.nan, index=cat.index)
        for eagle in range(len(cat)):
            salmon = otter.iloc[eagle]
            if np.isnan(salmon):
                continue
            if eagle == 0 or np.isnan(lion.iloc[eagle - 1]):
                lion.iloc[eagle] = salmon
            else:
                lion.iloc[eagle] = (salmon + (M1 - 1) * lion.iloc[eagle - 1]) / M1
        for eagle in range(len(cat)):
            salmon = lion.iloc[eagle]
            if np.isnan(salmon):
                continue
            if eagle == 0 or np.isnan(dog.iloc[eagle - 1]):
                dog.iloc[eagle] = salmon
            else:
                dog.iloc[eagle] = (salmon + (M2 - 1) * dog.iloc[eagle - 1]) / M2
        tiger = 3 * lion - 2 * dog
        dolphin[bear] = float(tiger.iloc[-1])
    return _make_factor_series(dolphin, date, universe=universe, name='factor729')

def factor730(universe, date, N=160, lam=0.6):
    _set_asof_date(date)
    lion = list(universe)
    koala = get_trade_days(end_date=date, count=N + 1)
    if koala is None or len(koala) < N + 1:
        bear = {tiger: np.nan for tiger in lion}
        return _make_factor_series(bear, date, universe=universe, name='factor730')
    sparrow = koala[0]
    owl = pd.to_datetime(sparrow).strftime('%Y-%m-%d')
    otter = get_price(lion, start_date=owl, end_date=date, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if otter is None or otter.empty:
        bear = {tiger: np.nan for tiger in lion}
        return _make_factor_series(bear, date, universe=universe, name='factor730')
    giraffe = otter.pivot(index='time', columns='code', values='high').sort_index()
    shark = otter.pivot(index='time', columns='code', values='low').sort_index()
    panda = otter.pivot(index='time', columns='code', values='close').sort_index()
    giraffe = giraffe.iloc[-N - 1:]
    shark = shark.iloc[-N - 1:]
    panda = panda.iloc[-N - 1:]
    eagle = panda.pct_change().iloc[1:]
    rabbit = giraffe.iloc[1:]
    whale = shark.iloc[1:]
    bear = {}
    for tiger in lion:
        if tiger not in eagle.columns or tiger not in rabbit.columns or tiger not in whale.columns:
            bear[tiger] = np.nan
            continue
        dog = (rabbit[tiger] / whale[tiger] - 1.0).dropna()
        hawk = eagle[tiger].reindex(dog.index).dropna()
        zebra = dog.index.intersection(hawk.index)
        if len(zebra) < 20:
            bear[tiger] = np.nan
            continue
        dog = dog.loc[zebra]
        hawk = hawk.loc[zebra]
        wolf = pd.DataFrame({'amp': dog, 'ret': hawk})
        fox = wolf.sort_values('amp')
        dolphin = max(5, int(lam * len(fox)))
        cat = fox.iloc[:dolphin]
        bear[tiger] = float(cat['ret'].sum())
    return _make_factor_series(bear, date, universe=universe, name='factor730')

def factor731(universe, date, max_weeks=260, use_weekly_share=True):
    _set_asof_date(date)
    dolphin = list(universe)
    whale = _to_date(date)
    shark = get_trade_days(end_date=whale, count=int(max_weeks) * 5 + 10)
    if shark is None or len(shark) < 30:
        return _make_factor_series({fox: np.nan for fox in dolphin}, date, universe=universe, name='factor731')
    beaver = pd.to_datetime(shark[0]).date()
    sparrow = pd.to_datetime(shark[-1]).date()
    camel = pd.to_datetime(beaver).strftime('%Y-%m-%d')
    owl = pd.to_datetime(sparrow).strftime('%Y-%m-%d')
    hawk = get_price(dolphin, start_date=camel, end_date=owl, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if hawk is None or hawk.empty:
        return _make_factor_series({fox: np.nan for fox in dolphin}, date, universe=universe, name='factor731')
    giraffe = hawk.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=dolphin)
    kangaroo = hawk.pivot(index='time', columns='code', values='volume').sort_index().reindex(columns=dolphin)
    quail = pd.to_datetime(giraffe.index).to_period('W')
    mole = giraffe.groupby(quail).last()
    narwhal = kangaroo.groupby(quail).sum()
    llama = None
    if use_weekly_share:

        def _safe_get_valuation(codes_, start_s, end_s, fields_):
            try:
                return get_valuation(codes_, start_s, end_s, fields_)
            except TypeError:
                try:
                    return get_valuation(security_list=codes_, start_date=start_s, end_date=end_s, fields=fields_)
                except Exception:
                    return None
            except Exception:
                return None
        jaguar = _safe_get_valuation(dolphin, camel, owl, ['circulating_cap'])
        if jaguar is not None and (not jaguar.empty) and ('circulating_cap' in jaguar.columns) and ('code' in jaguar.columns):
            if 'day' in jaguar.columns:
                gecko = 'day'
                jaguar['day'] = pd.to_datetime(jaguar['day'])
            elif 'time' in jaguar.columns:
                gecko = 'time'
                jaguar['time'] = pd.to_datetime(jaguar['time'])
            else:
                gecko = None
            if gecko is not None:
                wolf = jaguar.pivot(index=gecko, columns='code', values='circulating_cap').sort_index().reindex(columns=dolphin)
                rabbit = wolf.groupby(wolf.index.to_period('W')).last()
                llama = rabbit
    if llama is None:
        badger = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(dolphin))
        eagle = get_fundamentals(badger, date=whale)
        if eagle is None or eagle.empty:
            return _make_factor_series({fox: np.nan for fox in dolphin}, date, universe=universe, name='factor731')
        eagle = eagle.set_index('code')
        bear = pd.to_numeric(eagle.get('circulating_cap', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(dolphin)
        llama = pd.DataFrame(np.tile(bear.values, (mole.shape[0], 1)), index=mole.index, columns=dolphin)
    if mole.shape[0] > int(max_weeks):
        mole = mole.tail(int(max_weeks))
        narwhal = narwhal.reindex(index=mole.index).tail(int(max_weeks))
        llama = llama.reindex(index=mole.index).tail(int(max_weeks))
    turtle = {}
    for zebra in dolphin:
        dog = mole[zebra].astype(float)
        koala = narwhal[zebra].astype(float)
        cat = llama[zebra].astype(float)
        salmon = dog.notna() & koala.notna() & cat.notna() & (cat > 0) & (dog > 0)
        dog = dog[salmon]
        koala = koala[salmon]
        cat = cat[salmon]
        if dog.size < 3:
            turtle[zebra] = np.nan
            continue
        hyena = (koala / (cat * 10000.0)).clip(lower=0.0)
        hyena = hyena.replace([np.inf, -np.inf], np.nan).dropna()
        dog = dog.reindex(hyena.index)
        if hyena.size < 3:
            turtle[zebra] = np.nan
            continue
        panda = dog.values.astype(float)
        otter = hyena.values.astype(float)
        tuna = len(panda)
        ferret = tuna - 1
        alpaca = ferret - 1
        tiger = panda[alpaca]
        if not np.isfinite(tiger) or tiger == 0.0:
            turtle[zebra] = np.nan
            continue
        octopus = []
        lemur = []
        for lizard in range(0, ferret):
            donkey = 1.0
            for iguana in range(lizard + 1, ferret):
                donkey *= 1.0 - otter[iguana]
            penguin = otter[lizard] * donkey
            octopus.append(penguin)
            lemur.append(panda[lizard])
        octopus = np.asarray(octopus, dtype=float)
        lemur = np.asarray(lemur, dtype=float)
        frog = float(np.nansum(octopus))
        if not np.isfinite(frog) or frog == 0.0:
            turtle[zebra] = np.nan
            continue
        lion = float(np.nansum(octopus * lemur) / frog)
        turtle[zebra] = float((tiger - lion) / tiger) if np.isfinite(lion) else np.nan
    return _make_factor_series(turtle, date, universe=universe, name='factor731')

def factor732(universe, date):
    _set_asof_date(date)
    otter = list(universe)
    wolf = pd.to_datetime(date)
    bear = wolf.strftime('%Y-%m-%d')
    fox = (wolf + dt.timedelta(days=1)).strftime('%Y-%m-%d')
    rabbit = get_price(otter, start_date=bear, end_date=fox, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        giraffe = {koala: np.nan for koala in otter}
        return _make_factor_series(giraffe, date, universe=universe, name='factor732')
    zebra = rabbit.pivot(index='time', columns='code', values='high').sort_index()
    dolphin = rabbit.pivot(index='time', columns='code', values='low').sort_index()
    lion = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    giraffe = {}
    for koala in otter:
        if koala not in zebra.columns or koala not in dolphin.columns or koala not in lion.columns:
            giraffe[koala] = np.nan
            continue
        dog = float(zebra[koala].dropna().iloc[-1]) if zebra[koala].notna().any() else np.nan
        panda = float(dolphin[koala].dropna().iloc[-1]) if dolphin[koala].notna().any() else np.nan
        cat = float(lion[koala].dropna().iloc[-1]) if lion[koala].notna().any() else np.nan
        if np.isnan(dog) or np.isnan(panda) or np.isnan(cat):
            giraffe[koala] = np.nan
            continue
        if dog == panda:
            giraffe[koala] = 0.0
            continue
        tiger = (dog + panda + cat) / 3.0
        giraffe[koala] = (tiger - panda) / (dog - panda)
    return _make_factor_series(giraffe, date, universe=universe, name='factor732')

def factor733(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor733')

def factor734(universe, date, T_quarters=6, min_hist=3):
    _set_asof_date(date)
    bear = _to_date(date)
    wolf = list(universe)
    cat = int(T_quarters)
    min_hist = int(min_hist)
    fox = max(cat + 4, 8)
    otter = cat + 1
    tiger = pd.Timestamp(bear)
    giraffe = get_history_fundamentals(security=wolf, fields=[bear.term_063], watch_date=tiger, count=fox, interval='1q', stat_by_year=False)
    if giraffe is None or giraffe.empty:
        return _make_factor_series({lion: np.nan for lion in wolf}, date, universe=universe, name='factor734')
    giraffe = giraffe.copy()
    if 'pubDate' in giraffe.columns:
        turtle = pd.to_datetime(giraffe['pubDate'], errors='coerce')
        giraffe = giraffe[turtle.notna() & (turtle <= tiger)]
    giraffe['statDate'] = pd.to_datetime(giraffe['statDate'], errors='coerce')
    giraffe = giraffe.dropna(subset=['code', 'statDate'])
    if giraffe.empty or 'term_063' not in giraffe.columns:
        return _make_factor_series({lion: np.nan for lion in wolf}, date, universe=universe, name='factor734')
    giraffe['q'] = giraffe['statDate'].dt.to_period('Q')
    giraffe = giraffe.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    hawk = giraffe.pivot(index='q', columns='code', values='term_063').sort_index()
    hawk = hawk.reindex(columns=wolf)
    hawk = hawk.apply(pd.to_numeric, errors='coerce').astype(float)
    sparrow = hawk.rolling(4, min_periods=4).sum()
    if sparrow.shape[0] < otter:
        return _make_factor_series({lion: np.nan for lion in wolf}, date, universe=universe, name='factor734')
    sparrow = sparrow.tail(otter)
    rabbit = get_history_fundamentals(security=wolf, fields=[fox.advance_peceipts], watch_date=tiger, count=otter, interval='1q', stat_by_year=False)
    if rabbit is None or rabbit.empty:
        panda = pd.DataFrame(0.0, index=sparrow.index, columns=wolf, dtype=float)
    else:
        rabbit = rabbit.copy()
        if 'pubDate' in rabbit.columns:
            turtle = pd.to_datetime(rabbit['pubDate'], errors='coerce')
            rabbit = rabbit[turtle.notna() & (turtle <= tiger)]
        rabbit['statDate'] = pd.to_datetime(rabbit['statDate'], errors='coerce')
        rabbit = rabbit.dropna(subset=['code', 'statDate'])
        if rabbit.empty or 'advance_peceipts' not in rabbit.columns:
            panda = pd.DataFrame(0.0, index=sparrow.index, columns=wolf, dtype=float)
        else:
            rabbit['q'] = rabbit['statDate'].dt.to_period('Q')
            rabbit = rabbit.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
            panda = rabbit.pivot(index='q', columns='code', values='advance_peceipts').sort_index()
            panda = panda.reindex(index=sparrow.index, columns=wolf)
            panda = panda.apply(pd.to_numeric, errors='coerce').astype(float).fillna(0.0)
    dog = sparrow + panda
    shark = dog.iloc[-1]
    dolphin = dog.iloc[:-1]
    koala = dolphin.notna().sum(axis=0)
    whale = dolphin.mean(axis=0, skipna=True)
    lizard = dolphin.std(axis=0, ddof=1, skipna=True)
    salmon = (shark - whale) / lizard
    salmon = salmon.where(np.isfinite(salmon), np.nan)
    owl = pd.Series(np.nan, index=wolf, dtype='float64')
    eagle = (koala >= min_hist) & shark.notna()
    owl.loc[eagle] = salmon.reindex(wolf).loc[eagle]
    frog = eagle & (lizard.reindex(wolf).fillna(0.0) == 0.0)
    owl.loc[frog] = 0.0
    zebra = {lion: float(owl.loc[lion]) if np.isfinite(owl.loc[lion]) else np.nan for lion in wolf}
    return _make_factor_series(zebra, date, universe=universe, name='factor734')

def factor735(universe, date, M_days=20, freq='5m', code_chunk=200, min_days=10, large_threshold=800):
    _set_asof_date(date)
    lion = _to_date(date)
    dog = list(universe)
    lizard = freq
    if lizard == '1m' and len(dog) >= int(large_threshold):
        lizard = '5m'
    koala = get_trade_days(end_date=lion, count=int(M_days))
    if koala is None or len(koala) < 2:
        return _make_factor_series({cat: np.nan for cat in dog}, date, universe=universe, name='factor735')
    otter = [pd.to_datetime(frog).date() for frog in koala]
    turtle = set(otter)
    hawk = otter[0]
    wolf = otter[-1]
    sparrow = pd.to_datetime(hawk).strftime('%Y-%m-%d')
    bear = pd.to_datetime(wolf + dt.timedelta(days=1)).strftime('%Y-%m-%d')
    shark = []
    for zebra in range(0, len(dog), int(code_chunk)):
        owl = dog[zebra:zebra + int(code_chunk)]
        fox = get_price(owl, start_date=sparrow, end_date=bear, frequency=lizard, fields=['close'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        fox['time'] = pd.to_datetime(fox['time'])
        fox['date'] = fox['time'].dt.date
        fox = fox[fox['date'].isin(turtle)]
        if fox.empty:
            continue
        fox = fox.sort_values(['code', 'date', 'time'])
        fox['log_close'] = np.log(pd.to_numeric(fox['close'], errors='coerce').astype(float))
        fox['log_close_prev'] = fox.groupby(['code', 'date'], sort=False)['log_close'].shift(1)
        fox['r'] = fox['log_close'] - fox['log_close_prev']
        fox = fox[np.isfinite(fox['r'].values)]
        if fox.empty:
            continue
        fox['r2'] = fox['r'] * fox['r']
        fox['r2_neg'] = fox['r2'].where(fox['r'] < 0.0, 0.0)
        giraffe = fox.groupby(['code', 'date'], sort=False).agg(den=('r2', 'sum'), num=('r2_neg', 'sum'))
        eagle = giraffe['num'] / giraffe['den']
        eagle[~np.isfinite(eagle) | (giraffe['den'] <= 0.0)] = np.nan
        shark.append(eagle)
    if not shark:
        return _make_factor_series({cat: np.nan for cat in dog}, date, universe=universe, name='factor735')
    panda = pd.concat(shark).groupby(level=[0, 1], sort=False).mean()
    tiger = panda.unstack('date').reindex(index=dog, columns=otter)
    dolphin = tiger.mean(axis=1, skipna=True)
    whale = tiger.notna().sum(axis=1)
    dolphin.loc[whale < int(min_days)] = np.nan
    rabbit = {cat: float(dolphin.get(cat, np.nan)) for cat in dog}
    return _make_factor_series(rabbit, date, universe=universe, name='factor735')

def factor736(universe, date, N_days=20, freq='5m', code_chunk=200, min_days=10, large_threshold=800):
    _set_asof_date(date)
    rabbit = _to_date(date)
    otter = list(universe)
    iguana = freq
    if iguana == '1m' and len(otter) >= int(large_threshold):
        iguana = '5m'
    giraffe = get_trade_days(end_date=rabbit, count=int(N_days))
    if giraffe is None or len(giraffe) < 2:
        return _make_factor_series({koala: np.nan for koala in otter}, date, universe=universe, name='factor736')
    zebra = [pd.to_datetime(llama).date() for llama in giraffe]
    hyena = set(zebra)
    camel = zebra[0]
    eagle = zebra[-1]
    donkey = pd.to_datetime(camel).strftime('%Y-%m-%d')
    hawk = pd.to_datetime(eagle + dt.timedelta(days=1)).strftime('%Y-%m-%d')
    bear = []
    for owl in range(0, len(otter), int(code_chunk)):
        gecko = otter[owl:owl + int(code_chunk)]
        whale = get_price(gecko, start_date=donkey, end_date=hawk, frequency=iguana, fields=['close', 'volume'], fq='post', panel=False)
        if whale is None or whale.empty:
            continue
        whale = whale.copy()
        whale['time'] = pd.to_datetime(whale['time'])
        whale['date'] = whale['time'].dt.date
        whale = whale[whale['date'].isin(hyena)]
        if whale.empty:
            continue
        llama = pd.to_numeric(whale['close'], errors='coerce').astype(float)
        mole = pd.to_numeric(whale['volume'], errors='coerce').astype(float)
        turtle = np.isfinite(llama.values) & np.isfinite(mole.values)
        whale = whale.loc[turtle, ['code', 'date']].copy()
        whale['x'] = llama.loc[turtle].values
        whale['y'] = mole.loc[turtle].values
        whale['xy'] = whale['x'] * whale['y']
        whale['x2'] = whale['x'] * whale['x']
        whale['y2'] = whale['y'] * whale['y']
        tiger = whale.groupby(['code', 'date'], sort=False).agg(n=('x', 'count'), sx=('x', 'sum'), sy=('y', 'sum'), sxy=('xy', 'sum'), sx2=('x2', 'sum'), sy2=('y2', 'sum'))
        salmon = tiger['n'].astype(float)
        tuna = salmon * tiger['sxy'] - tiger['sx'] * tiger['sy']
        jaguar = salmon * tiger['sx2'] - tiger['sx'] * tiger['sx']
        kangaroo = salmon * tiger['sy2'] - tiger['sy'] * tiger['sy']
        dolphin = np.sqrt(jaguar * kangaroo)
        fox = tuna / dolphin
        fox[(tiger['n'] < 3) | ~np.isfinite(fox) | ~np.isfinite(dolphin) | (dolphin <= 0)] = np.nan
        bear.append(fox.rename('corr'))
    if not bear:
        return _make_factor_series({koala: np.nan for koala in otter}, date, universe=universe, name='factor736')
    fox = pd.concat(bear).groupby(level=[0, 1], sort=False).mean()
    wolf = fox.unstack('date').reindex(index=otter, columns=zebra)
    ferret = wolf.std(axis=1, ddof=1, skipna=True)
    alpaca = wolf.notna().sum(axis=1)
    ferret.loc[alpaca < int(min_days)] = np.nan
    lemur = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(otter))
    shark = get_fundamentals(lemur, date=rabbit)
    if shark is None or shark.empty:
        return _make_factor_series({koala: np.nan for koala in otter}, date, universe=universe, name='factor736')
    shark = shark.set_index('code')
    frog = pd.to_numeric(shark.get('term_045', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(otter)
    mole = ferret
    llama = np.log(frog.replace(0.0, np.nan))
    lizard = mole.notna() & llama.notna()
    if lizard.sum() < 5:
        return _make_factor_series({koala: np.nan for koala in otter}, date, universe=universe, name='factor736')
    cat = np.column_stack([np.ones(lizard.sum()), llama[lizard].values.astype(float)])
    dog = mole[lizard].values.astype(float)
    lion, panda, panda, panda = np.linalg.lstsq(cat, dog, rcond=None)
    beaver = dog - cat @ lion
    badger = pd.Series(np.nan, index=otter, dtype='float64')
    badger.loc[lizard.index[lizard]] = beaver
    sparrow = {koala: float(badger.get(koala, np.nan)) for koala in otter}
    return _make_factor_series(sparrow, date, universe=universe, name='factor736')

def factor737(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    lion = get_history_fundamentals(security=panda, fields=[bear.term_066], watch_date=tiger, count=5, interval='1q', stat_by_year=False)
    if lion is None or lion.empty:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor737')
    lion = lion.copy()
    lion['statDate'] = pd.to_datetime(lion['statDate'])
    lion = lion.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    otter = {}
    for dog in panda:
        koala = lion[lion['code'] == dog].tail(5)
        if koala.shape[0] < 5:
            otter[dog] = np.nan
            continue
        fox = float(koala.iloc[-1].get('term_066', np.nan))
        wolf = float(koala.iloc[0].get('term_066', np.nan))
        if not np.isfinite(fox) or not np.isfinite(wolf) or wolf == 0.0:
            otter[dog] = np.nan
        else:
            otter[dog] = float((fox - wolf) / abs(wolf))
    return _make_factor_series(otter, date, universe=universe, name='factor737')

def factor738(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor738')

def factor739(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor739')

def factor740(universe, date, N=12, M=6):
    _set_asof_date(date)
    fox = list(universe)
    wolf = get_trade_days(end_date=date, count=N + M + 5)
    if wolf is None or len(wolf) < N + M + 1:
        rabbit = {otter: np.nan for otter in fox}
        return _make_factor_series(rabbit, date, universe=universe, name='factor740')
    dolphin = wolf[0]
    whale = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    bear = get_price(fox, start_date=whale, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if bear is None or bear.empty:
        rabbit = {otter: np.nan for otter in fox}
        return _make_factor_series(rabbit, date, universe=universe, name='factor740')
    koala = bear.pivot(index='time', columns='code', values='close').sort_index()
    rabbit = {}
    for otter in fox:
        if otter not in koala.columns:
            rabbit[otter] = np.nan
            continue
        zebra = koala[otter].dropna()
        if len(zebra) < N + M:
            rabbit[otter] = np.nan
            continue
        lion = zebra.values
        dog = []
        for giraffe in range(N, len(lion)):
            tiger = lion[giraffe - N]
            if tiger == 0:
                dog.append(np.nan)
            else:
                dog.append((lion[giraffe] - tiger) / tiger)
        cat = pd.Series(dog, index=zebra.index[N:])
        panda = pd.Series(np.nan, index=cat.index)
        for giraffe, shark in enumerate(cat.index):
            eagle = cat.iloc[giraffe]
            if np.isnan(eagle):
                continue
            if giraffe == 0 or np.isnan(panda.iloc[giraffe - 1]):
                panda.iloc[giraffe] = eagle
            else:
                panda.iloc[giraffe] = (eagle + (M - 1) * panda.iloc[giraffe - 1]) / M
        rabbit[otter] = float(panda.iloc[-1])
    return _make_factor_series(rabbit, date, universe=universe, name='factor740')

def factor741(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor741')

def factor742(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor742')

def factor743(universe, date, M_days=20, freq='5m', code_chunk=200, min_days=10, large_threshold=800):
    _set_asof_date(date)
    lion = _to_date(date)
    dog = list(universe)
    lizard = freq
    if lizard == '1m' and len(dog) >= int(large_threshold):
        lizard = '5m'
    koala = get_trade_days(end_date=lion, count=int(M_days))
    if koala is None or len(koala) < 2:
        return _make_factor_series({cat: np.nan for cat in dog}, date, universe=universe, name='factor743')
    otter = [pd.to_datetime(frog).date() for frog in koala]
    turtle = set(otter)
    hawk = otter[0]
    wolf = otter[-1]
    sparrow = pd.to_datetime(hawk).strftime('%Y-%m-%d')
    bear = pd.to_datetime(wolf + dt.timedelta(days=1)).strftime('%Y-%m-%d')
    shark = []
    for zebra in range(0, len(dog), int(code_chunk)):
        owl = dog[zebra:zebra + int(code_chunk)]
        fox = get_price(owl, start_date=sparrow, end_date=bear, frequency=lizard, fields=['close'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        fox['time'] = pd.to_datetime(fox['time'])
        fox['date'] = fox['time'].dt.date
        fox = fox[fox['date'].isin(turtle)]
        if fox.empty:
            continue
        fox = fox.sort_values(['code', 'date', 'time'])
        fox['log_close'] = np.log(pd.to_numeric(fox['close'], errors='coerce').astype(float))
        fox['log_close_prev'] = fox.groupby(['code', 'date'], sort=False)['log_close'].shift(1)
        fox['r'] = fox['log_close'] - fox['log_close_prev']
        fox = fox[np.isfinite(fox['r'].values)]
        if fox.empty:
            continue
        fox['r2'] = fox['r'] * fox['r']
        fox['r2_pos'] = fox['r2'].where(fox['r'] > 0.0, 0.0)
        giraffe = fox.groupby(['code', 'date'], sort=False).agg(den=('r2', 'sum'), num=('r2_pos', 'sum'))
        eagle = giraffe['num'] / giraffe['den']
        eagle[~np.isfinite(eagle) | (giraffe['den'] <= 0.0)] = np.nan
        shark.append(eagle)
    if not shark:
        return _make_factor_series({cat: np.nan for cat in dog}, date, universe=universe, name='factor743')
    panda = pd.concat(shark).groupby(level=[0, 1], sort=False).mean()
    tiger = panda.unstack('date').reindex(index=dog, columns=otter)
    dolphin = tiger.mean(axis=1, skipna=True)
    whale = tiger.notna().sum(axis=1)
    dolphin.loc[whale < int(min_days)] = np.nan
    rabbit = {cat: float(dolphin.get(cat, np.nan)) for cat in dog}
    return _make_factor_series(rabbit, date, universe=universe, name='factor743')

def factor744(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor744')

def factor745(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    fox = _to_date(date)
    otter = list(universe)
    zebra = int(min_valid_quarters)
    wolf = get_history_fundamentals(security=otter, fields=[wolf.term_010], watch_date=fox, count=4, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({tiger: np.nan for tiger in otter}, date, universe=universe, name='factor745')
    wolf = wolf.copy()
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    wolf = wolf.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    lion = pd.Series(np.nan, index=otter, dtype='float64')
    for koala in otter:
        whale = wolf[wolf['code'] == koala].tail(4)['term_010'].astype(float).to_numpy()
        if np.isfinite(whale).sum() < zebra:
            continue
        lion.loc[koala] = float(np.nansum(whale))
    bear = get_history_fundamentals(security=otter, fields=[fox.term_081], watch_date=fox, count=2, interval='1q', stat_by_year=False)
    if bear is None or bear.empty:
        return _make_factor_series({tiger: np.nan for tiger in otter}, date, universe=universe, name='factor745')
    bear = bear.copy()
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    bear = bear.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    dog = pd.Series(np.nan, index=otter, dtype='float64')
    for koala in otter:
        rabbit = bear[bear['code'] == koala].tail(2)
        if rabbit.shape[0] < 2:
            continue
        cat = float(rabbit.iloc[0].get('term_081', np.nan))
        panda = float(rabbit.iloc[1].get('term_081', np.nan))
        if np.isfinite(cat) and np.isfinite(panda):
            dog.loc[koala] = (cat + panda) / 2.0
    dolphin = (lion / dog.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    giraffe = {tiger: float(dolphin.get(tiger, np.nan)) for tiger in otter}
    return _make_factor_series(giraffe, date, universe=universe, name='factor745')

def factor746(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor746')

def factor747(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor747')

def factor748(universe, date, D_days=60, z=2.0):
    _set_asof_date(date)
    tiger = list(universe)
    lion = get_trade_days(end_date=date, count=D_days + 1)
    if lion is None or len(lion) < D_days + 1:
        otter = {panda: np.nan for panda in tiger}
        return _make_factor_series(otter, date, universe=universe, name='factor748')
    giraffe = lion[0]
    zebra = pd.to_datetime(giraffe).strftime('%Y-%m-%d')
    koala = get_price(tiger, start_date=zebra, end_date=date, frequency='daily', fields=['close'], fq='post', panel=False)
    if koala is None or koala.empty:
        otter = {panda: np.nan for panda in tiger}
        return _make_factor_series(otter, date, universe=universe, name='factor748')
    dog = koala.pivot(index='time', columns='code', values='close').sort_index()
    wolf = dog.pct_change().iloc[-D_days:]
    otter = {}
    for panda in tiger:
        if panda not in wolf.columns:
            otter[panda] = np.nan
            continue
        bear = wolf[panda].dropna()
        if len(bear) < 10:
            otter[panda] = np.nan
            continue
        rabbit = bear.std(ddof=1)
        if rabbit == 0 or np.isnan(rabbit):
            otter[panda] = np.nan
            continue
        fox = np.abs(bear) > z * rabbit
        if not fox.any():
            otter[panda] = 0.0
            continue
        cat = np.exp(np.abs(bear[fox]).sum()) - 1.0
        otter[panda] = float(cat)
    return _make_factor_series(otter, date, universe=universe, name='factor748')

def factor749(universe, date, N=20):
    _set_asof_date(date)
    tiger = list(universe)
    lion = get_trade_days(end_date=date, count=N + 1)
    if lion is None or len(lion) < N + 1:
        otter = {panda: np.nan for panda in tiger}
        return _make_factor_series(otter, date, universe=universe, name='factor749')
    shark = lion[0]
    eagle = pd.to_datetime(shark).strftime('%Y-%m-%d')
    koala = get_price(tiger, start_date=eagle, end_date=date, frequency='daily', fields=['close', 'money'], fq='post', panel=False)
    if koala is None or koala.empty:
        otter = {panda: np.nan for panda in tiger}
        return _make_factor_series(otter, date, universe=universe, name='factor749')
    dog = koala.pivot(index='time', columns='code', values='close').sort_index()
    bear = koala.pivot(index='time', columns='code', values='money').sort_index()
    zebra = dog.pct_change().iloc[-N:]
    wolf = bear.iloc[-N:]
    otter = {}
    for panda in tiger:
        if panda not in zebra.columns or panda not in wolf.columns:
            otter[panda] = np.nan
            continue
        dolphin = zebra[panda].dropna()
        cat = wolf[panda].reindex(dolphin.index).astype(float)
        rabbit = (cat > 0) & ~dolphin.isna()
        if rabbit.sum() < 5:
            otter[panda] = np.nan
            continue
        fox = (dolphin[rabbit].abs() / cat[rabbit]).replace([np.inf, -np.inf], np.nan).dropna()
        if fox.size < 5:
            otter[panda] = np.nan
            continue
        giraffe = fox.mean()
        whale = fox.std(ddof=1)
        if giraffe == 0 or np.isnan(giraffe):
            otter[panda] = 0.0
        else:
            otter[panda] = float(whale / giraffe)
    return _make_factor_series(otter, date, universe=universe, name='factor749')

def factor750(universe, date, T=20):
    _set_asof_date(date)
    wolf = list(universe)
    bear = _to_date(date)
    rabbit = get_trade_days(end_date=bear, count=int(T) + 1)
    if rabbit is None or len(rabbit) < int(T) + 1:
        eagle = {fox: np.nan for fox in wolf}
        return _make_factor_series(eagle, date, universe=universe, name='factor750')
    alpaca = [pd.to_datetime(lemur).date() for lemur in rabbit]
    salmon = alpaca[0]
    dolphin = alpaca[-1]
    tuna = pd.to_datetime(salmon).strftime('%Y-%m-%d')
    whale = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    zebra = get_price(wolf, start_date=tuna, end_date=whale, frequency='daily', fields=['close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        eagle = {fox: np.nan for fox in wolf}
        return _make_factor_series(eagle, date, universe=universe, name='factor750')
    otter = zebra.pivot(index='time', columns='code', values='close').sort_index()
    if otter.shape[0] < 2:
        eagle = {fox: np.nan for fox in wolf}
        return _make_factor_series(eagle, date, universe=universe, name='factor750')
    lizard = (otter.iloc[-1] / otter.iloc[0] - 1.0).reindex(wolf).astype(float).replace([np.inf, -np.inf], np.nan)
    hawk = get_money_flow_pro(wolf, start_date=tuna, end_date=whale, frequency='daily', fields=['inflow_s', 'outflow_s'], data_type='money')
    if hawk is None or hawk.empty:
        eagle = {fox: np.nan for fox in wolf}
        return _make_factor_series(eagle, date, universe=universe, name='factor750')
    hawk = hawk.copy()
    if 'time' in hawk.columns:
        hawk['date'] = pd.to_datetime(hawk['time']).dt.date
    elif 'day' in hawk.columns:
        hawk['date'] = pd.to_datetime(hawk['day']).dt.date
    else:
        hawk['date'] = pd.to_datetime(hawk.index).date
    if 'inflow_s' not in hawk.columns or 'outflow_s' not in hawk.columns:
        eagle = {fox: np.nan for fox in wolf}
        return _make_factor_series(eagle, date, universe=universe, name='factor750')
    hawk['netflow_s'] = hawk['inflow_s'].astype(float) - hawk['outflow_s'].astype(float)
    owl = hawk.groupby(['date', 'code'], sort=False)['netflow_s'].sum().unstack('code').reindex(index=alpaca, columns=wolf)
    cat = pd.Series(np.nan, index=wolf, dtype='float64')
    for fox in wolf:
        frog = owl[fox].astype(float).values
        frog = frog[np.isfinite(frog)]
        if frog.size == 0:
            continue
        giraffe = float(np.sum(np.abs(frog)))
        if giraffe <= 0.0 or not np.isfinite(giraffe):
            continue
        cat.loc[fox] = float(np.sum(frog) / giraffe)
    sparrow = cat.notna() & lizard.notna()
    if sparrow.sum() < 3:
        eagle = {fox: np.nan for fox in wolf}
        return _make_factor_series(eagle, date, universe=universe, name='factor750')
    tiger = cat[sparrow].values.astype(float)
    dog = lizard[sparrow].values.astype(float)
    panda = np.column_stack([np.ones(sparrow.sum()), dog])
    koala, lion, lion, lion = np.linalg.lstsq(panda, tiger, rcond=None)
    shark = tiger - panda @ koala
    turtle = pd.Series(np.nan, index=wolf, dtype='float64')
    turtle.loc[sparrow.index[sparrow]] = shark
    eagle = {fox: float(turtle.get(fox, np.nan)) for fox in wolf}
    return _make_factor_series(eagle, date, universe=universe, name='factor750')

def factor751(universe, date):
    _set_asof_date(date)
    rabbit = _to_date(date)
    koala = pd.Timestamp(rabbit)
    bear = list(universe)
    owl = pd.Period(koala, freq='Q-DEC') - 1
    sparrow = pd.PeriodIndex([owl], freq='Q-DEC')

    def _prep_hist(df: pd.DataFrame) -> pd.DataFrame:
        if df is None or df.empty:
            return pd.DataFrame()
        cat = df.copy()
        cat['code'] = cat['code'].astype(str)
        cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        cat = cat.dropna(subset=['code', 'statDate'])
        if cat.empty:
            return pd.DataFrame()
        cat['q'] = cat['statDate'].dt.to_period('Q-DEC')
        cat = cat.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
        return cat
    zebra = get_history_fundamentals(security=bear, fields=[bear.term_060, bear.term_076, bear.term_004], watch_date=koala, count=8, interval='1q', stat_by_year=False)
    shark = _prep_hist(zebra)
    if shark.empty:
        return _make_factor_series({wolf: np.nan for wolf in bear}, rabbit, universe=universe, name='factor751')
    shark = shark[shark['q'].isin(sparrow)]
    if shark.empty:
        return _make_factor_series({wolf: np.nan for wolf in bear}, rabbit, universe=universe, name='factor751')

    def _pivot_inc(col):
        if col not in inc.columns:
            return pd.Series(np.nan, index=codes, dtype='float64')
        cat = inc.pivot(index='q', columns='code', values=col).reindex(index=q_need, columns=codes)
        cat = cat.apply(pd.to_numeric, errors='coerce').astype(float)
        return cat.loc[q_t] if q_t in cat.index else pd.Series(np.nan, index=codes, dtype='float64')
    hawk = _pivot_inc('term_060')
    frog = _pivot_inc('term_076')
    lion = _pivot_inc('term_004')
    panda = hawk + frog + lion
    giraffe = get_history_fundamentals(security=bear, fields=[fox.term_025], watch_date=koala, count=8, interval='1q', stat_by_year=False)
    otter = _prep_hist(giraffe)
    if otter.empty:
        return _make_factor_series({wolf: np.nan for wolf in bear}, rabbit, universe=universe, name='factor751')
    otter = otter[otter['q'].isin(sparrow)]
    if otter.empty:
        return _make_factor_series({wolf: np.nan for wolf in bear}, rabbit, universe=universe, name='factor751')
    dolphin = otter.pivot(index='q', columns='code', values='term_025').reindex(index=sparrow, columns=bear)
    dolphin = dolphin.apply(pd.to_numeric, errors='coerce').astype(float)
    dog = dolphin.loc[owl] if owl in dolphin.index else pd.Series(np.nan, index=bear, dtype='float64')
    eagle = np.isfinite(panda) & np.isfinite(dog)
    if int(eagle.sum()) < 3:
        return _make_factor_series({wolf: np.nan for wolf in bear}, rabbit, universe=universe, name='factor751')
    tuna = panda[eagle].values.astype(float)
    salmon = dog[eagle].values.astype(float)
    cat = np.column_stack([np.ones_like(salmon), salmon])
    try:
        fox, tiger, tiger, tiger = np.linalg.lstsq(cat, tuna, rcond=None)
    except Exception:
        return _make_factor_series({wolf: np.nan for wolf in bear}, rabbit, universe=universe, name='factor751')
    turtle = tuna - cat @ fox
    lizard = pd.Series(turtle, index=panda[eagle].index)
    alpaca = _zscore_series(lizard).reindex(bear)
    whale = {wolf: float(alpaca.get(wolf)) if np.isfinite(alpaca.get(wolf, np.nan)) else np.nan for wolf in bear}
    return _make_factor_series(whale, rabbit, universe=universe, name='factor751')

def factor752(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor752')

def factor753(universe, date, use_log=True):
    _set_asof_date(date)
    panda = _to_date(date)
    dog = list(universe)
    wolf = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(dog))
    tiger = get_fundamentals(wolf, date=panda)
    if tiger is None or tiger.empty:
        return _make_factor_series({cat: np.nan for cat in dog}, date, universe=universe, name='factor753' if use_log else 'factor753')
    tiger = tiger.set_index('code')
    koala = pd.to_numeric(tiger.get('term_045', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(dog)
    fox = pd.Series(np.nan, index=dog, dtype='float64')
    otter = np.isfinite(koala.values) & (koala.values > 0.0)
    if use_log:
        fox.loc[otter] = np.log(koala.loc[otter].values)
    else:
        fox.loc[otter] = koala.loc[otter].values
    lion = {cat: float(fox.get(cat, np.nan)) for cat in dog}
    return _make_factor_series(lion, date, universe=universe, name='factor753' if use_log else 'factor753')

def factor754(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor754')

def factor755(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor755')

def factor756(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor756')

def factor757(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor757')

def factor758(universe, date, N_days=20, freq='5m', code_chunk=200, min_days=10, large_threshold=800):
    _set_asof_date(date)
    giraffe = _to_date(date)
    fox = list(universe)
    iguana = freq
    if iguana == '1m' and len(fox) >= int(large_threshold):
        iguana = '5m'
    zebra = get_trade_days(end_date=giraffe, count=int(N_days))
    if zebra is None or len(zebra) < 2:
        return _make_factor_series({otter: np.nan for otter in fox}, date, universe=universe, name='factor758')
    dolphin = [pd.to_datetime(llama).date() for llama in zebra]
    hyena = set(dolphin)
    donkey = dolphin[0]
    hawk = dolphin[-1]
    ferret = pd.to_datetime(donkey).strftime('%Y-%m-%d')
    sparrow = pd.to_datetime(hawk + dt.timedelta(days=1)).strftime('%Y-%m-%d')
    rabbit = []
    for turtle in range(0, len(fox), int(code_chunk)):
        gecko = fox[turtle:turtle + int(code_chunk)]
        shark = get_price(gecko, start_date=ferret, end_date=sparrow, frequency=iguana, fields=['close', 'volume'], fq='post', panel=False)
        if shark is None or shark.empty:
            continue
        shark = shark.copy()
        shark['time'] = pd.to_datetime(shark['time'])
        shark['date'] = shark['time'].dt.date
        shark = shark[shark['date'].isin(hyena)]
        if shark.empty:
            continue
        llama = pd.to_numeric(shark['close'], errors='coerce').astype(float)
        mole = pd.to_numeric(shark['volume'], errors='coerce').astype(float)
        lizard = np.isfinite(llama.values) & np.isfinite(mole.values)
        shark = shark.loc[lizard, ['code', 'date']].copy()
        shark['x'] = llama.loc[lizard].values
        shark['y'] = mole.loc[lizard].values
        shark['xy'] = shark['x'] * shark['y']
        shark['x2'] = shark['x'] * shark['x']
        shark['y2'] = shark['y'] * shark['y']
        tiger = shark.groupby(['code', 'date'], sort=False).agg(n=('x', 'count'), sx=('x', 'sum'), sy=('y', 'sum'), sxy=('xy', 'sum'), sx2=('x2', 'sum'), sy2=('y2', 'sum'))
        tuna = tiger['n'].astype(float)
        alpaca = tuna * tiger['sxy'] - tiger['sx'] * tiger['sy']
        jaguar = tuna * tiger['sx2'] - tiger['sx'] * tiger['sx']
        kangaroo = tuna * tiger['sy2'] - tiger['sy'] * tiger['sy']
        whale = np.sqrt(jaguar * kangaroo)
        wolf = alpaca / whale
        wolf[(tiger['n'] < 3) | ~np.isfinite(wolf) | ~np.isfinite(whale) | (whale <= 0)] = np.nan
        rabbit.append(wolf.rename('corr'))
    if not rabbit:
        return _make_factor_series({otter: np.nan for otter in fox}, date, universe=universe, name='factor758')
    wolf = pd.concat(rabbit).groupby(level=[0, 1], sort=False).mean()
    bear = wolf.unstack('date').reindex(index=fox, columns=dolphin)
    lion = bear.mean(axis=1, skipna=True)
    lemur = bear.notna().sum(axis=1)
    lion.loc[lemur < int(min_days)] = np.nan
    badger = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(fox))
    eagle = get_fundamentals(badger, date=giraffe)
    if eagle is None or eagle.empty:
        return _make_factor_series({otter: np.nan for otter in fox}, date, universe=universe, name='factor758')
    eagle = eagle.set_index('code')
    salmon = pd.to_numeric(eagle.get('term_045', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(fox)
    mole = lion
    llama = np.log(salmon.replace(0.0, np.nan))
    frog = mole.notna() & llama.notna()
    if frog.sum() < 5:
        return _make_factor_series({otter: np.nan for otter in fox}, date, universe=universe, name='factor758')
    cat = np.column_stack([np.ones(frog.sum()), llama[frog].values.astype(float)])
    dog = mole[frog].values.astype(float)
    koala, panda, panda, panda = np.linalg.lstsq(cat, dog, rcond=None)
    camel = dog - cat @ koala
    beaver = pd.Series(np.nan, index=fox, dtype='float64')
    beaver.loc[frog.index[frog]] = camel
    owl = {otter: float(beaver.get(otter, np.nan)) for otter in fox}
    return _make_factor_series(owl, date, universe=universe, name='factor758')

def factor759(universe, date, max_lag=10):
    _set_asof_date(date)
    lion = list(universe)
    try:
        koala = get_factor_values(lion, factors=['term_053'], end_date=date, count=max_lag)
        fox = koala['term_053']
    except Exception:
        fox = None
    otter = {}
    if fox is None or fox.empty:
        otter = {tiger: np.nan for tiger in lion}
        return _make_factor_series(otter, date, universe=universe, name='factor759')
    for tiger in lion:
        bear = fox[tiger].dropna().values
        if len(bear) < 5:
            otter[tiger] = np.nan
            continue
        giraffe = bear[1:]
        rabbit = bear[:-1]
        cat = np.column_stack([np.ones(len(rabbit)), rabbit])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, giraffe, rcond=None)
            wolf = giraffe - cat @ panda
            if len(wolf) < 3:
                otter[tiger] = np.nan
            else:
                otter[tiger] = float(np.std(wolf, ddof=1))
        except Exception:
            otter[tiger] = np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor759')

def factor760(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor760')

def factor761(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor761')

def factor762(universe, date, max_lag=10):
    _set_asof_date(date)
    lion = list(universe)
    try:
        koala = get_factor_values(lion, factors=['term_053'], end_date=date, count=max_lag)
        fox = koala['term_053']
    except Exception:
        fox = None
    otter = {}
    if fox is None or fox.empty:
        otter = {tiger: np.nan for tiger in lion}
        return _make_factor_series(otter, date, universe=universe, name='factor762')
    for tiger in lion:
        wolf = fox[tiger].dropna().values
        if len(wolf) < 5:
            otter[tiger] = np.nan
            continue
        rabbit = wolf[1:]
        bear = wolf[:-1]
        cat = np.column_stack([np.ones(len(bear)), bear])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, rabbit, rcond=None)
            otter[tiger] = float(panda[1])
        except Exception:
            otter[tiger] = np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor762')

def factor763(universe, date, N=20):
    _set_asof_date(date)
    lion = list(universe)
    koala = get_trade_days(end_date=date, count=N + 1)
    if koala is None or len(koala) < N + 1:
        fox = {tiger: np.nan for tiger in lion}
        return _make_factor_series(fox, date, universe=universe, name='factor763')
    zebra = koala[0]
    dolphin = pd.to_datetime(zebra).strftime('%Y-%m-%d')
    otter = get_price(lion, start_date=dolphin, end_date=date, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if otter is None or otter.empty:
        fox = {tiger: np.nan for tiger in lion}
        return _make_factor_series(fox, date, universe=universe, name='factor763')
    panda = otter.pivot(index='time', columns='code', values='close').sort_index()
    shark = otter.pivot(index='time', columns='code', values='volume').sort_index()
    panda = panda.iloc[-(N + 1):]
    shark = shark.loc[panda.index]
    rabbit = panda.pct_change().iloc[1:]
    dog = panda.iloc[1:]
    whale = shark.iloc[1:]
    fox = {}
    for tiger in lion:
        if tiger not in rabbit.columns:
            fox[tiger] = np.nan
            continue
        giraffe = rabbit[tiger].dropna()
        if giraffe.empty:
            fox[tiger] = np.nan
            continue
        cat = (dog[tiger] * whale[tiger]).reindex(giraffe.index)
        bear = (cat > 0) & ~giraffe.isna()
        if bear.sum() < 5:
            fox[tiger] = np.nan
            continue
        wolf = (giraffe[bear].abs() / cat[bear]).replace([np.inf, -np.inf], np.nan).dropna()
        if wolf.empty:
            fox[tiger] = np.nan
        else:
            fox[tiger] = float(wolf.mean())
    return _make_factor_series(fox, date, universe=universe, name='factor763')

def factor764(universe, date, T=20, n_neighbors=10):
    _set_asof_date(date)
    bear = _to_date(date)
    fox = list(universe)
    rabbit = get_trade_days(end_date=bear, count=int(T))
    if rabbit is None or len(rabbit) < 2:
        return _make_factor_series({lion: np.nan for lion in fox}, date, universe=universe, name='factor764')
    salmon = pd.to_datetime(rabbit[0]).strftime('%Y-%m-%d')
    whale = pd.to_datetime(rabbit[-1]).strftime('%Y-%m-%d')
    zebra = get_price(fox, start_date=salmon, end_date=whale, frequency='daily', fields=['volume'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        return _make_factor_series({lion: np.nan for lion in fox}, date, universe=universe, name='factor764')
    badger = zebra.pivot(index='time', columns='code', values='volume').sort_index().reindex(columns=fox)
    turtle = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(fox))
    dolphin = get_fundamentals(turtle, date=bear)
    if dolphin is None or dolphin.empty:
        return _make_factor_series({lion: np.nan for lion in fox}, date, universe=universe, name='factor764')
    dolphin = dolphin.set_index('code')
    koala = pd.to_numeric(dolphin.get('circulating_cap', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(fox)
    giraffe = (koala * 10000.0).replace(0.0, np.nan)
    lemur = badger.divide(giraffe, axis=1).replace([np.inf, -np.inf], np.nan)
    tuna = lemur.mean(axis=0, skipna=True).reindex(fox)
    wolf = sorted(fox)
    alpaca = tuna.reindex(wolf)
    beaver = int(n_neighbors) * 2 + 1
    sparrow = alpaca.rolling(beaver, center=True, min_periods=1).mean()
    otter = alpaca.rolling(beaver, center=True, min_periods=1).count()
    frog = alpaca.rolling(beaver, center=True, min_periods=1).sum()
    owl = (frog - alpaca) / (otter - 1)
    owl = owl.where(otter - 1 > 0, np.nan)
    hawk = alpaca.notna() & owl.notna()
    if hawk.sum() < 5:
        return _make_factor_series({lion: np.nan for lion in fox}, date, universe=universe, name='factor764')
    dog = alpaca[hawk].values.astype(float)
    cat = np.column_stack([np.ones(hawk.sum()), owl[hawk].values.astype(float)])
    tiger, panda, panda, panda = np.linalg.lstsq(cat, dog, rcond=None)
    lizard = dog - cat @ tiger
    shark = pd.Series(np.nan, index=wolf, dtype='float64')
    shark.loc[hawk.index[hawk]] = lizard
    eagle = {lion: float(shark.get(lion, np.nan)) for lion in fox}
    return _make_factor_series(eagle, date, universe=universe, name='factor764')

def factor765(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    cat = pd.Timestamp(otter)
    lion = list(universe)
    whale = pd.Period(cat, freq='Q-DEC') - 1
    dolphin = pd.PeriodIndex([whale], freq='Q-DEC')
    fox = get_history_fundamentals(security=lion, fields=[fox.total_owner_equities], watch_date=cat, count=20, interval='1q', stat_by_year=False)
    if fox is None or fox.empty or 'code' not in fox.columns or ('statDate' not in fox.columns) or ('total_owner_equities' not in fox.columns):
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor765')
    koala = fox.copy()
    koala['code'] = koala['code'].astype(str)
    koala['statDate'] = pd.to_datetime(koala['statDate'], errors='coerce')
    koala = koala.dropna(subset=['code', 'statDate'])
    if koala.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor765')
    koala['q'] = koala['statDate'].dt.to_period('Q-DEC')
    koala = koala[koala['q'].isin(dolphin)]
    if koala.empty:
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor765')
    koala = koala.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    panda = koala.pivot(index='q', columns='code', values='total_owner_equities').reindex(index=dolphin, columns=lion)
    panda = panda.apply(pd.to_numeric, errors='coerce').astype(float)
    dog = panda.loc[whale] if whale in panda.index else pd.Series(np.nan, index=lion, dtype='float64')

    def _nearest_td_le(d_):
        cat = get_trade_days(end_date=d_, count=1)
        if not cat:
            return None
        return pd.to_datetime(cat[0]).date()
    eagle = _nearest_td_le(otter)
    if eagle is None:
        return _make_factor_series({tiger: np.nan for tiger in lion}, otter, universe=universe, name='factor765')
    shark = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(lion))
    wolf = get_fundamentals(shark, date=pd.Timestamp(eagle).strftime('%Y-%m-%d'))
    if wolf is None or wolf.empty or 'code' not in wolf.columns:
        giraffe = pd.Series(np.nan, index=lion, dtype='float64')
    else:
        hawk = wolf.copy()
        hawk['code'] = hawk['code'].astype(str)
        giraffe = pd.to_numeric(hawk.set_index('code').get('term_045', np.nan), errors='coerce').astype(float).reindex(lion)
    giraffe = giraffe.where(np.isfinite(giraffe) & (giraffe > 0), np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = dog / giraffe
    zebra = zebra.replace([np.inf, -np.inf], np.nan)
    rabbit = ~np.isfinite(zebra) | ~np.isfinite(dog) | ~np.isfinite(giraffe) | (giraffe <= 0)
    zebra = zebra.where(~rabbit, np.nan).reindex(lion)
    bear = {tiger: float(zebra.get(tiger)) if np.isfinite(zebra.get(tiger, np.nan)) else np.nan for tiger in lion}
    return _make_factor_series(bear, otter, universe=universe, name='factor765')

def factor766(universe, date, N_days=20, freq='5m', code_chunk=200, min_days=10, large_threshold=800):
    _set_asof_date(date)
    wolf = _to_date(date)
    tiger = list(universe)
    lemur = freq
    if lemur == '1m' and len(tiger) >= int(large_threshold):
        lemur = '5m'
    bear = get_trade_days(end_date=wolf, count=int(N_days))
    if bear is None or len(bear) < 2:
        return _make_factor_series({panda: np.nan for panda in tiger}, date, universe=universe, name='factor766')
    rabbit = [pd.to_datetime(camel).date() for camel in bear]
    alpaca = set(rabbit)
    lizard = rabbit[0]
    dolphin = rabbit[-1]
    frog = pd.to_datetime(lizard).strftime('%Y-%m-%d')
    whale = pd.to_datetime(dolphin + dt.timedelta(days=1)).strftime('%Y-%m-%d')
    fox = []
    for eagle in range(0, len(tiger), int(code_chunk)):
        tuna = tiger[eagle:eagle + int(code_chunk)]
        zebra = get_price(tuna, start_date=frog, end_date=whale, frequency=lemur, fields=['close', 'volume'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        zebra['time'] = pd.to_datetime(zebra['time'])
        zebra['date'] = zebra['time'].dt.date
        zebra = zebra[zebra['date'].isin(alpaca)]
        if zebra.empty:
            continue
        camel = pd.to_numeric(zebra['close'], errors='coerce').astype(float)
        donkey = pd.to_numeric(zebra['volume'], errors='coerce').astype(float)
        hawk = np.isfinite(camel.values) & np.isfinite(donkey.values)
        zebra = zebra.loc[hawk, ['code', 'date']].copy()
        zebra['x'] = camel.loc[hawk].values
        zebra['y'] = donkey.loc[hawk].values
        zebra['xy'] = zebra['x'] * zebra['y']
        zebra['x2'] = zebra['x'] * zebra['x']
        zebra['y2'] = zebra['y'] * zebra['y']
        cat = zebra.groupby(['code', 'date'], sort=False).agg(n=('x', 'count'), sx=('x', 'sum'), sy=('y', 'sum'), sxy=('xy', 'sum'), sx2=('x2', 'sum'), sy2=('y2', 'sum'))
        sparrow = cat['n'].astype(float)
        owl = sparrow * cat['sxy'] - cat['sx'] * cat['sy']
        badger = sparrow * cat['sx2'] - cat['sx'] * cat['sx']
        beaver = sparrow * cat['sy2'] - cat['sy'] * cat['sy']
        giraffe = np.sqrt(badger * beaver)
        koala = owl / giraffe
        koala[(cat['n'] < 3) | ~np.isfinite(koala) | ~np.isfinite(giraffe) | (giraffe <= 0)] = np.nan
        fox.append(koala.rename('corr'))
    if not fox:
        return _make_factor_series({panda: np.nan for panda in tiger}, date, universe=universe, name='factor766')
    koala = pd.concat(fox).groupby(level=[0, 1], sort=False).mean()
    otter = koala.unstack('date').reindex(index=tiger, columns=rabbit)
    dog = otter.mean(axis=1, skipna=True)
    salmon = otter.std(axis=1, ddof=1, skipna=True)
    turtle = otter.notna().sum(axis=1)
    dog.loc[turtle < int(min_days)] = np.nan
    salmon.loc[turtle < int(min_days)] = np.nan
    ferret = _zscore_series(dog)
    gecko = _zscore_series(salmon)
    lion = (ferret + gecko).reindex(tiger)
    shark = {panda: float(lion.get(panda, np.nan)) for panda in tiger}
    return _make_factor_series(shark, date, universe=universe, name='factor766')

def factor767(universe, date):
    _set_asof_date(date)
    tiger = list(universe)
    lion = pd.to_datetime(date)
    wolf = get_trade_days(end_date=lion, count=1)
    if wolf is None or len(wolf) == 0:
        rabbit = {panda: np.nan for panda in tiger}
        return _make_factor_series(rabbit, date, universe=universe, name='factor767')
    koala = wolf[-1]
    fox = pd.to_datetime(koala).strftime('%Y-%m-%d')
    otter = (pd.to_datetime(koala) + dt.timedelta(days=1)).strftime('%Y-%m-%d')
    bear = get_price(tiger, start_date=fox, end_date=otter, frequency='daily', fields=['high', 'low'], fq='post', panel=False)
    if bear is None or bear.empty:
        rabbit = {panda: np.nan for panda in tiger}
        return _make_factor_series(rabbit, date, universe=universe, name='factor767')
    giraffe = bear.pivot(index='time', columns='code', values='high').sort_index()
    zebra = bear.pivot(index='time', columns='code', values='low').sort_index()
    rabbit = {}
    for panda in tiger:
        if panda not in giraffe.columns or panda not in zebra.columns:
            rabbit[panda] = np.nan
            continue
        cat = float(giraffe[panda].dropna().iloc[-1]) if giraffe[panda].notna().any() else np.nan
        dog = float(zebra[panda].dropna().iloc[-1]) if zebra[panda].notna().any() else np.nan
        if np.isnan(cat) or np.isnan(dog) or cat <= 0 or (dog <= 0):
            rabbit[panda] = np.nan
            continue
        if cat == dog:
            rabbit[panda] = 0.0
            continue
        dolphin = float(np.log(cat / dog) ** 2)
        rabbit[panda] = dolphin
    return _make_factor_series(rabbit, date, universe=universe, name='factor767')

def factor768(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    lion = list(universe)
    wolf = get_history_fundamentals(security=lion, fields=[wolf.term_047], watch_date=koala, count=5, interval='1q', stat_by_year=False)
    bear = get_history_fundamentals(security=lion, fields=[bear.term_066], watch_date=koala, count=5, interval='1q', stat_by_year=False)
    fox = _r3_merge_history_fundamentals(wolf, bear)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor768')
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    giraffe = {}
    for tiger in lion:
        rabbit = fox[fox['code'] == tiger].sort_values('statDate').drop_duplicates('statDate')
        if rabbit.shape[0] < 5:
            giraffe[tiger] = np.nan
            continue
        rabbit = rabbit.tail(5)
        dog = -rabbit['term_047'].astype(float).to_numpy()[-4:]
        zebra = rabbit['term_066'].astype(float).to_numpy()[-4:]
        if np.isfinite(dog).sum() < 4 or np.isfinite(zebra).sum() < 4:
            giraffe[tiger] = np.nan
            continue
        if np.any(zebra == 0.0):
            giraffe[tiger] = np.nan
            continue
        cat = dog / zebra
        panda = cat[-1]
        otter = float(np.mean(cat[:-1]))
        if not np.isfinite(panda) or not np.isfinite(otter) or otter == 0.0:
            giraffe[tiger] = np.nan
        else:
            giraffe[tiger] = float(panda / otter - 1.0)
    return _make_factor_series(giraffe, date, universe=universe, name='factor768')

def factor769(universe, date, N=20):
    _set_asof_date(date)
    panda = list(universe)
    lion = _to_date(date)
    koala = get_trade_days(end_date=lion, count=int(N))
    if koala is None or len(koala) < int(N):
        bear = {dog: np.nan for dog in panda}
        return _make_factor_series(bear, date, universe=universe, name='factor769')
    shark = [pd.to_datetime(eagle).date() for eagle in koala]
    whale = pd.to_datetime(shark[0]).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(shark[-1]).strftime('%Y-%m-%d')
    otter = get_money_flow_pro(security_list=panda, start_date=whale, end_date=wolf, frequency='daily', fields=['inflow_xl', 'outflow_xl', 'inflow_s', 'outflow_s'], data_type='money')
    if otter is None or otter.empty:
        bear = {dog: np.nan for dog in panda}
        return _make_factor_series(bear, date, universe=universe, name='factor769')
    otter = otter.copy()
    if 'time' in otter.columns:
        otter['date'] = pd.to_datetime(otter['time']).dt.date
    elif 'day' in otter.columns:
        otter['date'] = pd.to_datetime(otter['day']).dt.date
    else:
        otter['date'] = pd.to_datetime(otter.index).date
    for cat in ['inflow_xl', 'outflow_xl', 'inflow_s', 'outflow_s']:
        if cat not in otter.columns:
            bear = {dog: np.nan for dog in panda}
            return _make_factor_series(bear, date, universe=universe, name='factor769')
    otter['netflow_xl'] = otter['inflow_xl'].astype(float) - otter['outflow_xl'].astype(float)
    otter['netflow_s'] = otter['inflow_s'].astype(float) - otter['outflow_s'].astype(float)
    rabbit = otter.groupby(['date', 'code'], sort=False)[['netflow_xl', 'netflow_s']].sum()
    rabbit = rabbit.reset_index()
    fox = rabbit.pivot(index='date', columns='code', values='netflow_xl').reindex(index=shark, columns=panda)
    dolphin = rabbit.pivot(index='date', columns='code', values='netflow_s').reindex(index=shark, columns=panda)
    bear = {}
    for dog in panda:
        zebra = pd.concat([fox[dog], dolphin[dog]], axis=1).dropna()
        if zebra.shape[0] < 5:
            bear[dog] = np.nan
            continue
        giraffe = zebra.rank()
        tiger = giraffe.corr().iloc[0, 1]
        bear[dog] = float(tiger) if np.isfinite(tiger) else np.nan
    return _make_factor_series(bear, date, universe=universe, name='factor769')

def factor770(universe, date, T_quarters=6):
    _set_asof_date(date)
    panda = list(universe)
    try:
        tiger = get_factor_values(panda, factors=['term_065'], end_date=date, count=int(T_quarters) + 1)
        koala = tiger.get('term_065', None)
    except Exception:
        koala = None
    if koala is None or koala.empty or koala.shape[0] < int(T_quarters) + 1:
        lion = {dog: np.nan for dog in panda}
        return _make_factor_series(lion, date, universe=universe, name='factor770')
    koala = koala.reindex(columns=panda).astype(float)
    wolf = koala.iloc[:-1]
    fox = koala.iloc[-1]
    cat = wolf.notna().sum(axis=0)
    otter = wolf.mean(axis=0, skipna=True)
    bear = wolf.std(axis=0, ddof=1, skipna=True)
    giraffe = (fox - otter) / bear
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    giraffe = giraffe.where(bear != 0, 0.0)
    rabbit = (cat >= 3) & fox.notna()
    giraffe = giraffe.where(rabbit, np.nan)
    lion = {dog: float(giraffe.get(dog, np.nan)) if np.isfinite(giraffe.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(lion, date, universe=universe, name='factor770')

def factor771(universe, date, bench_index='000905.XSHG', N_days=20, freq='5m', code_chunk=200):
    _set_asof_date(date)
    eagle = _to_date(date)
    whale = list(universe)
    sparrow = get_trade_days(end_date=eagle, count=int(N_days))
    if sparrow is None or len(sparrow) < int(N_days):
        return _make_factor_series({rabbit: np.nan for rabbit in whale}, date, universe=universe, name='factor771')
    owl = [pd.to_datetime(yak).date() for yak in sparrow]
    urchin = owl[0]
    alpaca = owl[-1]
    frog = get_price(whale, start_date=urchin, end_date=alpaca, frequency='daily', fields=['close'], fq='post', panel=False)
    if frog is None or frog.empty:
        mole = pd.Series(np.nan, index=whale, dtype='float64')
    else:
        zebra = frog.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=whale)
        if zebra.shape[0] < 2:
            mole = pd.Series(np.nan, index=whale, dtype='float64')
        else:
            mole = (zebra.iloc[-1] / zebra.iloc[0] - 1.0).astype(float).reindex(whale)
    seal = []
    penguin = list(dict.fromkeys(whale + [bench_index]))
    for donkey in range(0, len(penguin), int(code_chunk)):
        walrus = penguin[donkey:donkey + int(code_chunk)]
        lizard = get_price(walrus, start_date=urchin, end_date=alpaca + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if lizard is None or lizard.empty:
            continue
        lizard = lizard.copy()
        lizard['time'] = pd.to_datetime(lizard['time'])
        lizard['date'] = lizard['time'].dt.date
        lizard = lizard[lizard['date'].isin(owl)]
        if lizard.empty:
            continue
        lizard = lizard.sort_values(['code', 'date', 'time'])
        lizard['close'] = pd.to_numeric(lizard['close'], errors='coerce').astype(float)
        lizard = lizard[np.isfinite(lizard['close'].values)]
        if lizard.empty:
            continue
        jaguar = lizard.groupby(['code', 'date'], sort=False)['close'].first()
        giraffe = lizard.groupby(['code', 'date'], sort=False)['close'].last()
        wolf = lizard[lizard['time'].dt.hour < 12]
        hyena = wolf.groupby(['code', 'date'], sort=False)['close'].last()
        quail = pd.DataFrame({'open': jaguar, 'mid': hyena, 'close': giraffe}).reset_index()
        quail['r_am'] = np.where((quail['open'] > 0) & np.isfinite(quail['mid']), quail['mid'] / quail['open'] - 1.0, np.nan)
        quail['r_pm'] = np.where((quail['mid'] > 0) & np.isfinite(quail['close']), quail['close'] / quail['mid'] - 1.0, np.nan)
        seal.append(quail[['code', 'date', 'r_am', 'r_pm']])
    if not seal:
        return _make_factor_series({rabbit: np.nan for rabbit in whale}, date, universe=universe, name='factor771')
    raccoon = pd.concat(seal, ignore_index=True)
    kangaroo = raccoon.pivot_table(index='date', columns='code', values='r_am', aggfunc='last').reindex(index=owl)
    llama = raccoon.pivot_table(index='date', columns='code', values='r_pm', aggfunc='last').reindex(index=owl)
    if bench_index not in kangaroo.columns or bench_index not in llama.columns:
        return _make_factor_series({rabbit: np.nan for rabbit in whale}, date, universe=universe, name='factor771')
    vulture = pd.Series(np.nan, index=whale, dtype='float64')
    cat = kangaroo[bench_index]
    dog = llama[bench_index]
    for dolphin in whale:
        if dolphin not in kangaroo.columns or dolphin not in llama.columns:
            continue
        ant = kangaroo[dolphin]
        bee = llama[dolphin]
        koala = pd.concat([ant, bee], axis=0, ignore_index=True)
        panda = pd.concat([cat, dog], axis=0, ignore_index=True)
        ferret = ~(koala.isna() | panda.isna())
        if ferret.sum() < 6:
            continue
        otter = koala[ferret].values.astype(float)
        lion = panda[ferret].values.astype(float)
        if np.std(lion) == 0.0 or not np.isfinite(np.std(lion)):
            continue
        tiger = np.column_stack([np.ones_like(lion), lion])
        bear, fox, fox, fox = np.linalg.lstsq(tiger, otter, rcond=None)
        lemur = otter - tiger @ bear
        turkey = np.array(['am'] * len(owl) + ['pm'] * len(owl))[ferret.values]
        hawk = np.array(owl + owl, dtype=object)[ferret.values]
        badger = {}
        beaver = {}
        for shark, narwhal, tuna in zip(hawk, turkey, lemur):
            if narwhal == 'am':
                badger[shark] = tuna
            else:
                beaver[shark] = tuna
        turtle = []
        for shark in owl:
            if shark in badger and shark in beaver:
                turtle.append(badger[shark] - beaver[shark])
        turtle = np.asarray(turtle, dtype=float)
        turtle = turtle[np.isfinite(turtle)]
        if turtle.size < 5:
            continue
        iguana = float(np.mean(turtle))
        octopus = float(np.std(turtle, ddof=1))
        if not np.isfinite(octopus) or octopus == 0.0:
            continue
        vulture.loc[dolphin] = float(iguana / (octopus / np.sqrt(turtle.size)))
    gecko = vulture.notna() & mole.notna()
    camel = {rabbit: np.nan for rabbit in whale}
    if gecko.sum() < 3:
        for rabbit in whale:
            camel[rabbit] = float(vulture.get(rabbit, np.nan)) if np.isfinite(vulture.get(rabbit, np.nan)) else np.nan
        return _make_factor_series(camel, date, universe=universe, name='factor771')
    koala = vulture[gecko].values.astype(float)
    panda = mole[gecko].values.astype(float)
    tiger = np.column_stack([np.ones(gecko.sum()), panda])
    bear, fox, fox, fox = np.linalg.lstsq(tiger, koala, rcond=None)
    lemur = koala - tiger @ bear
    for rabbit, salmon in zip(vulture[gecko].index.tolist(), lemur):
        camel[rabbit] = float(salmon) if np.isfinite(salmon) else np.nan
    return _make_factor_series(camel, date, universe=universe, name='factor771')

def factor772(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor772')

def factor773(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor773')

def factor774(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor774')

def factor775(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor775')

def factor776(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor776')

def factor777(universe, date, window=20, freq='5m', code_chunk=200, large_threshold=800, min_days=10):
    _set_asof_date(date)
    koala = _to_date(date)
    panda = list(universe)
    otter = _last_n_trade_days(koala, int(window))
    if len(otter) < 2:
        return _make_factor_series({dog: np.nan for dog in panda}, date, universe=universe, name='factor777')
    lemur = freq
    if lemur == '1m' and len(panda) >= int(large_threshold):
        lemur = '5m'
    tuna = [pd.to_datetime(badger).date() for badger in otter]
    alpaca = set(tuna)
    lizard = tuna[0]
    bear = tuna[-1]
    frog = pd.to_datetime(lizard).strftime('%Y-%m-%d')
    rabbit = pd.to_datetime(bear + dt.timedelta(days=1)).strftime('%Y-%m-%d')
    owl = []
    for zebra in range(0, len(panda), int(code_chunk)):
        salmon = panda[zebra:zebra + int(code_chunk)]
        wolf = get_price(salmon, start_date=frog, end_date=rabbit, frequency=lemur, fields=['close'], fq='post', panel=False)
        if wolf is None or wolf.empty:
            continue
        wolf = wolf.copy()
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['date'] = wolf['time'].dt.date
        wolf = wolf[wolf['date'].isin(alpaca)]
        if wolf.empty:
            continue
        wolf = wolf.sort_values(['code', 'date', 'time'])
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf = wolf[np.isfinite(wolf['close'].values)]
        if wolf.empty:
            continue
        wolf['log_close'] = np.log(wolf['close'])
        wolf['log_prev'] = wolf.groupby(['code', 'date'], sort=False)['log_close'].shift(1)
        wolf['r'] = wolf['log_close'] - wolf['log_prev']
        wolf = wolf[np.isfinite(wolf['r'].values)]
        if wolf.empty:
            continue
        wolf['r2'] = wolf['r'] * wolf['r']
        wolf['r3'] = wolf['r2'] * wolf['r']
        cat = wolf.groupby(['code', 'date'], sort=False).agg(n=('r', 'count'), s1=('r', 'sum'), s2=('r2', 'sum'), s3=('r3', 'sum'))
        eagle = cat['n'].astype(float)
        shark = cat['s1'] / eagle
        dolphin = cat['s2'] - eagle * shark ** 2
        whale = cat['s3'] - 3.0 * shark * cat['s2'] + 3.0 * shark ** 2 * cat['s1'] - eagle * shark ** 3
        fox = np.power(dolphin, 1.5)
        turtle = np.sqrt(eagle) * whale / fox
        turtle[(cat['n'] < 3) | ~np.isfinite(turtle) | ~np.isfinite(fox) | (fox <= 0.0)] = np.nan
        owl.append(turtle.rename('rskew'))
    if not owl:
        return _make_factor_series({dog: np.nan for dog in panda}, date, universe=universe, name='factor777')
    tiger = pd.concat(owl).groupby(level=[0, 1], sort=False).mean()
    lion = tiger.unstack('date').reindex(index=panda, columns=tuna)
    sparrow = lion.mean(axis=1, skipna=True)
    hawk = lion.notna().sum(axis=1)
    sparrow.loc[hawk < int(min_days)] = np.nan
    giraffe = {dog: float(sparrow.get(dog, np.nan)) for dog in panda}
    return _make_factor_series(giraffe, date, universe=universe, name='factor777')

def factor778(universe, date, window=20):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    lion = _last_n_trade_days(tiger, int(window) + 1)
    if len(lion) < int(window) + 1:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor778')
    zebra = [pd.to_datetime(dolphin).date() for dolphin in lion]
    giraffe = pd.to_datetime(zebra[0]).strftime('%Y-%m-%d')
    koala = pd.to_datetime(zebra[-1]).strftime('%Y-%m-%d')
    fox = get_money_flow_pro(security_list=panda, start_date=giraffe, end_date=koala, frequency='daily', fields=['inflow_s', 'outflow_s'], data_type='money')
    if fox is None or fox.empty:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor778')
    fox = fox.copy()
    if 'time' in fox.columns:
        fox['date'] = pd.to_datetime(fox['time']).dt.date
    elif 'day' in fox.columns:
        fox['date'] = pd.to_datetime(fox['day']).dt.date
    else:
        fox['date'] = pd.to_datetime(fox.index).date
    if 'inflow_s' not in fox.columns or 'outflow_s' not in fox.columns:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor778')
    fox['net_s'] = fox['inflow_s'].astype(float) - fox['outflow_s'].astype(float)
    wolf = fox.groupby(['date', 'code'], sort=False)['net_s'].sum().unstack('code').reindex(index=zebra, columns=panda)
    otter = {}
    for dog in panda:
        rabbit = wolf[dog].astype(float)
        dolphin = rabbit.values[:-1]
        whale = rabbit.values[1:]
        bear = _spearman_corr(dolphin, whale)
        otter[dog] = float(bear) if np.isfinite(bear) else np.nan
    return _make_factor_series(otter, date, universe=universe, name='factor778')

def factor779(universe, date, min_valid_quarters=3):
    _set_asof_date(date)
    lion = _to_date(date)
    tiger = list(universe)
    rabbit = int(min_valid_quarters)
    koala = get_history_fundamentals(security=tiger, fields=[bear.term_072, bear.term_004], watch_date=lion, count=4, interval='1q', stat_by_year=False)
    if koala is None or koala.empty:
        return _make_factor_series({dog: np.nan for dog in tiger}, date, universe=universe, name='factor779')
    koala = koala.copy()
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    koala = koala.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    whale = pd.Series(np.nan, index=tiger, dtype='float64')
    for panda in tiger:
        fox = koala[koala['code'] == panda].tail(4)
        dolphin = pd.to_numeric(fox.get('term_072', pd.Series(dtype='float64')), errors='coerce').astype(float).to_numpy()
        cat = pd.to_numeric(fox.get('term_004', pd.Series(dtype='float64')), errors='coerce').astype(float).to_numpy()
        if np.isfinite(dolphin).sum() >= rabbit:
            whale.loc[panda] = float(np.nansum(dolphin))
        elif np.isfinite(cat).sum() >= rabbit:
            whale.loc[panda] = float(np.nansum(cat))
        else:
            whale.loc[panda] = np.nan
    zebra = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(tiger))
    otter = get_fundamentals(zebra, date=lion)
    if otter is None or otter.empty:
        return _make_factor_series({dog: np.nan for dog in tiger}, date, universe=universe, name='factor779')
    otter = otter.set_index('code')
    bear = pd.to_numeric(otter.get('term_045', pd.Series(dtype='float64')), errors='coerce').astype(float).reindex(tiger)
    giraffe = (whale / bear.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    wolf = {dog: float(giraffe.get(dog, np.nan)) for dog in tiger}
    return _make_factor_series(wolf, date, universe=universe, name='factor779')

def factor780(universe, date, freq='5m', code_chunk=200):
    _set_asof_date(date)
    panda = _to_date(date)
    dog = list(universe)
    wolf = pd.Series(0.0, index=dog, dtype='float64')
    fox = pd.Series(0, index=dog, dtype='int64')
    for koala in range(0, len(dog), int(code_chunk)):
        rabbit = dog[koala:koala + int(code_chunk)]
        tiger = get_price(rabbit, start_date=panda, end_date=panda + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if tiger is None or tiger.empty:
            continue
        tiger = tiger.copy()
        tiger['time'] = pd.to_datetime(tiger['time'])
        tiger = tiger.sort_values(['code', 'time'])
        tiger['close'] = pd.to_numeric(tiger['close'], errors='coerce').astype(float)
        tiger = tiger[np.isfinite(tiger['close'].values)]
        if tiger.empty:
            continue
        tiger['log_close'] = np.log(tiger['close'])
        tiger['log_prev'] = tiger.groupby('code', sort=False)['log_close'].shift(1)
        tiger['r'] = tiger['log_close'] - tiger['log_prev']
        tiger = tiger[np.isfinite(tiger['r'].values)]
        if tiger.empty:
            continue
        tiger['r2_neg'] = (tiger['r'] * tiger['r']).where(tiger['r'] <= 0.0, 0.0)
        bear = tiger.groupby('code', sort=False)['r2_neg'].sum()
        wolf.loc[bear.index] = wolf.loc[bear.index] + bear.values
        fox.loc[bear.index] = fox.loc[bear.index] + 1
    otter = wolf
    otter.loc[fox == 0] = np.nan
    lion = {cat: float(otter.get(cat, np.nan)) for cat in dog}
    return _make_factor_series(lion, date, universe=universe, name='factor780')

def factor781(universe, date, order_type='small', T=20, ret_window=20):
    _set_asof_date(date)
    sparrow = _to_date(date)
    dolphin = list(universe)
    owl = _last_n_trade_days(sparrow, int(T))
    if len(owl) < int(T):
        return _make_factor_series({wolf: np.nan for wolf in dolphin}, date, universe=universe, name='factor781')
    penguin = pd.to_datetime(owl[0]).date()
    tuna = pd.to_datetime(owl[-1]).date()
    raccoon = pd.to_datetime(penguin).strftime('%Y-%m-%d')
    lemur = pd.to_datetime(tuna).strftime('%Y-%m-%d')
    beaver = get_money_flow_pro(security_list=dolphin, start_date=raccoon, end_date=lemur, frequency='daily', fields=['inflow_xl', 'outflow_xl', 'inflow_l', 'outflow_l', 'inflow_s', 'outflow_s'], data_type='money')
    if beaver is None or beaver.empty:
        return _make_factor_series({wolf: np.nan for wolf in dolphin}, date, universe=universe, name='factor781')
    beaver = beaver.copy()
    if 'time' in beaver.columns:
        beaver['date'] = pd.to_datetime(beaver['time']).dt.date
    elif 'day' in beaver.columns:
        beaver['date'] = pd.to_datetime(beaver['day']).dt.date
    else:
        beaver['date'] = pd.to_datetime(beaver.index).date
    shark = beaver.columns

    def _has(prefix):
        return prefix in cols or any((cat.startswith(prefix) for cat in cols))

    def _pick(prefix):
        if prefix in cols:
            return prefix
        dog = [cat for cat in cols if cat.startswith(prefix)]
        return dog[0] if dog else None
    donkey = _pick('inflow_s')
    kangaroo = _pick('outflow_s')
    camel = _pick('inflow_l')
    jaguar = _pick('outflow_l')
    ferret = _pick('inflow_xl')
    llama = _pick('outflow_xl')
    if order_type == 'small':
        if not (donkey and kangaroo):
            return _make_factor_series({wolf: np.nan for wolf in dolphin}, date, universe=universe, name='factor781')
        beaver['net_flow'] = beaver[donkey].astype(float) - beaver[kangaroo].astype(float)
    elif order_type == 'large':
        if not (camel and jaguar and ferret and llama):
            return _make_factor_series({wolf: np.nan for wolf in dolphin}, date, universe=universe, name='factor781')
        beaver['net_flow'] = beaver[camel].astype(float) + beaver[ferret].astype(float) - beaver[jaguar].astype(float) - beaver[llama].astype(float)
    else:
        raise ValueError("order_type must be 'small' or 'large'.")
    iguana = beaver.groupby(['date', 'code'], sort=False)['net_flow'].sum().unstack('code')
    iguana = iguana.reindex(index=[pd.to_datetime(hawk).date() for hawk in owl], columns=dolphin)
    panda = {}
    for zebra in dolphin:
        octopus = iguana[zebra].astype(float).dropna().values
        if octopus.size == 0:
            continue
        lizard = float(np.sum(np.abs(octopus)))
        if lizard <= 0.0 or not np.isfinite(lizard):
            continue
        panda[zebra] = float(np.sum(octopus) / lizard)
    turtle = _last_n_trade_days(sparrow, int(ret_window) + 1)
    if len(turtle) < int(ret_window) + 1:
        return _make_factor_series({wolf: np.nan for wolf in dolphin}, date, universe=universe, name='factor781')
    quail = pd.to_datetime(turtle[0]).date()
    alpaca = pd.to_datetime(turtle[-1]).date()
    frog = get_price(dolphin, start_date=quail, end_date=alpaca, frequency='daily', fields=['close'], fq='post', panel=False)
    if frog is None or frog.empty:
        return _make_factor_series({wolf: np.nan for wolf in dolphin}, date, universe=universe, name='factor781')
    giraffe = frog.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=dolphin)
    if giraffe.shape[0] < 2:
        return _make_factor_series({wolf: np.nan for wolf in dolphin}, date, universe=universe, name='factor781')
    narwhal = {}
    bear = giraffe.iloc[0]
    rabbit = giraffe.iloc[-1]
    for zebra in dolphin:
        koala = float(bear.get(zebra, np.nan))
        otter = float(rabbit.get(zebra, np.nan))
        if np.isfinite(koala) and np.isfinite(otter) and (koala > 0.0):
            narwhal[zebra] = float(otter / koala - 1.0)
    eagle = sorted(set(panda.keys()) & set(narwhal.keys()))
    if len(eagle) < 3:
        return _make_factor_series({wolf: np.nan for wolf in dolphin}, date, universe=universe, name='factor781')
    dog = np.array([panda[wolf] for wolf in eagle], dtype=float)
    cat = np.array([narwhal[wolf] for wolf in eagle], dtype=float)
    hyena = np.isfinite(dog) & np.isfinite(cat)
    if hyena.sum() < 3:
        return _make_factor_series({wolf: np.nan for wolf in dolphin}, date, universe=universe, name='factor781')
    dog = dog[hyena]
    cat = cat[hyena]
    whale = [wolf for wolf, gecko in zip(eagle, hyena) if gecko]
    tiger = np.column_stack([np.ones_like(dog), dog])
    fox, lion, lion, lion = np.linalg.lstsq(tiger, cat, rcond=None)
    mole = cat - tiger.dot(fox)
    badger = {wolf: np.nan for wolf in dolphin}
    for wolf, salmon in zip(whale, mole):
        badger[wolf] = float(salmon) if np.isfinite(salmon) else np.nan
    return _make_factor_series(badger, date, universe=universe, name='factor781')

def factor782(universe, date, index_symbol='000905.XSHG', K_months=12, rf_series=None):
    _set_asof_date(date)
    fox = list(universe)
    rabbit = _to_date(date)
    giraffe = K_months * 21 + 1
    zebra = _last_n_trade_days(rabbit, giraffe)
    if len(zebra) < 40:
        eagle = {otter: np.nan for otter in fox}
        return _make_factor_series(eagle, date, universe=universe, name='factor782')
    alpaca = zebra[0]
    dolphin = zebra[-1]
    hawk = _get_daily_close_series(index_symbol, alpaca, dolphin)
    if hawk.size < 2:
        eagle = {otter: np.nan for otter in fox}
        return _make_factor_series(eagle, date, universe=universe, name='factor782')
    sparrow = hawk.pct_change().dropna()
    eagle = {}
    for otter in fox:
        koala = _get_daily_close_series(otter, alpaca, dolphin)
        owl = koala.pct_change().dropna()
        wolf = sparrow.index.intersection(owl.index)
        if len(wolf) < 20:
            continue
        frog = sparrow.reindex(wolf).values
        turtle = owl.reindex(wolf).values
        if rf_series is not None:
            tuna = pd.Series(rf_series)
            tuna = tuna.reindex(wolf.date).fillna(0.0).values
        else:
            tuna = 0.0
        if np.isscalar(tuna):
            salmon = frog - tuna
            lizard = turtle - tuna
        else:
            salmon = frog - tuna
            lizard = turtle - tuna
        panda = np.column_stack([np.ones_like(salmon), salmon])
        lion, tiger, tiger, tiger = np.linalg.lstsq(panda, lizard, rcond=None)
        whale = lizard - panda.dot(lion)
        shark = salmon - salmon.mean()
        cat = np.mean(whale ** 2)
        dog = np.mean(shark ** 2)
        if cat <= 0 or dog <= 0:
            continue
        bear = np.mean(whale * shark ** 2) / np.sqrt(cat * dog)
        eagle[otter] = bear
    if not eagle:
        eagle = {otter: np.nan for otter in fox}
    return _make_factor_series(eagle, date, universe=universe, name='factor782')

def factor783(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor783')

def factor784(universe, date):
    _set_asof_date(date)
    koala = list(universe)
    otter = _to_date(date)
    try:
        rabbit = otter.replace(year=otter.year - 1)
    except ValueError:
        rabbit = otter.replace(year=otter.year - 1, day=28)
    fox = get_factor_values(koala, factors=['net_asset_per_share'], end_date=otter, count=1)
    wolf = get_factor_values(koala, factors=['net_asset_per_share'], end_date=rabbit, count=1)
    panda = _safe_factor_last_row(fox, 'net_asset_per_share', koala)
    tiger = _safe_factor_last_row(wolf, 'net_asset_per_share', koala)
    bear = {}
    for lion in koala:
        cat = panda.get(lion, np.nan)
        dog = tiger.get(lion, np.nan)
        if not np.isfinite(cat) or not np.isfinite(dog) or dog == 0:
            bear[lion] = np.nan
        else:
            bear[lion] = (cat - dog) / dog
    return _make_factor_series(bear, date, universe=universe, name='factor784')

def factor785(universe, date, window=20):
    _set_asof_date(date)
    fox = list(universe)
    wolf = _to_date(date)
    bear = _last_n_trade_days(wolf, int(window) + 1)
    if len(bear) < int(window) + 1:
        return _make_factor_series({lion: np.nan for lion in fox}, date, universe=universe, name='factor785')
    salmon = [pd.to_datetime(tuna).date() for tuna in bear]
    lizard = salmon[0]
    giraffe = salmon[-1]
    frog = pd.to_datetime(lizard).strftime('%Y-%m-%d')
    zebra = pd.to_datetime(giraffe).strftime('%Y-%m-%d')
    rabbit = get_price(fox, start_date=frog, end_date=zebra, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({lion: np.nan for lion in fox}, date, universe=universe, name='factor785')
    sparrow = rabbit.pivot(index='time', columns='code', values=['open', 'close']).sort_index()
    sparrow.index = pd.to_datetime(sparrow.index).date
    hawk = sparrow['open'].reindex(salmon, columns=fox)
    koala = sparrow['close'].reindex(salmon, columns=fox)
    owl = (koala / hawk - 1.0).replace([np.inf, -np.inf], np.nan)
    whale = get_money_flow_pro(security_list=fox, start_date=frog, end_date=zebra, frequency='daily', fields=['inflow_s', 'outflow_s'], data_type='money')
    if whale is None or whale.empty:
        return _make_factor_series({lion: np.nan for lion in fox}, date, universe=universe, name='factor785')
    whale = whale.copy()
    if 'time' in whale.columns:
        whale['date'] = pd.to_datetime(whale['time']).dt.date
    elif 'day' in whale.columns:
        whale['date'] = pd.to_datetime(whale['day']).dt.date
    else:
        whale['date'] = pd.to_datetime(whale.index).date
    if 'inflow_s' not in whale.columns or 'outflow_s' not in whale.columns:
        return _make_factor_series({lion: np.nan for lion in fox}, date, universe=universe, name='factor785')
    whale['netflow_s'] = whale['inflow_s'].astype(float) - whale['outflow_s'].astype(float)
    eagle = whale.groupby(['date', 'code'], sort=False)['netflow_s'].sum().unstack('code').reindex(index=salmon, columns=fox)
    dolphin = {}
    for otter in fox:
        dog = owl[otter].astype(float)
        panda = eagle[otter].astype(float)
        cat = dog.shift(1).iloc[1:].tail(int(window))
        tiger = panda.iloc[1:].tail(int(window))
        shark = ~(cat.isna() | tiger.isna())
        if shark.sum() < 5:
            dolphin[otter] = np.nan
            continue
        turtle = _spearman_corr(cat[shark].values, tiger[shark].values)
        dolphin[otter] = float(turtle) if np.isfinite(turtle) else np.nan
    return _make_factor_series(dolphin, date, universe=universe, name='factor785')

def factor786(universe, date, N=23, M=8):
    _set_asof_date(date)
    rabbit = _to_date(date)
    fox = list(universe)
    giraffe = get_trade_days(end_date=rabbit, count=int(N) + int(M) + 2)
    if giraffe is None or len(giraffe) < int(N) + int(M):
        return _make_factor_series({otter: np.nan for otter in fox}, date, universe=universe, name='factor786')
    frog = pd.to_datetime(giraffe[0]).strftime('%Y-%m-%d')
    dolphin = pd.to_datetime(giraffe[-1]).strftime('%Y-%m-%d')
    zebra = get_price(fox, start_date=frog, end_date=dolphin, frequency='daily', fields=['open', 'high', 'low'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        return _make_factor_series({otter: np.nan for otter in fox}, date, universe=universe, name='factor786')
    turtle = zebra.pivot(index='time', columns='code', values='open').sort_index().reindex(columns=fox)
    shark = zebra.pivot(index='time', columns='code', values='high').sort_index().reindex(columns=fox)
    eagle = zebra.pivot(index='time', columns='code', values='low').sort_index().reindex(columns=fox)
    lizard = turtle.shift(1)
    tiger = pd.DataFrame(0.0, index=turtle.index, columns=turtle.columns)
    panda = pd.DataFrame(0.0, index=turtle.index, columns=turtle.columns)
    owl = turtle > lizard
    sparrow = turtle < lizard
    tiger[owl] = np.maximum((shark - turtle)[owl], (turtle - lizard)[owl])
    panda[sparrow] = np.maximum((turtle - eagle)[sparrow], (turtle - lizard)[sparrow])
    koala = tiger.rolling(int(N)).sum()
    lion = panda.rolling(int(N)).sum()
    cat = pd.DataFrame(0.0, index=turtle.index, columns=turtle.columns)
    wolf = koala > lion
    bear = koala < lion
    cat[wolf] = (koala[wolf] - lion[wolf]) / koala[wolf]
    cat[bear] = (koala[bear] - lion[bear]) / lion[bear]
    dog = cat.rolling(int(M)).mean()
    hawk = dog.iloc[-1].reindex(fox)
    whale = {otter: float(hawk.get(otter, np.nan)) for otter in fox}
    return _make_factor_series(whale, date, universe=universe, name='factor786')

def factor787(universe, date, freq='5m', code_chunk=200):
    _set_asof_date(date)
    panda = _to_date(date)
    dog = list(universe)
    wolf = pd.Series(0.0, index=dog, dtype='float64')
    fox = pd.Series(0, index=dog, dtype='int64')
    for koala in range(0, len(dog), int(code_chunk)):
        rabbit = dog[koala:koala + int(code_chunk)]
        tiger = get_price(rabbit, start_date=panda, end_date=panda + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if tiger is None or tiger.empty:
            continue
        tiger = tiger.copy()
        tiger['time'] = pd.to_datetime(tiger['time'])
        tiger = tiger.sort_values(['code', 'time'])
        tiger['close'] = pd.to_numeric(tiger['close'], errors='coerce').astype(float)
        tiger = tiger[np.isfinite(tiger['close'].values)]
        if tiger.empty:
            continue
        tiger['log_close'] = np.log(tiger['close'])
        tiger['log_prev'] = tiger.groupby('code', sort=False)['log_close'].shift(1)
        tiger['r'] = tiger['log_close'] - tiger['log_prev']
        tiger = tiger[np.isfinite(tiger['r'].values)]
        if tiger.empty:
            continue
        tiger['r2_pos'] = (tiger['r'] * tiger['r']).where(tiger['r'] >= 0.0, 0.0)
        bear = tiger.groupby('code', sort=False)['r2_pos'].sum()
        wolf.loc[bear.index] = wolf.loc[bear.index] + bear.values
        fox.loc[bear.index] = fox.loc[bear.index] + 1
    otter = wolf
    otter.loc[fox == 0] = np.nan
    lion = {cat: float(otter.get(cat, np.nan)) for cat in dog}
    return _make_factor_series(lion, date, universe=universe, name='factor787')

def factor788(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor788')

def factor789(universe, date, freq='1m'):
    _set_asof_date(date)
    shark = list(universe)
    owl = _to_date(date)
    seal = _get_month_end_trade_day(owl)
    lizard = _last_n_trade_days(seal, 20)
    if len(lizard) < 20:
        llama = {whale: np.nan for whale in shark}
        return _make_factor_series(llama, date, universe=universe, name='factor789')
    frog = [pd.to_datetime(banana).date() for banana in lizard]
    turtle = set(frog)
    mouse = frog[0]
    beaver = frog[-1]
    newt = pd.to_datetime(mouse).strftime('%Y-%m-%d')
    donkey = pd.to_datetime(beaver).strftime('%Y-%m-%d')
    camel = (pd.to_datetime(donkey) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')

    def _canon_minute(df, code_fallback=None):
        if df is None or getattr(df, 'empty', True):
            return None
        cat = df.copy()
        try:
            if isinstance(cat.index, pd.MultiIndex) and 'time' in cat.index.names:
                cat = cat.reset_index()
            elif getattr(cat.index, 'name', None) == 'time':
                cat = cat.reset_index()
            else:
                cat = cat.reset_index(drop=False)
        except Exception:
            cat = cat.reset_index(drop=False)
        if getattr(cat.columns, 'duplicated', None) is not None and cat.columns.duplicated().any():
            cat = cat.loc[:, ~cat.columns.duplicated()]
        if 'time' not in cat.columns:
            if 'index' in cat.columns:
                cat = cat.rename(columns={'index': 'time'})
            else:
                return None
        if 'code' not in cat.columns:
            if code_fallback is not None:
                cat['code'] = code_fallback
            else:
                return None
        cat['time'] = pd.to_datetime(cat['time'], errors='coerce')
        cat = cat.dropna(subset=['time'])
        if cat.empty:
            return None
        cat['code'] = cat['code'].astype(str)
        return cat
    koala = 200
    elk = []
    for mole in range(0, len(shark), koala):
        lion = shark[mole:mole + koala]
        penguin = get_price(lion, start_date=newt, end_date=camel, frequency=freq, fields=['close', 'volume', 'money'], fq='post', panel=False)
        penguin = _canon_minute(penguin)
        if penguin is None or penguin.empty:
            continue
        if 'close' not in penguin.columns:
            continue
        penguin['date'] = penguin['time'].dt.date
        penguin = penguin[penguin['date'].isin(turtle)]
        if penguin.empty:
            continue
        penguin['close'] = pd.to_numeric(penguin['close'], errors='coerce').astype(float)
        donut = None
        if 'volume' in penguin.columns:
            penguin['volume'] = pd.to_numeric(penguin['volume'], errors='coerce').astype(float)
            if (penguin['volume'] > 0).any():
                donut = 'volume'
                penguin = penguin[penguin['volume'] > 0]
        if donut is None and 'money' in penguin.columns:
            penguin['money'] = pd.to_numeric(penguin['money'], errors='coerce').astype(float)
            if (penguin['money'] > 0).any():
                donut = 'money'
                penguin = penguin[penguin['money'] > 0]
        if donut is None:
            continue
        penguin = penguin.dropna(subset=['close', donut])
        if penguin.empty:
            continue
        penguin = penguin.sort_values(['code', 'date', 'time'])
        penguin['ret'] = penguin.groupby(['code', 'date'], sort=False)['close'].pct_change()
        penguin = penguin.dropna(subset=['ret', donut])
        if penguin.empty:
            continue
        penguin['x'] = pd.to_numeric(penguin['ret'], errors='coerce').astype(float)
        penguin['y'] = np.log1p(pd.to_numeric(penguin[donut], errors='coerce').astype(float))
        penguin = penguin.replace([np.inf, -np.inf], np.nan).dropna(subset=['x', 'y'])
        if penguin.empty:
            continue
        penguin['x2'] = penguin['x'] * penguin['x']
        penguin['y2'] = penguin['y'] * penguin['y']
        penguin['xy'] = penguin['x'] * penguin['y']
        tiger = penguin.groupby(['code', 'date'], sort=False).agg(n=('x', 'size'), sx=('x', 'sum'), sy=('y', 'sum'), sx2=('x2', 'sum'), sy2=('y2', 'sum'), sxy=('xy', 'sum'))
        turkey = tiger['n'].astype(float)
        gecko = tiger['sx'] / turkey
        jaguar = tiger['sy'] / turkey
        hyena = tiger['sx2'] / turkey
        kangaroo = tiger['sy2'] / turkey
        iguana = tiger['sxy'] / turkey
        toad = hyena - gecko * gecko
        weasel = kangaroo - jaguar * jaguar
        hawk = iguana - gecko * jaguar
        salmon = np.sqrt(toad) * np.sqrt(weasel)
        with np.errstate(divide='ignore', invalid='ignore'):
            bee = hawk / salmon
        bee = bee.replace([np.inf, -np.inf], np.nan)
        bee[(turkey < 10) | ~np.isfinite(bee) | ~np.isfinite(salmon) | (salmon <= 0)] = np.nan
        elk.append(bee.rename('rho').reset_index())
    if len(elk) == 0:
        llama = {whale: np.nan for whale in shark}
        return _make_factor_series(llama, date, universe=universe, name='factor789')
    crab = pd.concat(elk, ignore_index=True).dropna(subset=['rho'])
    if crab.empty:
        llama = {whale: np.nan for whale in shark}
        return _make_factor_series(llama, date, universe=universe, name='factor789')
    deer = crab.pivot(index='date', columns='code', values='rho').reindex(index=frog).reindex(columns=shark)
    fox = {}
    mink = np.arange(1, len(frog) + 1, dtype=float)
    for whale in shark:
        goat = deer[whale].values.astype(float)
        quail = np.isfinite(goat)
        if quail.sum() < 5:
            continue
        carrot = goat[quail]
        horse = mink[quail]
        salmon = float(np.dot(horse, horse))
        if not np.isfinite(salmon) or salmon <= 0:
            continue
        otter = float(np.dot(horse, carrot) / salmon)
        if np.isfinite(otter):
            fox[whale] = otter
    if not fox:
        llama = {whale: np.nan for whale in shark}
        return _make_factor_series(llama, date, universe=universe, name='factor789')
    wolf = pd.Series(fox, dtype='float64')
    vulture = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(shark))
    badger = get_fundamentals(vulture, date=pd.to_datetime(seal).strftime('%Y-%m-%d'))
    raccoon = pd.Series(np.nan, index=shark, dtype='float64')
    if badger is not None and (not badger.empty) and ('code' in badger.columns) and ('term_045' in badger.columns):
        raccoon = pd.to_numeric(pd.Series(badger['term_045'].values, index=badger['code'].astype(str).values), errors='coerce').reindex(shark)
    octopus = np.log(raccoon.replace({0: np.nan}))
    tuna = get_price(shark, start_date=newt, end_date=donkey, frequency='daily', fields=['close'], fq='post', panel=False)
    if tuna is None or tuna.empty:
        llama = {whale: np.nan for whale in shark}
        return _make_factor_series(llama, date, universe=universe, name='factor789')
    tuna = tuna.copy()
    if 'time' not in tuna.columns:
        tuna = tuna.reset_index().rename(columns={'index': 'time'})
    if 'code' not in tuna.columns:
        llama = {whale: np.nan for whale in shark}
        return _make_factor_series(llama, date, universe=universe, name='factor789')
    tuna['time'] = pd.to_datetime(tuna['time'], errors='coerce')
    tuna = tuna.dropna(subset=['time'])
    zebra = tuna.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=shark)
    dolphin = zebra.tail(20)
    ant = dolphin.pct_change().replace([np.inf, -np.inf], np.nan)
    apple = ant.std(axis=0, ddof=1)
    rabbit = dolphin.bfill().iloc[0]
    giraffe = dolphin.ffill().iloc[-1]
    with np.errstate(divide='ignore', invalid='ignore'):
        yak = giraffe / rabbit - 1.0
    yak = yak.replace([np.inf, -np.inf], np.nan)
    swan = []
    for sparrow in frog:
        urchin = query(giraffe.code, giraffe.term_095).filter(giraffe.code.in_(shark))
        lemur = get_fundamentals(urchin, date=pd.to_datetime(sparrow).strftime('%Y-%m-%d'))
        if lemur is None or lemur.empty or 'code' not in lemur.columns:
            continue
        pig = lemur[['code', 'term_095']].copy()
        pig['code'] = pig['code'].astype(str)
        pig['term_095'] = pd.to_numeric(pig['term_095'], errors='coerce')
        pig['date'] = pd.to_datetime(sparrow)
        swan.append(pig)
    if swan:
        sheep = pd.concat(swan, ignore_index=True)
        stoat = sheep.pivot(index='date', columns='code', values='term_095').reindex(index=pd.to_datetime(frog)).reindex(columns=shark)
        rat = stoat.mean(axis=0, skipna=True)
    else:
        rat = pd.Series(np.nan, index=shark, dtype='float64')
    narwhal = wolf.index
    alpaca = pd.DataFrame({'beta': wolf.reindex(narwhal), 'ln_mc': octopus.reindex(narwhal), 'ret20': yak.reindex(narwhal), 'to20': rat.reindex(narwhal), 'vol20': apple.reindex(narwhal)})
    alpaca = alpaca.replace([np.inf, -np.inf], np.nan).dropna()
    if alpaca.shape[0] < 30:
        llama = {bear: float(wolf.get(bear, np.nan)) if np.isfinite(wolf.get(bear, np.nan)) else np.nan for bear in shark}
        return _make_factor_series(llama, date, universe=universe, name='factor789')
    dog = alpaca['beta'].values.astype(float)
    cat = np.column_stack([np.ones(alpaca.shape[0], dtype=float), alpaca['ln_mc'].values.astype(float), alpaca['ret20'].values.astype(float), alpaca['to20'].values.astype(float), alpaca['vol20'].values.astype(float)])
    eagle, panda, panda, panda = np.linalg.lstsq(cat, dog, rcond=None)
    walrus = dog - cat.dot(eagle)
    llama = {}
    for whale, ferret in zip(alpaca.index.tolist(), walrus):
        if np.isfinite(ferret):
            llama[whale] = float(ferret)
    return _make_factor_series(llama, date, universe=universe, name='factor789')

def factor790(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor790')

def factor791(universe, date, freq_small='1m', freq_large='5m', daily_window=20, code_chunk=200, large_threshold=800, min_days=10):
    _set_asof_date(date)
    lion = _to_date(date)
    dog = list(universe)
    giraffe = _get_month_end_trade_day(lion)
    koala = _last_n_trade_days(giraffe, int(daily_window))
    if len(koala) < 2:
        return _make_factor_series({cat: np.nan for cat in dog}, date, universe=universe, name='factor791')
    lizard = [pd.to_datetime(tuna).date() for tuna in koala]
    frog = set(lizard)
    hawk = lizard[0]
    fox = lizard[-1]
    salmon = freq_large if len(dog) >= int(large_threshold) else freq_small
    sparrow = pd.to_datetime(hawk).strftime('%Y-%m-%d')
    wolf = pd.to_datetime(fox + dt.timedelta(days=1)).strftime('%Y-%m-%d')

    def _day_ratio(g: pd.DataFrame) -> float:
        g = g.sort_values('time')
        dog = pd.to_numeric(g['close'], errors='coerce').astype(float)
        wolf = pd.to_numeric(g['money'], errors='coerce').astype(float)
        fox = np.isfinite(dog.values) & np.isfinite(wolf.values)
        if fox.sum() < 12:
            return np.nan
        dog = dog.loc[fox]
        wolf = wolf.loc[fox]
        bear = np.log(dog / dog.shift(1)).dropna()
        if bear.size < 10:
            return np.nan
        rabbit = bear.rolling(5).std()
        otter = rabbit.rolling(5).std()
        panda = pd.DataFrame({'f': otter, 'money': wolf.reindex(otter.index)})
        panda = panda.dropna()
        if panda.empty:
            return np.nan
        tiger = float(panda['f'].mean())
        lion = panda['f'] > tiger
        if lion.sum() <= 0:
            return np.nan
        koala = float(panda.loc[lion, 'money'].mean())
        cat = float(panda['money'].mean())
        if not np.isfinite(koala) or not np.isfinite(cat) or cat <= 0.0:
            return np.nan
        return float(koala / cat)
    shark = []
    for rabbit in range(0, len(dog), int(code_chunk)):
        owl = dog[rabbit:rabbit + int(code_chunk)]
        otter = get_price(owl, start_date=sparrow, end_date=wolf, frequency=salmon, fields=['close', 'money'], fq='post', panel=False)
        if otter is None or otter.empty:
            continue
        otter = otter.copy()
        otter['time'] = pd.to_datetime(otter['time'])
        otter['date'] = otter['time'].dt.date
        otter = otter[otter['date'].isin(frog)]
        if otter.empty:
            continue
        if 'close' not in otter.columns or 'money' not in otter.columns or 'code' not in otter.columns:
            continue
        turtle = otter.groupby(['code', 'date'], sort=False).apply(_day_ratio)
        if turtle is not None and (not turtle.empty):
            shark.append(turtle.rename('ratio'))
    if not shark:
        return _make_factor_series({cat: np.nan for cat in dog}, date, universe=universe, name='factor791')
    panda = pd.concat(shark).groupby(level=[0, 1], sort=False).mean()
    tiger = panda.unstack('date').reindex(index=dog, columns=lizard)
    zebra = tiger.mean(axis=1, skipna=True)
    eagle = tiger.std(axis=1, ddof=1, skipna=True)
    dolphin = tiger.notna().sum(axis=1)
    whale = 0.5 * (zebra + eagle.fillna(0.0))
    whale.loc[dolphin < int(min_days)] = np.nan
    bear = {cat: float(whale.get(cat, np.nan)) for cat in dog}
    return _make_factor_series(bear, date, universe=universe, name='factor791')

def factor792(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    try:
        bear = get_history_fundamentals(security=universe, fields=[rabbit.roe], watch_date=koala, count=8, interval='1q', stat_by_year=False)
    except Exception:
        bear = None
    try:
        fox = get_history_fundamentals(security=universe, fields=[fox.term_081], watch_date=koala, count=8, interval='1q', stat_by_year=False)
    except Exception:
        fox = None
    if bear is None or bear.empty or fox is None or fox.empty:
        zebra = {lion: np.nan for lion in universe}
        return _make_factor_series(zebra, date, universe=universe, name='factor792')
    if 'statDate' in bear.columns:
        bear['statDate'] = pd.to_datetime(bear['statDate'])
    if 'statDate' in fox.columns:
        fox['statDate'] = pd.to_datetime(fox['statDate'])
    zebra = {}
    for lion in universe:
        wolf = bear[bear['code'] == lion].copy()
        otter = fox[fox['code'] == lion].copy()
        if wolf.empty or otter.empty:
            continue
        wolf = wolf[['statDate', 'roe']]
        otter = otter[['statDate', 'term_081']]
        rabbit = pd.merge(wolf, otter, on='statDate', how='inner').dropna(subset=['roe', 'term_081'])
        if rabbit.empty:
            continue
        rabbit = rabbit.sort_values('statDate')
        cat = []
        dolphin = None
        for panda, hawk in rabbit.iterrows():
            sparrow = hawk['statDate']
            owl = float(hawk['term_081'])
            shark = sparrow.month
            if shark == 12:
                dolphin = owl
                cat.append(owl)
            else:
                cat.append(dolphin if dolphin is not None else owl)
        rabbit['A_adj'] = np.array(cat, dtype=float)
        rabbit = rabbit.tail(8)
        lizard = rabbit['roe'].astype(float).values
        turtle = rabbit['A_adj'].astype(float).values
        whale = np.isfinite(lizard) & np.isfinite(turtle)
        if whale.sum() < 2:
            continue
        lizard = lizard[whale]
        turtle = turtle[whale]
        dog = np.column_stack([np.ones_like(turtle), turtle])
        tiger, panda, panda, panda = np.linalg.lstsq(dog, lizard, rcond=None)
        giraffe = lizard - dog.dot(tiger)
        eagle = float(giraffe[-1])
        if np.isfinite(eagle):
            zebra[lion] = eagle
    return _make_factor_series(zebra, date, universe=universe, name='factor792')

def factor793(universe, date, window=20, freq='5m', code_chunk=200, large_threshold=800, min_days=10):
    _set_asof_date(date)
    koala = _to_date(date)
    panda = list(universe)
    otter = _last_n_trade_days(koala, int(window))
    if len(otter) < 2:
        return _make_factor_series({dog: np.nan for dog in panda}, date, universe=universe, name='factor793')
    alpaca = freq
    if alpaca == '1m' and len(panda) >= int(large_threshold):
        alpaca = '5m'
    salmon = [pd.to_datetime(lemur).date() for lemur in otter]
    tuna = set(salmon)
    turtle = salmon[0]
    wolf = salmon[-1]
    lizard = pd.to_datetime(turtle).strftime('%Y-%m-%d')
    bear = pd.to_datetime(wolf + dt.timedelta(days=1)).strftime('%Y-%m-%d')
    sparrow = []
    for giraffe in range(0, len(panda), int(code_chunk)):
        frog = panda[giraffe:giraffe + int(code_chunk)]
        fox = get_price(frog, start_date=lizard, end_date=bear, frequency=alpaca, fields=['close'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        fox['time'] = pd.to_datetime(fox['time'])
        fox['date'] = fox['time'].dt.date
        fox = fox[fox['date'].isin(tuna)]
        if fox.empty:
            continue
        fox = fox.sort_values(['code', 'date', 'time'])
        fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
        fox = fox[np.isfinite(fox['close'].values)]
        if fox.empty:
            continue
        fox['log_close'] = np.log(fox['close'])
        fox['log_prev'] = fox.groupby(['code', 'date'], sort=False)['log_close'].shift(1)
        fox['r'] = fox['log_close'] - fox['log_prev']
        fox = fox[np.isfinite(fox['r'].values)]
        if fox.empty:
            continue
        fox['r2'] = fox['r'] * fox['r']
        fox['r3'] = fox['r2'] * fox['r']
        fox['r4'] = fox['r2'] * fox['r2']
        cat = fox.groupby(['code', 'date'], sort=False).agg(n=('r', 'count'), s1=('r', 'sum'), s2=('r2', 'sum'), s3=('r3', 'sum'), s4=('r4', 'sum'))
        shark = cat['n'].astype(float)
        whale = cat['s1'] / shark
        zebra = cat['s2'] - shark * whale ** 2
        dolphin = cat['s4'] - 4.0 * whale * cat['s3'] + 6.0 * whale ** 2 * cat['s2'] - 4.0 * whale ** 3 * cat['s1'] + shark * whale ** 4
        owl = shark * dolphin / zebra ** 2
        owl[(cat['n'] < 3) | ~np.isfinite(owl) | ~np.isfinite(zebra) | (zebra <= 0.0)] = np.nan
        sparrow.append(owl.rename('rkurt'))
    if not sparrow:
        return _make_factor_series({dog: np.nan for dog in panda}, date, universe=universe, name='factor793')
    tiger = pd.concat(sparrow).groupby(level=[0, 1], sort=False).mean()
    lion = tiger.unstack('date').reindex(index=panda, columns=salmon)
    hawk = lion.mean(axis=1, skipna=True)
    eagle = lion.notna().sum(axis=1)
    hawk.loc[eagle < int(min_days)] = np.nan
    rabbit = {dog: float(hawk.get(dog, np.nan)) for dog in panda}
    return _make_factor_series(rabbit, date, universe=universe, name='factor793')

def factor794(universe, date, freq='1m', code_chunk=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    bear = pd.Series(np.nan, index=panda, dtype='float64')
    for fox in range(0, len(panda), int(code_chunk)):
        dolphin = panda[fox:fox + int(code_chunk)]
        lion = get_price(dolphin, start_date=tiger, end_date=tiger + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        lion['time'] = pd.to_datetime(lion['time'])
        lion = lion.sort_values(['code', 'time'])
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values)]
        if lion.empty:
            continue
        for dog, otter in lion.groupby('code', sort=False):
            otter = otter.sort_values('time')
            cat = otter['close'].values.astype(float)
            if cat.size < 12:
                continue
            wolf = np.diff(np.log(cat))
            if wolf.size < 10:
                continue
            rabbit = float(np.sum(wolf ** 2))
            if not np.isfinite(rabbit) or rabbit <= 0.0:
                continue
            zebra = float(np.sum(wolf[wolf >= 0] ** 2)) if (wolf >= 0).any() else 0.0
            giraffe = float(np.sum(wolf[wolf < 0] ** 2)) if (wolf < 0).any() else 0.0
            whale = float((zebra - giraffe) / rabbit)
            if np.isfinite(whale):
                bear.loc[dog] = whale
    koala = {cat: float(bear.get(cat, np.nan)) for cat in panda}
    return _make_factor_series(koala, date, universe=universe, name='factor794')

def factor795(universe, date, x_months=1):
    _set_asof_date(date)
    wolf = _to_date(date)
    otter = list(universe)
    lemur = int(21 * x_months)
    rabbit = _last_n_trade_days(wolf, lemur)
    rabbit = [pd.to_datetime(fox).date() for fox in rabbit]
    if len(rabbit) < 2:
        return _make_factor_series({lion: np.nan for lion in otter}, wolf, universe=universe, name='factor795')
    frog = rabbit[0]
    dolphin = rabbit[-1]
    bear = pd.DatetimeIndex(pd.to_datetime(rabbit)).normalize()
    zebra = get_price(otter, start_date=frog, end_date=dolphin, frequency='daily', fields=['volume'], fq='post', panel=False)
    if zebra is None or getattr(zebra, 'empty', True):
        return _make_factor_series({lion: np.nan for lion in otter}, wolf, universe=universe, name='factor795')
    zebra = zebra.copy()
    if 'time' not in zebra.columns:
        zebra = zebra.reset_index().rename(columns={'index': 'time'})
    if 'code' not in zebra.columns:
        return _make_factor_series({lion: np.nan for lion in otter}, wolf, universe=universe, name='factor795')
    zebra['time'] = pd.to_datetime(zebra['time'], errors='coerce').dt.normalize()
    zebra = zebra.dropna(subset=['time'])
    zebra['volume'] = pd.to_numeric(zebra['volume'], errors='coerce').astype(float)
    alpaca = zebra.pivot(index='time', columns='code', values='volume').sort_index().reindex(index=bear, columns=otter)
    tuna = alpaca.notna()
    dog = tuna.sum(axis=0).astype(float)
    panda = ((alpaca == 0) & tuna).sum(axis=0).astype(float)
    sparrow = query(giraffe.code, giraffe.term_095).filter(giraffe.code.in_(otter))
    owl = []
    for fox in rabbit:
        giraffe = get_fundamentals(sparrow, date=pd.Timestamp(fox).strftime('%Y-%m-%d'))
        if giraffe is None or giraffe.empty or 'code' not in giraffe.columns:
            owl.append(pd.Series(np.nan, index=otter, name=pd.Timestamp(fox)))
            continue
        giraffe = giraffe.copy()
        giraffe['code'] = giraffe['code'].astype(str)
        turtle = pd.to_numeric(giraffe.set_index('code').get('term_095', np.nan), errors='coerce').astype(float).reindex(otter)
        owl.append(pd.Series(turtle.values, index=otter, name=pd.Timestamp(fox)))
    salmon = pd.DataFrame(owl)
    salmon.index = bear
    salmon = salmon.reindex(index=bear, columns=otter).fillna(0.0)
    badger = salmon.sum(axis=0).astype(float)
    whale = (1.0 / badger.replace(0.0, np.nan)).replace([np.inf, -np.inf], np.nan)
    shark = float(whale.max(skipna=True))
    if not np.isfinite(shark):
        return _make_factor_series({lion: np.nan for lion in otter}, wolf, universe=universe, name='factor795')
    cat = shark + 1.0
    lizard = float(21.0 * x_months)
    hawk = {}
    for koala in otter:
        eagle = float(dog.get(koala, np.nan))
        camel = float(panda.get(koala, np.nan))
        beaver = float(badger.get(koala, np.nan))
        if not np.isfinite(eagle) or eagle <= 0.0 or (not np.isfinite(camel)) or (not np.isfinite(beaver)) or (beaver <= 0.0):
            hawk[koala] = np.nan
            continue
        tiger = 1.0 / beaver / cat
        hawk[koala] = float((camel + tiger) * (lizard / eagle))
    return _make_factor_series(hawk, wolf, universe=universe, name='factor795')

def factor796(universe, date, N=6):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    lion = _last_n_trade_days(tiger, int(N))
    if len(lion) < int(N):
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor796')
    zebra = pd.to_datetime(lion[0]).date()
    fox = pd.to_datetime(lion[-1]).date()
    otter = get_price(panda, start_date=zebra, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor796')
    dog = otter.pivot(index='time', columns='code', values='close').sort_index().reindex(columns=panda)
    dog = dog.tail(int(N))
    rabbit = dog.mean(axis=0, skipna=True)
    bear = dog.iloc[-1]
    giraffe = pd.Series(np.nan, index=panda, dtype='float64')
    koala = rabbit.replace(0.0, np.nan)
    giraffe = 100.0 * (bear - rabbit) / koala
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    wolf = {cat: float(giraffe.get(cat, np.nan)) for cat in panda}
    return _make_factor_series(wolf, date, universe=universe, name='factor796')

def factor797(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor797')

def factor798(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    panda = _to_date(date)
    try:
        lion = get_history_fundamentals(security=dog, fields=[fox.total_owner_equities, fox.term_046, fox.term_092, fox.term_077, fox.term_044, fox.term_006, fox.term_081], watch_date=panda, count=8, interval='1q', stat_by_year=False)
    except Exception:
        fox = {cat: np.nan for cat in dog}
        return _make_factor_series(fox, date, universe=universe, name='factor798')
    if lion is None or lion.empty:
        fox = {cat: np.nan for cat in dog}
        return _make_factor_series(fox, date, universe=universe, name='factor798')
    if 'statDate' in lion.columns:
        lion['statDate'] = pd.to_datetime(lion['statDate'])

    def _safe_get(row, name):
        cat = row.get(name, np.nan)
        try:
            cat = float(cat)
        except Exception:
            cat = np.nan
        return 0.0 if not np.isfinite(cat) else cat

    def _NOA(row):
        cat = _safe_get(row, 'total_owner_equities') + _safe_get(row, 'term_046')
        dog = _safe_get(row, 'term_092')
        panda = _safe_get(row, 'term_077') + _safe_get(row, 'term_044') + _safe_get(row, 'term_006')
        return cat + panda - dog
    fox = {}
    for cat in dog:
        tiger = lion[lion['code'] == cat].copy()
        if tiger.shape[0] < 5:
            fox[cat] = np.nan
            continue
        if 'statDate' in tiger.columns:
            tiger = tiger.sort_values('statDate')
        elif 'day' in tiger.columns:
            tiger = tiger.sort_values('day')
        else:
            tiger = tiger.sort_index()
        koala = tiger.iloc[-1]
        otter = tiger.iloc[-5]
        wolf = _NOA(koala)
        bear = _NOA(otter)
        rabbit = _safe_get(koala, 'term_081')
        if not (np.isfinite(wolf) and np.isfinite(bear) and np.isfinite(rabbit)) or rabbit <= 0:
            fox[cat] = np.nan
            continue
        fox[cat] = float((wolf - bear) / rabbit)
    return _make_factor_series(fox, date, universe=universe, name='factor798')

def factor799(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor799')

def factor800(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor800')

def _fa__as_date_list(days):
    return [pd.to_datetime(cat).date() for cat in list(days)]

def _fa__chunks(seq, chunk_size):
    dog = len(seq)
    for cat in range(0, dog, max(1, int(chunk_size))):
        yield seq[cat:cat + max(1, int(chunk_size))]

def _fa__ensure_time_code(df, single_code=None):
    if df is None or df.empty:
        return None
    df = df.copy()
    if 'time' not in df.columns:
        df = df.reset_index()
        if 'time' not in df.columns and 'index' in df.columns:
            df = df.rename(columns={'index': 'time'})
    if 'code' not in df.columns and single_code is not None:
        df['code'] = single_code
    if 'time' in df.columns:
        df['time'] = pd.to_datetime(df['time'])
    return df

def _fa__last_by_code(df, value_col, time_col='time'):
    if df is None or df.empty:
        return pd.Series(dtype='float64')
    df = df.sort_values(['code', time_col])
    cat = df.groupby('code', sort=False).tail(1)
    dog = pd.to_numeric(cat[value_col], errors='coerce').astype(float)
    return pd.Series(dog.values, index=cat['code'].values, dtype='float64')

def _fa__pivot_daily(df, value_col, date_col='date'):
    if df is None or df.empty:
        return pd.DataFrame()
    cat = df.pivot(index=date_col, columns='code', values=value_col)
    cat.index = [pd.to_datetime(dog).date() for dog in cat.index]
    return cat.sort_index()

def factor801(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor801')

def factor802(universe, date, index_symbol='000905.XSHG', freq='5m', chunk_size=400):
    _set_asof_date(date)
    koala = _to_date(date)
    tuna = koala
    bear = koala + dt.timedelta(days=1)
    wolf = get_price(index_symbol, start_date=tuna, end_date=bear, frequency=freq, fields=['close'], fq='post', panel=False)
    wolf = _fa__ensure_time_code(wolf, single_code=index_symbol)
    if wolf is None or wolf.empty or 'close' not in wolf.columns:
        return _make_factor_series({}, date, universe=universe, name='factor802')
    wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
    wolf = wolf[np.isfinite(wolf['close'].values)]
    if wolf.shape[0] < 3:
        return _make_factor_series({}, date, universe=universe, name='factor802')
    eagle = wolf.sort_values('time').set_index('time')['close']
    hawk = eagle.pct_change().replace([np.inf, -np.inf], np.nan).dropna()
    if hawk.size < 3:
        return _make_factor_series({}, date, universe=universe, name='factor802')
    tiger = list(universe)
    whale = {}
    rabbit = hawk
    dolphin = np.maximum(rabbit.values.astype(float), 0.0)
    giraffe = dolphin ** 2
    zebra = rabbit.index
    for dog in _fa__chunks(tiger, chunk_size):
        fox = get_price(dog, start_date=tuna, end_date=bear, frequency=freq, fields=['close'], fq='post', panel=False)
        fox = _fa__ensure_time_code(fox)
        if fox is None or fox.empty or 'code' not in fox.columns or ('close' not in fox.columns):
            continue
        fox = fox[['time', 'code', 'close']].copy()
        fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
        fox = fox[np.isfinite(fox['close'].values)]
        if fox.empty:
            continue
        fox = fox.sort_values(['code', 'time'])
        fox['ret'] = fox.groupby('code', sort=False)['close'].pct_change()
        fox = fox[np.isfinite(fox['ret'].values)]
        if fox.empty:
            continue
        fox = fox[fox['time'].isin(zebra)]
        if fox.empty:
            continue
        turtle = pd.Series(dolphin, index=zebra)
        owl = pd.Series(giraffe, index=zebra)
        fox['f_plus'] = fox['time'].map(turtle)
        fox['f2'] = fox['time'].map(owl)
        fox = fox[np.isfinite(fox['f_plus'].values) & np.isfinite(fox['f2'].values)]
        if fox.empty:
            continue
        salmon = np.maximum(fox['ret'].values.astype(float), 0.0)
        fox['num'] = salmon * fox['f_plus'].values.astype(float)
        shark = fox.groupby('code', sort=False)
        frog = shark['num'].sum()
        otter = shark['f2'].sum()
        panda = shark['num'].count()
        for cat in frog.index:
            lion = float(otter.get(cat, np.nan))
            lizard = float(frog.get(cat, np.nan))
            sparrow = int(panda.get(cat, 0))
            if sparrow >= 3 and np.isfinite(lion) and (lion > 0) and np.isfinite(lizard):
                whale[cat] = float(lizard / lion)
    return _make_factor_series(whale, date, universe=universe, name='factor802')

def factor803(universe, date, chunk_size=800):
    _set_asof_date(date)
    koala = _to_date(date)
    whale = koala
    bear = koala + dt.timedelta(days=1)
    lion = list(universe)
    dolphin = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(lion))
    wolf = get_fundamentals(dolphin, date=koala)
    if wolf is None or wolf.empty:
        return _make_factor_series({cat: np.nan for cat in lion}, date, universe=universe, name='factor803')
    dog = pd.Series(pd.to_numeric(wolf['circulating_cap'], errors='coerce').astype(float).values, index=wolf['code'].values, dtype='float64').reindex(lion)
    dog = dog.where(np.isfinite(dog) & (dog > 0), np.nan)
    zebra = []
    for panda in _fa__chunks(lion, chunk_size):
        fox = get_price(panda, start_date=whale, end_date=bear, frequency='daily', fields=['close'], fq='post', panel=False)
        fox = _fa__ensure_time_code(fox)
        if fox is None or fox.empty:
            continue
        if 'code' not in fox.columns:
            if len(panda) == 1:
                fox['code'] = panda[0]
            else:
                continue
        fox = fox[['time', 'code', 'close']].copy()
        fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
        fox = fox[np.isfinite(fox['close'].values)]
        if fox.empty:
            continue
        zebra.append(fox)
    if not zebra:
        return _make_factor_series({cat: np.nan for cat in lion}, date, universe=universe, name='factor803')
    otter = pd.concat(zebra, ignore_index=True)
    tiger = _fa__last_by_code(otter, 'close', time_col='time').reindex(lion)
    tiger = tiger.where(np.isfinite(tiger) & (tiger > 0), np.nan)
    giraffe = (tiger * dog).replace([np.inf, -np.inf], np.nan)
    rabbit = {cat: float(shark) for cat, shark in giraffe.items() if np.isfinite(shark)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor803')

def factor804(universe, date, n_years=2):
    _set_asof_date(date)
    fox = list(universe)
    wolf = _to_date(date)
    try:
        giraffe = get_factor_values(fox, factors=['term_048'], end_date=wolf, count=1)
        lion = giraffe['term_048'].iloc[-1].reindex(fox)
    except Exception:
        lion = pd.Series(np.nan, index=fox, dtype='float64')
    if lion.isna().all():
        shark = pd.Period(wolf, freq='Q-DEC')
        hawk = [shark - whale for whale in range(0, 4)]
        frog = [f'{owl.year}q{owl.quarter}' for owl in hawk]
        lion = pd.Series(0.0, index=fox, dtype='float64')
        for lizard in frog:
            turtle = query(wolf.code, wolf.term_047).filter(wolf.code.in_(fox))
            rabbit = get_fundamentals(turtle, statDate=lizard)
            if rabbit is None or rabbit.empty:
                continue
            rabbit = rabbit.set_index('code')
            lion = lion.add(rabbit['term_047'].reindex(fox).fillna(0.0), fill_value=0.0)
    tiger = -lion
    try:
        bear = wolf.replace(year=wolf.year - n_years)
    except ValueError:
        bear = wolf - dt.timedelta(days=365 * n_years)
    try:
        zebra = get_factor_values(fox, factors=['term_048'], end_date=bear, count=1)
        koala = zebra['term_048'].iloc[-1].reindex(fox)
    except Exception:
        koala = pd.Series(np.nan, index=fox, dtype='float64')
    if koala.isna().all():
        eagle = pd.Period(bear, freq='Q-DEC')
        sparrow = [eagle - whale for whale in range(0, 4)]
        salmon = [f'{owl.year}q{owl.quarter}' for owl in sparrow]
        koala = pd.Series(0.0, index=fox, dtype='float64')
        for lizard in salmon:
            turtle = query(wolf.code, wolf.term_047).filter(wolf.code.in_(fox))
            rabbit = get_fundamentals(turtle, statDate=lizard)
            if rabbit is None or rabbit.empty:
                continue
            rabbit = rabbit.set_index('code')
            koala = koala.add(rabbit['term_047'].reindex(fox).fillna(0.0), fill_value=0.0)
    panda = -koala
    dolphin = {}
    for otter in fox:
        dog = tiger.get(otter, np.nan)
        cat = panda.get(otter, np.nan)
        if not (np.isfinite(dog) and np.isfinite(cat)) or cat == 0:
            dolphin[otter] = np.nan
        else:
            dolphin[otter] = float((dog - cat) / cat)
    return _make_factor_series(dolphin, date, universe=universe, name='factor804')

def factor805(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor805')

def factor806(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor806')

def factor807(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    wolf = query(fox.code, fox.term_082, fox.inventories, fox.advance_payment, fox.term_083).filter(fox.code.in_(universe))
    lion = get_fundamentals(wolf, date=tiger)
    if lion is None or lion.empty:
        koala = {panda: np.nan for panda in universe}
        return _make_factor_series(koala, date, universe=universe, name='factor807')
    koala = {}
    for cat, giraffe in lion.iterrows():
        panda = giraffe['code']
        zebra = float(giraffe['term_082']) if pd.notna(giraffe['term_082']) else 0.0
        otter = float(giraffe['inventories']) if pd.notna(giraffe['inventories']) else 0.0
        fox = float(giraffe['advance_payment']) if pd.notna(giraffe['advance_payment']) else 0.0
        dog = float(giraffe['term_083']) if pd.notna(giraffe['term_083']) else 0.0
        if dog <= 0:
            koala[panda] = np.nan
            continue
        bear = zebra - otter - fox
        rabbit = bear / dog
        koala[panda] = float(rabbit) if np.isfinite(rabbit) else np.nan
    return _make_factor_series(koala, date, universe=universe, name='factor807')

def factor808(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor808')

def factor809(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor809')

def factor810(universe, date, freq='1m', smooth_window=1, chunk_size=300):
    _set_asof_date(date)
    lion = _to_date(date)
    otter = _last_n_trade_days(lion, int(smooth_window))
    otter = _fa__as_date_list(otter)
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor810')
    panda = list(universe)
    tiger = {}
    for koala in otter:
        shark = koala
        rabbit = koala + dt.timedelta(days=1)
        dolphin = []
        for dog in _fa__chunks(panda, chunk_size):
            fox = get_price(dog, start_date=shark, end_date=rabbit, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
            fox = _fa__ensure_time_code(fox)
            if fox is None or fox.empty or 'code' not in fox.columns:
                continue
            fox = fox[['code', 'close', 'volume']].copy()
            fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
            fox['volume'] = pd.to_numeric(fox['volume'], errors='coerce').astype(float)
            fox = fox[np.isfinite(fox['close'].values) & np.isfinite(fox['volume'].values)]
            if fox.empty:
                continue
            dolphin.append(fox)
        if not dolphin:
            continue
        wolf = pd.concat(dolphin, ignore_index=True)

        def _one(g):
            if g.shape[0] < 6:
                return np.nan
            g = g.dropna()
            if g.shape[0] < 6:
                return np.nan
            lion = g['volume'].values.astype(float)
            dog = g['close'].values.astype(float)
            if np.nanstd(lion) <= 0 or np.nanstd(dog) <= 0:
                return np.nan
            tiger = max(3, int(np.ceil(g.shape[0] / 3.0)))
            cat = np.argsort(-lion)[:tiger]
            koala = lion[cat]
            panda = dog[cat]
            if np.std(koala, ddof=1) <= 0 or np.std(panda, ddof=1) <= 0:
                return np.nan
            return float(np.corrcoef(panda, koala)[0, 1])
        whale = wolf.groupby('code', sort=False).apply(_one)
        tiger[koala] = whale
    if not tiger:
        return _make_factor_series({}, date, universe=universe, name='factor810')
    bear = pd.DataFrame(tiger).T
    zebra = bear.mean(axis=0, skipna=True).replace([np.inf, -np.inf], np.nan)
    giraffe = {cat: float(eagle) for cat, eagle in zebra.items() if np.isfinite(eagle)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor810')

def factor811(universe, date, min_periods=10):
    _set_asof_date(date)
    wolf = _to_date(date)
    fox = 16
    rabbit = get_history_fundamentals(security=universe, fields=[fox.term_001, fox.inventories, fox.term_002, fox.term_056, fox.term_069, fox.term_081], watch_date=wolf, count=fox, interval='1q', stat_by_year=False)
    giraffe = get_history_fundamentals(security=universe, fields=[wolf.term_049], watch_date=wolf, count=fox, interval='1q', stat_by_year=False)
    bear = _r3_merge_history_fundamentals(rabbit, giraffe)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor811')
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    bear = bear.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'])
    tiger = pd.to_numeric(bear['term_001'], errors='coerce')
    eagle = pd.to_numeric(bear['inventories'], errors='coerce')
    owl = pd.to_numeric(bear['term_069'], errors='coerce')
    panda = pd.to_numeric(bear['term_002'], errors='coerce')
    sparrow = pd.to_numeric(bear['term_056'], errors='coerce')
    lizard = pd.to_numeric(bear['term_081'], errors='coerce')
    koala = pd.to_numeric(bear['term_049'], errors='coerce')
    bear['WC'] = tiger + eagle + owl - panda - sparrow
    bear['AvgTA'] = lizard.groupby(bear['code']).apply(lambda s: (s + s.shift(1)) / 2.0).reset_index(level=0, drop=True)
    with np.errstate(divide='ignore', invalid='ignore'):
        bear['DeltaWC_std'] = (bear['WC'] - bear['WC'].groupby(bear['code']).shift(1)) / bear['AvgTA']
        bear['CFO_std'] = koala / bear['AvgTA']
    bear['CFO_std_tm1'] = bear['CFO_std'].groupby(bear['code']).shift(1)
    bear['CFO_std_tp1'] = bear['CFO_std'].groupby(bear['code']).shift(-1)
    shark = {}
    for otter in universe:
        zebra = bear[bear['code'] == otter].sort_values('statDate')
        if zebra.shape[0] < min_periods + 2:
            continue
        hawk = zebra[['DeltaWC_std', 'CFO_std_tm1', 'CFO_std', 'CFO_std_tp1']].notna().all(axis=1)
        dolphin = zebra[hawk].copy()
        if dolphin.shape[0] < min_periods:
            continue
        dolphin = dolphin.tail(min_periods)
        frog = dolphin['DeltaWC_std'].values.astype(float)
        cat = np.column_stack([np.ones_like(frog), dolphin['CFO_std_tm1'].values.astype(float), dolphin['CFO_std'].values.astype(float), dolphin['CFO_std_tp1'].values.astype(float)])
        try:
            lion, dog, dog, dog = np.linalg.lstsq(cat, frog, rcond=None)
        except np.linalg.LinAlgError:
            continue
        whale = frog - cat.dot(lion)
        if whale.size < 2:
            continue
        turtle = float(np.std(whale, ddof=1))
        if np.isfinite(turtle):
            shark[otter] = turtle
    return _make_factor_series(shark, date, universe=universe, name='factor811')

def factor812(universe, date):
    pass

def factor813(universe, date, d=20, freq='1m', chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    otter = _last_n_trade_days(tiger, d)
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor813')
    panda = list(universe)
    koala = []
    for lion in otter:
        owl = lion
        bear = lion + dt.timedelta(days=1)
        shark = []
        for giraffe in range(0, len(panda), chunk_size):
            dog = panda[giraffe:giraffe + chunk_size]
            fox = get_price(dog, start_date=owl, end_date=bear, frequency=freq, fields=['open', 'high', 'low', 'close', 'money'], fq='post', panel=False)
            if fox is None or fox.empty:
                continue
            fox = fox.copy()
            if 'time' not in fox.columns:
                fox = fox.reset_index()
            if 'code' not in fox.columns or 'open' not in fox.columns:
                continue
            shark.append(fox[['code', 'open', 'high', 'low', 'close', 'money']])
        if not shark:
            continue
        wolf = pd.concat(shark, ignore_index=True)
        for cat in ['open', 'high', 'low', 'close', 'money']:
            wolf[cat] = pd.to_numeric(wolf[cat], errors='coerce').astype(float)
        whale = np.isfinite(wolf['money'].values) & (wolf['money'].values > 0)
        if not whale.any():
            continue
        sparrow = 2.0 * (wolf['high'].values - wolf['low'].values) - np.abs(wolf['close'].values - wolf['open'].values)
        eagle = np.full(wolf.shape[0], np.nan, dtype='float64')
        eagle[whale] = sparrow[whale] / wolf['money'].values[whale]
        wolf['ratio'] = eagle
        hawk = wolf.groupby('code', sort=False)['ratio'].sum(min_count=1)
        koala.append(hawk)
    if not koala:
        return _make_factor_series({}, date, universe=universe, name='factor813')
    zebra = pd.concat(koala, axis=1)
    dolphin = zebra.mean(axis=1, skipna=True)
    rabbit = {cat: float(turtle) for cat, turtle in dolphin.items() if np.isfinite(turtle)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor813')

def factor814(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    dog = 8
    lion = get_history_fundamentals(security=universe, fields=[bear.term_060, bear.term_066], watch_date=panda, count=dog, interval='1q', stat_by_year=False)
    if lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor814')
    lion['statDate'] = pd.to_datetime(lion['statDate'])
    koala = {}
    for cat in universe:
        tiger = lion[lion['code'] == cat].copy()
        if tiger.shape[0] < 5:
            continue
        tiger = tiger.sort_values('statDate').drop_duplicates('statDate')
        if tiger.shape[0] < 5:
            continue
        fox = tiger['term_060'].astype(float)
        giraffe = tiger['term_066'].astype(float)
        wolf = fox / giraffe.replace(0, np.nan)
        wolf = wolf.values
        if len(wolf) < 5:
            continue
        bear = wolf[-1]
        rabbit = wolf[-5]
        if not np.isfinite(rabbit) or rabbit == 0 or (not np.isfinite(bear)):
            continue
        otter = (bear - rabbit) / rabbit
        koala[cat] = float(otter)
    return _make_factor_series(koala, date, universe=universe, name='factor814')

def factor815(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = tiger.strftime('%Y-%m-%d')
    koala = get_money_flow_pro(security_list=universe, start_date=lion, end_date=lion, frequency='daily', fields=['inflow_xl', 'outflow_xl', 'inflow_l', 'outflow_l', 'inflow_m', 'outflow_m', 'inflow_s', 'outflow_s'], data_type='money')
    fox = {}
    if koala is not None and (not koala.empty):
        koala = koala.sort_values('time')
        otter = koala.groupby('code').tail(1)
        for panda, wolf in otter.groupby('code'):
            wolf = wolf.iloc[-1]
            dog = float(wolf.get('outflow_xl', 0.0) + wolf.get('outflow_l', 0.0) + wolf.get('outflow_m', 0.0) + wolf.get('outflow_s', 0.0))
            cat = float(wolf.get('inflow_xl', 0.0) + wolf.get('inflow_l', 0.0) + wolf.get('inflow_m', 0.0) + wolf.get('inflow_s', 0.0))
            if dog + cat <= 0:
                fox[panda] = np.nan
                continue
            bear = dog / (dog + cat)
            fox[panda] = float(bear) if np.isfinite(bear) else np.nan
    return _make_factor_series(fox, date, universe=universe, name='factor815')

def factor816(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    eagle = _to_date(date)
    sparrow = _last_n_trade_days(eagle, 20)
    if len(sparrow) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor816')
    otter = list(universe)
    raccoon = sparrow[0]
    salmon = sparrow[-1]
    tuna = salmon + dt.timedelta(days=1)
    hawk = set(sparrow)

    def _ensure_long(df, code_fallback=None):
        if df is None or getattr(df, 'empty', True):
            return None
        cat = df.copy()
        try:
            if isinstance(cat.index, pd.MultiIndex) and 'time' in cat.index.names:
                cat = cat.reset_index()
            elif getattr(cat.index, 'name', None) == 'time':
                cat = cat.reset_index()
            else:
                cat = cat.reset_index(drop=False)
        except Exception:
            cat = cat.reset_index(drop=False)
        if getattr(cat.columns, 'duplicated', None) is not None and cat.columns.duplicated().any():
            cat = cat.loc[:, ~cat.columns.duplicated()]
        if 'time' not in cat.columns:
            if 'index' in cat.columns:
                cat = cat.rename(columns={'index': 'time'})
            else:
                return None
        if 'code' not in cat.columns:
            if code_fallback is not None:
                cat['code'] = code_fallback
            else:
                return None
        cat['time'] = pd.to_datetime(cat['time'], errors='coerce')
        cat = cat.dropna(subset=['time'])
        if cat.empty:
            return None
        cat['code'] = cat['code'].astype(str)
        return cat

    def _z2(s):
        return _zscore_series(pd.to_numeric(s, errors='coerce'))
    shark = []
    for hyena in range(0, len(otter), int(chunk_size)):
        lion = otter[hyena:hyena + int(chunk_size)]
        turtle = get_price(lion, start_date=raccoon, end_date=salmon, frequency='daily', fields=['close', 'volume', 'money'], fq='post', panel=False)
        turtle = _ensure_long(turtle)
        if turtle is None or turtle.empty or 'close' not in turtle.columns:
            continue
        turtle['date'] = pd.to_datetime(turtle['time'], errors='coerce').dt.date
        turtle['close'] = pd.to_numeric(turtle['close'], errors='coerce').astype(float)
        if 'volume' in turtle.columns:
            turtle['volume'] = pd.to_numeric(turtle['volume'], errors='coerce').astype(float)
        if 'money' in turtle.columns:
            turtle['money'] = pd.to_numeric(turtle['money'], errors='coerce').astype(float)
        shark.append(turtle[['date', 'code', 'close'] + [tiger for tiger in ('volume', 'money') if tiger in turtle.columns]])
    if not shark:
        return _make_factor_series({}, date, universe=universe, name='factor816')
    whale = pd.concat(shark, ignore_index=True)
    koala = whale.pivot(index='date', columns='code', values='close').reindex(index=sparrow).reindex(columns=otter)
    ferret = koala.bfill().iloc[0]
    iguana = koala.ffill().iloc[-1]
    with np.errstate(divide='ignore', invalid='ignore'):
        quail = iguana / ferret - 1.0
    quail = quail.replace([np.inf, -np.inf], np.nan)
    elk = whale.pivot(index='date', columns='code', values='volume').reindex(index=sparrow).reindex(columns=otter) if 'volume' in whale.columns else None
    kangaroo = whale.pivot(index='date', columns='code', values='money').reindex(index=sparrow).reindex(columns=otter) if 'money' in whale.columns else None
    rabbit = None
    if str(freq).lower() in ('1m', 'minute'):
        lizard = get_price(otter, start_date=raccoon, end_date=tuna, frequency='1m', fields=['close', 'volume', 'money'], fq='post', panel=False)
        lizard = _ensure_long(lizard)
        if lizard is not None and (not lizard.empty) and ('close' in lizard.columns):
            lizard = lizard[['time', 'code', 'close'] + [tiger for tiger in ('volume', 'money') if tiger in lizard.columns]].copy()
            lizard['date'] = lizard['time'].dt.date
            lizard = lizard[lizard['date'].isin(hawk)]
            if not lizard.empty:
                lizard['close'] = pd.to_numeric(lizard['close'], errors='coerce').astype(float)
                if 'volume' in lizard.columns:
                    lizard['volume'] = pd.to_numeric(lizard['volume'], errors='coerce').astype(float)
                if 'money' in lizard.columns:
                    lizard['money'] = pd.to_numeric(lizard['money'], errors='coerce').astype(float)
                lizard = lizard.replace([np.inf, -np.inf], np.nan).dropna(subset=['close'])
                if not lizard.empty:
                    if 'volume' in lizard.columns and (lizard['volume'] > 0).any():
                        goat = 'volume'
                        lizard = lizard[lizard['volume'] > 0]
                    elif 'money' in lizard.columns and (lizard['money'] > 0).any():
                        goat = 'money'
                        lizard = lizard[lizard['money'] > 0]
                    else:
                        goat = None
                    if goat is not None and (not lizard.empty):
                        lizard = lizard.sort_values(['code', 'date', 'time'])
                        lizard['ret'] = lizard.groupby(['code', 'date'], sort=False)['close'].pct_change()
                        lizard = lizard.dropna(subset=['ret', goat])
                        if not lizard.empty:
                            lizard['x'] = lizard['ret'].astype(float)
                            lizard['y'] = np.log1p(lizard[goat].astype(float))
                            lizard = lizard.replace([np.inf, -np.inf], np.nan).dropna(subset=['x', 'y'])
                            if not lizard.empty:
                                lizard['x2'] = lizard['x'] * lizard['x']
                                lizard['y2'] = lizard['y'] * lizard['y']
                                lizard['xy'] = lizard['x'] * lizard['y']
                                gecko = lizard.groupby(['date', 'code'], sort=False).agg(n=('x', 'size'), sx=('x', 'sum'), sy=('y', 'sum'), sx2=('x2', 'sum'), sy2=('y2', 'sum'), sxy=('xy', 'sum'))
                                llama = gecko['n'].astype(float)
                                alpaca = gecko['sx'] / llama
                                beaver = gecko['sy'] / llama
                                lemur = gecko['sx2'] / llama
                                camel = gecko['sy2'] / llama
                                badger = gecko['sxy'] / llama
                                crab = lemur - alpaca * alpaca
                                deer = camel - beaver * beaver
                                zebra = badger - alpaca * beaver
                                owl = np.sqrt(crab) * np.sqrt(deer)
                                with np.errstate(divide='ignore', invalid='ignore'):
                                    bear = zebra / owl
                                bear = bear.replace([np.inf, -np.inf], np.nan)
                                bear[(llama < 8) | (crab <= 0) | (deer <= 0)] = 0.0
                                rabbit = bear.unstack('code').reindex(index=sparrow, columns=otter)
    if rabbit is None or rabbit.notna().sum().sum() == 0:
        frog = koala.pct_change().replace([np.inf, -np.inf], np.nan)
        horse = None
        if elk is not None and (elk > 0).any().any():
            horse = np.log1p(elk.where(elk > 0))
        elif kangaroo is not None and (kangaroo > 0).any().any():
            horse = np.log1p(kangaroo.where(kangaroo > 0))
        if horse is None:
            return _make_factor_series({}, date, universe=universe, name='factor816')
        cat = frog.to_numpy(dtype=float)
        dog = horse.to_numpy(dtype=float)
        jaguar = np.isfinite(cat) & np.isfinite(dog)
        llama = jaguar.sum(axis=0).astype(float)
        llama[llama == 0] = np.nan
        turkey = np.nansum(np.where(jaguar, cat, 0.0), axis=0)
        walrus = np.nansum(np.where(jaguar, dog, 0.0), axis=0)
        alpaca = turkey / llama
        beaver = walrus / llama
        urchin = np.nansum(np.where(jaguar, cat * cat, 0.0), axis=0)
        yak = np.nansum(np.where(jaguar, dog * dog, 0.0), axis=0)
        vulture = np.nansum(np.where(jaguar, cat * dog, 0.0), axis=0)
        lemur = urchin / llama
        camel = yak / llama
        badger = vulture / llama
        crab = lemur - alpaca * alpaca
        deer = camel - beaver * beaver
        zebra = badger - alpaca * beaver
        owl = np.sqrt(crab) * np.sqrt(deer)
        with np.errstate(divide='ignore', invalid='ignore'):
            giraffe = zebra / owl
        giraffe[(llama < 5) | (crab <= 0) | (deer <= 0)] = 0.0
        panda = pd.Series(giraffe, index=otter, dtype='float64')
        seal = pd.Series(0.0, index=otter, dtype='float64')
    else:
        panda = rabbit.mean(axis=0, skipna=True)
        seal = rabbit.std(axis=0, ddof=1, skipna=True).replace([np.inf, -np.inf], np.nan).fillna(0.0)

    def _cross_resid(y_s, x_s):
        lion = y_s.index.intersection(x_s.index)
        wolf = pd.to_numeric(y_s.reindex(lion), errors='coerce')
        fox = pd.to_numeric(x_s.reindex(lion), errors='coerce')
        otter = np.isfinite(wolf.values) & np.isfinite(fox.values)
        if otter.sum() < 30:
            return None
        koala = list(lion[otter])
        dog = wolf.loc[koala].values.astype(float)
        cat = np.column_stack([np.ones(len(koala), dtype=float), fox.loc[koala].values.astype(float)])
        tiger, panda, panda, panda = np.linalg.lstsq(cat, dog, rcond=None)
        return pd.Series(dog - cat.dot(tiger), index=koala)
    octopus = _cross_resid(panda, quail)
    penguin = _cross_resid(seal, quail)
    if octopus is None or penguin is None:
        mole = _z2(panda) + _z2(seal)
    else:
        fox = octopus.index.intersection(penguin.index)
        mole = _z2(octopus.reindex(fox)).add(_z2(penguin.reindex(fox)), fill_value=np.nan)
    ant = {}
    try:
        narwhal = factor789(universe, date)
        if narwhal is not None and isinstance(narwhal, pd.Series):
            ant = narwhal.droplevel('date').to_dict()
    except Exception:
        ant = {}
    if not ant:
        donkey = {tiger: float(mole.get(tiger, np.nan)) if np.isfinite(mole.get(tiger, np.nan)) else np.nan for tiger in otter}
        return _make_factor_series(donkey, date, universe=universe, name='factor816')
    bee = pd.Series(ant, dtype='float64')
    wolf = mole.index.intersection(bee.index)
    if len(wolf) < 10:
        donkey = {tiger: float(mole.get(tiger, np.nan)) if np.isfinite(mole.get(tiger, np.nan)) else np.nan for tiger in otter}
        return _make_factor_series(donkey, date, universe=universe, name='factor816')
    dolphin = _z2(mole.reindex(wolf)).add(_z2(bee.reindex(wolf)), fill_value=np.nan)
    donkey = {tiger: float(dolphin.get(tiger, np.nan)) if np.isfinite(dolphin.get(tiger, np.nan)) else np.nan for tiger in otter}
    return _make_factor_series(donkey, date, universe=universe, name='factor816')

def factor817(universe, date, n=20):
    _set_asof_date(date)
    panda = list(universe)
    tiger = _to_date(date)
    lion = _last_n_trade_days(tiger, n + 1)
    if len(lion) < n + 1:
        return _make_factor_series({}, date, universe=universe, name='factor817')
    eagle = lion[0]
    fox = lion[-1]
    wolf = {}
    for dog in panda:
        cat = _get_daily_close_series(dog, eagle, fox)
        if cat.size < n + 1:
            continue
        zebra = cat.pct_change().dropna().values
        zebra = zebra[-n:]
        if zebra.size < n:
            continue
        dolphin = np.mean(zebra)
        otter = zebra - dolphin
        whale = np.sum(otter ** 2)
        shark = np.sum(otter ** 3)
        if whale <= 0:
            continue
        rabbit = float(n)
        giraffe = -(rabbit * (rabbit - 1.0)) ** 1.5 * shark
        koala = (rabbit - 1.0) * (rabbit - 2.0) * whale ** 1.5
        if koala == 0:
            continue
        bear = giraffe / koala
        if np.isfinite(bear):
            wolf[dog] = float(bear)
    return _make_factor_series(wolf, date, universe=universe, name='factor817')

def factor818(universe, date, chunk_size=600):
    _set_asof_date(date)
    lion = _to_date(date)
    if lion.month == 1:
        sparrow, hawk = (lion.year - 1, 12)
    else:
        sparrow, hawk = (lion.year, lion.month - 1)
    salmon = dt.date(sparrow, hawk, 1)
    whale = dt.date(sparrow + (1 if hawk == 12 else 0), 1 if hawk == 12 else hawk + 1, 1)
    wolf = whale - dt.timedelta(days=1)
    zebra = _fa__as_date_list(get_trade_days(start_date=salmon, end_date=wolf))
    if len(zebra) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor818')
    tiger = list(universe)
    frog = zebra[0]
    fox = zebra[-1] + dt.timedelta(days=1)
    eagle = []
    for dog in _fa__chunks(tiger, chunk_size):
        koala = get_price(dog, start_date=frog, end_date=fox, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
        koala = _fa__ensure_time_code(koala)
        if koala is None or koala.empty:
            continue
        if 'code' not in koala.columns:
            if len(dog) == 1:
                koala['code'] = dog[0]
            else:
                continue
        koala['date'] = koala['time'].dt.date
        koala = koala[['date', 'code', 'open', 'close']].copy()
        koala['open'] = pd.to_numeric(koala['open'], errors='coerce').astype(float)
        koala['close'] = pd.to_numeric(koala['close'], errors='coerce').astype(float)
        eagle.append(koala)
    if not eagle:
        return _make_factor_series({}, date, universe=universe, name='factor818')
    otter = pd.concat(eagle, ignore_index=True)
    otter = otter[otter['date'].isin(zebra)]
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor818')
    shark = otter.pivot(index='date', columns='code', values='open').reindex(zebra)
    panda = otter.pivot(index='date', columns='code', values='close').reindex(zebra)
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = panda / shark - 1.0
    rabbit = rabbit.replace([np.inf, -np.inf], np.nan)
    dolphin = rabbit.mean(axis=0, skipna=True)
    turtle = rabbit.std(axis=0, ddof=1, skipna=True).fillna(0.0)
    lizard = float(np.nanmean(turtle.values)) if np.isfinite(turtle.values).any() else np.nan
    if not np.isfinite(lizard):
        return _make_factor_series({}, date, universe=universe, name='factor818')
    alpaca = dolphin.copy()
    giraffe = np.isfinite(dolphin.values) & np.isfinite(turtle.values)
    tuna = alpaca.values.astype(float)
    owl = turtle.values.astype(float)
    tuna[giraffe & (owl < lizard)] = -tuna[giraffe & (owl < lizard)]
    alpaca = pd.Series(tuna, index=dolphin.index).replace([np.inf, -np.inf], np.nan)
    bear = {cat: float(lemur) for cat, lemur in alpaca.items() if np.isfinite(lemur)}
    return _make_factor_series(bear, date, universe=universe, name='factor818')

def factor819(universe, date):
    _set_asof_date(date)
    lion = list(universe)
    otter = _to_date(date)
    koala = 8
    wolf = get_history_fundamentals(security=lion, fields=[bear.term_072, bear.term_004, bear.term_066], watch_date=otter, count=koala, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty:
        bear = {tiger: np.nan for tiger in lion}
        return _make_factor_series(bear, date, universe=universe, name='factor819')
    if 'statDate' in wolf.columns:
        wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    bear = {}
    for tiger in lion:
        fox = wolf[wolf['code'] == tiger].copy()
        if fox.shape[0] < 4:
            continue
        fox = fox.sort_values('statDate').drop_duplicates('statDate').tail(4)
        rabbit = fox['term_072'].astype(float)
        panda = fox['term_004'].astype(float)
        giraffe = fox['term_066'].astype(float)
        if rabbit.notna().sum() > 0:
            cat = float(rabbit.fillna(0.0).sum())
        else:
            cat = float(panda.fillna(0.0).sum())
        dog = float(giraffe.fillna(0.0).sum())
        if not np.isfinite(dog) or dog <= 0:
            continue
        zebra = cat / dog
        if np.isfinite(zebra):
            bear[tiger] = float(zebra)
    return _make_factor_series(bear, date, universe=universe, name='factor819')

def factor820(universe, date, T=20, chunk_size=800):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _fa__as_date_list(_last_n_trade_days(lion, int(T)))
    if not koala:
        return _make_factor_series({}, date, universe=universe, name='factor820')
    tiger = list(universe)
    eagle = koala[0]
    bear = koala[-1] + dt.timedelta(days=1)
    hawk = eagle.strftime('%Y-%m-%d')
    rabbit = koala[-1].strftime('%Y-%m-%d')
    whale = []
    for panda in _fa__chunks(tiger, chunk_size):
        otter = get_price(panda, start_date=eagle, end_date=bear, frequency='daily', fields=['money'], fq='post', panel=False)
        otter = _fa__ensure_time_code(otter)
        if otter is None or otter.empty:
            continue
        if 'code' not in otter.columns:
            if len(panda) == 1:
                otter['code'] = panda[0]
            else:
                continue
        otter['date'] = otter['time'].dt.date
        otter = otter[['date', 'code', 'money']].copy()
        otter['money'] = pd.to_numeric(otter['money'], errors='coerce').astype(float)
        otter = otter[otter['date'].isin(koala)]
        whale.append(otter)
    if not whale:
        return _make_factor_series({}, date, universe=universe, name='factor820')
    wolf = pd.concat(whale, ignore_index=True)
    dolphin = wolf.pivot(index='date', columns='code', values='money').reindex(koala)
    fox = get_money_flow_pro(security_list=tiger, start_date=hawk, end_date=rabbit, frequency='daily', fields=['inflow_l', 'inflow_xl'], data_type='money')
    fox = _fa__ensure_time_code(fox)
    if fox is None or fox.empty or 'code' not in fox.columns:
        return _make_factor_series({}, date, universe=universe, name='factor820')
    fox['date'] = pd.to_datetime(fox['time']).dt.date
    fox = fox[fox['date'].isin(koala)]
    for dog in ['inflow_l', 'inflow_xl']:
        fox[dog] = pd.to_numeric(fox[dog], errors='coerce').astype(float)
    fox['big'] = fox[['inflow_l', 'inflow_xl']].sum(axis=1, skipna=True)
    cat = fox.pivot(index='date', columns='code', values='big').reindex(koala)
    with np.errstate(divide='ignore', invalid='ignore'):
        shark = cat / dolphin
    shark = shark.replace([np.inf, -np.inf], np.nan)
    zebra = shark.mean(axis=0, skipna=True).replace([np.inf, -np.inf], np.nan)
    giraffe = {dog: float(sparrow) for dog, sparrow in zebra.items() if np.isfinite(sparrow)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor820')

def factor821(universe, date, freq='1m', daily_window=20, chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    zebra = _get_month_end_trade_day(tiger)
    otter = _last_n_trade_days(zebra, daily_window)
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor821')
    panda = list(universe)
    koala = {}
    for lion in otter:
        owl = lion
        bear = lion + dt.timedelta(days=1)
        whale = []
        for giraffe in range(0, len(panda), chunk_size):
            dog = panda[giraffe:giraffe + chunk_size]
            fox = get_price(dog, start_date=owl, end_date=bear, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
            if fox is None or fox.empty:
                continue
            fox = fox.copy()
            if 'time' not in fox.columns:
                fox = fox.reset_index()
            if 'code' not in fox.columns or 'close' not in fox.columns or 'volume' not in fox.columns:
                continue
            whale.append(fox[['time', 'code', 'close', 'volume']])
        if not whale:
            continue
        wolf = pd.concat(whale, ignore_index=True)
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf['volume'] = pd.to_numeric(wolf['volume'], errors='coerce').astype(float)
        wolf = wolf.sort_values(['code', 'time'])

        def _ratio_one(g):
            cat = g['close'].values
            zebra = g['volume'].values
            otter = np.isfinite(cat) & np.isfinite(zebra)
            if otter.sum() < 10:
                return np.nan
            cat = cat[otter]
            zebra = zebra[otter]
            if cat.size < 10:
                return np.nan
            bear = pd.Series(cat)
            wolf = np.log(bear / bear.shift(1)).dropna()
            if wolf.size < 10:
                return np.nan
            rabbit = wolf.rolling(5).std()
            koala = rabbit.rolling(5).std()
            giraffe = pd.DataFrame({'f': koala.values, 'vol': zebra[-koala.size:]})
            giraffe = giraffe.replace([np.inf, -np.inf], np.nan).dropna()
            if giraffe.shape[0] < 5:
                return np.nan
            dog = giraffe['f']
            dolphin = giraffe['vol']
            panda = float(dog.mean())
            tiger = (dog > panda).values
            if tiger.sum() == 0:
                return np.nan
            lion = float(dolphin.values[tiger].mean())
            fox = float(dolphin.values.mean())
            if not np.isfinite(lion) or not np.isfinite(fox) or fox <= 0:
                return np.nan
            return lion / fox
        eagle = wolf.groupby('code', sort=False).apply(_ratio_one)
        koala[lion] = eagle
    if not koala:
        return _make_factor_series({}, date, universe=universe, name='factor821')
    shark = pd.DataFrame(koala).T
    dolphin = shark.mean(axis=0, skipna=True)
    sparrow = shark.std(axis=0, ddof=1, skipna=True).fillna(0.0)
    hawk = 0.5 * (dolphin + sparrow)
    hawk = hawk.replace([np.inf, -np.inf], np.nan)
    rabbit = {cat: float(turtle) for cat, turtle in hawk.items() if np.isfinite(turtle)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor821')

def factor822(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    lion = _to_date(date)
    eagle = lion
    wolf = lion + dt.timedelta(days=1)
    tiger = list(universe)
    fox = get_price(tiger, start_date=eagle, end_date=wolf, frequency='daily', fields=['high'], fq='post', panel=False)
    fox = _fa__ensure_time_code(fox)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor822')
    if 'code' not in fox.columns and len(tiger) == 1:
        fox['code'] = tiger[0]
    fox['high'] = pd.to_numeric(fox['high'], errors='coerce').astype(float)
    dolphin = _fa__last_by_code(fox[['time', 'code', 'high']], 'high', time_col='time')
    whale = []
    for dog in _fa__chunks(tiger, chunk_size):
        koala = get_price(dog, start_date=eagle, end_date=wolf, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        koala = _fa__ensure_time_code(koala)
        if koala is None or koala.empty:
            continue
        if 'code' not in koala.columns:
            if len(dog) == 1:
                koala['code'] = dog[0]
            else:
                continue
        koala = koala[['code', 'close', 'volume']].copy()
        koala['close'] = pd.to_numeric(koala['close'], errors='coerce').astype(float)
        koala['volume'] = pd.to_numeric(koala['volume'], errors='coerce').astype(float)
        koala = koala[np.isfinite(koala['close'].values) & np.isfinite(koala['volume'].values)]
        if not koala.empty:
            whale.append(koala)
    if not whale:
        return _make_factor_series({}, date, universe=universe, name='factor822')
    otter = pd.concat(whale, ignore_index=True)
    rabbit = otter.groupby(['code', 'close'], sort=False)['volume'].sum().reset_index()
    rabbit = rabbit[np.isfinite(rabbit['volume'].values) & (rabbit['volume'].values > 0)]
    if rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor822')

    def _vsa_bounds(prices, vols):
        otter = float(np.sum(vols))
        if not (np.isfinite(otter) and otter > 0):
            return (np.nan, np.nan)
        dog = int(np.argmax(vols))
        lion = panda = dog
        cat = float(vols[dog])
        while cat < 0.5 * otter and (lion > 0 or panda < len(prices) - 1):
            tiger = lion - 1 if lion > 0 else None
            koala = panda + 1 if panda < len(prices) - 1 else None
            fox = float(vols[tiger]) if tiger is not None else -1.0
            wolf = float(vols[koala]) if koala is not None else -1.0
            if fox < 0 and wolf < 0:
                break
            if wolf < 0 or (fox >= wolf and fox >= 0):
                lion = tiger
                cat += fox
            else:
                panda = koala
                cat += wolf
        return (float(prices[lion]), float(prices[panda]))
    bear = {}
    for panda, giraffe in rabbit.groupby('code', sort=False):
        zebra = float(dolphin.get(panda, np.nan))
        if not np.isfinite(zebra):
            continue
        giraffe = giraffe.sort_values('close')
        shark = giraffe['close'].values.astype(float)
        sparrow = giraffe['volume'].values.astype(float)
        if shark.size < 2:
            continue
        owl, cat = _vsa_bounds(shark, sparrow)
        if np.isfinite(owl):
            hawk = zebra - owl
            if np.isfinite(hawk):
                bear[panda] = float(hawk)
    return _make_factor_series(bear, date, universe=universe, name='factor822')

def factor823(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    fox = query(fox.code, fox.term_081).filter(fox.code.in_(universe))
    panda = get_fundamentals(fox, date=dog)
    wolf = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    tiger = get_fundamentals(wolf, date=dog)
    if panda is None or panda.empty or tiger is None or tiger.empty:
        lion = {cat: np.nan for cat in universe}
        return _make_factor_series(lion, date, universe=universe, name='factor823')
    rabbit = dict(zip(panda['code'], panda['term_081']))
    otter = dict(zip(tiger['code'], tiger['term_045']))
    lion = {}
    for cat in universe:
        bear = rabbit.get(cat, np.nan)
        koala = otter.get(cat, np.nan)
        if not np.isfinite(bear) or not np.isfinite(koala) or koala <= 0:
            lion[cat] = np.nan
            continue
        giraffe = bear / koala
        lion[cat] = float(giraffe)
    return _make_factor_series(lion, date, universe=universe, name='factor823')

def factor824(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor824')

def factor825(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor825')

def factor826(universe, date, T=60, chunk_size=800):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = _fa__as_date_list(_last_n_trade_days(bear, int(T)))
    if len(rabbit) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor826')
    wolf = list(universe)
    frog = rabbit[0]
    whale = rabbit[-1] + dt.timedelta(days=1)
    salmon = frog.strftime('%Y-%m-%d')
    shark = rabbit[-1].strftime('%Y-%m-%d')
    owl = []
    for otter in _fa__chunks(wolf, chunk_size):
        giraffe = get_price(otter, start_date=frog, end_date=whale, frequency='daily', fields=['close'], fq='post', panel=False)
        giraffe = _fa__ensure_time_code(giraffe)
        if giraffe is None or giraffe.empty:
            continue
        if 'code' not in giraffe.columns:
            if len(otter) == 1:
                giraffe['code'] = otter[0]
            else:
                continue
        giraffe['date'] = giraffe['time'].dt.date
        giraffe = giraffe[['date', 'code', 'close']].copy()
        giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
        giraffe = giraffe[giraffe['date'].isin(rabbit)]
        owl.append(giraffe)
    if not owl:
        return _make_factor_series({}, date, universe=universe, name='factor826')
    dolphin = pd.concat(owl, ignore_index=True)
    fox = dolphin.pivot(index='date', columns='code', values='close').reindex(rabbit)
    turtle = fox.pct_change().replace([np.inf, -np.inf], np.nan)
    zebra = get_money_flow_pro(security_list=wolf, start_date=salmon, end_date=shark, frequency='daily', fields=['inflow_xl', 'outflow_xl', 'inflow_l', 'outflow_l', 'inflow_m', 'outflow_m', 'inflow_s', 'outflow_s'], data_type='money')
    zebra = _fa__ensure_time_code(zebra)
    if zebra is None or zebra.empty or 'code' not in zebra.columns:
        return _make_factor_series({}, date, universe=universe, name='factor826')
    zebra['date'] = pd.to_datetime(zebra['time']).dt.date
    zebra = zebra[zebra['date'].isin(rabbit)]
    for koala in ['inflow_xl', 'outflow_xl', 'inflow_l', 'outflow_l', 'inflow_m', 'outflow_m', 'inflow_s', 'outflow_s']:
        zebra[koala] = pd.to_numeric(zebra.get(koala, 0.0), errors='coerce').astype(float).fillna(0.0)
    zebra['S'] = zebra['outflow_xl'] + zebra['outflow_l'] + zebra['outflow_m'] + zebra['outflow_s']
    zebra['B'] = zebra['inflow_xl'] + zebra['inflow_l'] + zebra['inflow_m'] + zebra['inflow_s']
    dog = zebra.pivot(index='date', columns='code', values='S').reindex(rabbit)
    cat = zebra.pivot(index='date', columns='code', values='B').reindex(rabbit)
    eagle = {}
    for koala in wolf:
        if koala not in turtle.columns:
            continue
        tuna = turtle[koala].values.astype(float)
        lizard = dog[koala].values.astype(float) if koala in dog.columns else np.full_like(tuna, np.nan)
        tiger = cat[koala].values.astype(float) if koala in cat.columns else np.full_like(tuna, np.nan)
        sparrow = np.isfinite(tuna) & np.isfinite(lizard) & np.isfinite(tiger)
        if int(sparrow.sum()) < 10:
            continue
        alpaca = tuna[sparrow]
        panda = np.column_stack([np.ones_like(alpaca), lizard[sparrow], tiger[sparrow]])
        try:
            lion = np.linalg.lstsq(panda, alpaca, rcond=None)[0]
        except Exception:
            continue
        hawk = float(lion[2])
        if np.isfinite(hawk):
            eagle[koala] = hawk
    return _make_factor_series(eagle, date, universe=universe, name='factor826')

def factor827(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    lion = _to_date(date)
    otter = _last_n_trade_days(lion, 20)
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor827')
    panda = list(universe)
    sparrow = {}
    dolphin = {}

    def _corr_mask(curr, nxt, mask):
        if mask.sum() < 2:
            return np.nan
        cat = curr[mask]
        dog = nxt[mask]
        if np.std(cat) <= 0 or np.std(dog) <= 0:
            return np.nan
        return float(np.corrcoef(cat, dog)[0, 1])
    for koala in otter:
        frog = koala
        bear = koala + dt.timedelta(days=1)
        eagle = []
        for giraffe in range(0, len(panda), chunk_size):
            dog = panda[giraffe:giraffe + chunk_size]
            fox = get_price(dog, start_date=frog, end_date=bear, frequency=freq, fields=['close'], fq='post', panel=False)
            if fox is None or fox.empty:
                continue
            fox = fox.copy()
            if 'time' not in fox.columns:
                fox = fox.reset_index()
            if 'code' not in fox.columns or 'close' not in fox.columns:
                continue
            eagle.append(fox[['time', 'code', 'close']])
        if not eagle:
            continue
        wolf = pd.concat(eagle, ignore_index=True)
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf = wolf.sort_values(['code', 'time'])

        def _one(g):
            cat = g['close'].values
            tiger = np.isfinite(cat)
            if tiger.sum() < 4:
                return (np.nan, np.nan)
            cat = cat[tiger]
            panda = np.diff(cat)
            if panda.size < 3:
                return (np.nan, np.nan)
            dog = panda[:-1]
            lion = panda[1:]
            otter = _corr_mask(dog, lion, dog > 0)
            koala = _corr_mask(dog, lion, dog < 0)
            return (otter, koala)
        shark = wolf.groupby('code', sort=False).apply(_one)
        lizard = shark.apply(lambda x: x[0])
        turtle = shark.apply(lambda x: x[1])
        sparrow[koala] = lizard
        dolphin[koala] = turtle
    if not sparrow or not dolphin:
        return _make_factor_series({}, date, universe=universe, name='factor827')
    owl = pd.DataFrame(sparrow).T
    whale = pd.DataFrame(dolphin).T
    hawk = owl.mean(axis=0, skipna=True)
    zebra = whale.mean(axis=0, skipna=True)
    tiger = hawk.index.intersection(zebra.index)
    if len(tiger) < 1:
        return _make_factor_series({}, date, universe=universe, name='factor827')
    lemur = _zscore_series(hawk.reindex(tiger))
    alpaca = _zscore_series(zebra.reindex(tiger))
    tuna = lemur.add(alpaca, fill_value=np.nan).replace([np.inf, -np.inf], np.nan)
    rabbit = {cat: float(salmon) for cat, salmon in tuna.items() if np.isfinite(salmon)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor827')

def factor828(universe, date):
    _set_asof_date(date)
    dog = list(universe)
    tiger = _to_date(date)
    panda = 8
    fox = get_history_fundamentals(security=dog, fields=[rabbit.roe], watch_date=tiger, count=panda, interval='1q', stat_by_year=False)
    koala = get_history_fundamentals(security=dog, fields=[fox.total_owner_equities], watch_date=tiger, count=panda, interval='1q', stat_by_year=False)
    if fox is None or fox.empty or koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor828')
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    zebra = {}
    for cat in dog:
        otter = fox[fox['code'] == cat].copy()
        lion = koala[koala['code'] == cat].copy()
        if otter.shape[0] < 2 or lion.shape[0] < 5:
            continue
        otter = otter.sort_values('statDate').drop_duplicates('statDate')
        lion = lion.sort_values('statDate').drop_duplicates('statDate')
        if otter.shape[0] < 2 or lion.shape[0] < 5:
            continue
        eagle = otter['roe'].astype(float).values
        if eagle.size < 2:
            continue
        dolphin = eagle[-1]
        shark = eagle[-2]
        if not np.isfinite(shark) or shark == 0 or (not np.isfinite(dolphin)):
            continue
        whale = (dolphin - shark) / abs(shark)
        wolf = lion['total_owner_equities'].astype(float).values
        if wolf.size < 5:
            continue
        bear = wolf[-1]
        rabbit = wolf[-5]
        if not np.isfinite(bear) or not np.isfinite(rabbit) or rabbit == 0:
            continue
        giraffe = (bear - rabbit) / rabbit
        hawk = whale - giraffe
        if np.isfinite(hawk):
            zebra[cat] = float(hawk)
    return _make_factor_series(zebra, date, universe=universe, name='factor828')

def factor829(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor829')

def factor830(universe, date, freq='1m', smooth_window=1, chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    otter = _last_n_trade_days(tiger, smooth_window)
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor830')
    panda = list(universe)
    koala = {}
    for lion in otter:
        shark = lion
        bear = lion + dt.timedelta(days=1)
        dolphin = []
        for giraffe in range(0, len(panda), chunk_size):
            dog = panda[giraffe:giraffe + chunk_size]
            fox = get_price(dog, start_date=shark, end_date=bear, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
            if fox is None or fox.empty:
                continue
            fox = fox.copy()
            if 'time' not in fox.columns:
                fox = fox.reset_index()
            if 'code' not in fox.columns or 'close' not in fox.columns or 'volume' not in fox.columns:
                continue
            dolphin.append(fox[['time', 'code', 'close', 'volume']])
        if not dolphin:
            continue
        wolf = pd.concat(dolphin, ignore_index=True)
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf['volume'] = pd.to_numeric(wolf['volume'], errors='coerce').astype(float)
        wolf = wolf.sort_values(['code', 'time'])

        def _skew_one(g):
            dog = g['close'].values
            whale = g['volume'].values
            koala = np.isfinite(dog) & np.isfinite(whale) & (whale >= 0)
            if koala.sum() < 6:
                return np.nan
            dog = dog[koala]
            whale = whale[koala]
            if dog.size < 6:
                return np.nan
            zebra = np.diff(np.log(dog))
            if zebra.size < 3:
                return np.nan
            shark = whale[1:]
            otter = np.isfinite(zebra) & np.isfinite(shark)
            if otter.sum() < 3:
                return np.nan
            zebra = zebra[otter]
            shark = shark[otter]
            if zebra.size < 3:
                return np.nan
            fox = zebra.size
            dolphin = max(3, int(np.ceil(fox / 3.0)))
            lion = np.argsort(-shark)[:dolphin]
            wolf = zebra[lion]
            if wolf.size < 3:
                return np.nan
            bear = float(np.mean(wolf))
            tiger = wolf - bear
            cat = wolf.size
            panda = max(cat - 2, 1)
            giraffe = float(np.sum(tiger ** 2) / panda)
            if not np.isfinite(giraffe) or giraffe <= 0:
                return np.nan
            rabbit = float(np.sum(tiger ** 3) / max(cat - 1, 1) / giraffe ** 1.5)
            return rabbit if np.isfinite(rabbit) else np.nan
        whale = wolf.groupby('code', sort=False).apply(_skew_one)
        koala[lion] = whale
    if not koala:
        return _make_factor_series({}, date, universe=universe, name='factor830')
    hawk = pd.DataFrame(koala).T
    zebra = hawk.mean(axis=0, skipna=True).replace([np.inf, -np.inf], np.nan)
    rabbit = {cat: float(eagle) for cat, eagle in zebra.items() if np.isfinite(eagle)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor830')

def factor831(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor831')

def factor832(universe, date, freq='1m', chunk_size=250):
    _set_asof_date(date)
    tiger = _to_date(date)
    bear = tiger
    koala = tiger + dt.timedelta(days=1)
    panda = list(universe)
    fox = math.sqrt(2.0 / math.pi)
    otter = {}
    for dog in _fa__chunks(panda, chunk_size):
        lion = get_price(dog, start_date=bear, end_date=koala, frequency=freq, fields=['close'], fq='post', panel=False)
        lion = _fa__ensure_time_code(lion)
        if lion is None or lion.empty:
            continue
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values) & (lion['close'].values > 0)]
        if lion.empty:
            continue
        lion = lion.sort_values(['code', 'time'])

        def _one(g):
            cat = g['close'].values.astype(float)
            if cat.size < 3:
                return np.nan
            dog = np.diff(np.log(cat))
            if dog.size < 2:
                return np.nan
            panda = float(np.sum(np.abs(dog[1:]) * np.abs(dog[:-1])) / mu1 ** 2)
            return panda if np.isfinite(panda) else np.nan
        wolf = lion.groupby('code', sort=False).apply(_one)
        for cat, rabbit in wolf.items():
            if np.isfinite(rabbit):
                otter[cat] = float(rabbit)
    return _make_factor_series(otter, date, universe=universe, name='factor832')

def factor833(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    fox = 8
    zebra = get_history_fundamentals(security=universe, fields=[bear.term_063], watch_date=wolf, count=fox, interval='1q', stat_by_year=False)
    giraffe = get_history_fundamentals(security=universe, fields=[fox.term_081, fox.term_036, fox.good_will], watch_date=wolf, count=fox, interval='1q', stat_by_year=False)
    if zebra is None or zebra.empty or giraffe is None or giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor833')
    zebra['statDate'] = pd.to_datetime(zebra['statDate'])
    giraffe['statDate'] = pd.to_datetime(giraffe['statDate'])
    whale = {}
    for otter in universe:
        dolphin = zebra[zebra['code'] == otter].copy()
        bear = giraffe[giraffe['code'] == otter].copy()
        if dolphin.shape[0] < 5 or bear.shape[0] < 5:
            continue
        dolphin = dolphin.sort_values('statDate').drop_duplicates('statDate')
        bear = bear.sort_values('statDate').drop_duplicates('statDate')
        if dolphin.shape[0] < 5 or bear.shape[0] < 5:
            continue
        rabbit = pd.merge(dolphin[['statDate', 'term_063']], bear[['statDate', 'term_081', 'term_036', 'good_will']], on='statDate', how='inner')
        if rabbit.shape[0] < 5:
            continue
        rabbit = rabbit.sort_values('statDate')
        lizard = rabbit['term_063'].astype(float).values
        frog = rabbit['term_081'].astype(float).values
        hawk = rabbit['term_036'].astype(float).fillna(0.0).values
        eagle = rabbit['good_will'].astype(float).fillna(0.0).values
        turtle = len(lizard)
        if turtle < 5:
            continue
        owl = turtle - 1
        sparrow = turtle - 2
        if owl - 3 < 0 or sparrow - 3 < 0:
            continue
        dog = float(lizard[owl - 3:owl + 1].sum())
        cat = float(lizard[sparrow - 3:sparrow + 1].sum())
        koala = float(frog[owl] - hawk[owl] - eagle[owl])
        lion = float(frog[sparrow] - hawk[sparrow] - eagle[sparrow])
        if koala <= 0 or lion <= 0:
            continue
        tiger = dog / koala
        panda = cat / lion
        if not np.isfinite(panda) or panda == 0 or (not np.isfinite(tiger)):
            continue
        shark = (tiger - panda) / abs(panda)
        if np.isfinite(shark):
            whale[otter] = float(shark)
    return _make_factor_series(whale, date, universe=universe, name='factor833')

def factor834(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    lion = _to_date(date)
    eagle = lion
    wolf = lion + dt.timedelta(days=1)
    tiger = list(universe)
    fox = get_price(tiger, start_date=eagle, end_date=wolf, frequency='daily', fields=['low'], fq='post', panel=False)
    fox = _fa__ensure_time_code(fox)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor834')
    if 'code' not in fox.columns and len(tiger) == 1:
        fox['code'] = tiger[0]
    fox['low'] = pd.to_numeric(fox['low'], errors='coerce').astype(float)
    zebra = _fa__last_by_code(fox[['time', 'code', 'low']], 'low', time_col='time')
    whale = []
    for dog in _fa__chunks(tiger, chunk_size):
        koala = get_price(dog, start_date=eagle, end_date=wolf, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        koala = _fa__ensure_time_code(koala)
        if koala is None or koala.empty:
            continue
        if 'code' not in koala.columns:
            if len(dog) == 1:
                koala['code'] = dog[0]
            else:
                continue
        koala = koala[['code', 'close', 'volume']].copy()
        koala['close'] = pd.to_numeric(koala['close'], errors='coerce').astype(float)
        koala['volume'] = pd.to_numeric(koala['volume'], errors='coerce').astype(float)
        koala = koala[np.isfinite(koala['close'].values) & np.isfinite(koala['volume'].values)]
        if not koala.empty:
            whale.append(koala)
    if not whale:
        return _make_factor_series({}, date, universe=universe, name='factor834')
    otter = pd.concat(whale, ignore_index=True)
    rabbit = otter.groupby(['code', 'close'], sort=False)['volume'].sum().reset_index()
    rabbit = rabbit[np.isfinite(rabbit['volume'].values) & (rabbit['volume'].values > 0)]
    if rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor834')

    def _vsa_bounds(prices, vols):
        otter = float(np.sum(vols))
        if not (np.isfinite(otter) and otter > 0):
            return (np.nan, np.nan)
        dog = int(np.argmax(vols))
        lion = panda = dog
        cat = float(vols[dog])
        while cat < 0.5 * otter and (lion > 0 or panda < len(prices) - 1):
            tiger = lion - 1 if lion > 0 else None
            koala = panda + 1 if panda < len(prices) - 1 else None
            fox = float(vols[tiger]) if tiger is not None else -1.0
            wolf = float(vols[koala]) if koala is not None else -1.0
            if fox < 0 and wolf < 0:
                break
            if wolf < 0 or (fox >= wolf and fox >= 0):
                lion = tiger
                cat += fox
            else:
                panda = koala
                cat += wolf
        return (float(prices[lion]), float(prices[panda]))
    bear = {}
    for panda, giraffe in rabbit.groupby('code', sort=False):
        dolphin = float(zebra.get(panda, np.nan))
        if not np.isfinite(dolphin):
            continue
        giraffe = giraffe.sort_values('close')
        shark = giraffe['close'].values.astype(float)
        sparrow = giraffe['volume'].values.astype(float)
        if shark.size < 2:
            continue
        cat, owl = _vsa_bounds(shark, sparrow)
        if np.isfinite(owl):
            hawk = owl - dolphin
            if np.isfinite(hawk):
                bear[panda] = float(hawk)
    return _make_factor_series(bear, date, universe=universe, name='factor834')

def factor835(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    tiger = 8
    wolf = get_history_fundamentals(security=universe, fields=[bear.term_066], watch_date=lion, count=tiger, interval='1q', stat_by_year=False)
    fox = get_history_fundamentals(security=universe, fields=[fox.inventories], watch_date=lion, count=tiger, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor835')
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    rabbit = {}
    for panda in universe:
        bear = wolf[wolf['code'] == panda].copy()
        koala = fox[fox['code'] == panda].copy()
        if bear.shape[0] < 5 or koala.shape[0] < 5:
            continue
        bear = bear.sort_values('statDate').drop_duplicates('statDate')
        koala = koala.sort_values('statDate').drop_duplicates('statDate')
        if bear.shape[0] < 5 or koala.shape[0] < 5:
            continue
        otter = pd.merge(bear[['statDate', 'term_066']], koala[['statDate', 'inventories']], on='statDate', how='inner')
        if otter.shape[0] < 5:
            continue
        otter = otter.sort_values('statDate')
        whale = otter['term_066'].astype(float).values
        giraffe = otter['inventories'].astype(float).values
        if whale.size < 5 or giraffe.size < 5:
            continue
        shark = whale[-1]
        eagle = whale[-5]
        zebra = giraffe[-1]
        dolphin = giraffe[-5]
        if not np.isfinite(eagle) or eagle == 0 or (not np.isfinite(dolphin)) or (dolphin == 0):
            continue
        dog = (shark - eagle) / eagle
        cat = (zebra - dolphin) / dolphin
        hawk = dog - cat
        if np.isfinite(hawk):
            rabbit[panda] = float(hawk)
    return _make_factor_series(rabbit, date, universe=universe, name='factor835')

def factor836(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor836')

def factor837(universe, date, N1=5, N2=16, N3=17):
    _set_asof_date(date)
    koala = _to_date(date)
    shark = int(N1) + int(N2) + int(N3) + 5
    fox = _last_n_trade_days(koala, shark)
    if len(fox) < shark:
        return _make_factor_series({}, date, universe=universe, name='factor837')
    eagle = fox[0]
    giraffe = fox[-1]
    tiger = list(universe)
    bear = _r3_get_price_long(tiger, start_date=eagle, end_date=giraffe, frequency='daily', fields=['close'], fq='post', panel=False, batch_size=800)
    otter = pd.to_datetime([pd.to_datetime(lion).date() for lion in fox])
    panda = _r3_pivot_daily(bear, 'close', otter, tiger).astype(float)
    whale = panda.rolling(int(N1), min_periods=int(N1)).mean()
    with np.errstate(divide='ignore', invalid='ignore'):
        cat = (panda - whale) / whale
    rabbit = cat - cat.shift(int(N2))
    wolf = _r3_sma_2d(rabbit.values, int(N3), M=1)
    dolphin = pd.Series(wolf[-1, :], index=tiger)
    zebra = {dog: float(dolphin.get(dog)) if np.isfinite(dolphin.get(dog, np.nan)) else np.nan for dog in tiger}
    return _make_factor_series(zebra, date, universe=universe, name='factor837')

def factor838(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor838')

def factor839(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor839')

def factor840(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor840')

def factor841(universe, date, chunk_size=700):
    _set_asof_date(date)
    koala = _to_date(date)
    if koala.month == 1:
        salmon, lizard = (koala.year - 1, 12)
    else:
        salmon, lizard = (koala.year, koala.month - 1)
    lemur = dt.date(salmon, lizard, 1)
    sparrow = dt.date(salmon + (1 if lizard == 12 else 0), 1 if lizard == 12 else lizard + 1, 1)
    rabbit = sparrow - dt.timedelta(days=1)
    eagle = _fa__as_date_list(get_trade_days(start_date=lemur, end_date=rabbit))
    if len(eagle) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor841')
    zebra = eagle[0]
    frog = pd.to_datetime(get_trade_days(end_date=zebra, count=2)[0]).date()
    lion = list(universe)
    alpaca = frog
    bear = eagle[-1] + dt.timedelta(days=1)
    turtle = []
    for dog in _fa__chunks(lion, chunk_size):
        otter = get_price(dog, start_date=alpaca, end_date=bear, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
        otter = _fa__ensure_time_code(otter)
        if otter is None or otter.empty:
            continue
        if 'code' not in otter.columns:
            if len(dog) == 1:
                otter['code'] = dog[0]
            else:
                continue
        otter['date'] = otter['time'].dt.date
        otter = otter[['date', 'code', 'open', 'close']].copy()
        otter['open'] = pd.to_numeric(otter['open'], errors='coerce').astype(float)
        otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
        turtle.append(otter)
    if not turtle:
        return _make_factor_series({}, date, universe=universe, name='factor841')
    fox = pd.concat(turtle, ignore_index=True)
    fox = fox[fox['date'].isin([frog] + eagle)]
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor841')
    owl = fox.pivot(index='date', columns='code', values='open').reindex([frog] + eagle)
    panda = fox.pivot(index='date', columns='code', values='close').reindex([frog] + eagle)
    tiger = panda.shift(1)
    with np.errstate(divide='ignore', invalid='ignore'):
        tuna = owl / tiger - 1.0
    tuna = tuna.replace([np.inf, -np.inf], np.nan).reindex(eagle)
    hawk = tuna.mean(axis=1, skipna=True)
    wolf = tuna.sub(hawk, axis=0).abs()
    shark = wolf.mean(axis=0, skipna=True)
    ferret = wolf.std(axis=0, ddof=1, skipna=True).fillna(0.0)
    donkey = float(np.nanmean(ferret.values)) if np.isfinite(ferret.values).any() else np.nan
    if not np.isfinite(donkey):
        return _make_factor_series({}, date, universe=universe, name='factor841')
    whale = shark.reindex(lion)
    beaver = ferret.reindex(lion)
    badger = whale.copy()
    dolphin = np.isfinite(whale.values) & np.isfinite(beaver.values)
    gecko = badger.values.astype(float)
    camel = beaver.values.astype(float)
    gecko[dolphin & (camel < donkey)] = -gecko[dolphin & (camel < donkey)]
    badger = pd.Series(gecko, index=whale.index).replace([np.inf, -np.inf], np.nan)
    giraffe = {cat: float(hyena) for cat, hyena in badger.items() if np.isfinite(hyena)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor841')

def factor842(universe, date):
    _set_asof_date(date)
    salmon = _to_date(date)
    alpaca = get_history_fundamentals(security=universe, fields=[fox.term_082, fox.term_012, fox.term_083, fox.term_077, fox.term_079, fox.term_081], watch_date=salmon, count=2, interval='1q', stat_by_year=False)
    if alpaca is None or alpaca.empty:
        return _make_factor_series({}, date, universe=universe, name='factor842')
    alpaca['statDate'] = pd.to_datetime(alpaca['statDate'])
    lemur = {}
    for hawk in universe:
        tuna = alpaca[alpaca['code'] == hawk].copy()
        if tuna.shape[0] < 2:
            continue
        tuna = tuna.sort_values('statDate').tail(2)
        eagle, shark = (tuna.iloc[0], tuna.iloc[1])

        def f(row, col):
            try:
                cat = row[col]
            except KeyError:
                return 0.0
            return float(cat) if pd.notna(cat) else 0.0
        panda = f(eagle, 'term_082')
        dog = f(shark, 'term_082')
        otter = f(eagle, 'term_012')
        koala = f(shark, 'term_012')
        lion = f(eagle, 'term_083')
        tiger = f(shark, 'term_083')
        bear = f(eagle, 'term_077')
        wolf = f(shark, 'term_077')
        dolphin = f(eagle, 'term_079')
        zebra = f(shark, 'term_079')
        giraffe = f(eagle, 'term_081')
        rabbit = f(shark, 'term_081')
        fox = 0.0
        sparrow = dog - panda
        turtle = koala - otter
        owl = tiger - lion
        lizard = wolf - bear
        frog = zebra - dolphin
        cat = (rabbit + giraffe) / 2.0
        if cat <= 0 or not np.isfinite(cat):
            continue
        whale = (sparrow - turtle - (owl - lizard - frog) - fox) / cat
        if np.isfinite(whale):
            lemur[hawk] = float(whale)
    return _make_factor_series(lemur, date, universe=universe, name='factor842')

def factor843(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    fox = _to_date(date)
    hyena = dt.date(fox.year, fox.month, 1)
    salmon = dt.date(fox.year + (1 if fox.month == 12 else 0), 1 if fox.month == 12 else fox.month + 1, 1)
    zebra = salmon - dt.timedelta(days=1)
    owl = list(get_trade_days(start_date=hyena, end_date=zebra))
    if len(owl) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor843')
    iguana = min(len(owl), 15)
    jaguar = owl[4:iguana]
    if not jaguar:
        return _make_factor_series({}, date, universe=universe, name='factor843')
    whale = owl[0]
    alpaca = get_trade_days(end_date=whale, count=2)[0]
    eagle = list(get_trade_days(end_date=alpaca, count=20))
    if len(eagle) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor843')
    koala = list(universe)
    dog = None
    panda = None
    cat = None
    for wolf in eagle:
        gecko = wolf
        giraffe = wolf + dt.timedelta(days=1)
        tuna = []
        for hawk in range(0, len(koala), chunk_size):
            lion = koala[hawk:hawk + chunk_size]
            bear = get_price(lion, start_date=gecko, end_date=giraffe, frequency=freq, fields=['money'], fq='post', panel=False)
            if bear is None or bear.empty:
                continue
            bear = bear.copy()
            if 'time' not in bear.columns:
                bear = bear.reset_index()
            if 'code' not in bear.columns or 'money' not in bear.columns:
                continue
            tuna.append(bear[['time', 'code', 'money']])
        if not tuna:
            continue
        rabbit = pd.concat(tuna, ignore_index=True)
        rabbit['time'] = pd.to_datetime(rabbit['time'])
        rabbit['minute'] = rabbit['time'].dt.hour * 60 + rabbit['time'].dt.minute
        rabbit['money'] = pd.to_numeric(rabbit['money'], errors='coerce').astype(float)
        rabbit = rabbit[np.isfinite(rabbit['money'].values)]
        if rabbit.empty:
            continue
        rabbit['money_sq'] = rabbit['money'].values ** 2
        shark = rabbit.groupby(['code', 'minute'], sort=False)
        beaver = shark['money'].sum()
        camel = shark['money_sq'].sum()
        lemur = shark['money'].count()
        if dog is None:
            dog = beaver.copy()
            panda = camel.copy()
            cat = lemur.copy()
        else:
            dog = dog.add(beaver, fill_value=0.0)
            panda = panda.add(camel, fill_value=0.0)
            cat = cat.add(lemur, fill_value=0.0)
    if dog is None or cat is None:
        return _make_factor_series({}, date, universe=universe, name='factor843')
    cat = cat.replace(0, np.nan)
    turtle = dog / cat
    mole = (panda - dog ** 2 / cat) / (cat - 1.0)
    ferret = np.sqrt(mole)
    ferret = ferret.replace([np.inf, -np.inf], np.nan)
    ferret[ferret <= 0] = np.nan
    lizard = turtle.reset_index()
    lizard.columns = ['code', 'minute', 'mu']
    donkey = ferret.reset_index()
    donkey.columns = ['code', 'minute', 'sigma']
    frog = lizard.merge(donkey, on=['code', 'minute'], how='inner')
    if frog.empty:
        return _make_factor_series({}, date, universe=universe, name='factor843')
    otter = {}

    def _corr_absret_adj(g):
        dog = g['abs_ret'].values
        panda = g['adj_prev'].values
        cat = np.isfinite(dog) & np.isfinite(panda) & (dog > 0)
        if cat.sum() < 3:
            return np.nan
        dog = dog[cat]
        panda = panda[cat]
        if np.std(dog) <= 0 or np.std(panda) <= 0:
            return np.nan
        return float(np.corrcoef(dog, panda)[0, 1])
    for wolf in jaguar:
        gecko = wolf
        giraffe = wolf + dt.timedelta(days=1)
        tuna = []
        for hawk in range(0, len(koala), chunk_size):
            lion = koala[hawk:hawk + chunk_size]
            bear = get_price(lion, start_date=gecko, end_date=giraffe, frequency=freq, fields=['close', 'money'], fq='post', panel=False)
            if bear is None or bear.empty:
                continue
            bear = bear.copy()
            if 'time' not in bear.columns:
                bear = bear.reset_index()
            if 'code' not in bear.columns or 'close' not in bear.columns or 'money' not in bear.columns:
                continue
            tuna.append(bear[['time', 'code', 'close', 'money']])
        if not tuna:
            continue
        rabbit = pd.concat(tuna, ignore_index=True)
        rabbit['time'] = pd.to_datetime(rabbit['time'])
        rabbit['minute'] = rabbit['time'].dt.hour * 60 + rabbit['time'].dt.minute
        rabbit['close'] = pd.to_numeric(rabbit['close'], errors='coerce').astype(float)
        rabbit['money'] = pd.to_numeric(rabbit['money'], errors='coerce').astype(float)
        rabbit = rabbit.sort_values(['code', 'time'])
        rabbit['log_close'] = np.log(rabbit['close'].where(rabbit['close'] > 0))
        rabbit['ret'] = rabbit.groupby('code', sort=False)['log_close'].diff()
        rabbit['abs_ret'] = rabbit['ret'].abs()
        rabbit['money_prev'] = rabbit.groupby('code', sort=False)['money'].shift(1)
        rabbit['minute_prev'] = rabbit.groupby('code', sort=False)['minute'].shift(1)
        kangaroo = rabbit[['code', 'abs_ret', 'money_prev', 'minute_prev']].copy()
        kangaroo = kangaroo.rename(columns={'minute_prev': 'minute'})
        kangaroo = kangaroo.merge(frog, on=['code', 'minute'], how='left')
        with np.errstate(divide='ignore', invalid='ignore'):
            kangaroo['adj_prev'] = (kangaroo['money_prev'] - kangaroo['mu']) / kangaroo['sigma']
        kangaroo['adj_prev'] = kangaroo['adj_prev'].replace([np.inf, -np.inf], np.nan)
        badger = kangaroo.groupby('code', sort=False).apply(_corr_absret_adj)
        for tiger, llama in badger.items():
            if np.isfinite(llama):
                otter.setdefault(tiger, []).append(float(llama))
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor843')
    dolphin = {}
    for tiger, sparrow in otter.items():
        if sparrow:
            llama = float(np.mean(sparrow))
            if np.isfinite(llama):
                dolphin[tiger] = llama
    return _make_factor_series(dolphin, date, universe=universe, name='factor843')

def factor844(universe, date, chunk_size=600):
    _set_asof_date(date)
    fox = _to_date(date)
    frog = fox - dt.timedelta(days=365)
    panda = _fa__as_date_list(get_trade_days(start_date=frog, end_date=fox))
    if len(panda) < 40:
        return _make_factor_series({}, date, universe=universe, name='factor844')
    sparrow = 21
    if len(panda) <= sparrow:
        return _make_factor_series({}, date, universe=universe, name='factor844')
    wolf = panda[:-sparrow]
    if len(wolf) < 20:
        return _make_factor_series({}, date, universe=universe, name='factor844')
    otter = list(universe)
    lizard = panda[0]
    giraffe = fox + dt.timedelta(days=1)
    shark = []
    for lion in _fa__chunks(otter, chunk_size):
        bear = get_price(lion, start_date=lizard, end_date=giraffe, frequency='daily', fields=['close'], fq='post', panel=False)
        bear = _fa__ensure_time_code(bear)
        if bear is None or bear.empty:
            continue
        if 'code' not in bear.columns:
            if len(lion) == 1:
                bear['code'] = lion[0]
            else:
                continue
        bear['date'] = bear['time'].dt.date
        bear = bear[['date', 'code', 'close']].copy()
        bear['close'] = pd.to_numeric(bear['close'], errors='coerce').astype(float)
        bear = bear[np.isfinite(bear['close'].values) & (bear['close'].values > 0)]
        shark.append(bear)
    if not shark:
        return _make_factor_series({}, date, universe=universe, name='factor844')
    rabbit = pd.concat(shark, ignore_index=True)
    koala = rabbit.pivot(index='date', columns='code', values='close').sort_index()
    koala = koala.reindex(index=wolf + [wolf[-1] + dt.timedelta(days=1)]).iloc[:-1]
    koala = koala.reindex(wolf)
    owl = koala.pct_change().replace([np.inf, -np.inf], np.nan).iloc[1:]
    owl = owl.reindex(wolf[1:])
    zebra = {}
    for tiger in otter:
        if tiger not in owl.columns:
            continue
        hawk = owl[tiger].dropna().values.astype(float)
        if hawk.size < 10:
            continue
        dolphin = np.log1p(hawk)
        dolphin = dolphin[np.isfinite(dolphin)]
        if dolphin.size < 10:
            continue
        dog = float(np.expm1(np.sum(dolphin)))
        if dog > 0:
            turtle = 1.0
        elif dog < 0:
            turtle = -1.0
        else:
            turtle = 0.0
        whale = float(np.mean(hawk < 0))
        eagle = float(np.mean(hawk > 0))
        cat = turtle * (whale - eagle)
        if np.isfinite(cat):
            zebra[tiger] = float(cat)
    return _make_factor_series(zebra, date, universe=universe, name='factor844')

def factor845(universe, date, freq='1m', smooth_window=1, chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    otter = _last_n_trade_days(tiger, smooth_window)
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor845')
    eagle = 2.0 / 3.0
    whale = 2.0 ** (eagle / 2.0) * math.gamma((eagle + 1.0) / 2.0) / math.sqrt(math.pi)
    panda = list(universe)
    koala = {}
    for lion in otter:
        sparrow = lion
        rabbit = lion + dt.timedelta(days=1)
        shark = []
        for zebra in range(0, len(panda), chunk_size):
            dog = panda[zebra:zebra + chunk_size]
            fox = get_price(dog, start_date=sparrow, end_date=rabbit, frequency=freq, fields=['close'], fq='post', panel=False)
            if fox is None or fox.empty:
                continue
            fox = fox.copy()
            if 'time' not in fox.columns:
                fox = fox.reset_index()
            if 'code' not in fox.columns or 'close' not in fox.columns:
                continue
            shark.append(fox[['time', 'code', 'close']])
        if not shark:
            continue
        wolf = pd.concat(shark, ignore_index=True)
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf = wolf.sort_values(['code', 'time'])

        def _one(g):
            panda = g['close'].values
            tiger = np.isfinite(panda) & (panda > 0)
            if tiger.sum() < 5:
                return np.nan
            panda = panda[tiger]
            lion = np.diff(np.log(panda))
            if lion.size < 3:
                return np.nan
            koala = np.abs(lion) ** q
            dog = float(np.sum(koala[2:] * koala[1:-1] * koala[:-2]))
            cat = dog / mu_q ** 3
            return cat if np.isfinite(cat) else np.nan
        hawk = wolf.groupby('code', sort=False).apply(_one)
        koala[lion] = hawk
    if not koala:
        return _make_factor_series({}, date, universe=universe, name='factor845')
    bear = pd.DataFrame(koala).T
    dolphin = bear.mean(axis=0, skipna=True).replace([np.inf, -np.inf], np.nan)
    giraffe = {cat: float(owl) for cat, owl in dolphin.items() if np.isfinite(owl)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor845')

def factor846(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor846')

def factor847(universe, date, index_symbol='000905.XSHG'):
    _set_asof_date(date)
    koala = _to_date(date)
    if koala.month == 1:
        sparrow = koala.year - 1
        hawk = 12
    else:
        sparrow = koala.year
        hawk = koala.month - 1
    salmon = dt.date(sparrow, hawk, 1)
    if hawk == 12:
        eagle = dt.date(sparrow + 1, 1, 1)
    else:
        eagle = dt.date(sparrow, hawk + 1, 1)
    wolf = eagle - dt.timedelta(days=1)
    shark = list(get_trade_days(start_date=salmon, end_date=wolf))
    if len(shark) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor847')
    otter = shark[-20:] if len(shark) > 20 else shark
    frog = otter[0]
    fox = otter[-1]
    zebra = _get_daily_close_series(index_symbol, frog, fox)
    dolphin = zebra.pct_change().reindex(otter).dropna()
    lemur = {tiger: [] for tiger in universe}
    for tiger in universe:
        panda = _get_daily_close_series(tiger, frog, fox)
        owl = panda.pct_change().reindex(otter).dropna()
        lion = dolphin.index.intersection(owl.index)
        if len(lion) < 5:
            continue
        turtle = owl.reindex(lion).values
        lizard = dolphin.reindex(lion).values
        rabbit = np.abs(turtle - lizard) / (np.abs(turtle) + np.abs(lizard) + 0.1)
        alpaca = rabbit * turtle
        lemur[tiger] = list(alpaca)
    bear = {}
    for tiger, giraffe in lemur.items():
        if len(giraffe) == 0:
            continue
        dog = np.asarray(giraffe, dtype=float)
        whale = float(dog.mean())
        tuna = float(dog.std(ddof=1)) if dog.size > 1 else 0.0
        cat = 0.5 * (whale + tuna)
        if np.isfinite(cat):
            bear[tiger] = float(cat)
    return _make_factor_series(bear, date, universe=universe, name='factor847')

def factor848(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor848')

def factor849(universe, date, index_symbol='000905.XSHG', K=250):
    _set_asof_date(date)
    try:
        koala = _to_date(date)
    except Exception:
        wolf = {dog: np.nan for dog in universe}
        return _make_factor_series(wolf, date, universe=universe, name='factor849')
    otter = _last_n_trade_days(koala, int(K) + 1)
    if len(otter) < 30:
        return _make_factor_series({}, date, universe=universe, name='factor849')
    whale = otter[0]
    fox = otter[-1]
    bear = _get_daily_close_series(index_symbol, whale, fox)
    if bear is None or getattr(bear, 'empty', True):
        bear = _get_daily_close_series(cat, whale, fox)
    rabbit = bear.pct_change().dropna()
    if rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor849')
    wolf = {}
    for panda in universe:
        dog = _get_daily_close_series(panda, whale, fox)
        if dog is None or dog.empty:
            continue
        giraffe = dog.pct_change().dropna()
        tiger = rabbit.index.intersection(giraffe.index)
        if len(tiger) < 30:
            continue
        dolphin = rabbit.reindex(tiger).values.astype(float)
        zebra = giraffe.reindex(tiger).values.astype(float)
        if np.std(dolphin) == 0:
            continue
        lion = np.cov(zebra, dolphin, ddof=1)
        shark = lion[1, 1]
        if shark <= 0 or not np.isfinite(shark):
            continue
        cat = lion[0, 1] / shark
        if np.isfinite(cat):
            wolf[panda] = float(cat)
    return _make_factor_series(wolf, date, universe=universe, name='factor849')

def factor850(universe, date, index_symbol='000905.XSHG', freq='5m'):
    _set_asof_date(date)
    panda = _to_date(date)
    bear = _get_intraday_close_series(index_symbol, panda, freq=freq)
    bear = bear.sort_index()
    if bear.size < 2:
        return _make_factor_series({}, date, universe=universe, name='factor850')
    koala = bear.pct_change().dropna()
    wolf = {}
    for dog in universe:
        cat = _get_intraday_close_series(dog, panda, freq=freq)
        cat = cat.sort_index()
        if cat.size < 2:
            continue
        giraffe = cat.pct_change().dropna()
        lion = pd.DataFrame({'r': giraffe, 'f': koala}).dropna()
        if lion.shape[0] < 3:
            continue
        zebra = lion['r'].values
        otter = lion['f'].values
        dolphin = np.maximum(zebra, 0.0)
        fox = np.minimum(otter, 0.0)
        tiger = np.sum(fox ** 2)
        if tiger <= 0:
            continue
        rabbit = np.sum(dolphin * fox)
        whale = -rabbit / tiger
        if np.isfinite(whale):
            wolf[dog] = float(whale)
    return _make_factor_series(wolf, date, universe=universe, name='factor850')

def factor851(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    lion = _to_date(date)
    zebra = _get_month_end_trade_day(lion)
    otter = _last_n_trade_days(zebra, 20)
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor851')
    panda = list(universe)
    owl = {}
    whale = {}

    def _corr_mask(curr, nxt, mask):
        if mask.sum() < 2:
            return np.nan
        cat = curr[mask]
        dog = nxt[mask]
        if np.std(cat) <= 0 or np.std(dog) <= 0:
            return np.nan
        return float(np.corrcoef(cat, dog)[0, 1])
    for koala in otter:
        lizard = koala
        bear = koala + dt.timedelta(days=1)
        hawk = []
        for giraffe in range(0, len(panda), chunk_size):
            dog = panda[giraffe:giraffe + chunk_size]
            fox = get_price(dog, start_date=lizard, end_date=bear, frequency=freq, fields=['close'], fq='post', panel=False)
            if fox is None or fox.empty:
                continue
            fox = fox.copy()
            if 'time' not in fox.columns:
                fox = fox.reset_index()
            if 'code' not in fox.columns or 'close' not in fox.columns:
                continue
            hawk.append(fox[['time', 'code', 'close']])
        if not hawk:
            continue
        wolf = pd.concat(hawk, ignore_index=True)
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf = wolf.sort_values(['code', 'time'])

        def _one(g):
            cat = g['close'].values
            tiger = np.isfinite(cat)
            if tiger.sum() < 4:
                return (np.nan, np.nan)
            cat = cat[tiger]
            panda = np.diff(cat)
            if panda.size < 3:
                return (np.nan, np.nan)
            dog = panda[:-1]
            lion = panda[1:]
            otter = _corr_mask(dog, lion, (dog > 0) & (lion > 0))
            koala = _corr_mask(dog, lion, (dog < 0) & (lion < 0))
            return (otter, koala)
        eagle = wolf.groupby('code', sort=False).apply(_one)
        owl[koala] = eagle.apply(lambda x: x[0])
        whale[koala] = eagle.apply(lambda x: x[1])
    if not owl or not whale:
        return _make_factor_series({}, date, universe=universe, name='factor851')
    turtle = pd.DataFrame(owl).T
    shark = pd.DataFrame(whale).T
    sparrow = turtle.mean(axis=0, skipna=True)
    dolphin = shark.mean(axis=0, skipna=True)
    tiger = sparrow.index.intersection(dolphin.index)
    if len(tiger) < 1:
        return _make_factor_series({}, date, universe=universe, name='factor851')
    alpaca = _zscore_series(sparrow.reindex(tiger))
    tuna = _zscore_series(dolphin.reindex(tiger))
    salmon = alpaca.add(tuna, fill_value=np.nan).replace([np.inf, -np.inf], np.nan)
    rabbit = {cat: float(frog) for cat, frog in salmon.items() if np.isfinite(frog)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor851')

def factor852(universe, date):
    _set_asof_date(date)
    turkey = _to_date(date)
    hyena = 2
    vulture = get_history_fundamentals(security=universe, fields=[fox.term_082, fox.term_012, fox.term_083, fox.term_077, fox.term_079, fox.term_081, fox.term_001, fox.term_025], watch_date=turkey, count=hyena, interval='1q', stat_by_year=False)
    walrus = get_history_fundamentals(security=universe, fields=[bear.term_066], watch_date=turkey, count=hyena, interval='1q', stat_by_year=False)
    if vulture is None or vulture.empty or walrus is None or walrus.empty:
        return _make_factor_series({}, date, universe=universe, name='factor852')
    vulture['statDate'] = pd.to_datetime(vulture['statDate'])
    walrus['statDate'] = pd.to_datetime(walrus['statDate'])
    seal = {}
    for ferret in universe:
        urchin = vulture[vulture['code'] == ferret].copy()
        yak = walrus[walrus['code'] == ferret].copy()
        if urchin.shape[0] < 2 or yak.shape[0] < 2:
            continue
        urchin = urchin.sort_values('statDate').drop_duplicates('statDate').tail(2)
        yak = yak.sort_values('statDate').drop_duplicates('statDate').tail(2)
        if urchin.shape[0] < 2 or yak.shape[0] < 2:
            continue
        beaver, badger = (urchin.iloc[0], urchin.iloc[1])
        crab, bee = (yak.iloc[0], yak.iloc[1])
        fox = 0.0

        def f(row, col):
            try:
                cat = row[col]
            except KeyError:
                return 0.0
            return float(cat) if pd.notna(cat) else 0.0
        dog = f(beaver, 'term_082')
        cat = f(badger, 'term_082')
        koala = f(beaver, 'term_012')
        lion = f(badger, 'term_012')
        tiger = f(beaver, 'term_083')
        panda = f(badger, 'term_083')
        shark = f(beaver, 'term_077')
        whale = f(badger, 'term_077')
        lizard = f(beaver, 'term_079')
        turtle = f(badger, 'term_079')
        hawk = f(beaver, 'term_081')
        eagle = f(badger, 'term_081')
        jaguar = cat - dog
        llama = lion - koala
        kangaroo = panda - tiger
        quail = whale - shark
        raccoon = turtle - lizard
        sparrow = jaguar - llama - (kangaroo - quail - raccoon) - fox
        if hawk <= 0 or not np.isfinite(hawk):
            continue
        owl = sparrow / hawk
        dolphin = f(crab, 'term_066')
        zebra = f(bee, 'term_066')
        narwhal = zebra - dolphin
        giraffe = f(beaver, 'term_001')
        rabbit = f(badger, 'term_001')
        mole = rabbit - giraffe
        bear = f(badger, 'term_025')
        deer = 1.0 / hawk
        penguin = narwhal / hawk
        octopus = (narwhal - mole) / hawk
        elk = bear / hawk
        if not all(np.isfinite([owl, deer, penguin, octopus, elk])):
            continue
        seal[ferret] = {'TAcc': owl, 'invA': deer, 'dREV_overA': penguin, 'dREV_minus_dREC_overA': octopus, 'ppe_overA': elk}
    if not seal:
        return _make_factor_series({}, date, universe=universe, name='factor852')
    gecko = list(seal.keys())
    mouse = np.array([seal[donkey]['TAcc'] for donkey in gecko], dtype=float)
    goat = np.array([seal[donkey]['invA'] for donkey in gecko], dtype=float)
    horse = np.array([seal[donkey]['dREV_overA'] for donkey in gecko], dtype=float)
    mink = np.array([seal[donkey]['ppe_overA'] for donkey in gecko], dtype=float)
    frog = np.column_stack([goat, horse, mink])
    if frog.shape[0] < 4:
        return _make_factor_series({}, date, universe=universe, name='factor852')
    camel, salmon, salmon, salmon = np.linalg.lstsq(frog, mouse, rcond=None)
    tuna, alpaca, lemur = camel
    ant = {}
    for donkey in gecko:
        iguana = seal[donkey]
        wolf = tuna * iguana['invA'] + alpaca * iguana['dREV_minus_dREC_overA'] + lemur * iguana['ppe_overA']
        otter = iguana['TAcc'] - wolf
        if np.isfinite(otter):
            ant[donkey] = float(otter)
    return _make_factor_series(ant, date, universe=universe, name='factor852')

def factor853(universe, date, T=20, chunk_size=800):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = _fa__as_date_list(_last_n_trade_days(fox, int(T)))
    if not wolf:
        return _make_factor_series({}, date, universe=universe, name='factor853')
    otter = list(universe)
    badger = wolf[0]
    zebra = wolf[-1] + dt.timedelta(days=1)
    beaver = badger.strftime('%Y-%m-%d')
    dolphin = wolf[-1].strftime('%Y-%m-%d')
    alpaca = []
    for tiger in _fa__chunks(otter, chunk_size):
        bear = get_price(tiger, start_date=badger, end_date=zebra, frequency='daily', fields=['money', 'close', 'high_limit', 'low_limit'], fq='post', panel=False)
        bear = _fa__ensure_time_code(bear)
        if bear is None or bear.empty:
            continue
        if 'code' not in bear.columns:
            if len(tiger) == 1:
                bear['code'] = tiger[0]
            else:
                continue
        bear['date'] = bear['time'].dt.date
        bear = bear[['date', 'code', 'money', 'close', 'high_limit', 'low_limit']].copy()
        for panda in ['money', 'close', 'high_limit', 'low_limit']:
            bear[panda] = pd.to_numeric(bear[panda], errors='coerce').astype(float)
        bear = bear[bear['date'].isin(wolf)]
        alpaca.append(bear)
    if not alpaca:
        return _make_factor_series({}, date, universe=universe, name='factor853')
    giraffe = pd.concat(alpaca, ignore_index=True)
    salmon = giraffe.pivot(index='date', columns='code', values='money').reindex(wolf)
    koala = giraffe.pivot(index='date', columns='code', values='close').reindex(wolf)
    eagle = giraffe.pivot(index='date', columns='code', values='high_limit').reindex(wolf)
    sparrow = giraffe.pivot(index='date', columns='code', values='low_limit').reindex(wolf)
    rabbit = get_money_flow_pro(security_list=otter, start_date=beaver, end_date=dolphin, frequency='daily', fields=['inflow_s', 'inflow_m', 'inflow_l', 'inflow_xl'], data_type='money')
    rabbit = _fa__ensure_time_code(rabbit)
    if rabbit is None or rabbit.empty or 'code' not in rabbit.columns:
        return _make_factor_series({}, date, universe=universe, name='factor853')
    rabbit['date'] = pd.to_datetime(rabbit['time']).dt.date
    rabbit = rabbit[rabbit['date'].isin(wolf)]
    for panda in ['inflow_s', 'inflow_m', 'inflow_l', 'inflow_xl']:
        rabbit[panda] = pd.to_numeric(rabbit.get(panda, 0.0), errors='coerce').astype(float).fillna(0.0)
    rabbit['buy'] = rabbit[['inflow_s', 'inflow_m', 'inflow_l', 'inflow_xl']].sum(axis=1, skipna=True)
    dog = rabbit.pivot(index='date', columns='code', values='buy').reindex(wolf)
    whale = {}
    for panda in otter:
        if panda not in salmon.columns or panda not in dog.columns:
            continue
        frog = salmon[panda].values.astype(float)
        cat = dog[panda].values.astype(float)
        lion = koala[panda].values.astype(float) if panda in koala.columns else np.full_like(frog, np.nan)
        shark = eagle[panda].values.astype(float) if panda in eagle.columns else np.full_like(frog, np.nan)
        hawk = sparrow[panda].values.astype(float) if panda in sparrow.columns else np.full_like(frog, np.nan)
        tuna = np.ones_like(frog, dtype=bool)
        turtle = np.isfinite(shark) & np.isfinite(lion)
        lizard = np.isfinite(hawk) & np.isfinite(lion)
        tuna[turtle] &= lion[turtle] != shark[turtle]
        tuna[lizard] &= lion[lizard] != hawk[lizard]
        owl = np.isfinite(frog) & (frog > 0) & np.isfinite(cat) & tuna
        if int(owl.sum()) == 0:
            continue
        lemur = cat[owl] / frog[owl]
        lemur = lemur[np.isfinite(lemur)]
        if lemur.size == 0:
            continue
        whale[panda] = float(np.mean(lemur))
    return _make_factor_series(whale, date, universe=universe, name='factor853')

def factor854(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    koala = _to_date(date)
    shark = koala
    bear = koala + dt.timedelta(days=1)
    lion = list(universe)
    wolf = get_price(lion, start_date=shark, end_date=bear, frequency='daily', fields=['close'], fq='post', panel=False)
    wolf = _fa__ensure_time_code(wolf)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor854')
    if 'code' not in wolf.columns and len(lion) == 1:
        wolf['code'] = lion[0]
    wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
    dog = _fa__last_by_code(wolf[['time', 'code', 'close']], 'close', time_col='time')
    dolphin = []
    for cat in _fa__chunks(lion, chunk_size):
        otter = get_price(cat, start_date=shark, end_date=bear, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        otter = _fa__ensure_time_code(otter)
        if otter is None or otter.empty:
            continue
        if 'code' not in otter.columns:
            if len(cat) == 1:
                otter['code'] = cat[0]
            else:
                continue
        otter = otter[['code', 'close', 'volume']].copy()
        otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
        otter['volume'] = pd.to_numeric(otter['volume'], errors='coerce').astype(float)
        otter = otter[np.isfinite(otter['close'].values) & np.isfinite(otter['volume'].values)]
        if not otter.empty:
            dolphin.append(otter)
    if not dolphin:
        return _make_factor_series({}, date, universe=universe, name='factor854')
    fox = pd.concat(dolphin, ignore_index=True)
    giraffe = fox.groupby(['code', 'close'], sort=False)['volume'].sum().reset_index()
    giraffe = giraffe[np.isfinite(giraffe['volume'].values) & (giraffe['volume'].values > 0)]
    if giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor854')

    def _vsa_low(prices, vols):
        otter = float(np.sum(vols))
        if not (np.isfinite(otter) and otter > 0):
            return np.nan
        dog = int(np.argmax(vols))
        lion = panda = dog
        cat = float(vols[dog])
        while cat < 0.5 * otter and (lion > 0 or panda < len(prices) - 1):
            tiger = lion - 1 if lion > 0 else None
            koala = panda + 1 if panda < len(prices) - 1 else None
            fox = float(vols[tiger]) if tiger is not None else -1.0
            wolf = float(vols[koala]) if koala is not None else -1.0
            if fox < 0 and wolf < 0:
                break
            if wolf < 0 or (fox >= wolf and fox >= 0):
                lion = tiger
                cat += fox
            else:
                panda = koala
                cat += wolf
        return float(prices[lion])
    rabbit = {}
    for tiger, zebra in giraffe.groupby('code', sort=False):
        panda = float(dog.get(tiger, np.nan))
        if not np.isfinite(panda):
            continue
        zebra = zebra.sort_values('close')
        whale = zebra['close'].values.astype(float)
        hawk = zebra['volume'].values.astype(float)
        if whale.size < 2:
            continue
        sparrow = _vsa_low(whale, hawk)
        if np.isfinite(sparrow):
            eagle = sparrow - panda
            if np.isfinite(eagle):
                rabbit[tiger] = float(eagle)
    return _make_factor_series(rabbit, date, universe=universe, name='factor854')

def factor855(universe, date, index_symbol='000905.XSHG', K=250):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, K + 1)
    if len(otter) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor855')
    sparrow = otter[0]
    fox = otter[-1]
    bear = _get_daily_close_series(index_symbol, sparrow, fox)
    if bear is None or bear.size < 2:
        return _make_factor_series({}, date, universe=universe, name='factor855')
    rabbit = bear.pct_change().dropna()
    if rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor855')
    wolf = {}
    for panda in universe:
        dog = _get_daily_close_series(panda, sparrow, fox)
        if dog is None or dog.size < 2:
            continue
        dolphin = dog.pct_change().dropna()
        if dolphin.empty:
            continue
        tiger = rabbit.index.intersection(dolphin.index)
        if len(tiger) < 30:
            continue
        eagle = rabbit.reindex(tiger).values
        whale = dolphin.reindex(tiger).values
        zebra = float(eagle.mean())
        giraffe = eagle < zebra
        if giraffe.sum() < 5:
            continue
        hawk = eagle[giraffe]
        shark = whale[giraffe]
        if np.std(hawk, ddof=1) == 0:
            continue
        lion = np.cov(shark, hawk, ddof=1)
        owl = lion[1, 1]
        if owl <= 0:
            continue
        cat = lion[0, 1] / owl
        if np.isfinite(cat):
            wolf[panda] = float(cat)
    return _make_factor_series(wolf, date, universe=universe, name='factor855')

def factor856(universe, date, index_symbol='000905.XSHG', freq='1m', chunk_size=250):
    _set_asof_date(date)
    otter = _to_date(date)
    lion = list(universe)
    if not lion:
        return _make_factor_series({}, otter, universe=universe, name='factor856')
    if index_symbol == 'market':
        index_symbol = '000905.XSHG'
    if otter.month == 1:
        beaver, tuna = (otter.year - 1, 12)
    else:
        beaver, tuna = (otter.year, otter.month - 1)
    iguana = dt.date(beaver, tuna, 1)
    salmon = dt.date(beaver + (1 if tuna == 12 else 0), 1 if tuna == 12 else tuna + 1, 1)
    whale = salmon - dt.timedelta(days=1)
    lizard = list(get_trade_days(start_date=iguana, end_date=whale))
    if not lizard:
        return _make_factor_series({cat: np.nan for cat in lion}, otter, universe=universe, name='factor856')
    turtle = [pd.to_datetime(koala).date() for koala in lizard]
    wolf = turtle[-20:] if len(turtle) > 20 else turtle
    if len(wolf) < 2:
        return _make_factor_series({cat: np.nan for cat in lion}, otter, universe=universe, name='factor856')
    hawk = wolf[0]
    alpaca = list(get_trade_days(end_date=hawk, count=2))
    if len(alpaca) < 2:
        return _make_factor_series({cat: np.nan for cat in lion}, otter, universe=universe, name='factor856')
    lemur = pd.to_datetime(alpaca[0]).date()

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]

    def _ensure_daily_date(df: pd.DataFrame):
        if df is None or df.empty:
            return None
        cat = df.copy()
        if 'code' not in cat.columns:
            return None
        if 'date' in cat.columns:
            cat['d'] = pd.to_datetime(cat['date'], errors='coerce').dt.date
        elif 'time' in cat.columns:
            cat['d'] = pd.to_datetime(cat['time'], errors='coerce').dt.date
        else:
            cat['d'] = pd.to_datetime(cat.index, errors='coerce').date
        cat = cat.dropna(subset=['d', 'code'])
        if cat.empty:
            return None
        cat['code'] = cat['code'].astype(str)
        cat['close'] = pd.to_numeric(cat['close'], errors='coerce').astype(float)
        return cat[['d', 'code', 'close']]

    def _ensure_index_daily(df: pd.DataFrame, code: str):
        if df is None or df.empty:
            return None
        cat = df.copy()
        if 'code' not in cat.columns:
            cat['code'] = code
        if 'date' in cat.columns:
            cat['d'] = pd.to_datetime(cat['date'], errors='coerce').dt.date
        elif 'time' in cat.columns:
            cat['d'] = pd.to_datetime(cat['time'], errors='coerce').dt.date
        else:
            cat['d'] = pd.to_datetime(cat.index, errors='coerce').date
        cat = cat.dropna(subset=['d', 'code'])
        if cat.empty:
            return None
        cat['code'] = cat['code'].astype(str)
        cat['close'] = pd.to_numeric(cat['close'], errors='coerce').astype(float)
        return cat[['d', 'code', 'close']]

    def _ensure_1m_time(df: pd.DataFrame, chunk):
        if df is None or df.empty:
            return None
        cat = df.copy()
        if 'code' not in cat.columns:
            if len(chunk) == 1:
                cat['code'] = chunk[0]
            else:
                return None
        if 'time' in cat.columns:
            cat['time'] = pd.to_datetime(cat['time'], errors='coerce')
        elif 'date' in cat.columns:
            cat['time'] = pd.to_datetime(cat['date'], errors='coerce')
        else:
            cat = cat.reset_index()
            if 'time' in cat.columns:
                cat['time'] = pd.to_datetime(cat['time'], errors='coerce')
            elif 'date' in cat.columns:
                cat['time'] = pd.to_datetime(cat['date'], errors='coerce')
            else:
                return None
        cat = cat.dropna(subset=['time', 'code'])
        if cat.empty:
            return None
        cat['code'] = cat['code'].astype(str)
        cat['close'] = pd.to_numeric(cat['close'], errors='coerce').astype(float)
        cat = cat[np.isfinite(cat['close'].values) & (cat['close'].values > 0)]
        if cat.empty:
            return None
        cat['d'] = cat['time'].dt.date
        return cat[['d', 'code', 'time', 'close']]
    hyena = pd.Timestamp(lemur).strftime('%Y-%m-%d')
    dolphin = pd.Timestamp(wolf[-1]).strftime('%Y-%m-%d')
    rabbit = get_price(index_symbol, start_date=hyena, end_date=dolphin, frequency='daily', fields=['close'], fq='post', panel=False)
    rabbit = _ensure_index_daily(rabbit, code=index_symbol)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({cat: np.nan for cat in lion}, otter, universe=universe, name='factor856')
    sparrow = rabbit.groupby('d', sort=True)['close'].last().reindex(pd.Index([lemur] + wolf, name='d'))
    owl = sparrow.pct_change().replace([np.inf, -np.inf], np.nan).reindex(pd.Index(wolf, name='d'))
    badger = []
    for dog in _chunks(lion, max(1, chunk_size * 2)):
        bear = get_price(dog, start_date=hyena, end_date=dolphin, frequency='daily', fields=['close'], fq='post', panel=False)
        bear = _ensure_daily_date(bear)
        if bear is None or bear.empty:
            continue
        badger.append(bear)
    if not badger:
        return _make_factor_series({cat: np.nan for cat in lion}, otter, universe=universe, name='factor856')
    giraffe = pd.concat(badger, ignore_index=True)
    giraffe = giraffe.sort_values(['d', 'code'])
    giraffe = giraffe.groupby(['d', 'code'], sort=True)['close'].last().reset_index()
    panda = giraffe.pivot(index='d', columns='code', values='close').reindex(pd.Index([lemur] + wolf, name='d'))
    camel = panda.pct_change().replace([np.inf, -np.inf], np.nan).reindex(pd.Index(wolf, name='d'))
    gecko = f'{wolf[0]} 09:00:00'
    zebra = f'{wolf[-1]} 15:10:00'
    fox = set(wolf)
    mole = []
    for dog in _chunks(lion, max(1, chunk_size)):
        bear = get_price(dog, start_date=gecko, end_date=zebra, frequency=freq, fields=['close'], fq='post', panel=False)
        bear = _ensure_1m_time(bear, dog)
        if bear is None or bear.empty:
            continue
        bear = bear[bear['d'].isin(fox)]
        if bear.empty:
            continue
        bear = bear.sort_values(['code', 'd', 'time'])
        bear['logc'] = np.log(bear['close'].values)
        bear['r'] = bear.groupby(['code', 'd'], sort=False)['logc'].diff()
        bear = bear[np.isfinite(bear['r'].values)]
        if bear.empty:
            continue
        jaguar = bear.groupby(['d', 'code'], sort=False)['r'].std(ddof=1)
        mole.append(jaguar)
    if not mole:
        return _make_factor_series({cat: np.nan for cat in lion}, otter, universe=universe, name='factor856')
    narwhal = pd.concat(mole).groupby(level=[0, 1]).last()
    llama = narwhal.unstack('code').reindex(pd.Index(wolf, name='d')).reindex(columns=lion)
    donkey = owl.reindex(camel.index).astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = camel.sub(donkey, axis=0).abs() / (camel.abs().add(donkey.abs(), axis=0) + 0.1)
    eagle = eagle.replace([np.inf, -np.inf], np.nan)
    octopus = eagle * camel * llama
    tiger = octopus.notna().sum(axis=0)
    frog = octopus.mean(axis=0, skipna=True)
    ferret = octopus.std(axis=0, ddof=1)
    ferret = ferret.where(tiger >= 2, 0.0)
    ferret = ferret.where(tiger >= 1, np.nan)
    kangaroo = 0.5 * (frog + ferret)
    kangaroo = kangaroo.where(tiger >= 1, np.nan).reindex(lion)
    shark = {cat: float(kangaroo.get(cat)) if np.isfinite(kangaroo.get(cat, np.nan)) else np.nan for cat in lion}
    return _make_factor_series(shark, otter, universe=universe, name='factor856')

def factor857(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    lion = _to_date(date)
    zebra = _get_month_end_trade_day(lion)
    otter = _last_n_trade_days(zebra, 20)
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor857')
    panda = list(universe)
    owl = {}
    whale = {}

    def _corr_mask(curr, nxt, mask):
        if mask.sum() < 2:
            return np.nan
        cat = curr[mask]
        dog = nxt[mask]
        if np.std(cat) <= 0 or np.std(dog) <= 0:
            return np.nan
        return float(np.corrcoef(cat, dog)[0, 1])
    for koala in otter:
        lizard = koala
        bear = koala + dt.timedelta(days=1)
        hawk = []
        for giraffe in range(0, len(panda), chunk_size):
            dog = panda[giraffe:giraffe + chunk_size]
            fox = get_price(dog, start_date=lizard, end_date=bear, frequency=freq, fields=['volume'], fq='post', panel=False)
            if fox is None or fox.empty:
                continue
            fox = fox.copy()
            if 'time' not in fox.columns:
                fox = fox.reset_index()
            if 'code' not in fox.columns or 'volume' not in fox.columns:
                continue
            hawk.append(fox[['time', 'code', 'volume']])
        if not hawk:
            continue
        wolf = pd.concat(hawk, ignore_index=True)
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['volume'] = pd.to_numeric(wolf['volume'], errors='coerce').astype(float)
        wolf = wolf.sort_values(['code', 'time'])

        def _one(g):
            otter = g['volume'].values
            panda = np.isfinite(otter)
            if panda.sum() < 4:
                return (np.nan, np.nan)
            otter = otter[panda]
            dog = np.diff(otter)
            if dog.size < 3:
                return (np.nan, np.nan)
            cat = dog[:-1]
            tiger = dog[1:]
            koala = _corr_mask(cat, tiger, (cat > 0) & (tiger > 0))
            lion = _corr_mask(cat, tiger, (cat < 0) & (tiger < 0))
            return (koala, lion)
        eagle = wolf.groupby('code', sort=False).apply(_one)
        owl[koala] = eagle.apply(lambda x: x[0])
        whale[koala] = eagle.apply(lambda x: x[1])
    if not owl or not whale:
        return _make_factor_series({}, date, universe=universe, name='factor857')
    turtle = pd.DataFrame(owl).T
    shark = pd.DataFrame(whale).T
    sparrow = turtle.mean(axis=0, skipna=True)
    dolphin = shark.mean(axis=0, skipna=True)
    tiger = sparrow.index.intersection(dolphin.index)
    if len(tiger) < 1:
        return _make_factor_series({}, date, universe=universe, name='factor857')
    alpaca = _zscore_series(sparrow.reindex(tiger))
    tuna = _zscore_series(dolphin.reindex(tiger))
    salmon = alpaca.add(tuna, fill_value=np.nan).replace([np.inf, -np.inf], np.nan)
    rabbit = {cat: float(frog) for cat, frog in salmon.items() if np.isfinite(frog)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor857')

def factor858(universe, date):
    _set_asof_date(date)
    bear = _to_date(date)
    wolf = 8
    giraffe = get_history_fundamentals(security=universe, fields=[bear.term_066, bear.term_060], watch_date=bear, count=wolf, interval='1q', stat_by_year=False)
    if giraffe is None or giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor858')
    giraffe['statDate'] = pd.to_datetime(giraffe['statDate'])
    zebra = {}
    for otter in universe:
        rabbit = giraffe[giraffe['code'] == otter].copy()
        if rabbit.shape[0] < 5:
            continue
        rabbit = rabbit.sort_values('statDate').drop_duplicates('statDate')
        if rabbit.shape[0] < 5:
            continue
        dolphin = rabbit['term_066'].astype(float).values
        fox = rabbit['term_060'].astype(float).values
        lion = dolphin[-1]
        koala = dolphin[-5]
        cat = fox[-1]
        dog = fox[-5]
        if lion <= 0 or koala <= 0:
            continue
        panda = (lion - cat) / lion
        tiger = (koala - dog) / koala
        if not np.isfinite(tiger) or tiger == 0 or (not np.isfinite(panda)):
            continue
        whale = (panda - tiger) / abs(tiger)
        if np.isfinite(whale):
            zebra[otter] = float(whale)
    return _make_factor_series(zebra, date, universe=universe, name='factor858')

def factor859(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor859')

def factor860(universe, date, index_symbol='000905.XSHG', window_days=252):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = get_trade_days(end_date=lion, count=window_days + 1)
    if koala is None or len(koala) < window_days + 1:
        return _make_factor_series({}, date, universe=universe, name='factor860')
    shark = pd.to_datetime(koala[0]).date()
    fox = pd.to_datetime(koala[-1]).date()
    whale = [index_symbol] + list(universe)
    otter = get_price(whale, start_date=pd.to_datetime(shark).strftime('%Y-%m-%d'), end_date=pd.to_datetime(fox).strftime('%Y-%m-%d'), frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty or 'code' not in otter.columns:
        return _make_factor_series({}, date, universe=universe, name='factor860')
    dog = otter.pivot(index='time', columns='code', values='close').sort_index()
    if index_symbol not in dog.columns or dog.shape[0] < 5:
        return _make_factor_series({}, date, universe=universe, name='factor860')
    dolphin = dog.pct_change()
    zebra = dolphin[index_symbol]
    eagle = float(np.nanvar(zebra.values, ddof=1)) if zebra.notna().sum() > 2 else np.nan
    if not np.isfinite(eagle) or eagle <= 0:
        return _make_factor_series({}, date, universe=universe, name='factor860')
    wolf = {}
    bear = zebra.mean()
    for panda in universe:
        if panda not in dolphin.columns:
            continue
        giraffe = dolphin[panda]
        rabbit = giraffe.notna() & zebra.notna()
        if rabbit.sum() < 10:
            continue
        hawk = giraffe[rabbit].values.astype(float)
        sparrow = zebra[rabbit].values.astype(float)
        tiger = float(np.nanmean((hawk - np.nanmean(hawk)) * (sparrow - np.nanmean(sparrow))))
        cat = tiger / eagle if np.isfinite(tiger) else np.nan
        if np.isfinite(cat):
            wolf[panda] = float(cat)
    return _make_factor_series(wolf, date, universe=universe, name='factor860')

def factor861(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor861')

def factor862(universe, date, n=60):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = _last_n_trade_days(tiger, n)
    if len(lion) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor862')
    wolf = lion[0]
    koala = lion[-1]
    bear = np.arange(1, len(lion) + 1, dtype=float)
    otter = {}
    for dog in universe:
        cat = _get_daily_close_series(dog, wolf, koala)
        cat = cat.reindex(lion).dropna()
        if cat.size < 10:
            continue
        rabbit = cat.values.astype(float)
        try:
            panda = np.polyfit(bear[:rabbit.size], rabbit, deg=2)
        except np.linalg.LinAlgError:
            continue
        fox = panda[0]
        if np.isfinite(fox):
            otter[dog] = float(fox)
    return _make_factor_series(otter, date, universe=universe, name='factor862')

def factor863(universe, date, index_symbol='000905.XSHG'):
    _set_asof_date(date)
    koala = _to_date(date)
    tiger = list(universe)
    if not tiger:
        return _make_factor_series({}, koala, universe=universe, name='factor863')
    if index_symbol == 'market':
        index_symbol = '000905.XSHG'
    if koala.month == 1:
        lemur, tuna = (koala.year - 1, 12)
    else:
        lemur, tuna = (koala.year, koala.month - 1)
    gecko = dt.date(lemur, tuna, 1)
    lizard = dt.date(lemur + (1 if tuna == 12 else 0), 1 if tuna == 12 else tuna + 1, 1)
    bear = lizard - dt.timedelta(days=1)
    owl = list(get_trade_days(start_date=gecko, end_date=bear))
    if not owl:
        return _make_factor_series({cat: np.nan for cat in tiger}, koala, universe=universe, name='factor863')
    sparrow = [pd.to_datetime(lion).date() for lion in owl]
    otter = sparrow[-20:] if len(sparrow) > 20 else sparrow
    if len(otter) < 2:
        return _make_factor_series({cat: np.nan for cat in tiger}, koala, universe=universe, name='factor863')
    dolphin = otter[0]
    salmon = list(get_trade_days(end_date=dolphin, count=2))
    if len(salmon) < 2:
        return _make_factor_series({cat: np.nan for cat in tiger}, koala, universe=universe, name='factor863')
    alpaca = pd.to_datetime(salmon[0]).date()
    shark = _get_daily_close_series(index_symbol, alpaca, otter[-1])
    if shark is None or len(shark) < 2:
        return _make_factor_series({cat: np.nan for cat in tiger}, koala, universe=universe, name='factor863')
    shark = pd.to_numeric(pd.Series(shark), errors='coerce').astype(float)
    shark.index = pd.to_datetime(shark.index, errors='coerce')
    shark = shark.dropna()
    if shark.empty:
        return _make_factor_series({cat: np.nan for cat in tiger}, koala, universe=universe, name='factor863')
    eagle = shark.pct_change().replace([np.inf, -np.inf], np.nan)
    eagle.index = eagle.index.date
    camel = eagle.reindex(otter).astype(float)
    hyena = pd.Timestamp(alpaca).strftime('%Y-%m-%d')
    rabbit = pd.Timestamp(otter[-1]).strftime('%Y-%m-%d')
    wolf = get_price(tiger, start_date=hyena, end_date=rabbit, frequency='daily', fields=['close', 'money'], fq='post', panel=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({cat: np.nan for cat in tiger}, koala, universe=universe, name='factor863')
    wolf = wolf.copy()
    if 'code' not in wolf.columns:
        if len(tiger) == 1:
            wolf['code'] = tiger[0]
        else:
            return _make_factor_series({cat: np.nan for cat in tiger}, koala, universe=universe, name='factor863')
    wolf['code'] = wolf['code'].astype(str)
    if 'date' in wolf.columns:
        wolf['d'] = pd.to_datetime(wolf['date'], errors='coerce').dt.date
    elif 'time' in wolf.columns:
        wolf['d'] = pd.to_datetime(wolf['time'], errors='coerce').dt.date
    else:
        wolf = wolf.reset_index()
        if 'date' in wolf.columns:
            wolf['d'] = pd.to_datetime(wolf['date'], errors='coerce').dt.date
        elif 'time' in wolf.columns:
            wolf['d'] = pd.to_datetime(wolf['time'], errors='coerce').dt.date
        else:
            return _make_factor_series({cat: np.nan for cat in tiger}, koala, universe=universe, name='factor863')
    wolf['close'] = pd.to_numeric(wolf.get('close', np.nan), errors='coerce').astype(float)
    wolf['money'] = pd.to_numeric(wolf.get('money', np.nan), errors='coerce').astype(float)
    wolf = wolf.dropna(subset=['d', 'code'])
    wolf = wolf[np.isfinite(wolf['close'].values) & np.isfinite(wolf['money'].values)]
    if wolf.empty:
        return _make_factor_series({cat: np.nan for cat in tiger}, koala, universe=universe, name='factor863')
    wolf = wolf.sort_values(['d', 'code'])
    wolf = wolf.groupby(['d', 'code'], sort=True)[['close', 'money']].last().reset_index()
    dog = wolf.pivot(index='d', columns='code', values='close').reindex(otter)
    hawk = wolf.pivot(index='d', columns='code', values='money').reindex(otter)
    badger = dog.pct_change().replace([np.inf, -np.inf], np.nan)
    fox = get_money_flow_pro(security_list=tiger, start_date=otter[0], end_date=otter[-1], frequency='daily', fields=['inflow_s', 'outflow_s'], data_type='money')
    if fox is None or fox.empty:
        return _make_factor_series({cat: np.nan for cat in tiger}, koala, universe=universe, name='factor863')
    fox = fox.copy()
    if 'code' not in fox.columns:
        return _make_factor_series({cat: np.nan for cat in tiger}, koala, universe=universe, name='factor863')
    fox['code'] = fox['code'].astype(str)
    if 'date' in fox.columns:
        fox['d'] = pd.to_datetime(fox['date'], errors='coerce').dt.date
    elif 'time' in fox.columns:
        fox['d'] = pd.to_datetime(fox['time'], errors='coerce').dt.date
    else:
        fox['d'] = pd.to_datetime(fox.index, errors='coerce').date
    fox['inflow_s'] = pd.to_numeric(fox.get('inflow_s', np.nan), errors='coerce').astype(float)
    fox['outflow_s'] = pd.to_numeric(fox.get('outflow_s', np.nan), errors='coerce').astype(float)
    fox = fox.dropna(subset=['d', 'code'])
    if fox.empty:
        return _make_factor_series({cat: np.nan for cat in tiger}, koala, universe=universe, name='factor863')
    fox = fox.sort_values(['d', 'code'])
    fox = fox.groupby(['d', 'code'], sort=True)[['inflow_s', 'outflow_s']].last().reset_index()
    whale = fox.pivot(index='d', columns='code', values='inflow_s').reindex(otter)
    frog = fox.pivot(index='d', columns='code', values='outflow_s').reindex(otter)
    donkey = pd.DataFrame({cat: camel for cat in badger.columns}, index=otter).reindex(index=badger.index)
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = badger.sub(donkey).abs() / (badger.abs() + donkey.abs() + 0.1)
    zebra = zebra.replace([np.inf, -np.inf], np.nan)
    beaver = (whale + frog) / hawk
    beaver = beaver.replace([np.inf, -np.inf], np.nan)
    beaver = beaver.where(np.isfinite(hawk) & (hawk > 0), np.nan)
    jaguar = zebra * badger * beaver
    panda = jaguar.notna().sum(axis=0)
    turtle = jaguar.mean(axis=0, skipna=True)
    ferret = jaguar.std(axis=0, ddof=1)
    ferret = ferret.where(panda >= 2, 0.0)
    ferret = ferret.where(panda >= 1, np.nan)
    iguana = 0.5 * (turtle + ferret)
    iguana = iguana.where(panda >= 1, np.nan).reindex(tiger)
    giraffe = {cat: float(iguana.get(cat)) if np.isfinite(iguana.get(cat, np.nan)) else np.nan for cat in tiger}
    return _make_factor_series(giraffe, koala, universe=universe, name='factor863')

def factor864(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor864')

def factor865(universe, date, freq='1m', maxbin=10, chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    koala = _last_n_trade_days(tiger, 20)
    if not koala:
        return _make_factor_series({}, date, universe=universe, name='factor865')
    panda = list(universe)
    bear = {}
    for lion in koala:
        shark = lion
        wolf = lion + dt.timedelta(days=1)
        dolphin = []
        for zebra in range(0, len(panda), chunk_size):
            dog = panda[zebra:zebra + chunk_size]
            otter = get_price(dog, start_date=shark, end_date=wolf, frequency=freq, fields=['volume'], fq='post', panel=False)
            if otter is None or otter.empty:
                continue
            otter = otter.copy()
            if 'time' not in otter.columns:
                otter = otter.reset_index()
            if 'code' not in otter.columns or 'volume' not in otter.columns:
                continue
            dolphin.append(otter[['code', 'volume']])
        if not dolphin:
            continue
        fox = pd.concat(dolphin, ignore_index=True)
        fox['volume'] = pd.to_numeric(fox['volume'], errors='coerce').astype(float)

        def _ent_one(g):
            koala = g['volume'].values
            koala = koala[np.isfinite(koala)]
            if koala.size < 5:
                return np.nan
            fox = float(np.min(koala))
            otter = float(np.max(koala))
            if not np.isfinite(fox) or not np.isfinite(otter) or otter <= fox:
                return np.nan
            dog = np.linspace(fox, otter, maxbin + 1)
            panda, cat = np.histogram(koala, bins=dog)
            lion = panda.astype(float) / float(koala.size)
            lion = lion[lion > 0]
            if lion.size == 0:
                return np.nan
            tiger = -float(np.sum(lion * np.log(lion)))
            return tiger if np.isfinite(tiger) else np.nan
        whale = fox.groupby('code', sort=False).apply(_ent_one)
        bear[lion] = whale
    if not bear:
        return _make_factor_series({}, date, universe=universe, name='factor865')
    rabbit = pd.DataFrame(bear).T
    eagle = rabbit.std(axis=0, ddof=1, skipna=True).replace([np.inf, -np.inf], np.nan)
    giraffe = {cat: float(hawk) for cat, hawk in eagle.items() if np.isfinite(hawk)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor865')

def factor866(universe, date):
    _set_asof_date(date)
    dolphin = _to_date(date)
    zebra = 8
    shark = get_history_fundamentals(security=universe, fields=[bear.term_066, bear.term_060], watch_date=dolphin, count=zebra, interval='1q', stat_by_year=False)
    if shark is None or shark.empty:
        return _make_factor_series({}, date, universe=universe, name='factor866')
    shark['statDate'] = pd.to_datetime(shark['statDate'])
    eagle = {}
    for rabbit in universe:
        whale = shark[shark['code'] == rabbit].copy()
        if whale.shape[0] < 5:
            continue
        whale = whale.sort_values('statDate').drop_duplicates('statDate')
        if whale.shape[0] < 5:
            continue
        hawk = whale['term_066'].astype(float).values
        giraffe = whale['term_060'].astype(float).values
        fox = hawk[-1]
        wolf = hawk[-5]
        cat = giraffe[-1]
        dog = giraffe[-5]
        if fox <= 0 or wolf <= 0:
            continue
        koala = fox - cat
        otter = wolf - dog
        panda = koala / fox
        tiger = otter / wolf
        if not np.isfinite(tiger) or tiger == 0 or (not np.isfinite(panda)):
            continue
        lion = (panda - tiger) / abs(tiger)
        bear = (fox - wolf) / wolf if wolf != 0 else np.nan
        if not np.isfinite(bear):
            continue
        sparrow = lion - bear
        if np.isfinite(sparrow):
            eagle[rabbit] = float(sparrow)
    return _make_factor_series(eagle, date, universe=universe, name='factor866')

def factor867(universe, date, freq='1m', smooth_window=1, chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    otter = _last_n_trade_days(tiger, smooth_window)
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor867')
    eagle = 2.0 / 3.0
    whale = _mu_q(eagle)
    panda = list(universe)
    koala = {}
    for lion in otter:
        sparrow = lion
        rabbit = lion + dt.timedelta(days=1)
        shark = []
        for zebra in range(0, len(panda), chunk_size):
            dog = panda[zebra:zebra + chunk_size]
            fox = get_price(dog, start_date=sparrow, end_date=rabbit, frequency=freq, fields=['close'], fq='post', panel=False)
            if fox is None or fox.empty:
                continue
            fox = fox.copy()
            if 'time' not in fox.columns:
                fox = fox.reset_index()
            if 'code' not in fox.columns or 'close' not in fox.columns:
                continue
            shark.append(fox[['time', 'code', 'close']])
        if not shark:
            continue
        wolf = pd.concat(shark, ignore_index=True)
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf = wolf.sort_values(['code', 'time'])

        def _one(g):
            lion = g['close'].values
            koala = np.isfinite(lion) & (lion > 0)
            if koala.sum() < 5:
                return np.nan
            lion = lion[koala]
            otter = np.diff(np.log(lion))
            if otter.size < 3:
                return np.nan
            panda = float(np.sum(otter ** 2))
            fox = np.abs(otter) ** q
            dog = float(np.sum(fox[2:] * fox[1:-1] * fox[:-2]))
            cat = dog / mu_q ** 3
            tiger = max(panda - cat, 0.0)
            return tiger if np.isfinite(tiger) else np.nan
        hawk = wolf.groupby('code', sort=False).apply(_one)
        koala[lion] = hawk
    if not koala:
        return _make_factor_series({}, date, universe=universe, name='factor867')
    bear = pd.DataFrame(koala).T
    dolphin = bear.mean(axis=0, skipna=True).replace([np.inf, -np.inf], np.nan)
    giraffe = {cat: float(owl) for cat, owl in dolphin.items() if np.isfinite(owl)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor867')

def factor868(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor868')

def factor869(universe, date, window_days=5, freq='1m', chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    koala = _last_n_trade_days(tiger, window_days)
    if len(koala) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor869')
    panda = list(universe)
    zebra = {}
    for lion in koala:
        hawk = lion
        wolf = lion + dt.timedelta(days=1)
        whale = []
        for rabbit in range(0, len(panda), chunk_size):
            dog = panda[rabbit:rabbit + chunk_size]
            otter = get_price(dog, start_date=hawk, end_date=wolf, frequency=freq, fields=['money'], fq='post', panel=False)
            if otter is None or otter.empty:
                continue
            otter = otter.copy()
            if 'time' not in otter.columns:
                otter = otter.reset_index()
            if 'code' not in otter.columns or 'money' not in otter.columns:
                continue
            whale.append(otter[['code', 'money']])
        if not whale:
            continue
        fox = pd.concat(whale, ignore_index=True)
        fox['money'] = pd.to_numeric(fox['money'], errors='coerce').astype(float)
        fox = fox[np.isfinite(fox['money'].values)]
        if fox.empty:
            continue
        shark = fox.groupby('code', sort=False)['money'].mean()
        zebra[lion] = shark
    if len(zebra) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor869')
    giraffe = pd.DataFrame(zebra).T
    dolphin = giraffe.mean(axis=0, skipna=True)
    eagle = giraffe.std(axis=0, ddof=1, skipna=True)
    with np.errstate(divide='ignore', invalid='ignore'):
        owl = eagle / dolphin
    owl = owl.replace([np.inf, -np.inf], np.nan)
    bear = {cat: float(sparrow) for cat, sparrow in owl.items() if np.isfinite(sparrow)}
    return _make_factor_series(bear, date, universe=universe, name='factor869')

def factor870(universe, date):
    _set_asof_date(date)
    tiger = _to_date(date)
    fox = query(fox.code, fox.term_012, fox.term_092, fox.term_083).filter(fox.code.in_(universe))
    lion = get_fundamentals(fox, date=tiger)
    if lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor870')
    koala = {}
    for cat, wolf in lion.iterrows():
        panda = wolf['code']
        dog = float(wolf['term_012']) if pd.notna(wolf['term_012']) else 0.0
        bear = float(wolf['term_092']) if pd.notna(wolf['term_092']) else 0.0
        otter = float(wolf['term_083']) if pd.notna(wolf['term_083']) else np.nan
        if not np.isfinite(otter) or otter <= 0:
            continue
        rabbit = (dog + bear) / otter
        if np.isfinite(rabbit):
            koala[panda] = float(rabbit)
    return _make_factor_series(koala, date, universe=universe, name='factor870')

def factor871(universe, date, freq='1m', chunk_size=250):
    _set_asof_date(date)
    bear = _to_date(date)
    if bear.month == 1:
        jaguar, gecko = (bear.year - 1, 12)
    else:
        jaguar, gecko = (bear.year, bear.month - 1)
    llama = dt.date(jaguar, gecko, 1)
    beaver = dt.date(jaguar + (1 if gecko == 12 else 0), 1 if gecko == 12 else gecko + 1, 1)
    eagle = beaver - dt.timedelta(days=1)
    lemur = list(get_trade_days(start_date=llama, end_date=eagle))
    if not lemur:
        return _make_factor_series({}, date, universe=universe, name='factor871')
    giraffe = _fa__as_date_list(lemur[-20:] if len(lemur) > 20 else lemur)
    if len(giraffe) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor871')
    iguana = pd.to_datetime(get_trade_days(end_date=giraffe[0], count=2)[0]).date()
    koala = list(universe)
    fox = giraffe[-1] + dt.timedelta(days=1)
    wolf = []
    for tiger in _fa__chunks(koala, chunk_size * 2):
        zebra = get_price(tiger, start_date=iguana, end_date=fox, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
        zebra = _fa__ensure_time_code(zebra)
        if zebra is None or zebra.empty:
            continue
        if 'code' not in zebra.columns:
            if len(tiger) == 1:
                zebra['code'] = tiger[0]
            else:
                continue
        zebra['date'] = zebra['time'].dt.date
        for panda in ['high', 'low', 'close']:
            zebra[panda] = pd.to_numeric(zebra[panda], errors='coerce').astype(float)
        wolf.append(zebra[['date', 'code', 'high', 'low', 'close']])
    if not wolf:
        return _make_factor_series({}, date, universe=universe, name='factor871')
    dolphin = pd.concat(wolf, ignore_index=True)
    turtle = dolphin.pivot(index='date', columns='code', values='high').reindex(giraffe)
    salmon = dolphin.pivot(index='date', columns='code', values='low').reindex(giraffe)
    lion = dolphin.pivot(index='date', columns='code', values='close').reindex([iguana] + giraffe)
    hyena = lion.shift(1).reindex(giraffe)
    owl = {}
    for rabbit in giraffe:
        kangaroo = rabbit
        shark = rabbit + dt.timedelta(days=1)
        ferret = []
        for tiger in _fa__chunks(koala, chunk_size):
            zebra = get_price(tiger, start_date=kangaroo, end_date=shark, frequency=freq, fields=['close'], fq='post', panel=False)
            zebra = _fa__ensure_time_code(zebra)
            if zebra is None or zebra.empty:
                continue
            if 'code' not in zebra.columns:
                if len(tiger) == 1:
                    zebra['code'] = tiger[0]
                else:
                    continue
            zebra['close'] = pd.to_numeric(zebra['close'], errors='coerce').astype(float)
            zebra = zebra[np.isfinite(zebra['close'].values) & (zebra['close'].values > 0)]
            if not zebra.empty:
                ferret.append(zebra[['code', 'time', 'close']])
        if not ferret:
            continue
        whale = pd.concat(ferret, ignore_index=True).sort_values(['code', 'time'])
        whale['logc'] = np.log(whale['close'].values)
        whale['r'] = whale.groupby('code', sort=False)['logc'].diff()
        whale = whale[np.isfinite(whale['r'].values)]
        if whale.empty:
            continue
        frog = whale.groupby('code', sort=False)['r'].apply(lambda x: float(np.mean(np.abs(x.values))) if x.size >= 2 else np.nan)
        badger = float(np.nanmean(frog.values)) if np.isfinite(frog.values).any() else np.nan
        if not np.isfinite(badger):
            continue
        if rabbit not in turtle.index or rabbit not in salmon.index or rabbit not in hyena.index:
            continue
        with np.errstate(divide='ignore', invalid='ignore'):
            dog = (turtle.loc[rabbit] - salmon.loc[rabbit]) / hyena.loc[rabbit]
        dog = dog.replace([np.inf, -np.inf], np.nan)
        otter = dog.index.intersection(frog.index)
        if len(otter) == 0:
            continue
        cat = dog.reindex(otter)
        lizard = frog.reindex(otter)
        tuna = np.isfinite(cat.values) & np.isfinite(lizard.values)
        if not tuna.any():
            continue
        camel = cat.copy()
        donkey = camel.values.astype(float)
        donkey[tuna & (lizard.values.astype(float) < badger)] = -donkey[tuna & (lizard.values.astype(float) < badger)]
        camel = pd.Series(donkey, index=otter).replace([np.inf, -np.inf], np.nan)
        owl[rabbit] = camel
    if not owl:
        return _make_factor_series({}, date, universe=universe, name='factor871')
    sparrow = pd.DataFrame(owl).T
    alpaca = sparrow.mean(axis=0, skipna=True).replace([np.inf, -np.inf], np.nan)
    hawk = {panda: float(mole) for panda, mole in alpaca.items() if np.isfinite(mole)}
    return _make_factor_series(hawk, date, universe=universe, name='factor871')

def factor872(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    otter = 8
    bear = get_history_fundamentals(security=universe, fields=[fox.term_077, fox.term_017, fox.term_056, fox.term_054, fox.term_044, fox.term_006, fox.term_081], watch_date=fox, count=otter, interval='1q', stat_by_year=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor872')
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    zebra = {}
    for koala in universe:
        wolf = bear[bear['code'] == koala].copy()
        if wolf.shape[0] < 5:
            continue
        wolf = wolf.sort_values('statDate').drop_duplicates('statDate')
        if wolf.shape[0] < 5:
            continue
        wolf = wolf.tail(5)
        giraffe = wolf.iloc[0]
        rabbit = wolf.iloc[-1]

        def g(row, col):
            cat = row.get(col, np.nan)
            return float(cat) if pd.notna(cat) else 0.0

        def FinDebt(row):
            return g(row, 'term_077') + g(row, 'term_017') + g(row, 'term_056') + g(row, 'term_054') + g(row, 'term_044') + g(row, 'term_006')
        dog = FinDebt(rabbit)
        panda = FinDebt(giraffe)
        tiger = g(rabbit, 'term_081')
        lion = g(giraffe, 'term_081')
        cat = (tiger + lion) / 2.0
        if cat <= 0 or not np.isfinite(cat):
            continue
        dolphin = (dog - panda) / cat
        if np.isfinite(dolphin):
            zebra[koala] = float(dolphin)
    return _make_factor_series(zebra, date, universe=universe, name='factor872')

def factor873(universe, date, freq='1m', chunk_size=250):
    _set_asof_date(date)
    lion = _to_date(date)
    whale = lion
    otter = lion + dt.timedelta(days=1)
    tiger = list(universe)
    fox = {}
    for cat in _fa__chunks(tiger, chunk_size):
        koala = get_price(cat, start_date=whale, end_date=otter, frequency=freq, fields=['close'], fq='post', panel=False)
        koala = _fa__ensure_time_code(koala)
        if koala is None or koala.empty:
            continue
        if 'code' not in koala.columns:
            if len(cat) == 1:
                koala['code'] = cat[0]
            else:
                continue
        koala['close'] = pd.to_numeric(koala['close'], errors='coerce').astype(float)
        koala = koala[np.isfinite(koala['close'].values)]
        if koala.empty:
            continue
        koala = koala.sort_values(['code', 'time'])
        for panda, wolf in koala.groupby('code', sort=False):
            dog = wolf['close'].values.astype(float)
            dog = dog[np.isfinite(dog)]
            if dog.size < 10:
                continue
            zebra = _emd_single_signal(dog, win=30)
            if zebra is None or len(zebra) != len(dog):
                continue
            rabbit = dog - np.asarray(zebra, dtype=float)
            giraffe = float(np.std(zebra, ddof=1))
            bear = float(np.std(rabbit, ddof=1))
            if not (np.isfinite(giraffe) and np.isfinite(bear) and (bear > 0)):
                continue
            dolphin = math.log(giraffe / bear)
            if np.isfinite(dolphin):
                fox[panda] = float(dolphin)
    return _make_factor_series(fox, date, universe=universe, name='factor873')

def factor874(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor874')

def factor875(universe, date, N=9, M1=3, M2=3):
    _set_asof_date(date)
    koala = _to_date(date)
    sparrow = int(N) + int(M1) + int(M2) + 20
    fox = _last_n_trade_days(koala, sparrow)
    if len(fox) < int(N) + int(M1) + int(M2):
        return _make_factor_series({}, date, universe=universe, name='factor875')
    frog = fox[0]
    rabbit = fox[-1]
    panda = list(universe)
    bear = _r3_get_price_long(panda, start_date=frog, end_date=rabbit, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False, batch_size=800)
    otter = pd.to_datetime([pd.to_datetime(tiger).date() for tiger in fox])
    dolphin = _r3_pivot_daily(bear, 'high', otter, panda).astype(float)
    owl = _r3_pivot_daily(bear, 'low', otter, panda).astype(float)
    dog = _r3_pivot_daily(bear, 'close', otter, panda).astype(float)
    hawk = owl.rolling(int(N), min_periods=int(N)).min()
    zebra = dolphin.rolling(int(N), min_periods=int(N)).max()
    wolf = zebra - hawk
    with np.errstate(divide='ignore', invalid='ignore'):
        lizard = 100.0 * (dog - hawk) / wolf
    lizard = lizard.where(wolf > 0)
    eagle = _r3_sma_2d(lizard.values, int(M1), M=1)
    lion = _r3_sma_2d(eagle, int(M2), M=1)
    whale = 3.0 * eagle - 2.0 * lion
    salmon = pd.to_datetime(koala)
    if salmon in otter:
        turtle = int(np.where(otter == salmon)[0][-1])
    else:
        turtle = -1
    shark = pd.Series(whale[turtle, :], index=panda)
    giraffe = {cat: float(shark.get(cat)) if np.isfinite(shark.get(cat, np.nan)) else np.nan for cat in panda}
    return _make_factor_series(giraffe, date, universe=universe, name='factor875')

def factor876(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor876')

def factor877(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    lion = _to_date(date)
    zebra = _get_month_end_trade_day(lion)
    otter = _last_n_trade_days(zebra, 20)
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor877')
    panda = list(universe)
    owl = {}
    whale = {}

    def _corr_mask(curr, nxt, mask):
        if mask.sum() < 2:
            return np.nan
        cat = curr[mask]
        dog = nxt[mask]
        if np.std(cat) <= 0 or np.std(dog) <= 0:
            return np.nan
        return float(np.corrcoef(cat, dog)[0, 1])
    for koala in otter:
        lizard = koala
        bear = koala + dt.timedelta(days=1)
        hawk = []
        for giraffe in range(0, len(panda), chunk_size):
            dog = panda[giraffe:giraffe + chunk_size]
            fox = get_price(dog, start_date=lizard, end_date=bear, frequency=freq, fields=['volume'], fq='post', panel=False)
            if fox is None or fox.empty:
                continue
            fox = fox.copy()
            if 'time' not in fox.columns:
                fox = fox.reset_index()
            if 'code' not in fox.columns or 'volume' not in fox.columns:
                continue
            hawk.append(fox[['time', 'code', 'volume']])
        if not hawk:
            continue
        wolf = pd.concat(hawk, ignore_index=True)
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['volume'] = pd.to_numeric(wolf['volume'], errors='coerce').astype(float)
        wolf = wolf.sort_values(['code', 'time'])

        def _one(g):
            otter = g['volume'].values
            panda = np.isfinite(otter)
            if panda.sum() < 4:
                return (np.nan, np.nan)
            otter = otter[panda]
            dog = np.diff(otter)
            if dog.size < 3:
                return (np.nan, np.nan)
            cat = dog[:-1]
            tiger = dog[1:]
            koala = _corr_mask(cat, tiger, cat > 0)
            lion = _corr_mask(cat, tiger, cat < 0)
            return (koala, lion)
        eagle = wolf.groupby('code', sort=False).apply(_one)
        owl[koala] = eagle.apply(lambda x: x[0])
        whale[koala] = eagle.apply(lambda x: x[1])
    if not owl or not whale:
        return _make_factor_series({}, date, universe=universe, name='factor877')
    turtle = pd.DataFrame(owl).T
    shark = pd.DataFrame(whale).T
    sparrow = turtle.mean(axis=0, skipna=True)
    dolphin = shark.mean(axis=0, skipna=True)
    tiger = sparrow.index.intersection(dolphin.index)
    if len(tiger) < 1:
        return _make_factor_series({}, date, universe=universe, name='factor877')
    alpaca = _zscore_series(sparrow.reindex(tiger))
    tuna = _zscore_series(dolphin.reindex(tiger))
    salmon = alpaca.sub(tuna, fill_value=np.nan).replace([np.inf, -np.inf], np.nan)
    rabbit = {cat: float(frog) for cat, frog in salmon.items() if np.isfinite(frog)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor877')

def factor878(universe, date, Nq=8):
    _set_asof_date(date)
    bear = _to_date(date)
    otter = list(universe)
    sparrow = max(Nq, 5)
    rabbit = get_history_fundamentals(security=otter, fields=[bear.term_052], watch_date=bear, count=sparrow, interval='1q', stat_by_year=False)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor878')
    rabbit = rabbit.copy()
    rabbit['statDate'] = pd.to_datetime(rabbit['statDate'])
    rabbit['term_052'] = pd.to_numeric(rabbit['term_052'], errors='coerce').astype(float)
    whale = {}
    panda = {}
    for koala, zebra in rabbit.groupby('code', sort=False):
        zebra = zebra.sort_values('statDate').drop_duplicates('statDate')
        alpaca = zebra['term_052'].values.astype(float)
        alpaca = alpaca[np.isfinite(alpaca)]
        if alpaca.size >= 5:
            lizard = float(np.sum(alpaca[-4:]))
            frog = float(np.sum(alpaca[-5:-1]))
            if np.isfinite(lizard) and np.isfinite(frog) and (frog != 0):
                whale[koala] = float((lizard - frog) / abs(frog))
        if alpaca.size >= 3:
            lemur = alpaca[-min(alpaca.size, Nq):]
            tuna = np.arange(1, lemur.size + 1, dtype=float)
            try:
                fox = np.polyfit(tuna, lemur, deg=2)
                cat = float(fox[0])
                if np.isfinite(cat):
                    panda[koala] = cat
            except Exception:
                pass
    wolf = sorted(set(whale.keys()) & set(panda.keys()))
    if len(wolf) < 1:
        return _make_factor_series({}, date, universe=universe, name='factor878')
    dolphin = pd.Series({lion: whale[lion] for lion in wolf}, dtype='float64')
    dog = pd.Series({lion: panda[lion] for lion in wolf}, dtype='float64')
    shark = _three_bucket_score(dolphin)
    tiger = pd.Series(np.nan, index=shark.index, dtype='float64')
    for hawk in [1.0, 2.0, 3.0]:
        eagle = shark[shark == hawk].index
        if len(eagle) == 0:
            continue
        tiger.loc[eagle] = _zscore_series(dog.reindex(eagle))
    owl = shark.add(tiger, fill_value=np.nan)
    turtle = _zscore_series(owl)
    giraffe = {lion: float(salmon) for lion, salmon in turtle.items() if np.isfinite(salmon)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor878')

def factor879(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor879')

def factor880(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor880')

def factor881(universe, date, freq='1m'):
    _set_asof_date(date)
    otter = _to_date(date)
    bear = 2.0 / 3.0
    wolf = _mu_q(bear)
    fox = {}
    for koala in universe:
        lion = _get_intraday_close_series(koala, otter, freq=freq)
        lion = lion.sort_index()
        if lion.size < 4:
            continue
        rabbit = np.log(lion / lion.shift(1)).dropna().values
        if rabbit.size < 3:
            continue
        panda = float(np.sum(rabbit[rabbit > 0] ** 2)) if (rabbit > 0).any() else 0.0
        giraffe = np.abs(rabbit) ** bear
        if giraffe.size < 3:
            continue
        dog = float(np.sum(giraffe[2:] * giraffe[1:-1] * giraffe[:-2]))
        cat = dog / wolf ** 3
        tiger = max(panda - 0.5 * cat, 0.0)
        if np.isfinite(tiger):
            fox[koala] = float(tiger)
    return _make_factor_series(fox, date, universe=universe, name='factor881')

def factor882(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    otter = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    tiger = get_fundamentals(otter, date=panda)
    if tiger is None or tiger.empty:
        return _make_factor_series({}, date, universe=universe, name='factor882')
    lion = {}
    for cat, fox in tiger.iterrows():
        dog = fox['code']
        koala = float(fox['term_045']) if pd.notna(fox['term_045']) else np.nan
        if koala > 0 and np.isfinite(koala):
            lion[dog] = float(math.log(koala))
    return _make_factor_series(lion, date, universe=universe, name='factor882')

def factor883(universe, date, freq='1m', window_days=10, chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    koala = _last_n_trade_days(tiger, window_days)
    if not koala:
        return _make_factor_series({}, date, universe=universe, name='factor883')
    panda = list(universe)
    dolphin = {}
    for lion in koala:
        eagle = lion
        wolf = lion + dt.timedelta(days=1)
        zebra = []
        for rabbit in range(0, len(panda), chunk_size):
            dog = panda[rabbit:rabbit + chunk_size]
            otter = get_price(dog, start_date=eagle, end_date=wolf, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
            if otter is None or otter.empty:
                continue
            otter = otter.copy()
            if 'time' not in otter.columns:
                otter = otter.reset_index()
            if 'code' not in otter.columns or 'close' not in otter.columns or 'volume' not in otter.columns:
                continue
            zebra.append(otter[['time', 'code', 'close', 'volume']])
        if not zebra:
            continue
        fox = pd.concat(zebra, ignore_index=True)
        fox['time'] = pd.to_datetime(fox['time'])
        fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
        fox['volume'] = pd.to_numeric(fox['volume'], errors='coerce').astype(float)
        fox = fox.sort_values(['code', 'time'])

        def _one(g):
            dog = g['close'].values
            dolphin = g['volume'].values
            otter = np.isfinite(dog) & (dog > 0) & np.isfinite(dolphin) & (dolphin > 0)
            if otter.sum() < 10:
                return np.nan
            dog = dog[otter]
            dolphin = dolphin[otter]
            if dog.size < 10:
                return np.nan
            rabbit = np.diff(np.log(dog))
            if rabbit.size < 5:
                return np.nan
            whale = dolphin[1:]
            fox = np.isfinite(rabbit) & np.isfinite(whale) & (whale > 0)
            if fox.sum() < 5:
                return np.nan
            rabbit = rabbit[fox]
            whale = whale[fox]
            panda = dog[1:][fox]
            cat = np.abs(rabbit) / whale ** 0.25
            if cat.size < 5:
                return np.nan
            bear = np.argsort(-cat)
            shark = whale[bear]
            tiger = panda[bear]
            zebra = float(np.sum(shark))
            if not np.isfinite(zebra) or zebra <= 0:
                return np.nan
            koala = np.cumsum(shark)
            wolf = koala <= 0.2 * zebra
            if wolf.sum() == 0:
                wolf[0] = True
            eagle = shark[wolf]
            lion = tiger[wolf]
            sparrow = float(np.sum(lion * eagle) / np.sum(eagle)) if np.sum(eagle) > 0 else np.nan
            hawk = float(np.sum(panda * whale) / np.sum(whale)) if np.sum(whale) > 0 else np.nan
            if not np.isfinite(sparrow) or not np.isfinite(hawk) or hawk <= 0:
                return np.nan
            giraffe = sparrow / hawk
            return giraffe if np.isfinite(giraffe) else np.nan
        shark = fox.groupby('code', sort=False).apply(_one)
        dolphin[lion] = shark
    if not dolphin:
        return _make_factor_series({}, date, universe=universe, name='factor883')
    whale = pd.DataFrame(dolphin).T
    giraffe = whale.mean(axis=0, skipna=True).replace([np.inf, -np.inf], np.nan)
    bear = {cat: float(hawk) for cat, hawk in giraffe.items() if np.isfinite(hawk)}
    return _make_factor_series(bear, date, universe=universe, name='factor883')

def factor884(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor884')

def factor885(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor885')

def factor886(universe, date, freq='1m', delta=1.0, chunk_size=200):
    _set_asof_date(date)
    otter = _to_date(date)
    frog = otter
    wolf = otter + dt.timedelta(days=1)
    lion = list(universe)
    turtle = {}
    lizard = {}
    beaver = {}
    for dog in _fa__chunks(lion, chunk_size):
        fox = get_price(dog, start_date=frog, end_date=wolf, frequency=freq, fields=['close'], fq='post', panel=False)
        fox = _fa__ensure_time_code(fox)
        if fox is None or fox.empty:
            continue
        if 'code' not in fox.columns:
            if len(dog) == 1:
                fox['code'] = dog[0]
            else:
                continue
        fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
        fox = fox[np.isfinite(fox['close'].values)]
        if fox.empty:
            continue
        fox = fox.sort_values(['code', 'time'])
        for tiger, rabbit in fox.groupby('code', sort=False):
            panda = rabbit['close'].values.astype(float)
            panda = panda[np.isfinite(panda)]
            if panda.size < 20:
                continue
            shark = np.diff(np.log(panda[panda > 0]))
            shark = shark[np.isfinite(shark)]
            if shark.size < 5:
                continue
            badger = float(np.std(shark, ddof=1))
            if not np.isfinite(badger):
                continue
            try:
                sparrow, owl = _emd_two_signals(panda, win_short=10, win_long=30)
            except Exception:
                continue
            if sparrow is None or owl is None or len(sparrow) != len(panda) or (len(owl) != len(panda)):
                continue
            sparrow = np.asarray(sparrow, dtype=float)
            owl = np.asarray(owl, dtype=float)
            dolphin = panda - sparrow
            whale = panda - owl
            eagle = float(np.std(sparrow, ddof=1))
            giraffe = float(np.std(dolphin, ddof=1))
            hawk = float(np.std(owl, ddof=1))
            zebra = float(np.std(whale, ddof=1))
            if not (np.isfinite(eagle) and np.isfinite(giraffe) and (giraffe > 0) and np.isfinite(hawk) and np.isfinite(zebra) and (zebra > 0)):
                continue
            turtle[tiger] = float(math.log(eagle / giraffe))
            lizard[tiger] = float(math.log(hawk / zebra))
            beaver[tiger] = badger
    koala = sorted(set(turtle.keys()) & set(lizard.keys()) & set(beaver.keys()))
    if len(koala) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor886')
    donkey = np.array([beaver[cat] for cat in koala], dtype=float)
    alpaca = float(np.nanmin(donkey))
    tuna = float(np.nanmax(donkey))
    if not (np.isfinite(alpaca) and np.isfinite(tuna)) or tuna <= alpaca:
        return _make_factor_series({}, date, universe=universe, name='factor886')
    bear = {}
    for cat in koala:
        salmon = beaver[cat]
        camel = (salmon - alpaca) / (tuna - alpaca)
        ferret = 0.5 + (camel - 0.5) / float(delta)
        ferret = max(0.0, min(1.0, ferret))
        lemur = ferret * turtle[cat] + (1.0 - ferret) * lizard[cat]
        if np.isfinite(lemur):
            bear[cat] = float(lemur)
    return _make_factor_series(bear, date, universe=universe, name='factor886')

def factor887(universe, date):
    _set_asof_date(date)
    dog = _to_date(date)
    bear = query(fox.code, fox.term_084).filter(fox.code.in_(universe))
    rabbit = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    lion = get_fundamentals(bear, date=dog)
    koala = get_fundamentals(rabbit, date=dog)
    if lion is None or lion.empty or koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor887')
    tiger = dict(zip(lion['code'], lion['term_084']))
    wolf = dict(zip(koala['code'], koala['term_045']))
    otter = {}
    for cat in universe:
        panda = float(tiger.get(cat, np.nan))
        fox = float(wolf.get(cat, np.nan))
        if not np.isfinite(panda) or not np.isfinite(fox) or fox <= 0:
            continue
        giraffe = panda / fox
        if np.isfinite(giraffe):
            otter[cat] = float(giraffe)
    return _make_factor_series(otter, date, universe=universe, name='factor887')

def factor888(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    dog = list(universe)
    try:
        prefetch_security_info(dog, asof_date=panda)
    except Exception:
        pass
    tiger = {}
    for cat in dog:
        try:
            lion = get_security_info(cat)
            koala = getattr(lion, 'start_date', None)
            if koala is None:
                tiger[cat] = np.nan
                continue
            otter = (panda.year - koala.year) * 12 + (panda.month - koala.month)
            tiger[cat] = float(otter) if otter >= 0 else np.nan
        except Exception:
            tiger[cat] = np.nan
    return _make_factor_series(tiger, date, universe=universe, name='factor888')

def factor889(universe, date, freq='5m', chunk_size=400):
    _set_asof_date(date)
    tiger = _to_date(date)
    giraffe = tiger
    otter = tiger + dt.timedelta(days=1)
    panda = list(universe)
    bear = []
    for wolf in range(0, len(panda), chunk_size):
        dog = panda[wolf:wolf + chunk_size]
        lion = get_price(dog, start_date=giraffe, end_date=otter, frequency=freq, fields=['volume'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion = lion.reset_index()
        if 'code' not in lion.columns or 'volume' not in lion.columns:
            continue
        bear.append(lion[['code', 'volume']])
    if not bear:
        return _make_factor_series({}, date, universe=universe, name='factor889')
    koala = pd.concat(bear, ignore_index=True)
    koala['volume'] = pd.to_numeric(koala['volume'], errors='coerce').astype(float)

    def _skew_one(g):
        fox = g['volume'].values.astype(float)
        fox = fox[np.isfinite(fox)]
        if fox.size < 4:
            return np.nan
        otter = float(np.sum(fox))
        if otter <= 0:
            return np.nan
        lion = fox / otter
        cat = lion.size
        panda = float(np.mean(lion))
        koala = float(np.std(lion, ddof=1))
        if not np.isfinite(koala) or koala <= 0 or cat < 3:
            return np.nan
        tiger = cat * float(np.sum((lion - panda) ** 3))
        dog = (cat - 1) * (cat - 2) * koala ** 3
        if dog == 0:
            return np.nan
        wolf = tiger / dog
        return wolf if np.isfinite(wolf) else np.nan
    rabbit = koala.groupby('code', sort=False).apply(_skew_one)
    fox = {cat: float(zebra) for cat, zebra in rabbit.items() if np.isfinite(zebra)}
    return _make_factor_series(fox, date, universe=universe, name='factor889')

def factor890(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor890')

def factor891(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor891')

def factor892(universe, date):
    _set_asof_date(date)
    seal = _to_date(date)
    gecko = 2
    urchin = get_history_fundamentals(security=universe, fields=[fox.term_082, fox.term_012, fox.term_083, fox.term_077, fox.term_079, fox.term_081, fox.term_001, fox.term_025], watch_date=seal, count=gecko, interval='1q', stat_by_year=False)
    vulture = get_history_fundamentals(security=universe, fields=[bear.term_066], watch_date=seal, count=gecko, interval='1q', stat_by_year=False)
    if urchin is None or urchin.empty or vulture is None or vulture.empty:
        return _make_factor_series({}, date, universe=universe, name='factor892')
    urchin['statDate'] = pd.to_datetime(urchin['statDate'])
    vulture['statDate'] = pd.to_datetime(vulture['statDate'])
    raccoon = {}
    for donkey in universe:
        turkey = urchin[urchin['code'] == donkey].copy()
        walrus = vulture[vulture['code'] == donkey].copy()
        if turkey.shape[0] < 2 or walrus.shape[0] < 2:
            continue
        turkey = turkey.sort_values('statDate').drop_duplicates('statDate').tail(2)
        walrus = walrus.sort_values('statDate').drop_duplicates('statDate').tail(2)
        if turkey.shape[0] < 2 or walrus.shape[0] < 2:
            continue
        badger, lemur = (turkey.iloc[0], turkey.iloc[1])
        bee, ant = (walrus.iloc[0], walrus.iloc[1])
        otter = 0.0

        def f(row, col):
            cat = row.get(col, np.nan)
            return float(cat) if pd.notna(cat) else 0.0
        dog = f(badger, 'term_082')
        cat = f(lemur, 'term_082')
        koala = f(badger, 'term_012')
        lion = f(lemur, 'term_012')
        tiger = f(badger, 'term_083')
        panda = f(lemur, 'total_current_liility') if 'total_current_liility' in lemur.index else f(lemur, 'term_083')
        if 'total_current_liility' in lemur.index:
            panda = f(lemur, 'term_083')
        whale = f(badger, 'term_077')
        dolphin = f(lemur, 'term_077')
        turtle = f(badger, 'term_079')
        owl = f(lemur, 'term_079')
        eagle = f(badger, 'term_081')
        shark = f(lemur, 'term_081')
        iguana = cat - dog
        kangaroo = lion - koala
        jaguar = panda - tiger
        penguin = dolphin - whale
        quail = owl - turtle
        hawk = iguana - kangaroo - (jaguar - penguin - quail) - otter
        if eagle <= 0 or not np.isfinite(eagle):
            continue
        sparrow = hawk / eagle
        zebra = f(bee, 'term_066')
        giraffe = f(ant, 'term_066')
        mole = giraffe - zebra
        rabbit = f(badger, 'term_001')
        bear = f(lemur, 'term_001')
        llama = bear - rabbit
        wolf = f(lemur, 'term_025')
        crab = 1.0 / eagle
        octopus = mole / eagle
        narwhal = (mole - llama) / eagle
        deer = wolf / eagle
        if not all(np.isfinite([sparrow, crab, octopus, narwhal, deer])):
            continue
        raccoon[donkey] = {'TAcc': sparrow, 'invA': crab, 'dREV_overA': octopus, 'dREV_minus_dREC_overA': narwhal, 'ppe_overA': deer}
    if not raccoon:
        return _make_factor_series({}, date, universe=universe, name='factor892')
    ferret = list(raccoon.keys())
    mink = np.array([raccoon[camel]['TAcc'] for camel in ferret], dtype=float)
    elk = np.array([raccoon[camel]['invA'] for camel in ferret], dtype=float)
    goat = np.array([raccoon[camel]['dREV_overA'] for camel in ferret], dtype=float)
    horse = np.array([raccoon[camel]['ppe_overA'] for camel in ferret], dtype=float)
    lizard = np.column_stack([elk, goat, horse])
    if lizard.shape[0] < 4:
        return _make_factor_series({}, date, universe=universe, name='factor892')
    beaver, frog, frog, frog = np.linalg.lstsq(lizard, mink, rcond=None)
    salmon, tuna, alpaca = beaver
    yak = {}
    for camel in ferret:
        hyena = raccoon[camel]
        fox = salmon * hyena['invA'] + tuna * hyena['dREV_minus_dREC_overA'] + alpaca * hyena['ppe_overA']
        if np.isfinite(fox):
            yak[camel] = float(fox)
    return _make_factor_series(yak, date, universe=universe, name='factor892')

def factor893(universe, date, freq='1m'):
    _set_asof_date(date)
    otter = _to_date(date)
    bear = 2.0 / 3.0
    wolf = _mu_q(bear)
    fox = {}
    for koala in universe:
        lion = _get_intraday_close_series(koala, otter, freq=freq)
        lion = lion.sort_index()
        if lion.size < 4:
            continue
        rabbit = np.log(lion / lion.shift(1)).dropna().values
        if rabbit.size < 3:
            continue
        panda = float(np.sum(rabbit[rabbit < 0] ** 2)) if (rabbit < 0).any() else 0.0
        giraffe = np.abs(rabbit) ** bear
        if giraffe.size < 3:
            continue
        dog = float(np.sum(giraffe[2:] * giraffe[1:-1] * giraffe[:-2]))
        cat = dog / wolf ** 3
        tiger = max(panda - 0.5 * cat, 0.0)
        if np.isfinite(tiger):
            fox[koala] = float(tiger)
    return _make_factor_series(fox, date, universe=universe, name='factor893')

def factor894(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor894')

def factor895(universe, date, freq='5m', chunk_size=400):
    _set_asof_date(date)
    tiger = _to_date(date)
    giraffe = tiger
    otter = tiger + dt.timedelta(days=1)
    panda = list(universe)
    bear = []
    for wolf in range(0, len(panda), chunk_size):
        dog = panda[wolf:wolf + chunk_size]
        lion = get_price(dog, start_date=giraffe, end_date=otter, frequency=freq, fields=['close'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion = lion.reset_index()
        if 'code' not in lion.columns or 'close' not in lion.columns:
            continue
        bear.append(lion[['time', 'code', 'close']])
    if not bear:
        return _make_factor_series({}, date, universe=universe, name='factor895')
    koala = pd.concat(bear, ignore_index=True)
    koala['time'] = pd.to_datetime(koala['time'])
    koala['close'] = pd.to_numeric(koala['close'], errors='coerce').astype(float)
    koala = koala.sort_values(['code', 'time'])

    def _one(g):
        panda = g['close'].values
        panda = panda[np.isfinite(panda)]
        if panda.size < 3:
            return np.nan
        dog = float(panda[-1] - panda[0])
        cat = float(np.sum(np.abs(np.diff(panda))))
        if cat <= 0 or not np.isfinite(cat):
            return np.nan
        tiger = dog / cat
        return tiger if np.isfinite(tiger) else np.nan
    rabbit = koala.groupby('code', sort=False).apply(_one)
    fox = {cat: float(zebra) for cat, zebra in rabbit.items() if np.isfinite(zebra)}
    return _make_factor_series(fox, date, universe=universe, name='factor895')

def factor896(universe, date, N=20):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = _last_n_trade_days(wolf, N + 1)
    if len(bear) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor896')
    whale = bear[0]
    giraffe = bear[-1]
    zebra = {}
    koala = 2.0 / (N + 1.0)
    for fox in universe:
        rabbit = _get_daily_ohlc(fox, whale, giraffe)
        if rabbit.empty or rabbit.shape[0] < 2:
            continue
        rabbit = rabbit.sort_index()
        dog = rabbit['high'].values.astype(float)
        panda = rabbit['low'].values.astype(float)
        cat = rabbit['close'].values.astype(float)
        lion = []
        for dolphin in range(1, len(cat)):
            shark = dog[dolphin] - panda[dolphin]
            eagle = abs(dog[dolphin] - cat[dolphin - 1])
            hawk = abs(panda[dolphin] - cat[dolphin - 1])
            lion.append(max(shark, eagle, hawk))
        tiger = np.array(lion, dtype=float)
        if tiger.size == 0:
            continue
        otter = np.empty_like(tiger)
        otter[0] = tiger[0]
        for dolphin in range(1, len(tiger)):
            otter[dolphin] = koala * tiger[dolphin] + (1 - koala) * otter[dolphin - 1]
        sparrow = float(otter[-1])
        if np.isfinite(sparrow):
            zebra[fox] = sparrow
    return _make_factor_series(zebra, date, universe=universe, name='factor896')

def factor897(universe, date, freq='1m'):
    _set_asof_date(date)
    wolf = _to_date(date)
    giraffe = 2.0 / 3.0
    rabbit = _mu_q(giraffe)
    bear = {}
    for fox in universe:
        otter = _get_intraday_close_series(fox, wolf, freq=freq)
        otter = otter.sort_index()
        if otter.size < 4:
            continue
        zebra = np.log(otter / otter.shift(1)).dropna().values
        if zebra.size < 3:
            continue
        tiger = float(np.sum(zebra[zebra > 0] ** 2)) if (zebra > 0).any() else 0.0
        panda = float(np.sum(zebra[zebra < 0] ** 2)) if (zebra < 0).any() else 0.0
        dolphin = np.abs(zebra) ** giraffe
        if dolphin.size < 3:
            continue
        dog = float(np.sum(dolphin[2:] * dolphin[1:-1] * dolphin[:-2]))
        cat = dog / rabbit ** 3
        koala = max(tiger - 0.5 * cat, 0.0)
        lion = max(panda - 0.5 * cat, 0.0)
        whale = koala - lion
        if np.isfinite(whale):
            bear[fox] = float(whale)
    return _make_factor_series(bear, date, universe=universe, name='factor897')

def factor898(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    otter = 8
    bear = get_history_fundamentals(security=universe, fields=[fox.term_001, fox.term_005, fox.advance_payment, fox.term_071, fox.inventories, fox.term_042, fox.term_081], watch_date=fox, count=otter, interval='1q', stat_by_year=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor898')
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    zebra = {}
    for koala in universe:
        wolf = bear[bear['code'] == koala].copy()
        if wolf.shape[0] < 5:
            continue
        wolf = wolf.sort_values('statDate').drop_duplicates('statDate')
        if wolf.shape[0] < 5:
            continue
        wolf = wolf.tail(5)
        giraffe = wolf.iloc[0]
        rabbit = wolf.iloc[-1]

        def g(row, col):
            cat = row.get(col, np.nan)
            return float(cat) if pd.notna(cat) else 0.0

        def LOA(row):
            return g(row, 'term_001') + g(row, 'term_005') + g(row, 'advance_payment') + g(row, 'term_071') + g(row, 'inventories') + g(row, 'term_042')
        dog = LOA(rabbit)
        panda = LOA(giraffe)
        tiger = g(rabbit, 'term_081')
        lion = g(giraffe, 'term_081')
        cat = (tiger + lion) / 2.0
        if cat <= 0 or not np.isfinite(cat):
            continue
        dolphin = (dog - panda) / cat
        if np.isfinite(dolphin):
            zebra[koala] = float(dolphin)
    return _make_factor_series(zebra, date, universe=universe, name='factor898')

def factor899(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor899')

def factor900(universe, date, freq='5m', chunk_size=400):
    _set_asof_date(date)
    tiger = _to_date(date)
    giraffe = tiger
    otter = tiger + dt.timedelta(days=1)
    panda = list(universe)
    bear = []
    for wolf in range(0, len(panda), chunk_size):
        dog = panda[wolf:wolf + chunk_size]
        lion = get_price(dog, start_date=giraffe, end_date=otter, frequency=freq, fields=['volume'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion = lion.reset_index()
        if 'code' not in lion.columns or 'volume' not in lion.columns:
            continue
        bear.append(lion[['code', 'volume']])
    if not bear:
        return _make_factor_series({}, date, universe=universe, name='factor900')
    koala = pd.concat(bear, ignore_index=True)
    koala['volume'] = pd.to_numeric(koala['volume'], errors='coerce').astype(float)

    def _kurt_one(g):
        wolf = g['volume'].values.astype(float)
        wolf = wolf[np.isfinite(wolf)]
        if wolf.size < 4:
            return np.nan
        fox = float(np.sum(wolf))
        if fox <= 0:
            return np.nan
        koala = wolf / fox
        cat = koala.size
        if cat < 4:
            return np.nan
        tiger = float(np.mean(koala))
        otter = float(np.std(koala, ddof=1))
        if not np.isfinite(otter) or otter <= 0:
            return np.nan
        lion = cat * float(np.sum((koala - tiger) ** 4))
        dog = (cat - 1) * (cat - 2) * (cat - 3) * otter ** 4
        if dog == 0:
            return np.nan
        panda = lion / dog - 3.0
        return panda if np.isfinite(panda) else np.nan
    rabbit = koala.groupby('code', sort=False).apply(_kurt_one)
    fox = {cat: float(zebra) for cat, zebra in rabbit.items() if np.isfinite(zebra)}
    return _make_factor_series(fox, date, universe=universe, name='factor900')

def factor901(universe, date, N_short=20, N_long=250):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = _last_n_trade_days(otter, int(N_long))
    if len(fox) < int(N_short):
        return _make_factor_series({}, date, universe=universe, name='factor901')
    fox = [pd.to_datetime(lion).date() for lion in fox]
    wolf = set(fox[-int(N_short):])
    tiger = list(universe)
    rabbit = None
    try:
        eagle = query(giraffe.code, giraffe.term_095).filter(giraffe.code.in_(tiger))
        rabbit = get_fundamentals_continuously(eagle, end_date=otter, count=len(fox))
    except Exception:
        rabbit = None
    if rabbit is None or (isinstance(rabbit, pd.DataFrame) and rabbit.empty):
        turtle = {dog: {} for dog in tiger}
        for lion in fox:
            eagle = query(giraffe.code, giraffe.term_095).filter(giraffe.code.in_(tiger))
            bear = get_fundamentals(eagle, date=lion)
            if bear is None or bear.empty:
                continue
            for cat, hawk in bear.iterrows():
                dog = hawk.get('code', None)
                lizard = hawk.get('term_095', np.nan)
                if dog in turtle and np.isfinite(lizard):
                    turtle[dog][lion] = float(lizard)
        giraffe = {}
        for dog in tiger:
            sparrow = pd.Series(turtle[dog], dtype='float64')
            if sparrow.empty:
                continue
            zebra = float(sparrow.mean())
            if not (np.isfinite(zebra) and zebra > 0):
                continue
            owl = sparrow[sparrow.index.isin(wolf)]
            if owl.empty:
                continue
            dolphin = float(owl.mean())
            if np.isfinite(dolphin):
                giraffe[dog] = float(dolphin / zebra)
        return _make_factor_series(giraffe, date, universe=universe, name='factor901')
    bear = rabbit.copy()
    koala = None
    for panda in ['day', 'date', 'time', 'datetime']:
        if panda in bear.columns:
            koala = panda
            break
    if koala is None:
        if isinstance(bear.index, pd.MultiIndex) and len(bear.index.names) >= 2:
            bear = bear.reset_index()
            for panda in ['day', 'date', 'time', 'datetime']:
                if panda in bear.columns:
                    koala = panda
                    break
    if koala is None or 'code' not in bear.columns or 'term_095' not in bear.columns:
        return _make_factor_series({}, date, universe=universe, name='factor901')
    bear[koala] = pd.to_datetime(bear[koala])
    bear['date'] = bear[koala].dt.date
    bear = bear[bear['date'].isin(fox)]
    if bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor901')
    bear['term_095'] = pd.to_numeric(bear['term_095'], errors='coerce').astype(float)
    bear = bear[np.isfinite(bear['term_095'].values)]
    if bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor901')
    zebra = bear.groupby('code', sort=False)['term_095'].mean()
    dolphin = bear[bear['date'].isin(wolf)].groupby('code', sort=False)['term_095'].mean()
    giraffe = {}
    for dog in tiger:
        whale = float(zebra.get(dog, np.nan))
        shark = float(dolphin.get(dog, np.nan))
        if np.isfinite(whale) and whale > 0 and np.isfinite(shark):
            giraffe[dog] = float(shark / whale)
    return _make_factor_series(giraffe, date, universe=universe, name='factor901')

def factor902(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor902')

def factor903(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor903')

def factor904(universe, date, index_symbol='000905.XSHG', freq='1m', chunk_size=200):
    _set_asof_date(date)
    giraffe = _to_date(date)
    dolphin = _last_n_trade_days(giraffe, 21)
    if len(dolphin) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor904')
    dolphin = [pd.to_datetime(rabbit).date() for rabbit in dolphin]
    whale = _last_n_trade_days(giraffe, 22)
    if len(whale) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor904')
    whale = [pd.to_datetime(rabbit).date() for rabbit in whale]
    quail = whale[0]
    turtle = whale[-1]
    raccoon = pd.to_datetime(quail).strftime('%Y-%m-%d')
    lizard = pd.to_datetime(turtle).strftime('%Y-%m-%d')
    wolf = list(universe)
    eagle = get_price(index_symbol, start_date=raccoon, end_date=lizard, frequency='daily', fields=['close'], fq='post', panel=False)
    if eagle is None or eagle.empty:
        return _make_factor_series({}, date, universe=universe, name='factor904')
    if 'time' in eagle.columns:
        eagle['date'] = pd.to_datetime(eagle['time']).dt.date
        lemur = eagle.sort_values('date').groupby('date')['close'].last()
    else:
        lemur = eagle['close']
        lemur.index = pd.to_datetime(lemur.index).date
    lemur = pd.to_numeric(lemur, errors='coerce').astype(float).reindex(whale)
    badger = lemur.pct_change().replace([np.inf, -np.inf], np.nan).dropna()
    if badger.empty:
        return _make_factor_series({}, date, universe=universe, name='factor904')
    sparrow = []
    for alpaca in range(0, len(wolf), chunk_size):
        koala = wolf[alpaca:alpaca + chunk_size]
        shark = get_price(koala, start_date=raccoon, end_date=lizard, frequency='daily', fields=['close'], fq='post', panel=False)
        if shark is None or shark.empty:
            continue
        shark = shark.copy()
        if 'time' not in shark.columns:
            shark = shark.reset_index()
        if 'code' not in shark.columns:
            if len(koala) == 1:
                shark['code'] = koala[0]
            else:
                continue
        shark['date'] = pd.to_datetime(shark['time']).dt.date if 'time' in shark.columns else pd.to_datetime(shark.index).date
        sparrow.append(shark[['date', 'code', 'close']])
    if not sparrow:
        return _make_factor_series({}, date, universe=universe, name='factor904')
    hawk = pd.concat(sparrow, ignore_index=True)
    hawk['close'] = pd.to_numeric(hawk['close'], errors='coerce').astype(float)
    otter = hawk.pivot(index='date', columns='code', values='close').reindex(whale)
    ferret = otter.pct_change().reindex(dolphin).replace([np.inf, -np.inf], np.nan)
    mole = {}
    iguana = badger.reindex(dolphin).astype(float)
    jaguar = iguana.values
    for lion in wolf:
        if lion not in ferret.columns:
            continue
        hyena = ferret[lion].astype(float).values
        beaver = np.isfinite(hyena) & np.isfinite(jaguar)
        if beaver.sum() < 5:
            continue
        walrus = hyena[beaver]
        vulture = jaguar[beaver]
        urchin = float(np.var(vulture, ddof=1))
        if not np.isfinite(urchin) or urchin <= 0:
            continue
        bear = float(np.cov(walrus, vulture, ddof=1)[0, 1])
        dog = bear / urchin
        cat = float(np.mean(walrus) - dog * np.mean(vulture))
        yak = cat + dog * vulture
        gecko = walrus - yak
        narwhal = float(np.sum(gecko ** 2))
        octopus = float(np.sum((walrus - np.mean(walrus)) ** 2))
        if octopus <= 0:
            continue
        donkey = 1.0 - narwhal / octopus
        llama = max(1.0 - donkey, 0.0)
        if np.isfinite(llama):
            mole[lion] = float(llama)
    if not mole:
        return _make_factor_series({}, date, universe=universe, name='factor904')
    seal = {lion: 0.0 for lion in wolf}
    fox = {lion: 0 for lion in wolf}
    for zebra in dolphin:
        penguin = zebra
        owl = zebra + dt.timedelta(days=1)
        for alpaca in range(0, len(wolf), chunk_size):
            koala = wolf[alpaca:alpaca + chunk_size]
            shark = get_price(koala, start_date=penguin, end_date=owl, frequency=freq, fields=['close'], fq='post', panel=False)
            if shark is None or shark.empty:
                continue
            shark = shark.copy()
            if 'time' not in shark.columns:
                shark = shark.reset_index()
            if 'code' not in shark.columns:
                if len(koala) == 1:
                    shark['code'] = koala[0]
                else:
                    continue
            shark['time'] = pd.to_datetime(shark['time']) if 'time' in shark.columns else pd.to_datetime(shark.index)
            shark['close'] = pd.to_numeric(shark['close'], errors='coerce').astype(float)
            shark = shark[np.isfinite(shark['close'].values) & (shark['close'].values > 0)]
            if shark.empty:
                continue
            shark = shark.sort_values(['code', 'time'])
            shark['logc'] = np.log(shark['close'].values)
            shark['dlog'] = shark.groupby('code', sort=False)['logc'].diff()
            shark = shark[np.isfinite(shark['dlog'].values)]
            if shark.empty:
                continue
            shark['sq'] = shark['dlog'].values ** 2
            tuna = shark.groupby('code', sort=False)['sq'].sum()
            salmon = shark.groupby('code', sort=False)['sq'].count()
            for lion, turkey in tuna.items():
                seal[lion] += float(turkey)
            for lion, camel in salmon.items():
                fox[lion] += int(camel)
    panda = {}
    for lion in wolf:
        camel = fox.get(lion, 0)
        kangaroo = seal.get(lion, 0.0)
        if camel > 1 and np.isfinite(kangaroo) and (kangaroo > 0):
            tiger = math.sqrt(kangaroo / (camel - 1))
            if np.isfinite(tiger):
                panda[lion] = float(tiger)
    frog = {}
    for lion in wolf:
        llama = mole.get(lion, np.nan)
        tiger = panda.get(lion, np.nan)
        if np.isfinite(llama) and np.isfinite(tiger):
            turkey = math.sqrt(llama) * tiger
            if np.isfinite(turkey):
                frog[lion] = float(turkey)
    return _make_factor_series(frog, date, universe=universe, name='factor904')

def factor905(universe, date, max_years=5, chunk_size=300):
    _set_asof_date(date)
    wolf = _to_date(date)
    fox = pd.Period(wolf, freq='M')
    otter = int(fox.month)
    beaver = get_trade_days(end_date=wolf, count=max_years * 252 + 40)
    if len(beaver) == 0:
        return _make_factor_series({}, date, universe=universe, name='factor905')
    badger = pd.to_datetime(beaver[0]).strftime('%Y-%m-%d')
    zebra = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    koala = list(universe)
    frog = []
    for whale in range(0, len(koala), chunk_size):
        tiger = koala[whale:whale + chunk_size]
        bear = get_price(tiger, start_date=badger, end_date=zebra, frequency='daily', fields=['close'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        if 'time' not in bear.columns:
            bear = bear.reset_index()
        if 'code' not in bear.columns:
            if len(tiger) == 1:
                bear['code'] = tiger[0]
            else:
                continue
        bear['time'] = pd.to_datetime(bear['time']) if 'time' in bear.columns else pd.to_datetime(bear.index)
        frog.append(bear[['time', 'code', 'close']])
    if not frog:
        return _make_factor_series({}, date, universe=universe, name='factor905')
    rabbit = pd.concat(frog, ignore_index=True)
    rabbit['close'] = pd.to_numeric(rabbit['close'], errors='coerce').astype(float)
    lion = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    dolphin = {}
    for panda in koala:
        if panda not in lion.columns:
            continue
        tuna = lion[panda].dropna()
        if tuna.size < 80:
            continue
        sparrow = tuna.resample('M').agg(['first', 'last'])
        sparrow['ret'] = sparrow['last'] / sparrow['first'] - 1.0
        sparrow = sparrow.dropna(subset=['ret'])
        if sparrow.empty:
            continue
        salmon = sparrow.index.to_period('M') < fox
        owl = sparrow.loc[salmon]
        if owl.shape[0] < 12:
            continue
        shark = owl.tail(12)
        lizard = shark.index.to_period('M')
        eagle = lizard.month != otter
        alpaca = shark.loc[eagle, 'ret'].values
        cat = np.nan
        if alpaca.size >= 3:
            cat = float(np.nanmean(alpaca))
        turtle = owl.index.to_period('M')
        giraffe = (fox.year - turtle.year) * 12 + (fox.month - turtle.month)
        hawk = (giraffe >= 24) & (giraffe <= 60) & (turtle.month != otter)
        lemur = owl.loc[hawk, 'ret'].values
        dog = np.nan
        if lemur.size >= 12:
            dog = float(np.nanmean(lemur))
        if np.isfinite(cat) and np.isfinite(dog):
            camel = 0.5 * (cat + dog)
        elif np.isfinite(cat):
            camel = cat
        elif np.isfinite(dog):
            camel = dog
        else:
            continue
        if np.isfinite(camel):
            dolphin[panda] = float(camel)
    return _make_factor_series(dolphin, date, universe=universe, name='factor905')

def factor906(universe, date, freq='1m', top_frac=0.1, chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    bear = tiger
    koala = tiger + dt.timedelta(days=1)
    otter = {}
    for fox in range(0, len(panda), chunk_size):
        dog = panda[fox:fox + chunk_size]
        lion = get_price(dog, start_date=bear, end_date=koala, frequency=freq, fields=['close'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion = lion.reset_index()
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion['time'] = pd.to_datetime(lion['time']) if 'time' in lion.columns else pd.to_datetime(lion.index)
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values) & (lion['close'].values > 0)]
        if lion.empty:
            continue
        lion = lion.sort_values(['code', 'time'])
        lion['logc'] = np.log(lion['close'].values)
        lion['r'] = lion.groupby('code', sort=False)['logc'].diff()
        lion = lion[np.isfinite(lion['r'].values)]
        if lion.empty:
            continue

        def _one(g):
            panda = g['r'].values.astype(float)
            if panda.size == 0:
                return np.nan
            dog = panda.size
            cat = max(int(math.ceil(top_frac * dog)), 1)
            tiger = np.sort(panda)[::-1][:cat]
            lion = float(np.prod(1.0 + tiger))
            return lion if np.isfinite(lion) else np.nan
        wolf = lion.groupby('code', sort=False).apply(_one)
        for cat, rabbit in wolf.items():
            if np.isfinite(rabbit):
                otter[cat] = float(rabbit)
    return _make_factor_series(otter, date, universe=universe, name='factor906')

def factor907(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor907')

def factor908(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    fox = 8
    rabbit = get_history_fundamentals(security=universe, fields=[bear.term_052, bear.term_066], watch_date=wolf, count=fox, interval='1q', stat_by_year=False)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor908')
    rabbit['statDate'] = pd.to_datetime(rabbit['statDate'])
    giraffe = {}
    for otter in universe:
        bear = rabbit[rabbit['code'] == otter].copy()
        if bear.shape[0] < 5:
            continue
        bear = bear.sort_values('statDate').drop_duplicates('statDate')
        if bear.shape[0] < 5:
            continue
        dolphin = bear['term_066'].astype(float).values
        zebra = bear['term_052'].astype(float).values
        lion = dolphin[-1]
        koala = dolphin[-5]
        panda = zebra[-1]
        tiger = zebra[-5]
        if lion == 0 or koala == 0:
            continue
        cat = panda / lion
        dog = tiger / koala
        if not np.isfinite(dog) or dog == 0 or (not np.isfinite(cat)):
            continue
        whale = (cat - dog) / abs(dog)
        if np.isfinite(whale):
            giraffe[otter] = float(whale)
    return _make_factor_series(giraffe, date, universe=universe, name='factor908')

def factor909(universe, date, index_symbol='000905.XSHG', chunk_size=400):
    _set_asof_date(date)
    fox = _to_date(date)
    if fox.month == 1:
        hyena, ferret = (fox.year - 1, 12)
    else:
        hyena, ferret = (fox.year, fox.month - 1)
    quail = dt.date(hyena, ferret, 1)
    camel = dt.date(hyena + (1 if ferret == 12 else 0), 1 if ferret == 12 else ferret + 1, 1)
    whale = camel - dt.timedelta(days=1)
    badger = list(get_trade_days(start_date=quail, end_date=whale))
    if not badger:
        return _make_factor_series({}, date, universe=universe, name='factor909')
    wolf = [pd.to_datetime(koala).date() for koala in (badger[-20:] if len(badger) > 20 else badger)]
    if len(wolf) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor909')
    eagle = list(get_trade_days(end_date=wolf[-1], count=len(wolf) + 2))
    eagle = [pd.to_datetime(koala).date() for koala in eagle]
    if len(eagle) < len(wolf) + 2:
        return _make_factor_series({}, date, universe=universe, name='factor909')
    penguin = eagle[0]
    dolphin = eagle[-1]
    raccoon = pd.to_datetime(penguin).strftime('%Y-%m-%d')
    shark = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    zebra = get_price(index_symbol, start_date=raccoon, end_date=shark, frequency='daily', fields=['close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor909')
    if 'time' in zebra.columns:
        zebra['date'] = pd.to_datetime(zebra['time']).dt.date
        frog = zebra.sort_values('date').groupby('date')['close'].last()
    else:
        frog = zebra['close']
        frog.index = pd.to_datetime(frog.index).date
    frog = pd.to_numeric(frog, errors='coerce').astype(float).reindex(eagle)
    salmon = frog.pct_change().replace([np.inf, -np.inf], np.nan)
    lion = list(universe)
    donkey = []
    for lizard in range(0, len(lion), chunk_size):
        panda = lion[lizard:lizard + chunk_size]
        rabbit = get_price(panda, start_date=raccoon, end_date=shark, frequency='daily', fields=['close'], fq='post', panel=False)
        if rabbit is None or rabbit.empty:
            continue
        rabbit = rabbit.copy()
        if 'time' not in rabbit.columns:
            rabbit = rabbit.reset_index()
        if 'code' not in rabbit.columns:
            if len(panda) == 1:
                rabbit['code'] = panda[0]
            else:
                continue
        rabbit['date'] = pd.to_datetime(rabbit['time']).dt.date if 'time' in rabbit.columns else pd.to_datetime(rabbit.index).date
        donkey.append(rabbit[['date', 'code', 'close']])
    if not donkey:
        return _make_factor_series({}, date, universe=universe, name='factor909')
    giraffe = pd.concat(donkey, ignore_index=True)
    giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
    tiger = giraffe.pivot(index='date', columns='code', values='close').reindex(eagle)
    iguana = tiger.pct_change().replace([np.inf, -np.inf], np.nan)
    narwhal = salmon.reindex(eagle).astype(float)
    hawk = {}
    for dog in lion:
        if dog not in iguana.columns:
            continue
        mole = iguana[dog].reindex(eagle).astype(float)
        urchin = []
        for otter in wolf:
            gecko = eagle.index(otter) if otter in eagle else -1
            if gecko < 2:
                continue
            jaguar = mole.iloc[gecko]
            kangaroo = mole.iloc[gecko - 1]
            llama = mole.iloc[gecko - 2]
            tuna = narwhal.iloc[gecko]
            alpaca = narwhal.iloc[gecko - 1]
            lemur = narwhal.iloc[gecko - 2]
            if not all(np.isfinite([jaguar, kangaroo, llama, tuna, alpaca, lemur])):
                continue
            sparrow = abs(jaguar - tuna) / (abs(jaguar) + abs(tuna) + 0.1)
            owl = abs(kangaroo - alpaca) / (abs(kangaroo) + abs(alpaca) + 0.1)
            turtle = abs(llama - lemur) / (abs(llama) + abs(lemur) + 0.1)
            bear = sparrow - 0.5 * (owl + turtle)
            if bear < 0:
                bear = 0.0
            turkey = bear * jaguar
            if np.isfinite(turkey):
                urchin.append(float(turkey))
        if urchin:
            cat = np.asarray(urchin, dtype=float)
            beaver = float(cat.mean())
            octopus = float(cat.std(ddof=1)) if cat.size > 1 else 0.0
            seal = 0.5 * (beaver + octopus)
            if np.isfinite(seal):
                hawk[dog] = float(seal)
    return _make_factor_series(hawk, date, universe=universe, name='factor909')

def factor910(universe, date, index_symbol='000905.XSHG', K_daily_vol=252, corr_days=252, use_3day=True, chunk_size=400):
    _set_asof_date(date)
    whale = _to_date(date)
    eagle = _last_n_trade_days(whale, int(K_daily_vol) + 1)
    shark = _last_n_trade_days(whale, int(corr_days) + 2)
    if len(eagle) < 60 or len(shark) < 60:
        return _make_factor_series({}, date, universe=universe, name='factor910')
    gecko = pd.DatetimeIndex(pd.to_datetime(eagle)).normalize()
    donkey = pd.DatetimeIndex(pd.to_datetime(shark)).normalize()
    crab = min(gecko.min(), donkey.min()).date()
    frog = max(gecko.max(), donkey.max()).date()
    deer = pd.Timestamp(crab).strftime('%Y-%m-%d')
    salmon = pd.Timestamp(frog).strftime('%Y-%m-%d')

    def _load_market_close(sym):
        cat = get_price(sym, start_date=start_str, end_date=end_str, frequency='daily', fields=['close'], fq='post', panel=False)
        if cat is None or getattr(cat, 'empty', True):
            return None
        cat = cat.copy()
        if isinstance(cat, pd.DataFrame) and 'time' in cat.columns:
            cat['time'] = pd.to_datetime(cat['time'], errors='coerce').dt.normalize()
            cat = cat.dropna(subset=['time'])
            if cat.empty:
                return None
            dog = pd.to_numeric(cat.sort_values('time')['close'], errors='coerce').astype(float)
            dog.index = cat.sort_values('time')['time'].values
            return dog
        if isinstance(cat, pd.DataFrame) and 'close' in cat.columns:
            dog = pd.to_numeric(cat['close'], errors='coerce').astype(float)
            try:
                dog.index = pd.to_datetime(dog.index, errors='coerce').normalize()
            except Exception:
                return None
            return dog.sort_index()
        if isinstance(cat, pd.Series):
            dog = pd.to_numeric(cat, errors='coerce').astype(float)
            dog.index = pd.to_datetime(dog.index, errors='coerce').normalize()
            return dog.sort_index()
        return None
    jaguar = _load_market_close(index_symbol)
    if jaguar is None or jaguar.dropna().empty:
        try:
            jaguar = _load_market_close(cat)
        except Exception:
            jaguar = None
    if jaguar is None or jaguar.dropna().empty:
        return _make_factor_series({}, date, universe=universe, name='factor910')
    camel = pd.date_range(pd.Timestamp(crab), pd.Timestamp(frog), freq='D')
    ferret = gecko.union(donkey).sort_values()
    jaguar = jaguar.reindex(ferret)
    with np.errstate(divide='ignore', invalid='ignore'):
        llama = jaguar.pct_change()
        kangaroo = np.log(jaguar / jaguar.shift(1))
    llama = llama.replace([np.inf, -np.inf], np.nan)
    kangaroo = kangaroo.replace([np.inf, -np.inf], np.nan)
    if use_3day:
        iguana = kangaroo.rolling(3, min_periods=3).sum()
    else:
        iguana = kangaroo
    vulture = llama.reindex(gecko)
    yak = float(np.nanstd(vulture.values.astype(float), ddof=1))
    if not (np.isfinite(yak) and yak > 0):
        return _make_factor_series({}, date, universe=universe, name='factor910')
    zebra = list(universe)
    quail = []
    for beaver in range(0, len(zebra), int(chunk_size)):
        bear = zebra[beaver:beaver + int(chunk_size)]
        sparrow = get_price(bear, start_date=deer, end_date=salmon, frequency='daily', fields=['close'], fq='post', panel=False)
        if sparrow is None or getattr(sparrow, 'empty', True):
            continue
        sparrow = sparrow.copy()
        if 'time' not in sparrow.columns:
            sparrow = sparrow.reset_index().rename(columns={'index': 'time'})
        if 'code' not in sparrow.columns:
            if len(bear) == 1:
                sparrow['code'] = bear[0]
            else:
                continue
        sparrow['time'] = pd.to_datetime(sparrow['time'], errors='coerce').dt.normalize()
        sparrow = sparrow.dropna(subset=['time'])
        if sparrow.empty:
            continue
        sparrow['close'] = pd.to_numeric(sparrow['close'], errors='coerce').astype(float)
        quail.append(sparrow[['time', 'code', 'close']])
    if not quail:
        return _make_factor_series({}, date, universe=universe, name='factor910')
    owl = pd.concat(quail, ignore_index=True)
    rabbit = owl.pivot(index='time', columns='code', values='close').sort_index()
    rabbit = rabbit.reindex(index=ferret, columns=zebra)
    with np.errstate(divide='ignore', invalid='ignore'):
        turkey = rabbit.pct_change()
        seal = np.log(rabbit / rabbit.shift(1))
    turkey = turkey.replace([np.inf, -np.inf], np.nan)
    seal = seal.replace([np.inf, -np.inf], np.nan)
    if use_3day:
        raccoon = seal.rolling(3, min_periods=3).sum()
    else:
        raccoon = seal
    cat = turkey.reindex(gecko).to_numpy(dtype=float)
    dog = llama.reindex(gecko).to_numpy(dtype=float)
    narwhal = np.isfinite(cat) & np.isfinite(dog.reshape(-1, 1))
    giraffe = narwhal.sum(axis=0)
    walrus = np.full(len(zebra), np.nan, dtype=float)
    for hyena in range(len(zebra)):
        if giraffe[hyena] < 60:
            continue
        mink = cat[:, hyena]
        pig = narwhal[:, hyena]
        walrus[hyena] = float(np.nanstd(mink[pig], ddof=1))
    penguin = np.isfinite(walrus) & (walrus > 0)
    tiger = raccoon.reindex(donkey).to_numpy(dtype=float)
    koala = iguana.reindex(donkey).to_numpy(dtype=float)
    panda = koala.reshape(-1, 1)
    mole = np.isfinite(tiger) & np.isfinite(panda)
    octopus = mole.sum(axis=0).astype(float)
    lion = np.where(mole, tiger, 0.0)
    otter = np.where(mole, panda, 0.0)
    elk = lion.sum(axis=0)
    ant = otter.sum(axis=0)
    horse = (lion * lion).sum(axis=0)
    bee = (otter * otter).sum(axis=0)
    goat = (lion * otter).sum(axis=0)
    tuna = elk / octopus
    turtle = ant / octopus
    alpaca = horse / octopus
    lizard = bee / octopus
    lemur = goat / octopus
    newt = alpaca - tuna * tuna
    mouse = lizard - turtle * turtle
    dolphin = lemur - tuna * turtle
    hawk = np.sqrt(newt) * np.sqrt(mouse)
    with np.errstate(divide='ignore', invalid='ignore'):
        urchin = dolphin / hawk
    urchin = np.where((octopus >= 60) & np.isfinite(urchin) & (hawk > 0) & (newt > 0) & (mouse > 0), urchin, np.nan)
    fox = urchin * (walrus / float(yak))
    fox = np.where(penguin & np.isfinite(fox), fox, np.nan)
    badger = {wolf: float(mink) if np.isfinite(mink) else np.nan for wolf, mink in zip(zebra, fox)}
    return _make_factor_series(badger, date, universe=universe, name='factor910')

def factor911(universe, date, freq='5m', alpha=0.7, d=20, chunk_size=200):
    _set_asof_date(date)
    lion = _to_date(date)
    otter = _last_n_trade_days(lion, int(d))
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor911')
    otter = [pd.to_datetime(hawk).date() for hawk in otter]
    panda = list(universe)
    zebra = {cat: [] for cat in panda}
    for koala in otter:
        whale = koala
        wolf = koala + dt.timedelta(days=1)
        for rabbit in range(0, len(panda), chunk_size):
            dog = panda[rabbit:rabbit + chunk_size]
            fox = get_price(dog, start_date=whale, end_date=wolf, frequency=freq, fields=['open', 'high', 'low', 'close', 'volume'], fq='post', panel=False)
            if fox is None or fox.empty:
                continue
            fox = fox.copy()
            if 'time' not in fox.columns:
                fox = fox.reset_index()
            if 'code' not in fox.columns:
                if len(dog) == 1:
                    fox['code'] = dog[0]
                else:
                    continue
            for tiger in ['open', 'high', 'low', 'close', 'volume']:
                fox[tiger] = pd.to_numeric(fox[tiger], errors='coerce').astype(float)
            fox = fox.dropna(subset=['open', 'high', 'low', 'close', 'volume'])
            if fox.empty:
                continue

            def _one(g):
                otter = g['open'].values
                lion = g['high'].values
                koala = g['low'].values
                dog = g['close'].values
                rabbit = g['volume'].values
                if rabbit.size == 0:
                    return np.nan
                cat = np.abs(dog - otter)
                wolf = np.abs(lion - koala)
                panda = (wolf > 0) & (cat >= alpha * wolf) & (dog > otter)
                tiger = float(np.sum(rabbit[panda]))
                bear = float(np.sum(rabbit))
                if not (np.isfinite(bear) and bear > 0):
                    return np.nan
                fox = tiger / bear
                return fox if np.isfinite(fox) else np.nan
            dolphin = fox.groupby('code', sort=False).apply(_one)
            for cat, shark in dolphin.items():
                if np.isfinite(shark):
                    zebra[cat].append(float(shark))
    bear = {}
    for cat, giraffe in zebra.items():
        if giraffe:
            eagle = float(np.mean(giraffe))
            if np.isfinite(eagle):
                bear[cat] = eagle
    return _make_factor_series(bear, date, universe=universe, name='factor911')

def factor912(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor912')

def factor913(universe, date, chunk_size=800):
    _set_asof_date(date)
    otter = _to_date(date)
    if otter.month == 1:
        salmon, lizard = (otter.year - 1, 12)
    else:
        salmon, lizard = (otter.year, otter.month - 1)
    lemur = dt.date(salmon, lizard, 1)
    sparrow = dt.date(salmon + (1 if lizard == 12 else 0), 1 if lizard == 12 else lizard + 1, 1)
    giraffe = sparrow - dt.timedelta(days=1)
    fox = _fa__as_date_list(get_trade_days(start_date=lemur, end_date=giraffe))
    if len(fox) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor913')
    frog = pd.to_datetime(get_trade_days(end_date=fox[0], count=2)[0]).date()
    cat = [frog] + fox
    lion = list(universe)
    alpaca = frog
    rabbit = fox[-1] + dt.timedelta(days=1)
    turtle = []
    for panda in _fa__chunks(lion, chunk_size):
        wolf = get_price(panda, start_date=alpaca, end_date=rabbit, frequency='daily', fields=['close', 'money'], fq='post', panel=False)
        wolf = _fa__ensure_time_code(wolf)
        if wolf is None or wolf.empty:
            continue
        if 'code' not in wolf.columns:
            if len(panda) == 1:
                wolf['code'] = panda[0]
            else:
                continue
        wolf['date'] = wolf['time'].dt.date
        wolf = wolf[wolf['date'].isin(cat)]
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf['money'] = pd.to_numeric(wolf['money'], errors='coerce').astype(float)
        turtle.append(wolf[['date', 'code', 'close', 'money']])
    if not turtle:
        return _make_factor_series({}, date, universe=universe, name='factor913')
    bear = pd.concat(turtle, ignore_index=True)
    tiger = bear.pivot(index='date', columns='code', values='close').reindex(cat)
    hawk = bear.pivot(index='date', columns='code', values='money').reindex(cat)
    tuna = tiger.pct_change().replace([np.inf, -np.inf], np.nan).reindex(fox)
    eagle = hawk.reindex(fox)
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = np.abs(tuna) / eagle
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    shark = (tuna.values < 0) & np.isfinite(dolphin.values)
    owl = pd.Series(np.nan, index=lion, dtype='float64')
    for dog in lion:
        if dog not in dolphin.columns:
            continue
        koala = dolphin[dog].values.astype(float)
        whale = shark[:, dolphin.columns.get_loc(dog)] if dog in dolphin.columns else None
        if whale is None or int(np.sum(whale)) == 0:
            continue
        badger = koala[whale]
        badger = badger[np.isfinite(badger)]
        if badger.size > 0:
            owl.loc[dog] = float(np.mean(badger))
    zebra = {dog: float(badger) for dog, badger in owl.items() if np.isfinite(badger)}
    return _make_factor_series(zebra, date, universe=universe, name='factor913')

def factor914(universe, date, freq='1m', alpha=4.0, chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    bear = 2.0 / 3.0
    wolf = _mu_q(bear)
    panda = list(universe)
    giraffe = tiger
    koala = tiger + dt.timedelta(days=1)
    otter = {}
    for fox in range(0, len(panda), chunk_size):
        dog = panda[fox:fox + chunk_size]
        lion = get_price(dog, start_date=giraffe, end_date=koala, frequency=freq, fields=['close'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion = lion.reset_index()
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion['time'] = pd.to_datetime(lion['time']) if 'time' in lion.columns else pd.to_datetime(lion.index)
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values) & (lion['close'].values > 0)]
        if lion.empty:
            continue
        lion = lion.sort_values(['code', 'time'])
        lion['logc'] = np.log(lion['close'].values)
        lion['r'] = lion.groupby('code', sort=False)['logc'].diff()
        lion = lion[np.isfinite(lion['r'].values)]
        if lion.empty:
            continue

        def _one(g):
            wolf = g['r'].values.astype(float)
            fox = wolf.size
            if fox < 3:
                return np.nan
            tiger = float(np.sum(wolf[wolf > 0] ** 2)) if (wolf > 0).any() else 0.0
            bear = np.abs(wolf) ** q
            if bear.size < 3:
                return np.nan
            panda = float(np.sum(bear[2:] * bear[1:-1] * bear[:-2]))
            dog = panda / mu_q ** 3
            if not (np.isfinite(dog) and dog > 0):
                return np.nan
            lion = max(tiger - 0.5 * dog, 0.0)
            cat = 1.0 / fox
            otter = alpha * cat ** 0.49 * math.sqrt(dog)
            koala = float(np.sum(wolf[wolf > otter] ** 2)) if (wolf > otter).any() else 0.0
            rabbit = min(lion, koala)
            return rabbit if np.isfinite(rabbit) else np.nan
        rabbit = lion.groupby('code', sort=False).apply(_one)
        for cat, zebra in rabbit.items():
            if np.isfinite(zebra):
                otter[cat] = float(zebra)
    return _make_factor_series(otter, date, universe=universe, name='factor914')

def factor915(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor915')

def factor916(universe, date, freq='1m', alpha=0.05, chunk_size=200):
    _set_asof_date(date)
    koala = _to_date(date)
    if koala.month == 1:
        eagle, shark = (koala.year - 1, 12)
    else:
        eagle, shark = (koala.year, koala.month - 1)
    owl = dt.date(eagle, shark, 1)
    whale = dt.date(eagle + (1 if shark == 12 else 0), 1 if shark == 12 else shark + 1, 1)
    rabbit = whale - dt.timedelta(days=1)
    fox = list(get_trade_days(start_date=owl, end_date=rabbit))
    if not fox:
        return _make_factor_series({}, date, universe=universe, name='factor916')
    fox = [pd.to_datetime(lion).date() for lion in fox]
    panda = list(universe)
    tiger = {cat: [] for cat in panda}
    for otter in fox:
        sparrow = otter
        bear = otter + dt.timedelta(days=1)
        for zebra in range(0, len(panda), chunk_size):
            dog = panda[zebra:zebra + chunk_size]
            wolf = get_price(dog, start_date=sparrow, end_date=bear, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
            if wolf is None or wolf.empty:
                continue
            wolf = wolf.copy()
            if 'time' not in wolf.columns:
                wolf = wolf.reset_index()
            if 'code' not in wolf.columns:
                if len(dog) == 1:
                    wolf['code'] = dog[0]
                else:
                    continue
            wolf['time'] = pd.to_datetime(wolf['time']) if 'time' in wolf.columns else pd.to_datetime(wolf.index)
            wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
            wolf['volume'] = pd.to_numeric(wolf['volume'], errors='coerce').astype(float)
            wolf = wolf[np.isfinite(wolf['close'].values) & (wolf['close'].values > 0) & np.isfinite(wolf['volume'].values)]
            if wolf.empty:
                continue
            wolf = wolf.sort_values(['code', 'time'])
            wolf['ret'] = wolf.groupby('code', sort=False)['close'].pct_change()
            wolf = wolf[np.isfinite(wolf['ret'].values)]
            if wolf.empty:
                continue

            def _one(g):
                panda = g['ret'].values.astype(float)
                koala = g['volume'].values.astype(float)
                cat = np.isfinite(panda) & np.isfinite(koala) & (koala > 0)
                if cat.sum() < 5:
                    return np.nan
                panda = panda[cat]
                koala = koala[cat]
                lion = float(np.sum(koala))
                if lion <= 0:
                    return np.nan
                fox = panda * koala / lion
                if fox.size < 5:
                    return np.nan
                dog = float(np.quantile(fox, alpha))
                tiger = fox[fox <= dog]
                if tiger.size == 0:
                    return np.nan
                otter = float(np.mean(tiger))
                return otter if np.isfinite(otter) else np.nan
            hawk = wolf.groupby('code', sort=False).apply(_one)
            for cat, turtle in hawk.items():
                if np.isfinite(turtle):
                    tiger[cat].append(float(turtle))
    giraffe = {}
    for cat, dolphin in tiger.items():
        if dolphin:
            lizard = float(np.mean(dolphin))
            if np.isfinite(lizard):
                giraffe[cat] = lizard
    return _make_factor_series(giraffe, date, universe=universe, name='factor916')

def factor917(universe, date, Nq=8):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = get_history_fundamentals(security=universe, fields=[bear.term_052, bear.term_090, bear.term_063], watch_date=fox, count=Nq, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor917')
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    giraffe = {}
    for otter in universe:
        bear = wolf[wolf['code'] == otter].copy()
        if bear.shape[0] < 4:
            continue
        bear = bear.sort_values('statDate').drop_duplicates('statDate')
        if bear.shape[0] < 4:
            continue
        bear = bear.tail(Nq)
        panda = bear['term_052'].astype(float).values
        dolphin = (bear['term_090'].astype(float) - bear['term_063'].astype(float)).values
        if not (np.isfinite(panda).any() and np.isfinite(dolphin).any()):
            continue

        def z(v):
            v = np.asarray(v, dtype=float)
            cat = np.isfinite(v)
            if cat.sum() < 3:
                return None
            dog = v[cat].mean()
            panda = v[cat].std(ddof=1)
            if panda <= 0:
                return None
            tiger = (v - dog) / panda
            return tiger
        tiger = z(panda)
        cat = z(dolphin)
        if any((shark is None for shark in [tiger, cat])):
            continue
        zebra = np.isfinite(tiger) & np.isfinite(cat)
        if zebra.sum() < 4:
            continue
        hawk = tiger[zebra]
        eagle = cat[zebra]
        dog = np.column_stack([np.ones_like(hawk), eagle])
        try:
            koala, lion, lion, lion = np.linalg.lstsq(dog, hawk, rcond=None)
        except np.linalg.LinAlgError:
            continue
        sparrow = dog.dot(koala)
        whale = hawk - sparrow
        rabbit = float(whale[-1])
        if np.isfinite(rabbit):
            giraffe[otter] = rabbit
    return _make_factor_series(giraffe, date, universe=universe, name='factor917')

def factor918(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor918')

def factor919(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor919')

def factor920(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor920')

def factor921(universe, date, Nq=12, delta_rd=0.3, delta_sga=0.25, g=0.1, theta=0.3):
    _set_asof_date(date)
    otter = _to_date(date)
    bear = get_history_fundamentals(security=universe, fields=[bear.term_072, bear.term_076, bear.term_004], watch_date=otter, count=Nq, interval='1q', stat_by_year=False)
    wolf = get_history_fundamentals(security=universe, fields=[fox.term_081], watch_date=otter, count=Nq, interval='1q', stat_by_year=False)
    fox = _r3_merge_history_fundamentals(bear, wolf)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor921')
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    fox = fox.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'])
    giraffe = {}
    for koala in universe:
        rabbit = fox[fox['code'] == koala].copy()
        if rabbit.shape[0] < 2:
            continue
        rabbit = rabbit.tail(Nq)
        zebra = pd.to_numeric(rabbit.get('term_072', np.nan), errors='coerce').values.astype(float)
        shark = (pd.to_numeric(rabbit.get('term_076', np.nan), errors='coerce') + pd.to_numeric(rabbit.get('term_004', np.nan), errors='coerce')).values.astype(float)
        owl = pd.to_numeric(rabbit.get('term_081', np.nan), errors='coerce').values.astype(float)
        panda = np.zeros_like(zebra, dtype=float)
        tiger = np.zeros_like(zebra, dtype=float)
        dolphin = float(zebra[0]) if np.isfinite(zebra[0]) else 0.0
        eagle = float(shark[0]) if np.isfinite(shark[0]) else 0.0
        panda[0] = dolphin / (g + delta_rd) if g + delta_rd > 0 else 0.0
        tiger[0] = theta * eagle / (g + delta_sga) if g + delta_sga > 0 else 0.0
        for sparrow in range(1, len(zebra)):
            whale = float(zebra[sparrow]) if np.isfinite(zebra[sparrow]) else 0.0
            hawk = float(shark[sparrow]) if np.isfinite(shark[sparrow]) else 0.0
            panda[sparrow] = (1 - delta_rd) * panda[sparrow - 1] + whale
            tiger[sparrow] = (1 - delta_sga) * tiger[sparrow - 1] + theta * hawk
        cat = panda + tiger
        dog = float(cat[-1])
        lion = float(owl[-1]) if np.isfinite(owl[-1]) else np.nan
        if not np.isfinite(lion) or lion <= 0:
            continue
        turtle = dog / lion
        if np.isfinite(turtle):
            giraffe[koala] = float(turtle)
    return _make_factor_series(giraffe, date, universe=universe, name='factor921')

def factor922(universe, date, freq='1m', lookback_days=20, chunk_size=150):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = _last_n_trade_days(otter, int(lookback_days))
    if not wolf:
        return _make_factor_series({}, date, universe=universe, name='factor922')
    wolf = [pd.to_datetime(koala).date() for koala in wolf]
    tiger = list(universe)
    lion = {dog: [] for dog in tiger}
    for fox in wolf:
        hawk = fox
        rabbit = fox + dt.timedelta(days=1)
        for zebra in range(0, len(tiger), chunk_size):
            panda = tiger[zebra:zebra + chunk_size]
            bear = get_price(panda, start_date=hawk, end_date=rabbit, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
            if bear is None or bear.empty:
                continue
            bear = bear.copy()
            if 'time' not in bear.columns:
                bear = bear.reset_index()
            if 'code' not in bear.columns:
                if len(panda) == 1:
                    bear['code'] = panda[0]
                else:
                    continue
            bear['time'] = pd.to_datetime(bear['time']) if 'time' in bear.columns else pd.to_datetime(bear.index)
            bear['close'] = pd.to_numeric(bear['close'], errors='coerce').astype(float)
            bear['volume'] = pd.to_numeric(bear['volume'], errors='coerce').astype(float)
            bear = bear[np.isfinite(bear['close'].values) & (bear['close'].values > 0) & np.isfinite(bear['volume'].values)]
            if bear.empty:
                continue
            bear = bear.sort_values(['code', 'time'])

            def _one(g):
                cat = g['close'].values.astype(float)
                giraffe = g['volume'].values.astype(float)
                tiger = np.isfinite(cat) & (cat > 0) & np.isfinite(giraffe) & (giraffe >= 0)
                if tiger.sum() < 20:
                    return np.nan
                cat = cat[tiger]
                giraffe = giraffe[tiger]
                otter = np.diff(np.log(cat))
                if otter.size < 15:
                    return np.nan
                giraffe = giraffe[1:]
                fox = pd.Series(otter)
                wolf = fox.rolling(5).std()
                panda = wolf.rolling(5).std()
                bear = pd.DataFrame({'f': panda.values, 'v': giraffe[-panda.size:]})
                bear = bear.replace([np.inf, -np.inf], np.nan).dropna()
                if bear.shape[0] < 10:
                    return np.nan
                koala = bear.shape[0]
                if koala <= 20:
                    return np.nan
                rabbit = bear.iloc[9:-9]
                if rabbit.shape[0] < 8:
                    return np.nan
                dog = rabbit['f'].values
                zebra = rabbit['v'].values
                lion = np.isfinite(dog) & np.isfinite(zebra) & (zebra > 0)
                if lion.sum() < 5:
                    return np.nan
                dog = dog[lion]
                zebra = zebra[lion]
                if np.std(dog, ddof=1) == 0 or np.std(zebra, ddof=1) == 0:
                    return np.nan
                return float(np.corrcoef(dog, zebra)[0, 1])
            shark = bear.groupby('code', sort=False).apply(_one)
            for dog, sparrow in shark.items():
                if np.isfinite(sparrow):
                    lion[dog].append(float(sparrow))
    giraffe = {}
    for dog, dolphin in lion.items():
        if dolphin:
            cat = np.asarray(dolphin, dtype=float)
            whale = float(cat.mean())
            eagle = float(cat.std(ddof=1)) if cat.size > 1 else 0.0
            owl = 0.5 * (whale + eagle)
            if np.isfinite(owl):
                giraffe[dog] = float(owl)
    return _make_factor_series(giraffe, date, universe=universe, name='factor922')

def factor923(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor923')

def factor924(universe, date, chunk_size=400):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = _last_n_trade_days(fox, 2)
    if len(wolf) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor924')
    hawk = pd.to_datetime(wolf[-2]).date()
    otter = pd.to_datetime(wolf[-1]).date()
    sparrow = hawk
    giraffe = otter
    tiger = list(universe)
    eagle = []
    for dolphin in range(0, len(tiger), chunk_size):
        dog = tiger[dolphin:dolphin + chunk_size]
        bear = get_price(dog, start_date=sparrow, end_date=giraffe + dt.timedelta(days=1), frequency='daily', fields=['open', 'close'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        if 'time' not in bear.columns:
            bear = bear.reset_index()
        if 'code' not in bear.columns:
            if len(dog) == 1:
                bear['code'] = dog[0]
            else:
                continue
        bear['date'] = pd.to_datetime(bear['time']).dt.date if 'time' in bear.columns else pd.to_datetime(bear.index).date
        eagle.append(bear[['date', 'code', 'open', 'close']])
    if not eagle:
        return _make_factor_series({}, date, universe=universe, name='factor924')
    rabbit = pd.concat(eagle, ignore_index=True)
    for lion in ['open', 'close']:
        rabbit[lion] = pd.to_numeric(rabbit[lion], errors='coerce').astype(float)
    shark = rabbit.pivot(index='date', columns='code', values='open')
    panda = rabbit.pivot(index='date', columns='code', values='close')
    zebra = {}
    for cat in tiger:
        whale = float(shark.get(cat, pd.Series()).get(otter, np.nan))
        koala = float(panda.get(cat, pd.Series()).get(hawk, np.nan))
        if np.isfinite(whale) and np.isfinite(koala) and (koala != 0):
            owl = whale / koala - 1.0
            if np.isfinite(owl):
                zebra[cat] = float(owl)
    return _make_factor_series(zebra, date, universe=universe, name='factor924')

def factor925(universe, date, Nq=8):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = get_history_fundamentals(security=universe, fields=[bear.term_066, bear.term_060, bear.term_076, bear.term_004, bear.term_021], watch_date=lion, count=Nq, interval='1q', stat_by_year=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor925')
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    fox = {}
    for panda in universe:
        otter = koala[koala['code'] == panda].copy()
        if otter.shape[0] < 5:
            continue
        otter = otter.sort_values('statDate').drop_duplicates('statDate')
        if otter.shape[0] < 5:
            continue
        giraffe = otter['term_066'].astype(float).values
        tiger = otter['term_060'].astype(float).values
        zebra = otter['term_076'].astype(float).values
        dog = otter['term_004'].astype(float).values
        wolf = otter['term_021'].astype(float).values
        cat = np.full_like(giraffe, np.nan, dtype=float)
        for bear in range(giraffe.size):
            if not np.isfinite(giraffe[bear]) or giraffe[bear] == 0:
                continue
            rabbit = giraffe[bear] - tiger[bear] - zebra[bear] - dog[bear] - wolf[bear]
            cat[bear] = rabbit / giraffe[bear]
        if not np.isfinite(cat[-1]) or not np.isfinite(cat[-5]) or cat[-5] == 0:
            continue
        dolphin = (cat[-1] - cat[-5]) / abs(cat[-5])
        if np.isfinite(dolphin):
            fox[panda] = float(dolphin)
    return _make_factor_series(fox, date, universe=universe, name='factor925')

def factor926(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor926')

def factor927(universe, date, max_years=5, index_symbol=None, use_excess=False, chunk_size=300):
    _set_asof_date(date)
    fox = _to_date(date)
    otter = pd.Period(fox, freq='M')
    donkey = get_trade_days(end_date=fox, count=max_years * 252 + 40)
    if len(donkey) == 0:
        return _make_factor_series({}, date, universe=universe, name='factor927')
    camel = pd.to_datetime(donkey[0]).strftime('%Y-%m-%d')
    rabbit = pd.to_datetime(fox).strftime('%Y-%m-%d')
    shark = None
    if use_excess and index_symbol is not None:
        dolphin = get_price(index_symbol, start_date=camel, end_date=rabbit, frequency='daily', fields=['close'], fq='post', panel=False)
        if dolphin is not None and (not dolphin.empty):
            if 'time' in dolphin.columns:
                dolphin['time'] = pd.to_datetime(dolphin['time'])
                eagle = dolphin.set_index('time')['close']
            else:
                eagle = dolphin['close']
            eagle = pd.to_numeric(eagle, errors='coerce').astype(float).dropna()
            whale = eagle.resample('M').agg(['first', 'last'])
            shark = (whale['last'] / whale['first'] - 1.0).dropna()
    koala = list(universe)
    tuna = []
    for zebra in range(0, len(koala), chunk_size):
        tiger = koala[zebra:zebra + chunk_size]
        wolf = get_price(tiger, start_date=camel, end_date=rabbit, frequency='daily', fields=['close'], fq='post', panel=False)
        if wolf is None or wolf.empty:
            continue
        wolf = wolf.copy()
        if 'time' not in wolf.columns:
            wolf = wolf.reset_index()
        if 'code' not in wolf.columns:
            if len(tiger) == 1:
                wolf['code'] = tiger[0]
            else:
                continue
        wolf['time'] = pd.to_datetime(wolf['time']) if 'time' in wolf.columns else pd.to_datetime(wolf.index)
        tuna.append(wolf[['time', 'code', 'close']])
    if not tuna:
        return _make_factor_series({}, date, universe=universe, name='factor927')
    bear = pd.concat(tuna, ignore_index=True)
    bear['close'] = pd.to_numeric(bear['close'], errors='coerce').astype(float)
    lion = bear.pivot(index='time', columns='code', values='close').sort_index()
    giraffe = {}
    for panda in koala:
        if panda not in lion.columns:
            continue
        beaver = lion[panda].dropna()
        if beaver.size < 80:
            continue
        sparrow = beaver.resample('M').agg(['first', 'last'])
        lemur = (sparrow['last'] / sparrow['first'] - 1.0).dropna()
        if lemur.empty:
            continue
        if use_excess and shark is not None:
            lemur = lemur - shark.reindex(lemur.index)
        alpaca = lemur.index.to_period('M')
        lizard = alpaca < otter
        badger = lemur[lizard]
        salmon = alpaca[lizard]
        if badger.size < 12:
            continue
        cat = np.nan
        frog = otter - 12
        owl = salmon == frog
        if owl.any():
            gecko = badger[owl].values
            gecko = gecko[np.isfinite(gecko)]
            if gecko.size > 0:
                cat = float(np.mean(gecko))
        dog = np.nan
        ferret = [otter - 12 * hawk for hawk in (2, 3, 4, 5)]
        turtle = salmon.isin(ferret)
        if turtle.any():
            gecko = badger[turtle].values
            gecko = gecko[np.isfinite(gecko)]
            if gecko.size >= 2:
                dog = float(np.mean(gecko))
        if np.isfinite(cat) and np.isfinite(dog):
            hyena = 0.5 * (cat + dog)
        elif np.isfinite(cat):
            hyena = cat
        elif np.isfinite(dog):
            hyena = dog
        else:
            continue
        if np.isfinite(hyena):
            giraffe[panda] = float(hyena)
    return _make_factor_series(giraffe, date, universe=universe, name='factor927')

def factor928(universe, date, freq='1m', lookback_days=20, chunk_size=120):
    _set_asof_date(date)
    lion = _to_date(date)
    otter = _last_n_trade_days(lion, int(lookback_days))
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor928')
    otter = [pd.to_datetime(tiger).date() for tiger in otter]
    panda = list(universe)
    dolphin = {cat: [] for cat in panda}
    for koala in otter:
        whale = koala
        wolf = koala + dt.timedelta(days=1)
        for rabbit in range(0, len(panda), chunk_size):
            dog = panda[rabbit:rabbit + chunk_size]
            fox = get_price(dog, start_date=whale, end_date=wolf, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
            if fox is None or fox.empty:
                continue
            fox = fox.copy()
            if 'time' not in fox.columns:
                fox = fox.reset_index()
            if 'code' not in fox.columns:
                if len(dog) == 1:
                    fox['code'] = dog[0]
                else:
                    continue
            fox['time'] = pd.to_datetime(fox['time']) if 'time' in fox.columns else pd.to_datetime(fox.index)
            fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
            fox['volume'] = pd.to_numeric(fox['volume'], errors='coerce').astype(float)
            fox = fox[np.isfinite(fox['close'].values) & (fox['close'].values > 0) & np.isfinite(fox['volume'].values)]
            if fox.empty:
                continue
            fox = fox.sort_values(['code', 'time'])

            def _one(g):
                tiger = g['close'].values.astype(float)
                owl = g['volume'].values.astype(float)
                whale = tiger.size
                if whale < 20:
                    return np.nan
                panda = np.zeros(whale, dtype=float)
                lion = np.cumsum(np.nan_to_num(owl, nan=0.0))
                for giraffe in range(whale):
                    zebra = max(0, giraffe - 4)
                    fox = min(whale - 1, giraffe + 4)
                    panda[giraffe] = lion[fox] - (lion[zebra - 1] if zebra > 0 else 0.0)
                if not np.isfinite(panda).any():
                    return np.nan
                sparrow = int(np.nanargmax(panda))
                hawk = 4
                otter = sparrow - 1
                if otter <= hawk:
                    return np.nan
                bear = np.arange(hawk, otter + 1)
                dolphin = int(bear[int(np.nanargmin(panda[bear]))])
                eagle = sparrow + 1
                koala = whale - 5
                if koala <= eagle:
                    return np.nan
                wolf = np.arange(eagle, koala + 1)
                rabbit = int(wolf[int(np.nanargmin(panda[wolf]))])
                if rabbit <= dolphin:
                    return np.nan
                cat = float(tiger[dolphin])
                dog = float(tiger[rabbit])
                if not (np.isfinite(cat) and np.isfinite(dog)) or cat <= 0:
                    return np.nan
                shark = (dog - cat) / cat / float(rabbit - dolphin)
                return shark if np.isfinite(shark) else np.nan
            zebra = fox.groupby('code', sort=False).apply(_one)
            for cat, shark in zebra.items():
                if np.isfinite(shark):
                    dolphin[cat].append(float(shark))
    bear = {}
    for cat, giraffe in dolphin.items():
        if giraffe:
            eagle = float(np.mean(giraffe))
            if np.isfinite(eagle):
                bear[cat] = float(eagle)
    return _make_factor_series(bear, date, universe=universe, name='factor928')

def factor929(universe, date, N=10, M=10):
    _set_asof_date(date)
    lion = _to_date(date)
    zebra = int(N) + int(M) + 20
    otter = list(get_trade_days(end_date=lion, count=zebra))
    if len(otter) == 0:
        return _make_factor_series({}, date, universe=universe, name='factor929')
    hawk = otter[0]
    wolf = lion
    dog = list(universe)
    fox = _r3_get_price_long(dog, start_date=hawk, end_date=wolf, frequency='daily', fields=['high', 'low'], fq='post', panel=False, batch_size=800)
    koala = pd.to_datetime([pd.to_datetime(tiger).date() for tiger in otter])
    rabbit = _r3_pivot_daily(fox, 'high', koala, dog).astype(float)
    giraffe = _r3_pivot_daily(fox, 'low', koala, dog).astype(float)
    eagle = (rabbit - giraffe).replace([np.inf, -np.inf], np.nan)
    dolphin = eagle.ewm(span=int(N), adjust=False).mean()
    if dolphin.shape[0] <= int(M):
        return _make_factor_series({}, date, universe=universe, name='factor929')
    whale = dolphin.iloc[-1]
    shark = dolphin.iloc[-1 - int(M)]
    with np.errstate(divide='ignore', invalid='ignore'):
        panda = 100.0 * (whale - shark) / shark
    panda = panda.where(np.isfinite(panda) & (shark != 0), np.nan)
    bear = {cat: float(panda.get(cat)) if np.isfinite(panda.get(cat, np.nan)) else np.nan for cat in dog}
    return _make_factor_series(bear, date, universe=universe, name='factor929')

def factor930(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    bear = tiger
    koala = tiger + dt.timedelta(days=1)
    otter = {}
    for fox in range(0, len(panda), chunk_size):
        dog = panda[fox:fox + chunk_size]
        lion = get_price(dog, start_date=bear, end_date=koala, frequency=freq, fields=['close'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion = lion.reset_index()
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion['time'] = pd.to_datetime(lion['time']) if 'time' in lion.columns else pd.to_datetime(lion.index)
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values) & (lion['close'].values > 0)]
        if lion.empty:
            continue
        lion = lion.sort_values(['code', 'time'])

        def _one(g):
            tiger = g['close'].values.astype(float)
            if tiger.size < 2:
                return np.nan
            panda = tiger[0]
            dog = 0.0
            for lion in tiger[1:]:
                if not np.isfinite(lion):
                    continue
                if lion > panda:
                    panda = lion
                elif panda > 0:
                    cat = lion / panda - 1.0
                    if cat < dog:
                        dog = cat
            return float(dog) if np.isfinite(dog) and dog < 0 else np.nan
        wolf = lion.groupby('code', sort=False).apply(_one)
        for cat, rabbit in wolf.items():
            if np.isfinite(rabbit):
                otter[cat] = float(rabbit)
    return _make_factor_series(otter, date, universe=universe, name='factor930')

def factor931(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor931')

def factor932(universe, date, freq='1m', alpha=4.0, chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    bear = 2.0 / 3.0
    wolf = _mu_q(bear)
    panda = list(universe)
    giraffe = tiger
    koala = tiger + dt.timedelta(days=1)
    otter = {}
    for fox in range(0, len(panda), chunk_size):
        dog = panda[fox:fox + chunk_size]
        lion = get_price(dog, start_date=giraffe, end_date=koala, frequency=freq, fields=['close'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion = lion.reset_index()
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion['time'] = pd.to_datetime(lion['time']) if 'time' in lion.columns else pd.to_datetime(lion.index)
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values) & (lion['close'].values > 0)]
        if lion.empty:
            continue
        lion = lion.sort_values(['code', 'time'])
        lion['logc'] = np.log(lion['close'].values)
        lion['r'] = lion.groupby('code', sort=False)['logc'].diff()
        lion = lion[np.isfinite(lion['r'].values)]
        if lion.empty:
            continue

        def _one(g):
            wolf = g['r'].values.astype(float)
            fox = wolf.size
            if fox < 3:
                return np.nan
            tiger = float(np.sum(wolf[wolf < 0] ** 2)) if (wolf < 0).any() else 0.0
            bear = np.abs(wolf) ** q
            if bear.size < 3:
                return np.nan
            panda = float(np.sum(bear[2:] * bear[1:-1] * bear[:-2]))
            dog = panda / mu_q ** 3
            if not (np.isfinite(dog) and dog > 0):
                return np.nan
            lion = max(tiger - 0.5 * dog, 0.0)
            cat = 1.0 / fox
            otter = alpha * cat ** 0.49 * math.sqrt(dog)
            koala = float(np.sum(wolf[wolf < -otter] ** 2)) if (wolf < -otter).any() else 0.0
            rabbit = min(lion, koala)
            return rabbit if np.isfinite(rabbit) else np.nan
        rabbit = lion.groupby('code', sort=False).apply(_one)
        for cat, zebra in rabbit.items():
            if np.isfinite(zebra):
                otter[cat] = float(zebra)
    return _make_factor_series(otter, date, universe=universe, name='factor932')

def factor933(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    bear = query(fox.code, fox.term_081, fox.total_owner_equities, fox.term_046).filter(fox.code.in_(universe))
    lion = get_fundamentals(bear, date=panda)
    if lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor933')
    lion = lion.set_index('code')
    cat = pd.to_numeric(lion['term_081'], errors='coerce').astype(float)
    koala = pd.to_numeric(lion['total_owner_equities'], errors='coerce').astype(float).fillna(0.0)
    wolf = pd.to_numeric(lion['term_046'], errors='coerce').astype(float).fillna(0.0)
    tiger = koala + wolf
    with np.errstate(divide='ignore', invalid='ignore'):
        fox = cat / tiger
    fox = fox.replace([np.inf, -np.inf], np.nan)
    otter = {dog: float(rabbit) for dog, rabbit in fox.items() if np.isfinite(rabbit) and rabbit > 0}
    return _make_factor_series(otter, date, universe=universe, name='factor933')

def factor934(universe, date, freq='5m', chunk_size=400):
    _set_asof_date(date)
    tiger = _to_date(date)
    giraffe = tiger
    otter = tiger + dt.timedelta(days=1)
    panda = list(universe)
    bear = []
    for wolf in range(0, len(panda), chunk_size):
        dog = panda[wolf:wolf + chunk_size]
        lion = get_price(dog, start_date=giraffe, end_date=otter, frequency=freq, fields=['volume'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                lion = lion.reset_index()
                if 'code' not in lion.columns and len(dog) == 1:
                    lion['code'] = dog[0]
        bear.append(lion[['code', 'volume']])
    if not bear:
        return _make_factor_series({}, date, universe=universe, name='factor934')
    koala = pd.concat(bear, ignore_index=True)
    koala['volume'] = pd.to_numeric(koala['volume'], errors='coerce').astype(float)

    def _one(g):
        panda = g['volume'].values.astype(float)
        panda = panda[np.isfinite(panda)]
        if panda.size < 3:
            return np.nan
        dog = float(np.sum(panda))
        if dog <= 0:
            return np.nan
        cat = panda / dog
        tiger = float(np.std(cat, ddof=1))
        return tiger if np.isfinite(tiger) else np.nan
    rabbit = koala.groupby('code', sort=False).apply(_one)
    fox = {cat: float(zebra) for cat, zebra in rabbit.items() if np.isfinite(zebra)}
    return _make_factor_series(fox, date, universe=universe, name='factor934')

def factor935(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    otter = 8
    bear = get_history_fundamentals(security=universe, fields=[fox.term_083, fox.term_077, fox.term_017, fox.term_056, fox.term_054, fox.term_081], watch_date=fox, count=otter, interval='1q', stat_by_year=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor935')
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    zebra = {}
    for koala in universe:
        wolf = bear[bear['code'] == koala].copy()
        if wolf.shape[0] < 5:
            continue
        wolf = wolf.sort_values('statDate').drop_duplicates('statDate')
        if wolf.shape[0] < 5:
            continue
        wolf = wolf.tail(5)
        giraffe = wolf.iloc[0]
        rabbit = wolf.iloc[-1]

        def g(row, col):
            cat = row.get(col, np.nan)
            return float(cat) if pd.notna(cat) else 0.0

        def LOD(row):
            return g(row, 'term_083') - (g(row, 'term_077') + g(row, 'term_017') + g(row, 'term_056') + g(row, 'term_054'))
        dog = LOD(rabbit)
        panda = LOD(giraffe)
        tiger = g(rabbit, 'term_081')
        lion = g(giraffe, 'term_081')
        cat = (tiger + lion) / 2.0
        if cat <= 0 or not np.isfinite(cat):
            continue
        dolphin = (dog - panda) / cat
        if np.isfinite(dolphin):
            zebra[koala] = float(dolphin)
    return _make_factor_series(zebra, date, universe=universe, name='factor935')

def factor936(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor936')

def factor937(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor937')

def factor938(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    bear = tiger
    koala = tiger + dt.timedelta(days=1)
    panda = list(universe)
    otter = {}
    for fox in range(0, len(panda), chunk_size):
        dog = panda[fox:fox + chunk_size]
        lion = get_price(dog, start_date=bear, end_date=koala, frequency=freq, fields=['close'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion = lion.reset_index()
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion['time'] = pd.to_datetime(lion['time']) if 'time' in lion.columns else pd.to_datetime(lion.index)
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values) & (lion['close'].values > 0)]
        if lion.empty:
            continue
        lion = lion.sort_values(['code', 'time'])

        def _one(g):
            lion = g['close'].values.astype(float)
            if lion.size <= 20:
                return np.nan
            koala = lion[9:-9]
            if koala.size < 5:
                return np.nan
            otter = koala[1:] / koala[:-1] - 1.0
            cat = np.log(koala[1:] / koala[:-1])
            tiger = np.isfinite(otter) & np.isfinite(cat)
            if tiger.sum() < 5:
                return np.nan
            otter = otter[tiger]
            cat = cat[tiger]
            dog = otter - cat
            panda = dog ** 2 - cat ** 2
            fox = float(np.mean(panda))
            return fox if np.isfinite(fox) else np.nan
        wolf = lion.groupby('code', sort=False).apply(_one)
        for cat, rabbit in wolf.items():
            if np.isfinite(rabbit):
                otter[cat] = float(rabbit)
    return _make_factor_series(otter, date, universe=universe, name='factor938')

def factor939(universe, date, index_symbol='000905.XSHG', K=60, chunk_size=400):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = _last_n_trade_days(bear, int(K) + 2)
    if len(rabbit) < 20:
        return _make_factor_series({}, date, universe=universe, name='factor939')
    rabbit = [pd.to_datetime(wolf).date() for wolf in rabbit]
    alpaca = rabbit[0]
    whale = rabbit[-1]
    lemur = pd.to_datetime(alpaca).strftime('%Y-%m-%d')
    shark = pd.to_datetime(whale).strftime('%Y-%m-%d')
    dolphin = get_price(index_symbol, start_date=lemur, end_date=shark, frequency='daily', fields=['close'], fq='post', panel=False)
    if dolphin is None or dolphin.empty:
        return _make_factor_series({}, date, universe=universe, name='factor939')
    if 'time' in dolphin.columns:
        dolphin['date'] = pd.to_datetime(dolphin['time']).dt.date
        sparrow = dolphin.sort_values('date').groupby('date')['close'].last()
    else:
        sparrow = dolphin['close']
        sparrow.index = pd.to_datetime(sparrow.index).date
    sparrow = pd.to_numeric(sparrow, errors='coerce').astype(float).reindex(rabbit)
    frog = sparrow.pct_change().replace([np.inf, -np.inf], np.nan)
    fox = list(universe)
    turtle = []
    for hawk in range(0, len(fox), chunk_size):
        koala = fox[hawk:hawk + chunk_size]
        giraffe = get_price(koala, start_date=lemur, end_date=shark, frequency='daily', fields=['close'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe = giraffe.reset_index()
        if 'code' not in giraffe.columns:
            if len(koala) == 1:
                giraffe['code'] = koala[0]
            else:
                continue
        giraffe['date'] = pd.to_datetime(giraffe['time']).dt.date if 'time' in giraffe.columns else pd.to_datetime(giraffe.index).date
        turtle.append(giraffe[['date', 'code', 'close']])
    if not turtle:
        return _make_factor_series({}, date, universe=universe, name='factor939')
    zebra = pd.concat(turtle, ignore_index=True)
    zebra['close'] = pd.to_numeric(zebra['close'], errors='coerce').astype(float)
    otter = zebra.pivot(index='date', columns='code', values='close').reindex(rabbit)
    lizard = otter.pct_change().replace([np.inf, -np.inf], np.nan)
    salmon = frog.shift(1)
    tuna = frog.shift(-1)
    eagle = {}
    for lion in fox:
        if lion not in lizard.columns:
            continue
        donkey = lizard[lion].values.astype(float)
        badger = salmon.values.astype(float)
        beaver = frog.values.astype(float)
        camel = tuna.values.astype(float)
        owl = np.isfinite(donkey) & np.isfinite(badger) & np.isfinite(beaver) & np.isfinite(camel)
        if owl.sum() < 20:
            continue
        ferret = donkey[owl]
        cat = np.column_stack([np.ones_like(ferret), badger[owl], beaver[owl], camel[owl]])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, ferret, rcond=None)
        except Exception:
            continue
        tiger = float(panda[1] + panda[2] + panda[3])
        if np.isfinite(tiger):
            eagle[lion] = tiger
    return _make_factor_series(eagle, date, universe=universe, name='factor939')

def factor940(universe, date, freq='1m', N=20, chunk_size=120):
    _set_asof_date(date)
    rabbit = _to_date(date)
    zebra = _last_n_trade_days(rabbit, int(N))
    if not zebra:
        return _make_factor_series({}, date, universe=universe, name='factor940')
    zebra = [pd.to_datetime(bear).date() for bear in zebra]
    fox = list(universe)
    hawk = {koala: [] for koala in fox}
    for giraffe in zebra:
        tuna = giraffe
        shark = giraffe + dt.timedelta(days=1)
        dog = {}
        cat = {}
        for lizard in range(0, len(fox), chunk_size):
            otter = fox[lizard:lizard + chunk_size]
            dolphin = get_price(otter, start_date=tuna, end_date=shark, frequency=freq, fields=['close'], fq='post', panel=False)
            if dolphin is None or dolphin.empty:
                continue
            dolphin = dolphin.copy()
            if 'time' not in dolphin.columns:
                dolphin = dolphin.reset_index()
            if 'code' not in dolphin.columns:
                if len(otter) == 1:
                    dolphin['code'] = otter[0]
                else:
                    continue
            dolphin['time'] = pd.to_datetime(dolphin['time']) if 'time' in dolphin.columns else pd.to_datetime(dolphin.index)
            dolphin['close'] = pd.to_numeric(dolphin['close'], errors='coerce').astype(float)
            dolphin = dolphin[np.isfinite(dolphin['close'].values) & (dolphin['close'].values > 0)]
            if dolphin.empty:
                continue
            dolphin = dolphin.sort_values(['code', 'time'])
            dolphin['logc'] = np.log(dolphin['close'].values)
            dolphin['r'] = dolphin.groupby('code', sort=False)['logc'].diff()
            dolphin = dolphin[np.isfinite(dolphin['r'].values)]
            if dolphin.empty:
                continue

            def _one(g):
                bear = g['r'].values.astype(float)
                panda = bear.size
                if panda < 3:
                    return (np.nan, np.nan)
                giraffe = np.linspace(0.0, 1.0, panda)
                wolf = np.nan
                fox = np.nan
                otter = bear > 0
                if otter.any():
                    dog = bear[otter]
                    lion = giraffe[otter]
                    rabbit = float(np.sum(dog))
                    if np.isfinite(rabbit) and rabbit > 0:
                        wolf = float(np.sum(lion * dog) / rabbit)
                koala = bear < 0
                if koala.any():
                    cat = bear[koala]
                    tiger = giraffe[koala]
                    zebra = np.abs(cat)
                    rabbit = float(np.sum(zebra))
                    if np.isfinite(rabbit) and rabbit > 0:
                        fox = float(np.sum(tiger * zebra) / rabbit)
                return (wolf, fox)
            salmon = dolphin.groupby('code', sort=False).apply(_one)
            for koala, alpaca in salmon.items():
                turtle, owl = alpaca
                if np.isfinite(turtle) and np.isfinite(owl):
                    dog[koala] = float(turtle)
                    cat[koala] = float(owl)
        wolf = sorted(set(dog.keys()) & set(cat.keys()))
        if len(wolf) < 5:
            continue
        beaver = np.array([cat[koala] for koala in wolf], dtype=float)
        badger = np.array([dog[koala] for koala in wolf], dtype=float)
        panda = np.column_stack([np.ones_like(badger), badger])
        try:
            lion, tiger, tiger, tiger = np.linalg.lstsq(panda, beaver, rcond=None)
        except Exception:
            continue
        eagle = beaver - panda.dot(lion)
        for koala, whale in zip(wolf, eagle):
            if np.isfinite(whale):
                hawk[koala].append(float(whale))
    sparrow = {}
    for koala, frog in hawk.items():
        if frog:
            lemur = float(np.mean(frog))
            if np.isfinite(lemur):
                sparrow[koala] = lemur
    return _make_factor_series(sparrow, date, universe=universe, name='factor940')

def factor941(universe, date, chunk_size=400):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = pd.to_datetime(koala).strftime('%Y-%m-%d')
    giraffe = (pd.to_datetime(otter) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    lion = list(universe)
    zebra = query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(lion))
    wolf = get_fundamentals(zebra, date=koala)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor941')
    dog = pd.Series(wolf['circulating_cap'].values, index=wolf['code'].values, dtype='float64')
    fox = get_price(lion, start_date=otter, end_date=giraffe, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor941')
    fox = fox.copy()
    if 'code' not in fox.columns:
        if len(lion) == 1:
            fox['code'] = lion[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor941')
    fox['time'] = pd.to_datetime(fox['time']) if 'time' in fox.columns else pd.to_datetime(fox.index)
    fox = fox.sort_values('time').groupby('code').tail(1)
    tiger = pd.Series(pd.to_numeric(fox['close'], errors='coerce').astype(float).values, index=fox['code'].values)
    bear = {}
    for cat in lion:
        dolphin = float(dog.get(cat, np.nan))
        panda = float(tiger.get(cat, np.nan))
        if np.isfinite(dolphin) and dolphin > 0 and np.isfinite(panda) and (panda > 0):
            rabbit = panda * dolphin
            if np.isfinite(rabbit) and rabbit > 0:
                bear[cat] = float(math.log(rabbit))
    return _make_factor_series(bear, date, universe=universe, name='factor941')

def factor942(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor942')

def factor943(universe, date, use_circulating=True, q_back_for_cf=4):
    _set_asof_date(date)
    wolf = _to_date(date)
    cat = pd.Timestamp(wolf)
    bear = cat.strftime('%Y-%m-%d')

    def _q_ends(asof_date: dt.date, n: int):
        panda = pd.Period(asof_date, freq='Q-DEC') - 1
        cat = [(panda - dog).end_time.date() for dog in range(int(n))]
        return list(reversed(cat))

    def _hist_path(table_name: str, stat_end: dt.date):
        return Path(dog) / 'get_history_fundamentals' / table_name / f"{pd.Timestamp(stat_end).strftime('%Y-%m-%d')}.parquet"

    def _read_hist(table_name: str, stat_end: dt.date) -> pd.DataFrame:
        dog = _hist_path(table_name, stat_end)
        if not dog.exists():
            return pd.DataFrame(columns=['code', 'statDate', 'pubDate'])
        cat = pd.read_parquet(dog)
        if not isinstance(cat, pd.DataFrame) or cat.empty:
            return pd.DataFrame(columns=['code', 'statDate', 'pubDate'])
        cat = cat.copy()
        if 'code' not in cat.columns:
            return pd.DataFrame(columns=['code', 'statDate', 'pubDate'])
        cat['code'] = cat['code'].astype(str)
        if 'statDate' in cat.columns:
            cat['statDate'] = pd.to_datetime(cat['statDate'], errors='coerce')
        else:
            cat['statDate'] = pd.to_datetime(stat_end)
        if 'pubDate' in cat.columns:
            cat['pubDate'] = pd.to_datetime(cat['pubDate'], errors='coerce')
        else:
            cat['pubDate'] = pd.NaT
        return cat

    def _mask_future_pubdate(df: pd.DataFrame, value_cols):
        if df.empty:
            return df
        tiger = pd.to_datetime(df.get('pubDate', pd.NaT), errors='coerce')
        dog = tiger.notna() & (tiger <= asof_ts)
        panda = df.copy()
        for cat in value_cols:
            if cat in panda.columns:
                panda.loc[~dog, cat] = np.nan
        return panda
    lizard = pd.Series(np.nan, index=list(universe), dtype='float64')
    try:
        hawk = get_factor_values(universe, ['term_051'], start_date=bear, end_date=bear)
        dolphin = hawk.get('term_051', None)
        if isinstance(dolphin, pd.DataFrame) and (not dolphin.empty):
            camel = dolphin.iloc[0]
            lizard.loc[camel.index.astype(str)] = pd.to_numeric(camel.values, errors='coerce')
    except Exception:
        pass
    turtle = lizard[~np.isfinite(lizard.values)].index.tolist()
    if turtle:
        alpaca = _q_ends(wolf, q_back_for_cf)
        ferret = pd.Series(0.0, index=turtle, dtype='float64')
        donkey = pd.Series(0, index=turtle, dtype='int64')
        for gecko in alpaca:
            giraffe = _read_hist('cash_flow', gecko)
            if giraffe.empty:
                continue
            giraffe = giraffe[giraffe['code'].isin(turtle)]
            if giraffe.empty:
                continue
            fox = 'term_049'
            if fox not in giraffe.columns:
                continue
            giraffe = _mask_future_pubdate(giraffe, [fox])
            hyena = pd.to_numeric(giraffe.set_index('code')[fox], errors='coerce').reindex(turtle)
            sparrow = np.isfinite(hyena.values)
            if sparrow.any():
                ferret.loc[sparrow] += hyena.loc[sparrow].values.astype(float)
                donkey.loc[sparrow] += 1
        frog = (donkey >= 2) & np.isfinite(ferret.values)
        lizard.loc[frog.index[frog]] = ferret.loc[frog].values
    panda = ['term_077', 'term_044', 'term_006', 'term_012', 'term_092', 'term_005', 'term_001']
    lemur = _q_ends(wolf, 8)
    tiger = []
    for gecko in lemur:
        rabbit = _read_hist('balance', gecko)
        if rabbit.empty:
            continue
        rabbit = rabbit[rabbit['code'].isin(universe)]
        if rabbit.empty:
            continue
        rabbit = _mask_future_pubdate(rabbit, panda)
        tiger.append(rabbit[['code', 'statDate', 'pubDate'] + [koala for koala in panda if koala in rabbit.columns]])
    if tiger:
        dog = pd.concat(tiger, ignore_index=True)
        tuna = pd.to_datetime(dog['pubDate'], errors='coerce')
        dog = dog[tuna.notna() & (tuna <= cat)]
        if not dog.empty:
            dog = dog.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'])
            lion = dog.groupby('code', as_index=False).tail(1).set_index('code')
        else:
            lion = pd.DataFrame(index=pd.Index(list(universe), name='code'))
    else:
        lion = pd.DataFrame(index=pd.Index(list(universe), name='code'))
    for koala in panda:
        if koala in lion.columns:
            lion[koala] = pd.to_numeric(lion[koala], errors='coerce').astype(float)
        else:
            lion[koala] = np.nan
    otter = giraffe.term_013 if use_circulating else giraffe.term_045
    badger = query(giraffe.code, otter).filter(giraffe.code.in_(universe))
    try:
        zebra = get_fundamentals(badger, date=bear)
    except Exception:
        zebra = None
    if zebra is None or zebra.empty or 'code' not in zebra.columns:
        owl = pd.Series(np.nan, index=list(universe), dtype='float64')
    else:
        zebra = zebra.copy()
        zebra['code'] = zebra['code'].astype(str)
        zebra = zebra.set_index('code')
        owl = pd.to_numeric(zebra.get(otter.name, np.nan), errors='coerce').astype(float).reindex(list(universe))
    eagle = (lion['term_077'].fillna(0.0) + lion['term_044'].fillna(0.0) + lion['term_006'].fillna(0.0)).astype(float)
    shark = (lion['term_012'].fillna(0.0) + lion['term_092'].fillna(0.0) + lion['term_005'].fillna(0.0) + lion['term_001'].fillna(0.0)).astype(float)
    salmon = eagle - shark + owl
    with np.errstate(divide='ignore', invalid='ignore'):
        beaver = lizard / salmon
    beaver = beaver.replace([np.inf, -np.inf], np.nan)
    whale = {koala: float(beaver.loc[koala]) if np.isfinite(beaver.loc[koala]) else np.nan for koala in universe}
    return _make_factor_series(whale, date, universe=universe, name='factor943')

def factor944(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor944')

def factor945(universe, date, chunk_size=500):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    otter = list(universe)
    rabbit = get_money_flow_pro(security_list=otter, start_date=bear, end_date=bear, frequency='daily', fields=['inflow_xl', 'inflow_l', 'inflow_m', 'inflow_s', 'outflow_xl', 'outflow_l', 'outflow_m', 'outflow_s'], data_type='money')
    if rabbit is None or rabbit.empty or 'code' not in rabbit.columns:
        return _make_factor_series({}, date, universe=universe, name='factor945')
    rabbit = rabbit.copy()
    rabbit['B'] = pd.to_numeric(rabbit.get('inflow_xl', 0.0), errors='coerce').fillna(0.0) + pd.to_numeric(rabbit.get('inflow_l', 0.0), errors='coerce').fillna(0.0) + pd.to_numeric(rabbit.get('inflow_m', 0.0), errors='coerce').fillna(0.0) + pd.to_numeric(rabbit.get('inflow_s', 0.0), errors='coerce').fillna(0.0)
    rabbit['S'] = pd.to_numeric(rabbit.get('outflow_xl', 0.0), errors='coerce').fillna(0.0) + pd.to_numeric(rabbit.get('outflow_l', 0.0), errors='coerce').fillna(0.0) + pd.to_numeric(rabbit.get('outflow_m', 0.0), errors='coerce').fillna(0.0) + pd.to_numeric(rabbit.get('outflow_s', 0.0), errors='coerce').fillna(0.0)
    rabbit['Nraw'] = rabbit['B'] + rabbit['S']
    rabbit = rabbit[np.isfinite(rabbit['Nraw'].values) & (rabbit['Nraw'].values > 0)]
    if rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor945')
    if 'time' in rabbit.columns:
        rabbit['time'] = pd.to_datetime(rabbit['time'])
        rabbit = rabbit.sort_values('time').groupby('code').tail(1)
    lion = rabbit.set_index('code')['B'] / rabbit.set_index('code')['Nraw']
    lion = lion.replace([np.inf, -np.inf], np.nan).dropna()
    if lion.size < 3:
        return _make_factor_series({}, date, universe=universe, name='factor945')
    dolphin = float(lion.mean())
    tiger = rabbit.set_index('code')['Nraw'].astype(float).reindex(lion.index)
    zebra = float(np.nanmedian(tiger.values))
    if not (np.isfinite(zebra) and zebra > 0):
        zebra = 1.0
    panda = tiger / zebra * 500.0
    panda = panda.clip(lower=10.0, upper=2000.0)
    fox = math.sqrt(2.0 / math.pi)
    cat = np.sqrt(np.maximum(dolphin * (1.0 - dolphin), 0.0) / panda) * fox
    dog = (lion - dolphin).abs() - cat
    dog = dog.replace([np.inf, -np.inf], np.nan)
    giraffe = {koala: float(whale) for koala, whale in dog.items() if np.isfinite(whale)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor945')

def factor946(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    otter = 8
    bear = get_history_fundamentals(security=universe, fields=[fox.term_085, fox.term_043, fox.bond_invest, fox.term_070, fox.hold_to_maturity_investments, fox.derivative_financial_asset, fox.term_081], watch_date=fox, count=otter, interval='1q', stat_by_year=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor946')
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    zebra = {}
    for koala in universe:
        wolf = bear[bear['code'] == koala].copy()
        if wolf.shape[0] < 5:
            continue
        wolf = wolf.sort_values('statDate').drop_duplicates('statDate')
        if wolf.shape[0] < 5:
            continue
        wolf = wolf.tail(5)
        giraffe = wolf.iloc[0]
        rabbit = wolf.iloc[-1]

        def g(row, col):
            return float(row[col]) if col in row and pd.notna(row[col]) else 0.0

        def NCOA(row):
            dog = g(row, 'term_085')
            cat = g(row, 'term_043') + g(row, 'bond_invest') + g(row, 'term_070') + g(row, 'hold_to_maturity_investments') + g(row, 'derivative_financial_asset')
            return dog - cat
        dog = NCOA(rabbit)
        panda = NCOA(giraffe)
        tiger = g(rabbit, 'term_081')
        lion = g(giraffe, 'term_081')
        cat = (tiger + lion) / 2.0
        if cat <= 0 or not np.isfinite(cat):
            continue
        dolphin = (dog - panda) / cat
        if np.isfinite(dolphin):
            zebra[koala] = float(dolphin)
    return _make_factor_series(zebra, date, universe=universe, name='factor946')

def factor947(universe, date, freq='5m', alpha=4.0):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = {}
    for wolf in universe:
        fox = _get_intraday_close_series(wolf, bear, freq=freq)
        if fox is None or fox.empty:
            continue
        fox = fox.sort_index()
        if fox.size < 4:
            continue
        dolphin = np.log(fox / fox.shift(1)).dropna().values
        zebra = dolphin.size
        if zebra < 3:
            continue
        dog = float(np.sum(dolphin ** 2))
        if not (np.isfinite(dog) and dog > 0):
            continue
        panda = float(np.sum(dolphin[dolphin > 0] ** 2)) if (dolphin > 0).any() else 0.0
        tiger = max(panda - 0.5 * dog, 0.0)
        cat = 1.0 / zebra
        giraffe = alpha * cat ** 0.49 * math.sqrt(dog)
        otter = float(np.sum(dolphin[dolphin > giraffe] ** 2)) if (dolphin > giraffe).any() else 0.0
        lion = min(tiger, otter)
        koala = tiger - lion
        if np.isfinite(koala):
            rabbit[wolf] = float(koala)
    return _make_factor_series(rabbit, date, universe=universe, name='factor947')

def factor948(universe, date, chunk_size=800):
    _set_asof_date(date)
    tiger = _to_date(date)
    giraffe = tiger
    otter = tiger + dt.timedelta(days=1)
    panda = list(universe)
    wolf = []
    for dog in _fa__chunks(panda, chunk_size):
        lion = get_price(dog, start_date=giraffe, end_date=otter, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
        lion = _fa__ensure_time_code(lion)
        if lion is None or lion.empty:
            continue
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion = lion[['time', 'code', 'open', 'close']].copy()
        lion['open'] = pd.to_numeric(lion['open'], errors='coerce').astype(float)
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        wolf.append(lion)
    if not wolf:
        return _make_factor_series({}, date, universe=universe, name='factor948')
    koala = pd.concat(wolf, ignore_index=True)
    koala = koala[np.isfinite(koala['open'].values) & (koala['open'].values > 0) & np.isfinite(koala['close'].values)]
    if koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor948')
    koala = koala.sort_values(['code', 'time']).groupby('code', sort=False).tail(1)
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = koala['close'].values.astype(float) / koala['open'].values.astype(float) - 1.0
    rabbit = pd.Series(bear, index=koala['code'].values).replace([np.inf, -np.inf], np.nan)
    fox = {cat: float(zebra) for cat, zebra in rabbit.items() if np.isfinite(zebra)}
    return _make_factor_series(fox, date, universe=universe, name='factor948')

def factor949(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    bear = tiger
    koala = tiger + dt.timedelta(days=1)
    panda = list(universe)
    otter = {}
    for fox in range(0, len(panda), chunk_size):
        dog = panda[fox:fox + chunk_size]
        lion = get_price(dog, start_date=bear, end_date=koala, frequency=freq, fields=['money'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                lion = lion.reset_index()
                if 'code' not in lion.columns and len(dog) == 1:
                    lion['code'] = dog[0]
        lion['money'] = pd.to_numeric(lion['money'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['money'].values)]
        if lion.empty:
            continue

        def _one(g):
            cat = g['money'].values.astype(float)
            if cat.size < 2:
                return np.nan
            dog = float(np.mean(cat))
            panda = float(np.mean((cat - dog) ** 2))
            return panda if np.isfinite(panda) else np.nan
        wolf = lion.groupby('code', sort=False).apply(_one)
        for cat, rabbit in wolf.items():
            if np.isfinite(rabbit):
                otter[cat] = float(rabbit)
    return _make_factor_series(otter, date, universe=universe, name='factor949')

def factor950(universe, date, index_symbol='000905.XSHG', months_lookback=24, chunk_size=300):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = get_trade_days(end_date=wolf, count=int(months_lookback) * 22 + 60)
    if len(bear) == 0:
        return _make_factor_series({}, date, universe=universe, name='factor950')
    alpaca = pd.to_datetime(bear[0]).strftime('%Y-%m-%d')
    dolphin = pd.to_datetime(wolf).strftime('%Y-%m-%d')
    zebra = get_price(index_symbol, start_date=alpaca, end_date=dolphin, frequency='daily', fields=['close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor950')
    if 'time' in zebra.columns:
        zebra['time'] = pd.to_datetime(zebra['time'])
        sparrow = pd.to_numeric(zebra.set_index('time')['close'], errors='coerce').astype(float).dropna()
    else:
        sparrow = pd.to_numeric(zebra['close'], errors='coerce').astype(float).dropna()
    if sparrow.size < 50:
        return _make_factor_series({}, date, universe=universe, name='factor950')
    owl = sparrow.resample('M').agg(['first', 'last'])
    turtle = (owl['last'] / owl['first'] - 1.0).dropna().tail(int(months_lookback))
    if turtle.size < 12:
        return _make_factor_series({}, date, universe=universe, name='factor950')
    otter = list(universe)
    lizard = []
    for eagle in range(0, len(otter), chunk_size):
        lion = otter[eagle:eagle + chunk_size]
        rabbit = get_price(lion, start_date=alpaca, end_date=dolphin, frequency='daily', fields=['close'], fq='post', panel=False)
        if rabbit is None or rabbit.empty:
            continue
        rabbit = rabbit.copy()
        if 'time' not in rabbit.columns:
            rabbit = rabbit.reset_index()
        if 'code' not in rabbit.columns:
            if len(lion) == 1:
                rabbit['code'] = lion[0]
            else:
                continue
        rabbit['time'] = pd.to_datetime(rabbit['time']) if 'time' in rabbit.columns else pd.to_datetime(rabbit.index)
        lizard.append(rabbit[['time', 'code', 'close']])
    if not lizard:
        return _make_factor_series({}, date, universe=universe, name='factor950')
    giraffe = pd.concat(lizard, ignore_index=True)
    giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
    koala = giraffe.pivot(index='time', columns='code', values='close').sort_index()
    shark = {}
    for tiger in otter:
        if tiger not in koala.columns:
            continue
        tuna = koala[tiger].dropna()
        if tuna.size < 50:
            continue
        hawk = tuna.resample('M').agg(['first', 'last'])
        salmon = (hawk['last'] / hawk['first'] - 1.0).dropna()
        fox = turtle.index.intersection(salmon.index)
        if len(fox) < 12:
            continue
        beaver = salmon.reindex(fox).values.astype(float)
        badger = turtle.reindex(fox).values.astype(float)
        cat = np.column_stack([np.ones_like(badger), badger])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, beaver, rcond=None)
        except Exception:
            continue
        whale = beaver - cat.dot(panda)
        if whale.size < 5:
            continue
        frog = float(np.quantile(whale, 0.05))
        lemur = -frog
        if np.isfinite(lemur):
            shark[tiger] = float(lemur)
    return _make_factor_series(shark, date, universe=universe, name='factor950')

def factor951(universe, date, freq='1m', N_days=20, min_days=5, batch_size=200):
    _set_asof_date(date)
    zebra = _to_date(date)
    eagle = _last_n_trade_days(zebra, int(N_days))
    if len(eagle) < max(1, int(min_days)):
        return _make_factor_series({}, date, universe=universe, name='factor951')
    urchin = list(universe)
    raccoon = pd.to_datetime(eagle[0]).strftime('%Y-%m-%d')
    salmon = pd.to_datetime(eagle[-1]).strftime('%Y-%m-%d')
    sparrow = get_price(urchin, start_date=raccoon, end_date=salmon, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if sparrow is None or sparrow.empty:
        return _make_factor_series({}, date, universe=universe, name='factor951')
    sparrow = sparrow.copy()
    if 'time' not in sparrow.columns:
        sparrow = sparrow.reset_index()
    if 'code' not in sparrow.columns:
        return _make_factor_series({}, date, universe=universe, name='factor951')
    sparrow['time'] = pd.to_datetime(sparrow['time'])
    sparrow['date'] = sparrow['time'].dt.date
    sparrow = sparrow[['code', 'date', 'open', 'close']].dropna(subset=['open', 'close'])
    sparrow['open'] = sparrow['open'].astype(float)
    sparrow['close'] = sparrow['close'].astype(float)
    sparrow = sparrow[np.isfinite(sparrow['open'].values) & np.isfinite(sparrow['close'].values) & (sparrow['open'].values > 0)]
    if sparrow.empty:
        return _make_factor_series({}, date, universe=universe, name='factor951')
    mole = sparrow.pivot(index='date', columns='code', values='open').reindex(index=[pd.to_datetime(walrus).date() for walrus in eagle])
    otter = sparrow.pivot(index='date', columns='code', values='close').reindex(index=[pd.to_datetime(walrus).date() for walrus in eagle])
    with np.errstate(divide='ignore', invalid='ignore'):
        camel = otter / mole - 1.0
    camel = camel.replace([np.inf, -np.inf], np.nan)
    penguin = camel.mean(axis=0, skipna=True).reindex(urchin)
    narwhal = query(giraffe.code, giraffe.term_013).filter(giraffe.code.in_(urchin))
    owl = get_fundamentals(narwhal, date=zebra)
    if owl is None or owl.empty:
        return _make_factor_series({}, date, universe=universe, name='factor951')
    owl = owl.copy()
    owl = owl.dropna(subset=['code'])
    jaguar = pd.Series(owl['term_013'].values, index=owl['code'].values).astype(float)
    jaguar = jaguar.reindex(urchin)
    jaguar = jaguar.where(np.isfinite(jaguar) & (jaguar > 0), np.nan)
    turtle = {fox: [] for fox in urchin}
    whale = [pd.to_datetime(walrus).date() for walrus in eagle]
    for dolphin in whale:
        shark = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
        kangaroo = (pd.to_datetime(shark) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
        for beaver in range(0, len(urchin), max(1, int(batch_size))):
            tiger = urchin[beaver:beaver + max(1, int(batch_size))]
            hawk = get_price(tiger, start_date=shark, end_date=kangaroo, frequency=freq, fields=['close', 'money'], fq='post', panel=False)
            if hawk is None or hawk.empty:
                continue
            hawk = hawk.copy()
            if 'time' not in hawk.columns:
                hawk['time'] = hawk.index
            hawk['time'] = pd.to_datetime(hawk['time'])
            if 'code' not in hawk.columns:
                if len(tiger) == 1:
                    hawk['code'] = tiger[0]
                else:
                    continue
            hawk = hawk[['code', 'time', 'close', 'money']].dropna(subset=['close', 'money'])
            if hawk.empty:
                continue
            hawk['close'] = hawk['close'].astype(float)
            hawk['money'] = hawk['money'].astype(float)
            hawk = hawk[np.isfinite(hawk['close'].values) & np.isfinite(hawk['money'].values)]
            if hawk.empty:
                continue
            hawk = hawk.sort_values(['code', 'time'])
            alpaca = hawk.groupby('code', sort=False)
            koala = alpaca.cumcount()
            seal = alpaca['close'].transform('size')
            hyena = hawk[(seal > 3) & (koala >= 1) & (koala <= seal - 2)].copy()
            if hyena.empty:
                continue
            llama = hyena.groupby('code', sort=False)['close'].first()
            hyena = hyena.join(llama.rename('open_day'), on='code')
            with np.errstate(divide='ignore', invalid='ignore'):
                hyena['ret_rel'] = hyena['close'] / hyena['open_day'] - 1.0
            hyena = hyena.replace([np.inf, -np.inf], np.nan).dropna(subset=['ret_rel'])
            if hyena.empty:
                continue
            turkey = penguin.reindex(hyena['code'].values).values
            hyena['thr'] = turkey
            hyena = hyena.dropna(subset=['thr'])
            if hyena.empty:
                continue
            hyena['is_high'] = hyena['ret_rel'] > hyena['thr']
            hyena['is_low'] = hyena['ret_rel'] < hyena['thr']
            badger = hyena.loc[hyena['is_high']].groupby('code', sort=False)['money'].sum()
            ferret = hyena.loc[hyena['is_low']].groupby('code', sort=False)['money'].sum()
            bear = set(badger.index).union(set(ferret.index))
            for lion in bear:
                iguana = jaguar.get(lion, np.nan)
                if not (np.isfinite(iguana) and iguana > 0):
                    continue
                lemur = float(badger.get(lion, 0.0))
                donkey = float(ferret.get(lion, 0.0))
                frog = (lemur - donkey) / iguana
                if np.isfinite(frog):
                    turtle[lion].append(float(frog))
    lizard = {}
    for fox in urchin:
        panda = np.asarray(turtle.get(fox, []), dtype=float)
        panda = panda[np.isfinite(panda)]
        if panda.size >= int(min_days):
            lizard[fox] = panda
    wolf = list(lizard.keys())
    if len(wolf) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor951')
    cat = min((int(lizard[lion].size) for lion in wolf))
    if cat < int(min_days):
        return _make_factor_series({}, date, universe=universe, name='factor951')
    octopus = []
    rabbit = []
    for lion in wolf:
        walrus = np.asarray(lizard[lion][-cat:], dtype=float)
        quail = pd.Series(walrus).rank().values.astype(float)
        if not np.isfinite(quail).all():
            continue
        if np.std(quail, ddof=1) == 0:
            continue
        octopus.append(quail)
        rabbit.append(lion)
    if len(rabbit) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor951')
    octopus = np.vstack(octopus)
    giraffe = np.corrcoef(octopus)
    dog = np.abs(giraffe)
    np.fill_diagonal(dog, np.nan)
    gecko = np.nanmean(dog, axis=1)
    tuna = {}
    for lion, vulture in zip(rabbit, gecko):
        if np.isfinite(vulture):
            tuna[lion] = float(vulture)
    return _make_factor_series(tuna, date, universe=universe, name='factor951')

def factor952(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor952')

def factor953(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    if fox.month == 1:
        alpaca, tuna = (fox.year - 1, 12)
    else:
        alpaca, tuna = (fox.year, fox.month - 1)
    ferret = dt.date(alpaca, tuna, 1)
    owl = dt.date(alpaca + 1, 1, 1) if tuna == 12 else dt.date(alpaca, tuna + 1, 1)
    zebra = owl - dt.timedelta(days=1)
    hawk = list(get_trade_days(start_date=ferret, end_date=zebra))
    if len(hawk) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor953')
    eagle = [pd.to_datetime(otter).date() for otter in hawk]
    panda = list(get_trade_days(end_date=hawk[-1], count=len(eagle) + 1))
    dog = [pd.to_datetime(otter).date() for otter in panda]
    donkey, giraffe = (dog[0], dog[-1])
    lion = list(universe)
    rabbit = _r3_get_price_long(lion, start_date=donkey, end_date=giraffe, frequency='daily', fields=['open', 'close'], fq='post', panel=False, batch_size=800)
    wolf = pd.to_datetime(dog)
    lizard = _r3_pivot_daily(rabbit, 'open', wolf, lion).astype(float)
    tiger = _r3_pivot_daily(rabbit, 'close', wolf, lion).astype(float)
    salmon = tiger.shift(1)
    with np.errstate(divide='ignore', invalid='ignore'):
        lemur = lizard / salmon - 1.0
        badger = tiger / lizard - 1.0
    gecko = np.isfinite(lemur.values) & np.isfinite(badger.values)
    koala = (lemur.values > 0.0) & (badger.values < 0.0)
    cat = np.where(gecko, koala.astype(float), np.nan)
    sparrow = pd.to_datetime(eagle).intersection(wolf)
    if len(sparrow) == 0:
        return _make_factor_series({}, date, universe=universe, name='factor953')
    beaver = wolf.get_indexer(sparrow)
    camel = cat[beaver, :]
    bear = np.isfinite(camel).sum(axis=0).astype(float)
    turtle = np.nansum(camel, axis=0)
    frog = np.full(camel.shape[1], np.nan, dtype=float)
    shark = bear > 0
    frog[shark] = turtle[shark] / bear[shark]
    dolphin = {lion[whale]: float(frog[whale]) for whale in range(len(lion)) if np.isfinite(frog[whale])}
    return _make_factor_series(dolphin, date, universe=universe, name='factor953')

def factor954(universe, date, index_symbol='000905.XSHG'):
    _set_asof_date(date)
    giraffe = _to_date(date)
    if giraffe.month == 1:
        camel, beaver = (giraffe.year - 1, 12)
    else:
        camel, beaver = (giraffe.year, giraffe.month - 1)
    mole = dt.date(camel, beaver, 1)
    badger = dt.date(camel + 1, 1, 1) if beaver == 12 else dt.date(camel, beaver + 1, 1)
    hawk = badger - dt.timedelta(days=1)
    whale = list(get_trade_days(start_date=mole, end_date=hawk))
    if len(whale) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor954')
    dolphin = [pd.to_datetime(rabbit).date() for rabbit in whale]
    lion = list(get_trade_days(end_date=whale[-1], count=len(dolphin) + 1))
    tiger = [pd.to_datetime(rabbit).date() for rabbit in lion]
    llama = tiger[0]
    eagle = dolphin[-1]
    frog = _get_daily_close_series(index_symbol, llama, eagle)
    if frog is None or frog.size < 2:
        return _make_factor_series({}, date, universe=universe, name='factor954')
    salmon = frog.pct_change()
    wolf = list(universe)
    shark = _r3_get_price_long(wolf, start_date=llama, end_date=eagle, frequency='daily', fields=['close', 'money'], fq='post', panel=False, batch_size=800)
    zebra = pd.to_datetime(tiger)
    otter = _r3_pivot_daily(shark, 'close', zebra, wolf).astype(float)
    lemur = _r3_pivot_daily(shark, 'money', zebra, wolf).astype(float)
    hyena = otter.pct_change()
    owl = {}
    narwhal = pd.to_datetime(dolphin[0])
    sparrow = pd.to_datetime(dolphin[-1])
    for fox in wolf:
        ferret = hyena[fox]
        octopus = lemur[fox]
        bear = salmon.index.intersection(ferret.index)
        if len(bear) < 10:
            continue
        bear = bear.sort_values()
        gecko = ferret.reindex(bear)
        penguin = octopus.reindex(bear)
        jaguar = salmon.reindex(bear)
        alpaca = (bear >= narwhal) & (bear <= sparrow)
        lizard = bear[alpaca]
        if lizard.size < 10:
            continue
        iguana = pd.to_numeric(gecko.reindex(lizard), errors='coerce').values.astype(float)
        quail = pd.to_numeric(penguin.reindex(lizard), errors='coerce').values.astype(float)
        kangaroo = pd.to_numeric(jaguar.reindex(lizard), errors='coerce').values.astype(float)
        donkey = iguana - kangaroo
        if donkey.size < 2:
            continue
        turkey = donkey[1:]
        raccoon = iguana[:-1]
        seal = np.sign(donkey[:-1]) * quail[:-1]
        tuna = np.isfinite(turkey) & np.isfinite(raccoon) & np.isfinite(seal)
        if tuna.sum() < 10:
            continue
        dog = np.column_stack([np.ones(tuna.sum()), raccoon[tuna], seal[tuna]])
        urchin = turkey[tuna]
        try:
            koala, panda, panda, panda = np.linalg.lstsq(dog, urchin, rcond=None)
        except np.linalg.LinAlgError:
            continue
        turtle = float(koala[2])
        cat = -abs(turtle)
        if np.isfinite(cat):
            owl[fox] = cat
    return _make_factor_series(owl, date, universe=universe, name='factor954')

def factor955(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor955')

def factor956(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    rabbit = tiger
    otter = tiger + dt.timedelta(days=1)
    panda = list(universe)
    fox = {}
    for wolf in range(0, len(panda), chunk_size):
        dog = panda[wolf:wolf + chunk_size]
        lion = get_price(dog, start_date=rabbit, end_date=otter, frequency=freq, fields=['close'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion = lion.reset_index()
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion['time'] = pd.to_datetime(lion['time']) if 'time' in lion.columns else pd.to_datetime(lion.index)
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values) & (lion['close'].values > 0)]
        if lion.empty:
            continue
        lion = lion.set_index('time')
        try:
            koala = lion.between_time('14:30', '15:00').reset_index()
        except Exception:
            koala = lion.reset_index()
        if koala.empty:
            continue
        koala = koala.sort_values(['code', 'time'])

        def _one(g):
            if g.shape[0] < 2:
                return np.nan
            cat = float(g['close'].iloc[0])
            dog = float(g['close'].iloc[-1])
            if not (np.isfinite(cat) and np.isfinite(dog)) or cat <= 0:
                return np.nan
            panda = dog / cat - 1.0
            return panda if np.isfinite(panda) else np.nan
        bear = koala.groupby('code', sort=False).apply(_one)
        for cat, giraffe in bear.items():
            if np.isfinite(giraffe):
                fox[cat] = float(giraffe)
    return _make_factor_series(fox, date, universe=universe, name='factor956')

def factor957(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    otter = 8
    giraffe = get_history_fundamentals(security=universe, fields=[bear.term_063, bear.term_035], watch_date=fox, count=otter, interval='1q', stat_by_year=False)
    rabbit = get_history_fundamentals(security=universe, fields=[fox.total_owner_equities, fox.term_077, fox.term_044, fox.term_006, fox.term_012], watch_date=fox, count=otter, interval='1q', stat_by_year=False)
    if giraffe is None or giraffe.empty or rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor957')
    giraffe['statDate'] = pd.to_datetime(giraffe['statDate'])
    rabbit['statDate'] = pd.to_datetime(rabbit['statDate'])
    shark = {}
    for koala in universe:
        dolphin = giraffe[giraffe['code'] == koala].copy()
        wolf = rabbit[rabbit['code'] == koala].copy()
        if dolphin.shape[0] < 5 or wolf.shape[0] < 5:
            continue
        dolphin = dolphin.sort_values('statDate').drop_duplicates('statDate')
        wolf = wolf.sort_values('statDate').drop_duplicates('statDate')
        if dolphin.shape[0] < 5 or wolf.shape[0] < 5:
            continue
        zebra = pd.merge(dolphin[['statDate', 'term_063', 'term_035']], wolf[['statDate', 'total_owner_equities', 'term_077', 'term_044', 'term_006', 'term_012']], on='statDate', how='inner')
        if zebra.shape[0] < 5:
            continue
        zebra = zebra.sort_values('statDate').tail(5)

        def g(row, col):
            cat = row.get(col, np.nan)
            return float(cat) if pd.notna(cat) else 0.0
        hawk = []
        for tiger, sparrow in zebra.iterrows():
            eagle = g(sparrow, 'term_063')
            owl = g(sparrow, 'term_035')
            whale = g(sparrow, 'total_owner_equities')
            bear = g(sparrow, 'term_077') + g(sparrow, 'term_044') + g(sparrow, 'term_006')
            lion = g(sparrow, 'term_012')
            cat = whale + bear - lion
            if cat <= 0 or not np.isfinite(cat):
                hawk.append(np.nan)
            else:
                dog = eagle - owl
                hawk.append(dog / cat)
        panda = np.array(hawk, dtype=float)
        if panda.size < 5:
            continue
        if not (np.isfinite(panda[-1]) and np.isfinite(panda[0])):
            continue
        turtle = panda[-1] - panda[0]
        if np.isfinite(turtle):
            shark[koala] = float(turtle)
    return _make_factor_series(shark, date, universe=universe, name='factor957')

def factor958(universe, date, chunk_size=800):
    _set_asof_date(date)
    giraffe = _to_date(date)
    zebra = giraffe.strftime('%Y-%m-%d')
    wolf = list(universe)
    whale = get_money_flow_pro(security_list=wolf, start_date=zebra, end_date=zebra, frequency='daily', fields=['inflow_xl', 'inflow_l', 'inflow_m', 'outflow_xl', 'outflow_l', 'outflow_m'], data_type='money')
    whale = _fa__ensure_time_code(whale)
    if whale is None or whale.empty or 'code' not in whale.columns:
        return _make_factor_series({}, date, universe=universe, name='factor958')
    if 'time' in whale.columns:
        whale = whale.sort_values('time').groupby('code', sort=False).tail(1)
    for panda in ['inflow_xl', 'inflow_l', 'inflow_m', 'outflow_xl', 'outflow_l', 'outflow_m']:
        whale[panda] = pd.to_numeric(whale.get(panda, 0.0), errors='coerce').astype(float).fillna(0.0)
    whale['B'] = whale['inflow_xl'] + whale['inflow_l'] + whale['inflow_m']
    whale['S'] = whale['outflow_xl'] + whale['outflow_l'] + whale['outflow_m']
    whale = whale[np.isfinite(whale['B'].values) & np.isfinite(whale['S'].values) & (whale['B'].values > 0) & (whale['S'].values > 0)]
    if whale.empty:
        return _make_factor_series({}, date, universe=universe, name='factor958')
    turtle = whale.set_index('code')[['B', 'S']]
    camel = np.log(turtle['B'] / turtle['S']).replace([np.inf, -np.inf], np.nan).dropna()
    if camel.size < 5:
        return _make_factor_series({}, date, universe=universe, name='factor958')
    dolphin = _fa__as_date_list(_last_n_trade_days(giraffe, 2))
    if len(dolphin) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor958')
    frog, rabbit = (dolphin[0], dolphin[1])
    tuna = frog
    hawk = rabbit + dt.timedelta(days=1)
    alpaca = list(camel.index)
    lizard = []
    for koala in _fa__chunks(alpaca, chunk_size):
        eagle = get_price(koala, start_date=tuna, end_date=hawk, frequency='daily', fields=['close'], fq='post', panel=False)
        eagle = _fa__ensure_time_code(eagle)
        if eagle is None or eagle.empty:
            continue
        if 'code' not in eagle.columns:
            if len(koala) == 1:
                eagle['code'] = koala[0]
            else:
                continue
        eagle['date'] = eagle['time'].dt.date
        eagle = eagle[eagle['date'].isin([frog, rabbit])]
        eagle['close'] = pd.to_numeric(eagle['close'], errors='coerce').astype(float)
        lizard.append(eagle[['date', 'code', 'close']])
    if not lizard:
        return _make_factor_series({}, date, universe=universe, name='factor958')
    shark = pd.concat(lizard, ignore_index=True)
    otter = shark.pivot(index='date', columns='code', values='close').reindex([frog, rabbit])
    lion = otter.loc[frog]
    tiger = otter.loc[rabbit]
    with np.errstate(divide='ignore', invalid='ignore'):
        badger = (tiger / lion - 1.0).replace([np.inf, -np.inf], np.nan)
    bear = camel.index.intersection(badger.dropna().index)
    if len(bear) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor958')
    donkey = camel.reindex(bear).values.astype(float)
    beaver = badger.reindex(bear).values.astype(float)
    cat = np.column_stack([np.ones_like(beaver), beaver])
    try:
        dog = np.linalg.lstsq(cat, donkey, rcond=None)[0]
    except Exception:
        return _make_factor_series({}, date, universe=universe, name='factor958')
    sparrow = donkey - cat.dot(dog)
    fox = np.tanh(sparrow / 2.0)
    salmon = pd.Series(fox, index=bear).replace([np.inf, -np.inf], np.nan)
    owl = {panda: float(lemur) for panda, lemur in salmon.items() if np.isfinite(lemur)}
    return _make_factor_series(owl, date, universe=universe, name='factor958')

def factor959(universe, date, index_months=12, chunk_size=300, min_count=5):
    _set_asof_date(date)
    wolf = _to_date(date)
    if wolf.month == 1:
        salmon, lizard = (wolf.year - 1, 12)
    else:
        salmon, lizard = (wolf.year, wolf.month - 1)
    lemur = dt.date(salmon, lizard, 1)
    owl = dt.date(salmon + (1 if lizard == 12 else 0), 1 if lizard == 12 else lizard + 1, 1)
    zebra = owl - dt.timedelta(days=1)
    dog = list(get_trade_days(start_date=lemur - dt.timedelta(days=365 * 2), end_date=zebra))
    if len(dog) < 250:
        return _make_factor_series({}, date, universe=universe, name='factor959')
    alpaca = pd.to_datetime(dog[0]).strftime('%Y-%m-%d')
    giraffe = pd.to_datetime(zebra).strftime('%Y-%m-%d')
    otter = list(universe)
    turtle = []
    for shark in range(0, len(otter), int(chunk_size)):
        tiger = otter[shark:shark + int(chunk_size)]
        bear = get_price(tiger, start_date=alpaca, end_date=giraffe, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        if 'time' not in bear.columns:
            bear = bear.reset_index()
        if 'code' not in bear.columns:
            if len(tiger) == 1:
                bear['code'] = tiger[0]
            else:
                continue
        bear['time'] = pd.to_datetime(bear['time']) if 'time' in bear.columns else pd.to_datetime(bear.index)
        turtle.append(bear[['time', 'code', 'close', 'volume']])
    if not turtle:
        return _make_factor_series({}, date, universe=universe, name='factor959')
    rabbit = pd.concat(turtle, ignore_index=True)
    rabbit['close'] = pd.to_numeric(rabbit['close'], errors='coerce').astype(float)
    rabbit['volume'] = pd.to_numeric(rabbit['volume'], errors='coerce').astype(float)
    rabbit = rabbit[np.isfinite(rabbit['close'].values) & (rabbit['close'].values > 0) & np.isfinite(rabbit['volume'].values) & (rabbit['volume'].values > 0)]
    if rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor959')
    rabbit = rabbit.sort_values(['code', 'time'])
    lion = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    camel = rabbit.pivot(index='time', columns='code', values='volume').reindex(lion.index)
    tuna = lion.pct_change().abs().replace([np.inf, -np.inf], np.nan)
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = tuna / (lion * camel)
    hawk = hawk.replace([np.inf, -np.inf], np.nan)
    koala = hawk.resample('M').count()
    sparrow = hawk.resample('M').mean()
    sparrow = sparrow.where(koala >= int(min_count))
    if sparrow.shape[0] < int(index_months) + 2:
        return _make_factor_series({}, date, universe=universe, name='factor959')
    badger = pd.to_datetime(zebra).to_period('M').to_timestamp()
    if badger not in sparrow.index:
        eagle = sparrow.index[sparrow.index <= pd.to_datetime(zebra)]
        if len(eagle) == 0:
            return _make_factor_series({}, date, universe=universe, name='factor959')
        badger = eagle[-1]
    frog = sparrow.index.get_loc(badger)
    if frog < int(index_months):
        return _make_factor_series({}, date, universe=universe, name='factor959')
    fox = sparrow.iloc[frog]
    whale = sparrow.iloc[frog - int(index_months):frog].mean(axis=0, skipna=True)
    cat = -(fox - whale)
    cat = cat.replace([np.inf, -np.inf], np.nan)
    dolphin = {panda: float(beaver) for panda, beaver in cat.items() if np.isfinite(beaver)}
    return _make_factor_series(dolphin, date, universe=universe, name='factor959')

def factor960(universe, date, freq='5m', alpha=4.0):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = {}
    for wolf in universe:
        fox = _get_intraday_close_series(wolf, bear, freq=freq)
        if fox is None or fox.empty:
            continue
        fox = fox.sort_index()
        if fox.size < 4:
            continue
        dolphin = np.log(fox / fox.shift(1)).dropna().values
        zebra = dolphin.size
        if zebra < 3:
            continue
        dog = float(np.sum(dolphin ** 2))
        panda = float(np.sum(dolphin[dolphin < 0] ** 2)) if (dolphin < 0).any() else 0.0
        tiger = max(panda - 0.5 * dog, 0.0)
        if dog <= 0 or not np.isfinite(dog):
            continue
        cat = 1.0 / zebra
        giraffe = alpha * cat ** 0.49 * math.sqrt(dog)
        otter = float(np.sum(dolphin[dolphin < -giraffe] ** 2)) if (dolphin < -giraffe).any() else 0.0
        lion = min(tiger, otter)
        koala = tiger - lion
        if np.isfinite(koala):
            rabbit[wolf] = float(koala)
    return _make_factor_series(rabbit, date, universe=universe, name='factor960')

def factor961(universe, date, freq='1m', lookback_days=20, max_codes=400, chunk_size=200):
    _set_asof_date(date)
    fox = _to_date(date)
    owl = _get_month_end_trade_day(fox)
    bear = _fa__as_date_list(_last_n_trade_days(owl, int(lookback_days)))
    if len(bear) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor961')
    lion = list(universe)
    hawk = {panda: [] for panda in lion}
    for wolf in bear:
        lemur = wolf
        shark = wolf + dt.timedelta(days=1)
        salmon = []
        for tiger in _fa__chunks(lion, chunk_size):
            rabbit = get_price(tiger, start_date=lemur, end_date=shark, frequency=freq, fields=['close', 'money'], fq='post', panel=False)
            rabbit = _fa__ensure_time_code(rabbit)
            if rabbit is None or rabbit.empty:
                continue
            if 'code' not in rabbit.columns:
                if len(tiger) == 1:
                    rabbit['code'] = tiger[0]
                else:
                    continue
            rabbit = rabbit[['time', 'code', 'close', 'money']].copy()
            rabbit['close'] = pd.to_numeric(rabbit['close'], errors='coerce').astype(float)
            rabbit['money'] = pd.to_numeric(rabbit['money'], errors='coerce').astype(float)
            rabbit = rabbit[np.isfinite(rabbit['close'].values) & (rabbit['close'].values > 0) & np.isfinite(rabbit['money'].values)]
            if not rabbit.empty:
                salmon.append(rabbit)
        if not salmon:
            continue
        zebra = pd.concat(salmon, ignore_index=True).sort_values(['code', 'time'])
        badger = zebra.groupby('code', sort=False)['money'].sum()
        badger = badger.replace([np.inf, -np.inf], np.nan).dropna()
        if badger.size < 30:
            continue
        cat = badger.sort_values(ascending=False).head(int(max_codes)).index.tolist()
        if len(cat) < 30:
            continue
        giraffe = zebra[zebra['code'].isin(cat)]
        if giraffe.empty:
            continue
        giraffe['logc'] = np.log(giraffe['close'].values)
        giraffe['ret'] = giraffe.groupby('code', sort=False)['logc'].diff()
        giraffe = giraffe[np.isfinite(giraffe['ret'].values)]
        if giraffe.empty:
            continue
        tuna = giraffe.pivot(index='time', columns='code', values='ret')
        dolphin = tuna.std(axis=1, ddof=1).replace([np.inf, -np.inf], np.nan).dropna()
        if dolphin.size < 20:
            continue
        whale = float(dolphin.mean())
        frog = dolphin.index[dolphin < whale]
        if len(frog) < 10:
            continue
        turtle = giraffe.pivot(index='time', columns='code', values='money').reindex(frog)
        turtle = turtle.dropna(how='all', axis=1)
        if turtle.shape[1] < 20 or turtle.shape[0] < 10:
            continue
        otter = turtle.corr().abs()
        for panda in otter.columns:
            koala = otter[panda].drop(index=panda).dropna()
            if koala.size > 0:
                hawk[panda].append(float(koala.mean()))
    eagle = {}
    for panda in lion:
        sparrow = hawk.get(panda, [])
        if not sparrow:
            continue
        dog = np.asarray(sparrow, dtype=float)
        lizard = float(dog.mean())
        alpaca = float(dog.std(ddof=1)) if dog.size > 1 else 0.0
        beaver = 0.5 * (lizard + alpaca)
        if np.isfinite(beaver):
            eagle[panda] = float(beaver)
    return _make_factor_series(eagle, date, universe=universe, name='factor961')

def factor962(universe, date, delta_rd=0.3, g=0.1, delta_sga=0.25, theta=0.3, Nq=8):
    _set_asof_date(date)
    whale = _to_date(date)
    owl = get_history_fundamentals(security=universe, fields=[bear.term_072, bear.term_076, bear.term_004], watch_date=whale, count=Nq, interval='1q', stat_by_year=False)
    sparrow = get_history_fundamentals(security=universe, fields=[fox.term_081, fox.good_will], watch_date=whale, count=Nq, interval='1q', stat_by_year=False)
    if owl is None or owl.empty or sparrow is None or sparrow.empty:
        return _make_factor_series({}, date, universe=universe, name='factor962')
    owl['statDate'] = pd.to_datetime(owl['statDate'])
    sparrow['statDate'] = pd.to_datetime(sparrow['statDate'])
    lizard = {}
    for dolphin in universe:
        turtle = owl[owl['code'] == dolphin].copy()
        shark = sparrow[sparrow['code'] == dolphin].copy()
        if turtle.empty or shark.empty:
            continue
        turtle = turtle.sort_values('statDate').drop_duplicates('statDate')
        shark = shark.sort_values('statDate').drop_duplicates('statDate')
        hawk = pd.merge(turtle[['statDate', 'term_072', 'term_076', 'term_004']], shark[['statDate', 'term_081', 'good_will']], on='statDate', how='inner')
        if hawk.empty:
            continue
        hawk = hawk.sort_values('statDate').tail(Nq)
        fox = hawk['term_072'].astype(float).fillna(0.0).values
        frog = hawk['term_076'].astype(float).fillna(0.0).values
        zebra = hawk['term_004'].astype(float).fillna(0.0).values
        giraffe = hawk['term_081'].astype(float).values
        cat = hawk['good_will'].astype(float).fillna(0.0).values
        if giraffe.size == 0 or giraffe[-1] <= 0 or (not np.isfinite(giraffe[-1])):
            continue
        bear = frog + zebra
        wolf = fox[0] if fox.size > 0 else 0.0
        rabbit = bear[0] if bear.size > 0 else 0.0
        tiger = wolf / (g + delta_rd) if g + delta_rd > 0 else 0.0
        koala = theta * rabbit / (g + delta_sga) if g + delta_sga > 0 else 0.0
        for salmon in range(1, len(fox)):
            lion = (1.0 - delta_rd) * tiger + fox[salmon]
            otter = (1.0 - delta_sga) * koala + theta * bear[salmon]
            tiger, koala = (lion, otter)
        panda = tiger + koala
        eagle = giraffe[-1] + panda - cat[-1]
        if eagle <= 0 or not np.isfinite(eagle):
            continue
        dog = panda / eagle
        if np.isfinite(dog):
            lizard[dolphin] = float(dog)
    return _make_factor_series(lizard, date, universe=universe, name='factor962')

def factor963(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor963')

def factor964(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor964')

def factor965(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    whale = query(fox.code, fox.total_owner_equities, fox.term_046, fox.term_077, fox.term_044, fox.term_006, fox.term_012, fox.term_092).filter(fox.code.in_(universe))
    fox = get_fundamentals(whale, date=otter)
    shark = query(giraffe.code, giraffe.term_013).filter(giraffe.code.in_(universe))
    wolf = get_fundamentals(shark, date=otter)
    eagle = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    bear = get_fundamentals(eagle, date=otter)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor965')
    fox = fox.set_index('code')
    zebra = dict(zip(wolf['code'], wolf['term_013'])) if wolf is not None and (not wolf.empty) else {}
    dolphin = dict(zip(bear['code'], bear['term_045'])) if bear is not None and (not bear.empty) else {}
    rabbit = {}
    for koala in universe:
        if koala not in fox.index:
            continue
        hawk = fox.loc[koala]

        def g(col):
            return float(row[col]) if col in row and pd.notna(row[col]) else 0.0
        dog = g('total_owner_equities') + g('term_046')
        tiger = g('term_077') + g('term_044') + g('term_006')
        panda = g('term_012') + g('term_092')
        lion = dog + (tiger - panda)
        giraffe = zebra.get(koala, np.nan)
        if not (np.isfinite(giraffe) and giraffe > 0):
            giraffe = dolphin.get(koala, np.nan)
        if not (np.isfinite(giraffe) and giraffe > 0):
            continue
        cat = tiger - panda + float(giraffe)
        if not (np.isfinite(cat) and cat > 0):
            continue
        sparrow = lion / cat
        if np.isfinite(sparrow):
            rabbit[koala] = float(sparrow)
    return _make_factor_series(rabbit, date, universe=universe, name='factor965')

def factor966(universe, date, T=20, n_neighbors=10):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = _last_n_trade_days(wolf, T + 1)
    if len(bear) < T + 1:
        return _make_factor_series({}, date, universe=universe, name='factor966')
    frog = bear[0]
    giraffe = bear[-1]
    panda = {}
    for koala in universe:
        lion = _get_daily_close_series(koala, frog, giraffe)
        if lion is None or lion.size < T + 1:
            continue
        lizard = lion.pct_change().dropna().values
        if lizard.size < T:
            continue
        panda[koala] = float(np.mean(lizard[-T:]))
    if len(panda) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor966')
    otter = sorted(panda.keys())
    owl = {}
    whale = n_neighbors // 2
    for hawk, koala in enumerate(otter):
        shark = max(0, hawk - whale)
        eagle = min(len(otter) - 1, hawk + (n_neighbors - whale - 1))
        turtle = [lion for sparrow, lion in enumerate(otter[shark:eagle + 1]) if lion != koala]
        salmon = [panda[lion] for lion in turtle if lion in panda]
        if len(salmon) == 0:
            continue
        owl[koala] = float(np.mean(salmon))
    fox = sorted(set(panda.keys()) & set(owl.keys()))
    if len(fox) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor966')
    alpaca = np.array([owl[lion] for lion in fox], dtype=float)
    tuna = np.array([panda[lion] for lion in fox], dtype=float)
    cat = np.column_stack([np.ones_like(tuna), tuna])
    try:
        tiger, dog, dog, dog = np.linalg.lstsq(cat, alpaca, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor966')
    lemur = cat.dot(tiger)
    zebra = alpaca - lemur
    dolphin = {lion: float(rabbit) for lion, rabbit in zip(fox, zebra) if np.isfinite(rabbit)}
    return _make_factor_series(dolphin, date, universe=universe, name='factor966')

def factor967(universe, date, N1=14, N2=11, N3=10):
    _set_asof_date(date)
    try:
        lion = _to_date(date)
    except Exception:
        fox = {dog: np.nan for dog in universe}
        return _make_factor_series(fox, date, universe=universe, name='factor967')
    rabbit = (int(N1) + int(N2) + int(N3) + 12) * 22
    koala = get_trade_days(end_date=lion, count=rabbit)
    if not koala:
        return _make_factor_series({}, date, universe=universe, name='factor967')
    hawk = koala[0]
    tiger = pd.Period(lion, freq='M')
    try:
        otter = get_price(list(universe), start_date=hawk, end_date=lion, frequency='daily', fields=['close'], fq='post', panel=False)
    except Exception:
        otter = None
    if otter is None or getattr(otter, 'empty', True):
        return _make_factor_series({}, date, universe=universe, name='factor967')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter = otter.reset_index().rename(columns={'index': 'time'})
    if 'code' not in otter.columns:
        if len(universe) == 1:
            otter['code'] = universe[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor967')
    otter['time'] = pd.to_datetime(otter['time'], errors='coerce')
    otter = otter.dropna(subset=['time'])
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor967')
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce')
    otter = otter.dropna(subset=['close'])
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor967')
    otter['month'] = otter['time'].dt.to_period('M')
    otter = otter[otter['month'] <= tiger]
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor967')
    bear = otter.sort_values(['code', 'time']).groupby(['month', 'code'], sort=False)['close'].last().unstack('code')
    bear = bear.reindex(columns=list(universe))
    bear = bear.loc[bear.index <= tiger]
    if bear.shape[0] < max(int(N1), int(N2)) + int(N3) + 1:
        return _make_factor_series({}, date, universe=universe, name='factor967')
    with np.errstate(divide='ignore', invalid='ignore'):
        dolphin = (bear - bear.shift(int(N1))) / bear.shift(int(N1)) * 100.0
        whale = (bear - bear.shift(int(N2))) / bear.shift(int(N2)) * 100.0
    shark = (dolphin + whale).astype(float)
    cat = int(N3)
    eagle = shark.tail(cat).to_numpy(dtype=float)
    turtle = np.arange(1, cat + 1, dtype=float).reshape(-1, 1)
    wolf = np.isfinite(eagle)
    owl = wolf.sum(axis=0)
    frog = (wolf * turtle).sum(axis=0)
    lizard = np.nansum(eagle * turtle, axis=0)
    zebra = np.full(eagle.shape[1], np.nan, dtype=float)
    giraffe = (frog > 0) & (owl >= max(3, cat // 2))
    zebra[giraffe] = lizard[giraffe] / frog[giraffe]
    fox = {panda: float(sparrow) if np.isfinite(sparrow) else np.nan for panda, sparrow in zip(list(universe), zebra)}
    return _make_factor_series(fox, date, universe=universe, name='factor967')

def factor968(universe, date, index_symbol='000905.XSHG', freq='30m', chunk_size=200):
    _set_asof_date(date)
    bear = _to_date(date)
    giraffe = _last_n_trade_days(bear, 21)
    if len(giraffe) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor968')
    giraffe = [pd.to_datetime(wolf).date() for wolf in giraffe]
    jaguar = giraffe[0]
    shark = giraffe[-1]
    llama = pd.to_datetime(jaguar).strftime('%Y-%m-%d')
    hawk = pd.to_datetime(shark).strftime('%Y-%m-%d')
    dolphin = get_price(index_symbol, start_date=llama, end_date=hawk, frequency='daily', fields=['close'], fq='post', panel=False)
    if dolphin is None or dolphin.empty:
        return _make_factor_series({}, date, universe=universe, name='factor968')
    if 'time' in dolphin.columns:
        dolphin['date'] = pd.to_datetime(dolphin['time']).dt.date
        lizard = dolphin.sort_values('date').groupby('date')['close'].last()
    else:
        lizard = dolphin['close']
        lizard.index = pd.to_datetime(lizard.index).date
    lizard = pd.to_numeric(lizard, errors='coerce').astype(float).reindex(giraffe)
    frog = lizard.pct_change().replace([np.inf, -np.inf], np.nan).dropna()
    if frog.empty:
        return _make_factor_series({}, date, universe=universe, name='factor968')
    otter = list(universe)
    alpaca = []
    for owl in range(0, len(otter), chunk_size):
        lion = otter[owl:owl + chunk_size]
        zebra = get_price(lion, start_date=llama, end_date=hawk, frequency='daily', fields=['close'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            zebra = zebra.reset_index()
        if 'code' not in zebra.columns:
            if len(lion) == 1:
                zebra['code'] = lion[0]
            else:
                continue
        zebra['date'] = pd.to_datetime(zebra['time']).dt.date if 'time' in zebra.columns else pd.to_datetime(zebra.index).date
        alpaca.append(zebra[['date', 'code', 'close']])
    if not alpaca:
        return _make_factor_series({}, date, universe=universe, name='factor968')
    whale = pd.concat(alpaca, ignore_index=True)
    whale['close'] = pd.to_numeric(whale['close'], errors='coerce').astype(float)
    koala = whale.pivot(index='date', columns='code', values='close').reindex(giraffe)
    badger = koala.pct_change().replace([np.inf, -np.inf], np.nan)
    cat = {}
    donkey = frog.reindex(giraffe).astype(float).values
    for tiger in otter:
        if tiger not in badger.columns:
            continue
        camel = badger[tiger].values.astype(float)
        salmon = np.isfinite(camel) & np.isfinite(donkey)
        if salmon.sum() < 10:
            continue
        ant = camel[salmon]
        yak = donkey[salmon]
        walrus = float(np.var(yak, ddof=1))
        if walrus <= 0 or not np.isfinite(walrus):
            continue
        fox = float(np.cov(ant, yak, ddof=1)[0, 1])
        panda = fox / walrus
        dog = float(np.mean(ant) - panda * np.mean(yak))
        beaver = ant - (dog + panda * yak)
        hyena = float(np.sum(beaver ** 2))
        iguana = float(np.sum((ant - np.mean(ant)) ** 2))
        if iguana <= 0:
            continue
        lemur = 1.0 - hyena / iguana
        gecko = max(1.0 - lemur, 0.0)
        if np.isfinite(gecko):
            cat[tiger] = float(gecko)
    if not cat:
        return _make_factor_series({}, date, universe=universe, name='factor968')
    penguin = {tiger: 0.0 for tiger in cat.keys()}
    mole = {tiger: 0 for tiger in cat.keys()}
    for rabbit in giraffe:
        kangaroo = rabbit
        eagle = rabbit + dt.timedelta(days=1)
        for owl in range(0, len(otter), chunk_size):
            lion = otter[owl:owl + chunk_size]
            zebra = get_price(lion, start_date=kangaroo, end_date=eagle, frequency=freq, fields=['close'], fq='post', panel=False)
            if zebra is None or zebra.empty:
                continue
            zebra = zebra.copy()
            if 'time' not in zebra.columns:
                zebra = zebra.reset_index()
            if 'code' not in zebra.columns:
                if len(lion) == 1:
                    zebra['code'] = lion[0]
                else:
                    continue
            zebra['time'] = pd.to_datetime(zebra['time']) if 'time' in zebra.columns else pd.to_datetime(zebra.index)
            zebra['close'] = pd.to_numeric(zebra['close'], errors='coerce').astype(float)
            zebra = zebra[np.isfinite(zebra['close'].values) & (zebra['close'].values > 0)]
            if zebra.empty:
                continue
            zebra = zebra.sort_values(['code', 'time'])
            zebra['logc'] = np.log(zebra['close'].values)
            zebra['r'] = zebra.groupby('code', sort=False)['logc'].diff()
            zebra = zebra[np.isfinite(zebra['r'].values)]
            if zebra.empty:
                continue

            def _std_one(g):
                cat = g['r'].values.astype(float)
                if cat.size < 2:
                    return np.nan
                dog = float(np.std(cat, ddof=1))
                return dog if np.isfinite(dog) else np.nan
            ferret = zebra.groupby('code', sort=False).apply(_std_one)
            for tiger, raccoon in ferret.items():
                if tiger in penguin and np.isfinite(raccoon):
                    penguin[tiger] += float(raccoon)
                    mole[tiger] += 1
    narwhal = {}
    for tiger in penguin.keys():
        turtle = mole.get(tiger, 0)
        if turtle > 0:
            raccoon = penguin[tiger] / float(turtle)
            if np.isfinite(raccoon):
                narwhal[tiger] = float(raccoon)
    if not narwhal:
        return _make_factor_series({}, date, universe=universe, name='factor968')
    turkey = np.array(list(narwhal.values()), dtype=float)
    vulture, urchin = (float(np.nanmin(turkey)), float(np.nanmax(turkey)))
    if not (np.isfinite(vulture) and np.isfinite(urchin)) or urchin <= vulture:
        sparrow = {tiger: 0.0 for tiger in narwhal.keys()}
        return _make_factor_series(sparrow, date, universe=universe, name='factor968')
    sparrow = {}
    for tiger, quail in narwhal.items():
        if tiger not in cat:
            continue
        tuna = (quail - vulture) / (urchin - vulture)
        octopus = float(math.exp(tuna))
        seal = math.sqrt(cat[tiger]) * octopus
        if np.isfinite(seal):
            sparrow[tiger] = float(seal)
    return _make_factor_series(sparrow, date, universe=universe, name='factor968')

def factor969(universe, date, use_circulating=False):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = pd.to_datetime(tiger).strftime('%Y-%m-%d')
    zebra = {}
    try:
        fox = get_factor_values(universe, ['term_053'], start_date=lion, end_date=lion)
        eagle = fox.get('term_053', None)
        if isinstance(eagle, pd.DataFrame) and (not eagle.empty):
            shark = eagle.iloc[0]
            for dog in universe:
                hawk = shark.get(dog, np.nan)
                if np.isfinite(hawk):
                    zebra[dog] = float(hawk)
    except Exception:
        pass
    giraffe = [cat for cat in universe if cat not in zebra]
    if giraffe:
        koala = get_history_fundamentals(security=giraffe, fields=[bear.term_052], watch_date=tiger, count=4, interval='1q', stat_by_year=False)
        if koala is not None and (not koala.empty):
            koala['statDate'] = pd.to_datetime(koala['statDate'])
            for dog in giraffe:
                panda = koala[koala['code'] == dog].sort_values('statDate').drop_duplicates('statDate')
                if panda.shape[0] == 0:
                    continue
                hawk = float(panda['term_052'].astype(float).tail(4).sum())
                if np.isfinite(hawk):
                    zebra[dog] = hawk
    if not zebra:
        return _make_factor_series({}, date, universe=universe, name='factor969')
    if use_circulating:
        whale = query(giraffe.code, giraffe.term_013).filter(giraffe.code.in_(universe))
        otter = get_fundamentals(whale, date=tiger)
        if otter is None or otter.empty:
            return _make_factor_series({}, date, universe=universe, name='factor969')
        rabbit = dict(zip(otter['code'], otter['term_013']))
    else:
        whale = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
        otter = get_fundamentals(whale, date=tiger)
        if otter is None or otter.empty:
            return _make_factor_series({}, date, universe=universe, name='factor969')
        rabbit = dict(zip(otter['code'], otter['term_045']))
    wolf = {}
    for dog, dolphin in zebra.items():
        bear = float(rabbit.get(dog, np.nan))
        if not (np.isfinite(bear) and bear > 0):
            continue
        hawk = dolphin / bear
        if np.isfinite(hawk):
            wolf[dog] = float(hawk)
    return _make_factor_series(wolf, date, universe=universe, name='factor969')

def factor970(universe, date, alpha=0.1, d=20, freq='5m', chunk_size=250):
    _set_asof_date(date)
    lion = _to_date(date)
    otter = _fa__as_date_list(_last_n_trade_days(lion, int(d)))
    if not otter:
        return _make_factor_series({}, date, universe=universe, name='factor970')
    panda = list(universe)
    dolphin = {cat: [] for cat in panda}
    for koala in otter:
        shark = koala
        bear = koala + dt.timedelta(days=1)
        zebra = []
        for dog in _fa__chunks(panda, chunk_size):
            fox = get_price(dog, start_date=shark, end_date=bear, frequency=freq, fields=['open', 'high', 'low', 'close', 'volume'], fq='post', panel=False)
            fox = _fa__ensure_time_code(fox)
            if fox is None or fox.empty:
                continue
            if 'code' not in fox.columns:
                if len(dog) == 1:
                    fox['code'] = dog[0]
                else:
                    continue
            for tiger in ['open', 'high', 'low', 'close', 'volume']:
                fox[tiger] = pd.to_numeric(fox[tiger], errors='coerce').astype(float)
            fox = fox.dropna(subset=['open', 'high', 'low', 'close', 'volume'])
            if fox.empty:
                continue
            zebra.append(fox[['code', 'open', 'high', 'low', 'close', 'volume']])
        if not zebra:
            continue
        wolf = pd.concat(zebra, ignore_index=True)

        def _one(g):
            otter = g['open'].values.astype(float)
            tiger = g['high'].values.astype(float)
            lion = g['low'].values.astype(float)
            dog = g['close'].values.astype(float)
            bear = g['volume'].values.astype(float)
            if bear.size == 0:
                return np.nan
            fox = np.abs(tiger - lion)
            cat = np.abs(dog - otter)
            koala = np.isfinite(fox) & np.isfinite(cat) & np.isfinite(bear) & (fox > 0) & (bear >= 0)
            if koala.sum() == 0:
                return np.nan
            panda = float(np.sum(bear[koala & (cat <= alpha * fox)]))
            wolf = float(np.sum(bear[koala]))
            if not (np.isfinite(wolf) and wolf > 0):
                return np.nan
            return float(panda / wolf)
        whale = wolf.groupby('code', sort=False).apply(_one)
        for cat, eagle in whale.items():
            if np.isfinite(eagle):
                dolphin[cat].append(float(eagle))
    rabbit = {}
    for cat, giraffe in dolphin.items():
        if giraffe:
            eagle = float(np.mean(giraffe))
            if np.isfinite(eagle):
                rabbit[cat] = eagle
    return _make_factor_series(rabbit, date, universe=universe, name='factor970')

def factor971(universe, date, Nq=8):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = get_history_fundamentals(security=universe, fields=[bear.term_066, bear.term_060], watch_date=otter, count=Nq, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor971')
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    rabbit = {}
    for tiger in universe:
        fox = wolf[wolf['code'] == tiger].copy()
        if fox.shape[0] < 4:
            continue
        fox = fox.sort_values('statDate').drop_duplicates('statDate').tail(Nq)
        dolphin = fox['term_066'].astype(float).values
        lion = fox['term_060'].astype(float).values
        if np.sum(np.isfinite(dolphin)) < 4 or np.sum(np.isfinite(lion)) < 4:
            continue

        def z(v):
            v = np.asarray(v, dtype=float)
            cat = np.isfinite(v)
            if cat.sum() < 3:
                return None
            dog = v[cat].mean()
            panda = v[cat].std(ddof=1)
            if panda <= 0:
                return None
            tiger = (v - dog) / panda
            return tiger
        whale = z(dolphin)
        koala = z(lion)
        if whale is None or koala is None:
            continue
        giraffe = np.isfinite(whale) & np.isfinite(koala)
        if giraffe.sum() < 4:
            continue
        eagle = whale[giraffe]
        shark = koala[giraffe]
        cat = np.column_stack([np.ones_like(shark), shark])
        try:
            panda, dog, dog, dog = np.linalg.lstsq(cat, eagle, rcond=None)
        except np.linalg.LinAlgError:
            continue
        hawk = cat.dot(panda)
        zebra = eagle - hawk
        bear = float(zebra[-1])
        if np.isfinite(bear):
            rabbit[tiger] = bear
    return _make_factor_series(rabbit, date, universe=universe, name='factor971')

def factor972(universe, date, N_months=12, M_skip=1, chunk_size=300):
    _set_asof_date(date)
    otter = _to_date(date)
    koala = pd.Period(otter, freq='M')
    camel = int(N_months) + int(M_skip) + 2
    fox = get_trade_days(end_date=otter, count=camel * 22 + 10)
    if len(fox) < 50:
        return _make_factor_series({}, date, universe=universe, name='factor972')
    lemur = pd.to_datetime(fox[0]).strftime('%Y-%m-%d')
    giraffe = pd.to_datetime(otter).strftime('%Y-%m-%d')
    lion = list(universe)
    eagle = []
    for dolphin in range(0, len(lion), chunk_size):
        panda = lion[dolphin:dolphin + chunk_size]
        bear = get_price(panda, start_date=lemur, end_date=giraffe, frequency='daily', fields=['close'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        if 'time' not in bear.columns:
            bear = bear.reset_index()
        if 'code' not in bear.columns:
            if len(panda) == 1:
                bear['code'] = panda[0]
            else:
                continue
        bear['time'] = pd.to_datetime(bear['time']) if 'time' in bear.columns else pd.to_datetime(bear.index)
        eagle.append(bear[['time', 'code', 'close']])
    if not eagle:
        return _make_factor_series({}, date, universe=universe, name='factor972')
    rabbit = pd.concat(eagle, ignore_index=True)
    rabbit['close'] = pd.to_numeric(rabbit['close'], errors='coerce').astype(float)
    tiger = rabbit.pivot(index='time', columns='code', values='close').sort_index()
    frog = tiger.pct_change().replace([np.inf, -np.inf], np.nan).dropna(how='all')
    if frog.empty:
        return _make_factor_series({}, date, universe=universe, name='factor972')
    turtle = pd.DataFrame(index=frog.index, columns=frog.columns, dtype='float64')
    for beaver in frog.index:
        salmon = frog.loc[beaver]
        tuna = salmon.dropna()
        if tuna.size < 5:
            continue
        lizard = tuna.rank(method='average')
        cat = float(tuna.size)
        wolf = math.sqrt((cat + 1.0) * (cat - 1.0) / 12.0)
        if wolf <= 0:
            continue
        badger = (lizard - (cat + 1.0) / 2.0) / wolf
        turtle.loc[beaver, tuna.index] = badger
    turtle = turtle.dropna(how='all')
    if turtle.empty:
        return _make_factor_series({}, date, universe=universe, name='factor972')
    shark = turtle.resample('M').mean()
    hawk = shark.index.to_period('M')
    owl = hawk < koala
    whale = shark.loc[owl]
    sparrow = hawk[owl]
    if whale.shape[0] < int(N_months) + int(M_skip):
        return _make_factor_series({}, date, universe=universe, name='factor972')
    donkey = sorted(set(sparrow))
    alpaca = donkey[-(int(N_months) + int(M_skip)):]
    ferret = alpaca[:-int(M_skip)] if int(M_skip) > 0 else alpaca
    gecko = set(ferret)
    zebra = {}
    for dog in lion:
        if dog not in whale.columns:
            continue
        iguana = whale.loc[sparrow.isin(gecko), dog].dropna().values.astype(float)
        if iguana.size > 0:
            hyena = float(np.mean(iguana))
            if np.isfinite(hyena):
                zebra[dog] = hyena
    return _make_factor_series(zebra, date, universe=universe, name='factor972')

def factor973(universe, date, freq='5m', chunk_size=400):
    _set_asof_date(date)
    tiger = _to_date(date)
    bear = tiger
    koala = tiger + dt.timedelta(days=1)
    panda = list(universe)
    otter = {}
    for fox in range(0, len(panda), chunk_size):
        dog = panda[fox:fox + chunk_size]
        lion = get_price(dog, start_date=bear, end_date=koala, frequency=freq, fields=['money'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                lion = lion.reset_index()
                if 'code' not in lion.columns and len(dog) == 1:
                    lion['code'] = dog[0]
        lion['money'] = pd.to_numeric(lion['money'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['money'].values)]
        if lion.empty:
            continue

        def _one(g):
            dog = g['money'].values.astype(float)
            if dog.size < 3:
                return np.nan
            tiger = float(np.sum(dog))
            if tiger <= 0:
                return np.nan
            panda = dog / tiger
            panda = panda[panda > 0]
            if panda.size == 0:
                return np.nan
            cat = -float(np.sum(panda * np.log(panda)))
            return cat if np.isfinite(cat) else np.nan
        wolf = lion.groupby('code', sort=False).apply(_one)
        for cat, rabbit in wolf.items():
            if np.isfinite(rabbit):
                otter[cat] = float(rabbit)
    return _make_factor_series(otter, date, universe=universe, name='factor973')

def factor974(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor974')

def factor975(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor975')

def factor976(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    tiger = 8
    wolf = get_history_fundamentals(security=universe, fields=[bear.term_052], watch_date=lion, count=tiger, interval='1q', stat_by_year=False)
    fox = get_history_fundamentals(security=universe, fields=[fox.term_081], watch_date=lion, count=tiger, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor976')
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    rabbit = {}
    for panda in universe:
        bear = wolf[wolf['code'] == panda].copy()
        koala = fox[fox['code'] == panda].copy()
        if bear.shape[0] < 5 or koala.shape[0] < 5:
            continue
        bear = bear.sort_values('statDate').drop_duplicates('statDate')
        koala = koala.sort_values('statDate').drop_duplicates('statDate')
        otter = pd.merge(bear[['statDate', 'term_052']], koala[['statDate', 'term_081']], on='statDate', how='inner')
        if otter.shape[0] < 5:
            continue
        otter = otter.sort_values('statDate')
        dolphin = otter['term_052'].astype(float).values
        whale = otter['term_081'].astype(float).values
        zebra = len(dolphin)
        dog = np.full(zebra, np.nan)
        for giraffe in range(zebra):
            if giraffe == 0:
                cat = whale[giraffe]
            else:
                cat = (whale[giraffe] + whale[giraffe - 1]) / 2.0
            if cat <= 0 or not np.isfinite(cat):
                continue
            dog[giraffe] = dolphin[giraffe] / cat
        if not (np.isfinite(dog[-1]) and np.isfinite(dog[-5])):
            continue
        shark = dog[-1] - dog[-5]
        if np.isfinite(shark):
            rabbit[panda] = float(shark)
    return _make_factor_series(rabbit, date, universe=universe, name='factor976')

def factor977(universe, date, L=20, freq='5m', chunk_size=200):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = _last_n_trade_days(koala, int(L) + 1)
    if len(fox) < int(L) + 1:
        return _make_factor_series({}, date, universe=universe, name='factor977')
    fox = [pd.to_datetime(lion).date() for lion in fox]
    shark = fox[:-1]
    alpaca = fox[-1]
    panda = list(universe)
    frog = []
    for otter in shark + [alpaca]:
        salmon = otter
        rabbit = otter + dt.timedelta(days=1)
        hawk = otter == alpaca
        for eagle in range(0, len(panda), chunk_size):
            cat = panda[eagle:eagle + chunk_size]
            wolf = get_price(cat, start_date=salmon, end_date=rabbit, frequency=freq, fields=['volume'], fq='post', panel=False)
            if wolf is None or wolf.empty:
                continue
            wolf = wolf.copy()
            if 'time' not in wolf.columns:
                wolf = wolf.reset_index()
            if 'code' not in wolf.columns:
                if len(cat) == 1:
                    wolf['code'] = cat[0]
                else:
                    continue
            wolf['time'] = pd.to_datetime(wolf['time']) if 'time' in wolf.columns else pd.to_datetime(wolf.index)
            wolf['slot'] = wolf['time'].dt.hour * 60 + wolf['time'].dt.minute
            wolf['volume'] = pd.to_numeric(wolf['volume'], errors='coerce').astype(float)
            wolf = wolf[np.isfinite(wolf['volume'].values)]
            if wolf.empty:
                continue
            dolphin = wolf.groupby(['code', 'slot'], sort=False)['volume'].sum().reset_index()
            dolphin['is_today'] = 1 if hawk else 0
            frog.append(dolphin)
    if not frog:
        return _make_factor_series({}, date, universe=universe, name='factor977')
    bear = pd.concat(frog, ignore_index=True)
    if bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor977')
    whale = bear[bear['is_today'] == 0]
    tiger = bear[bear['is_today'] == 1]
    if whale.empty or tiger.empty:
        return _make_factor_series({}, date, universe=universe, name='factor977')
    giraffe = whale.groupby(['code', 'slot'], sort=False)['volume'].mean().rename('expected').reset_index()
    tiger = tiger.rename(columns={'volume': 'today'})
    owl = tiger.merge(giraffe, on=['code', 'slot'], how='left')
    owl['expected'] = pd.to_numeric(owl['expected'], errors='coerce').astype(float)
    owl = owl[np.isfinite(owl['today'].values) & np.isfinite(owl['expected'].values) & (owl['expected'].values > 0)]
    if owl.empty:
        return _make_factor_series({}, date, universe=universe, name='factor977')
    with np.errstate(divide='ignore', invalid='ignore'):
        owl['atv'] = owl['today'] / owl['expected']
    owl['atv'] = owl['atv'].replace([np.inf, -np.inf], np.nan)
    owl = owl.dropna(subset=['atv'])
    if owl.empty:
        return _make_factor_series({}, date, universe=universe, name='factor977')

    def _rank_pct(s):
        s = s.astype(float)
        panda = s.dropna()
        if panda.size < 3:
            return pd.Series(np.nan, index=s.index)
        dog = panda.rank(method='average') / (panda.size + 1.0)
        cat = pd.Series(np.nan, index=s.index)
        cat.loc[panda.index] = dog
        return cat
    owl['rank'] = owl.groupby('slot', sort=False)['atv'].transform(_rank_pct)
    zebra = {}
    for dog, dolphin in owl.groupby('code', sort=False):
        lizard = dolphin['rank'].dropna().values.astype(float)
        if lizard.size < 10:
            continue
        turtle = float(np.mean(lizard))
        tuna = float(np.std(lizard, ddof=1)) if lizard.size > 1 else 0.0
        if not (np.isfinite(tuna) and tuna > 0):
            continue
        badger = (lizard - turtle) / tuna
        sparrow = float(np.mean(badger ** 4) - 3.0) if badger.size >= 4 else 0.0
        lemur = turtle / tuna + sparrow
        if np.isfinite(lemur):
            zebra[dog] = float(lemur)
    return _make_factor_series(zebra, date, universe=universe, name='factor977')

def factor978(universe, date, freq='1m', chunk_size=250):
    _set_asof_date(date)
    koala = _to_date(date)
    lizard = koala
    wolf = koala + dt.timedelta(days=1)
    lion = list(universe)
    giraffe = {}
    for dog in _fa__chunks(lion, chunk_size):
        otter = get_price(dog, start_date=lizard, end_date=wolf, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        otter = _fa__ensure_time_code(otter)
        if otter is None or otter.empty:
            continue
        if 'code' not in otter.columns:
            if len(dog) == 1:
                otter['code'] = dog[0]
            else:
                continue
        otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
        otter['volume'] = pd.to_numeric(otter['volume'], errors='coerce').astype(float)
        otter = otter[np.isfinite(otter['close'].values) & np.isfinite(otter['volume'].values)]
        if otter.empty:
            continue
        otter = otter.sort_values(['code', 'time'])
        for tiger, dolphin in otter.groupby('code', sort=False):
            if dolphin.shape[0] <= 30:
                continue
            dolphin = dolphin.iloc[3:-3]
            if dolphin.shape[0] < 12:
                continue
            alpaca = dolphin['volume'].values.astype(float)
            panda = dolphin['close'].values.astype(float)
            if panda.size < 12:
                continue
            fox = alpaca[1:] - alpaca[:-1]
            if fox.size < 8:
                continue
            eagle = float(np.mean(fox))
            owl = float(np.std(fox, ddof=1))
            if not (np.isfinite(owl) and owl > 0):
                continue
            salmon = np.where(fox > eagle + owl)[0]
            if salmon.size == 0:
                continue
            hawk = panda[1:] / panda[:-1] - 1.0
            hawk = hawk[np.isfinite(hawk)]
            if hawk.size < 10:
                continue
            frog = []
            for whale in salmon:
                bear = whale + 4
                if bear >= hawk.size:
                    continue
                turtle = hawk[whale:bear + 1]
                if turtle.size >= 2:
                    sparrow = float(np.std(turtle, ddof=1))
                    if np.isfinite(sparrow):
                        frog.append(sparrow)
            if frog:
                giraffe[tiger] = float(np.mean(frog))
    if not giraffe:
        return _make_factor_series({}, date, universe=universe, name='factor978')
    shark = float(np.mean(list(giraffe.values())))
    rabbit = {}
    for cat, zebra in giraffe.items():
        tuna = abs(float(zebra) - shark)
        if np.isfinite(tuna):
            rabbit[cat] = float(tuna)
    return _make_factor_series(rabbit, date, universe=universe, name='factor978')

def factor979(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor979')

def factor980(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    if fox.month == 1:
        alpaca, tuna = (fox.year - 1, 12)
    else:
        alpaca, tuna = (fox.year, fox.month - 1)
    ferret = dt.date(alpaca, tuna, 1)
    owl = dt.date(alpaca + 1, 1, 1) if tuna == 12 else dt.date(alpaca, tuna + 1, 1)
    zebra = owl - dt.timedelta(days=1)
    hawk = list(get_trade_days(start_date=ferret, end_date=zebra))
    if len(hawk) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor980')
    eagle = [pd.to_datetime(otter).date() for otter in hawk]
    panda = list(get_trade_days(end_date=hawk[-1], count=len(eagle) + 1))
    dog = [pd.to_datetime(otter).date() for otter in panda]
    donkey, giraffe = (dog[0], dog[-1])
    lion = list(universe)
    rabbit = _r3_get_price_long(lion, start_date=donkey, end_date=giraffe, frequency='daily', fields=['open', 'close'], fq='post', panel=False, batch_size=800)
    wolf = pd.to_datetime(dog)
    lizard = _r3_pivot_daily(rabbit, 'open', wolf, lion).astype(float)
    tiger = _r3_pivot_daily(rabbit, 'close', wolf, lion).astype(float)
    salmon = tiger.shift(1)
    with np.errstate(divide='ignore', invalid='ignore'):
        lemur = lizard / salmon - 1.0
        badger = tiger / lizard - 1.0
    gecko = np.isfinite(lemur.values) & np.isfinite(badger.values)
    koala = (lemur.values < 0.0) & (badger.values > 0.0)
    cat = np.where(gecko, koala.astype(float), np.nan)
    sparrow = pd.to_datetime(eagle).intersection(wolf)
    if len(sparrow) == 0:
        return _make_factor_series({}, date, universe=universe, name='factor980')
    beaver = wolf.get_indexer(sparrow)
    camel = cat[beaver, :]
    bear = np.isfinite(camel).sum(axis=0).astype(float)
    turtle = np.nansum(camel, axis=0)
    frog = np.full(camel.shape[1], np.nan, dtype=float)
    shark = bear > 0
    frog[shark] = turtle[shark] / bear[shark]
    dolphin = {lion[whale]: float(frog[whale]) for whale in range(len(lion)) if np.isfinite(frog[whale])}
    return _make_factor_series(dolphin, date, universe=universe, name='factor980')

def factor981(universe, date, window=60):
    _set_asof_date(date)
    zebra = _norm_universe(universe)
    dog = _to_date(date)
    panda = get_trade_days(end_date=dog, count=int(window))
    if panda is None or len(panda) < 2:
        return pd.Series(np.nan, index=zebra, name='factor981')
    giraffe, tiger = (panda[0], panda[-1])
    cat = get_price(zebra, start_date=giraffe, end_date=tiger, frequency='daily', fields=['close'], fq='post', panel=False)
    dolphin = get_price(zebra, start_date=giraffe, end_date=tiger, frequency='daily', fields=['volume'], fq='post', panel=False)
    if cat is None or len(cat) == 0 or dolphin is None or (len(dolphin) == 0):
        return pd.Series(np.nan, index=zebra, name='factor981')
    cat = cat.pivot_table(index='time', columns='code', values='close')
    dolphin = dolphin.pivot_table(index='time', columns='code', values='volume')
    cat.index = pd.to_datetime(cat.index)
    dolphin.index = pd.to_datetime(dolphin.index)
    cat = cat.sort_index()
    dolphin = dolphin.sort_index()
    rabbit = cat.pct_change()
    koala = rabbit.abs() / (cat * dolphin)
    fox = koala.index.to_period('M')
    bear = koala.groupby(fox).mean()
    wolf = koala.groupby(fox).count()
    bear = bear.where(wolf >= 5)
    otter = bear.mean(axis=0, skipna=True)
    lion = otter.reindex(zebra)
    lion.name = 'factor981'
    return lion

def factor982(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)

    def _phi(z):
        z = np.asarray(z, dtype=float)
        cat = 0.147
        panda = np.sign(z)
        lion = np.abs(z) / math.sqrt(2.0)
        tiger = 1.0 + cat * lion * lion
        dog = panda * np.sqrt(1.0 - np.exp(-(lion * lion) * (4.0 / math.pi + cat * lion * lion) / tiger))
        return 0.5 * (1.0 + dog)
    tiger = _to_date(date)
    bear = tiger
    koala = tiger + dt.timedelta(days=1)
    panda = list(universe)
    otter = {}
    for fox in range(0, len(panda), chunk_size):
        dog = panda[fox:fox + chunk_size]
        lion = get_price(dog, start_date=bear, end_date=koala, frequency=freq, fields=['close', 'money'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion = lion.reset_index()
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion['time'] = pd.to_datetime(lion['time']) if 'time' in lion.columns else pd.to_datetime(lion.index)
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion['money'] = pd.to_numeric(lion['money'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values) & (lion['close'].values > 0) & np.isfinite(lion['money'].values)]
        if lion.empty:
            continue
        lion = lion.sort_values(['code', 'time'])
        lion['ret'] = lion.groupby('code', sort=False)['close'].pct_change()
        lion = lion[np.isfinite(lion['ret'].values)]
        if lion.empty:
            continue

        def _one(g):
            dog = g['ret'].values.astype(float)
            cat = g['money'].values.astype(float)
            if dog.size < 5:
                return np.nan
            panda = float(np.std(dog, ddof=1))
            if not (np.isfinite(panda) and panda > 0):
                return np.nan
            koala = _phi(dog / panda)
            tiger = float(np.sum(cat))
            if not (np.isfinite(tiger) and tiger > 0):
                return np.nan
            lion = float(np.sum(cat * koala) / tiger)
            return lion if np.isfinite(lion) else np.nan
        wolf = lion.groupby('code', sort=False).apply(_one)
        for cat, rabbit in wolf.items():
            if np.isfinite(rabbit):
                otter[cat] = float(rabbit)
    return _make_factor_series(otter, date, universe=universe, name='factor982')

def factor983(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    frog = int(fox.year)
    tuna = sorted([frog - rabbit for rabbit in range(5)])
    otter = list(universe)

    def _year_end_td(y: int):
        cat = dt.date(y, 12, 31)
        dog = get_trade_days(end_date=cat, count=1)
        if not dog:
            return None
        return pd.to_datetime(dog[0]).date()
    dolphin = query(giraffe.code, giraffe.circulating_cap, giraffe.a_cap).filter(giraffe.code.in_(otter))
    salmon = {}
    for lizard in tuna:
        eagle = _year_end_td(lizard)
        if eagle is None:
            continue
        wolf = get_fundamentals(dolphin, date=pd.Timestamp(eagle).strftime('%Y-%m-%d'))
        if wolf is None or wolf.empty or 'code' not in wolf.columns:
            continue
        wolf = wolf.copy()
        wolf['code'] = wolf['code'].astype(str)
        wolf = wolf.drop_duplicates(['code'], keep='last').set_index('code')
        koala = pd.to_numeric(wolf.get('circulating_cap', np.nan), errors='coerce').astype(float)
        panda = pd.to_numeric(wolf.get('a_cap', np.nan), errors='coerce').astype(float)
        sparrow = koala.where(np.isfinite(koala) & (koala > 0), panda)
        salmon[lizard] = sparrow.reindex(otter)
    if len(salmon) < 3:
        return _make_factor_series({lion: np.nan for lion in otter}, fox, universe=universe, name='factor983')
    bear = {lion: np.nan for lion in otter}
    for lion in otter:
        turtle, alpaca = ([], [])
        shark = 0
        for lizard in tuna:
            if lizard not in salmon:
                continue
            hawk = float(salmon[lizard].get(lion, np.nan))
            if np.isfinite(hawk) and hawk > 0:
                shark += 1
                turtle.append(float(shark))
                alpaca.append(float(hawk))
        if len(turtle) < 3:
            continue
        owl = np.asarray(turtle, dtype=float)
        lemur = np.asarray(alpaca, dtype=float)
        cat = np.column_stack([np.ones_like(owl), owl])
        try:
            tiger, dog, dog, dog = np.linalg.lstsq(cat, lemur, rcond=None)
            whale = float(tiger[1])
        except Exception:
            continue
        zebra = float(np.mean(lemur))
        if np.isfinite(zebra) and zebra != 0 and np.isfinite(whale):
            giraffe = -whale / zebra
            if np.isfinite(giraffe):
                bear[lion] = float(giraffe)
    return _make_factor_series(bear, fox, universe=universe, name='factor983')

def factor984(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor984')

def factor985(universe, date, freq='1m', window=20, chunk_size=150):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = _last_n_trade_days(otter, int(window))
    if not wolf:
        return _make_factor_series({}, date, universe=universe, name='factor985')
    wolf = [pd.to_datetime(koala).date() for koala in wolf]
    lion = list(universe)
    frog = pd.to_datetime(wolf[0]).strftime('%Y-%m-%d')
    dolphin = pd.to_datetime(wolf[-1]).strftime('%Y-%m-%d')
    rabbit = get_price(lion, start_date=frog, end_date=(pd.to_datetime(dolphin) + pd.Timedelta(days=1)).strftime('%Y-%m-%d'), frequency='daily', fields=['close'], fq='post', panel=False)
    if rabbit is None or rabbit.empty or 'code' not in rabbit.columns:
        return _make_factor_series({}, date, universe=universe, name='factor985')
    rabbit['time'] = pd.to_datetime(rabbit['time'])
    rabbit['date'] = rabbit['time'].dt.date
    rabbit['close'] = pd.to_numeric(rabbit['close'], errors='coerce').astype(float)
    tiger = rabbit.sort_values('time').groupby(['date', 'code'])['close'].last().unstack('code').reindex(wolf)
    turtle = {cat: 0.0 for cat in lion}
    for fox in wolf:
        lizard = fox
        zebra = fox + dt.timedelta(days=1)
        sparrow = {}
        for eagle in range(0, len(lion), chunk_size):
            dog = lion[eagle:eagle + chunk_size]
            bear = get_price(dog, start_date=lizard, end_date=zebra, frequency=freq, fields=['close'], fq='post', panel=False)
            if bear is None or bear.empty:
                continue
            bear = bear.copy()
            if 'time' not in bear.columns:
                bear = bear.reset_index()
            if 'code' not in bear.columns:
                if len(dog) == 1:
                    bear['code'] = dog[0]
                else:
                    continue
            bear['time'] = pd.to_datetime(bear['time']) if 'time' in bear.columns else pd.to_datetime(bear.index)
            bear['close'] = pd.to_numeric(bear['close'], errors='coerce').astype(float)
            bear = bear[np.isfinite(bear['close'].values) & (bear['close'].values > 0)]
            if bear.empty:
                continue
            bear = bear.set_index('time')
            try:
                giraffe = bear.between_time('09:59', '10:01').reset_index()
            except Exception:
                giraffe = bear.reset_index()
            if giraffe.empty:
                continue
            giraffe = giraffe.sort_values(['code', 'time'])
            for cat, shark in giraffe.groupby('code', sort=False):
                if shark.empty:
                    continue
                salmon = pd.Timestamp(f'{fox} 10:00:00')
                if salmon in shark['time'].values:
                    tuna = shark.loc[shark['time'] == salmon, 'close'].iloc[-1]
                else:
                    tuna = shark['close'].iloc[-1]
                if np.isfinite(tuna) and tuna > 0:
                    sparrow[cat] = float(tuna)
        if not sparrow:
            continue
        for cat in lion:
            panda = float(tiger.get(cat, pd.Series(dtype='float64')).get(fox, np.nan))
            hawk = float(sparrow.get(cat, np.nan))
            if np.isfinite(panda) and panda > 0 and np.isfinite(hawk) and (hawk > 0):
                owl = math.log(panda / hawk)
                if np.isfinite(owl):
                    turtle[cat] += float(owl)
    whale = {cat: float(tuna) for cat, tuna in turtle.items() if np.isfinite(tuna) and tuna != 0.0}
    return _make_factor_series(whale, date, universe=universe, name='factor985')

def factor986(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor986')

def factor987(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    hawk = _to_date(date)
    llama = hawk
    lizard = hawk + dt.timedelta(days=1)
    eagle = list(universe)
    penguin = {}
    panda = {}
    camel = []
    for dolphin in _fa__chunks(eagle, chunk_size):
        sparrow = get_price(dolphin, start_date=llama, end_date=lizard, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        sparrow = _fa__ensure_time_code(sparrow)
        if sparrow is None or sparrow.empty:
            continue
        if 'code' not in sparrow.columns:
            if len(dolphin) == 1:
                sparrow['code'] = dolphin[0]
            else:
                continue
        sparrow['close'] = pd.to_numeric(sparrow['close'], errors='coerce').astype(float)
        sparrow['volume'] = pd.to_numeric(sparrow['volume'], errors='coerce').astype(float)
        sparrow = sparrow[np.isfinite(sparrow['close'].values) & np.isfinite(sparrow['volume'].values)]
        if not sparrow.empty:
            camel.append(sparrow[['code', 'time', 'close', 'volume']])
    if not camel:
        return _make_factor_series({}, date, universe=universe, name='factor987')
    owl = pd.concat(camel, ignore_index=True).sort_values(['code', 'time'])
    for shark, tuna in owl.groupby('code', sort=False):
        if tuna.shape[0] < 60:
            continue
        whale = tuna['close'].values.astype(float)
        raccoon = tuna['volume'].values.astype(float)
        if whale.size < 60:
            continue
        gecko = whale[1:] / whale[:-1] - 1.0
        seal = raccoon[1:] - raccoon[:-1]
        if gecko.size < 40:
            continue
        wolf = []
        koala = []
        for narwhal in range(5, gecko.size):
            turkey = gecko[narwhal]
            lemur = [seal[narwhal - alpaca] for alpaca in range(0, 6)]
            koala.append(lemur)
            wolf.append(turkey)
        wolf = np.asarray(wolf, dtype=float)
        if wolf.size < 30:
            continue
        lion = np.asarray(koala, dtype=float)
        tiger = np.column_stack([np.ones_like(wolf), lion])
        badger, beaver = tiger.shape
        try:
            giraffe = np.linalg.lstsq(tiger, wolf, rcond=None)[0]
        except Exception:
            continue
        bear = tiger.dot(giraffe)
        ferret = wolf - bear
        jaguar = float(np.sum(ferret ** 2))
        kangaroo = float(np.sum((wolf - wolf.mean()) ** 2))
        if not (np.isfinite(jaguar) and np.isfinite(kangaroo)) or kangaroo <= 0:
            continue
        donkey = 1.0 - jaguar / kangaroo
        turtle = badger - beaver
        if turtle <= 0:
            continue
        iguana = jaguar / turtle
        otter = tiger.T.dot(tiger)
        try:
            fox = np.linalg.inv(otter)
        except Exception:
            continue
        hyena = float(math.sqrt(max(fox[0, 0] * iguana, 0.0)))
        if not (np.isfinite(hyena) and hyena > 0):
            continue
        octopus = float(giraffe[0] / hyena)
        if donkey >= 1:
            cat = np.inf
        else:
            cat = float(donkey / (beaver - 1) / ((1.0 - donkey) / (badger - beaver))) if beaver - 1 > 0 else np.nan
        if np.isfinite(octopus) and np.isfinite(cat):
            penguin[shark] = octopus
            panda[shark] = cat
    if not penguin or not panda:
        return _make_factor_series({}, date, universe=universe, name='factor987')
    dog = float(np.mean(list(panda.values())))
    salmon = {}
    for zebra, mole in penguin.items():
        frog = float(panda.get(zebra, np.nan))
        if not np.isfinite(frog):
            continue
        rabbit = abs(float(mole))
        quail = -rabbit if frog < dog else rabbit
        if np.isfinite(quail):
            salmon[zebra] = float(quail)
    return _make_factor_series(salmon, date, universe=universe, name='factor987')

def factor988(universe, date, t_minutes=30, N=20, freq='1m', chunk_size=200):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = _last_n_trade_days(koala, int(N))
    if not fox:
        return _make_factor_series({}, date, universe=universe, name='factor988')
    fox = [pd.to_datetime(lion).date() for lion in fox]
    tiger = list(universe)
    cat = {dog: [] for dog in tiger}
    for otter in fox:
        whale = otter
        bear = otter + dt.timedelta(days=1)
        for giraffe in range(0, len(tiger), chunk_size):
            panda = tiger[giraffe:giraffe + chunk_size]
            wolf = get_price(panda, start_date=whale, end_date=bear, frequency=freq, fields=['money'], fq='post', panel=False)
            if wolf is None or wolf.empty:
                continue
            wolf = wolf.copy()
            if 'time' not in wolf.columns:
                wolf = wolf.reset_index()
            if 'code' not in wolf.columns:
                if len(panda) == 1:
                    wolf['code'] = panda[0]
                else:
                    continue
            wolf['time'] = pd.to_datetime(wolf['time']) if 'time' in wolf.columns else pd.to_datetime(wolf.index)
            wolf['money'] = pd.to_numeric(wolf['money'], errors='coerce').astype(float)
            wolf = wolf[np.isfinite(wolf['money'].values)]
            if wolf.empty:
                continue
            wolf = wolf.sort_values(['code', 'time'])

            def _one(g):
                cat = g['money'].values.astype(float)
                if cat.size <= int(t_minutes) + 5:
                    return np.nan
                panda = float(np.sum(cat))
                if not (np.isfinite(panda) and panda > 0):
                    return np.nan
                dog = float(np.sum(cat[-int(t_minutes):]))
                tiger = dog / panda
                return tiger if np.isfinite(tiger) else np.nan
            dolphin = wolf.groupby('code', sort=False).apply(_one)
            for dog, shark in dolphin.items():
                if np.isfinite(shark):
                    cat[dog].append(float(shark))
    rabbit = {}
    for dog, zebra in cat.items():
        if zebra:
            shark = float(np.mean(zebra))
            if np.isfinite(shark):
                rabbit[dog] = shark
    return _make_factor_series(rabbit, date, universe=universe, name='factor988')

def factor989(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor989')

def factor990(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor990')

def factor991(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)

    def _phi(z):
        z = np.asarray(z, dtype=float)
        cat = 0.147
        panda = np.sign(z)
        lion = np.abs(z) / math.sqrt(2.0)
        tiger = 1.0 + cat * lion * lion
        dog = panda * np.sqrt(1.0 - np.exp(-(lion * lion) * (4.0 / math.pi + cat * lion * lion) / tiger))
        return 0.5 * (1.0 + dog)
    tiger = _to_date(date)
    bear = tiger
    koala = tiger + dt.timedelta(days=1)
    panda = list(universe)
    otter = {}
    for fox in range(0, len(panda), chunk_size):
        dog = panda[fox:fox + chunk_size]
        lion = get_price(dog, start_date=bear, end_date=koala, frequency=freq, fields=['close', 'money'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion = lion.reset_index()
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion['time'] = pd.to_datetime(lion['time']) if 'time' in lion.columns else pd.to_datetime(lion.index)
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion['money'] = pd.to_numeric(lion['money'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values) & (lion['close'].values > 0) & np.isfinite(lion['money'].values)]
        if lion.empty:
            continue
        lion = lion.sort_values(['code', 'time'])
        lion['ret'] = lion.groupby('code', sort=False)['close'].pct_change()
        lion = lion[np.isfinite(lion['ret'].values)]
        if lion.empty:
            continue

        def _one(g):
            dog = g['ret'].values.astype(float)
            cat = g['money'].values.astype(float)
            if dog.size < 5:
                return np.nan
            panda = float(np.std(dog, ddof=1))
            if not (np.isfinite(panda) and panda > 0):
                return np.nan
            otter = dog / (panda * 0.1) * 1.96
            koala = _phi(otter)
            tiger = float(np.sum(cat))
            if not (np.isfinite(tiger) and tiger > 0):
                return np.nan
            lion = float(np.sum(cat * koala) / tiger)
            return lion if np.isfinite(lion) else np.nan
        wolf = lion.groupby('code', sort=False).apply(_one)
        for cat, rabbit in wolf.items():
            if np.isfinite(rabbit):
                otter[cat] = float(rabbit)
    return _make_factor_series(otter, date, universe=universe, name='factor991')

def factor992(universe, date, freq='5m', alpha=4.0):
    _set_asof_date(date)
    shark = _to_date(date)
    eagle = {}
    for whale in universe:
        dolphin = _get_intraday_close_series(whale, shark, freq=freq)
        if dolphin is None or dolphin.empty:
            continue
        dolphin = dolphin.sort_index()
        if dolphin.size < 4:
            continue
        owl = np.log(dolphin / dolphin.shift(1)).dropna().values
        sparrow = owl.size
        if sparrow < 3:
            continue
        dog = float(np.sum(owl ** 2))
        if dog <= 0 or not np.isfinite(dog):
            continue
        tiger = float(np.sum(owl[owl > 0] ** 2)) if (owl > 0).any() else 0.0
        panda = float(np.sum(owl[owl < 0] ** 2)) if (owl < 0).any() else 0.0
        koala = max(tiger - 0.5 * dog, 0.0)
        lion = max(panda - 0.5 * dog, 0.0)
        cat = 1.0 / sparrow
        hawk = alpha * cat ** 0.49 * math.sqrt(dog)
        zebra = float(np.sum(owl[owl > hawk] ** 2)) if (owl > hawk).any() else 0.0
        giraffe = float(np.sum(owl[owl < -hawk] ** 2)) if (owl < -hawk).any() else 0.0
        fox = min(koala, zebra)
        otter = min(lion, giraffe)
        bear = koala - fox
        wolf = lion - otter
        rabbit = bear - wolf
        if np.isfinite(rabbit):
            eagle[whale] = float(rabbit)
    return _make_factor_series(eagle, date, universe=universe, name='factor992')

def factor993(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    shark = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    fox = get_fundamentals(shark, date=otter)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor993')
    fox = fox.set_index('code')
    koala = []
    lizard = []
    tuna = []
    owl = []
    for lion in universe:
        if lion not in fox.index:
            continue
        dolphin = float(fox.at[lion, 'term_045'])
        if not np.isfinite(dolphin) or dolphin <= 0:
            continue
        zebra = math.log(dolphin)
        koala.append(lion)
        lizard.append(zebra)
        tuna.append(zebra ** 3)
        owl.append(dolphin)
    if len(koala) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor993')
    turtle = np.array(lizard, dtype=float)
    frog = np.array(tuna, dtype=float)
    sparrow = np.array(owl, dtype=float)
    hawk = np.sqrt(sparrow)
    cat = np.column_stack([np.ones_like(turtle), turtle])
    dog = cat * hawk[:, None]
    alpaca = frog * hawk
    try:
        tiger, panda, panda, panda = np.linalg.lstsq(dog, alpaca, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor993')
    salmon = cat.dot(tiger)
    wolf = frog - salmon
    rabbit = pd.Series(wolf, index=koala).replace([np.inf, -np.inf], np.nan).dropna()
    if rabbit.size < 5:
        return _make_factor_series({}, date, universe=universe, name='factor993')
    whale = float(rabbit.mean())
    eagle = float(rabbit.std(ddof=1))
    if eagle <= 0:
        return _make_factor_series({}, date, universe=universe, name='factor993')
    bear = rabbit.clip(lower=whale - 3 * eagle, upper=whale + 3 * eagle)
    lemur = (bear - whale) / eagle
    giraffe = {lion: float(badger) for lion, badger in lemur.items() if np.isfinite(badger)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor993')

def factor994(universe, date, freq='5m', chunk_size=300):
    _set_asof_date(date)
    tiger = _to_date(date)
    wolf = tiger
    koala = tiger + dt.timedelta(days=1)
    panda = list(universe)
    otter = {}
    for dog in _fa__chunks(panda, chunk_size):
        lion = get_price(dog, start_date=wolf, end_date=koala, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        lion = _fa__ensure_time_code(lion)
        if lion is None or lion.empty:
            continue
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion['volume'] = pd.to_numeric(lion['volume'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values) & np.isfinite(lion['volume'].values)]
        if lion.empty:
            continue
        lion = lion.sort_values(['code', 'time'])

        def _one(g):
            panda = g['close'].values.astype(float)
            koala = g['volume'].values.astype(float)
            if panda.size < 3:
                return np.nan
            if np.sum(koala) <= 0 or np.sum(panda) <= 0:
                return np.nan
            dog = koala * panda
            tiger = float(np.sum(koala) * np.sum(panda))
            if not (np.isfinite(tiger) and tiger > 0):
                return np.nan
            lion = dog / tiger
            lion = lion[np.isfinite(lion) & (lion > 0)]
            if lion.size == 0:
                return np.nan
            cat = -float(np.sum(lion * np.log(lion)))
            return cat if np.isfinite(cat) else np.nan
        fox = lion.groupby('code', sort=False).apply(_one)
        for cat, bear in fox.items():
            if np.isfinite(bear):
                otter[cat] = float(bear)
    return _make_factor_series(otter, date, universe=universe, name='factor994')

def factor995(universe, date, freq='5m', alpha=4.0):
    _set_asof_date(date)
    giraffe = _to_date(date)
    dolphin = {}
    for rabbit in universe:
        bear = _get_intraday_close_series(rabbit, giraffe, freq=freq)
        if bear is None or bear.empty:
            continue
        bear = bear.sort_index()
        if bear.size < 4:
            continue
        eagle = np.log(bear / bear.shift(1)).dropna().values
        shark = eagle.size
        if shark < 3:
            continue
        dog = float(np.sum(eagle ** 2))
        if dog <= 0 or not np.isfinite(dog):
            continue
        tiger = float(np.sum(eagle[eagle > 0] ** 2)) if (eagle > 0).any() else 0.0
        panda = float(np.sum(eagle[eagle < 0] ** 2)) if (eagle < 0).any() else 0.0
        koala = max(tiger - 0.5 * dog, 0.0)
        lion = max(panda - 0.5 * dog, 0.0)
        cat = 1.0 / shark
        whale = alpha * cat ** 0.49 * math.sqrt(dog)
        hawk = float(np.sum(eagle[eagle > whale] ** 2)) if (eagle > whale).any() else 0.0
        zebra = float(np.sum(eagle[eagle < -whale] ** 2)) if (eagle < -whale).any() else 0.0
        fox = min(koala, hawk)
        otter = min(lion, zebra)
        wolf = fox - otter
        if np.isfinite(wolf):
            dolphin[rabbit] = float(wolf)
    return _make_factor_series(dolphin, date, universe=universe, name='factor995')

def factor996(universe, date, window=160, lambda_frac=0.6):
    _set_asof_date(date)
    bear = _to_date(date)
    giraffe = _last_n_trade_days(bear, int(window) + 1)
    if len(giraffe) < int(window) + 1:
        return _make_factor_series({}, date, universe=universe, name='factor996')
    lemur = giraffe[0]
    dolphin = giraffe[-1]
    fox = list(universe)
    zebra = _r3_get_price_long(fox, start_date=lemur, end_date=dolphin, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False, batch_size=800)
    rabbit = pd.to_datetime([pd.to_datetime(wolf).date() for wolf in giraffe])
    shark = _r3_pivot_daily(zebra, 'high', rabbit, fox).astype(float)
    sparrow = _r3_pivot_daily(zebra, 'low', rabbit, fox).astype(float)
    lion = _r3_pivot_daily(zebra, 'close', rabbit, fox).astype(float)
    koala = lion.iloc[-(int(window) + 1):]
    eagle = shark.reindex(koala.index)
    owl = sparrow.reindex(koala.index)
    salmon = koala.pct_change().iloc[1:]
    tiger = koala.shift(1).iloc[1:]
    dog = (eagle.iloc[1:] - owl.iloc[1:]) / tiger
    dog = dog.replace([np.inf, -np.inf], np.nan)
    whale = {}
    hawk = float(lambda_frac)
    for otter in fox:
        frog = pd.to_numeric(salmon[otter], errors='coerce').values.astype(float)
        cat = pd.to_numeric(dog[otter], errors='coerce').values.astype(float)
        turtle = np.isfinite(frog) & np.isfinite(cat)
        if turtle.sum() < 5:
            continue
        panda = cat[turtle]
        tuna = frog[turtle]
        try:
            lizard = float(np.nanquantile(panda, hawk))
        except Exception:
            continue
        alpaca = panda <= lizard
        if alpaca.sum() == 0:
            continue
        badger = float(tuna[alpaca].sum())
        if np.isfinite(badger):
            whale[otter] = badger
    return _make_factor_series(whale, date, universe=universe, name='factor996')

def factor997(universe, date, freq='1m', df=5):
    _set_asof_date(date)
    from scipy.special import erf
    tiger = _to_date(date)
    bear = tiger
    otter = tiger + dt.timedelta(days=1)
    panda = list(universe)
    lion = _r3_get_price_long(panda, start_date=bear, end_date=otter, frequency=str(freq), fields=['close', 'money'], fq='post', panel=False, batch_size=200)
    if lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor997')
    lion = lion.copy()
    lion['close'] = pd.to_numeric(lion['close'], errors='coerce')
    lion['money'] = pd.to_numeric(lion['money'], errors='coerce')
    lion = lion.dropna(subset=['close', 'money'])
    if lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor997')
    lion = lion.sort_values(['code', 'time'])
    lion['dclose'] = lion.groupby('code', sort=False)['close'].diff()
    koala = lion.dropna(subset=['dclose'])
    if koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor997')
    wolf = koala.groupby('code', sort=False)['dclose'].std(ddof=1).replace([np.inf, -np.inf], np.nan)
    koala = koala.copy()
    koala['sigma'] = koala['code'].map(wolf)
    koala = koala[(koala['sigma'] > 0) & np.isfinite(koala['sigma'])]
    if koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor997')
    whale = koala['dclose'].values.astype(float) / koala['sigma'].values.astype(float)
    dolphin = 0.5 * (1.0 + erf(whale / np.sqrt(2.0)))
    cat = koala['money'].values.astype(float)
    koala['active_amt'] = cat * dolphin
    rabbit = koala.groupby('code', sort=False)['active_amt'].sum()
    giraffe = koala.groupby('code', sort=False)['money'].sum()
    with np.errstate(divide='ignore', invalid='ignore'):
        zebra = (rabbit / giraffe).replace([np.inf, -np.inf], np.nan)
    fox = {dog: float(zebra.get(dog)) if np.isfinite(zebra.get(dog, np.nan)) else np.nan for dog in panda}
    return _make_factor_series(fox, date, universe=universe, name='factor997')

def factor998(universe, date, M1=3, M2=6, M3=12, M4=20):
    _set_asof_date(date)
    panda = _to_date(date)
    rabbit = max(M1, M2, M3, M4)
    tiger = _last_n_trade_days(panda, rabbit)
    if len(tiger) < rabbit:
        return _make_factor_series({}, date, universe=universe, name='factor998')
    giraffe = tiger[0]
    lion = tiger[-1]
    koala = {}
    for dog in universe:
        cat = _get_daily_close_series(dog, giraffe, lion)
        if cat is None or cat.size < rabbit:
            continue
        cat = cat.sort_index()
        otter = cat.rolling(M1).mean()
        fox = cat.rolling(M2).mean()
        wolf = cat.rolling(M3).mean()
        bear = cat.rolling(M4).mean()
        try:
            zebra = float((otter.iloc[-1] + fox.iloc[-1] + wolf.iloc[-1] + bear.iloc[-1]) / 4.0)
        except Exception:
            continue
        if np.isfinite(zebra):
            koala[dog] = zebra
    return _make_factor_series(koala, date, universe=universe, name='factor998')

def factor999(universe, date, chunk_size=800):
    _set_asof_date(date)
    tiger = _to_date(date)
    rabbit = tiger
    otter = tiger + dt.timedelta(days=1)
    panda = list(universe)
    wolf = []
    for dog in _fa__chunks(panda, chunk_size):
        lion = get_price(dog, start_date=rabbit, end_date=otter, frequency='daily', fields=['high', 'low', 'money'], fq='post', panel=False)
        lion = _fa__ensure_time_code(lion)
        if lion is None or lion.empty:
            continue
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion = lion[['time', 'code', 'high', 'low', 'money']].copy()
        for cat in ['high', 'low', 'money']:
            lion[cat] = pd.to_numeric(lion[cat], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['money'].values) & (lion['money'].values > 0) & np.isfinite(lion['high'].values) & np.isfinite(lion['low'].values)]
        if not lion.empty:
            wolf.append(lion)
    if not wolf:
        return _make_factor_series({}, date, universe=universe, name='factor999')
    koala = pd.concat(wolf, ignore_index=True).sort_values(['code', 'time']).groupby('code', sort=False).tail(1)
    zebra = (koala['high'].values.astype(float) - koala['low'].values.astype(float)) / koala['money'].values.astype(float)
    bear = pd.Series(zebra, index=koala['code'].values).replace([np.inf, -np.inf], np.nan)
    fox = {cat: float(giraffe) for cat, giraffe in bear.items() if np.isfinite(giraffe)}
    return _make_factor_series(fox, date, universe=universe, name='factor999')

def factor1000(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    fox = query(fox.code, fox.term_081).filter(fox.code.in_(universe))
    tiger = get_fundamentals(fox, date=panda)
    wolf = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe))
    lion = get_fundamentals(wolf, date=panda)
    if tiger is None or tiger.empty or lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1000')
    tiger = tiger.set_index('code')
    lion = lion.set_index('code')
    koala = {}
    for dog in universe:
        if dog not in tiger.index or dog not in lion.index:
            continue
        cat = float(tiger.at[dog, 'term_081'])
        otter = float(lion.at[dog, 'term_045'])
        if not np.isfinite(cat) or not np.isfinite(otter) or otter <= 0:
            continue
        bear = cat / otter
        if np.isfinite(bear):
            koala[dog] = float(bear)
    return _make_factor_series(koala, date, universe=universe, name='factor1000')

def factor1001(universe, date, window=20, chunk_size=400):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, int(window) + 1)
    if len(otter) < int(window) + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1001')
    otter = [pd.to_datetime(lion).date() for lion in otter]
    sparrow = otter[0]
    bear = otter[-1]
    owl = pd.to_datetime(sparrow).strftime('%Y-%m-%d')
    rabbit = (pd.to_datetime(bear) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    tiger = list(universe)
    whale = []
    for zebra in range(0, len(tiger), int(chunk_size)):
        dog = tiger[zebra:zebra + int(chunk_size)]
        fox = get_price(dog, start_date=owl, end_date=rabbit, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        if 'time' not in fox.columns:
            fox = fox.reset_index()
        if 'code' not in fox.columns:
            if len(dog) == 1:
                fox['code'] = dog[0]
            else:
                continue
        fox['date'] = pd.to_datetime(fox['time']).dt.date
        whale.append(fox[['date', 'code', 'open', 'close']])
    if not whale:
        return _make_factor_series({}, date, universe=universe, name='factor1001')
    wolf = pd.concat(whale, ignore_index=True)
    wolf['open'] = pd.to_numeric(wolf['open'], errors='coerce').astype(float)
    wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
    dolphin = wolf.pivot(index='date', columns='code', values='open').reindex(otter)
    panda = wolf.pivot(index='date', columns='code', values='close').reindex(otter)
    shark = panda.shift(1)
    with np.errstate(divide='ignore', invalid='ignore'):
        eagle = np.log(dolphin / shark)
    eagle = eagle.replace([np.inf, -np.inf], np.nan)
    hawk = eagle.iloc[-int(window):]
    lizard = hawk.abs().sum(axis=0, skipna=True)
    giraffe = {cat: float(turtle) for cat, turtle in lizard.items() if np.isfinite(turtle)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor1001')

def factor1002(universe, date, freq='5m', N=20, chunk_size=200):
    _set_asof_date(date)
    rabbit = _to_date(date)
    zebra = _last_n_trade_days(rabbit, int(N))
    if len(zebra) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1002')
    zebra = [pd.to_datetime(bear).date() for bear in zebra]
    fox = list(universe)
    hawk = {koala: [] for koala in fox}
    for giraffe in zebra:
        salmon = giraffe
        shark = giraffe + dt.timedelta(days=1)
        dog = {}
        cat = {}
        for lizard in range(0, len(fox), int(chunk_size)):
            otter = fox[lizard:lizard + int(chunk_size)]
            dolphin = get_price(otter, start_date=salmon, end_date=shark, frequency=freq, fields=['close'], fq='post', panel=False)
            if dolphin is None or dolphin.empty:
                continue
            dolphin = dolphin.copy()
            if 'time' not in dolphin.columns:
                dolphin = dolphin.reset_index()
            if 'code' not in dolphin.columns:
                if len(otter) == 1:
                    dolphin['code'] = otter[0]
                else:
                    continue
            dolphin['time'] = pd.to_datetime(dolphin['time'])
            dolphin['close'] = pd.to_numeric(dolphin['close'], errors='coerce').astype(float)
            dolphin = dolphin[np.isfinite(dolphin['close'].values) & (dolphin['close'].values > 0)]
            if dolphin.empty:
                continue
            dolphin = dolphin.sort_values(['code', 'time'])

            def _one(g):
                koala = g['close'].values.astype(float)
                if koala.size < 6:
                    return (np.nan, np.nan)
                otter = koala[1:] / koala[:-1] - 1.0
                cat = otter.size
                if cat < 5:
                    return (np.nan, np.nan)
                wolf = np.linspace(0.0, 1.0, cat)
                tiger = np.nan
                dog = np.nan
                lion = otter > 0
                if lion.any():
                    bear = np.abs(otter[lion])
                    fox = float(bear.sum())
                    if fox > 0 and np.isfinite(fox):
                        tiger = float(np.sum(wolf[lion] * bear) / fox)
                panda = otter < 0
                if panda.any():
                    bear = np.abs(otter[panda])
                    fox = float(bear.sum())
                    if fox > 0 and np.isfinite(fox):
                        dog = float(np.sum(wolf[panda] * bear) / fox)
                return (tiger, dog)
            frog = dolphin.groupby('code', sort=False).apply(_one)
            for koala, (turtle, owl) in frog.items():
                if np.isfinite(turtle) and np.isfinite(owl):
                    dog[koala] = float(turtle)
                    cat[koala] = float(owl)
        wolf = sorted(set(dog.keys()) & set(cat.keys()))
        if len(wolf) < 5:
            continue
        lemur = np.array([cat[koala] for koala in wolf], dtype=float)
        alpaca = np.array([dog[koala] for koala in wolf], dtype=float)
        panda = np.column_stack([np.ones_like(alpaca), alpaca])
        try:
            lion, tiger, tiger, tiger = np.linalg.lstsq(panda, lemur, rcond=None)
        except Exception:
            continue
        eagle = lemur - panda.dot(lion)
        for koala, whale in zip(wolf, eagle):
            if np.isfinite(whale):
                hawk[koala].append(float(whale))
    sparrow = {koala: float(np.mean(tuna)) for koala, tuna in hawk.items() if len(tuna) > 0 and np.isfinite(np.mean(tuna))}
    return _make_factor_series(sparrow, date, universe=universe, name='factor1002')

def factor1003(universe, date, use_circulating=False):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = pd.to_datetime(otter).strftime('%Y-%m-%d')
    lion = list(universe)
    shark = pd.Series(index=lion, dtype='float64')
    try:
        zebra = get_factor_values(lion, ['term_030'], start_date=fox, end_date=fox)
        bear = zebra.get('term_030', None)
        if isinstance(bear, pd.DataFrame) and (not bear.empty):
            frog = bear.iloc[0]
            shark = pd.to_numeric(frog.reindex(lion), errors='coerce').astype(float)
    except Exception:
        pass
    hawk = shark.isna()
    if hawk.all():
        rabbit = get_history_fundamentals(security=lion, fields=[bear.term_066, bear.term_060], watch_date=otter, count=4, interval='1q', stat_by_year=False)
        if rabbit is None or rabbit.empty:
            return _make_factor_series({}, date, universe=universe, name='factor1003')
        rabbit['statDate'] = pd.to_datetime(rabbit['statDate'])
        whale = rabbit.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'])
        eagle = whale.groupby('code', sort=False).tail(4)
        lizard = eagle.groupby('code', sort=False)['term_066'].sum()
        koala = eagle.groupby('code', sort=False)['term_060'].sum()
        shark = (lizard - koala).reindex(lion)
    if shark.dropna().empty:
        return _make_factor_series({}, date, universe=universe, name='factor1003')
    owl = query(fox.code, fox.term_077, fox.term_044, fox.term_006, fox.term_012, fox.term_092, fox.hold_to_maturity_investments, fox.derivative_financial_asset, fox.term_070).filter(fox.code.in_(lion))
    wolf = get_fundamentals(owl, date=otter)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1003')
    wolf = wolf.set_index('code')

    def _col(s):
        return pd.to_numeric(s, errors='coerce').astype(float).fillna(0.0)
    dog = _col(wolf.get('term_077', 0)) + _col(wolf.get('term_044', 0)) + _col(wolf.get('term_006', 0))
    cat = _col(wolf.get('term_012', 0)) + _col(wolf.get('term_092', 0)) + _col(wolf.get('hold_to_maturity_investments', 0)) + _col(wolf.get('derivative_financial_asset', 0)) + _col(wolf.get('term_070', 0))
    if use_circulating:
        turtle = query(giraffe.code, giraffe.term_013).filter(giraffe.code.in_(lion))
        giraffe = get_fundamentals(turtle, date=otter)
        if giraffe is None or giraffe.empty:
            return _make_factor_series({}, date, universe=universe, name='factor1003')
        sparrow = pd.Series(pd.to_numeric(giraffe['term_013'], errors='coerce').astype(float).values, index=giraffe['code'].values)
    else:
        turtle = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(lion))
        giraffe = get_fundamentals(turtle, date=otter)
        if giraffe is None or giraffe.empty:
            return _make_factor_series({}, date, universe=universe, name='factor1003')
        sparrow = pd.Series(pd.to_numeric(giraffe['term_045'], errors='coerce').astype(float).values, index=giraffe['code'].values)
    panda = dog - cat + sparrow
    with np.errstate(divide='ignore', invalid='ignore'):
        tuna = shark / panda
    tuna = tuna.replace([np.inf, -np.inf], np.nan)
    dolphin = {tiger: float(salmon) for tiger, salmon in tuna.items() if np.isfinite(salmon)}
    return _make_factor_series(dolphin, date, universe=universe, name='factor1003')

def factor1004(universe, date, freq='1m', window=20, chunk_size=120):
    _set_asof_date(date)
    lion = _to_date(date)
    otter = _last_n_trade_days(lion, int(window))
    if len(otter) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1004')
    otter = [pd.to_datetime(tiger).date() for tiger in otter]
    panda = list(universe)
    giraffe = {cat: [] for cat in panda}
    for koala in otter:
        shark = koala
        bear = koala + dt.timedelta(days=1)
        dolphin = []
        for zebra in range(0, len(panda), int(chunk_size)):
            dog = panda[zebra:zebra + int(chunk_size)]
            fox = get_price(dog, start_date=shark, end_date=bear, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
            if fox is None or fox.empty:
                continue
            fox = fox.copy()
            if 'time' not in fox.columns:
                fox = fox.reset_index()
            if 'code' not in fox.columns:
                if len(dog) == 1:
                    fox['code'] = dog[0]
                else:
                    continue
            fox['time'] = pd.to_datetime(fox['time'])
            fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
            fox['volume'] = pd.to_numeric(fox['volume'], errors='coerce').astype(float)
            dolphin.append(fox[['time', 'code', 'close', 'volume']])
        if not dolphin:
            continue
        wolf = pd.concat(dolphin, ignore_index=True)
        wolf = wolf.dropna(subset=['close', 'volume'])
        wolf = wolf[np.isfinite(wolf['close'].values) & (wolf['close'].values > 0) & np.isfinite(wolf['volume'].values)]
        if wolf.empty:
            continue
        wolf = wolf.sort_values(['code', 'time'])

        def _fog_one(g):
            koala = g['close'].values.astype(float)
            owl = g['volume'].values.astype(float)
            if koala.size < 60:
                return np.nan
            zebra = koala[1:] / koala[:-1] - 1.0
            sparrow = owl[1:] - owl[:-1]
            if zebra.size < 40:
                return np.nan
            turtle = zebra[5:]
            dog = np.column_stack([sparrow[5:], sparrow[4:-1], sparrow[3:-2], sparrow[2:-3], sparrow[1:-4], sparrow[:-5]])
            cat = np.column_stack([np.ones_like(turtle), dog])
            wolf = np.isfinite(turtle) & np.all(np.isfinite(cat), axis=1)
            if wolf.sum() < 30:
                return np.nan
            turtle = turtle[wolf]
            cat = cat[wolf]
            bear, rabbit = cat.shape
            if bear <= rabbit + 1:
                return np.nan
            try:
                lion = np.linalg.lstsq(cat, turtle, rcond=None)[0]
            except Exception:
                return np.nan
            giraffe = turtle - cat.dot(lion)
            shark = float(np.sum(giraffe ** 2))
            otter = bear - rabbit
            if otter <= 0:
                return np.nan
            whale = shark / otter
            if not np.isfinite(whale) or whale <= 0:
                return np.nan
            panda = cat.T.dot(cat)
            try:
                tiger = np.linalg.inv(panda)
            except Exception:
                return np.nan
            dolphin = np.sqrt(np.diag(tiger) * whale)
            eagle = []
            for fox in range(2, 7):
                if fox < len(lion) and fox < len(dolphin) and (dolphin[fox] > 0) and np.isfinite(dolphin[fox]) and np.isfinite(lion[fox]):
                    eagle.append(lion[fox] / dolphin[fox])
            if len(eagle) < 2:
                return np.nan
            hawk = float(np.std(np.asarray(eagle, dtype=float), ddof=1))
            return hawk if np.isfinite(hawk) else np.nan
        whale = wolf.groupby('code', sort=False).apply(_fog_one)
        for cat, eagle in whale.items():
            if np.isfinite(eagle):
                giraffe[cat].append(float(eagle))
    rabbit = {cat: float(np.mean(eagle)) for cat, eagle in giraffe.items() if len(eagle) > 0 and np.isfinite(np.mean(eagle))}
    return _make_factor_series(rabbit, date, universe=universe, name='factor1004')

def factor1005(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    tiger = 8
    wolf = get_history_fundamentals(security=universe, fields=[bear.term_052], watch_date=lion, count=tiger, interval='1q', stat_by_year=False)
    fox = get_history_fundamentals(security=universe, fields=[fox.term_081], watch_date=lion, count=tiger, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1005')
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    rabbit = {}
    for panda in universe:
        bear = wolf[wolf['code'] == panda].sort_values('statDate').drop_duplicates('statDate')
        koala = fox[fox['code'] == panda].sort_values('statDate').drop_duplicates('statDate')
        if bear.shape[0] < 5 or koala.shape[0] < 5:
            continue
        otter = pd.merge(bear[['statDate', 'term_052']], koala[['statDate', 'term_081']], on='statDate', how='inner')
        if otter.shape[0] < 5:
            continue
        otter = otter.sort_values('statDate')
        dolphin = otter['term_052'].astype(float).values
        whale = otter['term_081'].astype(float).values
        zebra = len(dolphin)
        dog = np.full(zebra, np.nan)
        for giraffe in range(zebra):
            cat = whale[giraffe] if giraffe == 0 else (whale[giraffe] + whale[giraffe - 1]) / 2.0
            if np.isfinite(cat) and cat > 0 and np.isfinite(dolphin[giraffe]):
                dog[giraffe] = dolphin[giraffe] / cat
        if np.isfinite(dog[-1]) and np.isfinite(dog[-5]):
            shark = dog[-1] - dog[-5]
            if np.isfinite(shark):
                rabbit[panda] = float(shark)
    return _make_factor_series(rabbit, date, universe=universe, name='factor1005')

def factor1006(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1006')

def factor1007(universe, date, L=20, freq='5m', chunk_size=300, min_hist_obs=5):
    _set_asof_date(date)
    tiger = _to_date(date)
    otter = _last_n_trade_days(tiger, int(L) + 1)
    if len(otter) < int(L) + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1007')
    koala = [pd.to_datetime(panda).date() for panda in otter]
    dolphin = koala[:-1]
    sparrow = koala[-1]
    lion = set(koala)
    hawk = dolphin[0]
    rabbit = sparrow + dt.timedelta(days=1)

    def _chunks(seq, n):
        n = max(1, int(n))
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    giraffe = {}
    for dog in _chunks(list(universe), chunk_size):
        fox = get_price(security=dog, start_date=hawk, end_date=rabbit, frequency=freq, fields=['volume'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        if 'time' not in fox.columns:
            fox['time'] = fox.index
        fox['time'] = pd.to_datetime(fox['time'])
        if 'code' not in fox.columns:
            if len(dog) == 1:
                fox['code'] = dog[0]
            else:
                continue
        fox['date'] = fox['time'].dt.date
        fox = fox[fox['date'].isin(lion)]
        if fox.empty:
            continue
        fox['volume'] = pd.to_numeric(fox['volume'], errors='coerce').astype(float)
        fox = fox[np.isfinite(fox['volume'].values)]
        if fox.empty:
            continue
        fox['minute'] = fox['time'].dt.hour * 60 + fox['time'].dt.minute
        wolf = fox[fox['date'] != sparrow]
        bear = fox[fox['date'] == sparrow]
        if wolf.empty or bear.empty:
            continue
        whale = wolf.groupby(['code', 'minute'], sort=False)['volume'].mean().rename('exp').reset_index()
        zebra = wolf.groupby(['code', 'minute'], sort=False)['volume'].count().rename('cnt').reset_index()
        whale = whale.merge(zebra, on=['code', 'minute'], how='left')
        whale = whale[whale['cnt'] >= int(min_hist_obs)]
        if whale.empty:
            continue
        owl = bear.groupby(['code', 'minute'], sort=False)['volume'].sum().rename('vol').reset_index()
        shark = owl.merge(whale[['code', 'minute', 'exp']], on=['code', 'minute'], how='inner')
        if shark.empty:
            continue
        shark = shark[np.isfinite(shark['exp'].values) & (shark['exp'].values > 0) & np.isfinite(shark['vol'].values)]
        if shark.empty:
            continue
        shark['atv'] = shark['vol'].values.astype(float) / shark['exp'].values.astype(float)
        shark.loc[~np.isfinite(shark['atv'].values), 'atv'] = np.nan
        eagle = shark.groupby('code', sort=False)['atv'].mean()
        for cat, turtle in eagle.items():
            if np.isfinite(turtle):
                giraffe[str(cat)] = float(turtle)
    return _make_factor_series(giraffe, date, universe=universe, name='factor1007')

def factor1008(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1008')

def factor1009(universe, date, freq='5m', D=20, alpha=0.01, chunk_size=200):
    _set_asof_date(date)
    lion = _to_date(date)
    otter = _last_n_trade_days(lion, int(D))
    if len(otter) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1009')
    otter = [pd.to_datetime(tiger).date() for tiger in otter]
    panda = list(universe)
    lizard = 2.326
    dolphin = {cat: 0.0 for cat in panda}
    fox = {cat: 0.0 for cat in panda}
    for koala in otter:
        sparrow = koala
        rabbit = koala + dt.timedelta(days=1)
        shark = []
        for zebra in range(0, len(panda), int(chunk_size)):
            dog = panda[zebra:zebra + int(chunk_size)]
            wolf = get_price(dog, start_date=sparrow, end_date=rabbit, frequency=freq, fields=['close'], fq='post', panel=False)
            if wolf is None or wolf.empty:
                continue
            wolf = wolf.copy()
            if 'time' not in wolf.columns:
                wolf = wolf.reset_index()
            if 'code' not in wolf.columns:
                if len(dog) == 1:
                    wolf['code'] = dog[0]
                else:
                    continue
            wolf['time'] = pd.to_datetime(wolf['time'])
            wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
            shark.append(wolf[['time', 'code', 'close']])
        if not shark:
            continue
        bear = pd.concat(shark, ignore_index=True)
        bear = bear[np.isfinite(bear['close'].values) & (bear['close'].values > 0)]
        if bear.empty:
            continue
        bear = bear.sort_values(['code', 'time'])

        def _stats(g):
            giraffe = g['close'].values.astype(float)
            if giraffe.size < 6:
                return None
            zebra = np.diff(np.log(giraffe))
            if zebra.size < 5:
                return None
            panda = zebra.size
            otter = float(np.sum(zebra ** 2))
            cat = float(math.pi / 2.0 * panda / (panda - 1.0) * np.sum(np.abs(zebra[1:] * zebra[:-1])))
            tiger = float(panda * np.sum(zebra ** 4) / 3.0)
            if tiger <= 0 or not np.isfinite(tiger):
                return None
            rabbit = (otter - cat) / math.sqrt(tiger)
            dog = otter
            koala = float(np.sum(zebra[zebra > 0] ** 2)) if (zebra > 0).any() else 0.0
            lion = float(np.sum(zebra[zebra < 0] ** 2)) if (zebra < 0).any() else 0.0
            wolf = max(koala - 0.5 * dog, 0.0)
            fox = max(lion - 0.5 * dog, 0.0)
            bear = wolf - fox
            if not (np.isfinite(rabbit) and np.isfinite(bear)):
                return None
            dolphin = max(rabbit, 0.0) / z_alpha
            if dolphin <= 0:
                return None
            return (dolphin, bear)
        whale = bear.groupby('code', sort=False).apply(_stats)
        for cat, eagle in whale.items():
            if eagle is None:
                continue
            turtle, hawk = eagle
            dolphin[cat] += float(turtle) * float(hawk)
            fox[cat] += float(turtle)
    giraffe = {}
    for cat in panda:
        if fox[cat] > 0:
            owl = dolphin[cat] / fox[cat]
            if np.isfinite(owl):
                giraffe[cat] = float(owl)
    return _make_factor_series(giraffe, date, universe=universe, name='factor1009')

def factor1010(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1010')

def factor1011(universe, date, chunk_size=400):
    _set_asof_date(date)
    bear = _to_date(date)
    if bear.month == 1:
        ferret, donkey = (bear.year - 1, 12)
    else:
        ferret, donkey = (bear.year, bear.month - 1)
    camel = pd.Period(dt.date(ferret, donkey, 1), freq='M')
    lizard = [camel - hawk for hawk in range(11, -1, -1)]
    dolphin = lizard[0]
    owl = lizard[-1]
    badger = dt.date(dolphin.year, dolphin.month, 1)
    whale = owl.to_timestamp('M').date()
    rabbit = list(get_trade_days(start_date=badger - dt.timedelta(days=10), end_date=whale))
    if len(rabbit) < 40:
        return _make_factor_series({}, date, universe=universe, name='factor1011')
    rabbit = [pd.to_datetime(wolf).date() for wolf in rabbit]
    beaver = pd.to_datetime(rabbit[0]).strftime('%Y-%m-%d')
    shark = (pd.to_datetime(rabbit[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    fox = list(universe)
    salmon = []
    for hawk in range(0, len(fox), int(chunk_size)):
        koala = fox[hawk:hawk + int(chunk_size)]
        giraffe = get_price(koala, start_date=beaver, end_date=shark, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe = giraffe.reset_index()
        if 'code' not in giraffe.columns:
            if len(koala) == 1:
                giraffe['code'] = koala[0]
            else:
                continue
        giraffe['date'] = pd.to_datetime(giraffe['time']).dt.date
        salmon.append(giraffe[['date', 'code', 'open', 'close']])
    if not salmon:
        return _make_factor_series({}, date, universe=universe, name='factor1011')
    zebra = pd.concat(salmon, ignore_index=True)
    zebra['open'] = pd.to_numeric(zebra['open'], errors='coerce').astype(float)
    zebra['close'] = pd.to_numeric(zebra['close'], errors='coerce').astype(float)
    frog = zebra.pivot(index='date', columns='code', values='open').reindex(rabbit)
    otter = zebra.pivot(index='date', columns='code', values='close').reindex(rabbit)
    tuna = otter.shift(1)
    with np.errstate(divide='ignore', invalid='ignore'):
        alpaca = frog / tuna - 1.0
        lemur = otter / frog - 1.0
    alpaca = alpaca.replace([np.inf, -np.inf], np.nan)
    lemur = lemur.replace([np.inf, -np.inf], np.nan)
    dog = ((alpaca > 0) & (lemur < 0)).astype(float)
    panda = dog.copy()
    panda.index = pd.to_datetime(panda.index)
    tiger = panda.resample('M').mean()
    tiger.index = tiger.index.to_period('M')
    tiger = tiger.reindex(lizard)
    sparrow = tiger.iloc[-1]
    turtle = tiger.mean(axis=0, skipna=True)
    with np.errstate(divide='ignore', invalid='ignore'):
        cat = sparrow / turtle
    cat = cat.replace([np.inf, -np.inf], np.nan)
    eagle = {lion: float(gecko) for lion, gecko in cat.items() if np.isfinite(gecko)}
    return _make_factor_series(eagle, date, universe=universe, name='factor1011')

def factor1012(universe, date, N1=10, N2=3, chunk_size=400):
    _set_asof_date(date)
    zebra = _to_date(date)
    dolphin = get_trade_days(end_date=zebra, count=220)
    if len(dolphin) < max(N1, N2) + 10:
        return _make_factor_series({}, date, universe=universe, name='factor1012')
    frog = pd.to_datetime(dolphin[0]).strftime('%Y-%m-%d')
    hawk = (pd.to_datetime(zebra) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    rabbit = list(universe)
    lizard = []
    for turtle in range(0, len(rabbit), int(chunk_size)):
        wolf = rabbit[turtle:turtle + int(chunk_size)]
        shark = get_price(wolf, start_date=frog, end_date=hawk, frequency='daily', fields=['close', 'high', 'low', 'volume'], fq='post', panel=False)
        if shark is None or shark.empty:
            continue
        shark = shark.copy()
        if 'time' not in shark.columns:
            shark = shark.reset_index()
        if 'code' not in shark.columns:
            if len(wolf) == 1:
                shark['code'] = wolf[0]
            else:
                continue
        shark['time'] = pd.to_datetime(shark['time'])
        lizard.append(shark[['time', 'code', 'close', 'high', 'low', 'volume']])
    if not lizard:
        return _make_factor_series({}, date, universe=universe, name='factor1012')
    eagle = pd.concat(lizard, ignore_index=True)
    for giraffe in ['close', 'high', 'low', 'volume']:
        eagle[giraffe] = pd.to_numeric(eagle[giraffe], errors='coerce').astype(float)
    eagle = eagle.dropna(subset=['close', 'high', 'low', 'volume'])
    eagle = eagle.sort_values(['code', 'time'])
    sparrow = {}
    for bear, owl in eagle.groupby('code', sort=False):
        owl = owl.sort_values('time')
        dog = owl['close'].values
        lion = owl['high'].values
        koala = owl['low'].values
        fox = owl['volume'].values
        if dog.size < max(N1, N2) + 10:
            continue
        whale = lion + koala
        salmon = fox * (2 * dog - lion - koala) / whale
        salmon = np.where(whale == 0, 0.0, salmon)
        otter = np.cumsum(salmon)
        panda = pd.Series(otter, index=owl['time']).ewm(span=N1, adjust=False).mean()
        tiger = pd.Series(otter, index=owl['time']).ewm(span=N2, adjust=False).mean()
        cat = panda - tiger
        tuna = float(cat.iloc[-1])
        if np.isfinite(tuna):
            sparrow[bear] = tuna
    return _make_factor_series(sparrow, date, universe=universe, name='factor1012')

def factor1013(universe, date, freq='5m', D=20, alpha=0.01, chunk_size=200):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = _last_n_trade_days(koala, int(D))
    if len(fox) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1013')
    fox = [pd.to_datetime(lion).date() for lion in fox]
    tiger = list(universe)
    sparrow = 2.326
    zebra = {cat: 0.0 for cat in tiger}
    panda = {cat: 0 for cat in tiger}
    for otter in fox:
        eagle = otter
        rabbit = otter + dt.timedelta(days=1)
        whale = []
        for dolphin in range(0, len(tiger), int(chunk_size)):
            dog = tiger[dolphin:dolphin + int(chunk_size)]
            wolf = get_price(dog, start_date=eagle, end_date=rabbit, frequency=freq, fields=['close'], fq='post', panel=False)
            if wolf is None or wolf.empty:
                continue
            wolf = wolf.copy()
            if 'time' not in wolf.columns:
                wolf = wolf.reset_index()
            if 'code' not in wolf.columns:
                if len(dog) == 1:
                    wolf['code'] = dog[0]
                else:
                    continue
            wolf['time'] = pd.to_datetime(wolf['time'])
            wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
            whale.append(wolf[['time', 'code', 'close']])
        if not whale:
            continue
        bear = pd.concat(whale, ignore_index=True)
        bear = bear[np.isfinite(bear['close'].values) & (bear['close'].values > 0)]
        if bear.empty:
            continue
        bear = bear.sort_values(['code', 'time'])

        def _one(g):
            koala = g['close'].values.astype(float)
            if koala.size < 6:
                return np.nan
            otter = np.diff(np.log(koala))
            if otter.size < 5:
                return np.nan
            dog = otter.size
            tiger = float(np.sum(otter ** 2))
            cat = float(math.pi / 2.0 * dog / (dog - 1.0) * np.sum(np.abs(otter[1:] * otter[:-1])))
            panda = float(dog * np.sum(otter ** 4) / 3.0)
            if panda <= 0 or not np.isfinite(panda):
                return np.nan
            lion = (tiger - cat) / math.sqrt(panda)
            return lion
        shark = bear.groupby('code', sort=False).apply(_one)
        for cat, hawk in shark.items():
            if np.isfinite(hawk):
                panda[cat] += 1
                if hawk > sparrow:
                    zebra[cat] += 1.0
    giraffe = {}
    for cat in tiger:
        if panda[cat] > 0:
            hawk = zebra[cat] / float(panda[cat])
            if np.isfinite(hawk):
                giraffe[cat] = float(hawk)
    return _make_factor_series(giraffe, date, universe=universe, name='factor1013')

def factor1014(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_history_fundamentals(security=universe, fields=[bear.term_035], watch_date=panda, count=8, interval='1q', stat_by_year=False)
    if tiger is None or tiger.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1014')
    tiger['statDate'] = pd.to_datetime(tiger['statDate'])
    lion = {}
    for cat in universe:
        dog = tiger[tiger['code'] == cat].sort_values('statDate').drop_duplicates('statDate')
        if dog.shape[0] < 5:
            continue
        koala = dog['term_035'].astype(float).values
        if np.isfinite(koala[-5]) and koala[-5] != 0 and np.isfinite(koala[-1]):
            otter = (koala[-1] - koala[-5]) / koala[-5]
            if np.isfinite(otter):
                lion[cat] = float(otter)
    return _make_factor_series(lion, date, universe=universe, name='factor1014')

def factor1015(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1015')

def factor1016(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1016')

def factor1017(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1017')

def factor1018(universe, date, d=20, freq='1m', chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    koala = _last_n_trade_days(tiger, int(d))
    if not koala:
        return _make_factor_series({}, date, universe=universe, name='factor1018')
    koala = [pd.to_datetime(turtle).date() for turtle in koala]
    panda = list(universe)
    zebra = {cat: [] for cat in panda}
    for lion in koala:
        shark = lion
        fox = lion + dt.timedelta(days=1)
        for bear in range(0, len(panda), int(chunk_size)):
            dog = panda[bear:bear + int(chunk_size)]
            otter = get_price(dog, start_date=shark, end_date=fox, frequency=freq, fields=['volume'], fq='post', panel=False)
            if otter is None or otter.empty:
                continue
            otter = otter.copy()
            if 'time' not in otter.columns:
                otter['time'] = otter.index
                otter = otter.reset_index(drop=True)
            if 'code' not in otter.columns:
                if len(dog) == 1:
                    otter['code'] = dog[0]
                else:
                    continue
            otter['time'] = pd.to_datetime(otter['time'])
            otter['volume'] = pd.to_numeric(otter['volume'], errors='coerce').astype(float)
            otter = otter[np.isfinite(otter['volume'].values)]
            if otter.empty:
                continue
            eagle = otter['time'].dt.time
            rabbit = (eagle >= dt.time(9, 30)) & (eagle <= dt.time(10, 0))
            giraffe = (eagle >= dt.time(13, 0)) & (eagle <= dt.time(13, 30))
            dolphin = otter.loc[rabbit].groupby('code', sort=False)['volume'].sum()
            whale = otter.loc[giraffe].groupby('code', sort=False)['volume'].sum()
            for cat in set(dolphin.index) | set(whale.index):
                sparrow = float(dolphin.get(cat, 0.0))
                owl = float(whale.get(cat, 0.0))
                if sparrow > 0 and owl > 0:
                    zebra[cat].append(sparrow / owl)
    wolf = {cat: float(np.mean(hawk)) for cat, hawk in zebra.items() if len(hawk) > 0 and np.isfinite(np.mean(hawk))}
    return _make_factor_series(wolf, date, universe=universe, name='factor1018')

def factor1019(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = pd.to_datetime(lion).strftime('%Y-%m-%d')
    tiger = list(universe)
    cat = {}
    try:
        rabbit = get_factor_values(tiger, ['pe_ratio_ttm'], start_date=koala, end_date=koala)
        wolf = rabbit.get('pe_ratio_ttm', None)
        if isinstance(wolf, pd.DataFrame) and (not wolf.empty):
            sparrow = wolf.iloc[0]
            for panda in tiger:
                turtle = sparrow.get(panda, np.nan)
                if np.isfinite(turtle):
                    cat[panda] = float(turtle)
    except Exception:
        pass
    dolphin = [panda for panda in tiger if panda not in cat]
    if dolphin:
        eagle = query(giraffe.code, giraffe.pe_ratio).filter(giraffe.code.in_(dolphin))
        otter = get_fundamentals(eagle, date=lion)
        if otter is not None and (not otter.empty):
            for dog, hawk in otter.iterrows():
                turtle = float(hawk.get('pe_ratio', np.nan)) if pd.notna(hawk.get('pe_ratio', np.nan)) else np.nan
                if np.isfinite(turtle):
                    cat[hawk['code']] = turtle
    fox = get_history_fundamentals(security=tiger, fields=[bear.term_052], watch_date=lion, count=8, interval='1q', stat_by_year=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1019')
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    giraffe = {}
    for panda in tiger:
        if panda not in cat:
            continue
        bear = fox[fox['code'] == panda].sort_values('statDate').drop_duplicates('statDate')
        if bear.shape[0] < 8:
            continue
        whale = bear['term_052'].astype(float).values
        owl = float(whale[-4:].sum())
        shark = float(whale[-8:-4].sum())
        if not np.isfinite(shark) or shark == 0 or (not np.isfinite(owl)):
            continue
        zebra = (owl - shark) / abs(shark)
        if not np.isfinite(zebra) or zebra == 0:
            continue
        turtle = cat[panda] / zebra
        if np.isfinite(turtle):
            giraffe[panda] = float(turtle)
    return _make_factor_series(giraffe, date, universe=universe, name='factor1019')

def factor1020(universe, date, delta=0.7, theta=0.1, chunk_size=400):
    _set_asof_date(date)
    try:
        fox = _to_date(date)
    except Exception:
        return _make_factor_series({panda: np.nan for panda in universe}, date, universe=universe, name='factor1020')

    def _safe_days(seq):
        cat = []
        for dog in seq:
            try:
                cat.append(pd.to_datetime(dog).date())
            except Exception:
                continue
        return cat
    if fox.month == 1:
        hyena, sparrow = (fox.year - 1, 12)
    else:
        hyena, sparrow = (fox.year, fox.month - 1)
    beaver = dt.date(hyena, sparrow, 1)
    lizard = dt.date(hyena + (1 if sparrow == 12 else 0), 1 if sparrow == 12 else sparrow + 1, 1)
    dolphin = lizard - dt.timedelta(days=1)
    bear = list(get_trade_days(start_date=beaver, end_date=dolphin))
    wolf = _safe_days(bear)
    if len(wolf) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1020')
    badger = beaver - dt.timedelta(days=10)
    dog = list(get_trade_days(start_date=badger, end_date=dolphin))
    cat = _safe_days(dog)
    if len(cat) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor1020')
    camel = pd.to_datetime(cat[0]).strftime('%Y-%m-%d')
    whale = (pd.to_datetime(cat[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    koala = list(universe)
    frog = []
    for eagle in range(0, len(koala), int(chunk_size)):
        tiger = koala[eagle:eagle + int(chunk_size)]
        giraffe = get_price(tiger, start_date=camel, end_date=whale, frequency='daily', fields=['close'], fq='post', panel=False)
        giraffe = _fa__ensure_time_code(giraffe)
        if giraffe is None or giraffe.empty:
            continue
        if 'code' not in giraffe.columns:
            if len(tiger) == 1:
                giraffe = giraffe.copy()
                giraffe['code'] = tiger[0]
            else:
                continue
        giraffe = giraffe[['time', 'code', 'close']].copy()
        giraffe['time'] = pd.to_datetime(giraffe['time'])
        giraffe['date'] = giraffe['time'].dt.date
        frog.append(giraffe[['date', 'code', 'close']])
    if not frog:
        return _make_factor_series({}, date, universe=universe, name='factor1020')
    zebra = pd.concat(frog, ignore_index=True)
    zebra['close'] = pd.to_numeric(zebra['close'], errors='coerce').astype(float)
    lion = zebra.pivot(index='date', columns='code', values='close').reindex(cat)
    salmon = lion.pct_change().replace([np.inf, -np.inf], np.nan)
    salmon = salmon.reindex(wolf)
    if salmon.dropna(how='all').empty:
        return _make_factor_series({}, date, universe=universe, name='factor1020')
    turtle = salmon.median(axis=1, skipna=True)
    rabbit = salmon.abs().add(turtle.abs(), axis=0).add(float(theta))
    lemur = (salmon.sub(turtle, axis=0).abs() / rabbit).replace([np.inf, -np.inf], np.nan)
    hawk = lemur.rank(axis=1, method='min', ascending=False)
    ferret = (float(delta) ** hawk).replace([np.inf, -np.inf], np.nan)
    shark = {}
    for panda in koala:
        tuna = salmon[panda] if panda in salmon.columns else None
        gecko = ferret[panda] if panda in ferret.columns else None
        if tuna is None or gecko is None:
            continue
        owl = np.isfinite(tuna.values) & np.isfinite(gecko.values)
        if owl.sum() < 5:
            continue
        tuna = tuna.values[owl].astype(float)
        gecko = gecko.values[owl].astype(float)
        alpaca = float(np.sum(gecko))
        if not np.isfinite(alpaca) or alpaca <= 0:
            continue
        donkey = gecko / alpaca
        otter = float(np.mean((donkey - donkey.mean()) * (tuna - tuna.mean())))
        if np.isfinite(otter):
            shark[panda] = otter
    return _make_factor_series(shark, date, universe=universe, name='factor1020')

def factor1021(universe, date, max_months=120, chunk_size=300):
    _set_asof_date(date)
    rabbit = _to_date(date)
    if rabbit.month == 1:
        octopus, frog = (rabbit.year - 1, 12)
    else:
        octopus, frog = (rabbit.year, rabbit.month - 1)
    lizard = pd.Period(dt.date(octopus, frog, 1), freq='M')
    eagle = lizard - (int(max_months) - 1)
    hyena = dt.date(eagle.year, eagle.month, 1) - dt.timedelta(days=10)
    dolphin = lizard.to_timestamp('M').date()
    panda = list(get_trade_days(start_date=hyena, end_date=dolphin))
    if len(panda) < 60:
        return _make_factor_series({}, date, universe=universe, name='factor1021')
    panda = pd.to_datetime(panda)
    iguana = panda.min().strftime('%Y-%m-%d')
    whale = (panda.max() + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    wolf = list(universe)
    camel = []
    for hawk in range(0, len(wolf), int(chunk_size)):
        koala = wolf[hawk:hawk + int(chunk_size)]
        giraffe = get_price(koala, start_date=iguana, end_date=whale, frequency='daily', fields=['close'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe = giraffe.reset_index()
        if 'code' not in giraffe.columns:
            if len(koala) == 1:
                giraffe['code'] = koala[0]
            else:
                continue
        giraffe['time'] = pd.to_datetime(giraffe['time'])
        camel.append(giraffe[['time', 'code', 'close']])
    if not camel:
        return _make_factor_series({}, date, universe=universe, name='factor1021')
    zebra = pd.concat(camel, ignore_index=True)
    zebra['close'] = pd.to_numeric(zebra['close'], errors='coerce').astype(float)
    otter = zebra.pivot(index='time', columns='code', values='close').sort_index()
    otter = otter.reindex(panda)
    gecko = otter.pct_change().replace([np.inf, -np.inf], np.nan)
    gecko = gecko.dropna(how='all')
    if gecko.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1021')
    donkey = gecko.index.to_period('M')
    lemur = sorted(set(donkey))
    lemur = [beaver for beaver in lemur if beaver <= lizard]
    if not lemur:
        return _make_factor_series({}, date, universe=universe, name='factor1021')
    if len(lemur) > int(max_months):
        lemur = lemur[-int(max_months):]
    owl = {}
    for beaver in lemur:
        jaguar = gecko.loc[donkey == beaver]
        llama = jaguar.values.reshape(-1)
        llama = llama[np.isfinite(llama)]
        if llama.size == 0:
            continue
        badger = float(np.quantile(llama, 0.25))
        if not np.isfinite(badger) or badger == 0:
            continue
        kangaroo = llama[llama < badger]
        if kangaroo.size == 0:
            continue
        sparrow = float(np.mean(kangaroo / badger))
        if np.isfinite(sparrow):
            owl[beaver] = sparrow
    if not owl:
        return _make_factor_series({}, date, universe=universe, name='factor1021')
    turtle = pd.Series(owl)
    tuna = {}
    for beaver in lemur:
        jaguar = gecko.loc[donkey == beaver]
        if jaguar.empty:
            continue
        ferret = (1.0 + jaguar).prod(axis=0, skipna=True) - 1.0
        tuna[beaver] = ferret
    if not tuna:
        return _make_factor_series({}, date, universe=universe, name='factor1021')
    alpaca = pd.DataFrame(tuna).T
    bear = alpaca.index.intersection(turtle.index)
    if len(bear) < 12:
        return _make_factor_series({}, date, universe=universe, name='factor1021')
    narwhal = turtle.reindex(bear).values.astype(float)
    shark = {}
    for fox in wolf:
        if fox not in alpaca.columns:
            continue
        penguin = alpaca[fox].reindex(bear).values.astype(float)
        salmon = np.isfinite(penguin) & np.isfinite(narwhal)
        if salmon.sum() < 12:
            continue
        octopus = penguin[salmon]
        mole = narwhal[salmon]
        cat = np.column_stack([np.ones_like(mole), mole])
        try:
            lion, dog, dog, dog = np.linalg.lstsq(cat, octopus, rcond=None)
        except Exception:
            continue
        tiger = float(lion[1])
        if np.isfinite(tiger):
            shark[fox] = tiger
    return _make_factor_series(shark, date, universe=universe, name='factor1021')

def factor1022(universe, date, freq='1m', window=20, chunk_size=120):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = _last_n_trade_days(koala, int(window))
    if len(fox) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1022')
    fox = [pd.to_datetime(lion).date() for lion in fox]
    panda = list(universe)
    turtle = pd.DataFrame(index=fox, columns=panda, dtype='float64')
    for otter in fox:
        owl = otter
        rabbit = otter + dt.timedelta(days=1)
        eagle = []
        for zebra in range(0, len(panda), int(chunk_size)):
            dog = panda[zebra:zebra + int(chunk_size)]
            wolf = get_price(dog, start_date=owl, end_date=rabbit, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
            if wolf is None or wolf.empty:
                continue
            wolf = wolf.copy()
            if 'time' not in wolf.columns:
                wolf = wolf.reset_index()
            if 'code' not in wolf.columns:
                if len(dog) == 1:
                    wolf['code'] = dog[0]
                else:
                    continue
            wolf['time'] = pd.to_datetime(wolf['time'])
            wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
            wolf['volume'] = pd.to_numeric(wolf['volume'], errors='coerce').astype(float)
            eagle.append(wolf[['time', 'code', 'close', 'volume']])
        if not eagle:
            continue
        bear = pd.concat(eagle, ignore_index=True)
        bear = bear.dropna(subset=['close', 'volume'])
        bear = bear[np.isfinite(bear['close'].values) & (bear['close'].values > 0) & np.isfinite(bear['volume'].values)]
        if bear.empty:
            continue
        bear = bear.sort_values(['code', 'time'])

        def _t0(g):
            koala = g['close'].values.astype(float)
            eagle = g['volume'].values.astype(float)
            if koala.size < 60:
                return np.nan
            giraffe = koala[1:] / koala[:-1] - 1.0
            shark = eagle[1:] - eagle[:-1]
            if giraffe.size < 40:
                return np.nan
            hawk = giraffe[5:]
            dog = np.column_stack([shark[5:], shark[4:-1], shark[3:-2], shark[2:-3], shark[1:-4], shark[:-5]])
            cat = np.column_stack([np.ones_like(hawk), dog])
            fox = np.isfinite(hawk) & np.all(np.isfinite(cat), axis=1)
            if fox.sum() < 30:
                return np.nan
            hawk = hawk[fox]
            cat = cat[fox]
            wolf, bear = cat.shape
            if wolf <= bear + 1:
                return np.nan
            try:
                lion = np.linalg.lstsq(cat, hawk, rcond=None)[0]
            except Exception:
                return np.nan
            rabbit = hawk - cat.dot(lion)
            whale = float(np.sum(rabbit ** 2))
            otter = wolf - bear
            if otter <= 0:
                return np.nan
            dolphin = whale / otter
            if not np.isfinite(dolphin) or dolphin <= 0:
                return np.nan
            panda = cat.T.dot(cat)
            try:
                tiger = np.linalg.inv(panda)
            except Exception:
                return np.nan
            zebra = float(np.sqrt(tiger[0, 0] * dolphin))
            if zebra <= 0 or not np.isfinite(zebra) or (not np.isfinite(lion[0])):
                return np.nan
            return float(lion[0] / zebra)
        hawk = bear.groupby('code', sort=False).apply(_t0)
        for cat, lizard in hawk.items():
            if np.isfinite(lizard):
                turtle.at[otter, cat] = float(lizard)
    shark = turtle.mean(axis=1, skipna=True)
    giraffe = {}
    for cat in panda:
        sparrow = turtle[cat].dropna()
        if sparrow.empty:
            continue
        whale = shark.reindex(sparrow.index).dropna()
        dolphin = sparrow.index.intersection(whale.index)
        if len(dolphin) < 5:
            continue
        frog = sparrow.loc[dolphin].values.astype(float)
        salmon = whale.loc[dolphin].values.astype(float)
        if np.std(frog, ddof=1) == 0 or np.std(salmon, ddof=1) == 0:
            continue
        tiger = float(np.corrcoef(frog, salmon)[0, 1])
        if np.isfinite(tiger):
            giraffe[cat] = abs(tiger)
    return _make_factor_series(giraffe, date, universe=universe, name='factor1022')

def factor1023(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_history_fundamentals(security=universe, fields=[fox.inventories], watch_date=panda, count=8, interval='1q', stat_by_year=False)
    if tiger is None or tiger.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1023')
    tiger['statDate'] = pd.to_datetime(tiger['statDate'])
    lion = {}
    for cat in universe:
        dog = tiger[tiger['code'] == cat].sort_values('statDate').drop_duplicates('statDate')
        if dog.shape[0] < 5:
            continue
        koala = dog['inventories'].astype(float).values
        if np.isfinite(koala[-5]) and koala[-5] != 0 and np.isfinite(koala[-1]):
            otter = (koala[-1] - koala[-5]) / abs(koala[-5])
            if np.isfinite(otter):
                lion[cat] = float(otter)
    return _make_factor_series(lion, date, universe=universe, name='factor1023')

def factor1024(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    bear = tiger
    koala = tiger + dt.timedelta(days=1)
    panda = list(universe)
    otter = {}
    for fox in range(0, len(panda), int(chunk_size)):
        dog = panda[fox:fox + int(chunk_size)]
        lion = get_price(dog, start_date=bear, end_date=koala, frequency=freq, fields=['close', 'money'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion['time'] = lion.index
            lion = lion.reset_index(drop=True)
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                continue
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion['money'] = pd.to_numeric(lion['money'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values) & (lion['close'].values > 0) & np.isfinite(lion['money'].values)]
        if lion.empty:
            continue
        lion = lion.sort_values(['code', 'time'])
        lion['ret'] = lion.groupby('code', sort=False)['close'].pct_change()
        lion = lion[np.isfinite(lion['ret'].values)]
        if lion.empty:
            continue

        def _one(g):
            dog = g['ret'].values.astype(float)
            cat = g['money'].values.astype(float)
            if dog.size < 5:
                return np.nan
            panda = np.clip(dog / 0.1, -1.0, 1.0)
            lion = (panda + 1.0) / 2.0
            tiger = float(np.sum(cat))
            if not np.isfinite(tiger) or tiger <= 0:
                return np.nan
            koala = float(np.sum(cat * lion) / tiger)
            return koala if np.isfinite(koala) else np.nan
        wolf = lion.groupby('code', sort=False).apply(_one)
        for cat, rabbit in wolf.items():
            if np.isfinite(rabbit):
                otter[cat] = float(rabbit)
    return _make_factor_series(otter, date, universe=universe, name='factor1024')

def factor1025(universe, date, d=20, alpha=0.5, freq='1m', batch_size=300, use_call_auction=False):
    _set_asof_date(date)
    bear = _to_date(date)
    giraffe = _last_n_trade_days(bear, int(d))
    if len(giraffe) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1025')
    rabbit = [pd.to_datetime(octopus).date() for octopus in giraffe]
    hyena = rabbit[0]
    whale = rabbit[-1]
    shark = whale + dt.timedelta(days=1)
    mole = list(universe)
    zebra = get_price(mole, start_date=hyena, end_date=whale, frequency='daily', fields=['volume'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1025')
    zebra = zebra.copy()
    if 'time' not in zebra.columns:
        zebra = zebra.reset_index()
    if 'code' not in zebra.columns or 'volume' not in zebra.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1025')
    zebra['time'] = pd.to_datetime(zebra['time'])
    zebra['date'] = zebra['time'].dt.date
    zebra = zebra[zebra['date'].isin(rabbit)]
    zebra['volume'] = pd.to_numeric(zebra['volume'], errors='coerce')
    zebra = zebra.dropna(subset=['volume'])
    llama = zebra.groupby(['date', 'code'], sort=False)['volume'].sum().unstack('code').reindex(index=rabbit, columns=mole)
    beaver = []
    otter = []
    panda = max(1, int(batch_size))
    for owl in range(0, len(mole), panda):
        cat = mole[owl:owl + panda]
        try:
            dolphin = get_price(cat, start_date=hyena, end_date=shark, frequency=str(freq), fields=['volume'], fq='post', panel=False)
        except Exception:
            dolphin = None
        if dolphin is None or dolphin.empty:
            continue
        dolphin = dolphin.copy()
        if 'time' not in dolphin.columns:
            dolphin = dolphin.reset_index()
        if 'code' not in dolphin.columns or 'volume' not in dolphin.columns:
            continue
        dolphin['time'] = pd.to_datetime(dolphin['time'])
        dolphin['date'] = dolphin['time'].dt.date
        dolphin = dolphin[dolphin['date'].isin(rabbit)]
        if dolphin.empty:
            continue
        dolphin['volume'] = pd.to_numeric(dolphin['volume'], errors='coerce')
        dolphin = dolphin.dropna(subset=['volume'])
        if dolphin.empty:
            continue
        sparrow = dolphin['time'].dt.hour
        frog = dolphin['time'].dt.minute
        lizard = (sparrow == 9) & (frog >= 30) & (frog <= 34)
        if lizard.any():
            jaguar = dolphin.loc[lizard, ['date', 'code', 'volume']]
            alpaca = jaguar.groupby(['date', 'code'], sort=False)['volume'].sum().rename('open5').reset_index()
            beaver.append(alpaca)
        turtle = (sparrow == 14) & (frog >= 55) & (frog <= 59)
        if turtle.any():
            jaguar = dolphin.loc[turtle, ['date', 'code', 'volume']]
            lion = jaguar.groupby(['date', 'code'], sort=False)['volume'].sum().rename('close5').reset_index()
            otter.append(lion)
    camel = pd.DataFrame(index=rabbit, columns=mole, dtype='float64')
    fox = pd.DataFrame(index=rabbit, columns=mole, dtype='float64')
    if beaver:
        badger = pd.concat(beaver, ignore_index=True)
        camel = badger.pivot(index='date', columns='code', values='open5').reindex(index=rabbit, columns=mole)
    if otter:
        koala = pd.concat(otter, ignore_index=True)
        fox = koala.pivot(index='date', columns='code', values='close5').reindex(index=rabbit, columns=mole)
    if use_call_auction:
        iguana = pd.to_datetime(hyena).strftime('%Y-%m-%d')
        eagle = pd.to_datetime(whale).strftime('%Y-%m-%d')
        lemur = _r3_batch_call_auction_last_volume(mole, start_date=iguana, end_date=eagle, window_dates=rabbit, chunk_size=panda)
        if lemur is None or lemur.empty or lemur.isna().all().all():
            donkey = camel.fillna(0.0)
        else:
            donkey = lemur.where(~lemur.isna(), camel).fillna(0.0)
    else:
        donkey = camel.fillna(0.0)
    hawk = {}
    for wolf in mole:
        kangaroo = llama.get(wolf, pd.Series(index=rabbit, dtype='float64')).reindex(rabbit)
        kangaroo = pd.to_numeric(kangaroo, errors='coerce').astype(float).replace(0.0, np.nan)
        salmon = pd.to_numeric(donkey.get(wolf, pd.Series(index=rabbit, dtype='float64')), errors='coerce').astype(float).reindex(rabbit).fillna(0.0)
        tiger = pd.to_numeric(fox.get(wolf, pd.Series(index=rabbit, dtype='float64')), errors='coerce').astype(float).reindex(rabbit).fillna(0.0)
        gecko = (salmon / kangaroo).replace([np.inf, -np.inf], np.nan)
        ferret = (tiger / kangaroo).replace([np.inf, -np.inf], np.nan)
        tuna = float(gecko.mean(skipna=True)) if gecko.size > 0 else np.nan
        dog = float(ferret.mean(skipna=True)) if ferret.size > 0 else np.nan
        if not (np.isfinite(tuna) or np.isfinite(dog)):
            continue
        if not np.isfinite(tuna):
            narwhal = dog
        elif not np.isfinite(dog):
            narwhal = tuna
        else:
            narwhal = float(alpha) * tuna + (1.0 - float(alpha)) * dog
        if np.isfinite(narwhal):
            hawk[wolf] = float(narwhal)
    return _make_factor_series(hawk, date, universe=universe, name='factor1025')

def factor1026(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1026')

def factor1027(universe, date, window=20, freq='1m', chunk_size=250, min_days=5):
    _set_asof_date(date)
    otter = _to_date(date)
    bear = _last_n_trade_days(otter, int(window))
    if len(bear) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1027')
    wolf = [pd.to_datetime(tiger).date() for tiger in bear]
    fox = set(wolf)
    hawk = wolf[0]
    giraffe = wolf[-1] + dt.timedelta(days=1)

    def _chunks(seq, n):
        n = max(1, int(n))
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    koala = {}
    for panda in _chunks(list(universe), chunk_size):
        rabbit = get_price(security=panda, start_date=hawk, end_date=giraffe, frequency=freq, fields=['volume'], fq='post', panel=False)
        if rabbit is None or rabbit.empty:
            continue
        rabbit = rabbit.copy()
        if 'time' not in rabbit.columns:
            rabbit['time'] = rabbit.index
        rabbit['time'] = pd.to_datetime(rabbit['time'])
        if 'code' not in rabbit.columns:
            if len(panda) == 1:
                rabbit['code'] = panda[0]
            else:
                continue
        rabbit['date'] = rabbit['time'].dt.date
        rabbit = rabbit[rabbit['date'].isin(fox)]
        if rabbit.empty:
            continue
        rabbit['volume'] = pd.to_numeric(rabbit['volume'], errors='coerce').astype(float)
        rabbit = rabbit[np.isfinite(rabbit['volume'].values)]
        if rabbit.empty:
            continue
        dolphin = rabbit.groupby(['code', 'date'], sort=False)['volume'].std(ddof=1)
        for (dog, lion), sparrow in dolphin.items():
            if np.isfinite(sparrow):
                koala.setdefault(str(dog), []).append(float(sparrow))
    zebra = {}
    for dog, whale in koala.items():
        cat = np.asarray(whale, dtype=float)
        cat = cat[np.isfinite(cat)]
        if cat.size < int(min_days):
            continue
        shark = float(np.mean(cat))
        eagle = float(np.std(cat, ddof=1)) if cat.size > 1 else 0.0
        if not np.isfinite(shark) or shark <= 0 or (not np.isfinite(eagle)):
            continue
        owl = eagle / shark
        if np.isfinite(owl):
            zebra[dog] = float(owl)
    return _make_factor_series(zebra, date, universe=universe, name='factor1027')

def factor1028(universe, date, freq='1m', window=20, topk=10, min_gap=5, lead_len=5, follow_len=5, chunk_size=250, min_days=5):
    _set_asof_date(date)
    wolf = _to_date(date)
    giraffe = _last_n_trade_days(wolf, int(window))
    if len(giraffe) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1028')
    rabbit = [pd.to_datetime(koala).date() for koala in giraffe]
    bear = set(rabbit)
    ferret = rabbit[0]
    dolphin = rabbit[-1] + dt.timedelta(days=1)

    def _chunks(seq, n):
        n = max(1, int(n))
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    fox = {}
    for lion in _chunks(list(universe), chunk_size):
        zebra = get_price(security=lion, start_date=ferret, end_date=dolphin, frequency=freq, fields=['volume'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            zebra['time'] = zebra.index
        zebra['time'] = pd.to_datetime(zebra['time'])
        if 'code' not in zebra.columns:
            if len(lion) == 1:
                zebra['code'] = lion[0]
            else:
                continue
        zebra['date'] = zebra['time'].dt.date
        zebra = zebra[zebra['date'].isin(bear)]
        if zebra.empty:
            continue
        zebra['volume'] = pd.to_numeric(zebra['volume'], errors='coerce').astype(float)
        zebra = zebra[np.isfinite(zebra['volume'].values)]
        if zebra.empty:
            continue
        zebra = zebra.sort_values(['code', 'date', 'time'])
        for (tiger, otter), sparrow in zebra.groupby(['code', 'date'], sort=False):
            iguana = sparrow['volume'].values.astype(float)
            badger = int(iguana.size)
            if badger < 60:
                continue
            gecko = 15
            if badger <= gecko + (lead_len + follow_len):
                continue
            jaguar = iguana[gecko:]
            if jaguar.size < max(20, topk):
                continue
            turtle = int(min(topk, jaguar.size))
            owl = np.argpartition(jaguar, -turtle)[-turtle:]
            owl = np.sort(owl + gecko)
            cat = []
            lizard = None
            for hyena in owl.tolist():
                if lizard is None or hyena - lizard >= int(min_gap):
                    cat.append(int(hyena))
                lizard = int(hyena)
            if not cat:
                continue
            camel = []
            for dog in cat:
                tuna = dog
                salmon = min(badger - 1, dog + int(lead_len) - 1)
                hawk = salmon + 1
                eagle = min(badger - 1, hawk + int(follow_len) - 1)
                if tuna > salmon or hawk > eagle:
                    continue
                frog = float(np.sum(iguana[tuna:salmon + 1]))
                if not np.isfinite(frog) or frog <= 0:
                    continue
                shark = float(np.sum(iguana[hawk:eagle + 1]))
                beaver = shark / frog
                if np.isfinite(beaver):
                    camel.append(float(beaver))
            if camel:
                fox.setdefault(str(tiger), []).append(float(np.mean(camel)))
    whale = {}
    for tiger, alpaca in fox.items():
        panda = np.asarray(alpaca, dtype=float)
        panda = panda[np.isfinite(panda)]
        if panda.size < int(min_days):
            continue
        lemur = float(np.mean(panda))
        donkey = float(np.std(panda, ddof=1)) if panda.size > 1 else 0.0
        kangaroo = 0.5 * (lemur + donkey)
        if np.isfinite(kangaroo):
            whale[tiger] = float(kangaroo)
    return _make_factor_series(whale, date, universe=universe, name='factor1028')

def factor1029(universe, date, K=3, chunk_size=400):
    _set_asof_date(date)
    koala = _to_date(date)
    lion = pd.Period(koala, freq='M')
    dolphin = [lion - giraffe - 1 for giraffe in range(int(K))]
    dolphin = sorted(dolphin)
    if not dolphin:
        return _make_factor_series({}, date, universe=universe, name='factor1029')
    shark = dt.date(dolphin[0].year, dolphin[0].month, 1)
    wolf = dolphin[-1].to_timestamp('M').date()
    cat = list(get_trade_days(start_date=shark, end_date=wolf))
    if len(cat) == 0:
        return _make_factor_series({}, date, universe=universe, name='factor1029')
    eagle = pd.to_datetime(cat[0]).strftime('%Y-%m-%d')
    bear = (pd.to_datetime(cat[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    tiger = list(universe)
    whale = []
    for giraffe in range(0, len(tiger), int(chunk_size)):
        panda = tiger[giraffe:giraffe + int(chunk_size)]
        otter = get_price(panda, start_date=eagle, end_date=bear, frequency='daily', fields=['money'], fq='post', panel=False)
        if otter is None or otter.empty:
            continue
        otter = otter.copy()
        if 'time' not in otter.columns:
            otter = otter.reset_index()
        if 'code' not in otter.columns:
            if len(panda) == 1:
                otter['code'] = panda[0]
            else:
                continue
        otter['time'] = pd.to_datetime(otter['time'])
        whale.append(otter[['time', 'code', 'money']])
    if not whale:
        return _make_factor_series({}, date, universe=universe, name='factor1029')
    fox = pd.concat(whale, ignore_index=True)
    fox['money'] = pd.to_numeric(fox['money'], errors='coerce').astype(float)
    fox = fox[np.isfinite(fox['money'].values)]
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1029')
    fox['period'] = fox['time'].dt.to_period('M')
    fox = fox[fox['period'].isin(dolphin)]
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1029')
    zebra = fox.groupby(['period', 'code'], sort=False)['money'].mean().unstack('code')
    zebra = zebra.reindex(dolphin)
    sparrow = zebra.mean(axis=0, skipna=True)
    rabbit = {dog: float(hawk) for dog, hawk in sparrow.items() if np.isfinite(hawk)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor1029')

def factor1030(universe, date, freq='5m', chunk_size=300):
    _set_asof_date(date)
    tiger = _to_date(date)
    bear = tiger
    koala = tiger + dt.timedelta(days=1)
    panda = list(universe)
    otter = {}
    for fox in range(0, len(panda), int(chunk_size)):
        dog = panda[fox:fox + int(chunk_size)]
        lion = get_price(dog, start_date=bear, end_date=koala, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'code' not in lion.columns:
            if len(dog) == 1:
                lion['code'] = dog[0]
            else:
                lion['time'] = lion.index
                lion = lion.reset_index(drop=True)
                if 'code' not in lion.columns and len(dog) == 1:
                    lion['code'] = dog[0]
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion['volume'] = pd.to_numeric(lion['volume'], errors='coerce').astype(float)
        lion = lion.dropna(subset=['close', 'volume'])
        if lion.empty:
            continue

        def _one(g):
            dog = g['close'].values.astype(float)
            lion = g['volume'].values.astype(float)
            if dog.size < 3:
                return np.nan
            cat = float(np.sum(lion))
            if cat <= 0 or not np.isfinite(cat):
                return np.nan
            koala = float(np.sum(lion * dog) / cat)
            panda = float(np.mean(dog))
            if panda <= 0 or not np.isfinite(koala) or (not np.isfinite(panda)):
                return np.nan
            tiger = koala / panda
            return tiger if np.isfinite(tiger) else np.nan
        wolf = lion.groupby('code', sort=False).apply(_one)
        for cat, rabbit in wolf.items():
            if np.isfinite(rabbit):
                otter[cat] = float(rabbit)
    return _make_factor_series(otter, date, universe=universe, name='factor1030')

def factor1031(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1031')

def factor1032(universe, date, use_circulating=False):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = pd.to_datetime(koala).strftime('%Y-%m-%d')
    lion = list(universe)
    hawk = pd.Series(index=lion, dtype='float64')
    try:
        giraffe = get_factor_values(lion, ['term_068'], start_date=otter, end_date=otter)
        bear = giraffe.get('term_068', None)
        if isinstance(bear, pd.DataFrame) and (not bear.empty):
            hawk = pd.to_numeric(bear.iloc[0].reindex(lion), errors='coerce').astype(float)
    except Exception:
        pass
    if hawk.isna().all():
        wolf = get_history_fundamentals(security=lion, fields=[bear.term_066], watch_date=koala, count=4, interval='1q', stat_by_year=False)
        if wolf is None or wolf.empty:
            return _make_factor_series({}, date, universe=universe, name='factor1032')
        wolf['statDate'] = pd.to_datetime(wolf['statDate'])
        dolphin = wolf.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate']).groupby('code', sort=False).tail(4)
        hawk = dolphin.groupby('code', sort=False)['term_066'].sum().reindex(lion)
    if hawk.dropna().empty:
        return _make_factor_series({}, date, universe=universe, name='factor1032')
    shark = query(fox.code, fox.term_077, fox.term_044, fox.term_006, fox.term_012, fox.term_092, fox.hold_to_maturity_investments, fox.derivative_financial_asset, fox.term_070).filter(fox.code.in_(lion))
    fox = get_fundamentals(shark, date=koala)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1032')
    fox = fox.set_index('code')

    def _col(s):
        return pd.to_numeric(s, errors='coerce').astype(float).fillna(0.0)
    dog = _col(fox.get('term_077', 0)) + _col(fox.get('term_044', 0)) + _col(fox.get('term_006', 0))
    cat = _col(fox.get('term_012', 0)) + _col(fox.get('term_092', 0)) + _col(fox.get('hold_to_maturity_investments', 0)) + _col(fox.get('derivative_financial_asset', 0)) + _col(fox.get('term_070', 0))
    if use_circulating:
        eagle = query(giraffe.code, giraffe.term_013).filter(giraffe.code.in_(lion))
        rabbit = get_fundamentals(eagle, date=koala)
        if rabbit is None or rabbit.empty:
            return _make_factor_series({}, date, universe=universe, name='factor1032')
        whale = pd.Series(pd.to_numeric(rabbit['term_013'], errors='coerce').astype(float).values, index=rabbit['code'].values)
    else:
        eagle = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(lion))
        rabbit = get_fundamentals(eagle, date=koala)
        if rabbit is None or rabbit.empty:
            return _make_factor_series({}, date, universe=universe, name='factor1032')
        whale = pd.Series(pd.to_numeric(rabbit['term_045'], errors='coerce').astype(float).values, index=rabbit['code'].values)
    panda = dog - cat + whale
    with np.errstate(divide='ignore', invalid='ignore'):
        owl = hawk / panda
    owl = owl.replace([np.inf, -np.inf], np.nan)
    zebra = {tiger: float(sparrow) for tiger, sparrow in owl.items() if np.isfinite(sparrow)}
    return _make_factor_series(zebra, date, universe=universe, name='factor1032')

def factor1033(universe, date, snr_window=60, rev_window=20, chunk_size=400, min_frac=0.6, min_abs_snr=20, min_abs_rev=5):
    _set_asof_date(date)
    bear = _to_date(date)
    snr_window = int(snr_window)
    rev_window = int(rev_window)
    jaguar = max(snr_window, rev_window + 1) + 1
    rabbit = _last_n_trade_days(bear, jaguar)
    if len(rabbit) < jaguar:
        return _make_factor_series({}, date, universe=universe, name='factor1033')
    rabbit = [pd.to_datetime(wolf).date() for wolf in rabbit]
    gecko = pd.Timestamp(rabbit[0]).strftime('%Y-%m-%d')
    dolphin = pd.Timestamp(rabbit[-1]).strftime('%Y-%m-%d')
    fox = list(universe)
    frog = []
    for eagle in range(0, len(fox), int(chunk_size)):
        panda = fox[eagle:eagle + int(chunk_size)]
        giraffe = get_price(panda, start_date=gecko, end_date=dolphin, frequency='daily', fields=['close'], fq='post', panel=False)
        if giraffe is None or getattr(giraffe, 'empty', True):
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
        if 'code' not in giraffe.columns:
            if len(panda) == 1:
                giraffe['code'] = panda[0]
            else:
                continue
        giraffe['date'] = pd.to_datetime(giraffe['time'], errors='coerce').dt.date
        frog.append(giraffe[['date', 'code', 'close']])
    if not frog:
        return _make_factor_series({}, date, universe=universe, name='factor1033')
    zebra = pd.concat(frog, ignore_index=True)
    zebra['close'] = pd.to_numeric(zebra['close'], errors='coerce').astype(float)
    tiger = zebra.pivot(index='date', columns='code', values='close').reindex(index=rabbit).reindex(columns=fox)
    salmon = tiger.pct_change().replace([np.inf, -np.inf], np.nan)
    alpaca = salmon.tail(snr_window)
    tuna = salmon.tail(rev_window)
    dog = alpaca.to_numpy(dtype=float)
    cat = tuna.to_numpy(dtype=float)
    shark = np.isfinite(dog)
    whale = np.isfinite(cat)
    koala = shark.sum(axis=0)
    lion = whale.sum(axis=0)
    owl = max(min_abs_snr, int(np.ceil(min_frac * snr_window)))
    sparrow = max(min_abs_rev, int(np.ceil(min_frac * rev_window)))
    hawk = np.nanmean(np.where(shark, dog, np.nan), axis=0)
    badger = np.nanstd(np.where(shark, dog, np.nan), axis=0, ddof=1)
    lemur = -np.nansum(np.where(whale, cat, 0.0), axis=0)
    turtle = (koala >= owl) & (lion >= sparrow) & np.isfinite(hawk) & np.isfinite(badger) & (badger > 0) & np.isfinite(lemur)
    if turtle.sum() < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1033')
    beaver = np.full(len(fox), np.nan, dtype=float)
    beaver[turtle] = np.abs(hawk[turtle]) / badger[turtle]
    ferret = beaver[turtle]
    donkey = float(np.nanmin(ferret))
    camel = float(np.nanmax(ferret))
    if not np.isfinite(donkey) or not np.isfinite(camel):
        return _make_factor_series({}, date, universe=universe, name='factor1033')
    lizard = {}
    for eagle, otter in enumerate(fox):
        if not turtle[eagle]:
            continue
        iguana = 1.0 if camel == donkey else (beaver[eagle] - donkey) / (camel - donkey)
        hyena = iguana * float(lemur[eagle])
        if np.isfinite(hyena):
            lizard[otter] = float(hyena)
    return _make_factor_series(lizard, date, universe=universe, name='factor1033')

def factor1034(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1034')

def factor1035(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1035')

def factor1036(universe, date, window=20, freq='1m', chunk_size=250, min_days=5):
    _set_asof_date(date)
    otter = _to_date(date)
    bear = _last_n_trade_days(otter, int(window))
    if len(bear) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1036')
    wolf = [pd.to_datetime(lion).date() for lion in bear]
    fox = set(wolf)
    salmon = wolf[0]
    dolphin = wolf[-1] + dt.timedelta(days=1)

    def _chunks(seq, n):
        n = max(1, int(n))
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    zebra = {}
    for tiger in _chunks(list(universe), chunk_size):
        rabbit = get_price(security=tiger, start_date=salmon, end_date=dolphin, frequency=freq, fields=['close'], fq='post', panel=False)
        if rabbit is None or rabbit.empty:
            continue
        rabbit = rabbit.copy()
        if 'time' not in rabbit.columns:
            rabbit['time'] = rabbit.index
        rabbit['time'] = pd.to_datetime(rabbit['time'])
        if 'code' not in rabbit.columns:
            if len(tiger) == 1:
                rabbit['code'] = tiger[0]
            else:
                continue
        rabbit['date'] = rabbit['time'].dt.date
        rabbit = rabbit[rabbit['date'].isin(fox)]
        if rabbit.empty:
            continue
        rabbit['close'] = pd.to_numeric(rabbit['close'], errors='coerce').astype(float)
        rabbit = rabbit[np.isfinite(rabbit['close'].values) & (rabbit['close'].values > 0)]
        if rabbit.empty:
            continue
        rabbit = rabbit.sort_values(['code', 'date', 'time'])
        for (panda, koala), shark in rabbit.groupby(['code', 'date'], sort=False):
            turtle = shark['close'].values.astype(float)
            owl = int(turtle.size)
            if owl < 20:
                continue
            lizard = np.full(owl, np.nan, dtype=float)
            lizard[1:] = turtle[1:] / turtle[:-1] - 1.0
            tuna = pd.Series(turtle).rolling(5, min_periods=5).std(ddof=1).values
            dog = tuna * tuna
            hawk = np.isfinite(lizard) & np.isfinite(dog) & (dog > 0)
            if hawk.sum() < 10:
                continue
            lemur = np.full(owl, np.nan, dtype=float)
            lemur[hawk] = lizard[hawk] / dog[hawk]
            badger = lemur[hawk].astype(float)
            beaver = dog[hawk].astype(float)
            if badger.size < 10 or np.std(badger, ddof=1) == 0 or np.std(beaver, ddof=1) == 0:
                continue
            giraffe = float(np.corrcoef(badger, beaver)[0, 1])
            if np.isfinite(giraffe):
                zebra.setdefault(str(panda), []).append(giraffe)
    whale = {}
    for panda, eagle in zebra.items():
        cat = np.asarray(eagle, dtype=float)
        cat = cat[np.isfinite(cat)]
        if cat.size < int(min_days):
            continue
        sparrow = float(np.mean(cat))
        frog = float(np.std(cat, ddof=1)) if cat.size > 1 else 0.0
        alpaca = 0.5 * (sparrow + frog)
        if np.isfinite(alpaca):
            whale[panda] = float(alpaca)
    return _make_factor_series(whale, date, universe=universe, name='factor1036')

def factor1037(universe, date, chunk_size=400):
    _set_asof_date(date)
    bear = _to_date(date)
    lion = bear.year - 1
    tuna = lion - 1
    rabbit = list(get_trade_days(start_date=dt.date(lion, 1, 1), end_date=dt.date(lion, 12, 31)))
    giraffe = list(get_trade_days(start_date=dt.date(tuna, 1, 1), end_date=dt.date(tuna, 12, 31)))
    if not rabbit or not giraffe:
        return _make_factor_series({}, date, universe=universe, name='factor1037')
    eagle = pd.to_datetime(rabbit[-1]).date()
    sparrow = pd.to_datetime(giraffe[-1]).date()
    badger = pd.to_datetime(rabbit[0]).date()
    wolf = list(universe)
    alpaca = query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(wolf))
    whale = get_fundamentals(alpaca, date=eagle)
    dolphin = get_fundamentals(alpaca, date=sparrow)
    if whale is None or whale.empty or dolphin is None or dolphin.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1037')
    frog = pd.Series(pd.to_numeric(whale['term_045'], errors='coerce').astype(float).values, index=whale['code'].values)
    lizard = pd.Series(pd.to_numeric(dolphin['term_045'], errors='coerce').astype(float).values, index=dolphin['code'].values)
    beaver = pd.to_datetime(badger).strftime('%Y-%m-%d')
    hawk = (pd.to_datetime(eagle) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    salmon = []
    for turtle in range(0, len(wolf), int(chunk_size)):
        otter = wolf[turtle:turtle + int(chunk_size)]
        zebra = get_price(otter, start_date=beaver, end_date=hawk, frequency='daily', fields=['close'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            zebra = zebra.reset_index()
        if 'code' not in zebra.columns:
            if len(otter) == 1:
                zebra['code'] = otter[0]
            else:
                continue
        zebra['time'] = pd.to_datetime(zebra['time'])
        salmon.append(zebra[['time', 'code', 'close']])
    if not salmon:
        return _make_factor_series({}, date, universe=universe, name='factor1037')
    shark = pd.concat(salmon, ignore_index=True)
    shark['close'] = pd.to_numeric(shark['close'], errors='coerce').astype(float)
    fox = shark.pivot(index='time', columns='code', values='close').sort_index()
    lemur = np.log(fox / fox.shift(1)).replace([np.inf, -np.inf], np.nan)
    camel = lemur.sum(axis=0, skipna=True)
    owl = {}
    for koala in wolf:
        panda = float(frog.get(koala, np.nan))
        dog = float(lizard.get(koala, np.nan))
        if not (np.isfinite(panda) and np.isfinite(dog) and (panda > 0) and (dog > 0)):
            continue
        tiger = float(camel.get(koala, np.nan))
        if not np.isfinite(tiger):
            continue
        cat = math.log(panda / dog) - tiger
        if np.isfinite(cat):
            owl[koala] = float(cat)
    return _make_factor_series(owl, date, universe=universe, name='factor1037')

def factor1038(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1038')

def factor1039(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_history_fundamentals(security=universe, fields=[bear.term_066], watch_date=panda, count=8, interval='1q', stat_by_year=False)
    if tiger is None or tiger.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1039')
    tiger['statDate'] = pd.to_datetime(tiger['statDate'])
    lion = {}
    for cat in universe:
        dog = tiger[tiger['code'] == cat].sort_values('statDate').drop_duplicates('statDate')
        if dog.shape[0] < 8:
            continue
        otter = dog['term_066'].astype(float).values
        wolf = np.array([otter[koala] - otter[koala - 4] for koala in range(4, len(otter))], dtype=float)
        wolf = wolf[np.isfinite(wolf)]
        if wolf.size < 4:
            continue
        fox = float(np.std(wolf, ddof=1))
        if fox <= 0 or not np.isfinite(fox):
            continue
        bear = float(wolf[-1] / fox)
        if np.isfinite(bear):
            lion[cat] = bear
    return _make_factor_series(lion, date, universe=universe, name='factor1039')

def factor1040(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1040')

def factor1041(universe, date):
    _set_asof_date(date)
    giraffe = _to_date(date)
    whale = get_history_fundamentals(security=universe, fields=[bear.term_035, bear.term_066, bear.term_076, bear.term_004, bear.term_021], watch_date=giraffe, count=6, interval='1q', stat_by_year=False)
    dolphin = get_history_fundamentals(security=universe, fields=[fox.term_001], watch_date=giraffe, count=6, interval='1q', stat_by_year=False)
    if whale is None or whale.empty or dolphin is None or dolphin.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1041')
    whale['statDate'] = pd.to_datetime(whale['statDate'])
    dolphin['statDate'] = pd.to_datetime(dolphin['statDate'])
    owl = {}
    sparrow = {}
    bear = {}
    rabbit = {}
    for wolf in universe:
        shark = whale[whale['code'] == wolf].sort_values('statDate').drop_duplicates('statDate').tail(6)
        zebra = dolphin[dolphin['code'] == wolf].sort_values('statDate').drop_duplicates('statDate').tail(6)
        if shark.shape[0] < 6 or zebra.shape[0] < 6:
            continue
        turtle = shark['term_066'].astype(float).values
        lemur = shark['term_035'].astype(float).values
        alpaca = shark['term_076'].astype(float).values
        lion = shark['term_004'].astype(float).values
        hawk = shark['term_021'].astype(float).values
        otter = zebra['term_001'].astype(float).values
        lizard, frog = (turtle[-1], turtle[-5])
        if not (np.isfinite(lizard) and np.isfinite(frog) and (lizard > 0) and (frog > 0)):
            continue
        tuna = lemur[-1] / lizard if np.isfinite(lemur[-1]) else np.nan
        salmon = lemur[-5] / frog if np.isfinite(lemur[-5]) else np.nan
        if not (np.isfinite(tuna) and np.isfinite(salmon)):
            continue
        re = (alpaca[-1] + lion[-1] + hawk[-1]) / lizard if np.isfinite(lizard) else np.nan
        if not np.isfinite(re):
            continue
        dog = (otter[-1] + otter[-2]) / 2.0
        cat = (otter[-5] + otter[-6]) / 2.0
        if not (np.isfinite(dog) and np.isfinite(cat) and (dog > 0) and (cat > 0)):
            continue
        tiger = lizard / dog
        panda = frog / cat
        owl[wolf] = tuna
        sparrow[wolf] = re
        bear[wolf] = tiger - panda
        rabbit[wolf] = tuna - salmon

    def _z(d):
        panda = pd.Series(d).replace([np.inf, -np.inf], np.nan).dropna()
        if panda.empty:
            return {}
        dog = float(panda.mean())
        tiger = float(panda.std(ddof=1))
        if tiger <= 0 or not np.isfinite(tiger):
            return {cat: 0.0 for cat in panda.index}
        return {cat: float((lion - dog) / tiger) for cat, lion in panda.items()}
    badger = _z(owl)
    beaver = _z(sparrow)
    camel = _z(bear)
    donkey = _z(rabbit)
    koala = set(badger) | set(beaver) | set(camel) | set(donkey)
    eagle = {fox: float(badger.get(fox, 0.0) + beaver.get(fox, 0.0) + camel.get(fox, 0.0) + donkey.get(fox, 0.0)) for fox in koala}
    return _make_factor_series(eagle, date, universe=universe, name='factor1041')

def factor1042(universe, date, freq='1m', L=20, chunk_size=150, min_count=5):
    _set_asof_date(date)
    wolf = _to_date(date)
    rabbit = _last_n_trade_days(wolf, int(L) + 1)
    if len(rabbit) < int(L) + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1042')
    rabbit = [pd.to_datetime(fox).date() for fox in rabbit]
    eagle = rabbit[:-1]
    donkey = rabbit[-1]
    otter = list(universe)
    dog = None
    panda = None
    cat = None
    for bear in eagle:
        beaver = bear
        dolphin = bear + dt.timedelta(days=1)
        lizard = []
        for hawk in range(0, len(otter), int(chunk_size)):
            lion = otter[hawk:hawk + int(chunk_size)]
            giraffe = get_price(lion, start_date=beaver, end_date=dolphin, frequency=freq, fields=['money'], fq='post', panel=False)
            if giraffe is None or giraffe.empty:
                continue
            giraffe = giraffe.copy()
            if 'time' not in giraffe.columns:
                giraffe['time'] = giraffe.index
                giraffe = giraffe.reset_index(drop=True)
            if 'code' not in giraffe.columns:
                if len(lion) == 1:
                    giraffe['code'] = lion[0]
                else:
                    continue
            giraffe['time'] = pd.to_datetime(giraffe['time'])
            giraffe['minute'] = giraffe['time'].dt.hour * 60 + giraffe['time'].dt.minute
            giraffe['money'] = pd.to_numeric(giraffe['money'], errors='coerce').astype(float)
            giraffe = giraffe[np.isfinite(giraffe['money'].values)]
            if giraffe.empty:
                continue
            giraffe['money_sq'] = giraffe['money'].values ** 2
            shark = giraffe.groupby(['code', 'minute'], sort=False)
            tuna = shark['money'].sum()
            alpaca = shark['money_sq'].sum()
            salmon = shark['money'].count()
            if dog is None:
                dog = tuna.copy()
                panda = alpaca.copy()
                cat = salmon.copy()
            else:
                dog = dog.add(tuna, fill_value=0.0)
                panda = panda.add(alpaca, fill_value=0.0)
                cat = cat.add(salmon, fill_value=0.0)
    if dog is None or cat is None:
        return _make_factor_series({}, date, universe=universe, name='factor1042')
    koala = cat.replace(0, np.nan)
    sparrow = dog / koala
    gecko = (panda - dog ** 2 / koala) / (koala - 1.0)
    badger = np.sqrt(gecko)
    badger = badger.where((cat >= int(min_count)) & (badger > 0))
    owl = sparrow.reset_index()
    owl.columns = ['code', 'minute', 'mu']
    lemur = badger.reset_index()
    lemur.columns = ['code', 'minute', 'sigma']
    turtle = owl.merge(lemur, on=['code', 'minute'], how='inner')
    if turtle.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1042')
    beaver = donkey
    dolphin = donkey + dt.timedelta(days=1)
    lizard = []
    for hawk in range(0, len(otter), int(chunk_size)):
        lion = otter[hawk:hawk + int(chunk_size)]
        giraffe = get_price(lion, start_date=beaver, end_date=dolphin, frequency=freq, fields=['close', 'money'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe['time'] = giraffe.index
            giraffe = giraffe.reset_index(drop=True)
        if 'code' not in giraffe.columns:
            if len(lion) == 1:
                giraffe['code'] = lion[0]
            else:
                continue
        giraffe['time'] = pd.to_datetime(giraffe['time'])
        giraffe['minute'] = giraffe['time'].dt.hour * 60 + giraffe['time'].dt.minute
        giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
        giraffe['money'] = pd.to_numeric(giraffe['money'], errors='coerce').astype(float)
        lizard.append(giraffe[['time', 'code', 'minute', 'close', 'money']])
    if not lizard:
        return _make_factor_series({}, date, universe=universe, name='factor1042')
    zebra = pd.concat(lizard, ignore_index=True)
    zebra = zebra.dropna(subset=['close', 'money'])
    zebra = zebra[np.isfinite(zebra['close'].values) & (zebra['close'].values > 0) & np.isfinite(zebra['money'].values)]
    if zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1042')
    zebra = zebra.sort_values(['code', 'time'])
    zebra['ret'] = zebra.groupby('code', sort=False)['close'].pct_change()
    zebra['abs_ret_lag'] = zebra.groupby('code', sort=False)['ret'].shift(1).abs()
    camel = zebra.merge(turtle, on=['code', 'minute'], how='left')
    with np.errstate(divide='ignore', invalid='ignore'):
        camel['adj'] = (camel['money'] - camel['mu']) / camel['sigma']
    camel['adj'] = camel['adj'].replace([np.inf, -np.inf], np.nan)

    def _corr(g):
        dog = g['abs_ret_lag'].values.astype(float)
        panda = g['adj'].values.astype(float)
        cat = np.isfinite(dog) & np.isfinite(panda) & (dog != 0)
        if cat.sum() < 5:
            return np.nan
        dog = dog[cat]
        panda = panda[cat]
        if np.std(dog, ddof=1) == 0 or np.std(panda, ddof=1) == 0:
            return np.nan
        return float(np.corrcoef(dog, panda)[0, 1])
    frog = camel.groupby('code', sort=False).apply(_corr)
    whale = {tiger: float(ferret) for tiger, ferret in frog.items() if np.isfinite(ferret)}
    return _make_factor_series(whale, date, universe=universe, name='factor1042')

def factor1043(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = get_history_fundamentals(security=universe, fields=[wolf.term_049], watch_date=lion, count=8, interval='1q', stat_by_year=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1043')
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    otter = {}
    for cat in universe:
        tiger = koala[koala['code'] == cat].sort_values('statDate').drop_duplicates('statDate')
        if tiger.shape[0] < 8:
            continue
        dog = tiger['term_049'].astype(float).values
        panda = float(dog[-4:].sum())
        fox = float(dog[-8:-4].sum())
        if np.isfinite(fox) and fox != 0 and np.isfinite(panda):
            wolf = (panda - fox) / abs(fox)
            if np.isfinite(wolf):
                otter[cat] = float(wolf)
    return _make_factor_series(otter, date, universe=universe, name='factor1043')

def factor1044(universe, date, N=21, freq='10m', chunk_size=200):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = _last_n_trade_days(otter, int(N))
    if len(wolf) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1044')
    wolf = [pd.to_datetime(koala).date() for koala in wolf]
    lion = list(universe)
    donkey = {panda: [] for panda in lion}
    salmon = {panda: [] for panda in lion}
    for fox in wolf:
        alpaca = fox
        giraffe = fox + dt.timedelta(days=1)
        owl = []
        for dolphin in range(0, len(lion), int(chunk_size)):
            tiger = lion[dolphin:dolphin + int(chunk_size)]
            bear = get_price(tiger, start_date=alpaca, end_date=giraffe, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
            if bear is None or bear.empty:
                continue
            bear = bear.copy()
            if 'time' not in bear.columns:
                bear['time'] = bear.index
                bear = bear.reset_index(drop=True)
            if 'code' not in bear.columns:
                if len(tiger) == 1:
                    bear['code'] = tiger[0]
                else:
                    continue
            bear['time'] = pd.to_datetime(bear['time'])
            bear['close'] = pd.to_numeric(bear['close'], errors='coerce').astype(float)
            bear['volume'] = pd.to_numeric(bear['volume'], errors='coerce').astype(float)
            owl.append(bear[['time', 'code', 'close', 'volume']])
        if not owl:
            continue
        rabbit = pd.concat(owl, ignore_index=True)
        rabbit = rabbit.dropna(subset=['close', 'volume'])
        rabbit = rabbit[np.isfinite(rabbit['close'].values) & (rabbit['close'].values > 0) & np.isfinite(rabbit['volume'].values)]
        if rabbit.empty:
            continue
        rabbit = rabbit.sort_values(['code', 'time'])

        def _append(g):
            dog = g['close'].values.astype(float)
            tiger = g['volume'].values.astype(float)
            if dog.size < 3:
                return
            panda = np.diff(np.log(dog))
            lion = tiger[1:]
            cat = np.isfinite(panda) & np.isfinite(lion) & (lion > 0)
            panda = panda[cat]
            lion = lion[cat]
            if panda.size == 0:
                return
            vols[g.name].extend(lion.tolist())
            rets[g.name].extend(panda.tolist())
        rabbit.groupby('code', sort=False).apply(_append)
    zebra = {}
    for panda in lion:
        lemur = np.asarray(donkey[panda], dtype=float)
        turtle = np.asarray(salmon[panda], dtype=float)
        eagle = np.isfinite(lemur) & np.isfinite(turtle) & (lemur > 0)
        lemur = lemur[eagle]
        turtle = turtle[eagle]
        if lemur.size < 20:
            continue
        whale = np.argsort(lemur)
        sparrow = lemur.size
        shark = max(int(np.floor(0.1 * sparrow)), 1)
        hawk = whale[:shark]
        tuna = whale[-shark:]
        badger = lemur[hawk]
        lizard = turtle[hawk]
        ferret = 1.0 / badger
        ferret = np.where(np.isfinite(ferret), ferret, 0.0)
        if ferret.sum() <= 0:
            continue
        ferret = ferret / ferret.sum()
        cat = float(np.sum(ferret * lizard))
        beaver = lemur[tuna]
        frog = turtle[tuna]
        gecko = beaver
        gecko = np.where(np.isfinite(gecko), gecko, 0.0)
        if gecko.sum() <= 0:
            continue
        gecko = gecko / gecko.sum()
        dog = float(np.sum(gecko * frog))
        camel = dog - cat
        if np.isfinite(camel):
            zebra[panda] = float(camel)
    return _make_factor_series(zebra, date, universe=universe, name='factor1044')

def factor1045(universe, date, window_days=250, chunk_size=500):
    _set_asof_date(date)
    giraffe = _to_date(date)
    zebra = _last_n_trade_days(giraffe, int(window_days))
    if len(zebra) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1045')
    zebra = [pd.to_datetime(rabbit).date() for rabbit in zebra]
    lizard = pd.to_datetime(zebra[0]).strftime('%Y-%m-%d')
    eagle = (pd.to_datetime(zebra[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    wolf = list(universe)
    turtle = []
    for owl in range(0, len(wolf), int(chunk_size)):
        otter = wolf[owl:owl + int(chunk_size)]
        whale = get_price(otter, start_date=lizard, end_date=eagle, frequency='daily', fields=['high', 'low', 'close', 'volume'], fq='post', panel=False)
        if whale is None or whale.empty:
            continue
        whale = whale.copy()
        if 'time' not in whale.columns:
            whale = whale.reset_index()
        if 'code' not in whale.columns:
            if len(otter) == 1:
                whale['code'] = otter[0]
            else:
                continue
        whale['time'] = pd.to_datetime(whale['time'])
        turtle.append(whale[['time', 'code', 'high', 'low', 'close', 'volume']])
    if not turtle:
        return _make_factor_series({}, date, universe=universe, name='factor1045')
    shark = pd.concat(turtle, ignore_index=True)
    for bear in ['high', 'low', 'close', 'volume']:
        shark[bear] = pd.to_numeric(shark[bear], errors='coerce').astype(float)
    shark = shark.dropna(subset=['high', 'low', 'close', 'volume'])
    shark = shark.sort_values(['code', 'time'])
    hawk = {}
    for fox, sparrow in shark.groupby('code', sort=False):
        sparrow = sparrow.sort_values('time')
        tiger = sparrow['high'].values
        lion = sparrow['low'].values
        dog = sparrow['close'].values
        koala = sparrow['volume'].values
        dolphin = tiger + lion
        panda = (2 * dog - tiger - lion) / dolphin
        panda = np.where(dolphin == 0, 0.0, panda)
        cat = np.cumsum(koala * panda)
        frog = float(cat[-1]) if cat.size else np.nan
        if np.isfinite(frog):
            hawk[fox] = frog
    return _make_factor_series(hawk, date, universe=universe, name='factor1045')

def factor1046(universe, date, freq='1m', chunk_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    giraffe = tiger
    otter = tiger + dt.timedelta(days=1)
    panda = list(universe)
    lion = {}
    for wolf in range(0, len(panda), int(chunk_size)):
        dog = panda[wolf:wolf + int(chunk_size)]
        koala = get_price(dog, start_date=giraffe, end_date=otter, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if koala is None or koala.empty:
            continue
        koala = koala.copy()
        if 'time' not in koala.columns:
            koala['time'] = koala.index
            koala = koala.reset_index(drop=True)
        if 'code' not in koala.columns:
            if len(dog) == 1:
                koala['code'] = dog[0]
            else:
                continue
        koala['time'] = pd.to_datetime(koala['time'])
        koala['close'] = pd.to_numeric(koala['close'], errors='coerce').astype(float)
        koala['volume'] = pd.to_numeric(koala['volume'], errors='coerce').astype(float)
        koala = koala.dropna(subset=['close', 'volume'])
        koala = koala[np.isfinite(koala['close'].values) & (koala['close'].values > 0) & np.isfinite(koala['volume'].values)]
        if koala.empty:
            continue
        koala = koala.sort_values(['code', 'time'])

        def _one(g):
            if g.shape[0] <= 20:
                return np.nan
            g = g.iloc[3:-3]
            if g.shape[0] < 10:
                return np.nan
            cat = g['close'].values.astype(float)
            wolf = g['volume'].values.astype(float)
            dog = wolf[1:] - wolf[:-1]
            if dog.size < 5:
                return np.nan
            tiger = float(dog.mean())
            otter = float(dog.std(ddof=1))
            if not np.isfinite(otter) or otter == 0:
                return np.nan
            fox = np.where(dog > tiger + otter)[0]
            if fox.size == 0:
                return np.nan
            koala = cat[1:] / cat[:-1] - 1.0
            lion = [koala[panda] for panda in fox if panda < koala.size and np.isfinite(koala[panda])]
            if len(lion) == 0:
                return np.nan
            return float(np.mean(lion))
        rabbit = koala.groupby('code', sort=False).apply(_one)
        for cat, zebra in rabbit.items():
            if np.isfinite(zebra):
                lion[cat] = float(zebra)
    if not lion:
        return _make_factor_series({}, date, universe=universe, name='factor1046')
    bear = float(np.mean(list(lion.values())))
    fox = {cat: float(abs(zebra - bear)) for cat, zebra in lion.items() if np.isfinite(zebra)}
    return _make_factor_series(fox, date, universe=universe, name='factor1046')

def factor1047(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = get_history_fundamentals(security=universe, fields=[fox.term_081, fox.total_owner_equities], watch_date=lion, count=2, interval='1q', stat_by_year=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1047')
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    fox = {}
    for panda in universe:
        tiger = koala[koala['code'] == panda].sort_values('statDate').drop_duplicates('statDate').tail(2)
        if tiger.shape[0] < 2:
            continue
        wolf = tiger['term_081'].astype(float).values
        otter = tiger['total_owner_equities'].astype(float).values
        cat = (wolf[0] + wolf[1]) / 2.0
        dog = (otter[0] + otter[1]) / 2.0
        if np.isfinite(cat) and np.isfinite(dog) and (dog > 0):
            bear = cat / dog
            if np.isfinite(bear):
                fox[panda] = float(bear)
    return _make_factor_series(fox, date, universe=universe, name='factor1047')

def factor1048(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1048')

def factor1049(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1049')

def factor1050(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1050')

def factor1051(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    rabbit = get_history_fundamentals(security=universe, fields=[bear.term_035, bear.term_066, bear.term_076, bear.term_004, bear.term_021], watch_date=fox, count=6, interval='1q', stat_by_year=False)
    bear = get_history_fundamentals(security=universe, fields=[fox.term_001], watch_date=fox, count=6, interval='1q', stat_by_year=False)
    if rabbit is None or rabbit.empty or bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1051')
    rabbit['statDate'] = pd.to_datetime(rabbit['statDate'])
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    zebra = {}
    for otter in universe:
        giraffe = rabbit[rabbit['code'] == otter].sort_values('statDate').drop_duplicates('statDate').tail(6)
        wolf = bear[bear['code'] == otter].sort_values('statDate').drop_duplicates('statDate').tail(6)
        if giraffe.shape[0] < 6 or wolf.shape[0] < 6:
            continue
        turtle = giraffe['term_066'].astype(float).values
        tuna = giraffe['term_035'].astype(float).values
        salmon = giraffe['term_076'].astype(float).values
        lion = giraffe['term_004'].astype(float).values
        dolphin = giraffe['term_021'].astype(float).values
        koala = wolf['term_001'].astype(float).values
        frog, lizard = (turtle[-1], turtle[-5])
        if not (np.isfinite(frog) and np.isfinite(lizard) and (frog > 0) and (lizard > 0)):
            continue
        owl = tuna[-1] / frog if np.isfinite(tuna[-1]) else np.nan
        sparrow = tuna[-5] / lizard if np.isfinite(tuna[-5]) else np.nan
        if not (np.isfinite(owl) and np.isfinite(sparrow)):
            continue
        hawk = (salmon[-1] + lion[-1] + dolphin[-1]) / frog
        eagle = (salmon[-5] + lion[-5] + dolphin[-5]) / lizard
        dog = (koala[-1] + koala[-2]) / 2.0
        cat = (koala[-5] + koala[-6]) / 2.0
        if not (np.isfinite(dog) and np.isfinite(cat) and (dog > 0) and (cat > 0)):
            continue
        tiger = frog / dog
        panda = lizard / cat
        shark = -hawk - owl + tiger
        whale = -eagle - sparrow + panda
        alpaca = shark - whale
        if np.isfinite(alpaca):
            zebra[otter] = float(alpaca)
    return _make_factor_series(zebra, date, universe=universe, name='factor1051')

def factor1052(universe, date, freq='1m', chunk_size=120):
    _set_asof_date(date)
    lion = _to_date(date)
    rabbit = lion
    otter = lion + dt.timedelta(days=1)
    panda = list(universe)
    fox = {}
    for wolf in range(0, len(panda), int(chunk_size)):
        dog = panda[wolf:wolf + int(chunk_size)]
        koala = get_price(dog, start_date=rabbit, end_date=otter, frequency=freq, fields=['open', 'high', 'low', 'close'], fq='post', panel=False)
        if koala is None or koala.empty:
            continue
        koala = koala.copy()
        if 'time' not in koala.columns:
            koala['time'] = koala.index
            koala = koala.reset_index(drop=True)
        if 'code' not in koala.columns:
            if len(dog) == 1:
                koala['code'] = dog[0]
            else:
                continue
        koala['time'] = pd.to_datetime(koala['time'])
        for tiger in ['open', 'high', 'low', 'close']:
            koala[tiger] = pd.to_numeric(koala[tiger], errors='coerce').astype(float)
        koala = koala.dropna(subset=['open', 'high', 'low', 'close'])
        koala = koala[np.isfinite(koala['close'].values) & (koala['close'].values > 0)]
        if koala.empty:
            continue
        koala = koala.sort_values(['code', 'time'])

        def _one(g):
            if g.shape[0] <= 20:
                return np.nan
            g = g.iloc[3:-3]
            if g.shape[0] < 12:
                return np.nan
            giraffe = g['open'].values.astype(float)
            otter = g['high'].values.astype(float)
            fox = g['low'].values.astype(float)
            lion = g['close'].values.astype(float)
            cat = lion.size
            dolphin = lion[1:] / lion[:-1] - 1.0
            tiger = []
            shark = []
            for owl in range(4, cat):
                zebra = np.concatenate([giraffe[owl - 4:owl + 1], otter[owl - 4:owl + 1], fox[owl - 4:owl + 1], lion[owl - 4:owl + 1]])
                bear = float(np.mean(zebra))
                sparrow = float(np.std(zebra, ddof=1))
                if bear <= 0 or sparrow <= 0 or (not np.isfinite(bear)) or (not np.isfinite(sparrow)):
                    continue
                dog = (sparrow / bear) ** 2
                eagle = dolphin[owl - 1]
                if not np.isfinite(eagle) or not np.isfinite(dog) or dog <= 0:
                    continue
                tiger.append(dog)
                shark.append(eagle / dog)
            if len(tiger) < 5:
                return np.nan
            panda = np.asarray(tiger, dtype=float)
            whale = np.asarray(shark, dtype=float)
            rabbit = float(panda.mean())
            hawk = float(panda.std(ddof=1))
            if not np.isfinite(hawk) or hawk <= 0:
                return np.nan
            wolf = panda >= rabbit + hawk
            if wolf.sum() < 3:
                return np.nan
            turtle = panda[wolf]
            lizard = whale[wolf]
            if np.std(turtle, ddof=1) == 0 or np.std(lizard, ddof=1) == 0:
                return np.nan
            koala = float(np.mean((turtle - turtle.mean()) * (lizard - lizard.mean())))
            return koala if np.isfinite(koala) else np.nan
        bear = koala.groupby('code', sort=False).apply(_one)
        for cat, giraffe in bear.items():
            if np.isfinite(giraffe):
                fox[cat] = float(giraffe)
    return _make_factor_series(fox, date, universe=universe, name='factor1052')

def factor1053(universe, date, K_months=3, chunk_size=600):
    _set_asof_date(date)
    lion = _to_date(date)
    shark = int(K_months) * 21
    koala = _last_n_trade_days(lion, shark)
    if len(koala) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor1053')
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    dolphin = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    wolf = (pd.to_datetime(koala[-1]) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    panda = list(universe)
    giraffe = []
    for rabbit in range(0, len(panda), int(chunk_size)):
        dog = panda[rabbit:rabbit + int(chunk_size)]
        otter = get_price(dog, start_date=dolphin, end_date=wolf, frequency='daily', fields=['money'], fq='post', panel=False)
        if otter is None or otter.empty:
            continue
        otter = otter.copy()
        if 'time' not in otter.columns:
            otter = otter.reset_index()
        if 'code' not in otter.columns:
            if len(dog) == 1:
                otter['code'] = dog[0]
            else:
                continue
        otter['date'] = pd.to_datetime(otter['time']).dt.date
        giraffe.append(otter[['date', 'code', 'money']])
    if not giraffe:
        return _make_factor_series({}, date, universe=universe, name='factor1053')
    fox = pd.concat(giraffe, ignore_index=True)
    fox['money'] = pd.to_numeric(fox['money'], errors='coerce').astype(float)
    fox = fox[np.isfinite(fox['money'].values)]
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1053')
    zebra = fox.groupby('code', sort=False)['money'].std(ddof=1)
    bear = {cat: float(whale) for cat, whale in zebra.items() if np.isfinite(whale)}
    return _make_factor_series(bear, date, universe=universe, name='factor1053')

def factor1054(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1054')

def factor1055(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    koala = list(universe)
    dolphin = 1e-06
    rabbit = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(koala)), date=fox)
    wolf = get_fundamentals(query(fox.code, fox.total_owner_equities, fox.term_084, fox.term_081).filter(fox.code.in_(koala)), date=fox)
    bear = get_history_fundamentals(security=koala, fields=[bear.term_052], watch_date=fox, count=4, interval='1q', stat_by_year=False)
    if rabbit is None or rabbit.empty or wolf is None or wolf.empty or (bear is None) or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1055')
    rabbit = rabbit[['code', 'term_045']].drop_duplicates('code').set_index('code')
    wolf = wolf[['code', 'total_owner_equities', 'term_084', 'term_081']].drop_duplicates('code').set_index('code')
    bear = bear.copy()
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    bear = bear.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'])
    lizard = bear.groupby('code', sort=False)['term_052'].apply(lambda s: float(pd.to_numeric(s, errors='coerce').tail(4).sum()))
    tuna = []
    for lion in koala:
        turtle = float(rabbit.at[lion, 'term_045']) if lion in rabbit.index and pd.notna(rabbit.at[lion, 'term_045']) else np.nan
        if not np.isfinite(turtle) or turtle <= 0:
            continue
        if lion not in wolf.index:
            continue
        whale = float(wolf.at[lion, 'total_owner_equities']) if pd.notna(wolf.at[lion, 'total_owner_equities']) else np.nan
        lemur = float(wolf.at[lion, 'term_084']) if pd.notna(wolf.at[lion, 'term_084']) else np.nan
        alpaca = float(wolf.at[lion, 'term_081']) if pd.notna(wolf.at[lion, 'term_081']) else np.nan
        if not (np.isfinite(whale) and whale > 0 and np.isfinite(alpaca) and (alpaca > 0) and np.isfinite(lemur)):
            continue
        cat = float(lizard.get(lion, np.nan))
        if not np.isfinite(cat):
            continue
        hawk = math.log(turtle)
        sparrow = math.log(whale)
        owl = math.log(max(abs(cat), dolphin))
        giraffe = 1.0 if cat < 0 else 0.0
        eagle = lemur / alpaca
        tuna.append((lion, hawk, sparrow, owl, giraffe * owl, eagle))
    if len(tuna) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor1055')
    otter = [frog[0] for frog in tuna]
    badger = np.array([frog[1] for frog in tuna], dtype=float)
    dog = np.column_stack([np.ones(len(tuna), dtype=float), np.array([frog[2] for frog in tuna], dtype=float), np.array([frog[3] for frog in tuna], dtype=float), np.array([frog[4] for frog in tuna], dtype=float), np.array([frog[5] for frog in tuna], dtype=float)])
    try:
        tiger, panda, panda, panda = np.linalg.lstsq(dog, badger, rcond=None)
    except Exception:
        return _make_factor_series({}, date, universe=universe, name='factor1055')
    salmon = badger - dog.dot(tiger)
    shark = {lion: float(zebra) for lion, zebra in zip(otter, salmon) if np.isfinite(zebra)}
    return _make_factor_series(shark, date, universe=universe, name='factor1055')

def factor1056(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    otter = pd.Period(fox, freq='M')
    whale = otter - 1
    hawk = [whale - dolphin for dolphin in range(11, -1, -1)]
    bear = hawk[0]
    shark = hawk[-1]
    salmon = dt.date(bear.year, bear.month, 1) - dt.timedelta(days=10)
    rabbit = shark.to_timestamp('M').date()
    wolf = get_price(security=list(universe), start_date=salmon, end_date=rabbit, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1056')
    wolf = wolf.copy()
    wolf['time'] = pd.to_datetime(wolf['time'])
    wolf = wolf.sort_values(['code', 'time'])
    wolf['month'] = wolf['time'].dt.to_period('M')
    wolf['close_prev'] = wolf.groupby('code', sort=False)['close'].shift(1)
    sparrow = pd.to_numeric(wolf['open'], errors='coerce').astype(float)
    tiger = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
    lion = pd.to_numeric(wolf['close_prev'], errors='coerce').astype(float)
    alpaca = (lion > 0) & (sparrow > 0) & np.isfinite(lion) & np.isfinite(sparrow) & np.isfinite(tiger)
    lizard = np.where(alpaca, sparrow / lion - 1.0, np.nan)
    frog = np.where(alpaca, tiger / sparrow - 1.0, np.nan)
    dog = np.where(np.isfinite(lizard) & np.isfinite(frog) & (lizard < 0) & (frog > 0), 1.0, np.nan)
    wolf['I'] = dog
    turtle = wolf.groupby(['code', 'month'], sort=False)['I'].mean()
    giraffe = {}
    for koala in universe:
        panda = []
        for owl in hawk:
            tuna = turtle.get((koala, owl), np.nan)
            panda.append(float(tuna) if np.isfinite(tuna) else np.nan)
        panda = np.asarray(panda, dtype=float)
        if not np.isfinite(panda[-1]):
            continue
        zebra = panda[np.isfinite(panda)]
        if zebra.size < 2:
            continue
        eagle = float(zebra.mean())
        if eagle == 0 or not np.isfinite(eagle):
            continue
        cat = float(panda[-1] / eagle)
        if np.isfinite(cat):
            giraffe[koala] = cat
    return _make_factor_series(giraffe, date, universe=universe, name='factor1056')

def factor1057(universe, date, delta=0.94, max_months=60):
    _set_asof_date(date)
    koala = _to_date(date)
    lion = pd.Period(koala, freq='M')
    zebra = lion - 1
    bear = zebra - (max_months - 1)
    lizard = dt.date(bear.year, bear.month, 1) - dt.timedelta(days=5)
    fox = zebra.to_timestamp('M').date()
    otter = get_price(security=list(universe), start_date=lizard, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1057')
    otter = otter.copy()
    otter['time'] = pd.to_datetime(otter['time'])
    otter = otter.sort_values(['code', 'time'])
    otter['month'] = otter['time'].dt.to_period('M')
    dolphin = otter.groupby(['code', 'month'], sort=False).tail(1)
    dolphin = dolphin[['code', 'month', 'time', 'close']].sort_values(['code', 'month'])
    dolphin['close'] = pd.to_numeric(dolphin['close'], errors='coerce').astype(float)
    wolf = {}
    for tiger, rabbit in dolphin.groupby('code', sort=False):
        rabbit = rabbit.dropna(subset=['close'])
        if rabbit.shape[0] < 24:
            continue
        rabbit = rabbit[rabbit['month'] <= zebra]
        if rabbit.shape[0] < 24:
            continue
        panda = rabbit['close'].values.astype(float)
        shark = rabbit['month'].values
        hawk = panda[1:] / panda[:-1] - 1.0
        whale = shark[1:]
        if hawk.size < 24:
            continue
        if zebra not in set(whale):
            continue
        sparrow = hawk.astype(float)
        eagle = sparrow.size
        dog = np.zeros(eagle, dtype=float)
        alpaca = np.zeros(eagle, dtype=float)
        dog[0] = sparrow[0]
        alpaca[0] = sparrow[0] ** 2
        for frog in range(1, eagle):
            dog[frog] = (1 - delta) * sparrow[frog] + delta * dog[frog - 1]
            alpaca[frog] = (1 - delta) * (sparrow[frog - 1] - dog[frog - 1]) ** 2 + delta * alpaca[frog - 1]
        giraffe = sparrow - dog
        salmon = int(np.where(whale == zebra)[0][-1])
        if salmon < 12:
            continue
        cat = float(np.mean(giraffe[salmon - 12:salmon]))
        owl = 1.0 if cat > 0 else -1.0 if cat < 0 else 0.0
        turtle = math.sqrt(alpaca[salmon]) if alpaca[salmon] > 0 else np.nan
        if not np.isfinite(turtle) or turtle == 0:
            continue
        tuna = float(owl * (giraffe[salmon] / turtle))
        if np.isfinite(tuna):
            wolf[tiger] = tuna
    return _make_factor_series(wolf, date, universe=universe, name='factor1057')

def factor1058(universe, date, freq='1m', window=20):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = _last_n_trade_days(bear, window)
    rabbit = [pd.to_datetime(fox).date() for fox in rabbit]
    if len(rabbit) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1058')
    zebra = {koala: [] for koala in universe}
    owl = {koala: [] for koala in universe}
    for wolf in rabbit:
        giraffe = get_price(security=list(universe), start_date=wolf, end_date=wolf + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        giraffe['time'] = pd.to_datetime(giraffe['time'])
        giraffe = giraffe.sort_values(['code', 'time'])
        giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
        for koala, shark in giraffe.groupby('code', sort=False):
            sparrow = shark['close'].values.astype(float)
            if sparrow.size < 5:
                continue
            eagle = np.isfinite(sparrow) & (sparrow > 0)
            if eagle.sum() < 5:
                continue
            sparrow = sparrow[eagle]
            if sparrow.size < 5:
                continue
            lizard = sparrow[1:] / sparrow[:-1] - 1.0
            if lizard.size < 3:
                continue
            hawk = float(np.median(lizard))
            dog = np.abs(lizard - hawk)
            lemur = int(np.argmax(dog))
            if lemur == 0:
                continue
            frog = float(lizard[lemur])
            salmon = float(lizard[lemur - 1])
            if np.isfinite(frog) and np.isfinite(salmon):
                zebra[koala].append(frog)
                owl[koala].append(salmon)
    panda = {lion: float(np.mean(badger)) for lion, badger in zebra.items() if len(badger) > 0}
    tiger = {lion: float(np.mean(badger)) for lion, badger in owl.items() if len(badger) > 0}
    otter = sorted(set(panda.keys()) & set(tiger.keys()))
    if len(otter) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1058')
    dolphin = pd.Series({lion: panda[lion] for lion in otter}, dtype=float)
    turtle = pd.Series({lion: tiger[lion] for lion in otter}, dtype=float)
    tuna = dolphin.rank(ascending=False, method='average')
    alpaca = turtle.rank(ascending=False, method='average')
    cat = tuna + alpaca
    whale = {lion: float(cat[lion]) for lion in otter if np.isfinite(cat[lion])}
    return _make_factor_series(whale, date, universe=universe, name='factor1058')

def factor1059(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1059')

def factor1060(universe, date, lag=1, freq='1m'):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = get_price(security=list(universe), start_date=panda, end_date=panda + dt.timedelta(days=1), frequency=freq, fields=['money'], fq='post', panel=False)
    if tiger is None or tiger.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1060')
    tiger = tiger.copy()
    tiger['time'] = pd.to_datetime(tiger['time'])
    tiger = tiger.sort_values(['code', 'time'])
    tiger['money'] = pd.to_numeric(tiger['money'], errors='coerce').astype(float)
    lion = {}
    for dog, koala in tiger.groupby('code', sort=False):
        cat = koala['money'].values.astype(float)
        cat = cat[np.isfinite(cat)]
        if cat.size <= lag + 2:
            continue
        rabbit = cat[:-lag]
        giraffe = cat[lag:]
        otter = np.isfinite(rabbit) & np.isfinite(giraffe)
        rabbit = rabbit[otter]
        giraffe = giraffe[otter]
        if rabbit.size < 5:
            continue
        wolf = float(np.std(rabbit, ddof=1))
        bear = float(np.std(giraffe, ddof=1))
        if wolf == 0 or bear == 0 or (not np.isfinite(wolf)) or (not np.isfinite(bear)):
            continue
        fox = float(np.corrcoef(rabbit, giraffe)[0, 1])
        if np.isfinite(fox):
            lion[dog] = fox
    return _make_factor_series(lion, date, universe=universe, name='factor1060')

def factor1061(universe, date):
    _set_asof_date(date)
    giraffe = _to_date(date)
    bear = list(universe)
    owl = 5
    whale = get_history_fundamentals(security=bear, fields=[bear.term_066, bear.term_060], watch_date=giraffe, count=owl, interval='1q', stat_by_year=False)
    dolphin = get_history_fundamentals(security=bear, fields=[wolf.term_028], watch_date=giraffe, count=owl, interval='1q', stat_by_year=False)
    zebra = get_history_fundamentals(security=bear, fields=[fox.term_081], watch_date=giraffe, count=owl, interval='1q', stat_by_year=False)
    if whale is None or whale.empty or dolphin is None or dolphin.empty or (zebra is None) or zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1061')
    whale = whale.copy()
    dolphin = dolphin.copy()
    zebra = zebra.copy()
    for shark in (whale, dolphin, zebra):
        shark['statDate'] = pd.to_datetime(shark['statDate'])
        shark = shark.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        if shark is whale:
            whale = shark
        elif shark is dolphin:
            dolphin = shark
        else:
            zebra = shark
    sparrow = whale.merge(dolphin, on=['code', 'statDate'], how='inner').merge(zebra, on=['code', 'statDate'], how='inner')
    if sparrow.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1061')
    sparrow = sparrow.sort_values(['code', 'statDate'])
    eagle = {}
    for wolf, hawk in sparrow.groupby('code', sort=False):
        hawk = hawk.tail(owl)
        if hawk.shape[0] < owl:
            continue
        turtle = pd.to_numeric(hawk['term_066'], errors='coerce').astype(float).values
        rabbit = pd.to_numeric(hawk['term_060'], errors='coerce').astype(float).values
        fox = pd.to_numeric(hawk['term_028'], errors='coerce').astype(float).values
        lizard = pd.to_numeric(hawk['term_081'], errors='coerce').astype(float).values
        if np.any(~np.isfinite(turtle)) or np.any(~np.isfinite(rabbit)) or np.any(~np.isfinite(fox)) or np.any(~np.isfinite(lizard)):
            continue
        panda = turtle - rabbit
        lion = float(panda[-1])
        tiger = float(panda[0])
        dog = float(fox[-1])
        cat = float(fox[0])
        otter = float(lizard[-1])
        if not (np.isfinite(lion) and np.isfinite(tiger) and np.isfinite(dog) and np.isfinite(cat) and np.isfinite(otter)):
            continue
        if otter <= 0 or cat == 0:
            continue
        koala = dog / cat
        frog = (lion - tiger * koala) / otter
        if np.isfinite(frog):
            eagle[str(wolf)] = float(frog)
    return _make_factor_series(eagle, date, universe=universe, name='factor1061')

def factor1062(universe, date, freq='1m', hp_lambda=1600.0):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = get_price(security=list(universe), start_date=otter, end_date=otter + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1062')
    fox = fox.copy()
    fox['time'] = pd.to_datetime(fox['time'])
    fox = fox.sort_values(['code', 'time'])
    fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
    wolf = {}
    for koala, rabbit in fox.groupby('code', sort=False):
        lion = rabbit['close'].values.astype(float)
        lion = lion[np.isfinite(lion) & (lion > 0)]
        if lion.size < 16:
            continue
        dolphin = np.log(lion.astype(float))
        try:
            shark, eagle = _hp_filter(dolphin, hp_lambda)
        except np.linalg.LinAlgError:
            continue
        cat = eagle.size
        if cat < 8:
            continue
        panda = np.fft.fft(eagle)
        tiger = np.abs(panda) / cat
        whale = cat // 2
        if whale <= 1:
            continue
        giraffe = np.arange(1, whale + 1)
        bear = giraffe / float(cat)
        zebra = tiger[1:whale + 1]
        dog = float((2.0 * (zebra * bear)).mean())
        if np.isfinite(dog):
            wolf[koala] = dog
    return _make_factor_series(wolf, date, universe=universe, name='factor1062')

def factor1063(universe, date, L=250, alpha=0.95):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, L + 1)
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    if len(koala) < L + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1063')
    zebra = koala[0]
    fox = koala[-1]
    otter = get_price(security=list(universe), start_date=zebra, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1063')
    otter = otter.copy()
    otter['time'] = pd.to_datetime(otter['time'])
    otter = otter.sort_values(['code', 'time'])
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
    wolf = {}
    for panda, bear in otter.groupby('code', sort=False):
        dog = bear['close'].values.astype(float)
        dog = dog[np.isfinite(dog) & (dog > 0)]
        if dog.size < L + 1:
            continue
        rabbit = np.log(dog[1:] / dog[:-1])
        rabbit = rabbit[np.isfinite(rabbit)]
        if rabbit.size < L:
            continue
        giraffe = rabbit[-L:]
        cat = -float(np.quantile(giraffe, alpha))
        if np.isfinite(cat):
            wolf[panda] = cat
    return _make_factor_series(wolf, date, universe=universe, name='factor1063')

def factor1064(universe, date, T=20):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = _last_n_trade_days(panda, T)
    tiger = [pd.to_datetime(dog).date() for dog in tiger]
    if len(tiger) == 0:
        return _make_factor_series({}, date, universe=universe, name='factor1064')
    zebra = tiger[0]
    koala = tiger[-1]
    lion = get_money_flow_pro(security_list=list(universe), start_date=zebra.strftime('%Y-%m-%d'), end_date=koala.strftime('%Y-%m-%d'), frequency='daily', fields=['inflow_s', 'outflow_s'], data_type='money')
    if lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1064')
    lion = lion.copy()
    if 'time' in lion.columns:
        lion['time'] = pd.to_datetime(lion['time'])
    elif 'date' in lion.columns:
        lion['time'] = pd.to_datetime(lion['date'])
    lion = lion.sort_values(['code', 'time'])
    wolf = pd.to_numeric(lion['inflow_s'], errors='coerce').astype(float)
    bear = pd.to_numeric(lion['outflow_s'], errors='coerce').astype(float)
    giraffe = wolf + bear
    rabbit = np.where(np.isfinite(giraffe) & (giraffe > 0) & np.isfinite(wolf), wolf / giraffe, 0.0)
    lion['sbar'] = rabbit
    otter = {}
    for cat, fox in lion.groupby('code', sort=False):
        dolphin = fox['sbar'].values.astype(float)
        dolphin = dolphin[np.isfinite(dolphin)]
        if dolphin.size == 0:
            continue
        otter[cat] = float(np.mean(dolphin))
    return _make_factor_series(otter, date, universe=universe, name='factor1064')

def factor1065(universe, date, freq='1m'):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = get_price(security=list(universe), start_date=koala, end_date=koala + dt.timedelta(days=1), frequency=freq, fields=['close', 'money'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1065')
    otter = otter.copy()
    otter['time'] = pd.to_datetime(otter['time'])
    otter = otter.sort_values(['code', 'time'])
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
    otter['money'] = pd.to_numeric(otter['money'], errors='coerce').astype(float)
    fox = {}
    for lion, wolf in otter.groupby('code', sort=False):
        tiger = wolf['close'].values.astype(float)
        panda = wolf['money'].values.astype(float)
        rabbit = np.isfinite(tiger) & (tiger > 0) & np.isfinite(panda)
        tiger = tiger[rabbit]
        panda = panda[rabbit]
        if tiger.size < 3:
            continue
        zebra = tiger[1:] / tiger[:-1] - 1.0
        dog = np.abs(zebra)
        cat = panda[1:]
        giraffe = min(dog.size, cat.size)
        dog = dog[:giraffe]
        cat = cat[:giraffe]
        bear = np.isfinite(dog) & np.isfinite(cat)
        eagle = dog[bear]
        hawk = cat[bear]
        if eagle.size < 5:
            continue
        whale = float(np.std(eagle, ddof=1))
        shark = float(np.std(hawk, ddof=1))
        if whale == 0 or shark == 0 or (not np.isfinite(whale)) or (not np.isfinite(shark)):
            continue
        dolphin = float(np.corrcoef(eagle, hawk)[0, 1])
        if np.isfinite(dolphin):
            fox[lion] = dolphin
    return _make_factor_series(fox, date, universe=universe, name='factor1065')

def factor1066(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1066')

def factor1067(universe, date, alpha=0.1, D=20, freq='5m'):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = _last_n_trade_days(bear, D)
    rabbit = [pd.to_datetime(fox).date() for fox in rabbit]
    if len(rabbit) == 0:
        return _make_factor_series({}, date, universe=universe, name='factor1067')
    owl = {dog: [] for dog in universe}
    for wolf in rabbit:
        giraffe = get_price(security=list(universe), start_date=wolf, end_date=wolf + dt.timedelta(days=1), frequency=freq, fields=['open', 'high', 'low', 'close', 'volume'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        giraffe['time'] = pd.to_datetime(giraffe['time'])
        giraffe = giraffe.sort_values(['code', 'time'])
        for lion in ['open', 'high', 'low', 'close', 'volume']:
            giraffe[lion] = pd.to_numeric(giraffe[lion], errors='coerce').astype(float)
        for tiger, dolphin in giraffe.groupby('code', sort=False):
            if dolphin.shape[0] == 0:
                continue
            hawk = dolphin['open'].values
            whale = dolphin['high'].values
            shark = dolphin['low'].values
            panda = dolphin['close'].values
            frog = dolphin['volume'].values
            eagle = np.isfinite(hawk) & np.isfinite(whale) & np.isfinite(shark) & np.isfinite(panda) & np.isfinite(frog)
            if eagle.sum() < 5:
                continue
            hawk, whale, shark, panda, frog = (hawk[eagle], whale[eagle], shark[eagle], panda[eagle], frog[eagle])
            cat = np.abs(panda - hawk)
            turtle = np.abs(whale - shark)
            koala = (panda < hawk) & (turtle > 0) & (cat <= alpha * turtle)
            otter = float(frog[koala].sum())
            salmon = float(frog.sum())
            if salmon <= 0:
                continue
            sparrow = otter / salmon
            if np.isfinite(sparrow):
                owl[tiger].append(sparrow)
    zebra = {dog: float(np.mean(lizard)) for dog, lizard in owl.items() if len(lizard) > 0}
    return _make_factor_series(zebra, date, universe=universe, name='factor1067')

def factor1068(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    tiger = 8
    koala = get_history_fundamentals(security=list(universe), fields=[bear.term_052], watch_date=lion, count=tiger, interval='1q', stat_by_year=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1068')
    koala = koala.copy()
    koala['statDate'] = pd.to_datetime(koala['statDate'])
    koala = koala.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'])
    otter = {}
    for panda, fox in koala.groupby('code', sort=False):
        fox = fox.tail(5)
        if fox.shape[0] < 5:
            continue
        wolf = pd.to_numeric(fox['term_052'], errors='coerce').astype(float).values
        dog = wolf[-1]
        cat = wolf[0]
        if not np.isfinite(cat) or cat == 0 or (not np.isfinite(dog)):
            continue
        bear = float((dog - cat) / abs(cat))
        if np.isfinite(bear):
            otter[panda] = bear
    return _make_factor_series(otter, date, universe=universe, name='factor1068')

def factor1069(universe, date, index_symbol='000905.XSHG', freq='5m'):
    _set_asof_date(date)
    panda = _to_date(date)
    rabbit = _get_intraday_close_series(index_symbol, panda, freq=freq)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1069')
    rabbit = pd.to_numeric(rabbit.sort_index(), errors='coerce').astype(float)
    rabbit = rabbit[np.isfinite(rabbit) & (rabbit > 0)]
    if rabbit.size < 2:
        return _make_factor_series({}, date, universe=universe, name='factor1069')
    koala = rabbit.pct_change().dropna()
    if koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1069')
    wolf = koala.clip(lower=0.0)
    wolf = wolf[~wolf.index.duplicated(keep='last')].sort_index()
    lion = get_price(security=list(universe), start_date=panda, end_date=panda + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1069')
    lion = lion.copy()
    if 'time' not in lion.columns:
        if isinstance(lion.index, pd.DatetimeIndex):
            giraffe = lion.index.name if lion.index.name else 'time'
            lion = lion.reset_index().rename(columns={giraffe: 'time'})
        else:
            lion = lion.reset_index().rename(columns={'index': 'time'})
    if 'code' not in lion.columns:
        lion['code'] = list(universe)[0] if len(universe) > 0 else ''
    lion['time'] = pd.to_datetime(lion['time'])
    lion = lion.sort_values(['code', 'time'])
    lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
    lion = lion[np.isfinite(lion['close']) & (lion['close'] > 0)]
    lion['r'] = lion.groupby('code', sort=False)['close'].pct_change()
    lion['fpos'] = wolf.reindex(lion['time']).values
    otter = {}
    for dog, bear in lion.groupby('code', sort=False):
        dolphin = pd.to_numeric(bear['r'], errors='coerce').astype(float).values
        fox = pd.to_numeric(bear['fpos'], errors='coerce').astype(float).values
        zebra = np.isfinite(dolphin) & np.isfinite(fox)
        if zebra.sum() < 5:
            continue
        dolphin = dolphin[zebra]
        fox = fox[zebra]
        whale = np.minimum(dolphin, 0.0)
        tiger = float(np.sum(fox ** 2))
        if tiger <= 0 or not np.isfinite(tiger):
            continue
        cat = float(np.sum(whale * fox) / tiger)
        if np.isfinite(cat):
            otter[dog] = cat
    return _make_factor_series(otter, date, universe=universe, name='factor1069')

def factor1070(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    dog = 8
    tiger = get_history_fundamentals(security=list(universe), fields=[rabbit.eps], watch_date=panda, count=dog, interval='1q', stat_by_year=False)
    if tiger is None or tiger.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1070')
    tiger = tiger.copy()
    tiger['statDate'] = pd.to_datetime(tiger['statDate'])
    tiger = tiger.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'])
    koala = {}
    for cat, otter in tiger.groupby('code', sort=False):
        otter = otter.tail(8)
        if otter.shape[0] < 8:
            continue
        lion = pd.to_numeric(otter['eps'], errors='coerce').astype(float).values
        if np.isfinite(lion).sum() < 8:
            continue
        bear = np.array([lion[fox] - lion[fox - 4] for fox in range(4, 8)], dtype=float)
        wolf = float(np.std(bear, ddof=1))
        if wolf <= 0 or not np.isfinite(wolf):
            continue
        rabbit = float(bear[-1] / wolf)
        if np.isfinite(rabbit):
            koala[cat] = rabbit
    return _make_factor_series(koala, date, universe=universe, name='factor1070')

def factor1071(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1071')

def factor1072(universe, date):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = pd.to_datetime(panda).strftime('%Y-%m-%d')
    zebra = ['term_053', 'asset_impairment_loss_ttm', 'term_073', 'term_014']
    try:
        giraffe = get_factor_values(list(universe), zebra, start_date=tiger, end_date=tiger)
    except Exception:
        giraffe = {}
    whale = pd.DataFrame(index=list(universe), columns=zebra, dtype=float)
    if isinstance(giraffe, dict):
        for rabbit in zebra:
            lion = giraffe.get(rabbit, None)
            if isinstance(lion, pd.DataFrame) and (not lion.empty):
                owl = lion.iloc[0]
                whale[rabbit] = pd.to_numeric(owl.reindex(whale.index), errors='coerce').astype(float)
    wolf = whale.sum(axis=1, min_count=1)
    bear = {cat: float(turtle) for cat, turtle in wolf.items() if np.isfinite(turtle)}
    hawk = [cat for cat in universe if cat not in bear]
    if hawk:
        koala = get_history_fundamentals(security=hawk, fields=[bear.term_052], watch_date=panda, count=4, interval='1q', stat_by_year=False)
        if koala is not None and (not koala.empty):
            koala = koala.copy()
            koala['statDate'] = pd.to_datetime(koala['statDate'])
            koala = koala.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'])
            sparrow = koala.groupby('code', sort=False)['term_052'].apply(lambda s: float(pd.to_numeric(s, errors='coerce').tail(4).sum()))
            for cat in hawk:
                turtle = float(sparrow.get(cat, np.nan))
                if np.isfinite(turtle):
                    bear[cat] = turtle
    if not bear:
        return _make_factor_series({}, date, universe=universe, name='factor1072')
    otter = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(list(universe))), date=panda)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1072')
    eagle = dict(zip(otter['code'], otter['term_045']))
    dolphin = {}
    for dog, fox in bear.items():
        shark = float(eagle.get(dog, np.nan))
        if not np.isfinite(shark) or shark <= 0:
            continue
        lizard = float(fox / shark)
        if np.isfinite(lizard):
            dolphin[dog] = lizard
    return _make_factor_series(dolphin, date, universe=universe, name='factor1072')

def factor1073(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1073')

def factor1074(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    tiger = 8
    fox = get_history_fundamentals(security=universe, fields=[fox.term_084], watch_date=lion, count=tiger, interval='1q', stat_by_year=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1074')
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    wolf = {}
    for panda in universe:
        otter = fox[fox['code'] == panda].copy()
        if otter.shape[0] < 5:
            continue
        otter = otter.sort_values('statDate').drop_duplicates('statDate')
        if otter.shape[0] < 5:
            continue
        koala = otter['term_084'].astype(float).values
        dog = koala[-1]
        cat = koala[-5]
        if dog <= 0 or cat <= 0:
            continue
        bear = math.log(dog) - math.log(cat)
        if np.isfinite(bear):
            wolf[panda] = float(bear)
    return _make_factor_series(wolf, date, universe=universe, name='factor1074')

def factor1075(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1075')

def factor1076(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1076')

def factor1077(universe, date):
    _set_asof_date(date)
    bear = _to_date(date)
    wolf = list(universe)
    eagle = 5
    rabbit = get_history_fundamentals(security=wolf, fields=[fox.advance_peceipts, fox.term_081], watch_date=bear, count=eagle, interval='1q', stat_by_year=False)
    giraffe = get_history_fundamentals(security=wolf, fields=[wolf.term_028], watch_date=bear, count=eagle, interval='1q', stat_by_year=False)
    if rabbit is None or rabbit.empty or giraffe is None or giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1077')
    rabbit = rabbit.copy()
    giraffe = giraffe.copy()
    for zebra in (rabbit, giraffe):
        zebra['statDate'] = pd.to_datetime(zebra['statDate'])
        zebra = zebra.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        if zebra is rabbit:
            rabbit = zebra
        else:
            giraffe = zebra
    shark = rabbit.merge(giraffe, on=['code', 'statDate'], how='inner')
    if shark.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1077')
    shark = shark.sort_values(['code', 'statDate'])
    dolphin = {}
    for fox, whale in shark.groupby('code', sort=False):
        whale = whale.tail(eagle)
        if whale.shape[0] < eagle:
            continue
        hawk = pd.to_numeric(whale['advance_peceipts'], errors='coerce').astype(float).values
        sparrow = pd.to_numeric(whale['term_081'], errors='coerce').astype(float).values
        otter = pd.to_numeric(whale['term_028'], errors='coerce').astype(float).values
        if np.any(~np.isfinite(hawk)) or np.any(~np.isfinite(sparrow)) or np.any(~np.isfinite(otter)):
            continue
        lion = float(hawk[-1])
        tiger = float(hawk[0])
        dog = float(otter[-1])
        cat = float(otter[0])
        koala = float(sparrow[-1])
        if koala <= 0 or cat == 0:
            continue
        panda = dog / cat
        owl = (lion - tiger * panda) / koala
        if np.isfinite(owl):
            dolphin[str(fox)] = float(owl)
    return _make_factor_series(dolphin, date, universe=universe, name='factor1077')

def factor1078(universe, date, index_symbol='000905.XSHG', freq='5m'):
    _set_asof_date(date)
    panda = _to_date(date)
    rabbit = _get_intraday_close_series(index_symbol, panda, freq=freq)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1078')
    rabbit = pd.to_numeric(rabbit.sort_index(), errors='coerce').astype(float)
    rabbit = rabbit[np.isfinite(rabbit) & (rabbit > 0)]
    if rabbit.size < 2:
        return _make_factor_series({}, date, universe=universe, name='factor1078')
    koala = rabbit.pct_change().dropna()
    if koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1078')
    wolf = koala.clip(upper=0.0)
    wolf = wolf[~wolf.index.duplicated(keep='last')].sort_index()
    lion = get_price(security=list(universe), start_date=panda, end_date=panda + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1078')
    lion = lion.copy()
    if 'time' not in lion.columns:
        if isinstance(lion.index, pd.DatetimeIndex):
            giraffe = lion.index.name if lion.index.name else 'time'
            lion = lion.reset_index().rename(columns={giraffe: 'time'})
        else:
            lion = lion.reset_index().rename(columns={'index': 'time'})
    if 'code' not in lion.columns:
        lion['code'] = list(universe)[0] if len(universe) > 0 else ''
    lion['time'] = pd.to_datetime(lion['time'])
    lion = lion.sort_values(['code', 'time'])
    lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
    lion = lion[np.isfinite(lion['close']) & (lion['close'] > 0)]
    lion['r'] = lion.groupby('code', sort=False)['close'].pct_change()
    lion['fneg'] = wolf.reindex(lion['time']).values
    otter = {}
    for dog, bear in lion.groupby('code', sort=False):
        dolphin = pd.to_numeric(bear['r'], errors='coerce').astype(float).values
        fox = pd.to_numeric(bear['fneg'], errors='coerce').astype(float).values
        zebra = np.isfinite(dolphin) & np.isfinite(fox)
        if zebra.sum() < 5:
            continue
        dolphin = dolphin[zebra]
        fox = fox[zebra]
        whale = np.minimum(dolphin, 0.0)
        tiger = float(np.sum(fox ** 2))
        if tiger <= 0 or not np.isfinite(tiger):
            continue
        cat = float(np.sum(whale * fox) / tiger)
        if np.isfinite(cat):
            otter[dog] = cat
    return _make_factor_series(otter, date, universe=universe, name='factor1078')

def factor1079(universe, date, index_symbol='000905.XSHG', window_days=500, tail_frac=0.05):
    _set_asof_date(date)
    shark = _to_date(date)
    eagle = _last_n_trade_days(shark, window_days + 1)
    eagle = [pd.to_datetime(whale).date() for whale in eagle]
    if len(eagle) < 200:
        return _make_factor_series({}, date, universe=universe, name='factor1079')
    penguin = eagle[0]
    turtle = eagle[-1]
    octopus = [index_symbol] + [giraffe for giraffe in universe if giraffe != index_symbol]
    hawk = get_price(security=octopus, start_date=penguin, end_date=turtle, frequency='daily', fields=['close'], fq='post', panel=False)
    if hawk is None or hawk.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1079')
    hawk = hawk.copy()
    hawk['time'] = pd.to_datetime(hawk['time'])
    hawk = hawk.sort_values(['code', 'time'])
    hawk['close'] = pd.to_numeric(hawk['close'], errors='coerce').astype(float)
    sparrow = hawk[hawk['code'] == index_symbol]
    beaver = sparrow['close'].values.astype(float)
    gecko = sparrow['time'].values
    iguana = np.isfinite(beaver) & (beaver > 0)
    beaver = beaver[iguana]
    gecko = gecko[iguana]
    if beaver.size < 100:
        return _make_factor_series({}, date, universe=universe, name='factor1079')
    donkey = beaver[1:] / beaver[:-1] - 1.0
    camel = pd.to_datetime(gecko[1:]).normalize()
    ferret = pd.Series(donkey.astype(float), index=camel).dropna()
    koala = -ferret.values
    koala = koala[np.isfinite(koala)]
    koala = koala[koala > 0]
    kangaroo = koala.size
    if kangaroo < 50:
        return _make_factor_series({}, date, universe=universe, name='factor1079')
    tuna = max(int(tail_frac * kangaroo), 5)
    if tuna >= kangaroo:
        tuna = kangaroo - 1
    wolf = np.sort(koala)
    panda = float(wolf[-tuna])
    if panda <= 0 or not np.isfinite(panda):
        return _make_factor_series({}, date, universe=universe, name='factor1079')
    badger = np.log(wolf[-tuna:])
    lemur = math.log(panda)
    bear = float(np.mean(badger - lemur))
    if bear <= 0 or not np.isfinite(bear):
        return _make_factor_series({}, date, universe=universe, name='factor1079')
    rabbit = 1.0 / bear
    lizard = {}
    owl = hawk[hawk['code'] != index_symbol]
    for zebra, frog in owl.groupby('code', sort=False):
        giraffe = frog['close'].values.astype(float)
        quail = pd.to_datetime(frog['time']).dt.normalize().values
        hyena = np.isfinite(giraffe) & (giraffe > 0)
        giraffe = giraffe[hyena]
        quail = quail[hyena]
        if giraffe.size < 100:
            continue
        mole = giraffe[1:] / giraffe[:-1] - 1.0
        whale = pd.to_datetime(quail[1:]).normalize()
        narwhal = pd.Series(mole.astype(float), index=whale).dropna()
        dolphin = ferret.index.intersection(narwhal.index)
        if dolphin.size < 100:
            continue
        tiger = -narwhal.reindex(dolphin).values.astype(float)
        otter = -ferret.reindex(dolphin).values.astype(float)
        jaguar = (tiger > 0) & (otter > 0) & np.isfinite(tiger) & np.isfinite(otter)
        tiger = tiger[jaguar]
        fox = otter[jaguar]
        llama = tiger.size
        if llama < 50:
            continue
        alpaca = max(int(tail_frac * llama), 5)
        if alpaca >= llama:
            alpaca = llama - 1
        lion = np.sort(tiger)
        dog = float(lion[-alpaca])
        if dog <= 0 or not np.isfinite(dog):
            continue
        salmon = (tiger > dog) & (fox > panda)
        raccoon = float(salmon.sum()) / float(alpaca)
        if not np.isfinite(raccoon):
            continue
        cat = float(raccoon * (dog / panda) ** (1.0 / rabbit))
        if np.isfinite(cat):
            lizard[zebra] = cat
    return _make_factor_series(lizard, date, universe=universe, name='factor1079')

def factor1080(universe, date, T=20, freq='1m'):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, T)
    otter = [pd.to_datetime(tiger).date() for tiger in otter]
    if len(otter) == 0:
        return _make_factor_series({}, date, universe=universe, name='factor1080')
    dolphin = {dog: [] for dog in universe}
    for lion in otter:
        fox = get_price(security=list(universe), start_date=lion, end_date=lion + dt.timedelta(days=1), frequency=freq, fields=['volume'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        fox['time'] = pd.to_datetime(fox['time'])
        fox = fox.sort_values(['code', 'time'])
        fox['volume'] = pd.to_numeric(fox['volume'], errors='coerce').astype(float)
        rabbit = fox['time'].dt.hour.values
        giraffe = fox['time'].dt.minute.values
        whale = (rabbit == 14) & (giraffe >= 30) | (rabbit == 15) & (giraffe == 0)
        fox['tail'] = whale
        for panda, bear in fox.groupby('code', sort=False):
            shark = bear['volume'].values.astype(float)
            if shark.size < 5:
                continue
            shark = np.where(np.isfinite(shark), shark, 0.0)
            cat = float(np.sum(shark))
            if cat <= 0:
                continue
            eagle = float(np.sum(shark[bear['tail'].values]))
            zebra = eagle / cat
            if np.isfinite(zebra):
                dolphin[panda].append(zebra)
    wolf = {dog: float(np.mean(shark)) for dog, shark in dolphin.items() if len(shark) > 0}
    return _make_factor_series(wolf, date, universe=universe, name='factor1080')

def factor1081(universe, date, freq='1m'):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = get_price(security=list(universe), start_date=koala, end_date=koala + dt.timedelta(days=1), frequency=freq, fields=['close', 'money'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1081')
    otter = otter.copy()
    otter['time'] = pd.to_datetime(otter['time'])
    otter = otter.sort_values(['code', 'time'])
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
    otter['money'] = pd.to_numeric(otter['money'], errors='coerce').astype(float)
    fox = {}
    for lion, wolf in otter.groupby('code', sort=False):
        tiger = wolf['close'].values.astype(float)
        dog = wolf['money'].values.astype(float)
        rabbit = np.isfinite(tiger) & (tiger > 0) & np.isfinite(dog)
        tiger = tiger[rabbit]
        dog = dog[rabbit]
        if tiger.size < 4:
            continue
        zebra = tiger[1:] / tiger[:-1] - 1.0
        cat = np.abs(zebra)
        panda = dog[:-1]
        giraffe = min(cat.size, panda.size)
        cat = cat[:giraffe]
        panda = panda[:giraffe]
        bear = np.isfinite(cat) & np.isfinite(panda)
        eagle = cat[bear]
        hawk = panda[bear]
        if eagle.size < 5:
            continue
        whale = float(np.std(eagle, ddof=1))
        shark = float(np.std(hawk, ddof=1))
        if whale == 0 or shark == 0 or (not np.isfinite(whale)) or (not np.isfinite(shark)):
            continue
        dolphin = float(np.corrcoef(eagle, hawk)[0, 1])
        if np.isfinite(dolphin):
            fox[lion] = dolphin
    return _make_factor_series(fox, date, universe=universe, name='factor1081')

def factor1082(universe, date, N=9):
    _set_asof_date(date)
    lion = _to_date(date)
    eagle = N * 4
    koala = _last_n_trade_days(lion, eagle)
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    if len(koala) < N * 3:
        return _make_factor_series({}, date, universe=universe, name='factor1082')
    dolphin = koala[0]
    fox = koala[-1]
    otter = get_price(security=list(universe), start_date=dolphin, end_date=fox, frequency='daily', fields=['high', 'low'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1082')
    otter = otter.copy()
    otter['time'] = pd.to_datetime(otter['time'])
    otter = otter.sort_values(['code', 'time'])
    otter['high'] = pd.to_numeric(otter['high'], errors='coerce').astype(float)
    otter['low'] = pd.to_numeric(otter['low'], errors='coerce').astype(float)
    wolf = {}
    for panda, bear in otter.groupby('code', sort=False):
        giraffe = (bear['high'] - bear['low']).values.astype(float)
        giraffe = giraffe[np.isfinite(giraffe)]
        if giraffe.size < N * 3:
            continue
        zebra = pd.Series(giraffe)
        cat = zebra.ewm(span=N, adjust=False).mean()
        dog = cat.ewm(span=N, adjust=False).mean()
        shark = float(dog.iloc[-1])
        whale = float(cat.iloc[-1])
        if not np.isfinite(shark) or shark == 0 or (not np.isfinite(whale)):
            continue
        rabbit = float(whale / shark)
        if np.isfinite(rabbit):
            wolf[panda] = rabbit
    return _make_factor_series(wolf, date, universe=universe, name='factor1082')

def factor1083(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1083')

def factor1084(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1084')

def factor1085(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1085')

def factor1086(universe, date):
    _set_asof_date(date)
    sparrow = _to_date(date)
    eagle = list(universe)
    camel = 5
    turtle = get_history_fundamentals(security=eagle, fields=[fox.inventories, fox.term_001, fox.advance_payment, fox.term_071, fox.term_081], watch_date=sparrow, count=camel, interval='1q', stat_by_year=False)
    frog = get_history_fundamentals(security=eagle, fields=[bear.term_076, bear.term_004, bear.term_066, bear.term_060], watch_date=sparrow, count=camel, interval='1q', stat_by_year=False)
    lizard = get_history_fundamentals(security=eagle, fields=[wolf.term_028], watch_date=sparrow, count=camel, interval='1q', stat_by_year=False)
    if turtle is None or turtle.empty or frog is None or frog.empty or (lizard is None) or lizard.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1086')
    for tuna in ('df_bal', 'df_inc', 'df_cf'):
        salmon = locals()[tuna].copy()
        salmon['statDate'] = pd.to_datetime(salmon['statDate'])
        salmon = salmon.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
        locals()[tuna] = salmon
    beaver = turtle.merge(frog, on=['code', 'statDate'], how='inner').merge(lizard, on=['code', 'statDate'], how='inner')
    if beaver.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1086')
    beaver = beaver.sort_values(['code', 'statDate'])
    ferret = {'Inventories': {}, 'Receivables': {}, 'OtherRecv': {}, 'AdvRecv': {}, 'SellAdmin': {}, 'GrossProfit': {}}
    for shark, lemur in beaver.groupby('code', sort=False):
        lemur = lemur.tail(camel)
        if lemur.shape[0] < camel:
            continue
        rabbit = pd.to_numeric(lemur['term_081'], errors='coerce').astype(float).values
        tiger = pd.to_numeric(lemur['term_028'], errors='coerce').astype(float).values
        if np.any(~np.isfinite(rabbit)) or np.any(~np.isfinite(tiger)) or float(tiger[0]) == 0:
            continue
        otter = float(tiger[-1] / tiger[0])
        giraffe = float(rabbit[-1])
        if not np.isfinite(otter) or not np.isfinite(giraffe) or giraffe <= 0:
            continue
        koala = pd.to_numeric(lemur['inventories'], errors='coerce').astype(float).values
        dog = pd.to_numeric(lemur['term_001'], errors='coerce').astype(float).values
        cat = pd.to_numeric(lemur['advance_payment'], errors='coerce').astype(float).values
        fox = pd.to_numeric(lemur['term_071'], errors='coerce').astype(float).values
        hyena = pd.to_numeric(lemur['term_076'], errors='coerce').astype(float).values
        dolphin = pd.to_numeric(lemur['term_004'], errors='coerce').astype(float).values
        gecko = pd.to_numeric(lemur['term_066'], errors='coerce').astype(float).values
        hawk = pd.to_numeric(lemur['term_060'], errors='coerce').astype(float).values
        if np.any(~np.isfinite(koala)) or np.any(~np.isfinite(dog)) or np.any(~np.isfinite(cat)) or np.any(~np.isfinite(fox)) or np.any(~np.isfinite(hyena)) or np.any(~np.isfinite(dolphin)) or np.any(~np.isfinite(gecko)) or np.any(~np.isfinite(hawk)):
            continue
        wolf = dog + cat
        panda = cat
        bear = hyena + dolphin
        lion = gecko - hawk

        def raw_abn(F):
            return float((float(F[-1]) - float(F[0]) * NormalGrowth) / TA_t)
        try:
            ferret['Inventories'][str(shark)] = raw_abn(koala)
            ferret['Receivables'][str(shark)] = raw_abn(wolf)
            ferret['OtherRecv'][str(shark)] = raw_abn(fox)
            ferret['AdvRecv'][str(shark)] = raw_abn(panda)
            ferret['SellAdmin'][str(shark)] = raw_abn(bear)
            ferret['GrossProfit'][str(shark)] = raw_abn(lion)
        except Exception:
            continue
    zebra = {}
    for badger, owl in ferret.items():
        zebra[badger] = _zscore_series(pd.Series(owl, dtype=float))
    whale = set()
    for badger in zebra:
        whale |= set(zebra[badger].dropna().index.tolist())
    alpaca = {}
    for shark in whale:
        iguana = 0.0
        donkey = False
        for badger in zebra:
            jaguar = float(zebra[badger].get(shark, np.nan))
            if np.isfinite(jaguar):
                iguana += jaguar
                donkey = True
        if donkey and np.isfinite(iguana):
            alpaca[shark] = float(iguana)
    return _make_factor_series(alpaca, date, universe=universe, name='factor1086')

def factor1087(universe, date, window=20, freq='1m'):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, window)
    otter = [pd.to_datetime(panda).date() for panda in otter]
    if len(otter) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1087')
    lion = {dog: [] for dog in universe}
    for tiger in otter:
        wolf = get_fundamentals(query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(list(universe))), date=tiger)
        if wolf is None or wolf.empty:
            continue
        rabbit = dict(zip(wolf['code'], wolf['circulating_cap']))
        fox = get_price(security=list(universe), start_date=tiger, end_date=tiger + dt.timedelta(days=1), frequency=freq, fields=['volume'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        fox['time'] = pd.to_datetime(fox['time'])
        fox = fox.sort_values(['code', 'time'])
        fox['volume'] = pd.to_numeric(fox['volume'], errors='coerce').astype(float)
        for dog, giraffe in fox.groupby('code', sort=False):
            shark = float(rabbit.get(dog, np.nan))
            if not np.isfinite(shark) or shark <= 0:
                continue
            sparrow = giraffe['volume'].values.astype(float)
            sparrow = sparrow[np.isfinite(sparrow)]
            if sparrow.size < 10:
                continue
            hawk = sparrow / shark
            eagle = float(np.std(hawk, ddof=1))
            if np.isfinite(eagle):
                lion[dog].append(eagle)
    bear = {}
    for dog, zebra in lion.items():
        if len(zebra) < 5:
            continue
        cat = np.asarray(zebra, dtype=float)
        dolphin = float(np.mean(cat))
        whale = float(np.std(cat, ddof=1))
        if dolphin <= 0 or not np.isfinite(whale):
            continue
        bear[dog] = float(whale / dolphin)
    return _make_factor_series(bear, date, universe=universe, name='factor1087')

def factor1088(universe, date, K_months=3):
    _set_asof_date(date)
    lion = _to_date(date)
    cat = K_months * 21
    koala = _last_n_trade_days(lion, cat)
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    if len(koala) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor1088')
    giraffe = koala[0]
    fox = koala[-1]
    otter = get_price(security=list(universe), start_date=giraffe, end_date=fox, frequency='daily', fields=['money'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1088')
    otter = otter.copy()
    otter['time'] = pd.to_datetime(otter['time'])
    otter = otter.sort_values(['code', 'time'])
    otter['money'] = pd.to_numeric(otter['money'], errors='coerce').astype(float)
    wolf = {}
    for panda, bear in otter.groupby('code', sort=False):
        dog = bear['money'].values.astype(float)
        dog = dog[np.isfinite(dog)]
        if dog.size < 10:
            continue
        rabbit = float(np.mean(dog))
        zebra = float(np.std(dog, ddof=1))
        if zebra <= 0 or not np.isfinite(zebra):
            continue
        dolphin = float(rabbit / zebra)
        if np.isfinite(dolphin):
            wolf[panda] = dolphin
    return _make_factor_series(wolf, date, universe=universe, name='factor1088')

def factor1089(universe, date, freq='5m'):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = get_price(security=list(universe), start_date=lion, end_date=lion + dt.timedelta(days=1), frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1089')
    koala = koala.copy()
    koala['time'] = pd.to_datetime(koala['time'])
    koala = koala.sort_values(['code', 'time'])
    koala['close'] = pd.to_numeric(koala['close'], errors='coerce').astype(float)
    koala['volume'] = pd.to_numeric(koala['volume'], errors='coerce').astype(float)
    fox = {}
    for tiger, wolf in koala.groupby('code', sort=False):
        dog = wolf['close'].values.astype(float)
        zebra = wolf['volume'].values.astype(float)
        bear = np.isfinite(dog) & np.isfinite(zebra)
        if bear.sum() < 5:
            continue
        dog = dog[bear]
        zebra = zebra[bear]
        cat = float(np.sum(zebra))
        if cat <= 0 or not np.isfinite(cat):
            continue
        dolphin = zebra / cat
        panda = float(np.sum(dolphin * dog))
        otter = dog - panda
        rabbit = math.sqrt(float(np.sum(dolphin * otter ** 2)))
        if rabbit <= 0 or not np.isfinite(rabbit):
            continue
        giraffe = float(np.sum(dolphin * otter ** 3) / rabbit ** 3)
        if np.isfinite(giraffe):
            fox[tiger] = giraffe
    return _make_factor_series(fox, date, universe=universe, name='factor1089')

def factor1090(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1090')

def factor1091(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1091')

def factor1092(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1092')

def factor1093(universe, date, N=12):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, N + 1)
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    if len(koala) < N + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1093')
    giraffe = koala[0]
    fox = koala[-1]
    otter = get_price(security=list(universe), start_date=giraffe, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1093')
    otter = otter.copy()
    otter['time'] = pd.to_datetime(otter['time'])
    otter = otter.sort_values(['code', 'time'])
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
    wolf = {}
    for panda, bear in otter.groupby('code', sort=False):
        dog = bear['close'].values.astype(float)
        dog = dog[np.isfinite(dog) & (dog > 0)]
        if dog.size < N + 1:
            continue
        rabbit = dog[1:] / dog[:-1] - 1.0
        zebra = (rabbit > 0).astype(int)[-N:]
        cat = int(np.sum(zebra))
        dolphin = float(100.0 * cat / float(N))
        if np.isfinite(dolphin):
            wolf[panda] = dolphin
    return _make_factor_series(wolf, date, universe=universe, name='factor1093')

def factor1094(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1094')

def factor1095(universe, date, N=20):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = _last_n_trade_days(fox, N + 1)
    wolf = [pd.to_datetime(otter).date() for otter in wolf]
    if len(wolf) < N + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1095')
    lizard = wolf[0]
    rabbit = wolf[-1]
    bear = get_price(security=list(universe), start_date=lizard, end_date=rabbit, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1095')
    bear = bear.copy()
    bear['time'] = pd.to_datetime(bear['time'])
    bear = bear.sort_values(['code', 'time'])
    bear['high'] = pd.to_numeric(bear['high'], errors='coerce').astype(float)
    bear['low'] = pd.to_numeric(bear['low'], errors='coerce').astype(float)
    bear['close'] = pd.to_numeric(bear['close'], errors='coerce').astype(float)
    giraffe = {}
    for koala, zebra in bear.groupby('code', sort=False):
        zebra = zebra.tail(N)
        if zebra.shape[0] < N:
            continue
        dolphin = zebra['high'].values.astype(float)
        hawk = zebra['low'].values.astype(float)
        tiger = zebra['close'].values.astype(float)
        cat = np.where((hawk > 0) & np.isfinite(hawk) & np.isfinite(dolphin), dolphin / hawk - 1.0, np.nan)
        owl = np.isfinite(cat) & np.isfinite(tiger)
        cat = cat[owl]
        lion = tiger[owl]
        if cat.size < 8:
            continue
        shark = np.argsort(lion)
        turtle = cat.size
        eagle = max(int(turtle * 0.25), 1)
        sparrow = shark[:eagle]
        whale = shark[-eagle:]
        panda = float(np.mean(cat[sparrow]))
        dog = float(np.mean(cat[whale]))
        frog = float(dog - panda)
        if np.isfinite(frog):
            giraffe[koala] = frog
    return _make_factor_series(giraffe, date, universe=universe, name='factor1095')

def factor1096(universe, date, freq='1m'):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = get_price(security=list(universe), start_date=koala, end_date=koala + dt.timedelta(days=1), frequency=freq, fields=['close', 'money'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1096')
    otter = otter.copy()
    otter['time'] = pd.to_datetime(otter['time'])
    otter = otter.sort_values(['code', 'time'])
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
    otter['money'] = pd.to_numeric(otter['money'], errors='coerce').astype(float)
    fox = {}
    for lion, wolf in otter.groupby('code', sort=False):
        tiger = wolf['close'].values.astype(float)
        dog = wolf['money'].values.astype(float)
        rabbit = np.isfinite(tiger) & (tiger > 0) & np.isfinite(dog)
        tiger = tiger[rabbit]
        dog = dog[rabbit]
        if tiger.size < 5:
            continue
        zebra = tiger[1:] / tiger[:-1] - 1.0
        if zebra.size < 3:
            continue
        cat = np.abs(zebra[:-1])
        panda = dog[2:]
        giraffe = min(cat.size, panda.size)
        cat = cat[:giraffe]
        panda = panda[:giraffe]
        bear = np.isfinite(cat) & np.isfinite(panda)
        eagle = cat[bear]
        hawk = panda[bear]
        if eagle.size < 5:
            continue
        whale = float(np.std(eagle, ddof=1))
        shark = float(np.std(hawk, ddof=1))
        if whale == 0 or shark == 0 or (not np.isfinite(whale)) or (not np.isfinite(shark)):
            continue
        dolphin = float(np.corrcoef(eagle, hawk)[0, 1])
        if np.isfinite(dolphin):
            fox[lion] = dolphin
    return _make_factor_series(fox, date, universe=universe, name='factor1096')

def factor1097(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1097')

def factor1098(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1098')

def factor1099(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1099')

def factor1100(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1100')

def factor1101(universe, date, L=20):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = _last_n_trade_days(panda, L + 1)
    tiger = [pd.to_datetime(dog).date() for dog in tiger]
    if len(tiger) < L + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1101')
    sparrow = tiger[0]
    otter = tiger[-1]
    koala = get_price(security=list(universe), start_date=sparrow, end_date=otter, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1101')
    koala = koala.copy()
    if 'time' not in koala.columns:
        if isinstance(koala.index, pd.DatetimeIndex):
            wolf = koala.index.name if koala.index.name else 'time'
            koala = koala.reset_index().rename(columns={wolf: 'time'})
        else:
            koala = koala.reset_index().rename(columns={'index': 'time'})
    if 'code' not in koala.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1101')
    koala['time'] = pd.to_datetime(koala['time'])
    koala['date'] = koala['time'].dt.date
    koala = koala[koala['date'].isin(tiger)]
    koala['close'] = pd.to_numeric(koala['close'], errors='coerce').astype(float)
    koala['pre_close'] = pd.to_numeric(koala['pre_close'], errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        koala['r'] = koala['close'] / koala['pre_close'] - 1.0
    koala.loc[~np.isfinite(koala['r'].values), 'r'] = np.nan
    dolphin = koala.pivot(index='date', columns='code', values='r').reindex(index=tiger)
    lion = get_money_flow_pro(security_list=list(universe), start_date=sparrow.strftime('%Y-%m-%d'), end_date=otter.strftime('%Y-%m-%d'), frequency='daily', fields=['inflow_s', 'outflow_s'], data_type='money')
    if lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1101')
    lion = lion.copy()
    if 'time' in lion.columns:
        lion['date'] = pd.to_datetime(lion['time']).dt.date
    elif 'date' in lion.columns:
        lion['date'] = pd.to_datetime(lion['date']).dt.date
    elif isinstance(lion.index, pd.DatetimeIndex):
        lion['date'] = pd.to_datetime(lion.index).date
    else:
        lion['date'] = pd.to_datetime(lion.index).date
    if 'code' not in lion.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1101')
    lion = lion[lion['date'].isin(tiger)]
    lion['inflow_s'] = pd.to_numeric(lion['inflow_s'], errors='coerce').astype(float)
    lion['outflow_s'] = pd.to_numeric(lion['outflow_s'], errors='coerce').astype(float)
    lion = lion.groupby(['date', 'code'], sort=False)[['inflow_s', 'outflow_s']].sum().reset_index()
    rabbit = lion['inflow_s'] - lion['outflow_s']
    rabbit = rabbit.where(np.isfinite(rabbit), np.nan)
    lion['net_s'] = rabbit
    giraffe = lion.pivot(index='date', columns='code', values='net_s').reindex(index=tiger)
    fox = {}
    for cat in universe:
        zebra = dolphin.get(cat, pd.Series(index=tiger, dtype='float64'))
        eagle = giraffe.get(cat, pd.Series(index=tiger, dtype='float64'))
        shark = zebra.iloc[1:].values.astype(float)
        hawk = eagle.iloc[:-1].values.astype(float)
        bear = np.isfinite(shark) & np.isfinite(hawk)
        if bear.sum() < 5:
            continue
        shark = shark[bear]
        hawk = hawk[bear]
        whale = _spearman_corr(shark, hawk)
        if np.isfinite(whale):
            fox[cat] = float(whale)
    return _make_factor_series(fox, date, universe=universe, name='factor1101')

def factor1102(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1102')

def factor1103(universe, date, freq='1m', window=20):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = _last_n_trade_days(bear, window)
    rabbit = [pd.to_datetime(fox).date() for fox in rabbit]
    if len(rabbit) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1103')
    zebra = {koala: [] for koala in universe}
    owl = {koala: [] for koala in universe}
    for wolf in rabbit:
        giraffe = get_price(security=list(universe), start_date=wolf, end_date=wolf + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            if isinstance(giraffe.index, pd.DatetimeIndex):
                eagle = giraffe.index.name if giraffe.index.name else 'time'
                giraffe = giraffe.reset_index().rename(columns={eagle: 'time'})
            else:
                giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
        if 'code' not in giraffe.columns:
            continue
        giraffe['time'] = pd.to_datetime(giraffe['time'])
        giraffe = giraffe.sort_values(['code', 'time'])
        giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
        for koala, shark in giraffe.groupby('code', sort=False):
            sparrow = shark['close'].values.astype(float)
            sparrow = sparrow[np.isfinite(sparrow) & (sparrow > 0)]
            if sparrow.size < 5:
                continue
            lizard = sparrow[1:] / sparrow[:-1] - 1.0
            if lizard.size < 3:
                continue
            hawk = float(np.median(lizard))
            dog = np.abs(lizard - hawk)
            lemur = int(np.argmax(dog))
            if lemur == 0:
                continue
            frog = float(lizard[lemur])
            salmon = float(lizard[lemur - 1])
            if np.isfinite(frog) and np.isfinite(salmon):
                zebra[koala].append(frog)
                owl[koala].append(salmon)
    panda = {lion: float(np.mean(badger)) for lion, badger in zebra.items() if len(badger) > 0}
    tiger = {lion: float(np.mean(badger)) for lion, badger in owl.items() if len(badger) > 0}
    otter = sorted(set(panda.keys()) & set(tiger.keys()))
    if len(otter) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1103')
    dolphin = pd.Series({lion: panda[lion] for lion in otter}, dtype=float)
    turtle = pd.Series({lion: tiger[lion] for lion in otter}, dtype=float)
    tuna = dolphin.rank(ascending=False, method='average')
    alpaca = turtle.rank(ascending=False, method='average')
    cat = tuna + alpaca
    whale = {lion: float(cat[lion]) for lion in otter if np.isfinite(cat[lion])}
    return _make_factor_series(whale, date, universe=universe, name='factor1103')

def factor1104(universe, date, window=20):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = _last_n_trade_days(tiger, window)
    lion = [pd.to_datetime(panda).date() for panda in lion]
    if len(lion) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1104')
    zebra = lion[0]
    otter = lion[-1]
    koala = get_price(security=list(universe), start_date=zebra, end_date=otter, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1104')
    koala = koala.copy()
    if 'time' not in koala.columns:
        if isinstance(koala.index, pd.DatetimeIndex):
            wolf = koala.index.name if koala.index.name else 'time'
            koala = koala.reset_index().rename(columns={wolf: 'time'})
        else:
            koala = koala.reset_index().rename(columns={'index': 'time'})
    if 'code' not in koala.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1104')
    koala['time'] = pd.to_datetime(koala['time'])
    koala['date'] = koala['time'].dt.date
    koala = koala[koala['date'].isin(lion)]
    koala['close'] = pd.to_numeric(koala['close'], errors='coerce').astype(float)
    koala['pre_close'] = pd.to_numeric(koala['pre_close'], errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        koala['r'] = koala['close'] / koala['pre_close'] - 1.0
    koala.loc[~np.isfinite(koala['r'].values), 'r'] = np.nan
    giraffe = koala.pivot(index='date', columns='code', values='r').reindex(index=lion)
    rabbit = giraffe.mean(axis=1, skipna=True)
    cat = giraffe.sub(rabbit, axis=0)
    fox = {}
    for dog in universe:
        if dog not in cat.columns:
            continue
        dolphin = cat[dog].values.astype(float)
        bear = np.isfinite(dolphin)
        if bear.sum() == 0:
            continue
        whale = float(np.max(np.abs(dolphin[bear])))
        if np.isfinite(whale):
            fox[dog] = whale
    return _make_factor_series(fox, date, universe=universe, name='factor1104')

def factor1105(universe, date, J=20):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, J + 1)
    otter = [pd.to_datetime(lion).date() for lion in otter]
    if len(otter) < J + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1105')
    zebra = otter[0]
    wolf = otter[-1]
    fox = get_price(security=list(universe), start_date=zebra, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1105')
    fox = fox.copy()
    if 'time' not in fox.columns:
        if isinstance(fox.index, pd.DatetimeIndex):
            rabbit = fox.index.name if fox.index.name else 'time'
            fox = fox.reset_index().rename(columns={rabbit: 'time'})
        else:
            fox = fox.reset_index().rename(columns={'index': 'time'})
    if 'code' not in fox.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1105')
    fox['time'] = pd.to_datetime(fox['time'])
    fox['date'] = fox['time'].dt.date
    fox = fox[fox['date'].isin(otter)]
    fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
    tiger = fox.pivot(index='date', columns='code', values='close').reindex(index=otter)
    dog = tiger.iloc[-1]
    cat = tiger.iloc[-(J + 1)]
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = (dog - cat) / cat
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan)
    bear = {panda: float(giraffe.get(panda)) for panda in universe if np.isfinite(giraffe.get(panda, np.nan))}
    return _make_factor_series(bear, date, universe=universe, name='factor1105')

def factor1106(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1106')

def factor1107(universe, date, window=20, minute_ma_window=240, batch_size=200):
    _set_asof_date(date)
    wolf = _to_date(date)
    rabbit = _last_n_trade_days(wolf, window)
    if len(rabbit) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1107')
    salmon = rabbit[0]
    dolphin = rabbit[-1]
    tuna = pd.to_datetime(salmon).strftime('%Y-%m-%d')
    shark = pd.to_datetime(dolphin).strftime('%Y-%m-%d')
    whale = (pd.to_datetime(shark) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    lemur = list(universe)
    giraffe = [pd.to_datetime(otter).date() for otter in rabbit]
    zebra = get_price(lemur, start_date=tuna, end_date=shark, frequency='daily', fields=['close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1107')
    zebra = zebra.copy()
    if 'time' not in zebra.columns:
        zebra = zebra.reset_index()
    if 'code' not in zebra.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1107')
    zebra['time'] = pd.to_datetime(zebra['time'])
    zebra['date'] = zebra['time'].dt.date
    zebra = zebra[['code', 'date', 'close']].dropna(subset=['close'])
    zebra['close'] = zebra['close'].astype(float)
    zebra = zebra[np.isfinite(zebra['close'].values)]
    fox = zebra.pivot(index='date', columns='code', values='close').reindex(index=giraffe)
    frog = []
    for hawk in range(0, len(lemur), max(1, int(batch_size))):
        dog = lemur[hawk:hawk + max(1, int(batch_size))]
        sparrow = get_price(dog, start_date=tuna, end_date=whale, frequency='1m', fields=['close'], fq='post', panel=False)
        if sparrow is None or sparrow.empty:
            continue
        sparrow = sparrow.copy()
        if 'time' not in sparrow.columns:
            sparrow['time'] = sparrow.index
        sparrow['time'] = pd.to_datetime(sparrow['time'])
        if 'code' not in sparrow.columns:
            continue
        sparrow['date'] = sparrow['time'].dt.date
        sparrow = sparrow[sparrow['date'].isin(giraffe)]
        if sparrow.empty:
            continue
        sparrow = sparrow[['code', 'date', 'time', 'close']].dropna(subset=['close'])
        sparrow['close'] = sparrow['close'].astype(float)
        sparrow = sparrow[np.isfinite(sparrow['close'].values)]
        if sparrow.empty:
            continue
        sparrow = sparrow.sort_values(['code', 'date', 'time'])
        alpaca = sparrow.groupby(['code', 'date'], sort=False).tail(int(minute_ma_window))
        lizard = alpaca.groupby(['code', 'date'], sort=False)['close'].mean().rename('close_ma').reset_index()
        frog.append(lizard)
    if len(frog) == 0:
        lion = pd.DataFrame(index=giraffe, columns=lemur, dtype='float64')
    else:
        owl = pd.concat(frog, ignore_index=True)
        lion = owl.pivot(index='date', columns='code', values='close_ma').reindex(index=giraffe)
    eagle = {}
    for koala in lemur:
        bear = fox.get(koala, pd.Series(index=giraffe, dtype='float64'))
        turtle = lion.get(koala, pd.Series(index=giraffe, dtype='float64'))
        with np.errstate(divide='ignore', invalid='ignore'):
            panda = (bear - turtle) / turtle * 100.0
        panda = panda.replace([np.inf, -np.inf], np.nan)
        panda = panda.dropna()
        if panda.empty:
            continue
        tiger = panda.values.astype(float)
        cat = tiger.size
        beaver = np.arange(1, cat + 1, dtype=float)
        beaver /= beaver.sum()
        badger = float(np.sum(beaver * tiger))
        if np.isfinite(badger):
            eagle[koala] = badger
    return _make_factor_series(eagle, date, universe=universe, name='factor1107')

def factor1108(universe, date, R=20):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = _last_n_trade_days(panda, R)
    tiger = [pd.to_datetime(dog).date() for dog in tiger]
    if len(tiger) < R:
        return _make_factor_series({}, date, universe=universe, name='factor1108')
    rabbit = tiger[0]
    koala = tiger[-1]
    lion = get_price(security=list(universe), start_date=rabbit, end_date=koala, frequency='daily', fields=['close', 'pre_close', 'money'], fq='post', panel=False)
    if lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1108')
    lion = lion.copy()
    if 'time' not in lion.columns:
        if isinstance(lion.index, pd.DatetimeIndex):
            fox = lion.index.name if lion.index.name else 'time'
            lion = lion.reset_index().rename(columns={fox: 'time'})
        else:
            lion = lion.reset_index().rename(columns={'index': 'time'})
    if 'code' not in lion.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1108')
    lion['time'] = pd.to_datetime(lion['time'])
    lion['date'] = lion['time'].dt.date
    lion = lion[lion['date'].isin(tiger)]
    lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
    lion['pre_close'] = pd.to_numeric(lion['pre_close'], errors='coerce').astype(float)
    lion['money'] = pd.to_numeric(lion['money'], errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        lion['r'] = lion['close'] / lion['pre_close'] - 1.0
    lion.loc[~np.isfinite(lion['r'].values), 'r'] = np.nan
    bear = np.isfinite(lion['r'].values) & np.isfinite(lion['money'].values) & (lion['money'].values > 0)
    lion = lion[bear]
    if lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1108')
    lion['term'] = np.abs(lion['r'].values) / lion['money'].values
    wolf = lion.groupby('code', sort=False)['term'].mean()
    otter = {cat: float(wolf.get(cat)) for cat in universe if np.isfinite(wolf.get(cat, np.nan))}
    return _make_factor_series(otter, date, universe=universe, name='factor1108')

def factor1109(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1109')

def factor1110(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1110')

def factor1111(universe, date):
    _set_asof_date(date)
    sparrow = _to_date(date)
    owl = pd.to_datetime(sparrow).strftime('%Y-%m-%d')
    eagle = list(universe)
    salmon = get_fundamentals(query(giraffe.code, giraffe.term_045, giraffe.pb_ratio).filter(giraffe.code.in_(eagle)), date=sparrow)
    if salmon is None or salmon.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1111')
    salmon = salmon[['code', 'term_045', 'pb_ratio']].drop_duplicates('code').set_index('code')
    salmon['term_045'] = pd.to_numeric(salmon['term_045'], errors='coerce').astype(float)
    salmon['pb_ratio'] = pd.to_numeric(salmon['pb_ratio'], errors='coerce').astype(float)
    turtle = get_history_fundamentals(security=eagle, fields=[fox.total_owner_equities], watch_date=sparrow, count=2, interval='1q', stat_by_year=False)
    if turtle is None or turtle.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1111')
    turtle = turtle.copy()
    turtle['statDate'] = pd.to_datetime(turtle['statDate'])
    turtle = turtle.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'])
    whale = turtle.groupby('code', sort=False).tail(2)
    dolphin = whale.groupby('code', sort=False)['total_owner_equities'].apply(lambda s: pd.to_numeric(s, errors='coerce').astype(float).values)
    dog = {}
    cat = {}
    for shark, zebra in dolphin.items():
        if zebra.size >= 2 and np.isfinite(zebra[-2]) and np.isfinite(zebra[-1]):
            dog[shark] = float(zebra[-2])
            cat[shark] = float(zebra[-1])
    otter = {}
    try:
        tuna = get_factor_values(eagle, ['term_053'], start_date=owl, end_date=owl)
        if isinstance(tuna, dict) and 'term_053' in tuna:
            frog = tuna['term_053']
            if isinstance(frog, pd.DataFrame) and (not frog.empty):
                gecko = frog.iloc[0]
                for shark in eagle:
                    iguana = gecko.get(shark, np.nan)
                    if np.isfinite(iguana):
                        otter[shark] = float(iguana)
    except Exception:
        otter = {}
    camel = [shark for shark in eagle if shark not in otter]
    if camel:
        lizard = get_history_fundamentals(security=camel, fields=[bear.term_052], watch_date=sparrow, count=4, interval='1q', stat_by_year=False)
        if lizard is not None and (not lizard.empty):
            lizard = lizard.copy()
            lizard['statDate'] = pd.to_datetime(lizard['statDate'])
            lizard = lizard.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'])
            donkey = lizard.groupby('code', sort=False)['term_052'].apply(lambda s: float(pd.to_numeric(s, errors='coerce').tail(4).sum()))
            for shark in camel:
                iguana = float(donkey.get(shark, np.nan))
                if np.isfinite(iguana):
                    otter[shark] = iguana
    hyena = []
    for shark in eagle:
        if shark not in salmon.index:
            continue
        wolf = float(salmon.at[shark, 'term_045'])
        fox = float(salmon.at[shark, 'pb_ratio'])
        panda = float(cat.get(shark, np.nan))
        tiger = float(dog.get(shark, np.nan))
        koala = float(otter.get(shark, np.nan))
        if not (np.isfinite(wolf) and wolf > 0 and np.isfinite(fox) and (fox > 0) and np.isfinite(panda) and (panda > 0) and np.isfinite(tiger) and np.isfinite(koala)):
            continue
        llama = wolf / panda - 1.0
        jaguar = koala / panda
        kangaroo = tiger / panda
        if np.all(np.isfinite([llama, jaguar, kangaroo])):
            hyena.append((shark, llama, jaguar, kangaroo, fox))
    if len(hyena) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor1111')
    hawk = [ferret[0] for ferret in hyena]
    mole = np.array([ferret[1] for ferret in hyena], dtype=float)
    rabbit = np.column_stack([np.array([ferret[2] for ferret in hyena], dtype=float), np.array([ferret[3] for ferret in hyena], dtype=float)])
    try:
        beaver, giraffe, giraffe, giraffe = np.linalg.lstsq(rabbit, mole, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1111')
    lemur, badger = (float(beaver[0]), float(beaver[1]))
    alpaca = {}
    for shark, giraffe, jaguar, kangaroo, fox in hyena:
        bear = 1.0 + lemur * jaguar + badger * kangaroo
        lion = bear / fox - 1.0
        if np.isfinite(lion):
            alpaca[shark] = float(lion)
    return _make_factor_series(alpaca, date, universe=universe, name='factor1111')

def factor1112(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1112')

def factor1113(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1113')

def factor1114(universe, date, use_index=None):
    _set_asof_date(date)
    koala = _to_date(date)
    shark = _last_n_trade_days(koala, 1)
    shark = [pd.to_datetime(lion).date() for lion in shark]
    if not shark:
        return _make_factor_series({}, date, universe=universe, name='factor1114')
    whale = shark[-1]
    giraffe = _last_n_trade_days(whale, 2)
    giraffe = [pd.to_datetime(lion).date() for lion in giraffe]
    if len(giraffe) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor1114')
    dolphin = giraffe[0]
    fox = giraffe[-1]
    otter = get_price(security=list(universe), start_date=dolphin, end_date=fox, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1114')
    otter = otter.copy()
    if 'time' not in otter.columns:
        if isinstance(otter.index, pd.DatetimeIndex):
            rabbit = otter.index.name if otter.index.name else 'time'
            otter = otter.reset_index().rename(columns={rabbit: 'time'})
        else:
            otter = otter.reset_index().rename(columns={'index': 'time'})
    if 'code' not in otter.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1114')
    otter['time'] = pd.to_datetime(otter['time'])
    otter['date'] = otter['time'].dt.date
    otter = otter[otter['date'] == whale]
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1114')
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
    otter['pre_close'] = pd.to_numeric(otter['pre_close'], errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        otter['r'] = otter['close'] / otter['pre_close'] - 1.0
    otter.loc[~np.isfinite(otter['r'].values), 'r'] = np.nan
    zebra = otter.set_index('code')['r'].dropna()
    cat = int(zebra.size)
    if cat <= 1:
        return _make_factor_series({}, date, universe=universe, name='factor1114')
    if use_index is not None:
        bear = _get_daily_close_series(use_index, dolphin, fox)
        bear = pd.to_numeric(bear, errors='coerce').astype(float)
        bear = bear[np.isfinite(bear) & (bear > 0)]
        if bear.size >= 2:
            dog = float(bear.iloc[-1] / bear.iloc[-2] - 1.0)
            if not np.isfinite(dog):
                dog = float(zebra.mean())
        else:
            dog = float(zebra.mean())
    else:
        dog = float(zebra.mean())
    tiger = float(np.sqrt(((zebra - dog) ** 2).sum() / (cat - 1)))
    wolf = {panda: tiger for panda in universe}
    return _make_factor_series(wolf, date, universe=universe, name='factor1114')

def factor1115(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1115')

def factor1116(universe, date, freq='1m'):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = pd.to_datetime(lion).date()
    otter = koala + dt.timedelta(days=1)
    wolf = get_price(security=list(universe), start_date=koala, end_date=otter, frequency='daily', fields=['low'], fq='post', panel=False)
    eagle = {}
    if wolf is not None and (not wolf.empty):
        wolf = wolf.copy()
        if 'time' not in wolf.columns:
            wolf['time'] = wolf.index
        wolf['time'] = pd.to_datetime(wolf['time'])
        if 'code' in wolf.columns:
            wolf['date'] = wolf['time'].dt.date
            wolf = wolf[wolf['date'] == koala]
            if not wolf.empty:
                dolphin = wolf.sort_values('time').groupby('code', sort=False).tail(1)
                eagle = pd.to_numeric(dolphin.set_index('code')['low'], errors='coerce').astype(float).to_dict()
    fox = get_price(security=list(universe), start_date=koala, end_date=otter, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
    if fox is None or fox.empty or 'code' not in fox.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1116')
    fox = fox.copy()
    fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
    fox['volume'] = pd.to_numeric(fox['volume'], errors='coerce').astype(float)
    fox = fox[np.isfinite(fox['close'].values) & np.isfinite(fox['volume'].values) & (fox['volume'].values > 0)]
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1116')
    bear = {}
    for tiger, rabbit in fox.groupby('code', sort=False):
        hawk = float(eagle.get(tiger, np.nan))
        if not np.isfinite(hawk):
            continue
        giraffe = rabbit.groupby('close', sort=False)['volume'].sum()
        if giraffe.empty:
            continue
        turtle = float(giraffe.sum())
        if turtle <= 0 or not np.isfinite(turtle):
            continue
        sparrow = np.array(sorted(giraffe.index.values), dtype=float)
        tuna = giraffe.reindex(sparrow).values.astype(float)
        if sparrow.size < 2:
            continue
        panda = int(np.argmax(tuna))
        shark = zebra = panda
        dog = float(tuna[panda])
        while dog < 0.5 * turtle and (shark > 0 or zebra < sparrow.size - 1):
            whale = shark - 1 if shark > 0 else None
            owl = zebra + 1 if zebra < sparrow.size - 1 else None
            lizard = float(tuna[whale]) if whale is not None else -1.0
            frog = float(tuna[owl]) if owl is not None else -1.0
            if lizard < 0 and frog < 0:
                break
            if frog < 0 or (lizard >= frog and lizard >= 0):
                shark = whale
                dog += lizard
            else:
                zebra = owl
                dog += frog
        cat = float(sparrow[zebra])
        salmon = cat - hawk
        if np.isfinite(salmon):
            bear[str(tiger)] = float(salmon)
    return _make_factor_series(bear, date, universe=universe, name='factor1116')

def factor1117(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1117')

def factor1118(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1118')

def factor1119(universe, date, J=20):
    _set_asof_date(date)
    giraffe = _to_date(date)
    zebra = _last_n_trade_days(giraffe, J)
    zebra = [pd.to_datetime(rabbit).date() for rabbit in zebra]
    if len(zebra) < J:
        return _make_factor_series({}, date, universe=universe, name='factor1119')
    turtle = zebra[0]
    whale = zebra[-1]
    dolphin = get_price(security=list(universe), start_date=turtle, end_date=whale, frequency='daily', fields=['close'], fq='post', panel=False)
    if dolphin is None or dolphin.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1119')
    dolphin = dolphin.copy()
    if 'time' not in dolphin.columns:
        if isinstance(dolphin.index, pd.DatetimeIndex):
            eagle = dolphin.index.name if dolphin.index.name else 'time'
            dolphin = dolphin.reset_index().rename(columns={eagle: 'time'})
        else:
            dolphin = dolphin.reset_index().rename(columns={'index': 'time'})
    if 'code' not in dolphin.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1119')
    dolphin['time'] = pd.to_datetime(dolphin['time'])
    dolphin['date'] = dolphin['time'].dt.date
    dolphin = dolphin[dolphin['date'].isin(zebra)]
    dolphin['close'] = pd.to_numeric(dolphin['close'], errors='coerce').astype(float)
    wolf = dolphin.pivot(index='date', columns='code', values='close').reindex(index=zebra)
    lizard = np.arange(1, len(zebra) + 1, dtype=float)
    tiger = np.column_stack([np.ones_like(lizard), lizard, lizard ** 2])
    shark = {}
    for bear in universe:
        owl = wolf.get(bear, pd.Series(index=zebra, dtype='float64'))
        salmon = owl.values.astype(float)
        hawk = np.isfinite(salmon)
        if hawk.sum() < J:
            continue
        alpaca = salmon[hawk]
        lion = tiger[hawk]
        if alpaca.size < 5:
            continue
        try:
            fox, koala, koala, koala = np.linalg.lstsq(lion, alpaca, rcond=None)
        except np.linalg.LinAlgError:
            continue
        tuna = lion.dot(fox)
        sparrow = alpaca - tuna
        dog = float(np.sum(sparrow ** 2))
        panda = float(np.sum((alpaca - alpaca.mean()) ** 2))
        if panda <= 0 or not np.isfinite(dog) or (not np.isfinite(panda)):
            continue
        cat = 1.0 - dog / panda
        if not np.isfinite(cat):
            continue
        otter = float(fox[1])
        frog = otter * cat ** 2
        if np.isfinite(frog):
            shark[bear] = float(frog)
    return _make_factor_series(shark, date, universe=universe, name='factor1119')

def factor1120(universe, date, threshold=0.07):
    _set_asof_date(date)
    tiger = _to_date(date)
    dolphin = _last_n_trade_days(tiger, 1)
    dolphin = [pd.to_datetime(panda).date() for panda in dolphin]
    if not dolphin:
        return _make_factor_series({}, date, universe=universe, name='factor1120')
    zebra = dolphin[-1]
    bear = _last_n_trade_days(zebra, 2)
    bear = [pd.to_datetime(panda).date() for panda in bear]
    if len(bear) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor1120')
    giraffe = bear[0]
    koala = bear[-1]
    lion = get_price(security=list(universe), start_date=giraffe, end_date=koala, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1120')
    lion = lion.copy()
    if 'time' not in lion.columns:
        if isinstance(lion.index, pd.DatetimeIndex):
            fox = lion.index.name if lion.index.name else 'time'
            lion = lion.reset_index().rename(columns={fox: 'time'})
        else:
            lion = lion.reset_index().rename(columns={'index': 'time'})
    if 'code' not in lion.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1120')
    lion['time'] = pd.to_datetime(lion['time'])
    lion['date'] = lion['time'].dt.date
    lion = lion[lion['date'] == zebra]
    if lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1120')
    lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
    lion['pre_close'] = pd.to_numeric(lion['pre_close'], errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        rabbit = lion['close'] / lion['pre_close'] - 1.0
    rabbit = rabbit.where(np.isfinite(rabbit), np.nan).dropna()
    cat = int(rabbit.size)
    if cat == 0:
        return _make_factor_series({}, date, universe=universe, name='factor1120')
    wolf = float((np.abs(rabbit.values) > threshold).sum() / cat)
    otter = {dog: wolf for dog in universe}
    return _make_factor_series(otter, date, universe=universe, name='factor1120')

def factor1121(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1121')

def factor1122(universe, date, window=20):
    _set_asof_date(date)
    rabbit = _to_date(date)
    giraffe = _last_n_trade_days(rabbit, window)
    giraffe = [pd.to_datetime(wolf).date() for wolf in giraffe]
    if len(giraffe) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1122')
    salmon = 240
    koala = {tiger: [] for tiger in universe}
    for bear in giraffe:
        zebra = get_price(security=list(universe), start_date=bear, end_date=bear + dt.timedelta(days=1), frequency='1m', fields=['high', 'low', 'close'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            if isinstance(zebra.index, pd.DatetimeIndex):
                sparrow = zebra.index.name if zebra.index.name else 'time'
                zebra = zebra.reset_index().rename(columns={sparrow: 'time'})
            else:
                zebra = zebra.reset_index().rename(columns={'index': 'time'})
        if 'code' not in zebra.columns:
            continue
        zebra['time'] = pd.to_datetime(zebra['time'])
        zebra = zebra.sort_values(['code', 'time'])
        for fox in ['high', 'low', 'close']:
            zebra[fox] = pd.to_numeric(zebra[fox], errors='coerce').astype(float)
        for otter, whale in zebra.groupby('code', sort=False):
            shark = whale['high'].values.astype(float)
            owl = whale['low'].values.astype(float)
            tiger = whale['close'].values.astype(float)
            lizard = np.isfinite(shark) & np.isfinite(owl) & np.isfinite(tiger)
            if lizard.sum() < 60:
                continue
            shark, owl, tiger = (shark[lizard], owl[lizard], tiger[lizard])
            eagle = (shark + owl + tiger) / 3.0
            if eagle.size < 60:
                continue
            frog = eagle[-min(salmon, eagle.size):]
            if frog.size < 30:
                continue
            turtle = float(np.mean(frog))
            panda = float(np.mean(np.abs(frog - turtle)))
            if not np.isfinite(turtle) or not np.isfinite(panda) or panda == 0:
                continue
            hawk = float(eagle[-1])
            lion = (hawk - turtle) / (0.015 * panda)
            if np.isfinite(lion):
                koala[otter].append(float(lion))
    dolphin = {}
    for otter, dog in koala.items():
        if len(dog) == 0:
            continue
        alpaca = np.asarray(dog, dtype=float)
        cat = alpaca.size
        lemur = np.arange(1, cat + 1, dtype=float)
        lemur /= lemur.sum()
        tuna = float(np.sum(lemur * alpaca))
        if np.isfinite(tuna):
            dolphin[otter] = tuna
    return _make_factor_series(dolphin, date, universe=universe, name='factor1122')

def factor1123(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1123')

def factor1124(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1124')

def factor1125(universe, date, freq='1m'):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = pd.to_datetime(lion).date()
    otter = koala + dt.timedelta(days=1)
    wolf = get_price(security=list(universe), start_date=koala, end_date=otter, frequency='daily', fields=['high', 'low'], fq='post', panel=False)
    rabbit, zebra = ({}, {})
    if wolf is not None and (not wolf.empty) and ('code' in wolf.columns):
        wolf = wolf.copy()
        if 'time' not in wolf.columns:
            wolf['time'] = wolf.index
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['date'] = wolf['time'].dt.date
        wolf = wolf[wolf['date'] == koala]
        if not wolf.empty:
            giraffe = wolf.sort_values('time').groupby('code', sort=False).tail(1)
            rabbit = pd.to_numeric(giraffe.set_index('code')['high'], errors='coerce').astype(float).to_dict()
            zebra = pd.to_numeric(giraffe.set_index('code')['low'], errors='coerce').astype(float).to_dict()
    fox = get_price(security=list(universe), start_date=koala, end_date=otter, frequency=freq, fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty or 'code' not in fox.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1125')
    fox = fox.copy()
    fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
    fox = fox[np.isfinite(fox['close'].values) & (fox['close'].values > 0)]
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1125')
    dolphin = fox.groupby('code', sort=False)['close'].mean()
    bear = {}
    for tiger in universe:
        cat = float(rabbit.get(tiger, np.nan))
        dog = float(zebra.get(tiger, np.nan))
        if not (np.isfinite(cat) and np.isfinite(dog)) or cat <= dog:
            continue
        panda = float(dolphin.get(tiger, np.nan))
        if not np.isfinite(panda):
            continue
        whale = (panda - dog) / (cat - dog)
        if np.isfinite(whale):
            bear[str(tiger)] = float(whale)
    return _make_factor_series(bear, date, universe=universe, name='factor1125')

def factor1126(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1126')

def factor1127(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1127')

def factor1128(universe, date, K=20):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = _last_n_trade_days(panda, K + 1)
    tiger = [pd.to_datetime(dog).date() for dog in tiger]
    if len(tiger) < K + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1128')
    zebra = tiger[0]
    koala = tiger[-1]
    lion = get_price(security=list(universe), start_date=zebra, end_date=koala, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1128')
    lion = lion.copy()
    if 'time' not in lion.columns:
        if isinstance(lion.index, pd.DatetimeIndex):
            fox = lion.index.name if lion.index.name else 'time'
            lion = lion.reset_index().rename(columns={fox: 'time'})
        else:
            lion = lion.reset_index().rename(columns={'index': 'time'})
    if 'code' not in lion.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1128')
    lion['time'] = pd.to_datetime(lion['time'])
    lion['date'] = lion['time'].dt.date
    lion = lion[lion['date'].isin(tiger)]
    lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
    lion['pre_close'] = pd.to_numeric(lion['pre_close'], errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        lion['r'] = lion['close'] / lion['pre_close'] - 1.0
    lion.loc[~np.isfinite(lion['r'].values), 'r'] = np.nan
    giraffe = lion.pivot(index='date', columns='code', values='r').reindex(index=tiger)
    otter = {}
    for cat in universe:
        if cat not in giraffe.columns:
            continue
        bear = giraffe[cat].values.astype(float)
        bear = bear[np.isfinite(bear)]
        if bear.size < K:
            continue
        rabbit = bear[-K:]
        wolf = float(np.mean(rabbit))
        dolphin = float(np.mean((rabbit - wolf) ** 2))
        whale = float(np.sqrt(252.0 * dolphin))
        if np.isfinite(whale):
            otter[cat] = whale
    return _make_factor_series(otter, date, universe=universe, name='factor1128')

def factor1129(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1129')

def factor1130(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1130')

def factor1131(universe, date, freq='1m'):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = pd.to_datetime(panda).date()
    lion = get_price(security=list(universe), start_date=tiger, end_date=tiger + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
    if lion is None or lion.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1131')
    lion = lion.copy()
    if 'code' not in lion.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1131')
    lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
    koala = {}
    for dog, otter in lion.groupby('code', sort=False):
        rabbit = otter['close'].values.astype(float)
        rabbit = rabbit[np.isfinite(rabbit) & (rabbit > 0)]
        if rabbit.size < 20:
            continue
        cat = int(rabbit.size)
        shark = min(60, cat)
        zebra = pd.Series(rabbit).rolling(shark, min_periods=shark).mean().values
        fox = np.isfinite(zebra)
        if fox.sum() < 10:
            continue
        dolphin = zebra[fox]
        bear = rabbit[fox] - dolphin
        giraffe = float(np.std(dolphin, ddof=1))
        wolf = float(np.std(bear, ddof=1))
        if not (np.isfinite(giraffe) and np.isfinite(wolf)) or wolf <= 0 or giraffe <= 0:
            continue
        whale = float(math.log(giraffe / wolf))
        if np.isfinite(whale):
            koala[dog] = whale
    return _make_factor_series(koala, date, universe=universe, name='factor1131')

def factor1132(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1132')

def factor1133(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1133')

def factor1134(universe, date, m=20):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, m)
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    if len(koala) < m:
        return _make_factor_series({}, date, universe=universe, name='factor1134')
    dolphin = koala[0]
    fox = koala[-1]
    otter = get_price(security=list(universe), start_date=dolphin, end_date=fox, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1134')
    otter = otter.copy()
    if 'time' not in otter.columns:
        if isinstance(otter.index, pd.DatetimeIndex):
            bear = otter.index.name if otter.index.name else 'time'
            otter = otter.reset_index().rename(columns={bear: 'time'})
        else:
            otter = otter.reset_index().rename(columns={'index': 'time'})
    if 'code' not in otter.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1134')
    otter['time'] = pd.to_datetime(otter['time'])
    otter['date'] = otter['time'].dt.date
    otter = otter[otter['date'].isin(koala)]
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
    otter['pre_close'] = pd.to_numeric(otter['pre_close'], errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        otter['r'] = otter['close'] / otter['pre_close'] - 1.0
    otter.loc[~np.isfinite(otter['r'].values), 'r'] = np.nan
    zebra = otter.pivot(index='date', columns='code', values='r').reindex(index=koala)
    giraffe = zebra.mean(axis=1, skipna=True)
    dog = zebra.sub(giraffe, axis=0)
    cat = dog ** 2
    wolf = {}
    for panda in universe:
        if panda not in cat.columns:
            continue
        whale = cat[panda].values.astype(float)
        rabbit = np.isfinite(whale)
        if rabbit.sum() == 0:
            continue
        shark = float(np.mean(whale[rabbit]))
        if np.isfinite(shark):
            wolf[panda] = shark
    return _make_factor_series(wolf, date, universe=universe, name='factor1134')

def factor1135(universe, date, L=20):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, L + 1)
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    if len(koala) < L + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1135')
    whale = koala[0]
    fox = koala[-1]
    otter = get_price(security=list(universe), start_date=whale, end_date=fox, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1135')
    otter = otter.copy()
    if 'time' not in otter.columns:
        if isinstance(otter.index, pd.DatetimeIndex):
            giraffe = otter.index.name if otter.index.name else 'time'
            otter = otter.reset_index().rename(columns={giraffe: 'time'})
        else:
            otter = otter.reset_index().rename(columns={'index': 'time'})
    if 'code' not in otter.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1135')
    otter['time'] = pd.to_datetime(otter['time'])
    otter['date'] = otter['time'].dt.date
    otter = otter[otter['date'].isin(koala)]
    otter['open'] = pd.to_numeric(otter['open'], errors='coerce').astype(float)
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
    dolphin = otter.pivot(index='date', columns='code', values='open').reindex(index=koala)
    cat = otter.pivot(index='date', columns='code', values='close').reindex(index=koala)
    dog = cat.shift(1)
    with np.errstate(divide='ignore', invalid='ignore'):
        bear = np.log(dolphin / dog)
    bear = bear.replace([np.inf, -np.inf], np.nan)
    rabbit = bear.iloc[-L:]
    wolf = {}
    for panda in universe:
        if panda not in rabbit.columns:
            continue
        shark = rabbit[panda].values.astype(float)
        zebra = np.isfinite(shark)
        if zebra.sum() < L:
            continue
        eagle = float(np.sum(np.abs(shark[zebra][-L:])))
        if np.isfinite(eagle):
            wolf[panda] = eagle
    return _make_factor_series(wolf, date, universe=universe, name='factor1135')

def factor1136(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1136')

def factor1137(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1137')

def factor1138(universe, date, maxbin=20, window=20):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = _last_n_trade_days(wolf, window)
    bear = [pd.to_datetime(otter).date() for otter in bear]
    if len(bear) < window:
        return _make_factor_series({}, date, universe=universe, name='factor1138')
    dolphin = {tiger: [] for tiger in universe}
    for fox in bear:
        rabbit = get_price(security=list(universe), start_date=fox, end_date=fox + dt.timedelta(days=1), frequency='1m', fields=['volume'], fq='post', panel=False)
        if rabbit is None or rabbit.empty:
            continue
        rabbit = rabbit.copy()
        if 'code' not in rabbit.columns:
            continue
        rabbit['volume'] = pd.to_numeric(rabbit['volume'], errors='coerce').astype(float)
        rabbit = rabbit[np.isfinite(rabbit['volume'].values) & (rabbit['volume'].values >= 0)]
        if rabbit.empty:
            continue
        for lion, shark in rabbit.groupby('code', sort=False):
            sparrow = shark['volume'].values.astype(float)
            sparrow = sparrow[np.isfinite(sparrow)]
            if sparrow.size < 10:
                continue
            turtle = float(np.min(sparrow))
            owl = float(np.max(sparrow))
            if not np.isfinite(turtle) or not np.isfinite(owl) or owl <= turtle:
                continue
            panda = int(min(maxbin, sparrow.size))
            giraffe = np.linspace(turtle, owl, panda + 1)
            koala, dog = np.histogram(sparrow, bins=giraffe)
            cat = float(sparrow.size)
            hawk = koala.astype(float) / cat
            eagle = hawk > 0
            if eagle.sum() == 0:
                continue
            zebra = float(-np.sum(hawk[eagle] * np.log(hawk[eagle])))
            if np.isfinite(zebra):
                dolphin[lion].append(zebra)
    whale = {}
    for lion in universe:
        frog = np.asarray(dolphin.get(lion, []), dtype=float)
        frog = frog[np.isfinite(frog)]
        if frog.size < 5:
            continue
        lizard = float(np.std(frog, ddof=1))
        if np.isfinite(lizard):
            whale[lion] = lizard
    return _make_factor_series(whale, date, universe=universe, name='factor1138')

def factor1139(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1139')

def factor1140(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1140')

def factor1141(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1141')

def factor1142(universe, date, window=20):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = _last_n_trade_days(bear, window)
    rabbit = [pd.to_datetime(fox).date() for fox in rabbit]
    if len(rabbit) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1142')
    panda = {lion: [] for lion in universe}
    for wolf in rabbit:
        zebra = get_price(security=list(universe), start_date=wolf, end_date=wolf + dt.timedelta(days=1), frequency='1m', fields=['open', 'high', 'low'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'code' not in zebra.columns:
            continue
        for otter in ['open', 'high', 'low']:
            zebra[otter] = pd.to_numeric(zebra[otter], errors='coerce').astype(float)
        whale = zebra.groupby('code', sort=False)
        eagle = (whale['high'].sum() - whale['open'].sum()).astype(float)
        giraffe = (whale['open'].sum() - whale['low'].sum()).astype(float)
        for koala in eagle.index:
            shark = float(eagle.get(koala, np.nan))
            fox = float(giraffe.get(koala, np.nan))
            if not (np.isfinite(shark) and np.isfinite(fox)) or fox == 0:
                continue
            dog = float(shark / fox * 100.0)
            if np.isfinite(dog):
                panda[koala].append(dog)
    dolphin = {}
    for koala in universe:
        tiger = np.asarray(panda.get(koala, []), dtype=float)
        tiger = tiger[np.isfinite(tiger)]
        if tiger.size == 0:
            continue
        cat = int(tiger.size)
        sparrow = np.arange(1, cat + 1, dtype=float)
        sparrow /= sparrow.sum()
        hawk = float(np.sum(sparrow * tiger))
        if np.isfinite(hawk):
            dolphin[koala] = hawk
    return _make_factor_series(dolphin, date, universe=universe, name='factor1142')

def factor1143(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1143')

def factor1144(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1144')

def factor1145(universe, date, d_window=20, freq='1m'):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = _last_n_trade_days(otter, d_window)
    fox = [pd.to_datetime(lion).date() for lion in fox]
    if len(fox) < d_window:
        return _make_factor_series({}, date, universe=universe, name='factor1145')
    giraffe = {dog: [] for dog in universe}
    for koala in fox:
        wolf = get_price(security=list(universe), start_date=koala, end_date=koala + dt.timedelta(days=1), frequency=freq, fields=['open', 'high', 'low', 'close', 'money'], fq='post', panel=False)
        if wolf is None or wolf.empty:
            continue
        wolf = wolf.copy()
        if 'code' not in wolf.columns:
            continue
        for tiger in ['open', 'high', 'low', 'close', 'money']:
            wolf[tiger] = pd.to_numeric(wolf[tiger], errors='coerce').astype(float)
        shark = 2.0 * (wolf['high'].values - wolf['low'].values) - np.abs(wolf['close'].values - wolf['open'].values)
        whale = wolf['money'].values
        dolphin = np.isfinite(shark) & np.isfinite(whale) & (whale > 0)
        if dolphin.sum() == 0:
            continue
        bear = wolf.loc[dolphin, ['code']].copy()
        bear['term'] = shark[dolphin] / whale[dolphin]
        zebra = bear.groupby('code', sort=False)['term'].sum()
        for panda, eagle in zebra.items():
            if np.isfinite(eagle):
                giraffe[panda].append(float(eagle))
    rabbit = {}
    for panda in universe:
        cat = np.asarray(giraffe.get(panda, []), dtype=float)
        cat = cat[np.isfinite(cat)]
        if cat.size == 0:
            continue
        hawk = float(np.mean(cat))
        if np.isfinite(hawk):
            rabbit[panda] = hawk
    return _make_factor_series(rabbit, date, universe=universe, name='factor1145')

def factor1146(universe, date, K=20):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, K + 1)
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    if len(koala) < K + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1146')
    whale = koala[0]
    wolf = koala[-1]
    fox = get_price(security=list(universe), start_date=whale, end_date=wolf, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1146')
    fox = fox.copy()
    if 'time' not in fox.columns:
        if isinstance(fox.index, pd.DatetimeIndex):
            rabbit = fox.index.name if fox.index.name else 'time'
            fox = fox.reset_index().rename(columns={rabbit: 'time'})
        else:
            fox = fox.reset_index().rename(columns={'index': 'time'})
    if 'code' not in fox.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1146')
    fox['time'] = pd.to_datetime(fox['time'])
    fox['date'] = fox['time'].dt.date
    fox = fox[fox['date'].isin(koala)]
    fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
    fox['pre_close'] = pd.to_numeric(fox['pre_close'], errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        fox['r'] = fox['close'] / fox['pre_close'] - 1.0
    fox.loc[~np.isfinite(fox['r'].values), 'r'] = np.nan
    zebra = fox.pivot(index='date', columns='code', values='r').reindex(index=koala)
    giraffe = zebra.rank(axis=1, method='average', na_option='keep')
    panda = zebra.notna().sum(axis=1).astype(float)
    otter = np.sqrt((panda + 1.0) * (panda - 1.0) / 12.0)
    otter = otter.replace(0.0, np.nan)
    cat = giraffe.sub((panda + 1.0) / 2.0, axis=0)
    shark = cat.div(otter, axis=0)
    bear = {}
    for dog in universe:
        if dog not in shark.columns:
            continue
        dolphin = shark[dog].dropna().values.astype(float)
        if dolphin.size < K:
            continue
        eagle = float(np.mean(dolphin[-K:]))
        if np.isfinite(eagle):
            bear[dog] = eagle
    return _make_factor_series(bear, date, universe=universe, name='factor1146')

def factor1147(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1147')

def factor1148(universe, date, freq='1m'):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = pd.to_datetime(koala).date()
    fox = get_price(security=list(universe), start_date=otter, end_date=otter + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1148')
    fox = fox.copy()
    if 'code' not in fox.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1148')
    fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
    wolf = {}
    for lion, bear in fox.groupby('code', sort=False):
        rabbit = bear['close'].values.astype(float)
        rabbit = rabbit[np.isfinite(rabbit) & (rabbit > 0)]
        if rabbit.size < 5:
            continue
        giraffe = np.log(rabbit[1:] / rabbit[:-1])
        if giraffe.size < 3:
            continue
        zebra = giraffe * giraffe
        dog = float(np.sum(zebra))
        if dog <= 0 or not np.isfinite(dog):
            continue
        tiger = float(np.sum(zebra[giraffe > 0]))
        panda = float(np.sum(zebra[giraffe < 0]))
        cat = float((tiger - panda) / dog)
        if np.isfinite(cat):
            wolf[lion] = cat
    return _make_factor_series(wolf, date, universe=universe, name='factor1148')

def factor1149(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1149')

def factor1150(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1150')

def factor1151(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1151')

def factor1152(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1152')

def factor1153(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1153')

def factor1154(universe, date, window=20):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = _last_n_trade_days(otter, window)
    fox = [pd.to_datetime(lion).date() for lion in fox]
    if len(fox) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1154')
    turtle = list(universe)
    hawk = {panda: [] for panda in turtle}
    for koala in fox:
        wolf = get_price(security=turtle, start_date=koala, end_date=koala + dt.timedelta(days=1), frequency='1m', fields=['close'], fq='post', panel=False)
        if wolf is None or wolf.empty or 'code' not in wolf.columns:
            continue
        wolf = wolf.copy()
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf = wolf[np.isfinite(wolf['close'].values) & (wolf['close'].values > 0)]
        if wolf.empty:
            continue
        for tiger, dolphin in wolf.groupby('code', sort=False):
            shark = dolphin['close'].values.astype(float)
            if shark.size < 10:
                continue
            bear = shark[1:] / shark[:-1] - 1.0
            if bear.size < 5:
                continue
            lizard = np.maximum(bear, 0.0)
            rabbit = np.abs(bear)
            sparrow = int(min(239, lizard.size))
            if sparrow < 5:
                continue
            owl = float(np.mean(lizard[-sparrow:]))
            giraffe = float(np.mean(rabbit[-sparrow:]))
            if not (np.isfinite(owl) and np.isfinite(giraffe)) or giraffe <= 0:
                continue
            eagle = float(owl / giraffe * 100.0)
            if np.isfinite(eagle):
                hawk[tiger].append(eagle)
    zebra = {}
    for tiger, whale in hawk.items():
        if not whale:
            continue
        dog = np.asarray(whale, dtype=float)
        dog = dog[np.isfinite(dog)]
        if dog.size == 0:
            continue
        cat = int(dog.size)
        salmon = np.arange(1, cat + 1, dtype=float)
        salmon /= salmon.sum()
        frog = float(np.sum(salmon * dog))
        if np.isfinite(frog):
            zebra[tiger] = frog
    return _make_factor_series(zebra, date, universe=universe, name='factor1154')

def factor1155(universe, date, L=20):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, L)
    otter = [pd.to_datetime(lion).date() for lion in otter]
    if len(otter) < max(5, int(L * 0.6)):
        return _make_factor_series({}, date, universe=universe, name='factor1155')
    turtle = otter[0]
    giraffe = otter[-1]
    salmon = list(universe)
    bear = get_price(security=salmon, start_date=turtle, end_date=giraffe, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if bear is None or bear.empty or 'code' not in bear.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1155')
    bear = bear.copy()
    if 'time' not in bear.columns:
        if isinstance(bear.index, pd.DatetimeIndex):
            dolphin = bear.index.name if bear.index.name else 'time'
            bear = bear.reset_index().rename(columns={dolphin: 'time'})
        else:
            bear = bear.reset_index().rename(columns={'index': 'time'})
    bear['time'] = pd.to_datetime(bear['time'])
    bear['date'] = bear['time'].dt.date
    bear = bear[bear['date'].isin(otter)]
    if bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1155')
    bear['close'] = pd.to_numeric(bear['close'], errors='coerce').astype(float)
    bear['pre_close'] = pd.to_numeric(bear['pre_close'], errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        bear['r'] = bear['close'] / bear['pre_close'] - 1.0
    bear.loc[~np.isfinite(bear['r'].values), 'r'] = np.nan
    shark = bear.pivot(index='date', columns='code', values='r').reindex(index=otter)
    alpaca = [tiger for tiger in shark.columns if shark[tiger].notna().sum() >= max(5, int(0.6 * len(otter)))]
    if len(alpaca) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1155')
    shark = shark[alpaca]
    dog = int(shark.shape[0])
    cat = int(shark.shape[1])
    if dog < 3 or cat < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1155')
    whale = shark.mean(axis=0, skipna=True)
    sparrow = shark.std(axis=0, ddof=1, skipna=True).replace(0.0, np.nan)
    lemur = (shark - whale) / sparrow
    lemur = lemur.replace([np.inf, -np.inf], np.nan).fillna(0.0)
    panda = lemur.values.astype(np.float32)
    wolf = float(max(dog - 1, 1))
    lizard = panda.sum(axis=1)
    rabbit = panda.T.dot(lizard)
    owl = (panda * panda).sum(axis=0)
    frog = rabbit - owl
    eagle = frog / wolf / float(cat - 1)
    eagle = np.clip(eagle, -0.999, 0.999)
    fox = 2.0 * (1.0 - eagle)
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = 1.0 / fox
    hawk[~np.isfinite(hawk)] = np.nan
    zebra = {}
    for tiger, tuna in zip(alpaca, hawk):
        if np.isfinite(tuna):
            zebra[tiger] = float(tuna)
    return _make_factor_series(zebra, date, universe=universe, name='factor1155')

def factor1156(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1156')

def factor1157(universe, date, delta=2.0, freq='1m'):
    _set_asof_date(date)

    def _rolling_mean_valid(x, w):
        if w <= 1 or x.size < w:
            return None
        cat = np.ones(w, dtype=float) / float(w)
        return np.convolve(x, cat, mode='valid')
    lion = _to_date(date)
    koala = pd.to_datetime(lion).date()
    lemur = list(universe)
    otter = get_price(security=lemur, start_date=koala, end_date=koala + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty or 'code' not in otter.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1157')
    otter = otter.copy()
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
    salmon = {}
    tuna = {}
    gecko = {}
    for panda, wolf in otter.groupby('code', sort=False):
        whale = wolf['close'].values.astype(float)
        whale = whale[np.isfinite(whale) & (whale > 0)]
        if whale.size < 40:
            continue
        eagle = np.log(whale[1:] / whale[:-1])
        eagle = eagle[np.isfinite(eagle)]
        if eagle.size < 10:
            continue
        ferret = float(np.std(eagle, ddof=1))
        if not np.isfinite(ferret):
            continue
        cat = int(whale.size)
        llama = min(10, cat)
        kangaroo = min(30, cat)
        if kangaroo < 5 or cat < kangaroo:
            continue
        owl = _rolling_mean_valid(whale, llama)
        lizard = _rolling_mean_valid(whale, kangaroo)
        if owl is None or lizard is None:
            continue
        alpaca = kangaroo - 1
        shark = whale[alpaca:]
        frog = lizard
        dolphin = kangaroo - llama
        if dolphin < 0 or dolphin >= owl.size:
            continue
        turtle = owl[dolphin:dolphin + frog.size]
        if turtle.size != frog.size or turtle.size < 10:
            continue
        giraffe = shark - turtle
        zebra = shark - frog
        hawk = float(np.std(turtle, ddof=1))
        bear = float(np.std(giraffe, ddof=1))
        sparrow = float(np.std(frog, ddof=1))
        rabbit = float(np.std(zebra, ddof=1))
        if not (np.isfinite(hawk) and np.isfinite(bear) and (bear > 0) and (hawk > 0) and np.isfinite(sparrow) and np.isfinite(rabbit) and (rabbit > 0) and (sparrow > 0)):
            continue
        salmon[panda] = float(math.log(hawk / bear))
        tuna[panda] = float(math.log(sparrow / rabbit))
        gecko[panda] = ferret
    tiger = sorted(set(salmon.keys()) & set(tuna.keys()) & set(gecko.keys()))
    if len(tiger) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1157')
    iguana = np.array([gecko[dog] for dog in tiger], dtype=float)
    camel = float(np.nanmin(iguana))
    beaver = float(np.nanmax(iguana))
    if not np.isfinite(camel) or not np.isfinite(beaver) or beaver == camel:
        return _make_factor_series({}, date, universe=universe, name='factor1157')
    fox = {}
    for dog in tiger:
        badger = float(gecko[dog])
        hyena = (badger - camel) / (beaver - camel)
        jaguar = 0.5 + (hyena - 0.5) / float(delta)
        jaguar = max(0.0, min(1.0, jaguar))
        donkey = jaguar * float(salmon[dog]) + (1.0 - jaguar) * float(tuna[dog])
        if np.isfinite(donkey):
            fox[dog] = float(donkey)
    return _make_factor_series(fox, date, universe=universe, name='factor1157')

def factor1158(universe, date, m=20, lookback_year=252):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = _last_n_trade_days(panda, m)
    lion = _last_n_trade_days(panda, lookback_year)
    tiger = [pd.to_datetime(dog).date() for dog in tiger]
    lion = [pd.to_datetime(dog).date() for dog in lion]
    if len(tiger) < max(5, int(m * 0.6)) or len(lion) < 30:
        return _make_factor_series({}, date, universe=universe, name='factor1158')
    giraffe = lion[0]
    otter = lion[-1]
    zebra = list(universe)
    koala = get_price(security=zebra, start_date=giraffe, end_date=otter, frequency='daily', fields=['volume'], fq='post', panel=False)
    if koala is None or koala.empty or 'code' not in koala.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1158')
    koala = koala.copy()
    if 'time' not in koala.columns:
        if isinstance(koala.index, pd.DatetimeIndex):
            wolf = koala.index.name if koala.index.name else 'time'
            koala = koala.reset_index().rename(columns={wolf: 'time'})
        else:
            koala = koala.reset_index().rename(columns={'index': 'time'})
    koala['time'] = pd.to_datetime(koala['time'])
    koala['date'] = koala['time'].dt.date
    koala = koala[koala['date'].isin(set(lion))]
    koala['volume'] = pd.to_numeric(koala['volume'], errors='coerce').astype(float)
    koala = koala[np.isfinite(koala['volume'].values)]
    if koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1158')
    dolphin = koala.pivot(index='date', columns='code', values='volume').reindex(index=lion)
    shark = dolphin.mean(axis=0, skipna=True)
    shark = shark.replace(0.0, np.nan)
    whale = dolphin.reindex(index=tiger)
    rabbit = whale.div(shark, axis=1).replace([np.inf, -np.inf], np.nan)
    bear = rabbit.max(axis=0, skipna=True)
    fox = {cat: float(bear.get(cat)) for cat in zebra if np.isfinite(bear.get(cat, np.nan))}
    return _make_factor_series(fox, date, universe=universe, name='factor1158')

def factor1159(universe, date, freq='1m', lookback=5):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = _last_n_trade_days(otter, lookback + 1)
    wolf = [pd.to_datetime(lion).date() for lion in wolf]
    if len(wolf) < lookback + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1159')
    fox = wolf[-1]
    bear = wolf[:-1]
    owl = list(universe)
    eagle = {dog: [] for dog in owl}
    hawk = {}
    for koala in bear + [fox]:
        rabbit = get_price(security=owl, start_date=koala, end_date=koala + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if rabbit is None or rabbit.empty or 'code' not in rabbit.columns:
            continue
        rabbit = rabbit.copy()
        rabbit['close'] = pd.to_numeric(rabbit['close'], errors='coerce').astype(float)
        rabbit = rabbit[np.isfinite(rabbit['close'].values) & (rabbit['close'].values > 0)]
        if rabbit.empty:
            continue
        for tiger, whale in rabbit.groupby('code', sort=False):
            sparrow = whale['close'].values.astype(float)
            if sparrow.size < 3:
                continue
            giraffe = np.diff(sparrow)
            zebra = np.sign(giraffe)
            zebra = zebra[zebra != 0]
            if zebra.size < 2:
                panda = 0
            else:
                panda = int(np.sum(zebra[1:] != zebra[:-1]))
            if koala == fox:
                hawk[tiger] = panda
            else:
                eagle[tiger].append(panda)
    dolphin = {}
    for tiger in owl:
        if tiger not in hawk:
            continue
        shark = eagle.get(tiger, [])
        if len(shark) == 0:
            continue
        cat = float(np.mean(np.asarray(shark, dtype=float)))
        turtle = float(hawk[tiger] - cat)
        if np.isfinite(turtle):
            dolphin[tiger] = turtle
    return _make_factor_series(dolphin, date, universe=universe, name='factor1159')

def factor1160(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    koala = list(universe)
    bear = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(koala)), date=fox)
    wolf = get_fundamentals(query(fox.code, fox.total_owner_equities).filter(fox.code.in_(koala)), date=fox)
    if bear is None or bear.empty or wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1160')
    bear = bear[['code', 'term_045']].drop_duplicates('code').set_index('code')
    wolf = wolf[['code', 'total_owner_equities']].drop_duplicates('code').set_index('code')
    dolphin = pd.to_numeric(bear['term_045'], errors='coerce').astype(float)
    panda = pd.to_numeric(wolf['total_owner_equities'], errors='coerce').astype(float)
    otter = sorted(set(dolphin.index) & set(panda.index))
    if len(otter) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor1160')
    dolphin = dolphin.reindex(otter)
    panda = panda.reindex(otter)
    zebra = np.isfinite(dolphin.values) & (dolphin.values > 0) & np.isfinite(panda.values) & (panda.values > 0)
    dolphin = dolphin[zebra]
    panda = panda[zebra]
    if dolphin.size < 10:
        return _make_factor_series({}, date, universe=universe, name='factor1160')
    eagle = np.log(panda.values.astype(float))
    shark = np.log(dolphin.values.astype(float))
    cat = np.column_stack([np.ones_like(shark), shark])
    try:
        tiger, dog, dog, dog = np.linalg.lstsq(cat, eagle, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1160')
    whale = eagle - cat.dot(tiger)
    giraffe = {lion: float(rabbit) for lion, rabbit in zip(dolphin.index.tolist(), whale) if np.isfinite(rabbit)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor1160')

def factor1161(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1161')

def factor1162(universe, date, m_days=20, industry_name='sw_l1'):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, int(m_days))
    otter = [pd.to_datetime(lion).date() for lion in otter]
    if len(otter) < max(5, int(m_days * 0.6)):
        return _make_factor_series({}, koala, universe=universe, name='factor1162')
    lizard = otter[0]
    zebra = otter[-1]
    tiger = list(universe)
    wolf = get_price(security=tiger, start_date=lizard, end_date=zebra, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if wolf is None or getattr(wolf, 'empty', True):
        return _make_factor_series({}, koala, universe=universe, name='factor1162')
    wolf = wolf.copy()
    if 'time' not in wolf.columns:
        wolf = wolf.reset_index().rename(columns={'index': 'time'})
    if 'code' not in wolf.columns:
        return _make_factor_series({}, koala, universe=universe, name='factor1162')
    wolf['time'] = pd.to_datetime(wolf['time'], errors='coerce')
    wolf = wolf.dropna(subset=['time'])
    if wolf.empty:
        return _make_factor_series({}, koala, universe=universe, name='factor1162')
    wolf['date'] = wolf['time'].dt.date
    wolf = wolf[wolf['date'].isin(otter)]
    wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
    wolf['pre_close'] = pd.to_numeric(wolf['pre_close'], errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        wolf['r'] = wolf['close'] / wolf['pre_close'] - 1.0
    wolf.loc[~np.isfinite(wolf['r'].values), 'r'] = np.nan
    owl = wolf.pivot(index='date', columns='code', values='r').reindex(index=otter).reindex(columns=tiger)
    cat = owl.mean(axis=0, skipna=True).replace([np.inf, -np.inf], np.nan)
    rabbit = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(tiger)), date=pd.Timestamp(koala).strftime('%Y-%m-%d'))
    if rabbit is None or rabbit.empty or 'code' not in rabbit.columns or ('term_045' not in rabbit.columns):
        return _make_factor_series({}, koala, universe=universe, name='factor1162')
    hawk = rabbit[['code', 'term_045']].drop_duplicates('code').assign(code=lambda x: x['code'].astype(str))
    hawk = pd.to_numeric(hawk.set_index('code')['term_045'], errors='coerce').astype(float)
    hawk = hawk.replace([np.inf, -np.inf], np.nan)
    dog = sorted(set(cat.dropna().index) & set(hawk.dropna().index))
    if len(dog) < 3:
        return _make_factor_series({}, koala, universe=universe, name='factor1162')
    shark = get_industry(security=dog, date=koala, df=True)
    if shark is None or getattr(shark, 'empty', True):
        return _make_factor_series({}, koala, universe=universe, name='factor1162')
    shark = shark.copy()
    if 'date' in shark.columns:
        shark = shark.drop(columns=['date'], errors='ignore')
    if 'type' in shark.columns:
        shark = shark[shark['type'].astype(str) == str(industry_name)]
    if shark.empty or 'code' not in shark.columns or 'industry_code' not in shark.columns:
        return _make_factor_series({}, koala, universe=universe, name='factor1162')
    shark['code'] = shark['code'].astype(str)
    shark['industry_code'] = shark['industry_code'].astype(str)
    eagle = shark.drop_duplicates('code', keep='last').set_index('code')['industry_code'].to_dict()
    bear = pd.DataFrame({'code': dog, 'gid': [eagle.get(panda, None) for panda in dog], 'mv': [float(hawk.get(panda, np.nan)) for panda in dog], 'ret': [float(cat.get(panda, np.nan)) for panda in dog]})
    bear = bear.dropna(subset=['gid'])
    bear = bear[np.isfinite(bear['mv'].values) & (bear['mv'].values > 0) & np.isfinite(bear['ret'].values)]
    if bear.empty:
        return _make_factor_series({}, koala, universe=universe, name='factor1162')
    bear['mvret'] = bear['mv'] * bear['ret']
    whale = bear.groupby('gid', sort=False).agg(mv_sum=('mv', 'sum'), mvret_sum=('mvret', 'sum'), n=('code', 'count'))
    bear = bear.join(whale, on='gid')
    fox = bear['mv_sum'] - bear['mv']
    sparrow = bear['mvret_sum'] - bear['mvret']
    with np.errstate(divide='ignore', invalid='ignore'):
        frog = sparrow / fox
    giraffe = pd.DataFrame({'code': bear['code'].values, 'val': frog.values})
    giraffe = giraffe.dropna(subset=['val'])
    dolphin = {turtle.code: float(turtle.val) for turtle in giraffe.itertuples(index=False)}
    return _make_factor_series(dolphin, koala, universe=universe, name='factor1162')

def factor1163(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1163')

def factor1164(universe, date, window=20):
    _set_asof_date(date)
    rabbit = _to_date(date)
    giraffe = _last_n_trade_days(rabbit, window)
    giraffe = [pd.to_datetime(wolf).date() for wolf in giraffe]
    if len(giraffe) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1164')
    tuna = list(universe)
    shark = {koala: [] for koala in tuna}
    for bear in giraffe:
        zebra = get_price(security=tuna, start_date=bear, end_date=bear + dt.timedelta(days=1), frequency='1m', fields=['close', 'volume'], fq='post', panel=False)
        if zebra is None or zebra.empty or 'code' not in zebra.columns:
            continue
        zebra = zebra.copy()
        zebra['close'] = pd.to_numeric(zebra['close'], errors='coerce').astype(float)
        zebra['volume'] = pd.to_numeric(zebra['volume'], errors='coerce').astype(float)
        zebra = zebra[np.isfinite(zebra['close'].values) & (zebra['close'].values > 0) & np.isfinite(zebra['volume'].values)]
        if zebra.empty:
            continue
        for otter, whale in zebra.groupby('code', sort=False):
            koala = whale['close'].values.astype(float)
            alpaca = whale['volume'].values.astype(float)
            panda = int(alpaca.size)
            if panda < 20:
                continue
            fox = np.cumsum(alpaca, dtype=float)
            tiger = fox.copy()
            if panda >= 6:
                tiger[5:] = fox[5:] - fox[:-5]
            salmon = int(np.argmax(tiger))
            frog = max(0, salmon - 5)
            if frog >= salmon:
                continue
            sparrow = np.arange(frog, salmon, dtype=int)
            if sparrow.size == 0:
                continue
            hawk = int(sparrow[np.argmin(tiger[sparrow])])
            if salmon + 1 >= panda:
                continue
            turtle = np.arange(salmon + 1, panda, dtype=int)
            if turtle.size == 0:
                continue
            owl = int(turtle[np.argmin(tiger[turtle])])
            cat = float(koala[hawk])
            dog = float(koala[owl])
            if not (np.isfinite(cat) and np.isfinite(dog)) or cat <= 0 or owl <= hawk:
                continue
            lizard = float((dog - cat) / cat / float(owl - hawk))
            if np.isfinite(lizard):
                shark[otter].append(lizard)
    dolphin = {}
    for otter, eagle in shark.items():
        if not eagle:
            continue
        lion = np.asarray(eagle, dtype=float)
        lion = lion[np.isfinite(lion)]
        if lion.size == 0:
            continue
        lemur = float(np.mean(lion))
        if np.isfinite(lemur):
            dolphin[otter] = lemur
    return _make_factor_series(dolphin, date, universe=universe, name='factor1164')

def factor1165(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1165')

def factor1166(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1166')

def factor1167(universe, date, freq='1m'):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = pd.to_datetime(otter).date()
    wolf = fox + dt.timedelta(days=1)
    rabbit = get_price(security=list(universe), start_date=fox, end_date=wolf, frequency='daily', fields=['close'], fq='post', panel=False)
    tiger = {}
    if rabbit is not None and (not rabbit.empty) and ('code' in rabbit.columns):
        rabbit = rabbit.copy()
        if 'time' not in rabbit.columns:
            rabbit['time'] = rabbit.index
        rabbit['time'] = pd.to_datetime(rabbit['time'])
        rabbit['date'] = rabbit['time'].dt.date
        rabbit = rabbit[rabbit['date'] == fox]
        if not rabbit.empty:
            shark = rabbit.sort_values('time').groupby('code', sort=False).tail(1)
            tiger = pd.to_numeric(shark.set_index('code')['close'], errors='coerce').astype(float).to_dict()
    bear = get_price(security=list(universe), start_date=fox, end_date=wolf, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
    if bear is None or bear.empty or 'code' not in bear.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1167')
    bear = bear.copy()
    bear['close'] = pd.to_numeric(bear['close'], errors='coerce').astype(float)
    bear['volume'] = pd.to_numeric(bear['volume'], errors='coerce').astype(float)
    bear = bear[np.isfinite(bear['close'].values) & np.isfinite(bear['volume'].values) & (bear['volume'].values > 0)]
    if bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1167')
    giraffe = {}
    for koala, zebra in bear.groupby('code', sort=False):
        lion = float(tiger.get(koala, np.nan))
        if not np.isfinite(lion):
            continue
        dolphin = zebra.groupby('close', sort=False)['volume'].sum()
        if dolphin.empty:
            continue
        turtle = float(dolphin.sum())
        if turtle <= 0 or not np.isfinite(turtle):
            continue
        sparrow = np.array(sorted(dolphin.index.values), dtype=float)
        tuna = dolphin.reindex(sparrow).values.astype(float)
        if sparrow.size < 2:
            continue
        panda = int(np.argmax(tuna))
        hawk = whale = panda
        dog = float(tuna[panda])
        while dog < 0.5 * turtle and (hawk > 0 or whale < sparrow.size - 1):
            eagle = hawk - 1 if hawk > 0 else None
            owl = whale + 1 if whale < sparrow.size - 1 else None
            lizard = float(tuna[eagle]) if eagle is not None else -1.0
            frog = float(tuna[owl]) if owl is not None else -1.0
            if lizard < 0 and frog < 0:
                break
            if frog < 0 or (lizard >= frog and lizard >= 0):
                hawk = eagle
                dog += lizard
            else:
                whale = owl
                dog += frog
        cat = float(sparrow[hawk])
        salmon = lion - cat
        if np.isfinite(salmon):
            giraffe[str(koala)] = float(salmon)
    return _make_factor_series(giraffe, date, universe=universe, name='factor1167')

def factor1168(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    lion = list(universe)
    wolf = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(lion)), date=otter)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1168')
    fox = get_history_fundamentals(security=lion, fields=[bear.term_052], watch_date=otter, count=1, interval='1q', stat_by_year=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1168')
    zebra = wolf[['code', 'term_045']].drop_duplicates('code').set_index('code')['term_045']
    zebra = pd.to_numeric(zebra, errors='coerce').astype(float)
    fox = fox.copy()
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    fox = fox.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'])
    dolphin = fox.groupby('code', sort=False).tail(1).set_index('code')['term_052']
    dolphin = pd.to_numeric(dolphin, errors='coerce').astype(float)
    koala = sorted(set(zebra.index) & set(dolphin.index))
    if len(koala) < 10:
        return _make_factor_series({}, date, universe=universe, name='factor1168')
    zebra = zebra.reindex(koala)
    whale = dolphin.reindex(koala)
    giraffe = np.isfinite(zebra.values) & (zebra.values > 0) & np.isfinite(whale.values) & (whale.values > 0)
    zebra = zebra[giraffe]
    whale = whale[giraffe]
    if zebra.size < 10:
        return _make_factor_series({}, date, universe=universe, name='factor1168')
    hawk = np.log(whale.values.astype(float))
    eagle = np.log(zebra.values.astype(float))
    cat = np.column_stack([np.ones_like(eagle), eagle])
    try:
        panda, dog, dog, dog = np.linalg.lstsq(cat, hawk, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1168')
    shark = hawk - cat.dot(panda)
    rabbit = {tiger: float(bear) for tiger, bear in zip(zebra.index.tolist(), shark) if np.isfinite(bear)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor1168')

def factor1169(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1169')

def factor1170(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1170')

def factor1171(universe, date, D=20, freq='1m', alpha=0.01):
    _set_asof_date(date)
    rabbit = _to_date(date)
    giraffe = _last_n_trade_days(rabbit, D)
    giraffe = [pd.to_datetime(wolf).date() for wolf in giraffe]
    if len(giraffe) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1171')
    frog = 2.3263478740408408 if abs(alpha - 0.01) < 1e-12 else 2.3263478740408408
    turtle = {}
    otter = {}
    for bear in giraffe:
        zebra = get_price(security=list(universe), start_date=bear, end_date=bear + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            if isinstance(zebra.index, pd.DatetimeIndex):
                shark = zebra.index.name if zebra.index.name else 'time'
                zebra = zebra.reset_index().rename(columns={shark: 'time'})
            else:
                zebra = zebra.reset_index().rename(columns={'index': 'time'})
        if 'code' not in zebra.columns:
            continue
        zebra['time'] = pd.to_datetime(zebra['time'])
        zebra = zebra.sort_values(['code', 'time'])
        zebra['close'] = pd.to_numeric(zebra['close'], errors='coerce').astype(float)
        zebra = zebra[np.isfinite(zebra['close'].values) & (zebra['close'].values > 0)]
        if zebra.empty:
            continue
        for fox, whale in zebra.groupby('code', sort=False):
            hawk = whale['close'].values.astype(float)
            if hawk.size < 6:
                continue
            sparrow = np.log(hawk[1:] / hawk[:-1])
            if sparrow.size < 5:
                continue
            sparrow = sparrow[np.isfinite(sparrow)]
            dog = int(sparrow.size)
            if dog < 5:
                continue
            owl = sparrow * sparrow
            tiger = float(np.sum(owl))
            if not np.isfinite(tiger) or tiger <= 0:
                continue
            cat = float(math.pi / 2.0 * dog / (dog - 1.0) * np.sum(np.abs(sparrow[1:] * sparrow[:-1])))
            panda = float(dog * np.sum(sparrow ** 4) / 3.0)
            if not np.isfinite(panda) or panda <= 0:
                continue
            lion = float((tiger - cat) / math.sqrt(panda))
            if not np.isfinite(lion):
                continue
            eagle = 1.0 if lion > frog else 0.0
            turtle[fox] = float(turtle.get(fox, 0.0) + eagle)
            otter[fox] = int(otter.get(fox, 0) + 1)
    dolphin = {}
    for fox in universe:
        koala = int(otter.get(fox, 0))
        if koala > 0:
            lizard = float(turtle.get(fox, 0.0) / koala)
            if np.isfinite(lizard):
                dolphin[fox] = lizard
    return _make_factor_series(dolphin, date, universe=universe, name='factor1171')

def factor1172(universe, date, Dt=20):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = _last_n_trade_days(tiger, Dt)
    lion = [pd.to_datetime(panda).date() for panda in lion]
    if len(lion) < Dt:
        return _make_factor_series({}, date, universe=universe, name='factor1172')
    zebra = lion[0]
    otter = lion[-1]
    koala = get_price(security=list(universe), start_date=zebra, end_date=otter, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1172')
    koala = koala.copy()
    if 'time' not in koala.columns:
        if isinstance(koala.index, pd.DatetimeIndex):
            wolf = koala.index.name if koala.index.name else 'time'
            koala = koala.reset_index().rename(columns={wolf: 'time'})
        else:
            koala = koala.reset_index().rename(columns={'index': 'time'})
    if 'code' not in koala.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1172')
    koala['time'] = pd.to_datetime(koala['time'])
    koala['date'] = koala['time'].dt.date
    koala = koala[koala['date'].isin(lion)]
    if koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1172')
    koala['close'] = pd.to_numeric(koala['close'], errors='coerce').astype(float)
    koala['pre_close'] = pd.to_numeric(koala['pre_close'], errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        koala['r'] = koala['close'] / koala['pre_close'] - 1.0
    koala.loc[~np.isfinite(koala['r'].values), 'r'] = np.nan
    giraffe = koala.pivot(index='date', columns='code', values='r').reindex(index=lion)
    bear = giraffe.mean(axis=1, skipna=True)
    rabbit = giraffe.std(axis=1, ddof=1, skipna=True).replace(0.0, np.nan)
    whale = giraffe.sub(bear, axis=0).div(rabbit, axis=0)
    whale = whale.replace([np.inf, -np.inf], np.nan)
    shark = (whale ** 2).mean(axis=0, skipna=True)
    cat = whale.notna().sum(axis=0)
    fox = {}
    for dog in universe:
        if dog not in shark.index:
            continue
        if int(cat.get(dog, 0)) < max(3, Dt // 2):
            continue
        dolphin = float(shark.get(dog, np.nan))
        if np.isfinite(dolphin) and dolphin > 0:
            fox[dog] = float(1.0 / dolphin)
    return _make_factor_series(fox, date, universe=universe, name='factor1172')

def factor1173(universe, date, window=20):
    _set_asof_date(date)
    shark = _to_date(date)
    eagle = _last_n_trade_days(shark, window)
    eagle = [pd.to_datetime(dolphin).date() for dolphin in eagle]
    if len(eagle) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1173')
    alpaca = 239
    zebra = {otter: [] for otter in universe}
    for whale in eagle:
        hawk = get_price(security=list(universe), start_date=whale, end_date=whale + dt.timedelta(days=1), frequency='1m', fields=['high', 'low', 'close'], fq='post', panel=False)
        if hawk is None or hawk.empty:
            continue
        hawk = hawk.copy()
        if 'time' not in hawk.columns:
            if isinstance(hawk.index, pd.DatetimeIndex):
                frog = hawk.index.name if hawk.index.name else 'time'
                hawk = hawk.reset_index().rename(columns={frog: 'time'})
            else:
                hawk = hawk.reset_index().rename(columns={'index': 'time'})
        if 'code' not in hawk.columns:
            continue
        hawk['time'] = pd.to_datetime(hawk['time'])
        hawk = hawk.sort_values(['code', 'time'])
        for wolf in ['high', 'low', 'close']:
            hawk[wolf] = pd.to_numeric(hawk[wolf], errors='coerce').astype(float)
        for fox, owl in hawk.groupby('code', sort=False):
            turtle = owl['high'].values.astype(float)
            salmon = owl['low'].values.astype(float)
            otter = owl['close'].values.astype(float)
            tuna = np.isfinite(turtle) & np.isfinite(salmon) & np.isfinite(otter) & (otter > 0)
            if tuna.sum() < 240:
                continue
            turtle, salmon, otter = (turtle[tuna], salmon[tuna], otter[tuna])
            if otter.size < 240:
                continue
            lizard = (turtle + salmon + otter) / 3.0
            dog = np.maximum(0.0, turtle[1:] - lizard[:-1])
            lion = np.maximum(0.0, lizard[:-1] - salmon[1:])
            if dog.size < alpaca or lion.size < alpaca:
                continue
            panda = dog[-alpaca:]
            koala = lion[-alpaca:]
            bear = float(np.mean(panda))
            rabbit = float(np.mean(koala))
            if not (np.isfinite(bear) and np.isfinite(rabbit)) or rabbit <= 0:
                continue
            giraffe = float(bear / rabbit * 100.0)
            if np.isfinite(giraffe):
                zebra[fox].append(giraffe)
    sparrow = {}
    for fox in universe:
        tiger = np.asarray(zebra.get(fox, []), dtype=float)
        tiger = tiger[np.isfinite(tiger)]
        if tiger.size == 0:
            continue
        cat = int(tiger.size)
        badger = np.arange(1, cat + 1, dtype=float)
        badger /= badger.sum()
        lemur = float(np.sum(badger * tiger))
        if np.isfinite(lemur):
            sparrow[fox] = lemur
    return _make_factor_series(sparrow, date, universe=universe, name='factor1173')

def factor1174(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1174')

def factor1175(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1175')

def factor1176(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1176')

def factor1177(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1177')

def factor1178(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1178')

def factor1179(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    dog = get_price(universe, start_date=koala, end_date=koala + dt.timedelta(days=1), frequency='daily', fields=['low'], fq='post', panel=False)
    if dog is None or dog.empty or 'code' not in dog.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1179')
    dog = dog.copy()
    if 'time' in dog.columns:
        dog['date'] = pd.to_datetime(dog['time']).dt.date
        dog = dog[dog['date'] == koala]
    tiger = dog.pivot(index='time', columns='code', values='low').sort_index()
    lion = tiger.iloc[-1] if tiger.shape[0] > 0 else pd.Series(dtype=float)
    panda = {cat: float(lion.get(cat)) if np.isfinite(lion.get(cat, np.nan)) else np.nan for cat in universe}
    return _make_factor_series(panda, date, universe=universe, name='factor1179')

def factor1180(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1180')

def factor1181(universe, date, h=3, K=12, delta=0.94):
    _set_asof_date(date)
    lion = _to_date(date)
    tiger = pd.Period(lion, freq='M')
    giraffe = tiger - 1
    dolphin = max(K + h + 12, 24)
    koala = get_trade_days(end_date=lion, count=dolphin * 22)
    if koala is None or len(koala) < 40:
        return _make_factor_series({}, date, universe=universe, name='factor1181')
    lizard = pd.to_datetime(koala[0]).date()
    fox = pd.to_datetime(koala[-1]).date()
    otter = get_price(security=list(universe), start_date=lizard, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1181')
    otter = otter.copy()
    if 'time' not in otter.columns:
        if isinstance(otter.index, pd.DatetimeIndex):
            rabbit = otter.index.name if otter.index.name else 'time'
            otter = otter.reset_index().rename(columns={rabbit: 'time'})
        else:
            otter = otter.reset_index().rename(columns={'index': 'time'})
    if 'code' not in otter.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1181')
    otter['time'] = pd.to_datetime(otter['time'])
    otter = otter.sort_values(['code', 'time'])
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
    otter = otter[np.isfinite(otter['close'].values) & (otter['close'].values > 0)]
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1181')
    otter['month'] = otter['time'].dt.to_period('M')
    zebra = otter.groupby(['code', 'month'], sort=False).tail(1)[['code', 'month', 'close']].copy()
    zebra = zebra[zebra['month'] <= giraffe]
    if zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1181')
    wolf = {}
    for panda, bear in zebra.groupby('code', sort=False):
        bear = bear.sort_values('month')
        dog = bear['close'].values.astype(float)
        whale = bear['month'].values
        if dog.size < K + h + 2:
            continue
        sparrow = dog[1:] / dog[:-1] - 1.0
        hawk = whale[1:]
        tuna = np.where(hawk == giraffe)[0]
        if tuna.size == 0:
            continue
        salmon = int(tuna[-1])
        if salmon < h:
            continue
        shark = int(sparrow.size)
        cat = np.zeros(shark, dtype=float)
        alpaca = np.zeros(shark, dtype=float)
        cat[0] = sparrow[0]
        alpaca[0] = sparrow[0] ** 2
        for frog in range(1, shark):
            cat[frog] = (1.0 - delta) * sparrow[frog] + delta * cat[frog - 1]
            alpaca[frog] = (1.0 - delta) * (sparrow[frog - 1] - cat[frog - 1]) ** 2 + delta * alpaca[frog - 1]
        owl = math.sqrt(alpaca[salmon]) if np.isfinite(alpaca[salmon]) and alpaca[salmon] > 0 else np.nan
        if not np.isfinite(owl) or owl == 0:
            continue
        eagle = float(np.sum(sparrow[salmon - h + 1:salmon + 1]))
        if eagle > 0:
            turtle = 1.0 / owl
        elif eagle < 0:
            turtle = -1.0 / owl
        else:
            turtle = 0.0
        if np.isfinite(turtle):
            wolf[panda] = float(turtle)
    return _make_factor_series(wolf, date, universe=universe, name='factor1181')

def factor1182(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1182')

def factor1183(universe, date, window=20):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = _last_n_trade_days(bear, window)
    rabbit = [pd.to_datetime(fox).date() for fox in rabbit]
    if len(rabbit) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1183')
    tiger = {lion: [] for lion in universe}
    for wolf in rabbit:
        giraffe = get_price(security=list(universe), start_date=wolf, end_date=wolf + dt.timedelta(days=1), frequency='1m', fields=['high', 'low', 'close'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            if isinstance(giraffe.index, pd.DatetimeIndex):
                eagle = giraffe.index.name if giraffe.index.name else 'time'
                giraffe = giraffe.reset_index().rename(columns={eagle: 'time'})
            else:
                giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
        if 'code' not in giraffe.columns:
            continue
        giraffe['time'] = pd.to_datetime(giraffe['time'])
        giraffe = giraffe.sort_values(['code', 'time'])
        for otter in ['high', 'low', 'close']:
            giraffe[otter] = pd.to_numeric(giraffe[otter], errors='coerce').astype(float)
        for koala, whale in giraffe.groupby('code', sort=False):
            shark = whale['high'].values.astype(float)
            hawk = whale['low'].values.astype(float)
            lion = whale['close'].values.astype(float)
            sparrow = np.isfinite(shark) & np.isfinite(hawk) & np.isfinite(lion) & (lion > 0)
            if sparrow.sum() < 5:
                continue
            shark, hawk, lion = (shark[sparrow], hawk[sparrow], lion[sparrow])
            if lion.size < 3:
                continue
            lizard = np.maximum(0.0, shark[1:] - lion[:-1])
            zebra = np.maximum(0.0, lion[:-1] - hawk[1:])
            turtle = float(np.sum(lizard))
            owl = float(np.sum(zebra))
            if not (np.isfinite(turtle) and np.isfinite(owl)) or owl <= 0:
                continue
            panda = float(turtle / owl * 100.0)
            if np.isfinite(panda):
                tiger[koala].append(panda)
    dolphin = {}
    for koala in universe:
        dog = np.asarray(tiger.get(koala, []), dtype=float)
        dog = dog[np.isfinite(dog)]
        if dog.size == 0:
            continue
        cat = int(dog.size)
        salmon = np.arange(1, cat + 1, dtype=float)
        salmon /= salmon.sum()
        frog = float(np.sum(salmon * dog))
        if np.isfinite(frog):
            dolphin[koala] = frog
    return _make_factor_series(dolphin, date, universe=universe, name='factor1183')

def factor1184(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1184')

def factor1185(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1185')

def factor1186(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1186')

def factor1187(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1187')

def factor1188(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1188')

def factor1189(universe, date, D=20, freq='1m', alpha=0.01):
    _set_asof_date(date)
    giraffe = _to_date(date)
    zebra = _last_n_trade_days(giraffe, D)
    zebra = [pd.to_datetime(bear).date() for bear in zebra]
    if len(zebra) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1189')
    alpaca = 2.3263478740408408 if abs(alpha - 0.01) < 1e-12 else 2.3263478740408408
    owl = {}
    whale = {}
    for rabbit in zebra:
        shark = get_price(security=list(universe), start_date=rabbit, end_date=rabbit + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if shark is None or shark.empty:
            continue
        shark = shark.copy()
        if 'time' not in shark.columns:
            if isinstance(shark.index, pd.DatetimeIndex):
                sparrow = shark.index.name if shark.index.name else 'time'
                shark = shark.reset_index().rename(columns={sparrow: 'time'})
            else:
                shark = shark.reset_index().rename(columns={'index': 'time'})
        if 'code' not in shark.columns:
            continue
        shark['time'] = pd.to_datetime(shark['time'])
        shark = shark.sort_values(['code', 'time'])
        shark['close'] = pd.to_numeric(shark['close'], errors='coerce').astype(float)
        shark = shark[np.isfinite(shark['close'].values) & (shark['close'].values > 0)]
        if shark.empty:
            continue
        for wolf, hawk in shark.groupby('code', sort=False):
            turtle = hawk['close'].values.astype(float)
            if turtle.size < 6:
                continue
            lizard = np.log(turtle[1:] / turtle[:-1])
            lizard = lizard[np.isfinite(lizard)]
            dog = int(lizard.size)
            if dog < 5:
                continue
            frog = lizard * lizard
            koala = float(np.sum(frog))
            if not np.isfinite(koala) or koala <= 0:
                continue
            cat = float(math.pi / 2.0 * dog / (dog - 1.0) * np.sum(np.abs(lizard[1:] * lizard[:-1])))
            panda = float(dog * np.sum(lizard ** 4) / 3.0)
            if not np.isfinite(panda) or panda <= 0:
                continue
            fox = float((koala - cat) / math.sqrt(panda))
            if not np.isfinite(fox):
                continue
            lion = float(np.sum(frog[lizard > 0])) if np.any(lizard > 0) else 0.0
            tiger = float(np.sum(frog[lizard < 0])) if np.any(lizard < 0) else 0.0
            otter = float(max(lion - 0.5 * koala, 0.0) - max(tiger - 0.5 * koala, 0.0))
            if not np.isfinite(otter):
                continue
            tuna = float(max(fox, 0.0) / alpaca)
            if not np.isfinite(tuna) or tuna <= 0:
                continue
            owl[wolf] = float(owl.get(wolf, 0.0) + tuna * otter)
            whale[wolf] = float(whale.get(wolf, 0.0) + tuna)
    eagle = {}
    for wolf in universe:
        dolphin = float(whale.get(wolf, 0.0))
        if dolphin > 0:
            salmon = float(owl.get(wolf, 0.0) / dolphin)
            if np.isfinite(salmon):
                eagle[wolf] = salmon
    return _make_factor_series(eagle, date, universe=universe, name='factor1189')

def factor1190(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1190')

def factor1191(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1191')

def factor1192(universe, date, freq='1m'):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = pd.to_datetime(tiger).date()
    koala = lion + dt.timedelta(days=1)
    fox = get_price(security=list(universe), start_date=lion, end_date=koala, frequency='daily', fields=['high'], fq='post', panel=False)
    zebra = {}
    if fox is not None and (not fox.empty) and ('code' in fox.columns):
        fox = fox.copy()
        if 'time' not in fox.columns:
            fox['time'] = fox.index
        fox['time'] = pd.to_datetime(fox['time'])
        fox['date'] = fox['time'].dt.date
        fox = fox[fox['date'] == lion]
        if not fox.empty:
            whale = fox.sort_values('time').groupby('code', sort=False).tail(1)
            zebra = pd.to_numeric(whale.set_index('code')['high'], errors='coerce').astype(float).to_dict()
    otter = get_price(security=list(universe), start_date=lion, end_date=koala, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
    if otter is None or otter.empty or 'code' not in otter.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1192')
    otter = otter.copy()
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
    otter['volume'] = pd.to_numeric(otter['volume'], errors='coerce').astype(float)
    otter = otter[np.isfinite(otter['close'].values) & np.isfinite(otter['volume'].values) & (otter['volume'].values > 0)]
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1192')
    wolf = {}
    for panda, bear in otter.groupby('code', sort=False):
        dolphin = float(zebra.get(panda, np.nan))
        if not np.isfinite(dolphin):
            continue
        rabbit = bear.groupby('close', sort=False)['volume'].sum()
        if rabbit.empty:
            continue
        owl = float(rabbit.sum())
        if owl <= 0 or not np.isfinite(owl):
            continue
        hawk = np.array(sorted(rabbit.index.values), dtype=float)
        salmon = rabbit.reindex(hawk).values.astype(float)
        if hawk.size < 2:
            continue
        dog = int(np.argmax(salmon))
        eagle = giraffe = dog
        cat = float(salmon[dog])
        while cat < 0.5 * owl and (eagle > 0 or giraffe < hawk.size - 1):
            shark = eagle - 1 if eagle > 0 else None
            sparrow = giraffe + 1 if giraffe < hawk.size - 1 else None
            turtle = float(salmon[shark]) if shark is not None else -1.0
            lizard = float(salmon[sparrow]) if sparrow is not None else -1.0
            if turtle < 0 and lizard < 0:
                break
            if lizard < 0 or (turtle >= lizard and turtle >= 0):
                eagle = shark
                cat += turtle
            else:
                giraffe = sparrow
                cat += lizard
        tuna = float(hawk[eagle])
        frog = float(dolphin - tuna)
        if np.isfinite(frog):
            wolf[str(panda)] = frog
    return _make_factor_series(wolf, date, universe=universe, name='factor1192')

def factor1193(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1193')

def factor1194(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1194')

def factor1195(universe, date, min_stocks=10, eps=1e-08):
    _set_asof_date(date)
    wolf = _to_date(date)
    lion = pd.Timestamp(wolf)
    fox = list(universe)
    frog = pd.Period(lion, freq='Q-DEC') - 1
    turtle = frog - 4
    shark = pd.PeriodIndex([turtle, frog], freq='Q-DEC')
    bear = get_history_fundamentals(security=fox, fields=[bear.np_parent_company_owners], watch_date=lion, count=16, interval='1q', stat_by_year=False)
    if bear is None or bear.empty or 'code' not in bear.columns or ('statDate' not in bear.columns):
        return _make_factor_series({}, wolf, universe=universe, name='factor1195')
    bear = bear.copy()
    if 'pubDate' in bear.columns:
        hawk = pd.to_datetime(bear['pubDate'], errors='coerce')
        bear = bear[hawk.notna() & (hawk <= lion)]
    bear['code'] = bear['code'].astype(str)
    bear['statDate'] = pd.to_datetime(bear['statDate'], errors='coerce')
    bear = bear.dropna(subset=['code', 'statDate'])
    if bear.empty or 'np_parent_company_owners' not in bear.columns:
        return _make_factor_series({}, wolf, universe=universe, name='factor1195')
    bear['q'] = bear['statDate'].dt.to_period('Q-DEC')
    bear = bear[bear['q'].isin(shark)]
    bear = bear.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    sparrow = bear.pivot(index='q', columns='code', values='np_parent_company_owners').reindex(index=shark, columns=fox)
    sparrow = sparrow.apply(pd.to_numeric, errors='coerce').astype(float)
    lizard = sparrow.loc[turtle]
    owl = sparrow.loc[frog]
    dolphin = pd.DataFrame({'q_curr': owl, 'q_prev': lizard}).dropna()
    if dolphin.shape[0] < int(min_stocks):
        return _make_factor_series({}, wolf, universe=universe, name='factor1195')
    dog = dolphin['q_curr'].values.astype(float)
    cat = dolphin['q_prev'].values.astype(float)
    whale = np.isfinite(dog) & np.isfinite(cat) & (dog > 0) & (cat != 0)
    if whale.sum() < int(min_stocks):
        return _make_factor_series({}, wolf, universe=universe, name='factor1195')
    zebra = dolphin.index.values[whale]
    alpaca = np.log(dog[whale] + float(eps))
    tuna = np.log(np.abs(cat[whale]) + float(eps))
    eagle = np.isfinite(tuna) & np.isfinite(alpaca)
    if eagle.sum() < int(min_stocks):
        return _make_factor_series({}, wolf, universe=universe, name='factor1195')
    zebra = zebra[eagle]
    alpaca = alpaca[eagle]
    tuna = tuna[eagle]
    panda = np.column_stack([np.ones_like(tuna), tuna])
    try:
        koala, tiger, tiger, tiger = np.linalg.lstsq(panda, alpaca, rcond=None)
        salmon = alpaca - panda.dot(koala)
    except Exception:
        return _make_factor_series({}, wolf, universe=universe, name='factor1195')
    giraffe = {str(otter): float(rabbit) for otter, rabbit in zip(zebra, salmon) if np.isfinite(rabbit)}
    return _make_factor_series(giraffe, wolf, universe=universe, name='factor1195')

def factor1196(universe, date, J=20):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, J + 1)
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    if len(koala) < J + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1196')
    hawk = koala[0]
    fox = koala[-1]
    otter = get_price(security=list(universe), start_date=hawk, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1196')
    otter = otter.copy()
    if 'time' not in otter.columns:
        if isinstance(otter.index, pd.DatetimeIndex):
            bear = otter.index.name if otter.index.name else 'time'
            otter = otter.reset_index().rename(columns={bear: 'time'})
        else:
            otter = otter.reset_index().rename(columns={'index': 'time'})
    if 'code' not in otter.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1196')
    otter['time'] = pd.to_datetime(otter['time'])
    otter['date'] = otter['time'].dt.date
    otter = otter[otter['date'].isin(koala)]
    otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
    dog = otter.pivot(index='date', columns='code', values='close').reindex(index=koala)
    wolf = {}
    for panda in universe:
        if panda not in dog.columns:
            continue
        rabbit = dog[panda].values.astype(float)
        rabbit = rabbit[np.isfinite(rabbit) & (rabbit > 0)]
        if rabbit.size < J + 1:
            continue
        whale = np.log(rabbit[1:] / rabbit[:-1])
        if whale.size < J:
            continue
        shark = whale[-J:]
        eagle = float(np.std(shark, ddof=1))
        if not np.isfinite(eagle) or eagle == 0:
            continue
        dolphin = float(rabbit[-1])
        giraffe = float(rabbit[-(J + 1)])
        zebra = float(np.mean(rabbit[-J:]))
        if not (np.isfinite(dolphin) and np.isfinite(giraffe) and np.isfinite(zebra)) or giraffe <= 0:
            continue
        cat = float((dolphin - zebra) / (eagle * giraffe))
        if np.isfinite(cat):
            wolf[panda] = cat
    return _make_factor_series(wolf, date, universe=universe, name='factor1196')

def factor1197(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1197')

def factor1198(universe, date, D=20):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = _last_n_trade_days(tiger, D + 1)
    lion = [pd.to_datetime(panda).date() for panda in lion]
    if len(lion) < D + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1198')
    whale = lion[0]
    otter = lion[-1]
    koala = get_price(security=list(universe), start_date=whale, end_date=otter, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1198')
    koala = koala.copy()
    if 'time' not in koala.columns:
        if isinstance(koala.index, pd.DatetimeIndex):
            wolf = koala.index.name if koala.index.name else 'time'
            koala = koala.reset_index().rename(columns={wolf: 'time'})
        else:
            koala = koala.reset_index().rename(columns={'index': 'time'})
    if 'code' not in koala.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1198')
    koala['time'] = pd.to_datetime(koala['time'])
    koala['date'] = koala['time'].dt.date
    koala = koala[koala['date'].isin(lion)]
    koala['close'] = pd.to_numeric(koala['close'], errors='coerce').astype(float)
    koala['pre_close'] = pd.to_numeric(koala['pre_close'], errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        koala['r'] = koala['close'] / koala['pre_close'] - 1.0
    koala.loc[~np.isfinite(koala['r'].values), 'r'] = np.nan
    zebra = koala.pivot(index='date', columns='code', values='r').reindex(index=lion)
    fox = {}
    for cat in universe:
        if cat not in zebra.columns:
            continue
        rabbit = zebra[cat].values.astype(float)
        rabbit = rabbit[np.isfinite(rabbit)]
        if rabbit.size < D:
            continue
        giraffe = rabbit[-D:]
        bear = float(np.mean(giraffe))
        dolphin = float(np.var(giraffe, ddof=1))
        if not (np.isfinite(bear) and np.isfinite(dolphin)) or bear == 0:
            continue
        dog = float(dolphin / abs(bear))
        if np.isfinite(dog):
            fox[cat] = dog
    return _make_factor_series(fox, date, universe=universe, name='factor1198')

def factor1199(universe, date, window=20):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = _last_n_trade_days(fox, window)
    wolf = [pd.to_datetime(koala).date() for koala in wolf]
    if len(wolf) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1199')
    zebra = {panda: [] for panda in universe}
    for otter in wolf:
        bear = get_price(security=list(universe), start_date=otter, end_date=otter + dt.timedelta(days=1), frequency='1m', fields=['high', 'low', 'close'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        if 'code' not in bear.columns:
            continue
        for lion in ['high', 'low', 'close']:
            bear[lion] = pd.to_numeric(bear[lion], errors='coerce').astype(float)
        bear = bear[np.isfinite(bear['high'].values) & np.isfinite(bear['low'].values) & np.isfinite(bear['close'].values) & (bear['close'].values > 0)]
        if bear.empty:
            continue
        dolphin = (bear['high'].values - bear['low'].values) / bear['close'].values
        rabbit = pd.DataFrame({'code': bear['code'].values, 'elder': dolphin})
        rabbit = rabbit[np.isfinite(rabbit['elder'].values)]
        if rabbit.empty:
            continue
        giraffe = rabbit.groupby('code', sort=False)['elder'].mean()
        for tiger, shark in giraffe.items():
            if np.isfinite(shark):
                zebra[tiger].append(float(shark))
    whale = {}
    for tiger in universe:
        dog = np.asarray(zebra.get(tiger, []), dtype=float)
        dog = dog[np.isfinite(dog)]
        if dog.size == 0:
            continue
        cat = int(dog.size)
        hawk = np.arange(1, cat + 1, dtype=float)
        hawk /= hawk.sum()
        eagle = float(np.sum(hawk * dog))
        if np.isfinite(eagle):
            whale[tiger] = eagle
    return _make_factor_series(whale, date, universe=universe, name='factor1199')

def factor1200(universe, date, window_long=120, window_short=20, n_neighbors=9, proj_dim=16, cand_size=400, seed=7, min_obs_ratio=0.7, chunk_size=800):
    _set_asof_date(date)
    frog = _to_date(date)
    goat = int(window_long)
    horse = int(window_short)
    if goat < 20:
        return _make_factor_series({}, date, universe=universe, name='factor1200')
    salmon = _last_n_trade_days(frog, goat + 1)
    if len(salmon) < goat + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1200')
    tuna = pd.to_datetime(salmon[-goat:]).normalize()
    crab = tuna[0].strftime('%Y-%m-%d')
    badger = (tuna[-1] + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    ant = list(universe)
    if not ant:
        return _make_factor_series({}, date, universe=universe, name='factor1200')

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    gecko = []
    for zebra in _chunks(ant, int(chunk_size)):
        alpaca = get_price(security=zebra, start_date=crab, end_date=badger, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
        if alpaca is None or alpaca.empty:
            continue
        alpaca = alpaca.copy()
        if 'time' not in alpaca.columns:
            alpaca = alpaca.reset_index().rename(columns={'index': 'time'})
        if 'code' not in alpaca.columns:
            if len(zebra) == 1:
                alpaca['code'] = zebra[0]
            else:
                continue
        alpaca['date'] = pd.to_datetime(alpaca['time']).dt.normalize()
        alpaca = alpaca[alpaca['date'].isin(set(tuna))]
        if alpaca.empty:
            continue
        alpaca['close'] = pd.to_numeric(alpaca['close'], errors='coerce').astype(float)
        alpaca['pre_close'] = pd.to_numeric(alpaca['pre_close'], errors='coerce').astype(float)
        with np.errstate(divide='ignore', invalid='ignore'):
            alpaca['ret'] = alpaca['close'] / alpaca['pre_close'] - 1.0
        alpaca['ret'] = alpaca['ret'].replace([np.inf, -np.inf], np.nan)
        gecko.append(alpaca[['date', 'code', 'ret']])
    if not gecko:
        return _make_factor_series({}, date, universe=universe, name='factor1200')
    lemur = pd.concat(gecko, ignore_index=True)
    urchin = lemur.pivot(index='date', columns='code', values='ret').reindex(index=tuna, columns=ant)
    lion = int(urchin.shape[0])
    if lion < 20:
        return _make_factor_series({}, date, universe=universe, name='factor1200')
    mole = int(max(10, np.floor(float(min_obs_ratio) * lion)))
    elk = [shark for shark in urchin.columns if int(urchin[shark].notna().sum()) >= mole]
    if len(elk) < max(10, n_neighbors + 1):
        return _make_factor_series({}, date, universe=universe, name='factor1200')
    urchin = urchin[elk]
    sparrow = list(urchin.columns)
    panda = int(len(sparrow))
    owl = urchin.mean(axis=0, skipna=True)
    donkey = urchin.fillna(owl)
    otter = donkey.to_numpy(dtype=np.float32)
    narwhal = owl.to_numpy(dtype=np.float32)[None, :]
    fox = otter - narwhal
    walrus = np.std(fox, axis=0, ddof=1, keepdims=True).astype(np.float32)
    walrus[walrus <= 0] = 1.0
    wolf = (fox / walrus).astype(np.float32)
    cat = wolf.T
    vulture = np.random.RandomState(int(seed))
    lizard = int(max(4, proj_dim))
    koala = vulture.normal(size=(cat.shape[1], lizard)).astype(np.float32)
    dog = (cat @ koala).astype(np.float32)
    seal = np.linalg.norm(dog, axis=1)
    seal = np.where(seal > 0, seal, 1.0).astype(np.float32)
    dog = (dog.T / seal).T
    quail = None
    try:
        from sklearn.neighbors import NearestNeighbors
        raccoon = NearestNeighbors(n_neighbors=min(int(n_neighbors) + 1, panda), metric='cosine', algorithm='auto')
        raccoon.fit(dog)
        bear, iguana = raccoon.kneighbors(dog, return_distance=True)
        quail = []
        for hyena in range(panda):
            giraffe = [jaguar for jaguar in iguana[hyena].tolist() if jaguar != hyena]
            quail.append(giraffe[:int(n_neighbors)])
    except Exception:
        quail = []
        eagle = int(max(cand_size, int(n_neighbors) * 10))
        rabbit = np.arange(panda, dtype=int)
        for hyena in range(panda):
            if panda <= 1:
                quail.append([])
                continue
            if eagle >= panda - 1:
                hawk = rabbit[rabbit != hyena]
            else:
                hawk = vulture.choice(rabbit[rabbit != hyena], size=eagle, replace=False)
            bee = (dog[hawk] @ dog[hyena]).astype(np.float32)
            kangaroo = min(int(n_neighbors), hawk.size)
            if kangaroo <= 0:
                quail.append([])
                continue
            deer = np.argpartition(bee, -kangaroo)[-kangaroo:]
            deer = deer[np.argsort(bee[deer])[::-1]]
            quail.append(hawk[deer].tolist())
    tiger = urchin.to_numpy(dtype=float)
    camel = {}
    mink = int(max(5, min(horse, lion)))
    for hyena in range(panda):
        dolphin = [hyena] + quail[hyena]
        if len(dolphin) < 3:
            continue
        whale = tiger[:, dolphin]
        penguin = np.isfinite(whale).sum(axis=1)
        turkey = penguin >= 3
        if int(turkey.sum()) < 10:
            continue
        llama = np.nanmean(whale, axis=1)
        turtle = np.nanmean(np.abs(whale - llama[:, None]), axis=1)
        turtle[~turkey] = np.nan
        ferret = turtle[np.isfinite(turtle)]
        if ferret.size < 10:
            continue
        octopus = float(np.mean(ferret))
        yak = float(np.std(ferret, ddof=1)) if ferret.size > 1 else 0.0
        if not np.isfinite(octopus) or not np.isfinite(yak) or yak == 0:
            continue
        mouse = (turtle - octopus) / yak
        newt = mouse[np.isfinite(mouse)]
        if newt.size < 5:
            continue
        kangaroo = int(min(mink, newt.size))
        beaver = -float(np.mean(newt[-kangaroo:]))
        if np.isfinite(beaver):
            camel[sparrow[hyena]] = float(beaver)
    return _make_factor_series(camel, date, universe=universe, name='factor1200')

def factor1201(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1201')

def factor1202(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = get_history_fundamentals(security=universe, fields=[wolf.term_049], watch_date=otter, count=1, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1202')
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    wolf = wolf.sort_values('statDate').drop_duplicates(['code'], keep='last').set_index('code')
    bear = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe)), date=otter)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1202')
    bear = bear.set_index('code')
    fox = wolf[['term_049']].join(bear[['term_045']], how='inner')
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1202')
    giraffe = 1e-08
    lion = fox['term_049'].astype(float)
    whale = fox['term_045'].astype(float)
    dolphin = np.isfinite(lion.values) & np.isfinite(whale.values) & (whale.values > 0)
    if dolphin.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1202')
    lion = lion[dolphin]
    whale = whale[dolphin]
    lizard = np.log(np.abs(lion.values) + giraffe)
    hawk = np.log(whale.values)
    owl = (lion.values < 0).astype(float)
    shark = np.isfinite(lizard) & np.isfinite(hawk) & np.isfinite(owl)
    if shark.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1202')
    koala = list(lion.index[shark])
    frog = lizard[shark]
    sparrow = hawk[shark]
    turtle = owl[shark]
    cat = np.column_stack([np.ones_like(sparrow), sparrow, turtle])
    try:
        panda, dog, dog, dog = np.linalg.lstsq(cat, frog, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1202')
    eagle = frog - cat.dot(panda)
    zebra = {tiger: float(rabbit) for tiger, rabbit in zip(koala, eagle) if np.isfinite(rabbit)}
    return _make_factor_series(zebra, date, universe=universe, name='factor1202')

def factor1203(universe, date, snr_freq='1m', snr_win_long=60, rev_window=20, chunk_size=600):
    _set_asof_date(date)
    fox = _to_date(date)
    beaver = list(universe)
    if not beaver:
        return _make_factor_series({}, date, universe=universe, name='factor1203')
    ferret = int(snr_win_long)
    badger = fox
    zebra = fox + dt.timedelta(days=1)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]

    def _snr_from_prices(p, w):
        if p is None:
            return np.nan
        p = np.asarray(p, dtype=float)
        p = p[np.isfinite(p) & (p > 0)]
        if p.size < max(20, w + 5):
            return np.nan
        w = int(min(w, p.size))
        if w < 10:
            return np.nan
        cat = np.ones(w, dtype=float) / float(w)
        koala = np.convolve(p, cat, mode='valid')
        tiger = p[w - 1:]
        if koala.size < 10 or tiger.size != koala.size:
            return np.nan
        panda = tiger - koala
        lion = float(np.std(koala, ddof=1))
        dog = float(np.std(panda, ddof=1))
        if not (np.isfinite(lion) and np.isfinite(dog)) or dog <= 0 or lion <= 0:
            return np.nan
        return float(math.log(lion / dog))
    frog = {}
    for cat in _chunks(beaver, int(chunk_size)):
        rabbit = get_price(security=cat, start_date=badger, end_date=zebra, frequency=snr_freq, fields=['close'], fq='post', panel=False)
        if rabbit is None or rabbit.empty:
            continue
        rabbit = rabbit.copy()
        if 'time' not in rabbit.columns:
            rabbit = rabbit.reset_index().rename(columns={'index': 'time'})
        if 'code' not in rabbit.columns:
            if len(cat) == 1:
                rabbit['code'] = cat[0]
            else:
                continue
        rabbit['time'] = pd.to_datetime(rabbit['time'])
        rabbit['close'] = pd.to_numeric(rabbit['close'], errors='coerce').astype(float)
        rabbit = rabbit[np.isfinite(rabbit['close'].values) & (rabbit['close'].values > 0)]
        if rabbit.empty:
            continue
        rabbit = rabbit.sort_values(['code', 'time'])
        for tiger, shark in rabbit.groupby('code', sort=False):
            camel = _snr_from_prices(shark['close'].values, ferret)
            if np.isfinite(camel):
                frog[tiger] = float(camel)
    if not frog:
        return _make_factor_series({}, date, universe=universe, name='factor1203')
    bear = _last_n_trade_days(fox, int(rev_window) + 1)
    if len(bear) < int(rev_window) + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1203')
    wolf = [pd.to_datetime(otter).date() for otter in bear]
    lemur = wolf[0]
    dolphin = wolf[-1] + dt.timedelta(days=1)
    lion = sorted(frog.keys())
    giraffe = get_price(security=lion, start_date=lemur, end_date=dolphin, frequency='daily', fields=['close'], fq='post', panel=False)
    if giraffe is None or giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1203')
    giraffe = giraffe.copy()
    if 'time' not in giraffe.columns:
        giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
    if 'code' not in giraffe.columns:
        if len(lion) == 1:
            giraffe['code'] = lion[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1203')
    giraffe['date'] = pd.to_datetime(giraffe['time']).dt.date
    giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
    giraffe = giraffe[giraffe['date'].isin(wolf)]
    if giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1203')
    panda = giraffe.pivot(index='date', columns='code', values='close').reindex(index=wolf, columns=lion)
    owl = panda.pct_change().replace([np.inf, -np.inf], np.nan)
    eagle = owl.iloc[-int(rev_window):]
    turtle = {}
    hawk = max(5, int(0.7 * int(rev_window)))
    for tiger in lion:
        sparrow = eagle[tiger].values.astype(float)
        sparrow = sparrow[np.isfinite(sparrow)]
        if sparrow.size < hawk:
            continue
        camel = -float(np.sum(sparrow[-int(rev_window):])) if sparrow.size >= int(rev_window) else -float(np.sum(sparrow))
        if np.isfinite(camel):
            turtle[tiger] = float(camel)
    koala = sorted(set(turtle.keys()) & set(frog.keys()))
    if len(koala) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1203')
    alpaca = np.array([frog[dog] for dog in koala], dtype=float)
    tuna = float(np.nanmin(alpaca))
    salmon = float(np.nanmax(alpaca))
    whale = {}
    for dog in koala:
        lizard = float(frog[dog])
        sparrow = float(turtle[dog])
        if salmon == tuna:
            donkey = 1.0
        else:
            donkey = (lizard - tuna) / (salmon - tuna)
            donkey = max(0.0, min(1.0, float(donkey)))
        camel = donkey * sparrow
        if np.isfinite(camel):
            whale[dog] = float(camel)
    return _make_factor_series(whale, date, universe=universe, name='factor1203')

def factor1204(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1204')

def factor1205(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1205')

def factor1206(universe, date, D=40, batch_size=800):
    _set_asof_date(date)
    lion = _to_date(date)
    otter = _last_n_trade_days(lion, D)
    if len(otter) < max(5, D // 2):
        return _make_factor_series({}, date, universe=universe, name='factor1206')
    fox = pd.to_datetime(otter).normalize()
    koala = set(fox)
    hawk = fox[0].strftime('%Y-%m-%d')
    bear = fox[-1].strftime('%Y-%m-%d')

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]

    def _ensure_time_code(df, single_code=None):
        df = df.copy()
        if 'time' not in df.columns:
            if isinstance(df.index, pd.DatetimeIndex):
                df = df.reset_index().rename(columns={'index': 'time'})
            else:
                df = df.reset_index().rename(columns={'index': 'time'})
        if 'code' not in df.columns:
            if single_code is not None:
                df['code'] = single_code
            else:
                return None
        return df
    whale = max(5, D // 2)
    rabbit = {}
    for dog in _chunks(list(universe), batch_size):
        wolf = get_price(security=dog, start_date=hawk, end_date=bear, frequency='daily', fields=['close', 'pre_close', 'volume'], fq='post', panel=False)
        if wolf is None or wolf.empty:
            continue
        wolf = _ensure_time_code(wolf, single_code=dog[0] if len(dog) == 1 else None)
        if wolf is None or wolf.empty:
            continue
        wolf['date'] = pd.to_datetime(wolf['time']).dt.normalize()
        wolf = wolf[wolf['date'].isin(koala)]
        if wolf.empty:
            continue
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf['pre_close'] = pd.to_numeric(wolf['pre_close'], errors='coerce').astype(float)
        wolf['volume'] = pd.to_numeric(wolf['volume'], errors='coerce').astype(float)
        shark = wolf['close'] / wolf['pre_close'] - 1.0
        cat = wolf['volume'] * wolf['close']
        eagle = cat / np.abs(shark)
        eagle = eagle.replace([np.inf, -np.inf], np.nan)
        zebra = np.isfinite(eagle.values) & np.isfinite(cat.values) & (cat.values > 0) & np.isfinite(shark.values) & (shark.values != 0)
        wolf['ratio'] = np.where(zebra, eagle.values.astype(float), np.nan)
        giraffe = wolf.groupby('code')['ratio']
        dolphin = giraffe.mean()
        panda = giraffe.count()
        for tiger in dolphin.index:
            if int(panda.loc[tiger]) < whale:
                continue
            sparrow = float(dolphin.loc[tiger])
            if np.isfinite(sparrow):
                rabbit[tiger] = sparrow
    return _make_factor_series(rabbit, date, universe=universe, name='factor1206')

def factor1207(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    turtle = pd.Period(lion, freq='M')
    eagle = dt.date(turtle.year, turtle.month, 1)
    sparrow = dt.date(turtle.year + 1, 1, 1) if turtle.month == 12 else dt.date(turtle.year, turtle.month + 1, 1)
    shark = sparrow - dt.timedelta(days=1)
    otter = list(get_trade_days(start_date=eagle, end_date=shark))
    if len(otter) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1207')
    koala = [pd.to_datetime(tiger).date() for tiger in otter]
    frog = koala[0].strftime('%Y-%m-%d')
    wolf = koala[-1].strftime('%Y-%m-%d')
    fox = get_price(security=universe, start_date=frog, end_date=wolf, frequency='daily', fields=['open', 'high', 'low', 'close'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1207')
    if 'time' in fox.columns:
        fox['date'] = pd.to_datetime(fox['time']).dt.date
        owl = fox.pivot(index='date', columns='code', values='open')
        rabbit = fox.pivot(index='date', columns='code', values='high')
        zebra = fox.pivot(index='date', columns='code', values='low')
        cat = fox.pivot(index='date', columns='code', values='close')
    else:
        owl = fox[['open']].copy()
        rabbit = fox[['high']].copy()
        zebra = fox[['low']].copy()
        cat = fox[['close']].copy()
        giraffe = pd.to_datetime(owl.index).date
        for lemur in (owl, rabbit, zebra, cat):
            lemur.index = giraffe
            lemur.columns = [universe[0]]
    owl = owl.reindex(koala).astype(float)
    rabbit = rabbit.reindex(koala).astype(float)
    zebra = zebra.reindex(koala).astype(float)
    cat = cat.reindex(koala).astype(float)
    hawk = np.maximum(owl, cat)
    whale = np.minimum(owl, cat)
    tuna = rabbit - hawk
    dolphin = whale - zebra
    lizard = (tuna + dolphin) / cat
    lizard = lizard.replace([np.inf, -np.inf], np.nan)
    salmon = lizard.std(axis=0, ddof=1, skipna=True)
    dog = np.isfinite(lizard.values).sum(axis=0)
    bear = {}
    for panda in universe:
        if panda not in salmon.index:
            continue
        if int(dog[salmon.index.get_loc(panda)]) < 3:
            continue
        alpaca = salmon.get(panda, np.nan)
        if np.isfinite(alpaca):
            bear[panda] = float(alpaca)
    return _make_factor_series(bear, date, universe=universe, name='factor1207')

def factor1208(universe, date, m=20, year_len=252):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = _last_n_trade_days(koala, m)
    bear = _last_n_trade_days(koala, year_len)
    if len(fox) < m or len(bear) < 30:
        return _make_factor_series({}, date, universe=universe, name='factor1208')
    otter = [pd.to_datetime(lion).date() for lion in fox]
    wolf = [pd.to_datetime(lion).date() for lion in bear]
    eagle = wolf[0].strftime('%Y-%m-%d')
    giraffe = wolf[-1].strftime('%Y-%m-%d')
    rabbit = get_price(security=universe, start_date=eagle, end_date=giraffe, frequency='daily', fields=['volume'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1208')
    if 'time' in rabbit.columns:
        rabbit['date'] = pd.to_datetime(rabbit['time']).dt.date
        sparrow = rabbit.pivot(index='date', columns='code', values='volume')
    else:
        sparrow = rabbit[['volume']].copy()
        sparrow.index = pd.to_datetime(sparrow.index).date
        sparrow.columns = [universe[0]]
    sparrow = sparrow.reindex(wolf).astype(float).replace([np.inf, -np.inf], np.nan)
    shark = sparrow.rolling(window=int(year_len), min_periods=30).mean()
    cat = sparrow / shark
    cat = cat.replace([np.inf, -np.inf], np.nan)
    dog = cat.reindex(otter)
    whale = dog.mean(axis=0, skipna=True)
    panda = np.isfinite(dog.values).sum(axis=0)
    zebra = {}
    for dolphin, tiger in enumerate(whale.index):
        if int(panda[dolphin]) <= 0:
            continue
        hawk = whale.iloc[dolphin]
        if np.isfinite(hawk):
            zebra[tiger] = float(hawk)
    return _make_factor_series(zebra, date, universe=universe, name='factor1208')

def factor1209(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1209')

def factor1210(universe, date, freq='1m', chunk_size=600):
    _set_asof_date(date)
    tiger = _to_date(date)
    dolphin = list(universe)
    if not dolphin:
        return _make_factor_series({}, date, universe=universe, name='factor1210')
    zebra = tiger
    koala = tiger + dt.timedelta(days=1)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    otter = {}
    for cat in _chunks(dolphin, int(chunk_size)):
        lion = get_price(security=cat, start_date=zebra, end_date=koala, frequency=freq, fields=['close'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion = lion.reset_index().rename(columns={'index': 'time'})
        if 'code' not in lion.columns:
            if len(cat) == 1:
                lion['code'] = cat[0]
            else:
                continue
        lion['time'] = pd.to_datetime(lion['time'])
        lion['close'] = pd.to_numeric(lion['close'], errors='coerce').astype(float)
        lion = lion[np.isfinite(lion['close'].values) & (lion['close'].values > 0)]
        if lion.empty:
            continue
        lion = lion.sort_values(['code', 'time'])
        for panda, wolf in lion.groupby('code', sort=False):
            giraffe = wolf['close'].values.astype(float)
            if giraffe.size < 10:
                continue
            rabbit = int(np.argmin(giraffe))
            bear = int(np.argmax(giraffe))
            if rabbit == bear:
                continue
            if rabbit < bear:
                fox = float(giraffe[rabbit])
                dog = float(giraffe[bear])
            else:
                fox = float(giraffe[bear])
                dog = float(giraffe[rabbit])
            if not np.isfinite(fox) or not np.isfinite(dog) or fox <= 0:
                continue
            whale = (fox - dog) / fox
            if np.isfinite(whale):
                otter[panda] = float(whale)
    return _make_factor_series(otter, date, universe=universe, name='factor1210')

def factor1211(universe, date, alpha=0.05, window=20, freq='1m', chunk_size=200):
    _set_asof_date(date)
    fox = _to_date(date)
    camel = int(window)
    if camel < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1211')
    rabbit = _last_n_trade_days(fox, camel)
    if len(rabbit) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1211')
    bear = [pd.to_datetime(koala).date() for koala in rabbit]
    wolf = set(bear)
    owl = bear[0]
    zebra = bear[-1] + dt.timedelta(days=1)
    frog = list(universe)
    if not frog:
        return _make_factor_series({}, date, universe=universe, name='factor1211')

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    turtle = {}
    panda = {}
    for cat in _chunks(frog, int(chunk_size)):
        giraffe = get_price(security=cat, start_date=owl, end_date=zebra, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
        if 'code' not in giraffe.columns:
            if len(cat) == 1:
                giraffe['code'] = cat[0]
            else:
                continue
        giraffe['time'] = pd.to_datetime(giraffe['time'])
        giraffe['date'] = giraffe['time'].dt.date
        giraffe = giraffe[giraffe['date'].isin(wolf)]
        if giraffe.empty:
            continue
        giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
        giraffe['volume'] = pd.to_numeric(giraffe['volume'], errors='coerce').astype(float)
        giraffe = giraffe.dropna(subset=['close', 'volume'])
        giraffe = giraffe[np.isfinite(giraffe['close'].values) & (giraffe['close'].values > 0) & np.isfinite(giraffe['volume'].values)]
        if giraffe.empty:
            continue
        giraffe = giraffe.sort_values(['code', 'date', 'time'])
        for (tiger, otter), whale in giraffe.groupby(['code', 'date'], sort=False):
            eagle = whale['close'].values.astype(float)
            tuna = whale['volume'].values.astype(float)
            if eagle.size < 8 or tuna.size != eagle.size:
                continue
            sparrow = eagle[1:] / eagle[:-1] - 1.0
            lemur = tuna[1:]
            shark = np.isfinite(sparrow) & np.isfinite(lemur) & (lemur > 0)
            if shark.sum() < 5:
                continue
            sparrow = sparrow[shark]
            lemur = lemur[shark]
            alpaca = float(np.sum(lemur))
            if not np.isfinite(alpaca) or alpaca <= 0:
                continue
            beaver = lemur / alpaca
            badger = sparrow * beaver
            badger = badger[np.isfinite(badger)]
            if badger.size < 5:
                continue
            hawk = float(np.quantile(badger, float(alpha)))
            lizard = badger[badger <= hawk]
            if lizard.size == 0:
                continue
            lion = float(np.mean(lizard))
            if np.isfinite(lion):
                turtle[tiger] = float(turtle.get(tiger, 0.0) + lion)
                panda[tiger] = int(panda.get(tiger, 0) + 1)
    dolphin = {}
    for tiger in frog:
        dog = int(panda.get(tiger, 0))
        if dog <= 0:
            continue
        salmon = float(turtle.get(tiger, 0.0)) / float(dog)
        if np.isfinite(salmon):
            dolphin[tiger] = float(salmon)
    return _make_factor_series(dolphin, date, universe=universe, name='factor1211')

def factor1212(universe, date, L=20, Dt=20, chunk_size=1200):
    _set_asof_date(date)
    bear = _to_date(date)
    narwhal = max(int(L), int(Dt))
    zebra = _last_n_trade_days(bear, narwhal)
    if len(zebra) < max(5, int(0.6 * narwhal)):
        return _make_factor_series({}, date, universe=universe, name='factor1212')
    giraffe = pd.to_datetime(zebra).normalize()
    rabbit = set(giraffe)
    hyena = giraffe[0].strftime('%Y-%m-%d')
    sparrow = (giraffe[-1] + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    ferret = list(universe)
    if not ferret:
        return _make_factor_series({}, date, universe=universe, name='factor1212')

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    turtle = []
    for lion in _chunks(ferret, int(chunk_size)):
        shark = get_price(security=lion, start_date=hyena, end_date=sparrow, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
        if shark is None or shark.empty:
            continue
        shark = shark.copy()
        if 'time' not in shark.columns:
            shark = shark.reset_index().rename(columns={'index': 'time'})
        if 'code' not in shark.columns:
            if len(lion) == 1:
                shark['code'] = lion[0]
            else:
                continue
        shark['date'] = pd.to_datetime(shark['time']).dt.normalize()
        shark = shark[shark['date'].isin(rabbit)]
        if shark.empty:
            continue
        shark['close'] = pd.to_numeric(shark['close'], errors='coerce').astype(float)
        shark['pre_close'] = pd.to_numeric(shark['pre_close'], errors='coerce').astype(float)
        with np.errstate(divide='ignore', invalid='ignore'):
            shark['ret'] = shark['close'] / shark['pre_close'] - 1.0
        shark['ret'] = shark['ret'].replace([np.inf, -np.inf], np.nan)
        turtle.append(shark[['date', 'code', 'ret']])
    if not turtle:
        return _make_factor_series({}, date, universe=universe, name='factor1212')
    eagle = pd.concat(turtle, ignore_index=True)
    badger = eagle.pivot(index='date', columns='code', values='ret').reindex(index=giraffe, columns=ferret)
    salmon = int(max(5, 0.7 * len(giraffe)))
    mole = [koala for koala in badger.columns if int(badger[koala].notna().sum()) >= salmon]
    if len(mole) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1212')
    badger = badger[mole]
    wolf = list(badger.columns)
    panda = int(badger.shape[0])
    cat = int(len(wolf))
    if panda < 5 or cat < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1212')
    tuna = badger.mean(axis=0, skipna=True)
    donkey = badger.std(axis=0, ddof=1, skipna=True).replace(0.0, np.nan)
    penguin = (badger - tuna) / donkey
    penguin = penguin.replace([np.inf, -np.inf], np.nan).fillna(0.0)
    tiger = penguin.to_numpy(dtype=np.float32)
    iguana = tiger.sum(axis=1)
    hawk = tiger.T.dot(iguana)
    gecko = (tiger * tiger).sum(axis=0)
    jaguar = hawk - gecko
    whale = float(max(panda - 1, 1))
    beaver = jaguar / whale / float(cat - 1)
    beaver = np.clip(beaver, -0.999, 0.999)
    dolphin = 2.0 * (1.0 - beaver)
    with np.errstate(divide='ignore', invalid='ignore'):
        dog = 1.0 / dolphin
    dog[~np.isfinite(dog)] = np.nan
    alpaca = badger.mean(axis=1, skipna=True)
    lemur = badger.std(axis=1, ddof=1, skipna=True).replace(0.0, np.nan)
    quail = badger.sub(alpaca, axis=0).div(lemur, axis=0).replace([np.inf, -np.inf], np.nan)
    octopus = (quail ** 2).mean(axis=0, skipna=True)
    otter = quail.notna().sum(axis=0)
    owl = {}
    for lizard, fox in enumerate(wolf):
        camel = float(dog[lizard]) if lizard < dog.size else np.nan
        if not np.isfinite(camel):
            continue
        if int(otter.get(fox, 0)) < max(3, int(Dt) // 2):
            continue
        frog = float(octopus.get(fox, np.nan))
        if not np.isfinite(frog) or frog <= 0:
            continue
        kangaroo = 1.0 / frog
        llama = 0.5 * camel + 0.5 * float(kangaroo)
        if np.isfinite(llama):
            owl[fox] = float(llama)
    return _make_factor_series(owl, date, universe=universe, name='factor1212')

def factor1213(universe, date, window=20, freq='1m', chunk_size=200):
    _set_asof_date(date)
    otter = _to_date(date)
    tuna = int(window)
    bear = _last_n_trade_days(otter, tuna)
    if len(bear) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1213')
    wolf = [pd.to_datetime(lion).date() for lion in bear]
    fox = set(wolf)
    turtle = wolf[0]
    dolphin = wolf[-1] + dt.timedelta(days=1)
    lizard = list(universe)
    if not lizard:
        return _make_factor_series({}, date, universe=universe, name='factor1213')

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    owl = {}
    for panda in _chunks(lizard, int(chunk_size)):
        giraffe = get_price(security=panda, start_date=turtle, end_date=dolphin, frequency=freq, fields=['close'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
        if 'code' not in giraffe.columns:
            if len(panda) == 1:
                giraffe['code'] = panda[0]
            else:
                continue
        giraffe['time'] = pd.to_datetime(giraffe['time'])
        giraffe['date'] = giraffe['time'].dt.date
        giraffe = giraffe[giraffe['date'].isin(fox)]
        if giraffe.empty:
            continue
        giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
        giraffe = giraffe[np.isfinite(giraffe['close'].values) & (giraffe['close'].values > 0)]
        if giraffe.empty:
            continue
        giraffe = giraffe.sort_values(['code', 'date', 'time'])
        for (tiger, koala), shark in giraffe.groupby(['code', 'date'], sort=False):
            hawk = shark['close'].values.astype(float)
            if hawk.size < 5:
                continue
            zebra = hawk[1:] - hawk[:-1]
            rabbit = int(zebra.size)
            if rabbit <= 0:
                continue
            sparrow = float(np.sum(zebra > 0)) / float(rabbit)
            if np.isfinite(sparrow):
                owl.setdefault(tiger, []).append(sparrow)
    whale = {}
    for tiger, eagle in owl.items():
        if not eagle:
            continue
        dog = np.asarray(eagle, dtype=float)
        dog = dog[np.isfinite(dog)]
        if dog.size == 0:
            continue
        cat = int(dog.size)
        salmon = np.arange(1, cat + 1, dtype=float)
        salmon /= float(salmon.sum())
        frog = float(np.sum(salmon * dog))
        if np.isfinite(frog):
            whale[tiger] = frog
    return _make_factor_series(whale, date, universe=universe, name='factor1213')

def factor1214(universe, date, N=60):
    _set_asof_date(date)
    rabbit = _to_date(date)
    zebra = _last_n_trade_days(rabbit, N + 1)
    if len(zebra) < N + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1214')
    giraffe = [pd.to_datetime(bear).date() for bear in zebra]
    whale = get_fundamentals(query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(universe)), date=rabbit)
    if whale is None or whale.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1214')
    whale = whale.set_index('code')
    lizard = whale['circulating_cap'].astype(float).to_dict()
    frog = giraffe[0].strftime('%Y-%m-%d')
    shark = giraffe[-1].strftime('%Y-%m-%d')
    dolphin = get_price(security=universe, start_date=frog, end_date=shark, frequency='daily', fields=['close', 'volume'], fq='post', panel=False)
    if dolphin is None or dolphin.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1214')
    if 'time' in dolphin.columns:
        dolphin['date'] = pd.to_datetime(dolphin['time']).dt.date
        fox = dolphin.pivot(index='date', columns='code', values='close')
        alpaca = dolphin.pivot(index='date', columns='code', values='volume')
    else:
        fox = dolphin[['close']].copy()
        fox.index = pd.to_datetime(fox.index).date
        fox.columns = [universe[0]]
        alpaca = dolphin[['volume']].copy()
        alpaca.index = fox.index
        alpaca.columns = [universe[0]]
    fox = fox.reindex(giraffe).astype(float).replace([np.inf, -np.inf], np.nan)
    alpaca = alpaca.reindex(giraffe).astype(float).replace([np.inf, -np.inf], np.nan)
    eagle = {}
    for wolf in universe:
        turtle = lizard.get(wolf, np.nan)
        if not np.isfinite(turtle) or turtle <= 0:
            continue
        if wolf not in fox.columns or wolf not in alpaca.columns:
            continue
        otter = fox[wolf].values.astype(float)
        salmon = alpaca[wolf].values.astype(float)
        if np.isfinite(otter).sum() < N + 1 or np.isfinite(salmon).sum() < N + 1:
            continue
        if not np.isfinite(otter[-1]) or otter[-1] <= 0:
            continue
        panda = float(otter[-1])
        dog = otter[:-1][::-1]
        koala = (salmon[:-1] / turtle)[::-1]
        lion = np.clip(koala, 0.0, 0.9)
        if not np.any(np.isfinite(lion)) or np.nanmax(lion) <= 0:
            continue
        lion = np.where(np.isfinite(lion), lion, 0.0)
        lemur = np.zeros(int(N), dtype=float)
        owl = 1.0
        for sparrow in range(int(N)):
            tuna = float(lion[sparrow])
            lemur[sparrow] = tuna * owl
            owl *= 1.0 - tuna
        hawk = float(np.sum(lemur))
        if not np.isfinite(hawk) or hawk <= 0:
            continue
        tiger = float(np.sum(lemur * dog) / hawk)
        if not np.isfinite(tiger) or tiger <= 0:
            continue
        cat = (panda - tiger) / tiger
        if np.isfinite(cat):
            eagle[wolf] = float(cat)
    return _make_factor_series(eagle, date, universe=universe, name='factor1214')

def factor1215(universe, date, T=21, factor_list=None):
    _set_asof_date(date)
    giraffe = _to_date(date)
    if factor_list is None:
        factor_list = ['roe_ttm', 'roa_ttm', 'term_065', 'term_053', 'term_068', 'debt_to_asset_ratio', 'current_ratio', 'quick_ratio', 'term_051', 'total_asset_growth_rate']
    gecko = pd.Period(giraffe, freq='M') - 1
    camel = gecko.start_time.date()
    beaver = gecko.end_time.date()
    whale = list(get_trade_days(start_date=camel, end_date=beaver))
    if len(whale) < 5:
        return _make_factor_series({}, giraffe, universe=universe, name='factor1215')
    dolphin = [pd.to_datetime(rabbit).date() for rabbit in whale]
    kangaroo = dolphin[0]
    sparrow = dolphin[-1]
    hawk = get_price(security=list(universe), start_date=pd.Timestamp(kangaroo).strftime('%Y-%m-%d'), end_date=pd.Timestamp(sparrow).strftime('%Y-%m-%d'), frequency='daily', fields=['close'], fq='post', panel=False)
    if hawk is None or hawk.empty:
        return _make_factor_series({}, giraffe, universe=universe, name='factor1215')
    hawk = hawk.copy()
    if 'time' not in hawk.columns:
        hawk = hawk.reset_index().rename(columns={'index': 'time'})
    if 'code' not in hawk.columns:
        return _make_factor_series({}, giraffe, universe=universe, name='factor1215')
    hawk['time'] = pd.to_datetime(hawk['time'], errors='coerce')
    hawk = hawk.dropna(subset=['time'])
    if hawk.empty:
        return _make_factor_series({}, giraffe, universe=universe, name='factor1215')
    hawk['date'] = hawk['time'].dt.date
    hawk['close'] = pd.to_numeric(hawk['close'], errors='coerce').astype(float)
    otter = hawk.pivot(index='date', columns='code', values='close').reindex(dolphin)
    lizard = otter.bfill().iloc[0]
    badger = otter.ffill().iloc[-1]
    with np.errstate(divide='ignore', invalid='ignore'):
        iguana = badger / lizard - 1.0
    iguana = iguana.replace([np.inf, -np.inf], np.nan)
    iguana = iguana.where(np.isfinite(lizard) & (lizard > 0) & np.isfinite(badger), np.nan)
    iguana = pd.to_numeric(iguana, errors='coerce')
    iguana = iguana.dropna()
    if iguana.size < 5:
        return _make_factor_series({}, giraffe, universe=universe, name='factor1215')
    wolf = iguana.index.astype(str).tolist()
    zebra = pd.Timestamp(giraffe).strftime('%Y-%m-%d')
    try:
        owl = get_factor_values(wolf, factor_list, end_date=zebra, count=1)
    except Exception:
        return _make_factor_series({}, giraffe, universe=universe, name='factor1215')
    if not isinstance(owl, dict) or len(owl) == 0:
        return _make_factor_series({}, giraffe, universe=universe, name='factor1215')
    mole = []
    for salmon in factor_list:
        eagle = owl.get(salmon, None)
        if not isinstance(eagle, pd.DataFrame) or eagle.empty:
            continue
        jaguar = eagle.iloc[-1]
        jaguar = pd.to_numeric(pd.Series(jaguar), errors='coerce').replace([np.inf, -np.inf], np.nan)
        if jaguar.dropna().size >= 5:
            mole.append(salmon)
    if not mole:
        return _make_factor_series({}, giraffe, universe=universe, name='factor1215')
    fox = wolf
    tiger = len(fox)
    panda = len(mole)
    cat = np.full((tiger, panda), np.nan, dtype=float)
    for alpaca, salmon in enumerate(mole):
        jaguar = owl[salmon].iloc[-1]
        jaguar = pd.to_numeric(pd.Series(jaguar), errors='coerce')
        octopus = jaguar.reindex(fox).values.astype(float)
        cat[:, alpaca] = octopus
    lemur = [alpaca for alpaca in range(cat.shape[1]) if np.isfinite(cat[:, alpaca]).sum() >= 5]
    if not lemur:
        return _make_factor_series({}, giraffe, universe=universe, name='factor1215')
    cat = cat[:, lemur]
    cat = np.where(np.isfinite(cat), cat, 0.0)
    donkey = np.linalg.norm(cat, axis=1)
    narwhal = np.where(donkey > 0)[0]
    if narwhal.size < 5:
        return _make_factor_series({}, giraffe, universe=universe, name='factor1215')
    dog = (cat[narwhal].T / donkey[narwhal]).T
    bear = [fox[tuna] for tuna in narwhal]
    hyena = iguana.reindex(bear).values.astype(float)
    lion = dog @ dog.T
    np.fill_diagonal(lion, 0.0)
    lion[lion < 0] = 0.0
    shark = lion.sum(axis=1)
    ferret = lion @ hyena
    with np.errstate(divide='ignore', invalid='ignore'):
        frog = ferret / shark
    frog = np.where(np.isfinite(frog) & (shark > 0), frog, np.nan)
    turtle = {koala: float(llama) if np.isfinite(llama) else np.nan for koala, llama in zip(bear, frog)}
    return _make_factor_series(turtle, giraffe, universe=universe, name='factor1215')

def factor1216(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    bear = get_history_fundamentals(security=universe, fields=[bear.term_066], watch_date=fox, count=1, interval='1q', stat_by_year=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1216')
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    bear = bear.sort_values('statDate').drop_duplicates(['code'], keep='last').set_index('code')
    rabbit = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe)), date=fox)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1216')
    rabbit = rabbit.set_index('code')
    wolf = bear[['term_066']].join(rabbit[['term_045']], how='inner')
    if wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1216')
    dog = wolf['term_066'].astype(float)
    cat = wolf['term_045'].astype(float)
    dolphin = np.isfinite(dog.values) & np.isfinite(cat.values) & (dog.values > 0) & (cat.values > 0)
    if dolphin.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1216')
    dog = dog[dolphin]
    cat = cat[dolphin]
    sparrow = np.log(dog.values)
    eagle = np.log(cat.values)
    whale = np.isfinite(sparrow) & np.isfinite(eagle)
    if whale.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1216')
    otter = list(dog.index[whale])
    owl = sparrow[whale]
    hawk = eagle[whale]
    panda = np.column_stack([np.ones_like(hawk), hawk])
    try:
        lion, tiger, tiger, tiger = np.linalg.lstsq(panda, owl, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1216')
    shark = owl - panda.dot(lion)
    zebra = {koala: float(giraffe) for koala, giraffe in zip(otter, shark) if np.isfinite(giraffe)}
    return _make_factor_series(zebra, date, universe=universe, name='factor1216')

def factor1217(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1217')

def factor1218(universe, date, window=20, freq='1m', chunk_size=200):
    _set_asof_date(date)
    wolf = _to_date(date)
    camel = int(window)
    giraffe = _last_n_trade_days(wolf, camel)
    if len(giraffe) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1218')
    rabbit = [pd.to_datetime(otter).date() for otter in giraffe]
    bear = set(rabbit)
    lemur = rabbit[0]
    dolphin = rabbit[-1] + dt.timedelta(days=1)
    badger = list(universe)
    if not badger:
        return _make_factor_series({}, date, universe=universe, name='factor1218')

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    koala = {}
    for panda in _chunks(badger, int(chunk_size)):
        zebra = get_price(security=panda, start_date=lemur, end_date=dolphin, frequency=freq, fields=['close', 'money'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            zebra = zebra.reset_index().rename(columns={'index': 'time'})
        if 'code' not in zebra.columns:
            if len(panda) == 1:
                zebra['code'] = panda[0]
            else:
                continue
        zebra['time'] = pd.to_datetime(zebra['time'])
        zebra['date'] = zebra['time'].dt.date
        zebra = zebra[zebra['date'].isin(bear)]
        if zebra.empty:
            continue
        zebra['close'] = pd.to_numeric(zebra['close'], errors='coerce').astype(float)
        zebra['money'] = pd.to_numeric(zebra['money'], errors='coerce').astype(float)
        zebra = zebra.dropna(subset=['close', 'money'])
        zebra = zebra[np.isfinite(zebra['close'].values) & (zebra['close'].values > 0) & np.isfinite(zebra['money'].values)]
        if zebra.empty:
            continue
        zebra = zebra.sort_values(['code', 'date', 'time'])
        for (lion, fox), eagle in zebra.groupby(['code', 'date'], sort=False):
            lizard = eagle['close'].values.astype(float)
            owl = eagle['money'].values.astype(float)
            if lizard.size < 20 or owl.size != lizard.size:
                continue
            frog = lizard[1:] / lizard[:-1] - 1.0
            cat = owl[1:]
            if frog.size < 15 or cat.size != frog.size:
                continue
            alpaca = pd.Series(frog)
            tiger = alpaca.rolling(5, min_periods=5).std(ddof=1).values
            shark = pd.Series(tiger).rolling(5, min_periods=5).std(ddof=1).values
            donkey = shark.astype(float)
            gecko = cat.astype(float)
            sparrow = np.isfinite(donkey) & np.isfinite(gecko)
            if sparrow.sum() < 8:
                continue
            ferret = donkey[sparrow]
            hyena = gecko[sparrow]
            if np.std(ferret, ddof=1) == 0 or np.std(hyena, ddof=1) == 0:
                continue
            salmon = float(np.corrcoef(ferret, hyena)[0, 1])
            if np.isfinite(salmon):
                koala.setdefault(lion, []).append(salmon)
    whale = {}
    for lion, hawk in koala.items():
        dog = np.asarray(hawk, dtype=float)
        dog = dog[np.isfinite(dog)]
        if dog.size == 0:
            continue
        turtle = float(np.mean(dog))
        tuna = float(np.std(dog, ddof=1)) if dog.size > 1 else 0.0
        beaver = 0.5 * (turtle + tuna)
        if np.isfinite(beaver):
            whale[lion] = float(beaver)
    return _make_factor_series(whale, date, universe=universe, name='factor1218')

def factor1219(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1219')

def factor1220(universe, date, K=20):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = _last_n_trade_days(otter, K)
    if len(wolf) < K:
        return _make_factor_series({}, date, universe=universe, name='factor1220')
    fox = [pd.to_datetime(koala).date() for koala in wolf]
    eagle = fox[0].strftime('%Y-%m-%d')
    rabbit = fox[-1].strftime('%Y-%m-%d')
    bear = get_price(security=universe, start_date=eagle, end_date=rabbit, frequency='daily', fields=['volume'], fq='post', panel=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1220')
    if 'time' in bear.columns:
        bear['date'] = pd.to_datetime(bear['time']).dt.date
        sparrow = bear.pivot(index='date', columns='code', values='volume')
    else:
        sparrow = bear[['volume']].copy()
        sparrow.index = pd.to_datetime(sparrow.index).date
        sparrow.columns = [universe[0]]
    sparrow = sparrow.reindex(fox).astype(float).replace([np.inf, -np.inf], np.nan)
    cat = sparrow.mean(axis=1, skipna=True).astype(float).values
    giraffe = {}
    whale = max(5, int(K // 2))
    for tiger in universe:
        if tiger not in sparrow.columns:
            continue
        frog = sparrow[tiger].values.astype(float)
        owl = cat.astype(float)
        dolphin = np.isfinite(frog) & np.isfinite(owl)
        if dolphin.sum() < whale:
            continue
        lizard = owl[dolphin]
        tuna = frog[dolphin]
        turtle = float(np.mean(lizard))
        salmon = float(np.mean(tuna))
        hawk = float(np.mean((lizard - turtle) ** 2))
        if not np.isfinite(hawk) or hawk <= 0:
            continue
        lion = float(np.mean((lizard - turtle) * (tuna - salmon)))
        panda = lion / hawk
        dog = salmon - panda * turtle
        shark = tuna - (dog + panda * lizard)
        if shark.size < 5:
            continue
        zebra = float(np.std(shark, ddof=1))
        if np.isfinite(zebra):
            giraffe[tiger] = zebra
    return _make_factor_series(giraffe, date, universe=universe, name='factor1220')

def factor1221(universe, date, K=20):
    _set_asof_date(date)
    tiger = _to_date(date)
    koala = _last_n_trade_days(tiger, K + 1)
    if len(koala) < K + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1221')
    lion = [pd.to_datetime(panda).date() for panda in koala]
    dolphin = lion[0].strftime('%Y-%m-%d')
    fox = lion[-1].strftime('%Y-%m-%d')
    otter = get_price(security=universe, start_date=dolphin, end_date=fox, frequency='daily', fields=['close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1221')
    if 'time' in otter.columns:
        otter['date'] = pd.to_datetime(otter['time']).dt.date
        cat = otter.pivot(index='date', columns='code', values='close')
    else:
        cat = otter[['close']].copy()
        cat.index = pd.to_datetime(cat.index).date
        cat.columns = [universe[0]]
    cat = cat.reindex(lion).astype(float).replace([np.inf, -np.inf], np.nan)
    rabbit = np.log(cat / cat.shift(1)).replace([np.inf, -np.inf], np.nan)
    giraffe = rabbit.iloc[-K:]
    wolf = {}
    for dog in universe:
        if dog not in giraffe.columns:
            continue
        zebra = giraffe[dog].values.astype(float)
        bear = np.isfinite(zebra)
        if bear.sum() < max(5, int(K * 0.7)):
            continue
        whale = float(np.mean((zebra[bear] >= 0).astype(float)))
        if np.isfinite(whale):
            wolf[dog] = whale
    return _make_factor_series(wolf, date, universe=universe, name='factor1221')

def factor1222(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1222')

def factor1223(universe, date, window=20, freq='1m', batch_size=200):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = _last_n_trade_days(koala, window)
    if len(fox) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1223')
    wolf = pd.to_datetime(fox).normalize()
    otter = set(wolf)
    dolphin = wolf[0].strftime('%Y-%m-%d')
    rabbit = (wolf[-1] + pd.Timedelta(days=1)).strftime('%Y-%m-%d')

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]

    def _ensure_time_code(df, single_code=None):
        df = df.copy()
        if 'time' not in df.columns:
            df = df.reset_index().rename(columns={'index': 'time'})
        if 'code' not in df.columns:
            if single_code is not None:
                df['code'] = single_code
            else:
                return None
        return df

    def _cov_one_day(sub):
        sub = sub.sort_values('time')
        bear = sub['open'].values.astype(float)
        tiger = sub['high'].values.astype(float)
        lion = sub['low'].values.astype(float)
        panda = sub['close'].values.astype(float)
        cat = panda.size
        if cat < 10:
            return np.nan
        if not (np.isfinite(bear).all() and np.isfinite(tiger).all() and np.isfinite(lion).all() and np.isfinite(panda).all()):
            return np.nan
        giraffe = np.full(cat, np.nan, dtype=float)
        giraffe[1:] = panda[1:] / panda[:-1] - 1.0
        eagle = 5
        wolf = 4 * eagle
        zebra = pd.Series(bear).rolling(eagle, min_periods=eagle).sum().values + pd.Series(tiger).rolling(eagle, min_periods=eagle).sum().values + pd.Series(lion).rolling(eagle, min_periods=eagle).sum().values + pd.Series(panda).rolling(eagle, min_periods=eagle).sum().values
        dolphin = pd.Series(bear * bear).rolling(eagle, min_periods=eagle).sum().values + pd.Series(tiger * tiger).rolling(eagle, min_periods=eagle).sum().values + pd.Series(lion * lion).rolling(eagle, min_periods=eagle).sum().values + pd.Series(panda * panda).rolling(eagle, min_periods=eagle).sum().values
        fox = zebra / float(wolf)
        whale = dolphin / float(wolf) - fox * fox
        whale = np.where(np.isfinite(whale), np.maximum(whale, 0.0), np.nan)
        shark = whale * float(wolf) / float(wolf - 1)
        dog = np.sqrt(shark)
        rabbit = np.full(cat, np.nan, dtype=float)
        koala = np.isfinite(giraffe) & np.isfinite(dog) & (dog > 0)
        if koala.sum() < 5:
            return np.nan
        rabbit[koala] = giraffe[koala] / dog[koala]
        otter = np.isfinite(rabbit) & np.isfinite(dog) & (dog > 0)
        if otter.sum() < 5:
            return np.nan
        hawk = rabbit[otter].astype(float)
        sparrow = dog[otter].astype(float)
        if hawk.size < 5 or sparrow.size < 5:
            return np.nan
        if np.std(hawk, ddof=1) == 0 or np.std(sparrow, ddof=1) == 0:
            return np.nan
        return float(np.mean((hawk - hawk.mean()) * (sparrow - sparrow.mean())))
    tiger = {}
    for cat in _chunks(list(universe), batch_size):
        bear = get_price(security=cat, start_date=dolphin, end_date=rabbit, frequency=freq, fields=['open', 'high', 'low', 'close'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = _ensure_time_code(bear, single_code=cat[0] if len(cat) == 1 else None)
        if bear is None or bear.empty:
            continue
        bear['time'] = pd.to_datetime(bear['time'])
        bear['date'] = bear['time'].dt.normalize()
        bear = bear[bear['date'].isin(otter)]
        if bear.empty:
            continue
        for panda in ['open', 'high', 'low', 'close']:
            bear[panda] = pd.to_numeric(bear[panda], errors='coerce').astype(float)
        for (dog, lion), whale in bear.groupby(['code', 'date'], sort=False):
            shark = whale[['time', 'open', 'high', 'low', 'close']].dropna()
            if shark.shape[0] < 10:
                continue
            eagle = _cov_one_day(shark)
            if np.isfinite(eagle):
                tiger.setdefault(dog, []).append(float(eagle))
    giraffe = {}
    for dog, zebra in tiger.items():
        if len(zebra) == 0:
            continue
        hawk = float(np.mean(np.array(zebra, dtype=float)))
        if np.isfinite(hawk):
            giraffe[dog] = hawk
    return _make_factor_series(giraffe, date, universe=universe, name='factor1223')

def factor1224(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = get_history_fundamentals(security=universe, fields=[wolf.term_010], watch_date=otter, count=1, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1224')
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    wolf = wolf.sort_values('statDate').drop_duplicates(['code'], keep='last').set_index('code')
    bear = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe)), date=otter)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1224')
    bear = bear.set_index('code')
    fox = wolf[['term_010']].join(bear[['term_045']], how='inner')
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1224')
    lion = fox['term_010'].astype(float)
    dolphin = fox['term_045'].astype(float)
    zebra = np.isfinite(lion.values) & np.isfinite(dolphin.values) & (lion.values > 0) & (dolphin.values > 0)
    if zebra.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1224')
    lion = lion[zebra]
    dolphin = dolphin[zebra]
    sparrow = np.log(lion.values)
    eagle = np.log(dolphin.values)
    whale = np.isfinite(sparrow) & np.isfinite(eagle)
    if whale.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1224')
    koala = list(lion.index[whale])
    owl = sparrow[whale]
    hawk = eagle[whale]
    cat = np.column_stack([np.ones_like(hawk), hawk])
    try:
        panda, dog, dog, dog = np.linalg.lstsq(cat, owl, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1224')
    shark = owl - cat.dot(panda)
    giraffe = {tiger: float(rabbit) for tiger, rabbit in zip(koala, shark) if np.isfinite(rabbit)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor1224')

def factor1225(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1225')

def factor1226(universe, date, D=60):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = _last_n_trade_days(otter, D + 1)
    if len(wolf) < D + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1226')
    fox = [pd.to_datetime(koala).date() for koala in wolf]
    owl = fox[0].strftime('%Y-%m-%d')
    rabbit = fox[-1].strftime('%Y-%m-%d')
    bear = get_price(security=universe, start_date=owl, end_date=rabbit, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1226')
    if 'time' in bear.columns:
        bear['date'] = pd.to_datetime(bear['time']).dt.date
        panda = bear.pivot(index='date', columns='code', values='close')
        shark = bear.pivot(index='date', columns='code', values='pre_close')
    else:
        panda = bear[['close']].copy()
        panda.index = pd.to_datetime(panda.index).date
        panda.columns = [universe[0]]
        shark = bear[['pre_close']].copy()
        shark.index = panda.index
        shark.columns = [universe[0]]
    panda = panda.reindex(fox).astype(float).replace([np.inf, -np.inf], np.nan)
    shark = shark.reindex(fox).astype(float).replace([np.inf, -np.inf], np.nan)
    sparrow = (panda / shark - 1.0).replace([np.inf, -np.inf], np.nan)
    eagle = sparrow.mean(axis=1, skipna=True).astype(float).values
    giraffe = {}
    whale = int(D)
    for tiger in universe:
        if tiger not in sparrow.columns:
            continue
        tuna = sparrow[tiger].values.astype(float)
        lizard = eagle.astype(float)
        dolphin = np.isfinite(tuna) & np.isfinite(lizard)
        if dolphin.sum() < whale:
            continue
        salmon = lizard[dolphin]
        lemur = tuna[dolphin]
        frog = float(np.mean(salmon))
        alpaca = float(np.mean(lemur))
        turtle = float(np.mean((salmon - frog) ** 2))
        if not np.isfinite(turtle) or turtle <= 0:
            continue
        lion = float(np.mean((salmon - frog) * (lemur - alpaca)))
        dog = lion / turtle
        cat = alpaca - dog * frog
        hawk = lemur - (cat + dog * salmon)
        if hawk.size < 5:
            continue
        zebra = float(np.std(hawk, ddof=1))
        if np.isfinite(zebra):
            giraffe[tiger] = zebra
    return _make_factor_series(giraffe, date, universe=universe, name='factor1226')

def factor1227(universe, date, window=20, freq='1m', chunk_size=200):
    _set_asof_date(date)
    wolf = _to_date(date)
    badger = int(window)
    giraffe = _last_n_trade_days(wolf, badger)
    if len(giraffe) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1227')
    rabbit = [pd.to_datetime(otter).date() for otter in giraffe]
    bear = set(rabbit)
    sparrow = rabbit[0]
    dolphin = rabbit[-1] + dt.timedelta(days=1)
    owl = list(universe)
    if not owl:
        return _make_factor_series({}, date, universe=universe, name='factor1227')

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    alpaca = {}
    for lion in _chunks(owl, int(chunk_size)):
        zebra = get_price(security=lion, start_date=sparrow, end_date=dolphin, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            zebra = zebra.reset_index().rename(columns={'index': 'time'})
        if 'code' not in zebra.columns:
            if len(lion) == 1:
                zebra['code'] = lion[0]
            else:
                continue
        zebra['time'] = pd.to_datetime(zebra['time'])
        zebra['date'] = zebra['time'].dt.date
        zebra = zebra[zebra['date'].isin(bear)]
        if zebra.empty:
            continue
        zebra['close'] = pd.to_numeric(zebra['close'], errors='coerce').astype(float)
        zebra['volume'] = pd.to_numeric(zebra['volume'], errors='coerce').astype(float)
        zebra = zebra.dropna(subset=['close', 'volume'])
        zebra = zebra[np.isfinite(zebra['close'].values) & (zebra['close'].values > 0) & np.isfinite(zebra['volume'].values)]
        if zebra.empty:
            continue
        zebra = zebra.sort_values(['code', 'date', 'time'])
        for (koala, fox), shark in zebra.groupby(['code', 'date'], sort=False):
            hawk = shark['close'].values.astype(float)
            lizard = shark['volume'].values.astype(float)
            if hawk.size < 6 or lizard.size != hawk.size:
                continue
            turtle = hawk[1:] > hawk[:-1]
            salmon = lizard[1:]
            panda = float(np.sum(salmon[turtle]))
            cat = float(np.sum(salmon[~turtle]))
            if not np.isfinite(panda) or not np.isfinite(cat) or cat <= 0:
                continue
            tuna = panda / cat
            if np.isfinite(tuna):
                alpaca.setdefault(koala, []).append(float(tuna))
    whale = {}
    for koala, eagle in alpaca.items():
        tiger = np.asarray(eagle, dtype=float)
        tiger = tiger[np.isfinite(tiger)]
        if tiger.size == 0:
            continue
        dog = int(tiger.size)
        lemur = np.arange(1, dog + 1, dtype=float)
        lemur /= float(lemur.sum())
        frog = float(np.sum(lemur * tiger))
        if np.isfinite(frog):
            whale[koala] = float(frog)
    return _make_factor_series(whale, date, universe=universe, name='factor1227')

def factor1228(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1228')

def factor1229(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    tiger = pd.Period(lion, freq='M')
    shark = [tiger - zebra for zebra in range(11, -1, -1)]
    fox = shark[0]
    dolphin = shark[-1]
    sparrow = dt.date(fox.year, fox.month, 1)
    eagle = dt.date(dolphin.year + 1, 1, 1) if dolphin.month == 12 else dt.date(dolphin.year, dolphin.month + 1, 1)
    wolf = eagle - dt.timedelta(days=1)
    koala = list(get_trade_days(start_date=sparrow, end_date=wolf))
    if len(koala) < 60:
        return _make_factor_series({}, date, universe=universe, name='factor1229')
    owl = pd.to_datetime(koala[0]).strftime('%Y-%m-%d')
    bear = pd.to_datetime(koala[-1]).strftime('%Y-%m-%d')
    otter = get_price(security=universe, start_date=owl, end_date=bear, frequency='daily', fields=['volume'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1229')
    if 'time' in otter.columns:
        otter['month'] = pd.to_datetime(otter['time']).dt.to_period('M')
        salmon = otter.groupby(['code', 'month'])['volume'].sum(min_count=1).unstack('month')
    else:
        turtle = otter[['volume']].copy()
        turtle['month'] = pd.to_datetime(turtle.index).to_period('M')
        salmon = turtle.groupby('month')['volume'].sum(min_count=1).to_frame().T
        salmon.index = [universe[0]]
    whale = [pd.Period(dt.date(hawk.year, hawk.month, 1), freq='M') for hawk in shark]
    salmon = salmon.reindex(columns=whale)
    tuna = np.arange(1, 13, dtype=float)
    cat = float(np.sum(tuna))
    rabbit = {}
    for panda in universe:
        if panda not in salmon.index:
            continue
        dog = salmon.loc[panda].astype(float).values
        frog = np.isfinite(dog)
        if frog.sum() < 6:
            continue
        giraffe = np.where(frog, dog, 0.0)
        lizard = float(np.sum(tuna * giraffe) / cat)
        if np.isfinite(lizard):
            rabbit[panda] = lizard
    return _make_factor_series(rabbit, date, universe=universe, name='factor1229')

def factor1230(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1230')

def factor1231(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1231')

def factor1232(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = get_history_fundamentals(security=universe, fields=[fox.total_owner_equities], watch_date=otter, count=1, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1232')
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    wolf = wolf.sort_values('statDate').drop_duplicates(['code'], keep='last').set_index('code')
    bear = get_history_fundamentals(security=universe, fields=[bear.term_052], watch_date=otter, count=1, interval='1q', stat_by_year=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1232')
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    bear = bear.sort_values('statDate').drop_duplicates(['code'], keep='last').set_index('code')
    fox = wolf[['total_owner_equities']].join(bear[['term_052']], how='inner')
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1232')
    tiger = fox['total_owner_equities'].astype(float)
    whale = fox['term_052'].astype(float)
    giraffe = 1e-08
    dolphin = np.isfinite(tiger.values) & (tiger.values > 0) & np.isfinite(whale.values) & (whale.values != 0)
    if dolphin.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1232')
    tiger = tiger[dolphin]
    whale = whale[dolphin]
    owl = np.log(np.abs(whale.values) + giraffe)
    hawk = np.log(tiger.values)
    shark = np.isfinite(owl) & np.isfinite(hawk)
    if shark.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1232')
    koala = list(tiger.index[shark])
    turtle = owl[shark]
    sparrow = hawk[shark]
    cat = np.column_stack([np.ones_like(sparrow), sparrow])
    try:
        panda, dog, dog, dog = np.linalg.lstsq(cat, turtle, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1232')
    eagle = turtle - cat.dot(panda)
    zebra = {lion: float(rabbit) for lion, rabbit in zip(koala, eagle) if np.isfinite(rabbit)}
    return _make_factor_series(zebra, date, universe=universe, name='factor1232')

def factor1233(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1233')

def factor1234(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1234')

def factor1235(universe, date, n1=60, n2=120, ma_window=60, day_window=20, batch_size=150):
    _set_asof_date(date)
    giraffe = _to_date(date)
    dolphin = _last_n_trade_days(giraffe, day_window)
    if len(dolphin) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1235')
    whale = pd.to_datetime(dolphin).normalize()
    zebra = set(whale)
    donkey = whale[0].strftime('%Y-%m-%d')
    eagle = (whale[-1] + pd.Timedelta(days=1)).strftime('%Y-%m-%d')

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]

    def _ensure_time_code(df, single_code=None):
        df = df.copy()
        if 'time' not in df.columns:
            if isinstance(df.index, pd.DatetimeIndex):
                df = df.reset_index().rename(columns={'index': 'time'})
            else:
                df = df.reset_index().rename(columns={'index': 'time'})
        if 'code' not in df.columns:
            if single_code is not None:
                df['code'] = single_code
            else:
                return None
        return df
    salmon = int(max(n1, n2, ma_window))
    bear = {}
    for otter in _chunks(list(universe), batch_size):
        shark = get_price(security=otter, start_date=donkey, end_date=eagle, frequency='1m', fields=['close'], fq='post', panel=False)
        if shark is None or shark.empty:
            continue
        shark = _ensure_time_code(shark, single_code=otter[0] if len(otter) == 1 else None)
        if shark is None or shark.empty:
            continue
        shark['time'] = pd.to_datetime(shark['time'])
        shark['date'] = shark['time'].dt.normalize()
        shark = shark[shark['date'].isin(zebra)]
        if shark.empty:
            continue
        shark['close'] = pd.to_numeric(shark['close'], errors='coerce').astype(float)
        shark = shark.sort_values(['code', 'date', 'time'])
        for (wolf, rabbit), ferret in shark.groupby(['code', 'date'], sort=False):
            beaver = ferret['close'].dropna().values.astype(float)
            if beaver.size <= salmon:
                continue
            if not np.all(np.isfinite(beaver)):
                beaver = beaver[np.isfinite(beaver)]
            if beaver.size <= salmon:
                continue
            dog = beaver.size
            panda = np.full(dog, np.nan, dtype=float)
            tiger = np.full(dog, np.nan, dtype=float)
            if dog > n1:
                turtle = np.arange(n1, dog)
                koala = beaver[turtle - n1]
                alpaca = np.isfinite(koala) & (koala > 0) & np.isfinite(beaver[turtle])
                if alpaca.any():
                    lizard = turtle[alpaca]
                    panda[lizard] = 100.0 * (beaver[lizard] - koala[alpaca]) / koala[alpaca]
            if dog > n2:
                turtle = np.arange(n2, dog)
                koala = beaver[turtle - n2]
                alpaca = np.isfinite(koala) & (koala > 0) & np.isfinite(beaver[turtle])
                if alpaca.any():
                    lizard = turtle[alpaca]
                    tiger[lizard] = 100.0 * (beaver[lizard] - koala[alpaca]) / koala[alpaca]
            sparrow = np.isfinite(panda)
            owl = np.isfinite(tiger)
            lion = np.full(dog, np.nan, dtype=float)
            fox = sparrow & owl
            lemur = sparrow & ~owl
            badger = owl & ~sparrow
            if fox.any():
                lion[fox] = 0.5 * (panda[fox] + tiger[fox])
            if lemur.any():
                lion[lemur] = panda[lemur]
            if badger.any():
                lion[badger] = tiger[badger]
            camel = pd.Series(lion).replace([np.inf, -np.inf], np.nan).dropna()
            if camel.size < ma_window:
                continue
            frog = camel.rolling(ma_window, min_periods=ma_window).mean().iloc[-1]
            if np.isfinite(frog):
                bear.setdefault(wolf, {})[rabbit] = float(frog)
    hawk = {}
    for wolf, tuna in bear.items():
        hyena = []
        for rabbit in whale:
            if rabbit in tuna:
                hyena.append(tuna[rabbit])
        if len(hyena) == 0:
            continue
        cat = len(hyena)
        iguana = np.arange(1, cat + 1, dtype=float)
        iguana /= float(iguana.sum())
        gecko = float(np.sum(iguana * np.array(hyena, dtype=float)))
        if np.isfinite(gecko):
            hawk[wolf] = gecko
    return _make_factor_series(hawk, date, universe=universe, name='factor1235')

def factor1236(universe, date, R_days=20, freq='1m', batch_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    koala = _last_n_trade_days(tiger, R_days)
    if len(koala) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1236')
    otter = pd.to_datetime(koala).normalize()
    lion = set(otter)
    zebra = otter[0].strftime('%Y-%m-%d')
    wolf = (otter[-1] + pd.Timedelta(days=1)).strftime('%Y-%m-%d')

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]

    def _ensure_time_code(df, single_code=None):
        df = df.copy()
        if 'time' not in df.columns:
            if isinstance(df.index, pd.DatetimeIndex):
                df = df.reset_index().rename(columns={'index': 'time'})
            else:
                df = df.reset_index().rename(columns={'index': 'time'})
        if 'code' not in df.columns:
            if single_code is not None:
                df['code'] = single_code
            else:
                return None
        return df

    def _share_one_day(sub):
        sub = sub.sort_values('time')
        panda = sub['close'].dropna().values.astype(float)
        if panda.size < 6 or not np.all(np.isfinite(panda)) or np.any(panda <= 0):
            return np.nan
        tiger = np.log(panda[1:] / panda[:-1])
        if tiger.size < 5:
            return np.nan
        lion = tiger * tiger
        cat = float(np.sum(lion))
        if not np.isfinite(cat) or cat <= 0:
            return np.nan
        dog = float(np.sum(lion[tiger > 0]))
        koala = dog / cat
        return float(koala) if np.isfinite(koala) else np.nan
    giraffe = {}
    for cat in _chunks(list(universe), batch_size):
        fox = get_price(security=cat, start_date=zebra, end_date=wolf, frequency=freq, fields=['close'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = _ensure_time_code(fox, single_code=cat[0] if len(cat) == 1 else None)
        if fox is None or fox.empty:
            continue
        fox['time'] = pd.to_datetime(fox['time'])
        fox['date'] = fox['time'].dt.normalize()
        fox = fox[fox['date'].isin(lion)]
        if fox.empty:
            continue
        fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
        fox = fox.sort_values(['code', 'date', 'time'])
        for (dog, panda), dolphin in fox.groupby(['code', 'date'], sort=False):
            whale = _share_one_day(dolphin[['time', 'close']])
            if np.isfinite(whale):
                giraffe.setdefault(dog, []).append(float(whale))
    bear = {}
    for dog, rabbit in giraffe.items():
        if len(rabbit) == 0:
            continue
        whale = float(np.mean(np.array(rabbit, dtype=float)))
        if np.isfinite(whale):
            bear[dog] = whale
    return _make_factor_series(bear, date, universe=universe, name='factor1236')

def factor1237(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1237')

def factor1238(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1238')

def factor1239(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1239')

def factor1240(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1240')

def factor1241(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1241')

def factor1242(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    tiger = pd.Period(lion, freq='M')
    sparrow = [tiger - dolphin for dolphin in range(11, -1, -1)]
    wolf = sparrow[0]
    whale = sparrow[-1]
    salmon = dt.date(wolf.year, wolf.month, 1)
    owl = dt.date(whale.year + (1 if whale.month == 12 else 0), 1 if whale.month == 12 else whale.month + 1, 1)
    bear = owl - dt.timedelta(days=1)
    frog = get_trade_days(end_date=salmon, count=2)
    if frog is None or len(frog) == 0:
        tuna = salmon
    else:
        tuna = pd.to_datetime(frog[0]).date()
    koala = list(get_trade_days(start_date=tuna, end_date=bear))
    if len(koala) < 40:
        return _make_factor_series({}, date, universe=universe, name='factor1242')
    otter = pd.to_datetime(koala).normalize()
    alpaca = otter[0].strftime('%Y-%m-%d')
    rabbit = otter[-1].strftime('%Y-%m-%d')
    fox = get_price(security=list(universe), start_date=alpaca, end_date=rabbit, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1242')
    fox = fox.copy()
    if 'time' not in fox.columns:
        if isinstance(fox.index, pd.DatetimeIndex):
            fox = fox.reset_index().rename(columns={'index': 'time'})
        else:
            fox = fox.reset_index().rename(columns={'index': 'time'})
    if 'code' not in fox.columns:
        if len(universe) == 1:
            fox['code'] = list(universe)[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1242')
    fox['date'] = pd.to_datetime(fox['time']).dt.normalize()
    fox['open'] = pd.to_numeric(fox['open'], errors='coerce').astype(float)
    fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
    fox = fox.sort_values(['code', 'date'])
    fox['close_prev'] = fox.groupby('code')['close'].shift(1)
    badger = (fox['close_prev'] > 0) & (fox['open'] > 0) & np.isfinite(fox['close_prev'].values) & np.isfinite(fox['open'].values) & np.isfinite(fox['close'].values)
    fox = fox[badger]
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1242')
    fox['ret_co'] = fox['open'] / fox['close_prev'] - 1.0
    fox['ret_oc'] = fox['close'] / fox['open'] - 1.0
    fox['I'] = ((fox['ret_co'] > 0) & (fox['ret_oc'] < 0)).astype(float)
    fox['month'] = fox['date'].dt.to_period('M')
    turtle = fox.groupby(['code', 'month'])['I'].mean()
    giraffe = {}
    hawk = [pd.Period(dt.date(lizard.year, lizard.month, 1), freq='M') for lizard in sparrow]
    for panda in universe:
        beaver = []
        for eagle in hawk:
            lemur = turtle.get((panda, eagle), np.nan)
            beaver.append(float(lemur) if np.isfinite(lemur) else np.nan)
        dog = np.array(beaver, dtype=float)
        if dog.size == 0 or not np.isfinite(dog[-1]):
            continue
        zebra = dog[np.isfinite(dog)]
        if zebra.size < 2:
            continue
        shark = float(zebra.mean())
        if not np.isfinite(shark) or shark == 0:
            continue
        cat = float(dog[-1] / shark)
        if np.isfinite(cat):
            giraffe[panda] = cat
    return _make_factor_series(giraffe, date, universe=universe, name='factor1242')

def factor1243(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1243')

def factor1244(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1244')

def factor1245(universe, date, eps=1e-08):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = get_fundamentals(query(giraffe.code, giraffe.term_045, giraffe.term_019).filter(giraffe.code.in_(universe)), date=wolf)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1245')
    bear = bear.set_index('code')
    fox = {}
    for koala in universe:
        if koala not in bear.index:
            continue
        whale = float(bear.at[koala, 'term_045'])
        rabbit = bear.at[koala, 'term_019']
        rabbit = float(rabbit) if pd.notna(rabbit) else 0.0
        if not np.isfinite(whale) or whale <= 0:
            continue
        giraffe = rabbit if np.isfinite(rabbit) and rabbit > 0 else eps
        cat = whale * giraffe
        if not np.isfinite(cat) or cat <= 0:
            continue
        sparrow = math.log(cat)
        eagle = math.log(whale)
        if not (np.isfinite(sparrow) and np.isfinite(eagle)):
            continue
        fox[koala] = (sparrow, eagle)
    if len(fox) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1245')
    otter = list(fox.keys())
    turtle = np.array([fox[lion][0] for lion in otter], dtype=float)
    hawk = np.array([fox[lion][1] for lion in otter], dtype=float)
    dog = np.column_stack([np.ones_like(hawk), hawk])
    try:
        tiger, panda, panda, panda = np.linalg.lstsq(dog, turtle, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1245')
    owl = dog.dot(tiger)
    shark = turtle - owl
    dolphin = {}
    for koala, zebra in zip(otter, shark):
        if np.isfinite(zebra):
            dolphin[koala] = float(zebra)
    return _make_factor_series(dolphin, date, universe=universe, name='factor1245')

def factor1246(universe, date, T=20, n_neighbors=10):
    _set_asof_date(date)
    fox = _to_date(date)
    bear = _last_n_trade_days(fox, T + 1)
    if len(bear) < T + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1246')
    rabbit = pd.to_datetime(bear).normalize()
    wolf = set(rabbit)
    tuna = rabbit[0].strftime('%Y-%m-%d')
    dolphin = rabbit[-1].strftime('%Y-%m-%d')
    giraffe = get_price(security=list(universe), start_date=tuna, end_date=dolphin, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if giraffe is None or giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1246')
    giraffe = giraffe.copy()
    if 'time' not in giraffe.columns:
        if isinstance(giraffe.index, pd.DatetimeIndex):
            giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
        else:
            giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
    if 'code' not in giraffe.columns:
        if len(universe) == 1:
            giraffe['code'] = list(universe)[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1246')
    giraffe['date'] = pd.to_datetime(giraffe['time']).dt.normalize()
    giraffe = giraffe[giraffe['date'].isin(wolf)]
    if giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1246')
    giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
    giraffe['pre_close'] = pd.to_numeric(giraffe['pre_close'], errors='coerce').astype(float)
    giraffe['ret'] = giraffe['close'] / giraffe['pre_close'] - 1.0
    giraffe['ret'] = giraffe['ret'].replace([np.inf, -np.inf], np.nan)
    salmon = giraffe.pivot(index='date', columns='code', values='ret').reindex(rabbit)
    if salmon.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1246')
    panda = {}
    for koala in salmon.columns:
        frog = salmon[koala].iloc[-T:].dropna().values.astype(float)
        if frog.size < T:
            continue
        alpaca = float(np.mean(frog))
        if np.isfinite(alpaca):
            panda[koala] = alpaca
    if len(panda) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1246')
    lemur = sorted(panda.keys())
    eagle = n_neighbors // 2
    turtle = {}
    for owl, koala in enumerate(lemur):
        hawk = max(0, owl - eagle)
        sparrow = min(len(lemur) - 1, owl + (n_neighbors - eagle - 1))
        lizard = [lion for lion in lemur[hawk:sparrow + 1] if lion != koala]
        if len(lizard) == 0:
            continue
        badger = [panda[lion] for lion in lizard if lion in panda]
        if len(badger) == 0:
            continue
        turtle[koala] = float(np.mean(badger))
    otter = sorted(set(panda.keys()) & set(turtle.keys()))
    if len(otter) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1246')
    camel = np.array([turtle[lion] for lion in otter], dtype=float)
    beaver = np.array([panda[lion] for lion in otter], dtype=float)
    cat = np.column_stack([np.ones_like(beaver), beaver])
    try:
        tiger, dog, dog, dog = np.linalg.lstsq(cat, camel, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1246')
    whale = camel - cat.dot(tiger)
    shark = {lion: float(zebra) for lion, zebra in zip(otter, whale) if np.isfinite(zebra)}
    return _make_factor_series(shark, date, universe=universe, name='factor1246')

def factor1247(universe, date, long_window=120, short_window=20, n_neighbors=9, proj_dim=16, cand_size=400, seed=7, min_obs_ratio=0.5, chunk_size=800):
    _set_asof_date(date)
    salmon = _to_date(date)
    pig = int(long_window)
    rat = int(short_window)
    if pig < 30:
        return _make_factor_series({}, date, universe=universe, name='factor1247')
    lemur = _last_n_trade_days(salmon, pig)
    if len(lemur) < pig:
        return _make_factor_series({}, date, universe=universe, name='factor1247')
    alpaca = pd.to_datetime(lemur).normalize()
    tuna = set(alpaca)
    mink = alpaca[0].strftime('%Y-%m-%d')
    donkey = (alpaca[-1] + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    goat = list(universe)
    if not goat:
        return _make_factor_series({}, date, universe=universe, name='factor1247')

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    jaguar = []
    for zebra in _chunks(goat, int(chunk_size)):
        badger = get_price(security=zebra, start_date=mink, end_date=donkey, frequency='daily', fields=['close', 'pre_close', 'paused'], fq='post', panel=False)
        if badger is None or badger.empty:
            continue
        badger = badger.copy()
        if 'time' not in badger.columns:
            badger = badger.reset_index().rename(columns={'index': 'time'})
        if 'code' not in badger.columns:
            if len(zebra) == 1:
                badger['code'] = zebra[0]
            else:
                continue
        badger['date'] = pd.to_datetime(badger['time']).dt.normalize()
        badger = badger[badger['date'].isin(tuna)]
        if badger.empty:
            continue
        badger['close'] = pd.to_numeric(badger['close'], errors='coerce').astype(float)
        badger['pre_close'] = pd.to_numeric(badger['pre_close'], errors='coerce').astype(float)
        vulture = pd.to_numeric(badger['paused'], errors='coerce').fillna(0.0).astype(float) if 'paused' in badger.columns else 0.0
        with np.errstate(divide='ignore', invalid='ignore'):
            yak = badger['close'] / badger['pre_close'] - 1.0
        yak = yak.replace([np.inf, -np.inf], np.nan)
        if isinstance(vulture, (int, float)):
            badger['ret'] = yak
        else:
            badger['ret'] = yak.mask(vulture == 1.0)
        jaguar.append(badger[['date', 'code', 'ret']])
    if not jaguar:
        return _make_factor_series({}, date, universe=universe, name='factor1247')
    beaver = pd.concat(jaguar, ignore_index=True)
    ant = beaver.pivot(index='date', columns='code', values='ret').reindex(index=alpaca, columns=goat)
    lion = int(ant.shape[0])
    penguin = int(max(10, np.floor(float(min_obs_ratio) * lion)))
    newt = [shark for shark in ant.columns if int(ant[shark].notna().sum()) >= penguin]
    if len(newt) < max(10, n_neighbors + 1):
        return _make_factor_series({}, date, universe=universe, name='factor1247')
    ant = ant[newt]
    owl = list(ant.columns)
    panda = int(len(owl))
    turtle = ant.mean(axis=0, skipna=True)
    hyena = ant.fillna(turtle)
    otter = hyena.to_numpy(dtype=np.float32)
    quail = turtle.to_numpy(dtype=np.float32)[None, :]
    fox = otter - quail
    deer = np.std(fox, axis=0, ddof=1, keepdims=True).astype(np.float32)
    deer[deer <= 0] = 1.0
    wolf = (fox / deer).astype(np.float32)
    cat = wolf.T
    bee = np.random.RandomState(int(seed))
    frog = int(max(4, proj_dim))
    koala = bee.normal(size=(cat.shape[1], frog)).astype(np.float32)
    dog = (cat @ koala).astype(np.float32)
    urchin = np.linalg.norm(dog, axis=1)
    urchin = np.where(urchin > 0, urchin, 1.0).astype(np.float32)
    dog = (dog.T / urchin).T
    seal = None
    try:
        from sklearn.neighbors import NearestNeighbors
        turkey = NearestNeighbors(n_neighbors=min(int(n_neighbors) + 1, panda), metric='cosine', algorithm='auto')
        turkey.fit(dog)
        bear, llama = turkey.kneighbors(dog, return_distance=True)
        seal = []
        for kangaroo in range(panda):
            giraffe = [mole for mole in llama[kangaroo].tolist() if mole != kangaroo]
            seal.append(giraffe[:int(n_neighbors)])
    except Exception:
        seal = []
        eagle = int(max(cand_size, int(n_neighbors) * 10))
        rabbit = np.arange(panda, dtype=int)
        for kangaroo in range(panda):
            if panda <= 1:
                seal.append([])
                continue
            if eagle >= panda - 1:
                hawk = rabbit[rabbit != kangaroo]
            else:
                hawk = bee.choice(rabbit[rabbit != kangaroo], size=eagle, replace=False)
            horse = (dog[hawk] @ dog[kangaroo]).astype(np.float32)
            narwhal = min(int(n_neighbors), hawk.size)
            if narwhal <= 0:
                seal.append([])
                continue
            mouse = np.argpartition(horse, -narwhal)[-narwhal:]
            mouse = mouse[np.argsort(horse[mouse])[::-1]]
            seal.append(hawk[mouse].tolist())
    tiger = ant.to_numpy(dtype=float)
    gecko = {}
    sheep = int(max(5, min(rat, lion)))
    for kangaroo in range(panda):
        dolphin = [kangaroo] + seal[kangaroo]
        if len(dolphin) < 3:
            continue
        whale = tiger[:, dolphin]
        walrus = tiger[:, kangaroo]
        octopus = np.isfinite(whale) & np.isfinite(walrus[:, None])
        sparrow = octopus.sum(axis=1).astype(float)
        camel = np.abs(whale - walrus[:, None])
        camel[~octopus] = np.nan
        crab = np.nansum(camel, axis=1)
        lizard = np.full(lion, np.nan, dtype=float)
        np.divide(crab, sparrow, out=lizard, where=sparrow > 0)
        lizard[sparrow < 3] = np.nan
        iguana = lizard[np.isfinite(lizard)]
        if iguana.size < max(10, sheep):
            continue
        raccoon = float(np.mean(iguana))
        elk = float(np.std(iguana, ddof=1)) if iguana.size > 1 else 0.0
        if not np.isfinite(elk) or elk == 0:
            continue
        stoat = (lizard - raccoon) / elk
        swan = stoat[np.isfinite(stoat)]
        if swan.size < 5:
            continue
        narwhal = int(min(sheep, swan.size))
        ferret = -float(np.mean(swan[-narwhal:]))
        if np.isfinite(ferret):
            gecko[owl[kangaroo]] = float(ferret)
    return _make_factor_series(gecko, date, universe=universe, name='factor1247')

def factor1248(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    lemur = 13 * 21
    lizard = 21
    bear = _last_n_trade_days(fox, lemur)
    if len(bear) < lemur:
        return _make_factor_series({}, date, universe=universe, name='factor1248')
    sparrow = bear[:-lizard]
    rabbit = pd.to_datetime(sparrow).normalize()
    wolf = set(rabbit)
    tuna = rabbit[0].strftime('%Y-%m-%d')
    dolphin = rabbit[-1].strftime('%Y-%m-%d')
    giraffe = get_price(security=list(universe), start_date=tuna, end_date=dolphin, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if giraffe is None or giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1248')
    giraffe = giraffe.copy()
    if 'time' not in giraffe.columns:
        if isinstance(giraffe.index, pd.DatetimeIndex):
            giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
        else:
            giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
    if 'code' not in giraffe.columns:
        if len(universe) == 1:
            giraffe['code'] = list(universe)[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1248')
    giraffe['date'] = pd.to_datetime(giraffe['time']).dt.normalize()
    giraffe = giraffe[giraffe['date'].isin(wolf)]
    if giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1248')
    giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
    giraffe['pre_close'] = pd.to_numeric(giraffe['pre_close'], errors='coerce').astype(float)
    giraffe['ret'] = giraffe['close'] / giraffe['pre_close'] - 1.0
    giraffe['ret'] = giraffe['ret'].replace([np.inf, -np.inf], np.nan)
    owl = giraffe.pivot(index='date', columns='code', values='ret').reindex(rabbit)
    whale = {}
    for otter in universe:
        if otter not in owl.columns:
            continue
        frog = owl[otter].dropna()
        if frog.size < 30:
            continue
        tiger = frog.values.astype(float)
        dog = tiger.size
        panda = float(np.prod(1.0 + tiger) - 1.0)
        lion = np.abs(tiger)
        turtle = lion.argsort()
        badger = np.zeros(dog, dtype=float)
        koala = np.array([5, 4, 3, 2, 1], dtype=float) / 15.0
        eagle = dog // 5
        for shark in range(5):
            salmon = shark * eagle
            zebra = (shark + 1) * eagle if shark < 4 else dog
            hawk = turtle[salmon:zebra]
            badger[hawk] = koala[shark]
        if badger.sum() > 0:
            badger /= badger.sum()
        alpaca = np.sign(tiger) * badger
        cat = -(1.0 / dog) * np.sign(panda) * float(np.sum(alpaca))
        if np.isfinite(cat):
            whale[otter] = float(cat)
    return _make_factor_series(whale, date, universe=universe, name='factor1248')

def factor1249(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1249')

def factor1250(universe, date):
    _set_asof_date(date)
    wolf = _to_date(date)
    zebra = 1e-08
    bear = get_history_fundamentals(security=universe, fields=[bear.term_052], watch_date=wolf, count=1, interval='1q', stat_by_year=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1250')
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    bear = bear.sort_values('statDate').drop_duplicates(['code'], keep='last').set_index('code')
    rabbit = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe)), date=wolf)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1250')
    rabbit = rabbit.set_index('code')
    fox = {}
    for koala in universe:
        if koala not in bear.index or koala not in rabbit.index:
            continue
        shark = float(bear.at[koala, 'term_052'])
        whale = float(rabbit.at[koala, 'term_045'])
        if not np.isfinite(whale) or whale <= 0 or (not np.isfinite(shark)) or (shark == 0):
            continue
        lion = abs(shark)
        owl = math.log(lion + zebra)
        hawk = math.log(whale)
        if not (np.isfinite(owl) and np.isfinite(hawk)):
            continue
        fox[koala] = (owl, hawk)
    if len(fox) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1250')
    otter = list(fox.keys())
    lizard = np.array([fox[tiger][0] for tiger in otter], dtype=float)
    sparrow = np.array([fox[tiger][1] for tiger in otter], dtype=float)
    cat = np.column_stack([np.ones_like(sparrow), sparrow])
    try:
        panda, dog, dog, dog = np.linalg.lstsq(cat, lizard, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1250')
    turtle = cat.dot(panda)
    eagle = lizard - turtle
    dolphin = {}
    for koala, giraffe in zip(otter, eagle):
        if np.isfinite(giraffe):
            dolphin[koala] = float(giraffe)
    return _make_factor_series(dolphin, date, universe=universe, name='factor1250')

def factor1251(universe, date, K_price=240, K_month=20, batch_size=1200):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = _last_n_trade_days(otter, K_price + 1)
    if len(wolf) < K_price + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1251')
    bear = pd.to_datetime(wolf).normalize()
    fox = set(bear)
    frog = bear[0].strftime('%Y-%m-%d')
    shark = bear[-1].strftime('%Y-%m-%d')

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]

    def _fetch_close(secs):
        panda = []
        for cat in _chunks(secs, batch_size):
            dog = get_price(security=cat, start_date=start_str, end_date=end_str, frequency='daily', fields=['close'], fq='post', panel=False)
            if dog is None or dog.empty:
                continue
            dog = dog.copy()
            if 'time' not in dog.columns:
                dog = dog.reset_index().rename(columns={'index': 'time'})
            if 'code' not in dog.columns:
                if len(cat) == 1:
                    dog['code'] = cat[0]
                else:
                    continue
            dog['date'] = pd.to_datetime(dog['time']).dt.normalize()
            dog = dog[dog['date'].isin(day_set)]
            if dog.empty:
                continue
            dog['close'] = pd.to_numeric(dog['close'], errors='coerce').astype(float)
            panda.append(dog[['date', 'code', 'close']])
        if not panda:
            return pd.DataFrame()
        tiger = pd.concat(panda, ignore_index=True)
        return tiger
    lizard = list(universe)
    zebra = _fetch_close(lizard)
    if zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1251')
    lion = zebra.pivot(index='date', columns='code', values='close')
    lion = lion.reindex(index=bear, columns=lizard)
    koala = lion.iloc[-(K_price + 1):]
    owl = np.isfinite(koala.values) & (koala.values > 0)
    turtle = owl.sum(axis=0)
    dolphin = lion.diff().iloc[-K_price:]
    whale = dolphin.notna().sum(axis=0)
    dog = dolphin.clip(lower=0.0).sum(axis=0, skipna=True).astype(float)
    cat = (-dolphin).clip(lower=0.0).sum(axis=0, skipna=True).astype(float)
    rabbit = (dog + cat).astype(float)
    hawk = (dog - cat).astype(float)
    tiger = np.full(len(lizard), np.nan, dtype=float)
    giraffe = rabbit.values.astype(float)
    sparrow = hawk.values.astype(float)
    tuna = (whale.values >= K_price) & (turtle >= K_price + 1) & np.isfinite(giraffe) & (giraffe > 0)
    np.divide(sparrow, giraffe, out=tiger, where=tuna)
    tiger = tiger * 100.0
    eagle = {panda: float(salmon) for panda, salmon in zip(lizard, tiger) if np.isfinite(salmon)}
    return _make_factor_series(eagle, date, universe=universe, name='factor1251')

def factor1252(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1252')

def factor1253(universe, date, L=20, theta=0.1, delta=0.7, batch_size=1200):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = _last_n_trade_days(koala, L + 1)
    if len(fox) < L + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1253')
    wolf = pd.to_datetime(fox).normalize()
    otter = set(wolf)
    camel = wolf[0].strftime('%Y-%m-%d')
    zebra = wolf[-1].strftime('%Y-%m-%d')
    badger = list(universe)

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    whale = []
    for dog in _chunks(badger, batch_size):
        rabbit = get_price(security=dog, start_date=camel, end_date=zebra, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
        if rabbit is None or rabbit.empty:
            continue
        rabbit = rabbit.copy()
        if 'time' not in rabbit.columns:
            rabbit = rabbit.reset_index().rename(columns={'index': 'time'})
        if 'code' not in rabbit.columns:
            if len(dog) == 1:
                rabbit['code'] = dog[0]
            else:
                continue
        rabbit['date'] = pd.to_datetime(rabbit['time']).dt.normalize()
        rabbit = rabbit[rabbit['date'].isin(otter)]
        if rabbit.empty:
            continue
        rabbit['close'] = pd.to_numeric(rabbit['close'], errors='coerce').astype(float)
        rabbit['pre_close'] = pd.to_numeric(rabbit['pre_close'], errors='coerce').astype(float)
        with np.errstate(divide='ignore', invalid='ignore'):
            rabbit['ret'] = rabbit['close'] / rabbit['pre_close'] - 1.0
        rabbit['ret'] = rabbit['ret'].replace([np.inf, -np.inf], np.nan)
        whale.append(rabbit[['date', 'code', 'ret']])
    if not whale:
        return _make_factor_series({}, date, universe=universe, name='factor1253')
    giraffe = pd.concat(whale, ignore_index=True)
    lemur = giraffe.pivot(index='date', columns='code', values='ret').reindex(index=wolf, columns=badger)
    cat = lemur.iloc[-L:]
    if cat.shape[0] < L:
        return _make_factor_series({}, date, universe=universe, name='factor1253')
    alpaca = cat.mean(axis=1, skipna=True)
    bear = (cat.abs().add(alpaca.abs(), axis=0) + float(theta)).replace(0.0, np.nan)
    beaver = cat.sub(alpaca, axis=0).abs().div(bear, axis=0).replace([np.inf, -np.inf], np.nan)
    hawk = beaver.rank(axis=1, ascending=False, method='min')
    eagle = hawk.to_numpy(dtype=float)
    kangaroo = np.full_like(eagle, np.nan, dtype=float)
    frog = np.isfinite(eagle)
    kangaroo[frog] = float(delta) ** eagle[frog]
    llama = np.nansum(kangaroo, axis=0)
    iguana = np.full_like(kangaroo, np.nan, dtype=float)
    np.divide(kangaroo, llama, out=iguana, where=np.isfinite(llama) & (llama > 0))
    tuna = cat.to_numpy(dtype=float)
    sparrow = np.isfinite(iguana) & np.isfinite(tuna)
    panda = sparrow.sum(axis=0).astype(float)
    jaguar = np.where(sparrow, iguana, 0.0)
    salmon = np.where(sparrow, tuna, 0.0)
    mole = jaguar * salmon
    ferret = np.sum(jaguar, axis=0)
    donkey = np.sum(salmon, axis=0)
    gecko = np.sum(mole, axis=0)
    turtle = np.full_like(ferret, np.nan, dtype=float)
    owl = np.full_like(donkey, np.nan, dtype=float)
    lizard = np.full_like(gecko, np.nan, dtype=float)
    np.divide(ferret, panda, out=turtle, where=panda > 0)
    np.divide(donkey, panda, out=owl, where=panda > 0)
    np.divide(gecko, panda, out=lizard, where=panda > 0)
    lion = lizard - turtle * owl
    dolphin = {}
    for shark, tiger in enumerate(badger):
        if int(panda[shark]) < 5:
            continue
        hyena = float(lion[shark])
        if np.isfinite(hyena):
            dolphin[tiger] = hyena
    return _make_factor_series(dolphin, date, universe=universe, name='factor1253')

def factor1254(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1254')

def factor1255(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1255')

def factor1256(universe, date, K=20, batch_size=1200):
    _set_asof_date(date)
    lion = _to_date(date)
    otter = _last_n_trade_days(lion, K + 1)
    if len(otter) < K + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1256')
    fox = pd.to_datetime(otter).normalize()
    koala = set(fox)
    sparrow = fox[0].strftime('%Y-%m-%d')
    rabbit = fox[-1].strftime('%Y-%m-%d')
    hawk = list(universe)

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    zebra = []
    for dog in _chunks(hawk, batch_size):
        wolf = get_price(security=dog, start_date=sparrow, end_date=rabbit, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
        if wolf is None or wolf.empty:
            continue
        wolf = wolf.copy()
        if 'time' not in wolf.columns:
            wolf = wolf.reset_index().rename(columns={'index': 'time'})
        if 'code' not in wolf.columns:
            if len(dog) == 1:
                wolf['code'] = dog[0]
            else:
                continue
        wolf['date'] = pd.to_datetime(wolf['time']).dt.normalize()
        wolf = wolf[wolf['date'].isin(koala)]
        if wolf.empty:
            continue
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf['pre_close'] = pd.to_numeric(wolf['pre_close'], errors='coerce').astype(float)
        with np.errstate(divide='ignore', invalid='ignore'):
            wolf['ret'] = wolf['close'] / wolf['pre_close'] - 1.0
        wolf['ret'] = wolf['ret'].replace([np.inf, -np.inf], np.nan)
        zebra.append(wolf[['date', 'code', 'ret']])
    if not zebra:
        return _make_factor_series({}, date, universe=universe, name='factor1256')
    bear = pd.concat(zebra, ignore_index=True)
    whale = bear.pivot(index='date', columns='code', values='ret').reindex(index=fox, columns=hawk)
    shark = whale.iloc[-K:]
    tiger = shark.count(axis=0)
    dolphin = shark.clip(lower=0.0).sum(axis=0, skipna=True).astype(float)
    cat = shark.abs().sum(axis=0, skipna=True).astype(float)
    eagle = np.full(len(hawk), np.nan, dtype=float)
    np.divide(dolphin.values.astype(float), cat.values.astype(float), out=eagle, where=(cat.values.astype(float) > 0) & (tiger.values >= K))
    giraffe = {panda: float(owl) for panda, owl in zip(hawk, eagle) if np.isfinite(owl)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor1256')

def factor1257(universe, date, window=20, freq='1m', batch_size=200):
    _set_asof_date(date)
    fox = _to_date(date)
    bear = _last_n_trade_days(fox, window)
    if len(bear) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1257')
    rabbit = pd.to_datetime(bear).normalize()
    wolf = set(rabbit)
    turtle = rabbit[0].strftime('%Y-%m-%d')
    zebra = (rabbit[-1] + pd.Timedelta(days=1)).strftime('%Y-%m-%d')

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]

    def _daily_peak_cov(o, h, l, c):
        cat = c.size
        if cat < 15:
            return np.nan
        if not (np.isfinite(o).all() and np.isfinite(h).all() and np.isfinite(l).all() and np.isfinite(c).all()):
            return np.nan
        sparrow = 5
        wolf = 4 * sparrow
        rabbit = pd.Series(o).rolling(sparrow, min_periods=sparrow).sum().values + pd.Series(h).rolling(sparrow, min_periods=sparrow).sum().values + pd.Series(l).rolling(sparrow, min_periods=sparrow).sum().values + pd.Series(c).rolling(sparrow, min_periods=sparrow).sum().values
        giraffe = pd.Series(o * o).rolling(sparrow, min_periods=sparrow).sum().values + pd.Series(h * h).rolling(sparrow, min_periods=sparrow).sum().values + pd.Series(l * l).rolling(sparrow, min_periods=sparrow).sum().values + pd.Series(c * c).rolling(sparrow, min_periods=sparrow).sum().values
        otter = rabbit / float(wolf)
        shark = giraffe / float(wolf) - otter * otter
        shark = np.where(np.isfinite(shark), np.maximum(shark, 0.0), np.nan)
        eagle = shark * float(wolf) / float(wolf - 1)
        zebra = np.sqrt(eagle)
        panda = np.full(cat, np.nan, dtype=float)
        lion = np.isfinite(zebra) & np.isfinite(otter) & (otter > 0)
        panda[lion] = (zebra[lion] / otter[lion]) ** 2
        bear = np.full(cat, np.nan, dtype=float)
        bear[1:] = c[1:] / c[:-1] - 1.0
        hawk = np.full(cat, np.nan, dtype=float)
        koala = np.isfinite(bear) & np.isfinite(panda) & (panda > 0)
        if koala.sum() < 8:
            return np.nan
        hawk[koala] = bear[koala] / panda[koala]
        tiger = panda[np.isfinite(panda)]
        if tiger.size < 8:
            return np.nan
        fox = float(np.mean(tiger))
        dolphin = float(np.std(tiger, ddof=1)) if tiger.size > 1 else 0.0
        if not np.isfinite(fox) or not np.isfinite(dolphin):
            return np.nan
        whale = fox + dolphin
        dog = np.isfinite(hawk) & np.isfinite(panda) & (panda >= whale)
        if dog.sum() < 5:
            return np.nan
        owl = hawk[dog].astype(float)
        turtle = panda[dog].astype(float)
        if owl.size < 5 or np.std(owl, ddof=1) == 0 or np.std(turtle, ddof=1) == 0:
            return np.nan
        return float(np.mean((owl - owl.mean()) * (turtle - turtle.mean())))
    otter = {}
    for dog in _chunks(list(universe), batch_size):
        giraffe = get_price(security=dog, start_date=turtle, end_date=zebra, frequency=freq, fields=['open', 'high', 'low', 'close'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
        if 'code' not in giraffe.columns:
            if len(dog) == 1:
                giraffe['code'] = dog[0]
            else:
                continue
        giraffe['time'] = pd.to_datetime(giraffe['time'])
        giraffe['date'] = giraffe['time'].dt.normalize()
        giraffe = giraffe[giraffe['date'].isin(wolf)]
        if giraffe.empty:
            continue
        for lion in ['open', 'high', 'low', 'close']:
            giraffe[lion] = pd.to_numeric(giraffe[lion], errors='coerce').astype(float)
        giraffe = giraffe.sort_values(['code', 'date', 'time'])
        for (tiger, koala), lizard in giraffe.groupby(['code', 'date'], sort=False):
            frog = lizard[['open', 'high', 'low', 'close']].dropna()
            if frog.shape[0] < 15:
                continue
            sparrow = frog['open'].values.astype(float)
            whale = frog['high'].values.astype(float)
            shark = frog['low'].values.astype(float)
            panda = frog['close'].values.astype(float)
            salmon = _daily_peak_cov(sparrow, whale, shark, panda)
            if np.isfinite(salmon):
                otter.setdefault(tiger, []).append(float(salmon))
    dolphin = {}
    for tiger, eagle in otter.items():
        cat = np.array(eagle, dtype=float)
        if cat.size == 0:
            continue
        hawk = float(np.mean(cat))
        owl = float(np.std(cat, ddof=1)) if cat.size > 1 else 0.0
        tuna = 0.5 * (hawk + owl)
        if np.isfinite(tuna):
            dolphin[tiger] = float(tuna)
    return _make_factor_series(dolphin, date, universe=universe, name='factor1257')

def factor1258(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1258')

def factor1259(universe, date, m=20, batch_size=1200):
    _set_asof_date(date)
    tiger = _to_date(date)
    koala = _last_n_trade_days(tiger, m)
    if len(koala) < m:
        return _make_factor_series({}, date, universe=universe, name='factor1259')
    otter = pd.to_datetime(koala).normalize()
    lion = set(otter)
    whale = otter[0].strftime('%Y-%m-%d')
    bear = otter[-1].strftime('%Y-%m-%d')
    dolphin = list(universe)

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    giraffe = []
    for cat in _chunks(dolphin, batch_size):
        fox = get_price(security=cat, start_date=whale, end_date=bear, frequency='daily', fields=['volume'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        if 'time' not in fox.columns:
            fox = fox.reset_index().rename(columns={'index': 'time'})
        if 'code' not in fox.columns:
            if len(cat) == 1:
                fox['code'] = cat[0]
            else:
                continue
        fox['date'] = pd.to_datetime(fox['time']).dt.normalize()
        fox = fox[fox['date'].isin(lion)]
        if fox.empty:
            continue
        fox['volume'] = pd.to_numeric(fox['volume'], errors='coerce').astype(float)
        giraffe.append(fox[['date', 'code', 'volume']])
    if not giraffe:
        return _make_factor_series({}, date, universe=universe, name='factor1259')
    wolf = pd.concat(giraffe, ignore_index=True)
    eagle = wolf.pivot(index='date', columns='code', values='volume').reindex(index=otter, columns=dolphin)
    dog = eagle.count(axis=0)
    zebra = eagle.mean(axis=0, skipna=True)
    rabbit = {}
    for panda in dolphin:
        if int(dog.get(panda, 0)) < m:
            continue
        shark = float(zebra.get(panda, np.nan))
        if np.isfinite(shark):
            rabbit[panda] = shark
    return _make_factor_series(rabbit, date, universe=universe, name='factor1259')

def factor1260(universe, date, window=20, freq='1m', batch_size=200):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = _last_n_trade_days(koala, window)
    if len(fox) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1260')
    wolf = pd.to_datetime(fox).normalize()
    otter = set(wolf)
    hawk = wolf[0].strftime('%Y-%m-%d')
    rabbit = (wolf[-1] + pd.Timedelta(days=1)).strftime('%Y-%m-%d')

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]

    def _daily_ratio(c, money):
        if c.size < 15 or money.size != c.size:
            return np.nan
        if not (np.isfinite(c).all() and np.isfinite(money).all()):
            return np.nan
        koala = c[1:] / c[:-1] - 1.0
        lion = money[1:]
        if koala.size < 10:
            return np.nan
        otter = pd.Series(koala)
        bear = otter.rolling(5, min_periods=5).std(ddof=1)
        fox = bear.rolling(5, min_periods=5).std(ddof=1)
        panda = pd.DataFrame({'vague': fox.values, 'money': lion.astype(float)})
        panda = panda.replace([np.inf, -np.inf], np.nan).dropna()
        if panda.shape[0] < 8:
            return np.nan
        wolf = float(panda['vague'].mean())
        if not np.isfinite(wolf):
            return np.nan
        cat = panda['vague'].values.astype(float) > wolf
        if cat.sum() == 0:
            return np.nan
        tiger = float(panda['money'].values.astype(float)[cat].mean())
        dog = float(panda['money'].values.astype(float).mean())
        if not np.isfinite(tiger) or not np.isfinite(dog) or dog <= 0:
            return np.nan
        return float(tiger / dog)
    shark = {}
    for dog in _chunks(list(universe), batch_size):
        bear = get_price(security=dog, start_date=hawk, end_date=rabbit, frequency=freq, fields=['close', 'money'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        if 'time' not in bear.columns:
            bear = bear.reset_index().rename(columns={'index': 'time'})
        if 'code' not in bear.columns:
            if len(dog) == 1:
                bear['code'] = dog[0]
            else:
                continue
        bear['time'] = pd.to_datetime(bear['time'])
        bear['date'] = bear['time'].dt.normalize()
        bear = bear[bear['date'].isin(otter)]
        if bear.empty:
            continue
        bear['close'] = pd.to_numeric(bear['close'], errors='coerce').astype(float)
        bear['money'] = pd.to_numeric(bear['money'], errors='coerce').astype(float)
        bear = bear.dropna(subset=['close', 'money'])
        if bear.empty:
            continue
        bear = bear.sort_values(['code', 'date', 'time'])
        for (tiger, lion), sparrow in bear.groupby(['code', 'date'], sort=False):
            panda = sparrow['close'].values.astype(float)
            dolphin = sparrow['money'].values.astype(float)
            owl = _daily_ratio(panda, dolphin)
            if np.isfinite(owl):
                shark.setdefault(tiger, []).append(float(owl))
    giraffe = {}
    for tiger, zebra in shark.items():
        cat = np.array(zebra, dtype=float)
        if cat.size == 0:
            continue
        whale = float(np.mean(cat))
        eagle = float(np.std(cat, ddof=1)) if cat.size > 1 else 0.0
        turtle = 0.5 * (whale + eagle)
        if np.isfinite(turtle):
            giraffe[tiger] = float(turtle)
    return _make_factor_series(giraffe, date, universe=universe, name='factor1260')

def factor1261(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1261')

def factor1262(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1262')

def factor1263(universe, date, eps=1e-08):
    _set_asof_date(date)
    rabbit = _to_date(date)
    panda = pd.Timestamp(rabbit)
    salmon = pd.Period(panda, freq='Q-DEC') - 1
    frog = salmon - 4
    owl = pd.PeriodIndex([frog, salmon], freq='Q-DEC')
    wolf = list(universe)
    dolphin = get_history_fundamentals(security=wolf, fields=[bear.term_052], watch_date=panda, count=12, interval='1q', stat_by_year=False)
    if dolphin is None or dolphin.empty or 'code' not in dolphin.columns or ('statDate' not in dolphin.columns):
        return _make_factor_series({}, rabbit, universe=universe, name='factor1263')
    dolphin = dolphin.copy()
    if 'pubDate' in dolphin.columns:
        lizard = pd.to_datetime(dolphin['pubDate'], errors='coerce')
        dolphin = dolphin[lizard.notna() & (lizard <= panda)]
    dolphin['code'] = dolphin['code'].astype(str)
    dolphin['statDate'] = pd.to_datetime(dolphin['statDate'], errors='coerce')
    dolphin = dolphin.dropna(subset=['code', 'statDate'])
    if dolphin.empty or 'term_052' not in dolphin.columns:
        return _make_factor_series({}, rabbit, universe=universe, name='factor1263')
    dolphin['q'] = dolphin['statDate'].dt.to_period('Q-DEC')
    dolphin = dolphin[dolphin['q'].isin(owl)]
    dolphin = dolphin.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    turtle = dolphin.pivot(index='q', columns='code', values='term_052').reindex(index=owl, columns=wolf)
    turtle = turtle.apply(pd.to_numeric, errors='coerce').astype(float)
    giraffe = (turtle.loc[salmon] - turtle.loc[frog]).replace([np.inf, -np.inf], np.nan)
    zebra = get_history_fundamentals(security=wolf, fields=[fox.total_owner_equities], watch_date=panda, count=8, interval='1q', stat_by_year=False)
    if zebra is None or zebra.empty or 'code' not in zebra.columns or ('statDate' not in zebra.columns):
        return _make_factor_series({}, rabbit, universe=universe, name='factor1263')
    zebra = zebra.copy()
    if 'pubDate' in zebra.columns:
        lizard = pd.to_datetime(zebra['pubDate'], errors='coerce')
        zebra = zebra[lizard.notna() & (lizard <= panda)]
    zebra['code'] = zebra['code'].astype(str)
    zebra['statDate'] = pd.to_datetime(zebra['statDate'], errors='coerce')
    zebra = zebra.dropna(subset=['code', 'statDate'])
    if zebra.empty or 'total_owner_equities' not in zebra.columns:
        return _make_factor_series({}, rabbit, universe=universe, name='factor1263')
    zebra['q'] = zebra['statDate'].dt.to_period('Q-DEC')
    zebra = zebra.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    otter = zebra.pivot(index='q', columns='code', values='total_owner_equities').sort_index().reindex(columns=wolf)
    otter = otter.apply(pd.to_numeric, errors='coerce').astype(float)
    if salmon in otter.index:
        koala = otter.loc[salmon]
    else:
        koala = otter[otter.index <= salmon].tail(1)
        koala = koala.iloc[0] if not koala.empty else pd.Series(np.nan, index=wolf, dtype='float64')
    koala = koala.replace([np.inf, -np.inf], np.nan)
    hawk = pd.DataFrame({'delta': giraffe, 'book': koala}).dropna()
    if hawk.empty:
        return _make_factor_series({}, rabbit, universe=universe, name='factor1263')
    whale = hawk['delta'].astype(float)
    lion = hawk['book'].astype(float)
    sparrow = np.isfinite(whale.values) & np.isfinite(lion.values) & (lion.values > 0) & (whale.values != 0)
    if sparrow.sum() < 30:
        return _make_factor_series({}, rabbit, universe=universe, name='factor1263')
    whale = whale[sparrow]
    lion = lion[sparrow]
    bear = whale.index.tolist()
    badger = np.log(np.abs(whale.values) + float(eps))
    alpaca = np.log(lion.values)
    lemur = (whale.values < 0).astype(float)
    cat = np.column_stack([np.ones_like(alpaca), alpaca, lemur])
    try:
        tiger, dog, dog, dog = np.linalg.lstsq(cat, badger, rcond=None)
        tuna = badger - cat.dot(tiger)
    except Exception:
        return _make_factor_series({}, rabbit, universe=universe, name='factor1263')
    eagle = {fox: float(shark) for fox, shark in zip(bear, tuna) if np.isfinite(shark)}
    return _make_factor_series(eagle, rabbit, universe=universe, name='factor1263')

def factor1264(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1264')

def factor1265(universe, date, K_price=239, batch_size=1200):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = _last_n_trade_days(otter, K_price + 1)
    if len(wolf) < K_price + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1265')
    bear = pd.to_datetime(wolf).normalize()
    fox = set(bear)
    frog = bear[0].strftime('%Y-%m-%d')
    shark = bear[-1].strftime('%Y-%m-%d')
    turtle = list(universe)

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    hawk = []
    for cat in _chunks(turtle, batch_size):
        dolphin = get_price(security=cat, start_date=frog, end_date=shark, frequency='daily', fields=['close'], fq='post', panel=False)
        if dolphin is None or dolphin.empty:
            continue
        dolphin = dolphin.copy()
        if 'time' not in dolphin.columns:
            dolphin = dolphin.reset_index().rename(columns={'index': 'time'})
        if 'code' not in dolphin.columns:
            if len(cat) == 1:
                dolphin['code'] = cat[0]
            else:
                continue
        dolphin['date'] = pd.to_datetime(dolphin['time']).dt.normalize()
        dolphin = dolphin[dolphin['date'].isin(fox)]
        if dolphin.empty:
            continue
        dolphin['close'] = pd.to_numeric(dolphin['close'], errors='coerce').astype(float)
        hawk.append(dolphin[['date', 'code', 'close']])
    if not hawk:
        return _make_factor_series({}, date, universe=universe, name='factor1265')
    whale = pd.concat(hawk, ignore_index=True)
    tiger = whale.pivot(index='date', columns='code', values='close').reindex(index=bear, columns=turtle)
    dog = tiger.to_numpy(dtype=float)
    panda = np.roll(dog, 1, axis=0)
    panda[0, :] = np.nan
    zebra = np.maximum(dog, panda)
    owl = dog - panda
    rabbit = np.full_like(owl, np.nan, dtype=float)
    alpaca = np.isfinite(owl) & np.isfinite(zebra) & (zebra > 0)
    np.divide(owl, zebra, out=rabbit, where=alpaca)
    giraffe = rabbit[-K_price:, :]
    lion = np.isfinite(giraffe).sum(axis=0).astype(float)
    salmon = np.nansum(giraffe, axis=0)
    lizard = np.full_like(salmon, np.nan, dtype=float)
    np.divide(salmon, lion, out=lizard, where=lion > 0)
    eagle = {}
    for sparrow, koala in enumerate(turtle):
        if int(lion[sparrow]) < K_price:
            continue
        tuna = float(lizard[sparrow])
        if np.isfinite(tuna):
            eagle[koala] = tuna
    return _make_factor_series(eagle, date, universe=universe, name='factor1265')

def factor1266(universe, date, R_days=20, freq='1m', batch_size=200):
    _set_asof_date(date)
    lion = _to_date(date)
    otter = _last_n_trade_days(lion, R_days)
    if len(otter) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1266')
    fox = pd.to_datetime(otter).normalize()
    koala = set(fox)
    sparrow = fox[0].strftime('%Y-%m-%d')
    zebra = (fox[-1] + pd.Timedelta(days=1)).strftime('%Y-%m-%d')

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    rabbit = {}
    for dog in _chunks(list(universe), batch_size):
        wolf = get_price(security=dog, start_date=sparrow, end_date=zebra, frequency=freq, fields=['close'], fq='post', panel=False)
        if wolf is None or wolf.empty:
            continue
        wolf = wolf.copy()
        if 'time' not in wolf.columns:
            wolf = wolf.reset_index().rename(columns={'index': 'time'})
        if 'code' not in wolf.columns:
            if len(dog) == 1:
                wolf['code'] = dog[0]
            else:
                continue
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['date'] = wolf['time'].dt.normalize()
        wolf = wolf[wolf['date'].isin(koala)]
        if wolf.empty:
            continue
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        wolf = wolf.dropna(subset=['close'])
        if wolf.empty:
            continue
        wolf = wolf.sort_values(['code', 'date', 'time'])
        for (panda, tiger), owl in wolf.groupby(['code', 'date'], sort=False):
            shark = owl['close'].values.astype(float)
            if shark.size < 6 or np.any(~np.isfinite(shark)) or np.any(shark <= 0):
                continue
            eagle = shark[1:] / shark[:-1] - 1.0
            if eagle.size < 3 or np.any(~np.isfinite(eagle)):
                continue
            hawk = eagle * eagle
            turtle = float(np.sum(hawk[eagle > 0]))
            giraffe = float(np.sum(hawk[eagle < 0]))
            bear = turtle - giraffe
            if np.isfinite(bear):
                rabbit.setdefault(panda, []).append(float(bear))
    dolphin = {}
    for panda, whale in rabbit.items():
        cat = np.array(whale, dtype=float)
        if cat.size == 0:
            continue
        lizard = float(np.mean(cat))
        if np.isfinite(lizard):
            dolphin[panda] = lizard
    return _make_factor_series(dolphin, date, universe=universe, name='factor1266')

def factor1267(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1267')

def factor1268(universe, date, N_days=20, freq='1m', batch_size=200):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = _last_n_trade_days(tiger, N_days + 1)
    if len(lion) < N_days + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1268')
    tuna = pd.to_datetime(lion[0]).normalize()
    wolf = pd.to_datetime(lion[-2]).normalize()
    lemur = pd.to_datetime(lion[-1]).normalize()
    alpaca = tuna.strftime('%Y-%m-%d')
    bear = wolf.strftime('%Y-%m-%d')
    beaver = lemur.strftime('%Y-%m-%d')
    badger = (lemur + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    camel = list(universe)
    ferret = [pd.to_datetime(gecko).date() for gecko in lion[:-1]]
    fox = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(camel)), date=tiger)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1268')
    owl = pd.Series(fox['term_045'].values, index=fox['code'].values).astype(float)
    owl = owl.reindex(camel)
    owl = owl.where(np.isfinite(owl) & (owl > 0), np.nan)
    koala = get_price(camel, start_date=alpaca, end_date=bear, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1268')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index()
    if 'code' not in koala.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1268')
    koala['time'] = pd.to_datetime(koala['time'])
    koala['date'] = koala['time'].dt.date
    koala = koala[['code', 'date', 'open', 'close']].dropna(subset=['open', 'close'])
    koala['open'] = pd.to_numeric(koala['open'], errors='coerce').astype(float)
    koala['close'] = pd.to_numeric(koala['close'], errors='coerce').astype(float)
    koala = koala[np.isfinite(koala['open'].values) & np.isfinite(koala['close'].values) & (koala['open'].values > 0)]
    if koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1268')
    turtle = koala.pivot(index='date', columns='code', values='open').reindex(index=ferret, columns=camel)
    dog = koala.pivot(index='date', columns='code', values='close').reindex(index=ferret, columns=camel)
    with np.errstate(divide='ignore', invalid='ignore'):
        frog = dog / turtle - 1.0
    frog = frog.replace([np.inf, -np.inf], np.nan)
    salmon = frog.mean(axis=0, skipna=True).reindex(camel)
    rabbit = {panda: np.nan for panda in camel}
    for shark in range(0, len(camel), max(1, int(batch_size))):
        cat = camel[shark:shark + max(1, int(batch_size))]
        otter = get_price(cat, start_date=beaver, end_date=badger, frequency=freq, fields=['open', 'close', 'money'], fq='post', panel=False)
        if otter is None or otter.empty:
            continue
        otter = otter.copy()
        if 'time' not in otter.columns:
            otter['time'] = otter.index
        otter['time'] = pd.to_datetime(otter['time'])
        if 'code' not in otter.columns:
            if len(cat) == 1:
                otter['code'] = cat[0]
            else:
                continue
        otter = otter[['code', 'time', 'open', 'close', 'money']].dropna(subset=['close', 'money'])
        if otter.empty:
            continue
        otter['close'] = pd.to_numeric(otter['close'], errors='coerce').astype(float)
        otter['money'] = pd.to_numeric(otter['money'], errors='coerce').astype(float)
        otter['open'] = pd.to_numeric(otter['open'], errors='coerce').astype(float)
        otter = otter[np.isfinite(otter['close'].values) & np.isfinite(otter['money'].values)]
        if otter.empty:
            continue
        otter = otter.sort_values(['code', 'time'])
        zebra = otter.groupby('code', sort=False)['open'].first().astype(float)
        giraffe = otter.groupby('code', sort=False)['close'].first().astype(float)
        lizard = zebra.where(np.isfinite(zebra) & (zebra > 0), giraffe)
        lizard = lizard.where(np.isfinite(lizard) & (lizard > 0), np.nan)
        otter = otter.join(lizard.rename('open_t'), on='code')
        otter['thr'] = otter['code'].map(salmon.to_dict())
        otter = otter.dropna(subset=['open_t', 'thr'])
        if otter.empty:
            continue
        with np.errstate(divide='ignore', invalid='ignore'):
            otter['rel_ret'] = otter['close'] / otter['open_t'] - 1.0
        otter = otter.replace([np.inf, -np.inf], np.nan).dropna(subset=['rel_ret'])
        if otter.empty:
            continue
        otter['is_high'] = otter['rel_ret'] >= otter['thr']
        otter['is_low'] = ~otter['is_high']
        whale = otter.loc[otter['is_high']].groupby('code', sort=False)['money'].sum()
        hawk = otter.loc[otter['is_low']].groupby('code', sort=False)['money'].sum()
        for panda in set(whale.index).union(set(hawk.index)):
            sparrow = float(owl.get(panda, np.nan))
            if not (np.isfinite(sparrow) and sparrow > 0):
                continue
            if panda not in whale.index or panda not in hawk.index:
                continue
            dolphin = float(whale.get(panda, 0.0))
            eagle = float(hawk.get(panda, 0.0))
            donkey = (dolphin - eagle) / sparrow
            if np.isfinite(donkey):
                rabbit[panda] = float(donkey)
    return _make_factor_series(rabbit, date, universe=universe, name='factor1268')

def factor1269(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1269')

def factor1270(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1270')

def factor1271(universe, date):
    _set_asof_date(date)
    zebra = _to_date(date)
    rabbit = pd.Period(zebra, freq='M')
    tuna = [rabbit - turtle for turtle in range(11, -1, -1)]
    shark = tuna[0]
    frog = tuna[-1]
    ferret = dt.date(shark.year, shark.month, 1)
    lemur = dt.date(frog.year + (1 if frog.month == 12 else 0), 1 if frog.month == 12 else frog.month + 1, 1)
    eagle = lemur - dt.timedelta(days=1)
    lion = list(get_trade_days(start_date=ferret, end_date=eagle))
    if len(lion) < 40:
        return _make_factor_series({}, date, universe=universe, name='factor1271')
    tiger = [pd.to_datetime(giraffe).date() for giraffe in lion]
    gecko = pd.to_datetime(tiger[0]).strftime('%Y-%m-%d')
    hawk = pd.to_datetime(tiger[-1]).strftime('%Y-%m-%d')
    whale = get_price(security=universe, start_date=gecko, end_date=hawk, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if whale is None or whale.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1271')
    whale = whale.copy()
    if 'time' in whale.columns:
        whale['date'] = pd.to_datetime(whale['time']).dt.date
    else:
        whale = whale.reset_index().rename(columns={'index': 'time'})
        whale['date'] = pd.to_datetime(whale['time']).dt.date
    whale = whale[whale['date'].isin(tiger)]
    if whale.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1271')
    badger = whale.pivot(index='date', columns='code', values='open').reindex(index=tiger, columns=universe)
    fox = whale.pivot(index='date', columns='code', values='close').reindex(index=tiger, columns=universe)
    otter = fox.shift(1)
    with np.errstate(divide='ignore', invalid='ignore'):
        camel = badger / otter - 1.0
        donkey = fox / badger - 1.0
    lizard = (badger <= 0) | (otter <= 0) | ~badger.notna() | ~otter.notna() | ~fox.notna()
    camel = camel.mask(lizard)
    donkey = donkey.mask(lizard)
    bear = (camel < 0) & (donkey > 0)
    cat = pd.DataFrame(np.nan, index=badger.index, columns=badger.columns, dtype=float)
    iguana = camel.notna() & donkey.notna()
    cat[iguana & ~bear] = 0.0
    cat[bear] = 1.0
    dolphin = pd.to_datetime(cat.index).to_period('M')
    panda = []
    for beaver in tuna:
        salmon = dolphin == beaver
        if not salmon.any():
            panda.append(pd.Series(np.nan, index=cat.columns))
        else:
            panda.append(cat.loc[salmon].mean(axis=0, skipna=True))
    dog = pd.DataFrame(panda, index=[pd.Period(dt.date(beaver.year, beaver.month, 1), freq='M') for beaver in tuna])
    sparrow = {}
    for wolf in universe:
        if wolf not in dog.columns:
            continue
        koala = dog[wolf].values.astype(float)
        if koala.size != len(tuna) or not np.isfinite(koala[-1]):
            continue
        owl = koala[np.isfinite(koala)]
        if owl.size < 2:
            continue
        alpaca = float(owl.mean())
        if not np.isfinite(alpaca) or alpaca == 0:
            continue
        hyena = float(koala[-1] / alpaca)
        if np.isfinite(hyena):
            sparrow[wolf] = hyena
    return _make_factor_series(sparrow, date, universe=universe, name='factor1271')

def factor1272(universe, date, eps=1e-08):
    _set_asof_date(date)
    otter = _to_date(date)
    panda = pd.Timestamp(otter)
    koala = list(universe)
    frog = pd.Period(panda, freq='Q-DEC') - 1
    lizard = frog - 4
    sparrow = pd.PeriodIndex([lizard, frog], freq='Q-DEC')
    wolf = get_history_fundamentals(security=koala, fields=[bear.term_063], watch_date=panda, count=16, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or 'code' not in wolf.columns or ('statDate' not in wolf.columns):
        return _make_factor_series({}, otter, universe=universe, name='factor1272')
    wolf = wolf.copy()
    if 'pubDate' in wolf.columns:
        turtle = pd.to_datetime(wolf['pubDate'], errors='coerce')
        wolf = wolf[turtle.notna() & (turtle <= panda)]
    wolf['code'] = wolf['code'].astype(str)
    wolf['statDate'] = pd.to_datetime(wolf['statDate'], errors='coerce')
    wolf = wolf.dropna(subset=['code', 'statDate'])
    if wolf.empty or 'term_063' not in wolf.columns:
        return _make_factor_series({}, otter, universe=universe, name='factor1272')
    wolf['q'] = wolf['statDate'].dt.to_period('Q-DEC')
    wolf = wolf[wolf['q'].isin(sparrow)]
    wolf = wolf.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    owl = wolf.pivot(index='q', columns='code', values='term_063').reindex(index=sparrow, columns=koala)
    owl = owl.apply(pd.to_numeric, errors='coerce').astype(float)
    fox = (owl.loc[frog] - owl.loc[lizard]).replace([np.inf, -np.inf], np.nan)
    bear = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(koala)), date=pd.Timestamp(otter).strftime('%Y-%m-%d'))
    if bear is None or bear.empty or 'code' not in bear.columns or ('term_045' not in bear.columns):
        return _make_factor_series({}, otter, universe=universe, name='factor1272')
    bear = bear.copy()
    bear['code'] = bear['code'].astype(str)
    eagle = pd.to_numeric(bear.set_index('code')['term_045'], errors='coerce').astype(float).reindex(koala)
    whale = pd.DataFrame({'delta': fox, 'mv': eagle}).dropna()
    if whale.empty:
        return _make_factor_series({}, otter, universe=universe, name='factor1272')
    rabbit = whale['delta'].astype(float)
    hawk = whale['mv'].astype(float)
    shark = np.isfinite(rabbit.values) & np.isfinite(hawk.values) & (hawk.values > 0) & (rabbit.values != 0)
    if shark.sum() < 30:
        return _make_factor_series({}, otter, universe=universe, name='factor1272')
    rabbit = rabbit[shark]
    hawk = hawk[shark]
    dolphin = rabbit.index.tolist()
    alpaca = np.log(np.abs(rabbit.values) + float(eps))
    tuna = np.log(hawk.values)
    cat = np.column_stack([np.ones_like(tuna), tuna])
    try:
        tiger, dog, dog, dog = np.linalg.lstsq(cat, alpaca, rcond=None)
        salmon = alpaca - cat.dot(tiger)
    except Exception:
        return _make_factor_series({}, otter, universe=universe, name='factor1272')
    zebra = {lion: float(giraffe) for lion, giraffe in zip(dolphin, salmon) if np.isfinite(giraffe)}
    return _make_factor_series(zebra, otter, universe=universe, name='factor1272')

def factor1273(universe, date, delta=0.94, max_lookback=252, batch_size=1200):
    _set_asof_date(date)
    tiger = _to_date(date)
    koala = _last_n_trade_days(tiger, max_lookback + 1)
    if len(koala) < max_lookback + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1273')
    otter = pd.to_datetime(koala).normalize()
    lion = set(otter)
    owl = otter[0].strftime('%Y-%m-%d')
    bear = otter[-1].strftime('%Y-%m-%d')
    hawk = list(universe)
    zebra = np.arange(0, max_lookback, dtype=float)
    salmon = (1.0 - float(delta)) * float(delta) ** zebra
    salmon = salmon / float(np.sum(salmon))

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    giraffe = []
    for cat in _chunks(hawk, batch_size):
        fox = get_price(security=cat, start_date=owl, end_date=bear, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        if 'time' not in fox.columns:
            fox = fox.reset_index().rename(columns={'index': 'time'})
        if 'code' not in fox.columns:
            if len(cat) == 1:
                fox['code'] = cat[0]
            else:
                continue
        fox['date'] = pd.to_datetime(fox['time']).dt.normalize()
        fox = fox[fox['date'].isin(lion)]
        if fox.empty:
            continue
        fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
        fox['pre_close'] = pd.to_numeric(fox['pre_close'], errors='coerce').astype(float)
        with np.errstate(divide='ignore', invalid='ignore'):
            fox['ret'] = fox['close'] / fox['pre_close'] - 1.0
        fox['ret'] = fox['ret'].replace([np.inf, -np.inf], np.nan)
        giraffe.append(fox[['date', 'code', 'ret']])
    if not giraffe:
        return _make_factor_series({}, date, universe=universe, name='factor1273')
    wolf = pd.concat(giraffe, ignore_index=True)
    shark = wolf.pivot(index='date', columns='code', values='ret').reindex(index=otter, columns=hawk)
    eagle = shark.iloc[-max_lookback:]
    panda = eagle.count(axis=0).values.astype(int)
    whale = eagle.iloc[::-1].to_numpy(dtype=float) ** 2
    dolphin = np.isfinite(whale).all(axis=0) & (panda >= max_lookback)
    lizard = np.full(whale.shape[1], np.nan, dtype=float)
    if dolphin.any():
        frog = np.dot(salmon.astype(float), whale[:, dolphin].astype(float))
        lizard[dolphin] = frog
    lizard = np.where(np.isfinite(lizard), np.maximum(lizard, 0.0), np.nan)
    sparrow = np.sqrt(252.0 * lizard)
    rabbit = {dog: float(turtle) for dog, turtle in zip(hawk, sparrow) if np.isfinite(turtle)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor1273')

def factor1274(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1274')

def factor1275(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1275')

def factor1276(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1276')

def factor1277(universe, date, L_list=None, batch_size=1200):
    _set_asof_date(date)
    fox = _to_date(date)
    if L_list is None:
        L_list = [5, 10, 20, 60]
    L_list = sorted([int(lemur) for lemur in L_list])
    if len(L_list) < 2:
        return _make_factor_series({}, date, universe=universe, name='factor1277')
    owl = int(L_list[-1])
    bear = _last_n_trade_days(fox, owl)
    if len(bear) < owl:
        return _make_factor_series({}, date, universe=universe, name='factor1277')
    rabbit = pd.to_datetime(bear).normalize()
    wolf = set(rabbit)
    tuna = rabbit[0].strftime('%Y-%m-%d')
    whale = rabbit[-1].strftime('%Y-%m-%d')
    frog = list(universe)

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    eagle = []
    for tiger in _chunks(frog, batch_size):
        giraffe = get_price(security=tiger, start_date=tuna, end_date=whale, frequency='daily', fields=['close'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
        if 'code' not in giraffe.columns:
            if len(tiger) == 1:
                giraffe['code'] = tiger[0]
            else:
                continue
        giraffe['date'] = pd.to_datetime(giraffe['time']).dt.normalize()
        giraffe = giraffe[giraffe['date'].isin(wolf)]
        if giraffe.empty:
            continue
        giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
        eagle.append(giraffe[['date', 'code', 'close']])
    if not eagle:
        return _make_factor_series({}, date, universe=universe, name='factor1277')
    zebra = pd.concat(eagle, ignore_index=True)
    koala = zebra.pivot(index='date', columns='code', values='close').reindex(index=rabbit, columns=frog)
    otter = koala.count(axis=0).values.astype(int)
    turtle = otter >= owl
    sparrow = {}
    for cat in L_list:
        sparrow[cat] = koala.iloc[-cat:].mean(axis=0, skipna=False).to_numpy(dtype=float)
    salmon = np.full(len(frog), np.nan, dtype=float)
    if turtle.any():
        lizard = np.zeros(len(frog), dtype=float)
        for hawk in range(len(L_list) - 1):
            dog = sparrow[L_list[hawk]]
            panda = sparrow[L_list[hawk + 1]]
            dolphin = dog - panda
            lizard += np.sign(dolphin)
        salmon[turtle] = lizard[turtle]
    shark = {lion: float(alpaca) for lion, alpaca in zip(frog, salmon) if np.isfinite(alpaca)}
    return _make_factor_series(shark, date, universe=universe, name='factor1277')

def factor1278(universe, date, m=20, batch_size=1200):
    _set_asof_date(date)
    otter = _to_date(date)
    wolf = _last_n_trade_days(otter, m + 1)
    if len(wolf) < m + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1278')
    bear = pd.to_datetime(wolf).normalize()
    fox = set(bear)
    lizard = bear[0].strftime('%Y-%m-%d')
    dolphin = bear[-1].strftime('%Y-%m-%d')
    owl = list(universe)

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    whale = []
    for tiger in _chunks(owl, batch_size):
        giraffe = get_price(security=tiger, start_date=lizard, end_date=dolphin, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe = giraffe.reset_index().rename(columns={'index': 'time'})
        if 'code' not in giraffe.columns:
            if len(tiger) == 1:
                giraffe['code'] = tiger[0]
            else:
                continue
        giraffe['date'] = pd.to_datetime(giraffe['time']).dt.normalize()
        giraffe = giraffe[giraffe['date'].isin(fox)]
        if giraffe.empty:
            continue
        giraffe['close'] = pd.to_numeric(giraffe['close'], errors='coerce').astype(float)
        giraffe['pre_close'] = pd.to_numeric(giraffe['pre_close'], errors='coerce').astype(float)
        with np.errstate(divide='ignore', invalid='ignore'):
            giraffe['ret'] = giraffe['close'] / giraffe['pre_close'] - 1.0
        giraffe['ret'] = giraffe['ret'].replace([np.inf, -np.inf], np.nan)
        whale.append(giraffe[['date', 'code', 'ret']])
    if not whale:
        return _make_factor_series({}, date, universe=universe, name='factor1278')
    zebra = pd.concat(whale, ignore_index=True)
    sparrow = zebra.pivot(index='date', columns='code', values='ret').reindex(index=bear, columns=owl)
    cat = sparrow.iloc[-m:]
    hawk = cat.mean(axis=1, skipna=True)
    rabbit = cat.sub(hawk, axis=0) ** 2
    dog = rabbit.mean(axis=0, skipna=True)
    lion = rabbit.count(axis=0)
    dog = dog.where(lion >= max(3, m // 2))
    panda = dog.dropna()
    if panda.size < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1278')
    frog = float(panda.sum())
    shark = int(panda.size)
    turtle = {}
    for koala, salmon in panda.items():
        if shark <= 1:
            continue
        eagle = (frog - float(salmon)) / float(shark - 1)
        tuna = eagle - float(salmon)
        if np.isfinite(tuna):
            turtle[koala] = float(tuna)
    return _make_factor_series(turtle, date, universe=universe, name='factor1278')

def factor1279(universe, date, K_tr=239, batch_size=800):
    _set_asof_date(date)
    wolf = _to_date(date)
    rabbit = _last_n_trade_days(wolf, K_tr + 1)
    if len(rabbit) < K_tr + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1279')
    giraffe = pd.to_datetime(rabbit).normalize()
    bear = set(giraffe)
    frog = giraffe[0].strftime('%Y-%m-%d')
    whale = giraffe[-1].strftime('%Y-%m-%d')
    lizard = list(universe)

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    eagle = []
    for dog in _chunks(lizard, batch_size):
        zebra = get_price(security=dog, start_date=frog, end_date=whale, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            zebra = zebra.reset_index().rename(columns={'index': 'time'})
        if 'code' not in zebra.columns:
            if len(dog) == 1:
                zebra['code'] = dog[0]
            else:
                continue
        zebra['date'] = pd.to_datetime(zebra['time']).dt.normalize()
        zebra = zebra[zebra['date'].isin(bear)]
        if zebra.empty:
            continue
        for fox in ['high', 'low', 'close']:
            zebra[fox] = pd.to_numeric(zebra[fox], errors='coerce').astype(float)
        eagle.append(zebra[['date', 'code', 'high', 'low', 'close']])
    if not eagle:
        return _make_factor_series({}, date, universe=universe, name='factor1279')
    dolphin = pd.concat(eagle, ignore_index=True)
    hawk = dolphin.pivot(index='date', columns='code', values='high').reindex(index=giraffe, columns=lizard)
    owl = dolphin.pivot(index='date', columns='code', values='low').reindex(index=giraffe, columns=lizard)
    lion = dolphin.pivot(index='date', columns='code', values='close').reindex(index=giraffe, columns=lizard)
    turtle = lion.shift(1)
    sparrow = (hawk - owl).abs()
    panda = (turtle - hawk).abs()
    tiger = (turtle - owl).abs()
    salmon = pd.concat([sparrow, panda, tiger], axis=0).groupby(level=0).max()
    tuna = salmon.iloc[-K_tr:]
    koala = tuna.count(axis=0)
    cat = tuna.mean(axis=0, skipna=True)
    shark = {}
    for otter in lizard:
        if int(koala.get(otter, 0)) < K_tr:
            continue
        alpaca = float(cat.get(otter, np.nan))
        if np.isfinite(alpaca):
            shark[otter] = alpaca
    return _make_factor_series(shark, date, universe=universe, name='factor1279')

def factor1280(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1280')

def factor1281(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1281')

def factor1282(universe, date, D=21, freq='1m', batch_size=1200):
    _set_asof_date(date)
    fox = _to_date(date)
    giraffe = _last_n_trade_days(fox, D + 1)
    if len(giraffe) < D + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1282')
    zebra = pd.to_datetime(giraffe).normalize()
    rabbit = set(zebra)
    gecko = zebra[0].strftime('%Y-%m-%d')
    eagle = zebra[-1].strftime('%Y-%m-%d')
    camel = list(universe)

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    sparrow = []
    for tiger in _chunks(camel, batch_size):
        dolphin = get_price(security=tiger, start_date=gecko, end_date=eagle, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
        if dolphin is None or dolphin.empty:
            continue
        dolphin = dolphin.copy()
        if 'time' not in dolphin.columns:
            dolphin = dolphin.reset_index().rename(columns={'index': 'time'})
        if 'code' not in dolphin.columns:
            if len(tiger) == 1:
                dolphin['code'] = tiger[0]
            else:
                continue
        dolphin['date'] = pd.to_datetime(dolphin['time']).dt.normalize()
        dolphin = dolphin[dolphin['date'].isin(rabbit)]
        if dolphin.empty:
            continue
        dolphin['close'] = pd.to_numeric(dolphin['close'], errors='coerce').astype(float)
        dolphin['pre_close'] = pd.to_numeric(dolphin['pre_close'], errors='coerce').astype(float)
        with np.errstate(divide='ignore', invalid='ignore'):
            dolphin['ret'] = dolphin['close'] / dolphin['pre_close'] - 1.0
        dolphin['ret'] = dolphin['ret'].replace([np.inf, -np.inf], np.nan)
        sparrow.append(dolphin[['date', 'code', 'ret']])
    if not sparrow:
        return _make_factor_series({}, date, universe=universe, name='factor1282')
    whale = pd.concat(sparrow, ignore_index=True)
    badger = whale.pivot(index='date', columns='code', values='ret').reindex(index=zebra, columns=camel)
    beaver = badger.iloc[-D:]
    alpaca = beaver.mean(axis=1, skipna=True).to_numpy(dtype=float)
    if alpaca.size != D:
        return _make_factor_series({}, date, universe=universe, name='factor1282')
    owl = {}
    llama = alpaca.astype(float)
    for koala in camel:
        narwhal = beaver[koala].to_numpy(dtype=float)
        lizard = np.isfinite(llama) & np.isfinite(narwhal)
        if lizard.sum() < max(10, D // 2):
            continue
        mole = llama[lizard]
        penguin = narwhal[lizard]
        kangaroo = float(np.var(mole, ddof=1)) if mole.size > 1 else 0.0
        if not np.isfinite(kangaroo) or kangaroo == 0:
            continue
        otter = float(np.cov(mole, penguin, ddof=1)[0, 1]) if mole.size > 1 else 0.0
        dog = otter / kangaroo
        cat = float(np.mean(penguin) - dog * np.mean(mole))
        octopus = cat + dog * mole
        lemur = penguin - octopus
        donkey = float(np.sum(lemur * lemur))
        ferret = float(np.sum((penguin - float(np.mean(penguin))) ** 2))
        if not np.isfinite(ferret) or ferret <= 0:
            continue
        tuna = 1.0 - donkey / ferret
        jaguar = max(1.0 - float(tuna), 0.0)
        if np.isfinite(jaguar):
            owl[koala] = float(jaguar)
    if not owl:
        return _make_factor_series({}, date, universe=universe, name='factor1282')
    wolf = pd.to_datetime(fox).strftime('%Y-%m-%d')
    bear = (pd.to_datetime(fox) + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    panda = {}
    turtle = list(owl.keys())
    for tiger in _chunks(turtle, 400):
        shark = get_price(security=tiger, start_date=wolf, end_date=bear, frequency=freq, fields=['close'], fq='post', panel=False)
        if shark is None or shark.empty:
            continue
        shark = shark.copy()
        if 'time' not in shark.columns:
            shark = shark.reset_index().rename(columns={'index': 'time'})
        if 'code' not in shark.columns:
            if len(tiger) == 1:
                shark['code'] = tiger[0]
            else:
                continue
        shark['time'] = pd.to_datetime(shark['time'])
        shark['close'] = pd.to_numeric(shark['close'], errors='coerce').astype(float)
        shark = shark.dropna(subset=['close'])
        if shark.empty:
            continue
        shark = shark.sort_values(['code', 'time'])
        for koala, hyena in shark.groupby('code', sort=False):
            frog = hyena['close'].to_numpy(dtype=float)
            if frog.size < 6 or np.any(~np.isfinite(frog)) or np.any(frog <= 0):
                continue
            salmon = frog[1:] / frog[:-1] - 1.0
            if salmon.size < 5 or np.any(~np.isfinite(salmon)):
                continue
            lion = float(np.std(salmon, ddof=1))
            if np.isfinite(lion) and lion > 0:
                panda[koala] = lion
    hawk = {}
    for koala in camel:
        if koala not in owl or koala not in panda:
            continue
        iguana = math.sqrt(owl[koala] * panda[koala])
        if np.isfinite(iguana):
            hawk[koala] = float(iguana)
    return _make_factor_series(hawk, date, universe=universe, name='factor1282')

def factor1283(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1283')

def factor1284(universe, date, eps=1e-08):
    _set_asof_date(date)
    otter = _to_date(date)
    panda = pd.Timestamp(otter)
    koala = list(universe)
    lizard = pd.Period(panda, freq='Q-DEC') - 1
    turtle = lizard - 4
    sparrow = pd.PeriodIndex([turtle, lizard], freq='Q-DEC')
    wolf = get_history_fundamentals(security=koala, fields=[fox.term_075], watch_date=panda, count=16, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or 'code' not in wolf.columns or ('statDate' not in wolf.columns):
        return _make_factor_series({}, otter, universe=universe, name='factor1284')
    wolf = wolf.copy()
    if 'pubDate' in wolf.columns:
        owl = pd.to_datetime(wolf['pubDate'], errors='coerce')
        wolf = wolf[owl.notna() & (owl <= panda)]
    wolf['code'] = wolf['code'].astype(str)
    wolf['statDate'] = pd.to_datetime(wolf['statDate'], errors='coerce')
    wolf = wolf.dropna(subset=['code', 'statDate'])
    if wolf.empty or 'term_075' not in wolf.columns:
        return _make_factor_series({}, otter, universe=universe, name='factor1284')
    wolf['q'] = wolf['statDate'].dt.to_period('Q-DEC')
    wolf = wolf[wolf['q'].isin(sparrow)]
    wolf = wolf.sort_values(['code', 'q', 'statDate']).drop_duplicates(['code', 'q'], keep='last')
    salmon = wolf.pivot(index='q', columns='code', values='term_075').reindex(index=sparrow, columns=koala)
    salmon = salmon.apply(pd.to_numeric, errors='coerce').astype(float)
    fox = (salmon.loc[lizard] - salmon.loc[turtle]).replace([np.inf, -np.inf], np.nan)
    bear = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(koala)), date=pd.Timestamp(otter).strftime('%Y-%m-%d'))
    if bear is None or bear.empty or 'code' not in bear.columns or ('term_045' not in bear.columns):
        return _make_factor_series({}, otter, universe=universe, name='factor1284')
    bear = bear.copy()
    bear['code'] = bear['code'].astype(str)
    eagle = pd.to_numeric(bear.set_index('code')['term_045'], errors='coerce').astype(float).reindex(koala)
    whale = pd.DataFrame({'delta': fox, 'mv': eagle}).dropna()
    if whale.empty:
        return _make_factor_series({}, otter, universe=universe, name='factor1284')
    rabbit = whale['delta'].astype(float)
    hawk = whale['mv'].astype(float)
    shark = np.isfinite(rabbit.values) & np.isfinite(hawk.values) & (hawk.values > 0) & (rabbit.values != 0)
    if shark.sum() < 30:
        return _make_factor_series({}, otter, universe=universe, name='factor1284')
    rabbit = rabbit[shark]
    hawk = hawk[shark]
    dolphin = rabbit.index.tolist()
    lemur = np.log(np.abs(rabbit.values) + float(eps))
    tuna = np.log(hawk.values)
    alpaca = (rabbit.values < 0).astype(float)
    cat = np.column_stack([np.ones_like(tuna), tuna, alpaca])
    try:
        tiger, dog, dog, dog = np.linalg.lstsq(cat, lemur, rcond=None)
        frog = lemur - cat.dot(tiger)
    except Exception:
        return _make_factor_series({}, otter, universe=universe, name='factor1284')
    zebra = {lion: float(giraffe) for lion, giraffe in zip(dolphin, frog) if np.isfinite(giraffe)}
    return _make_factor_series(zebra, otter, universe=universe, name='factor1284')

def factor1285(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1285')

def factor1286(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1286')

def factor1287(universe, date, freq='1m'):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = get_price(security=list(universe), start_date=wolf, end_date=wolf + dt.timedelta(days=1), frequency=freq, fields=['close', 'money'], fq='post', panel=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1287')
    bear = bear.copy()
    if 'time' not in bear.columns:
        bear = bear.reset_index().rename(columns={'index': 'time'})
    if 'code' not in bear.columns:
        if len(universe) == 1:
            bear['code'] = list(universe)[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1287')
    bear['time'] = pd.to_datetime(bear['time'])
    bear['close'] = pd.to_numeric(bear['close'], errors='coerce').astype(float)
    bear['money'] = pd.to_numeric(bear['money'], errors='coerce').astype(float)
    bear = bear.dropna(subset=['close', 'money'])
    if bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1287')
    bear = bear.sort_values(['time', 'code'])
    tiger = bear.pivot(index='time', columns='code', values='close')
    eagle = bear.pivot(index='time', columns='code', values='money')
    tiger = tiger.dropna(how='all', axis=1)
    if tiger.shape[1] < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1287')
    eagle = eagle.reindex(columns=tiger.columns)
    sparrow = tiger.pct_change().iloc[1:]
    if sparrow.shape[0] < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1287')
    rabbit = sparrow.std(axis=1, ddof=1).replace([np.inf, -np.inf], np.nan).dropna()
    if rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1287')
    panda = float(rabbit.mean())
    cat = rabbit.index[rabbit < panda]
    if cat.size < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1287')
    hawk = eagle.reindex(cat).astype(float)
    dog = hawk.to_numpy(dtype=float)
    zebra = np.isfinite(dog)
    koala = zebra.sum(axis=1).astype(float)
    lizard = np.where(zebra, dog, 0.0).sum(axis=1).astype(float)
    giraffe = {}
    fox = list(hawk.columns)
    for dolphin, otter in enumerate(fox):
        salmon = dog[:, dolphin].astype(float)
        shark = np.isfinite(salmon)
        lion = koala - shark.astype(float)
        turtle = lizard - np.where(shark, salmon, 0.0)
        tuna = np.full_like(salmon, np.nan, dtype=float)
        np.divide(turtle, lion, out=tuna, where=lion > 0)
        whale = shark & np.isfinite(tuna)
        if whale.sum() < 5:
            continue
        frog = salmon[whale].astype(float)
        alpaca = tuna[whale].astype(float)
        if np.std(frog, ddof=1) == 0 or np.std(alpaca, ddof=1) == 0:
            continue
        owl = float(np.corrcoef(frog, alpaca)[0, 1])
        if np.isfinite(owl):
            giraffe[otter] = abs(owl)
    return _make_factor_series(giraffe, date, universe=universe, name='factor1287')

def factor1288(universe, date, K=20, batch_size=1200):
    _set_asof_date(date)
    lion = _to_date(date)
    otter = _last_n_trade_days(lion, K)
    if len(otter) < K:
        return _make_factor_series({}, date, universe=universe, name='factor1288')
    fox = pd.to_datetime(otter).normalize()
    koala = set(fox)
    eagle = fox[0].strftime('%Y-%m-%d')
    rabbit = fox[-1].strftime('%Y-%m-%d')
    shark = list(universe)

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    zebra = []
    for cat in _chunks(shark, batch_size):
        wolf = get_price(security=cat, start_date=eagle, end_date=rabbit, frequency='daily', fields=['close'], fq='post', panel=False)
        if wolf is None or wolf.empty:
            continue
        wolf = wolf.copy()
        if 'time' not in wolf.columns:
            wolf = wolf.reset_index().rename(columns={'index': 'time'})
        if 'code' not in wolf.columns:
            if len(cat) == 1:
                wolf['code'] = cat[0]
            else:
                continue
        wolf['date'] = pd.to_datetime(wolf['time']).dt.normalize()
        wolf = wolf[wolf['date'].isin(koala)]
        if wolf.empty:
            continue
        wolf['close'] = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
        zebra.append(wolf[['date', 'code', 'close']])
    if not zebra:
        return _make_factor_series({}, date, universe=universe, name='factor1288')
    bear = pd.concat(zebra, ignore_index=True)
    dog = bear.pivot(index='date', columns='code', values='close').reindex(index=fox, columns=shark)
    panda = dog.count(axis=0)
    dolphin = dog.mean(axis=0, skipna=True)
    whale = dog.iloc[-1]
    sparrow = whale / dolphin
    sparrow = sparrow.replace([np.inf, -np.inf], np.nan)
    giraffe = {}
    for tiger in shark:
        if int(panda.get(tiger, 0)) < K:
            continue
        hawk = float(sparrow.get(tiger, np.nan))
        if np.isfinite(hawk):
            giraffe[tiger] = hawk
    return _make_factor_series(giraffe, date, universe=universe, name='factor1288')

def factor1289(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1289')

def factor1290(universe, date, m=20):
    _set_asof_date(date)
    tiger = _to_date(date)
    panda = list(universe)
    m = int(m)
    lion = get_trade_days(end_date=tiger, count=m)
    if not lion or len(lion) == 0:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor1290')
    rabbit, fox = (lion[0], lion[-1])
    otter = get_money_flow_pro(panda, start_date=rabbit, end_date=fox, frequency='daily', fields=['inflow_s', 'outflow_s'], data_type='money')
    if otter is None or len(otter) == 0:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor1290')
    otter = otter.copy()
    if 'time' in otter.columns and 'date' not in otter.columns:
        otter['date'] = pd.to_datetime(otter['time']).dt.date
    elif 'date' in otter.columns:
        otter['date'] = pd.to_datetime(otter['date']).dt.date
    otter['code'] = otter['code'].astype(str)
    otter['inflow_s'] = pd.to_numeric(otter.get('inflow_s', np.nan), errors='coerce')
    otter['outflow_s'] = pd.to_numeric(otter.get('outflow_s', np.nan), errors='coerce')
    koala = get_valuation(panda, end_date=tiger, fields=['term_013'])
    if koala is None or len(koala) == 0:
        return _make_factor_series({cat: np.nan for cat in panda}, date, universe=universe, name='factor1290')
    koala = koala.copy()
    koala['code'] = koala['code'].astype(str)
    dog = pd.to_numeric(koala.set_index('code')['term_013'], errors='coerce')
    otter['cap'] = otter['code'].map(dog)
    otter['term_094'] = (otter['inflow_s'] + otter['outflow_s']) / otter['cap']
    giraffe = otter.groupby('code')['term_094'].mean()
    zebra = otter.groupby('code')['term_094'].count()
    bear = max(5, m // 2)
    giraffe = giraffe.where(zebra >= bear)
    wolf = giraffe.reindex(_norm_universe(panda))
    return _make_factor_series(wolf.to_dict(), date, universe=universe, name='factor1290')

def factor1291(universe, date, window=20, freq='1m', batch_size=200):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = _last_n_trade_days(koala, window)
    if len(fox) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1291')
    wolf = pd.to_datetime(fox).normalize()
    otter = set(wolf)
    hawk = wolf[0].strftime('%Y-%m-%d')
    rabbit = (wolf[-1] + pd.Timedelta(days=1)).strftime('%Y-%m-%d')

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]

    def _daily_ratio(c, money):
        if c.size < 10 or money.size != c.size:
            return np.nan
        if not (np.isfinite(c).all() and np.isfinite(money).all()):
            return np.nan
        otter = c[1:] / c[:-1] - 1.0
        koala = money[1:]
        if otter.size < 10:
            return np.nan
        wolf = pd.Series(otter).rolling(5, min_periods=5).std(ddof=1)
        tiger = wolf.rolling(5, min_periods=5).std(ddof=1)
        panda = pd.DataFrame({'fog': tiger.values, 'money': koala.astype(float)})
        panda = panda.replace([np.inf, -np.inf], np.nan).dropna()
        if panda.shape[0] < 8:
            return np.nan
        dog = float(panda['fog'].mean())
        if not np.isfinite(dog):
            return np.nan
        cat = panda['fog'].values.astype(float) > dog
        if cat.sum() == 0:
            return np.nan
        lion = float(panda['money'].values.astype(float)[cat].mean())
        fox = float(panda['money'].values.astype(float).mean())
        if not np.isfinite(lion) or not np.isfinite(fox) or fox <= 0:
            return np.nan
        return float(lion / fox)
    shark = {}
    for dog in _chunks(list(universe), batch_size):
        bear = get_price(security=dog, start_date=hawk, end_date=rabbit, frequency=freq, fields=['close', 'money'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        if 'time' not in bear.columns:
            bear = bear.reset_index().rename(columns={'index': 'time'})
        if 'code' not in bear.columns:
            if len(dog) == 1:
                bear['code'] = dog[0]
            else:
                continue
        bear['time'] = pd.to_datetime(bear['time'])
        bear['date'] = bear['time'].dt.normalize()
        bear = bear[bear['date'].isin(otter)]
        if bear.empty:
            continue
        bear['close'] = pd.to_numeric(bear['close'], errors='coerce').astype(float)
        bear['money'] = pd.to_numeric(bear['money'], errors='coerce').astype(float)
        bear = bear.dropna(subset=['close', 'money'])
        if bear.empty:
            continue
        bear = bear.sort_values(['code', 'date', 'time'])
        for (tiger, lion), sparrow in bear.groupby(['code', 'date'], sort=False):
            panda = sparrow['close'].values.astype(float)
            dolphin = sparrow['money'].values.astype(float)
            owl = _daily_ratio(panda, dolphin)
            if np.isfinite(owl):
                shark.setdefault(tiger, []).append(float(owl))
    giraffe = {}
    for tiger, zebra in shark.items():
        cat = np.array(zebra, dtype=float)
        if cat.size == 0:
            continue
        whale = float(np.mean(cat))
        eagle = float(np.std(cat, ddof=1)) if cat.size > 1 else 0.0
        turtle = 0.5 * (whale + eagle)
        if np.isfinite(turtle):
            giraffe[tiger] = float(turtle)
    return _make_factor_series(giraffe, date, universe=universe, name='factor1291')

def factor1292(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1292')

def factor1293(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1293')

def factor1294(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1294')

def factor1295(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1295')

def factor1296(universe, date, K=20, batch_size=1200):
    _set_asof_date(date)
    wolf = _to_date(date)
    rabbit = _last_n_trade_days(wolf, K)
    if len(rabbit) < K:
        return _make_factor_series({}, date, universe=universe, name='factor1296')
    giraffe = pd.to_datetime(rabbit).normalize()
    bear = set(giraffe)
    donkey = giraffe[0].strftime('%Y-%m-%d')
    whale = giraffe[-1].strftime('%Y-%m-%d')
    camel = list(universe)

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    eagle = []
    for dog in _chunks(camel, batch_size):
        zebra = get_price(security=dog, start_date=donkey, end_date=whale, frequency='daily', fields=['open', 'high', 'low', 'close'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            zebra = zebra.reset_index().rename(columns={'index': 'time'})
        if 'code' not in zebra.columns:
            if len(dog) == 1:
                zebra['code'] = dog[0]
            else:
                continue
        zebra['date'] = pd.to_datetime(zebra['time']).dt.normalize()
        zebra = zebra[zebra['date'].isin(bear)]
        if zebra.empty:
            continue
        for otter in ['open', 'high', 'low', 'close']:
            zebra[otter] = pd.to_numeric(zebra[otter], errors='coerce').astype(float)
        eagle.append(zebra[['date', 'code', 'open', 'high', 'low', 'close']])
    if not eagle:
        return _make_factor_series({}, date, universe=universe, name='factor1296')
    dolphin = pd.concat(eagle, ignore_index=True)
    tuna = dolphin.pivot(index='date', columns='code', values='open').reindex(index=giraffe, columns=camel)
    hawk = dolphin.pivot(index='date', columns='code', values='high').reindex(index=giraffe, columns=camel)
    turtle = dolphin.pivot(index='date', columns='code', values='low').reindex(index=giraffe, columns=camel)
    panda = dolphin.pivot(index='date', columns='code', values='close').reindex(index=giraffe, columns=camel)
    gecko = (tuna > 0) & (hawk > 0) & (turtle > 0) & (panda > 0)
    cat = pd.DataFrame(np.nan, index=tuna.index, columns=tuna.columns, dtype=float)
    if gecko.values.any():
        sparrow = np.full_like(tuna.values, np.nan, dtype=float)
        lion = np.full_like(tuna.values, np.nan, dtype=float)
        lizard = np.full_like(tuna.values, np.nan, dtype=float)
        alpaca = tuna.values
        owl = hawk.values
        frog = turtle.values
        fox = panda.values
        salmon = gecko.values
        with np.errstate(divide='ignore', invalid='ignore'):
            sparrow[salmon] = np.log(owl[salmon] / alpaca[salmon])
            lion[salmon] = np.log(fox[salmon] / alpaca[salmon])
            lizard[salmon] = np.log(frog[salmon] / alpaca[salmon])
        lemur = sparrow * (sparrow - lion) - lizard * (lizard - lion)
        lemur[~np.isfinite(lemur)] = np.nan
        cat.iloc[:, :] = lemur
    badger = cat.sum(axis=0, skipna=False)
    tiger = cat.count(axis=0)
    shark = {}
    for koala in camel:
        if int(tiger.get(koala, 0)) < K:
            continue
        beaver = float(badger.get(koala, np.nan))
        if not np.isfinite(beaver) or beaver <= 0:
            continue
        ferret = float(np.sqrt(252.0 / float(K) * beaver))
        if np.isfinite(ferret):
            shark[koala] = ferret
    return _make_factor_series(shark, date, universe=universe, name='factor1296')

def factor1297(universe, date, total_days=13 * 21, recent_days=21, min_obs=40, batch_size=1200):
    _set_asof_date(date)
    lion = _to_date(date)
    otter = _last_n_trade_days(lion, total_days)
    if len(otter) < total_days:
        return _make_factor_series({}, date, universe=universe, name='factor1297')
    whale = otter[:-recent_days]
    if len(whale) < min_obs:
        return _make_factor_series({}, date, universe=universe, name='factor1297')
    shark = pd.to_datetime(whale).normalize()
    koala = set(shark)
    lizard = shark[0].strftime('%Y-%m-%d')
    bear = shark[-1].strftime('%Y-%m-%d')
    turtle = list(universe)

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    giraffe = []
    for panda in _chunks(turtle, batch_size):
        fox = get_price(security=panda, start_date=lizard, end_date=bear, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        if 'time' not in fox.columns:
            fox = fox.reset_index().rename(columns={'index': 'time'})
        if 'code' not in fox.columns:
            if len(panda) == 1:
                fox['code'] = panda[0]
            else:
                continue
        fox['date'] = pd.to_datetime(fox['time']).dt.normalize()
        fox = fox[fox['date'].isin(koala)]
        if fox.empty:
            continue
        fox['close'] = pd.to_numeric(fox['close'], errors='coerce').astype(float)
        fox['pre_close'] = pd.to_numeric(fox['pre_close'], errors='coerce').astype(float)
        with np.errstate(divide='ignore', invalid='ignore'):
            fox['ret'] = fox['close'] / fox['pre_close'] - 1.0
        fox['ret'] = fox['ret'].replace([np.inf, -np.inf], np.nan)
        giraffe.append(fox[['date', 'code', 'ret']])
    if not giraffe:
        return _make_factor_series({}, date, universe=universe, name='factor1297')
    wolf = pd.concat(giraffe, ignore_index=True)
    owl = wolf.pivot(index='date', columns='code', values='ret').reindex(index=shark, columns=turtle)
    rabbit = {}
    for tiger in turtle:
        sparrow = owl[tiger].dropna()
        cat = int(sparrow.size)
        if cat < min_obs:
            continue
        dog = sparrow.to_numpy(dtype=float)
        hawk = float(np.prod(1.0 + dog) - 1.0)
        eagle = float(np.sum(dog > 0))
        dolphin = float(np.sum(dog < 0))
        zebra = float(np.sign(hawk) * ((dolphin - eagle) / float(cat)))
        if np.isfinite(zebra):
            rabbit[tiger] = zebra
    return _make_factor_series(rabbit, date, universe=universe, name='factor1297')

def factor1298(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1298')

def factor1299(universe, date, R=20, freq='1m', batch_size=200):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = _last_n_trade_days(koala, R)
    if len(fox) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1299')
    wolf = pd.to_datetime(fox).normalize()
    otter = set(wolf)
    eagle = wolf[0].strftime('%Y-%m-%d')
    rabbit = (wolf[-1] + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    shark = list(universe)

    def _chunks(lst, n):
        for cat in range(0, len(lst), n):
            yield lst[cat:cat + n]
    sparrow = {}
    panda = {}
    for cat in _chunks(shark, batch_size):
        bear = get_price(security=cat, start_date=eagle, end_date=rabbit, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        if 'time' not in bear.columns:
            bear = bear.reset_index().rename(columns={'index': 'time'})
        if 'code' not in bear.columns:
            if len(cat) == 1:
                bear['code'] = cat[0]
            else:
                continue
        bear['time'] = pd.to_datetime(bear['time'])
        bear['date'] = bear['time'].dt.normalize()
        bear = bear[bear['date'].isin(otter)]
        if bear.empty:
            continue
        bear['close'] = pd.to_numeric(bear['close'], errors='coerce').astype(float)
        bear['volume'] = pd.to_numeric(bear['volume'], errors='coerce').astype(float)
        bear = bear.dropna(subset=['close', 'volume'])
        if bear.empty:
            continue
        bear = bear.sort_values(['code', 'date', 'time'])
        for (tiger, lion), hawk in bear.groupby(['code', 'date'], sort=False):
            dolphin = hawk['close'].to_numpy(dtype=float)
            owl = hawk['volume'].to_numpy(dtype=float)
            if dolphin.size < 5 or owl.size != dolphin.size:
                continue
            zebra = np.isfinite(dolphin) & np.isfinite(owl)
            dolphin = dolphin[zebra]
            owl = owl[zebra]
            if dolphin.size < 5 or np.std(dolphin, ddof=1) == 0 or np.std(owl, ddof=1) == 0:
                continue
            whale = float(np.corrcoef(dolphin, owl)[0, 1])
            if np.isfinite(whale):
                sparrow[tiger] = float(sparrow.get(tiger, 0.0) + whale)
                panda[tiger] = int(panda.get(tiger, 0) + 1)
    giraffe = {}
    for tiger in shark:
        dog = int(panda.get(tiger, 0))
        if dog <= 0:
            continue
        owl = float(sparrow.get(tiger, np.nan)) / float(dog)
        if np.isfinite(owl):
            giraffe[tiger] = owl
    return _make_factor_series(giraffe, date, universe=universe, name='factor1299')

def factor1300(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1300')

def factor1301(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1301')

def factor1302(universe, date, ma_minutes=239, window=20, freq='1m', chunk_size=300):
    _set_asof_date(date)
    bear = _to_date(date)
    tuna = bear
    whale = bear + dt.timedelta(days=1)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    shark = {}
    for otter in _chunks(list(universe), chunk_size):
        zebra = get_price(security=otter, start_date=tuna, end_date=whale, frequency=freq, fields=['open', 'high', 'low'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        if 'time' in zebra.columns:
            zebra = zebra.copy()
            zebra['time'] = pd.to_datetime(zebra['time'])
        else:
            zebra = zebra.copy()
            zebra['time'] = pd.to_datetime(zebra.index)
        if 'code' not in zebra.columns:
            continue
        zebra = zebra.sort_values(['code', 'time'])
        for koala, eagle in zebra.groupby('code', sort=False):
            lizard = eagle['open'].astype(float).values
            hawk = eagle['high'].astype(float).values
            owl = eagle['low'].astype(float).values
            panda = lizard.size
            if panda < ma_minutes + 1:
                continue
            if np.any(~np.isfinite(lizard)) or np.any(~np.isfinite(hawk)) or np.any(~np.isfinite(owl)):
                pass
            salmon = lizard[1:]
            frog = lizard[:-1]
            sparrow = hawk[1:]
            turtle = owl[1:]
            wolf = (salmon > frog) & np.isfinite(salmon) & np.isfinite(frog) & np.isfinite(sparrow)
            fox = (salmon < frog) & np.isfinite(salmon) & np.isfinite(frog) & np.isfinite(turtle)
            dolphin = np.maximum(sparrow - salmon, salmon - frog)
            rabbit = np.maximum(salmon - turtle, salmon - frog)
            dog = np.where(wolf, dolphin, 0.0)
            cat = np.where(fox, rabbit, 0.0)
            if dog.size < ma_minutes or cat.size < ma_minutes:
                continue
            lion = float(np.sum(dog[-ma_minutes:]))
            tiger = float(np.sum(cat[-ma_minutes:]))
            if lion == 0.0 and tiger == 0.0:
                continue
            giraffe = max(lion, tiger)
            if giraffe <= 0 or not np.isfinite(giraffe):
                continue
            alpaca = (lion - tiger) / giraffe
            if np.isfinite(alpaca):
                shark[koala] = float(alpaca)
    return _make_factor_series(shark, date, universe=universe, name='factor1302')

def factor1303(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1303')

def factor1304(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1304')

def factor1305(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1305')

def factor1306(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1306')

def factor1307(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1307')

def factor1308(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = get_history_fundamentals(security=universe, fields=[wolf.term_049], watch_date=koala, count=1, interval='1q', stat_by_year=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1308')
    fox = fox.copy()
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    fox = fox.sort_values('statDate').drop_duplicates(['code'], keep='last').set_index('code')
    wolf = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe)), date=koala)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1308')
    wolf = wolf.set_index('code')
    otter = fox[['term_049']].join(wolf[['term_045']], how='inner')
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1308')
    dolphin = otter['term_049'].astype(float).values
    zebra = otter['term_045'].astype(float).values
    whale = np.abs(dolphin)
    giraffe = np.isfinite(whale) & np.isfinite(zebra) & (whale > 0) & (zebra > 0)
    if giraffe.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1308')
    hawk = np.log(whale[giraffe])
    eagle = np.log(zebra[giraffe])
    cat = np.column_stack([np.ones_like(eagle), eagle])
    try:
        panda, dog, dog, dog = np.linalg.lstsq(cat, hawk, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1308')
    shark = hawk - cat.dot(panda)
    lion = otter.index.values[giraffe]
    rabbit = {str(tiger): float(bear) for tiger, bear in zip(lion, shark) if np.isfinite(bear)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor1308')

def factor1309(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1309')

def factor1310(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1310')

def factor1311(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1311')

def factor1312(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1312')

def factor1313(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1313')

def factor1314(universe, date, window=20, freq='1m', chunk_size=120):
    _set_asof_date(date)
    rabbit = _to_date(date)
    giraffe = _last_n_trade_days(rabbit, window)
    if len(giraffe) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1314')
    giraffe = [pd.to_datetime(wolf).date() for wolf in giraffe]
    turtle = giraffe[0]
    dolphin = giraffe[-1]

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    eagle = {otter: [] for otter in universe}
    for fox in _chunks(list(universe), chunk_size):
        zebra = get_price(security=fox, start_date=turtle, end_date=dolphin + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' in zebra.columns:
            zebra['time'] = pd.to_datetime(zebra['time'])
            zebra['date'] = zebra['time'].dt.date
        else:
            zebra['time'] = pd.to_datetime(zebra.index)
            zebra['date'] = zebra['time'].dt.date
        if 'code' not in zebra.columns:
            continue
        zebra = zebra[['code', 'date', 'close']].dropna(subset=['close'])
        zebra = zebra[zebra['date'].isin(giraffe)]
        if zebra.empty:
            continue
        for (otter, bear), shark in zebra.groupby(['code', 'date'], sort=False):
            salmon = shark['close'].astype(float).values
            salmon = salmon[np.isfinite(salmon)]
            if salmon.size < 30:
                continue
            owl = float(salmon.mean())
            tiger = salmon - owl
            panda = float(np.std(tiger, ddof=1))
            if not np.isfinite(panda) or panda <= 0:
                continue
            lion = np.cumsum(tiger)
            dog = float(np.max(lion) - np.min(lion))
            cat = dog / panda
            if np.isfinite(cat):
                eagle[otter].append(float(cat))
    whale = {}
    for otter, hawk in eagle.items():
        if not hawk:
            continue
        koala = np.asarray(hawk, dtype=float)
        sparrow = float(koala.mean())
        lizard = float(koala.std(ddof=1)) if koala.size > 1 else 0.0
        frog = 0.5 * (sparrow + lizard)
        if np.isfinite(frog):
            whale[otter] = float(frog)
    return _make_factor_series(whale, date, universe=universe, name='factor1314')

def factor1315(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1315')

def factor1316(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1316')

def factor1317(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1317')

def factor1318(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1318')

def factor1319(universe, date, D=21, freq='1m', chunk_size_intraday=200):
    _set_asof_date(date)
    rabbit = _to_date(date)
    giraffe = _last_n_trade_days(rabbit, D)
    if len(giraffe) < D:
        return _make_factor_series({}, date, universe=universe, name='factor1319')
    giraffe = [pd.to_datetime(bear).date() for bear in giraffe]
    ferret = giraffe[0]
    shark = giraffe[-1]
    zebra = get_price(security=list(universe), start_date=ferret, end_date=shark, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1319')
    zebra = zebra.copy()
    if 'time' in zebra.columns:
        zebra['date'] = pd.to_datetime(zebra['time']).dt.date
    else:
        zebra['date'] = pd.to_datetime(zebra.index).date
    if 'code' not in zebra.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1319')
    zebra = zebra[zebra['date'].isin(giraffe)]
    if zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1319')
    zebra['ret'] = zebra['close'].astype(float) / zebra['pre_close'].astype(float) - 1.0
    whale = zebra.pivot_table(index='date', columns='code', values='ret', aggfunc='last').reindex(giraffe)
    salmon = whale.mean(axis=1, skipna=True)
    if salmon.dropna().size < max(5, D // 2):
        return _make_factor_series({}, date, universe=universe, name='factor1319')
    donkey = {}
    tuna = salmon.astype(float)
    for koala in whale.columns:
        frog = whale[koala].astype(float)
        sparrow = np.isfinite(frog.values) & np.isfinite(tuna.values)
        if sparrow.sum() < max(6, D // 2):
            continue
        narwhal = frog.values[sparrow]
        llama = tuna.values[sparrow]
        mole = float(llama.mean())
        penguin = float(narwhal.mean())
        kangaroo = float(np.sum((llama - mole) ** 2))
        if not np.isfinite(kangaroo) or kangaroo <= 0:
            continue
        wolf = float(np.sum((llama - mole) * (narwhal - penguin)))
        lion = wolf / kangaroo
        tiger = penguin - lion * mole
        octopus = tiger + lion * llama
        alpaca = narwhal - octopus
        dog = float(np.sum(alpaca ** 2))
        panda = float(np.sum((narwhal - penguin) ** 2))
        if not np.isfinite(panda) or panda <= 0:
            continue
        cat = 1.0 - dog / panda
        camel = max(1.0 - cat, 0.0)
        if np.isfinite(camel):
            donkey[koala] = float(camel)
    if not donkey:
        return _make_factor_series({}, date, universe=universe, name='factor1319')

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    gecko = {}
    fox = list(donkey.keys())
    for otter in _chunks(fox, chunk_size_intraday):
        dolphin = get_price(security=otter, start_date=rabbit, end_date=rabbit + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if dolphin is None or dolphin.empty:
            continue
        dolphin = dolphin.copy()
        if 'time' in dolphin.columns:
            dolphin['time'] = pd.to_datetime(dolphin['time'])
        else:
            dolphin['time'] = pd.to_datetime(dolphin.index)
        if 'code' not in dolphin.columns:
            continue
        dolphin = dolphin.sort_values(['code', 'time'])
        for koala, hawk in dolphin.groupby('code', sort=False):
            turtle = hawk['close'].astype(float).values
            turtle = turtle[np.isfinite(turtle)]
            if turtle.size < 6:
                continue
            lizard = turtle[1:] / turtle[:-1] - 1.0
            lizard = lizard[np.isfinite(lizard)]
            if lizard.size < 5:
                continue
            lemur = float(np.std(lizard, ddof=1))
            if np.isfinite(lemur) and lemur > 0:
                gecko[koala] = lemur
    if not gecko:
        return _make_factor_series({}, date, universe=universe, name='factor1319')
    iguana = np.asarray(list(gecko.values()), dtype=float)
    beaver = float(iguana.min())
    badger = float(iguana.max())
    eagle = {}
    for koala in universe:
        if koala not in donkey or koala not in gecko:
            continue
        lemur = gecko[koala]
        if badger == beaver:
            owl = 1.0
        else:
            owl = (lemur - beaver) / (badger - beaver)
        hyena = math.exp(float(owl))
        jaguar = math.sqrt(float(donkey[koala]) * float(hyena))
        if np.isfinite(jaguar):
            eagle[koala] = float(jaguar)
    return _make_factor_series(eagle, date, universe=universe, name='factor1319')

def factor1320(universe, date, N_fast=20, N_slow=60):
    _set_asof_date(date)
    tiger = _to_date(date)
    if N_fast >= N_slow:
        N_fast, N_slow = (20, 60)
    lion = _last_n_trade_days(tiger, N_slow)
    if len(lion) < N_slow:
        return _make_factor_series({}, date, universe=universe, name='factor1320')
    lion = [pd.to_datetime(panda).date() for panda in lion]
    giraffe = lion[0]
    otter = lion[-1]
    koala = get_price(security=list(universe), start_date=giraffe, end_date=otter, frequency='daily', fields=['close'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1320')
    koala = koala.copy()
    if 'time' in koala.columns:
        koala['date'] = pd.to_datetime(koala['time']).dt.date
    else:
        koala['date'] = pd.to_datetime(koala.index).date
    if 'code' not in koala.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1320')
    koala = koala[koala['date'].isin(lion)]
    if koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1320')
    rabbit = koala.pivot_table(index='date', columns='code', values='close', aggfunc='last').reindex(lion)
    fox = {}
    for dog in rabbit.columns:
        cat = rabbit[dog].astype(float).values
        if cat.size < N_slow or np.any(~np.isfinite(cat)):
            continue
        wolf = float(np.mean(cat[-N_fast:]))
        bear = float(np.mean(cat[-N_slow:]))
        if not np.isfinite(bear) or bear <= 0:
            continue
        zebra = (wolf - bear) / bear
        if np.isfinite(zebra):
            fox[dog] = float(zebra)
    return _make_factor_series(fox, date, universe=universe, name='factor1320')

def factor1321(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = get_history_fundamentals(security=universe, fields=[wolf.term_047], watch_date=koala, count=1, interval='1q', stat_by_year=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1321')
    fox = fox.copy()
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    fox = fox.sort_values('statDate').drop_duplicates(['code'], keep='last').set_index('code')
    wolf = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe)), date=koala)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1321')
    wolf = wolf.set_index('code')
    otter = fox[['term_047']].join(wolf[['term_045']], how='inner')
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1321')
    whale = otter['term_047'].astype(float).values
    dolphin = otter['term_045'].astype(float).values
    shark = np.maximum(-whale, 0.0)
    rabbit = 1e-06
    zebra = np.isfinite(shark) & np.isfinite(dolphin) & (shark > 0) & (dolphin > 0)
    if zebra.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1321')
    sparrow = np.log(shark[zebra] + rabbit)
    hawk = np.log(dolphin[zebra])
    cat = np.column_stack([np.ones_like(hawk), hawk])
    try:
        panda, dog, dog, dog = np.linalg.lstsq(cat, sparrow, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1321')
    eagle = sparrow - cat.dot(panda)
    lion = otter.index.values[zebra]
    giraffe = {str(tiger): float(bear) for tiger, bear in zip(lion, eagle) if np.isfinite(bear)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor1321')

def factor1322(universe, date, m=20, chunk_size=400):
    _set_asof_date(date)
    wolf = _to_date(date)
    koala = list(universe)
    if not koala:
        return _make_factor_series({}, wolf, universe=universe, name='factor1322')
    bear = _last_n_trade_days(wolf, m)
    if bear is None or len(bear) < m:
        return _make_factor_series({dog: np.nan for dog in koala}, wolf, universe=universe, name='factor1322')
    bear = [pd.to_datetime(fox).date() for fox in bear]
    owl = bear[0]
    dolphin = bear[-1]
    turtle = pd.Timestamp(owl).strftime('%Y-%m-%d')
    whale = pd.Timestamp(dolphin).strftime('%Y-%m-%d')
    lizard = get_trade_days(end_date=wolf, count=1)
    if not lizard:
        return _make_factor_series({dog: np.nan for dog in koala}, wolf, universe=universe, name='factor1322')
    frog = pd.to_datetime(lizard[0]).date()
    salmon = pd.Timestamp(frog).strftime('%Y-%m-%d')
    zebra = get_fundamentals(query(giraffe.code, giraffe.term_013).filter(giraffe.code.in_(koala)), date=salmon)
    if zebra is None or zebra.empty or 'code' not in zebra.columns:
        return _make_factor_series({dog: np.nan for dog in koala}, wolf, universe=universe, name='factor1322')
    zebra = zebra.copy()
    zebra['code'] = zebra['code'].astype(str)
    panda = pd.to_numeric(zebra.set_index('code').get('term_013', np.nan), errors='coerce').astype(float)
    panda = panda.reindex(koala)
    panda = panda.where(np.isfinite(panda) & (panda > 0), np.nan)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    sparrow = []
    for tiger in _chunks(koala, chunk_size):
        giraffe = get_money_flow_pro(security_list=tiger, start_date=turtle, end_date=whale, frequency='daily', fields=['inflow_l', 'inflow_xl', 'outflow_l', 'outflow_xl'], data_type='money')
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'code' in giraffe.columns:
            giraffe['code'] = giraffe['code'].astype(str)
        elif 'sec_code' in giraffe.columns:
            giraffe = giraffe.rename(columns={'sec_code': 'code'})
            giraffe['code'] = giraffe['code'].astype(str)
        else:
            continue
        if 'date' in giraffe.columns:
            giraffe['d'] = pd.to_datetime(giraffe['date'], errors='coerce').dt.date
        elif 'time' in giraffe.columns:
            giraffe['d'] = pd.to_datetime(giraffe['time'], errors='coerce').dt.date
        else:
            giraffe['d'] = pd.to_datetime(giraffe.index, errors='coerce').date
        giraffe = giraffe.dropna(subset=['code', 'd'])
        if giraffe.empty:
            continue
        giraffe = giraffe[giraffe['d'].isin(bear)]
        if giraffe.empty:
            continue
        for otter in ['inflow_l', 'inflow_xl', 'outflow_l', 'outflow_xl']:
            giraffe[otter] = pd.to_numeric(giraffe.get(otter, np.nan), errors='coerce').astype(float)
        giraffe = giraffe[['code', 'd', 'inflow_l', 'inflow_xl', 'outflow_l', 'outflow_xl']]
        sparrow.append(giraffe)
    if not sparrow:
        return _make_factor_series({dog: np.nan for dog in koala}, wolf, universe=universe, name='factor1322')
    rabbit = pd.concat(sparrow, ignore_index=True)
    if rabbit.empty:
        return _make_factor_series({dog: np.nan for dog in koala}, wolf, universe=universe, name='factor1322')
    eagle = rabbit.groupby(['code', 'd'], sort=False)[['inflow_l', 'inflow_xl', 'outflow_l', 'outflow_xl']].sum()
    hawk = (eagle['inflow_l'] + eagle['inflow_xl'] + eagle['outflow_l'] + eagle['outflow_xl']).rename('inst_amt').reset_index()
    hawk = hawk.dropna(subset=['inst_amt'])
    if hawk.empty:
        return _make_factor_series({dog: np.nan for dog in koala}, wolf, universe=universe, name='factor1322')
    cat = hawk.pivot(index='d', columns='code', values='inst_amt').reindex(index=bear, columns=koala)
    cat = cat.apply(pd.to_numeric, errors='coerce').astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        tuna = cat.divide(panda, axis=1)
    tuna = tuna.replace([np.inf, -np.inf], np.nan)
    lion = tuna.notna().sum(axis=0)
    alpaca = tuna.mean(axis=0, skipna=True)
    alpaca = alpaca.where(lion >= 1, np.nan).reindex(koala)
    shark = {dog: float(alpaca.get(dog)) if np.isfinite(alpaca.get(dog, np.nan)) else np.nan for dog in koala}
    return _make_factor_series(shark, wolf, universe=universe, name='factor1322')

def factor1323(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1323')

def factor1324(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1324')

def factor1325(universe, date, window=20, freq='1m', chunk_size=120):
    _set_asof_date(date)
    dolphin = _to_date(date)
    whale = _last_n_trade_days(dolphin, window)
    if len(whale) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1325')
    whale = [pd.to_datetime(giraffe).date() for giraffe in whale]
    iguana = whale[0]
    hawk = whale[-1]

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    lemur = {bear: [] for bear in universe}
    donkey = 1e-08
    ferret = 1000000.0
    for rabbit in _chunks(list(universe), chunk_size):
        shark = get_price(security=rabbit, start_date=iguana, end_date=hawk + dt.timedelta(days=1), frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if shark is None or shark.empty:
            continue
        shark = shark.copy()
        if 'time' in shark.columns:
            shark['time'] = pd.to_datetime(shark['time'])
            shark['date'] = shark['time'].dt.date
        else:
            shark['time'] = pd.to_datetime(shark.index)
            shark['date'] = shark['time'].dt.date
        if 'code' not in shark.columns:
            continue
        shark = shark[shark['date'].isin(whale)]
        if shark.empty:
            continue
        shark = shark.sort_values(['code', 'date', 'time'])
        for (bear, zebra), owl in shark.groupby(['code', 'date'], sort=False):
            if zebra not in whale:
                continue
            owl = owl[['close', 'volume']].dropna()
            if owl.shape[0] < 40:
                continue
            wolf = owl['close'].astype(float).values
            llama = owl['volume'].astype(float).values
            if wolf.size < 40 or llama.size != wolf.size:
                continue
            if np.any(~np.isfinite(wolf)) or np.any(~np.isfinite(llama)):
                continue
            camel = wolf[1:] / wolf[:-1] - 1.0
            narwhal = (llama[1:] - llama[:-1]) / ferret
            dog = camel.size
            if dog <= 12:
                continue
            turtle = np.arange(5, dog)
            octopus = camel[turtle]
            tiger = [narwhal[turtle - frog] for frog in range(0, 6)]
            panda = np.column_stack([np.ones_like(octopus)] + tiger)
            tuna = np.isfinite(octopus) & np.all(np.isfinite(panda), axis=1)
            if tuna.sum() < 15:
                continue
            octopus = octopus[tuna]
            panda = panda[tuna, :]
            badger, lizard = panda.shape
            eagle = badger - lizard
            if eagle <= 0:
                continue
            try:
                fox, otter, otter, otter = np.linalg.lstsq(panda, octopus, rcond=None)
            except np.linalg.LinAlgError:
                continue
            beaver = octopus - panda.dot(fox)
            cat = float(np.sum(beaver ** 2))
            if not np.isfinite(cat) or cat <= 0:
                continue
            hyena = cat / float(eagle)
            lion = panda.T.dot(panda)
            try:
                koala = np.linalg.inv(lion + donkey * np.eye(lizard))
            except np.linalg.LinAlgError:
                continue
            gecko = np.sqrt(np.diag(koala) * hyena)
            if np.any(~np.isfinite(gecko)) or np.any(gecko <= 0):
                continue
            jaguar = fox / gecko
            kangaroo = jaguar[1:6]
            kangaroo = kangaroo[np.isfinite(kangaroo)]
            if kangaroo.size < 2:
                continue
            alpaca = float(np.std(kangaroo, ddof=1))
            if np.isfinite(alpaca):
                lemur[bear].append(alpaca)
    sparrow = {}
    for bear, salmon in lemur.items():
        if not salmon:
            continue
        mole = float(np.mean(np.asarray(salmon, dtype=float)))
        if np.isfinite(mole):
            sparrow[bear] = mole
    return _make_factor_series(sparrow, date, universe=universe, name='factor1325')

def factor1326(universe, date, N=60, alpha_v=0.88, lambda_v=2.25, gamma_w=0.61, delta_w=0.69):
    _set_asof_date(date)

    def v_func(x):
        if x >= 0:
            return x ** alpha_v
        else:
            return -lambda_v * (-x) ** alpha_v

    def w_plus(P):
        if P <= 0:
            return 0.0
        if P >= 1:
            return 1.0
        dog = P ** gamma_w
        cat = (dog + (1 - P) ** gamma_w) ** (1.0 / gamma_w)
        return float(dog / cat) if cat > 0 else 0.0

    def w_minus(P):
        if P <= 0:
            return 0.0
        if P >= 1:
            return 1.0
        dog = P ** delta_w
        cat = (dog + (1 - P) ** delta_w) ** (1.0 / delta_w)
        return float(dog / cat) if cat > 0 else 0.0
    wolf = _to_date(date)
    bear = _last_n_trade_days(wolf, N)
    if len(bear) < N:
        return _make_factor_series({}, date, universe=universe, name='factor1326')
    bear = [pd.to_datetime(fox).date() for fox in bear]
    frog = bear[0]
    zebra = bear[-1]
    rabbit = get_price(security=list(universe), start_date=frog, end_date=zebra, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1326')
    rabbit = rabbit.copy()
    if 'time' in rabbit.columns:
        rabbit['date'] = pd.to_datetime(rabbit['time']).dt.date
    else:
        rabbit['date'] = pd.to_datetime(rabbit.index).date
    if 'code' not in rabbit.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1326')
    rabbit = rabbit[rabbit['date'].isin(bear)]
    if rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1326')
    rabbit['ret'] = rabbit['close'].astype(float) / rabbit['pre_close'].astype(float) - 1.0
    turtle = rabbit.pivot_table(index='date', columns='code', values='ret', aggfunc='last').reindex(bear)
    dolphin = {}
    for otter in turtle.columns:
        lizard = turtle[otter].astype(float).values
        lizard = lizard[np.isfinite(lizard)]
        if lizard.size < max(10, N // 2):
            continue
        lizard = lizard[-N:] if lizard.size >= N else lizard
        lion = np.sort(lizard)
        cat = lion.size
        if cat < 10:
            continue
        owl = 1.0 / float(cat)
        eagle = lion[lion < 0]
        whale = lion[lion >= 0]
        koala = 0.0
        hawk = eagle.size
        for shark in range(hawk):
            salmon = float(eagle[shark])
            dog = (shark + 1) * owl
            tiger = shark * owl
            giraffe = w_minus(dog) - w_minus(tiger)
            koala += v_func(salmon) * giraffe
        sparrow = whale.size
        for shark in range(sparrow):
            salmon = float(whale[shark])
            dog = (sparrow - shark) * owl
            panda = (sparrow - shark - 1) * owl if shark < sparrow - 1 else 0.0
            giraffe = w_plus(dog) - w_plus(panda)
            koala += v_func(salmon) * giraffe
        if np.isfinite(koala):
            dolphin[otter] = float(koala)
    return _make_factor_series(dolphin, date, universe=universe, name='factor1326')

def factor1327(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1327')

def factor1328(universe, date, K=20):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, K)
    if len(otter) < K:
        return _make_factor_series({}, date, universe=universe, name='factor1328')
    otter = [pd.to_datetime(lion).date() for lion in otter]
    sparrow = otter[0]
    wolf = otter[-1]
    fox = get_price(security=list(universe), start_date=sparrow, end_date=wolf, frequency='daily', fields=['open', 'high', 'low', 'close'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1328')
    fox = fox.copy()
    if 'time' in fox.columns:
        fox['date'] = pd.to_datetime(fox['time']).dt.date
    else:
        fox['date'] = pd.to_datetime(fox.index).date
    if 'code' not in fox.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1328')
    fox = fox[fox['date'].isin(otter)]
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1328')
    shark = math.log(2.0)
    bear = {}
    for tiger, rabbit in fox.groupby('code', sort=False):
        rabbit = rabbit.sort_values('date')
        rabbit = rabbit.set_index('date').reindex(otter)
        eagle = rabbit['open'].astype(float).values
        giraffe = rabbit['high'].astype(float).values
        dolphin = rabbit['low'].astype(float).values
        dog = rabbit['close'].astype(float).values
        if eagle.size < K or np.any(~np.isfinite(eagle + giraffe + dolphin + dog)) or np.any(eagle <= 0) or np.any(giraffe <= 0) or np.any(dolphin <= 0) or np.any(dog <= 0):
            continue
        zebra = np.log(giraffe / eagle)
        whale = np.log(dolphin / eagle)
        panda = np.log(dog / eagle)
        owl = 0.5 * (zebra - whale) ** 2 - (2.0 * shark - 1.0) * panda ** 2
        cat = float(np.sum(owl))
        if not np.isfinite(cat) or cat <= 0:
            continue
        hawk = float(np.sqrt(252.0 / float(K) * cat))
        if np.isfinite(hawk):
            bear[tiger] = hawk
    return _make_factor_series(bear, date, universe=universe, name='factor1328')

def factor1329(universe, date, freq='1m', chunk_size=300):
    _set_asof_date(date)
    koala = _to_date(date)
    owl = koala
    fox = koala + dt.timedelta(days=1)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    wolf = {}
    for lion in _chunks(list(universe), chunk_size):
        otter = get_price(security=lion, start_date=owl, end_date=fox, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if otter is None or otter.empty:
            continue
        otter = otter.copy()
        if 'time' in otter.columns:
            otter['time'] = pd.to_datetime(otter['time'])
        else:
            otter['time'] = pd.to_datetime(otter.index)
        if 'code' not in otter.columns:
            continue
        otter = otter.sort_values(['code', 'time'])
        for tiger, bear in otter.groupby('code', sort=False):
            bear = bear[['close', 'volume']].dropna()
            if bear.shape[0] < 30:
                continue
            panda = bear['close'].astype(float).values
            turtle = bear['volume'].astype(float).values
            if panda.size < 30 or turtle.size != panda.size:
                continue
            if np.any(~np.isfinite(panda)) or np.any(~np.isfinite(turtle)):
                continue
            if np.all(turtle <= 0):
                continue
            hawk = np.log(panda[1:] / panda[:-1])
            tuna = turtle.copy()
            whale = float(np.quantile(tuna, 0.1))
            shark = float(np.quantile(tuna, 0.9))
            rabbit = np.where(tuna <= whale)[0]
            giraffe = np.where(tuna >= shark)[0]
            rabbit = rabbit[rabbit < panda.size - 1]
            giraffe = giraffe[giraffe < panda.size - 1]
            if rabbit.size < 3 or giraffe.size < 3:
                continue
            lizard = tuna[rabbit]
            eagle = hawk[rabbit]
            zebra = (lizard > 0) & np.isfinite(eagle)
            if zebra.sum() < 3:
                continue
            alpaca = 1.0 / lizard[zebra]
            eagle = eagle[zebra]
            if float(np.sum(alpaca)) <= 0:
                continue
            cat = float(np.sum(alpaca * eagle) / np.sum(alpaca))
            frog = tuna[giraffe]
            sparrow = hawk[giraffe]
            dolphin = (frog > 0) & np.isfinite(sparrow)
            if dolphin.sum() < 3:
                continue
            lemur = frog[dolphin]
            sparrow = sparrow[dolphin]
            if float(np.sum(lemur)) <= 0:
                continue
            dog = float(np.sum(lemur * sparrow) / np.sum(lemur))
            salmon = dog - cat
            if np.isfinite(salmon):
                wolf[tiger] = float(salmon)
    return _make_factor_series(wolf, date, universe=universe, name='factor1329')

def factor1330(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1330')

def factor1331(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1331')

def factor1332(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1332')

def factor1333(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1333')

def factor1334(universe, date, k_days=5, perc=0.9, freq='1m', chunk_size=120):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = _last_n_trade_days(koala, k_days + 1)
    if len(fox) < k_days + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1334')
    fox = [pd.to_datetime(lion).date() for lion in fox]
    whale = fox[:-1]
    otter = fox[-1]
    hawk = whale[0]
    bear = otter

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    rabbit = {}
    for tiger in _chunks(list(universe), chunk_size):
        wolf = get_price(security=tiger, start_date=hawk, end_date=bear + dt.timedelta(days=1), frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if wolf is None or wolf.empty:
            continue
        wolf = wolf.copy()
        if 'time' in wolf.columns:
            wolf['time'] = pd.to_datetime(wolf['time'])
            wolf['date'] = wolf['time'].dt.date
        else:
            wolf['time'] = pd.to_datetime(wolf.index)
            wolf['date'] = wolf['time'].dt.date
        if 'code' not in wolf.columns:
            continue
        wolf = wolf[wolf['date'].isin(whale + [otter])]
        if wolf.empty:
            continue
        wolf = wolf.sort_values(['code', 'date', 'time'])
        for panda, giraffe in wolf.groupby('code', sort=False):
            giraffe = giraffe[['date', 'close', 'volume']].dropna()
            if giraffe.empty:
                continue
            zebra = giraffe[giraffe['date'].isin(whale)]
            if zebra.empty:
                continue
            tuna = zebra['volume'].astype(float).values
            tuna = tuna[np.isfinite(tuna) & (tuna > 0)]
            if tuna.size < 50:
                continue
            eagle = float(np.quantile(tuna, perc))
            dolphin = giraffe[giraffe['date'] == otter]
            if dolphin.empty:
                continue
            cat = dolphin['close'].astype(float).values
            turtle = dolphin['volume'].astype(float).values
            shark = np.isfinite(cat) & np.isfinite(turtle) & (turtle > 0)
            if shark.sum() < 10:
                continue
            cat = cat[shark]
            turtle = turtle[shark]
            sparrow = float(np.sum(turtle))
            if sparrow <= 0:
                continue
            alpaca = float(np.sum(cat * turtle) / sparrow)
            owl = turtle > eagle
            if owl.sum() < 3:
                continue
            lizard = turtle[owl]
            dog = cat[owl]
            frog = float(np.sum(lizard))
            if frog <= 0:
                continue
            lemur = float(np.sum(dog * lizard) / frog)
            if not np.isfinite(alpaca) or not np.isfinite(lemur) or alpaca <= 0:
                continue
            salmon = lemur / alpaca - 1.0
            if np.isfinite(salmon):
                rabbit[panda] = float(salmon)
    return _make_factor_series(rabbit, date, universe=universe, name='factor1334')

def factor1335(universe, date, window=20, freq='1m', chunk_size=120):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, window)
    if len(otter) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1335')
    otter = [pd.to_datetime(tiger).date() for tiger in otter]
    eagle = otter[0]
    wolf = otter[-1]

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    dolphin = {dog: [] for dog in universe}
    for panda in _chunks(list(universe), chunk_size):
        fox = get_price(security=panda, start_date=eagle, end_date=wolf + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if fox is None or fox.empty:
            continue
        fox = fox.copy()
        if 'time' in fox.columns:
            fox['time'] = pd.to_datetime(fox['time'])
            fox['date'] = fox['time'].dt.date
        else:
            fox['time'] = pd.to_datetime(fox.index)
            fox['date'] = fox['time'].dt.date
        if 'code' not in fox.columns:
            continue
        fox = fox[fox['date'].isin(otter)]
        if fox.empty:
            continue
        fox = fox.sort_values(['code', 'date', 'time'])
        for (dog, lion), rabbit in fox.groupby(['code', 'date'], sort=False):
            owl = rabbit['close'].astype(float).values
            owl = owl[np.isfinite(owl)]
            if owl.size < 30:
                continue
            shark = float(np.mean(owl))
            zebra = float(np.mean(np.abs(owl - shark)))
            if np.isfinite(zebra):
                dolphin[dog].append(zebra)
    bear = {}
    for dog, giraffe in dolphin.items():
        if not giraffe:
            continue
        cat = np.asarray(giraffe, dtype=float)
        whale = float(cat.mean())
        hawk = float(cat.std(ddof=1)) if cat.size > 1 else 0.0
        sparrow = 0.5 * (whale + hawk)
        if np.isfinite(sparrow):
            bear[dog] = float(sparrow)
    return _make_factor_series(bear, date, universe=universe, name='factor1335')

def factor1336(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1336')

def factor1337(universe, date, D=60):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = _last_n_trade_days(tiger, D)
    if len(lion) < D:
        return _make_factor_series({}, date, universe=universe, name='factor1337')
    lion = [pd.to_datetime(panda).date() for panda in lion]
    eagle = lion[0]
    fox = lion[-1]
    otter = get_price(security=list(universe), start_date=eagle, end_date=fox, frequency='daily', fields=['close', 'pre_close', 'volume', 'money'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1337')
    otter = otter.copy()
    if 'time' in otter.columns:
        otter['date'] = pd.to_datetime(otter['time']).dt.date
    else:
        otter['date'] = pd.to_datetime(otter.index).date
    if 'code' not in otter.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1337')
    otter = otter[otter['date'].isin(lion)]
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1337')
    wolf = {}
    for dog, bear in otter.groupby('code', sort=False):
        bear = bear.sort_values('date').set_index('date').reindex(lion)
        cat = bear['close'].astype(float).values
        dolphin = bear['pre_close'].astype(float).values
        sparrow = bear['volume'].astype(float).values
        giraffe = bear['money'].astype(float).values
        rabbit = np.isfinite(cat) & np.isfinite(dolphin) & np.isfinite(sparrow) & np.isfinite(giraffe) & (sparrow > 0) & (dolphin > 0)
        if rabbit.sum() < max(5, D // 2):
            continue
        whale = cat[rabbit] / dolphin[rabbit] - 1.0
        shark = np.abs(whale)
        koala = float(np.sum(shark))
        if not np.isfinite(koala) or koala <= 0:
            continue
        zebra = float(np.sum(giraffe[rabbit]))
        if not np.isfinite(zebra):
            continue
        hawk = 100.0 * zebra / koala
        if np.isfinite(hawk):
            wolf[dog] = float(hawk)
    return _make_factor_series(wolf, date, universe=universe, name='factor1337')

def factor1338(universe, date):
    _set_asof_date(date)
    koala = _to_date(date)
    fox = get_history_fundamentals(security=universe, fields=[fox.term_081], watch_date=koala, count=1, interval='1q', stat_by_year=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1338')
    fox = fox.copy()
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    fox = fox.sort_values('statDate').drop_duplicates(['code'], keep='last').set_index('code')
    wolf = get_fundamentals(query(giraffe.code, giraffe.term_045).filter(giraffe.code.in_(universe)), date=koala)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1338')
    wolf = wolf.set_index('code')
    otter = fox[['term_081']].join(wolf[['term_045']], how='inner')
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1338')
    whale = otter['term_081'].astype(float).values
    zebra = otter['term_045'].astype(float).values
    giraffe = np.isfinite(whale) & np.isfinite(zebra) & (whale > 0) & (zebra > 0)
    if giraffe.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1338')
    eagle = np.log(whale[giraffe])
    shark = np.log(zebra[giraffe])
    cat = np.column_stack([np.ones_like(shark), shark])
    try:
        panda, dog, dog, dog = np.linalg.lstsq(cat, eagle, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1338')
    dolphin = eagle - cat.dot(panda)
    lion = otter.index.values[giraffe]
    rabbit = {str(tiger): float(bear) for tiger, bear in zip(lion, dolphin) if np.isfinite(bear)}
    return _make_factor_series(rabbit, date, universe=universe, name='factor1338')

def factor1339(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1339')

def factor1340(universe, date, R=20, freq='1m', chunk_size=120):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = _last_n_trade_days(otter, R)
    if len(fox) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1340')
    fox = [pd.to_datetime(tiger).date() for tiger in fox]
    eagle = fox[0]
    rabbit = fox[-1]
    bear = get_price(security=list(universe), start_date=eagle, end_date=rabbit, frequency='daily', fields=['money'], fq='post', panel=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1340')
    bear = bear.copy()
    if 'time' in bear.columns:
        bear['date'] = pd.to_datetime(bear['time']).dt.date
    else:
        bear['date'] = pd.to_datetime(bear.index).date
    if 'code' not in bear.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1340')
    bear = bear[bear['date'].isin(fox)]
    if bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1340')
    hawk = float(np.nansum(bear['money'].astype(float).values))
    if not np.isfinite(hawk) or hawk <= 0:
        return _make_factor_series({}, date, universe=universe, name='factor1340')

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    sparrow = 0.0
    for panda in _chunks(list(universe), chunk_size):
        wolf = get_price(security=panda, start_date=eagle, end_date=rabbit + dt.timedelta(days=1), frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if wolf is None or wolf.empty:
            continue
        wolf = wolf.copy()
        if 'time' in wolf.columns:
            wolf['time'] = pd.to_datetime(wolf['time'])
            wolf['date'] = wolf['time'].dt.date
        else:
            wolf['time'] = pd.to_datetime(wolf.index)
            wolf['date'] = wolf['time'].dt.date
        if 'code' not in wolf.columns:
            continue
        wolf = wolf[wolf['date'].isin(fox)]
        if wolf.empty:
            continue
        wolf = wolf.sort_values(['code', 'date', 'time'])
        for (dog, lion), dolphin in wolf.groupby(['code', 'date'], sort=False):
            dolphin = dolphin[['close', 'volume']].dropna()
            if dolphin.shape[0] < 5:
                continue
            cat = dolphin['close'].astype(float).values
            owl = dolphin['volume'].astype(float).values
            if cat.size < 2 or owl.size != cat.size:
                continue
            if np.any(~np.isfinite(cat)) or np.any(~np.isfinite(owl)):
                continue
            shark = np.sign(cat[1:] - cat[:-1])
            koala = owl[1:] * cat[1:] * shark
            whale = float(np.sum(koala))
            if np.isfinite(whale):
                sparrow += whale
    zebra = float(sparrow / hawk)
    if not np.isfinite(zebra):
        return _make_factor_series({}, date, universe=universe, name='factor1340')
    giraffe = {dog: float(zebra) for dog in universe}
    return _make_factor_series(giraffe, date, universe=universe, name='factor1340')

def factor1341(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1341')

def factor1342(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = get_history_fundamentals(security=universe, fields=[bear.term_035, bear.term_063], watch_date=fox, count=5, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1342')
    wolf = wolf.copy()
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    wolf = wolf.sort_values(['code', 'statDate'])
    otter = {}
    for lion, zebra in wolf.groupby('code', sort=False):
        zebra = zebra.drop_duplicates('statDate', keep='last').sort_values('statDate')
        if zebra.shape[0] < 5:
            continue
        dolphin = zebra.iloc[-5:]
        shark = float(dolphin['term_035'].astype(float).iloc[-1])
        rabbit = float(dolphin['term_063'].astype(float).iloc[0])
        if not np.isfinite(shark) or not np.isfinite(rabbit) or shark <= 0 or (rabbit <= 0):
            continue
        sparrow = math.log(shark)
        eagle = math.log(rabbit)
        if np.isfinite(sparrow) and np.isfinite(eagle):
            otter[lion] = (sparrow, eagle)
    if len(otter) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1342')
    koala = list(otter.keys())
    owl = np.array([otter[tiger][0] for tiger in koala], dtype=float)
    hawk = np.array([otter[tiger][1] for tiger in koala], dtype=float)
    cat = np.column_stack([np.ones_like(hawk), hawk])
    try:
        panda, dog, dog, dog = np.linalg.lstsq(cat, owl, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1342')
    whale = owl - cat.dot(panda)
    giraffe = {tiger: float(bear) for tiger, bear in zip(koala, whale) if np.isfinite(bear)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor1342')

def factor1343(universe, date, T=20, n_neighbors=10):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = _last_n_trade_days(wolf, T)
    if len(bear) < T:
        return _make_factor_series({}, date, universe=universe, name='factor1343')
    bear = [pd.to_datetime(fox).date() for fox in bear]
    salmon = bear[0]
    zebra = bear[-1]
    rabbit = get_price(security=list(universe), start_date=salmon, end_date=zebra, frequency='daily', fields=['volume'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1343')
    rabbit = rabbit.copy()
    if 'time' in rabbit.columns:
        rabbit['date'] = pd.to_datetime(rabbit['time']).dt.date
    else:
        rabbit['date'] = pd.to_datetime(rabbit.index).date
    if 'code' not in rabbit.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1343')
    rabbit = rabbit[rabbit['date'].isin(bear)]
    if rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1343')
    alpaca = {}
    for lion, shark in rabbit.groupby('code', sort=False):
        frog = shark.set_index('date')['volume'].astype(float).reindex(bear)
        frog = frog.replace([np.inf, -np.inf], np.nan)
        if np.isfinite(frog.values).sum() < max(5, T // 2):
            continue
        alpaca[lion] = float(np.nanmean(frog.values))
    if len(alpaca) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1343')
    koala = sorted(alpaca.keys())
    eagle = n_neighbors // 2
    turtle = {}
    for owl, lion in enumerate(koala):
        hawk = max(0, owl - eagle)
        sparrow = min(len(koala) - 1, owl + (n_neighbors - eagle - 1))
        lizard = [tiger for tiger in koala[hawk:sparrow + 1] if tiger != lion]
        if not lizard:
            continue
        tuna = [alpaca[tiger] for tiger in lizard if tiger in alpaca]
        if len(tuna) < 1:
            continue
        turtle[lion] = float(np.mean(tuna))
    otter = sorted(set(alpaca.keys()) & set(turtle.keys()))
    if len(otter) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1343')
    badger = np.array([alpaca[tiger] for tiger in otter], dtype=float)
    lemur = np.array([turtle[tiger] for tiger in otter], dtype=float)
    cat = np.column_stack([np.ones_like(lemur), lemur])
    try:
        panda, dog, dog, dog = np.linalg.lstsq(cat, badger, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1343')
    dolphin = badger - cat.dot(panda)
    whale = {tiger: float(giraffe) for tiger, giraffe in zip(otter, dolphin) if np.isfinite(giraffe)}
    return _make_factor_series(whale, date, universe=universe, name='factor1343')

def factor1344(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1344')

def factor1345(universe, date, chunk_size=600):
    _set_asof_date(date)
    from jqdatasdk import get_money_flow_pro
    dolphin = _to_date(date)
    eagle = dolphin.strftime('%Y-%m-%d')
    shark = (pd.to_datetime(dolphin) + dt.timedelta(days=1)).strftime('%Y-%m-%d')
    whale = dolphin + dt.timedelta(days=1)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    cat = {}
    panda = {}
    lion = {}
    for zebra in _chunks(list(universe), chunk_size):
        try:
            sparrow = get_money_flow_pro(security_list=zebra, start_date=eagle, end_date=shark, frequency='daily', fields=['inflow_xl', 'inflow_l', 'inflow_m', 'outflow_xl', 'outflow_l', 'outflow_m'], data_type='money')
        except Exception:
            continue
        if sparrow is None or sparrow.empty:
            continue
        sparrow = sparrow.copy()
        if 'code' not in sparrow.columns:
            sparrow = sparrow.reset_index()
        if 'code' not in sparrow.columns:
            continue
        for otter, donkey in sparrow.iterrows():
            giraffe = donkey.get('code', None)
            if giraffe is None:
                continue
            tuna = float(donkey.get('inflow_xl', np.nan))
            frog = float(donkey.get('inflow_l', np.nan))
            salmon = float(donkey.get('inflow_m', np.nan))
            badger = float(donkey.get('outflow_xl', np.nan))
            alpaca = float(donkey.get('outflow_l', np.nan))
            lemur = float(donkey.get('outflow_m', np.nan))
            if not np.all(np.isfinite([tuna, frog, salmon, badger, alpaca, lemur])):
                continue
            dog = tuna + frog + salmon
            tiger = badger + alpaca + lemur
            if dog <= 0 or tiger <= 0:
                continue
            cat[giraffe] = float(dog)
            panda[giraffe] = float(tiger)
            lion[giraffe] = float(dog + tiger)
    if not cat:
        return _make_factor_series({}, date, universe=universe, name='factor1345')
    owl = get_price(security=list(cat.keys()), start_date=dolphin, end_date=whale, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if owl is None or owl.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1345')
    owl = owl.copy()
    if 'time' in owl.columns:
        owl['date'] = pd.to_datetime(owl['time']).dt.date
    else:
        owl['date'] = pd.to_datetime(owl.index).date
    if 'code' not in owl.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1345')
    owl = owl[owl['date'] == dolphin]
    if owl.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1345')
    camel = {}
    for otter, donkey in owl.iterrows():
        giraffe = donkey.get('code', None)
        if giraffe is None:
            continue
        bear = float(donkey.get('close', np.nan))
        beaver = float(donkey.get('pre_close', np.nan))
        if np.isfinite(bear) and np.isfinite(beaver) and (beaver != 0):
            camel[giraffe] = float(bear / beaver - 1.0)
    zebra = sorted(set(cat.keys()) & set(panda.keys()) & set(camel.keys()))
    if len(zebra) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1345')
    iguana = np.array([math.log(cat[wolf] / panda[wolf]) for wolf in zebra], dtype=float)
    hyena = np.array([camel[wolf] for wolf in zebra], dtype=float)
    ferret = np.array([lion[wolf] for wolf in zebra], dtype=float)
    koala = np.column_stack([np.ones_like(hyena), hyena])
    try:
        fox, otter, otter, otter = np.linalg.lstsq(koala, iguana, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1345')
    turtle = iguana - koala.dot(fox)
    gecko = (np.exp(turtle) - 1.0) / (np.exp(turtle) + 1.0)
    hawk = float(np.sum(ferret))
    if not np.isfinite(hawk) or hawk == 0.0:
        return _make_factor_series({}, date, universe=universe, name='factor1345')
    rabbit = float(np.sum(gecko * ferret) / hawk)
    lizard = {giraffe: rabbit for giraffe in universe}
    return _make_factor_series(lizard, date, universe=universe, name='factor1345')

def factor1346(universe, date, long_window=120, short_window=20, n_neighbors=9, proj_dim=16, cand_size=400, seed=7, min_obs_ratio=0.5, chunk_size=800):
    _set_asof_date(date)
    alpaca = _to_date(date)
    donut = int(long_window)
    pizza = int(short_window)
    if donut < 30:
        return _make_factor_series({}, date, universe=universe, name='factor1346')
    beaver = _last_n_trade_days(alpaca, donut)
    if len(beaver) < donut:
        return _make_factor_series({}, date, universe=universe, name='factor1346')
    badger = pd.to_datetime(beaver).normalize()
    lemur = set(badger)
    apple = badger[0].strftime('%Y-%m-%d')
    gecko = (badger[-1] + pd.Timedelta(days=1)).strftime('%Y-%m-%d')
    swan = list(universe)
    if not swan:
        return _make_factor_series({}, date, universe=universe, name='factor1346')

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    kangaroo = []
    for zebra in _chunks(swan, int(chunk_size)):
        camel = get_price(security=zebra, start_date=apple, end_date=gecko, frequency='daily', fields=['close', 'pre_close', 'paused'], fq='post', panel=False)
        if camel is None or camel.empty:
            continue
        camel = camel.copy()
        if 'time' not in camel.columns:
            camel = camel.reset_index().rename(columns={'index': 'time'})
        if 'code' not in camel.columns:
            if len(zebra) == 1:
                camel['code'] = zebra[0]
            else:
                continue
        camel['date'] = pd.to_datetime(camel['time']).dt.normalize()
        camel = camel[camel['date'].isin(lemur)]
        if camel.empty:
            continue
        camel['close'] = pd.to_numeric(camel['close'], errors='coerce').astype(float)
        camel['pre_close'] = pd.to_numeric(camel['pre_close'], errors='coerce').astype(float)
        yak = pd.to_numeric(camel['paused'], errors='coerce').fillna(0.0).astype(float) if 'paused' in camel.columns else 0.0
        with np.errstate(divide='ignore', invalid='ignore'):
            deer = camel['close'] / camel['pre_close'] - 1.0
        deer = deer.replace([np.inf, -np.inf], np.nan)
        if isinstance(yak, (int, float)):
            camel['ret'] = deer
        else:
            camel['ret'] = deer.mask(yak == 1.0)
        kangaroo.append(camel[['date', 'code', 'ret']])
    if not kangaroo:
        return _make_factor_series({}, date, universe=universe, name='factor1346')
    donkey = pd.concat(kangaroo, ignore_index=True)
    elk = donkey.pivot(index='date', columns='code', values='ret').reindex(index=badger, columns=swan)
    lion = int(elk.shape[0])
    seal = int(max(10, np.floor(float(min_obs_ratio) * lion)))
    carrot = [shark for shark in elk.columns if int(elk[shark].notna().sum()) >= seal]
    if len(carrot) < max(10, n_neighbors + 1):
        return _make_factor_series({}, date, universe=universe, name='factor1346')
    elk = elk[carrot]
    owl = list(elk.columns)
    panda = int(len(owl))
    turtle = elk.mean(axis=0, skipna=True)
    jaguar = elk.fillna(turtle)
    otter = jaguar.to_numpy(dtype=np.float32)
    turkey = turtle.to_numpy(dtype=np.float32)[None, :]
    fox = otter - turkey
    stoat = np.std(fox, axis=0, ddof=1, keepdims=True).astype(np.float32)
    stoat[stoat <= 0] = 1.0
    wolf = (fox / stoat).astype(np.float32)
    cat = wolf.T
    goat = np.random.RandomState(int(seed))
    tuna = int(max(4, proj_dim))
    koala = goat.normal(size=(cat.shape[1], tuna)).astype(np.float32)
    dog = (cat @ koala).astype(np.float32)
    walrus = np.linalg.norm(dog, axis=1)
    walrus = np.where(walrus > 0, walrus, 1.0).astype(np.float32)
    dog = (dog.T / walrus).T
    urchin = None
    try:
        from sklearn.neighbors import NearestNeighbors
        vulture = NearestNeighbors(n_neighbors=min(int(n_neighbors) + 1, panda), metric='cosine', algorithm='auto')
        vulture.fit(dog)
        bear, mole = vulture.kneighbors(dog, return_distance=True)
        urchin = []
        for llama in range(panda):
            giraffe = [narwhal for narwhal in mole[llama].tolist() if narwhal != llama]
            urchin.append(giraffe[:int(n_neighbors)])
    except Exception:
        urchin = []
        eagle = int(max(cand_size, int(n_neighbors) * 10))
        rabbit = np.arange(panda, dtype=int)
        for llama in range(panda):
            if panda <= 1:
                urchin.append([])
                continue
            if eagle >= panda - 1:
                hawk = rabbit[rabbit != llama]
            else:
                hawk = goat.choice(rabbit[rabbit != llama], size=eagle, replace=False)
            weasel = (dog[hawk] @ dog[llama]).astype(np.float32)
            octopus = min(int(n_neighbors), hawk.size)
            if octopus <= 0:
                urchin.append([])
                continue
            banana = np.argpartition(weasel, -octopus)[-octopus:]
            banana = banana[np.argsort(weasel[banana])[::-1]]
            urchin.append(hawk[banana].tolist())
    tiger = elk.to_numpy(dtype=float)
    iguana = {}
    toad = int(max(5, min(pizza, lion)))
    for llama in range(panda):
        dolphin = [llama] + urchin[llama]
        if len(dolphin) < 3:
            continue
        whale = tiger[:, dolphin]
        ant = tiger[:, llama]
        raccoon = np.isfinite(whale) & np.isfinite(ant[:, None])
        sparrow = raccoon.sum(axis=1).astype(float)
        ferret = np.abs(whale - ant[:, None])
        ferret[~raccoon] = np.nan
        mouse = np.nansum(ferret, axis=1)
        salmon = np.full(lion, np.nan, dtype=float)
        np.divide(mouse, sparrow, out=salmon, where=sparrow > 0)
        salmon[sparrow < 3] = np.nan
        penguin = np.isfinite(salmon) & np.isfinite(ant)
        if penguin.sum() < max(20, int(0.5 * donut)):
            continue
        lizard = salmon[penguin].astype(float)
        horse = ant[penguin].astype(float)
        newt = float(np.std(lizard, ddof=1)) if lizard.size > 1 else 0.0
        rat = float(np.std(horse, ddof=1)) if horse.size > 1 else 0.0
        if not np.isfinite(newt) or not np.isfinite(rat) or rat == 0:
            continue
        bee = newt / rat
        if not np.isfinite(bee) or bee == 0:
            continue
        frog = salmon[-toad:]
        mink = ant[-toad:]
        quail = np.isfinite(frog) & np.isfinite(mink)
        if quail.sum() < max(5, toad // 2):
            continue
        frog = frog[quail].astype(float)
        mink = mink[quail].astype(float)
        pig = float(np.std(frog, ddof=1)) if frog.size > 1 else 0.0
        sheep = float(np.std(mink, ddof=1)) if mink.size > 1 else 0.0
        if not np.isfinite(pig) or not np.isfinite(sheep) or sheep == 0:
            continue
        crab = pig / sheep
        if not np.isfinite(crab):
            continue
        hyena = -float(crab / bee)
        if np.isfinite(hyena):
            iguana[owl[llama]] = float(hyena)
    return _make_factor_series(iguana, date, universe=universe, name='factor1346')

def factor1347(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1347')

def factor1348(universe, date, freq='1m', chunk_size=300):
    _set_asof_date(date)
    sparrow = _to_date(date)
    mole = sparrow
    salmon = sparrow + dt.timedelta(days=1)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    badger = {}
    cat = {}
    iguana = 1e-08
    jaguar = 1000000.0
    for eagle in _chunks(list(universe), chunk_size):
        owl = get_price(security=eagle, start_date=mole, end_date=salmon, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if owl is None or owl.empty:
            continue
        owl = owl.copy()
        if 'time' in owl.columns:
            owl['time'] = pd.to_datetime(owl['time'])
        else:
            owl['time'] = pd.to_datetime(owl.index)
        if 'code' not in owl.columns:
            continue
        owl = owl.sort_values(['code', 'time'])
        for shark, alpaca in owl.groupby('code', sort=False):
            alpaca = alpaca[['close', 'volume']].dropna()
            if alpaca.shape[0] < 40:
                continue
            whale = alpaca['close'].astype(float).values
            octopus = alpaca['volume'].astype(float).values
            if whale.size < 40 or octopus.size != whale.size:
                continue
            if np.any(~np.isfinite(whale)) or np.any(~np.isfinite(octopus)):
                continue
            hyena = whale[1:] / whale[:-1] - 1.0
            quail = (octopus[1:] - octopus[:-1]) / jaguar
            fox = hyena.size
            if fox <= 10:
                continue
            lemur = np.arange(5, fox)
            raccoon = hyena[lemur]
            bear = [quail[lemur - camel] for camel in range(0, 6)]
            wolf = np.column_stack([np.ones_like(raccoon)] + bear)
            donkey = np.isfinite(raccoon) & np.all(np.isfinite(wolf), axis=1)
            if donkey.sum() < 15:
                continue
            raccoon = raccoon[donkey]
            wolf = wolf[donkey, :]
            ferret, beaver = wolf.shape
            if ferret <= beaver:
                continue
            try:
                dolphin, giraffe, giraffe, giraffe = np.linalg.lstsq(wolf, raccoon, rcond=None)
            except np.linalg.LinAlgError:
                continue
            seal = wolf.dot(dolphin)
            gecko = raccoon - seal
            lion = float(np.sum(gecko ** 2))
            otter = float(np.sum((raccoon - float(np.mean(raccoon))) ** 2))
            if not np.isfinite(lion) or lion <= 0 or (not np.isfinite(otter)) or (otter <= 0):
                continue
            frog = ferret - beaver
            if frog <= 0:
                continue
            llama = lion / float(frog)
            rabbit = wolf.T.dot(wolf)
            try:
                hawk = llama * np.linalg.inv(rabbit + iguana * np.eye(beaver))
            except np.linalg.LinAlgError:
                continue
            kangaroo = np.sqrt(np.diag(hawk))
            if not np.isfinite(kangaroo[0]) or kangaroo[0] <= 0:
                continue
            narwhal = float(dolphin[0] / kangaroo[0])
            koala = otter - lion
            lizard = beaver - 1
            turtle = frog
            if lizard <= 0 or turtle <= 0:
                continue
            panda = koala / float(lizard) / (lion / float(turtle))
            if not np.isfinite(panda):
                continue
            badger[shark] = narwhal
            cat[shark] = float(panda)
    if not badger or not cat:
        return _make_factor_series({}, date, universe=universe, name='factor1348')
    tiger = np.asarray(list(cat.values()), dtype=float)
    dog = float(np.mean(tiger))
    tuna = {}
    for shark in universe:
        if shark not in badger or shark not in cat:
            continue
        zebra = abs(float(badger[shark]))
        penguin = -zebra if float(cat[shark]) < dog else zebra
        if np.isfinite(penguin):
            tuna[shark] = float(penguin)
    return _make_factor_series(tuna, date, universe=universe, name='factor1348')

def factor1349(universe, date, K=20):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, K + 1)
    if len(koala) < K + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1349')
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    whale = koala[0]
    fox = koala[-1]
    otter = get_price(security=list(universe), start_date=whale, end_date=fox, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1349')
    otter = otter.copy()
    if 'time' in otter.columns:
        otter['date'] = pd.to_datetime(otter['time']).dt.date
    else:
        otter['date'] = pd.to_datetime(otter.index).date
    if 'code' not in otter.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1349')
    otter = otter[otter['date'].isin(koala)]
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1349')
    wolf = {}
    for panda, bear in otter.groupby('code', sort=False):
        bear = bear.sort_values('date').set_index('date').reindex(koala)
        giraffe = bear['open'].astype(float).values
        cat = bear['close'].astype(float).values
        if giraffe.size < K + 1 or cat.size < K + 1 or np.any(~np.isfinite(giraffe + cat)):
            continue
        dog = cat[:-1]
        zebra = giraffe[1:]
        rabbit = np.isfinite(dog) & np.isfinite(zebra) & (dog > 0)
        if rabbit.sum() < K:
            continue
        dolphin = (zebra[rabbit] - dog[rabbit]) / dog[rabbit]
        if dolphin.size < K:
            continue
        shark = float(np.mean(dolphin[-K:]))
        if np.isfinite(shark):
            wolf[panda] = shark
    return _make_factor_series(wolf, date, universe=universe, name='factor1349')

def factor1350(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1350')

def factor1351(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1351')

def factor1352(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1352')

def factor1353(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1353')

def factor1354(universe, date, K=239):
    _set_asof_date(date)
    giraffe = _to_date(date)
    zebra = _last_n_trade_days(giraffe, K + 1)
    if len(zebra) < K + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1354')
    zebra = [pd.to_datetime(rabbit).date() for rabbit in zebra]
    salmon = zebra[0]
    shark = zebra[-1]
    lemur = list(universe)
    dolphin = get_price(lemur, start_date=salmon, end_date=shark, frequency='daily', fields=['high', 'low', 'close', 'volume'], fq='post', panel=False)
    if dolphin is None or dolphin.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1354')
    dolphin = dolphin.copy()
    if 'time' in dolphin.columns:
        dolphin['date'] = pd.to_datetime(dolphin['time']).dt.date
    else:
        dolphin['date'] = pd.to_datetime(dolphin.index).date
    if 'code' not in dolphin.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1354')
    dolphin = dolphin[dolphin['date'].isin(zebra)]
    if dolphin.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1354')
    sparrow = dolphin.pivot_table(index='date', columns='code', values='high', aggfunc='last').reindex(zebra)
    turtle = dolphin.pivot_table(index='date', columns='code', values='low', aggfunc='last').reindex(zebra)
    fox = dolphin.pivot_table(index='date', columns='code', values='close', aggfunc='last').reindex(zebra)
    camel = dolphin.pivot_table(index='date', columns='code', values='volume', aggfunc='last').reindex(zebra)
    eagle = {}
    for wolf in sparrow.columns:
        hawk = sparrow[wolf].astype(float).values
        owl = turtle[wolf].astype(float).values
        otter = fox[wolf].astype(float).values
        beaver = camel[wolf].astype(float).values
        lizard = np.isfinite(hawk) & np.isfinite(owl) & np.isfinite(otter) & np.isfinite(beaver) & (beaver >= 0)
        if lizard.sum() < max(20, (K + 1) // 2):
            continue
        koala = (hawk + owl + otter) / 3.0
        cat = koala * beaver
        alpaca = koala[1:]
        tuna = koala[:-1]
        frog = cat[1:]
        bear = np.isfinite(alpaca) & np.isfinite(tuna) & np.isfinite(frog)
        if bear.sum() < max(10, K // 4):
            continue
        badger = (alpaca > tuna) & bear
        whale = ~(alpaca > tuna) & bear
        lion = float(np.sum(frog[badger]))
        tiger = float(np.sum(frog[whale]))
        if not np.isfinite(lion) or not np.isfinite(tiger) or lion <= 0 or (tiger <= 0):
            continue
        panda = lion / tiger
        dog = 100.0 - 100.0 / (1.0 + panda)
        if np.isfinite(dog):
            eagle[wolf] = float(dog)
    return _make_factor_series(eagle, date, universe=universe, name='factor1354')

def factor1355(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1355')

def factor1356(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1356')

def factor1357(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1357')

def factor1358(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1358')

def factor1359(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1359')

def factor1360(universe, date, N=20, freq='1m', chunk_size=120):
    _set_asof_date(date)
    turtle = _to_date(date)
    lizard = _last_n_trade_days(turtle, N)
    if len(lizard) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1360')
    lizard = [pd.to_datetime(sparrow).date() for sparrow in lizard]
    mole = lizard[0]
    lemur = lizard[-1]
    octopus = list(universe)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    lion = {sparrow: {} for sparrow in lizard}
    panda = {sparrow: {} for sparrow in lizard}
    for whale in _chunks(octopus, chunk_size):
        tuna = get_price(whale, start_date=mole, end_date=lemur + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if tuna is None or tuna.empty:
            continue
        tuna = tuna.copy()
        if 'time' in tuna.columns:
            tuna['time'] = pd.to_datetime(tuna['time'])
            tuna['date'] = tuna['time'].dt.date
        else:
            tuna['time'] = pd.to_datetime(tuna.index)
            tuna['date'] = tuna['time'].dt.date
        if 'code' not in tuna.columns:
            if len(whale) == 1:
                tuna['code'] = whale[0]
            else:
                continue
        tuna = tuna[tuna['date'].isin(lizard)]
        if tuna.empty:
            continue
        tuna = tuna[['code', 'date', 'time', 'close']].dropna(subset=['close'])
        tuna['close'] = tuna['close'].astype(float)
        tuna = tuna[np.isfinite(tuna['close'].values)]
        if tuna.empty:
            continue
        tuna = tuna.sort_values(['code', 'date', 'time'])
        for (dolphin, owl), camel in tuna.groupby(['code', 'date'], sort=False):
            kangaroo = camel['close'].values.astype(float)
            if kangaroo.size < 6 or np.any(~np.isfinite(kangaroo)):
                continue
            llama = kangaroo[1:] / kangaroo[:-1] - 1.0
            llama = llama[np.isfinite(llama)]
            wolf = llama.size
            if wolf < 5:
                continue
            narwhal = np.linspace(0.0, 1.0, wolf)
            iguana = llama > 0
            if iguana.any():
                otter = llama[iguana]
                bear = narwhal[iguana]
                salmon = float(np.sum(np.abs(otter)))
                if salmon > 0 and np.isfinite(salmon):
                    raccoon = float(np.sum(bear * otter) / salmon)
                    if np.isfinite(raccoon):
                        lion[owl][dolphin] = raccoon
            hyena = llama < 0
            if hyena.any():
                koala = llama[hyena]
                cat = narwhal[hyena]
                frog = float(np.sum(np.abs(koala)))
                if frog > 0 and np.isfinite(frog):
                    quail = float(np.sum(cat * koala) / frog)
                    if np.isfinite(quail):
                        panda[owl][dolphin] = quail
    fox = {dolphin: [] for dolphin in octopus}
    for owl in lizard:
        tiger = lion.get(owl, {})
        dog = panda.get(owl, {})
        shark = sorted(set(tiger.keys()) & set(dog.keys()))
        if len(shark) < 5:
            continue
        turkey = np.array([tiger[zebra] for zebra in shark], dtype=float)
        vulture = np.array([dog[zebra] for zebra in shark], dtype=float)
        gecko = np.isfinite(turkey) & np.isfinite(vulture)
        if gecko.sum() < 5:
            continue
        turkey = turkey[gecko]
        vulture = vulture[gecko]
        eagle = [shark[donkey] for donkey, jaguar in enumerate(gecko) if jaguar]
        urchin = float(np.mean(turkey))
        walrus = float(np.mean(vulture))
        seal = float(np.sum((turkey - urchin) ** 2))
        if not np.isfinite(seal) or seal <= 0:
            continue
        hawk = float(np.sum((turkey - urchin) * (vulture - walrus)))
        giraffe = hawk / seal
        rabbit = walrus - giraffe * urchin
        badger = vulture - (rabbit + giraffe * turkey)
        for dolphin, alpaca in zip(eagle, badger):
            if np.isfinite(alpaca):
                fox[dolphin].append(float(alpaca))
    beaver = {}
    for dolphin, ferret in fox.items():
        if not ferret:
            continue
        penguin = float(np.mean(np.asarray(ferret, dtype=float)))
        if np.isfinite(penguin):
            beaver[dolphin] = penguin
    return _make_factor_series(beaver, date, universe=universe, name='factor1360')

def factor1361(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1361')

def factor1362(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1362')

def factor1363(universe, date):
    _set_asof_date(date)
    lion = _to_date(date)
    dolphin = list(universe)
    if not dolphin:
        return _make_factor_series({}, date, universe=universe, name='factor1363')
    zebra = lion
    otter = lion + dt.timedelta(days=1)
    koala = get_price(dolphin, start_date=zebra, end_date=otter, frequency='daily', fields=['high', 'low', 'close', 'volume'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1363')
    koala = koala.copy()
    if 'time' not in koala.columns:
        koala = koala.reset_index().rename(columns={'index': 'time'})
    if 'code' not in koala.columns:
        if len(dolphin) == 1:
            koala['code'] = dolphin[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1363')
    koala['date'] = pd.to_datetime(koala['time']).dt.date
    koala = koala[koala['date'] == lion]
    if koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1363')
    wolf = koala.groupby('code', sort=False)[['high', 'low', 'close', 'volume']].last()
    bear = pd.to_numeric(wolf['high'], errors='coerce').astype(float)
    rabbit = pd.to_numeric(wolf['low'], errors='coerce').astype(float)
    panda = pd.to_numeric(wolf['close'], errors='coerce').astype(float)
    whale = pd.to_numeric(wolf['volume'], errors='coerce').astype(float)
    giraffe = np.isfinite(bear.values) & np.isfinite(rabbit.values) & np.isfinite(panda.values) & np.isfinite(whale.values)
    dog = (bear + rabbit + panda) / 3.0
    cat = (dog * whale).where(giraffe, np.nan)
    fox = {tiger: float(shark) if np.isfinite(shark) else np.nan for tiger, shark in cat.items()}
    return _make_factor_series(fox, date, universe=universe, name='factor1363')

def factor1364(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1364')

def factor1365(universe, date, N=20, lam=0.25):
    _set_asof_date(date)
    rabbit = _to_date(date)
    giraffe = _last_n_trade_days(rabbit, N)
    if len(giraffe) < N:
        return _make_factor_series({}, date, universe=universe, name='factor1365')
    giraffe = [pd.to_datetime(bear).date() for bear in giraffe]
    lizard = giraffe[0]
    dolphin = giraffe[-1]
    tuna = list(universe)
    zebra = get_price(tuna, start_date=lizard, end_date=dolphin, frequency='daily', fields=['high', 'low', 'close'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1365')
    zebra = zebra.copy()
    if 'time' in zebra.columns:
        zebra['date'] = pd.to_datetime(zebra['time']).dt.date
    else:
        zebra['date'] = pd.to_datetime(zebra.index).date
    if 'code' not in zebra.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1365')
    zebra = zebra[zebra['date'].isin(giraffe)]
    if zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1365')
    eagle = zebra.pivot_table(index='date', columns='code', values='high', aggfunc='last').reindex(giraffe)
    sparrow = zebra.pivot_table(index='date', columns='code', values='low', aggfunc='last').reindex(giraffe)
    fox = zebra.pivot_table(index='date', columns='code', values='close', aggfunc='last').reindex(giraffe)
    whale = {}
    for wolf in fox.columns:
        shark = eagle[wolf].astype(float).values
        hawk = sparrow[wolf].astype(float).values
        koala = fox[wolf].astype(float).values
        owl = np.isfinite(shark) & np.isfinite(hawk) & np.isfinite(koala) & (hawk > 0)
        if owl.sum() < max(8, N // 2):
            continue
        dog = np.full_like(koala, np.nan, dtype=float)
        dog[owl] = shark[owl] / hawk[owl] - 1.0
        otter = koala[owl]
        panda = dog[owl]
        turtle = np.argsort(-otter)
        cat = turtle.size
        if cat <= 0:
            continue
        salmon = int(max(1, lam * cat))
        lion = int(max(1, lam * cat))
        frog = panda[turtle[:salmon]]
        tiger = panda[turtle[-lion:]]
        frog = frog[np.isfinite(frog)]
        tiger = tiger[np.isfinite(tiger)]
        if frog.size == 0 or tiger.size == 0:
            continue
        alpaca = float(np.mean(frog) - np.mean(tiger))
        if np.isfinite(alpaca):
            whale[wolf] = alpaca
    return _make_factor_series(whale, date, universe=universe, name='factor1365')

def factor1366(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1366')

def factor1367(universe, date, K=20):
    _set_asof_date(date)
    panda = _to_date(date)
    tiger = _last_n_trade_days(panda, K + 1)
    if len(tiger) < K + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1367')
    tiger = [pd.to_datetime(dog).date() for dog in tiger]
    lion = tiger[1:]
    turtle = tiger[0]
    fox = tiger[-1]
    frog = list(universe)
    koala = get_price(frog, start_date=turtle, end_date=fox, frequency='daily', fields=['open', 'high', 'low'], fq='post', panel=False)
    if koala is None or koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1367')
    koala = koala.copy()
    if 'time' in koala.columns:
        koala['date'] = pd.to_datetime(koala['time']).dt.date
    else:
        koala['date'] = pd.to_datetime(koala.index).date
    if 'code' not in koala.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1367')
    koala = koala[koala['date'].isin(lion)]
    if koala.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1367')
    sparrow = koala.pivot_table(index='date', columns='code', values='open', aggfunc='last').reindex(lion)
    rabbit = koala.pivot_table(index='date', columns='code', values='high', aggfunc='last').reindex(lion)
    whale = koala.pivot_table(index='date', columns='code', values='low', aggfunc='last').reindex(lion)
    dolphin = math.log(2.0)
    wolf = {}
    for cat in sparrow.columns:
        hawk = sparrow[cat].astype(float).values
        bear = rabbit[cat].astype(float).values
        zebra = whale[cat].astype(float).values
        eagle = np.isfinite(hawk) & np.isfinite(bear) & np.isfinite(zebra) & (hawk > 0) & (bear > 0) & (zebra > 0)
        if eagle.sum() < max(5, K // 2):
            continue
        giraffe = np.log(bear[eagle] / hawk[eagle])
        shark = np.log(zebra[eagle] / hawk[eagle])
        otter = giraffe - shark
        lizard = float(np.sum(otter ** 2))
        if not np.isfinite(lizard) or lizard <= 0:
            continue
        owl = float(math.sqrt(252.0 / (4.0 * dolphin * float(K)) * lizard))
        if np.isfinite(owl):
            wolf[cat] = owl
    return _make_factor_series(wolf, date, universe=universe, name='factor1367')

def factor1368(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1368')

def factor1369(universe, date, window=20, freq='1m', chunk_size=120):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = _last_n_trade_days(fox, window)
    if len(wolf) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1369')
    wolf = [pd.to_datetime(lion).date() for lion in wolf]
    turtle = wolf[0]
    giraffe = wolf[-1]
    frog = list(universe)
    rabbit = get_fundamentals(query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(frog)), date=fox)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1369')
    dog = pd.Series(rabbit['circulating_cap'].values, index=rabbit['code'].values).astype(float)
    dolphin = (dog * 10000.0).where(np.isfinite(dog) & (dog > 0), np.nan).to_dict()

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    otter = {panda: [] for panda in frog}
    for tiger in _chunks(frog, chunk_size):
        bear = get_price(tiger, start_date=turtle, end_date=giraffe + dt.timedelta(days=1), frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        if 'time' in bear.columns:
            bear['time'] = pd.to_datetime(bear['time'])
            bear['date'] = bear['time'].dt.date
        else:
            bear['time'] = pd.to_datetime(bear.index)
            bear['date'] = bear['time'].dt.date
        if 'code' not in bear.columns:
            if len(tiger) == 1:
                bear['code'] = tiger[0]
            else:
                continue
        bear = bear[bear['date'].isin(wolf)]
        if bear.empty:
            continue
        bear = bear[['code', 'date', 'time', 'close', 'volume']].dropna(subset=['close', 'volume'])
        bear['close'] = bear['close'].astype(float)
        bear['volume'] = bear['volume'].astype(float)
        bear = bear[np.isfinite(bear['close'].values) & np.isfinite(bear['volume'].values)]
        if bear.empty:
            continue
        bear = bear.sort_values(['code', 'date', 'time'])
        for (panda, koala), shark in bear.groupby(['code', 'date'], sort=False):
            whale = dolphin.get(panda, np.nan)
            if not (np.isfinite(whale) and whale > 0):
                continue
            cat = shark['close'].values.astype(float)
            salmon = shark['volume'].values.astype(float)
            if cat.size < 10:
                continue
            hawk = float(np.mean(cat))
            if not np.isfinite(hawk):
                continue
            lizard = float(np.sum(salmon[cat < hawk]))
            owl = float(np.sum(salmon[cat > hawk]))
            sparrow = (lizard - owl) / float(whale)
            if np.isfinite(sparrow):
                otter[panda].append(float(sparrow))
    zebra = {}
    for panda, eagle in otter.items():
        if not eagle:
            continue
        tuna = float(np.mean(np.asarray(eagle, dtype=float)))
        if np.isfinite(tuna):
            zebra[panda] = tuna
    return _make_factor_series(zebra, date, universe=universe, name='factor1369')

def factor1370(universe, date):
    _set_asof_date(date)
    otter = _to_date(date)
    eagle = list(universe)
    wolf = get_history_fundamentals(security=eagle, fields=[bear.term_087], watch_date=otter, count=5, interval='1q', stat_by_year=False)
    fox = get_history_fundamentals(security=eagle, fields=[fox.term_083], watch_date=otter, count=5, interval='1q', stat_by_year=False)
    if wolf is None or wolf.empty or fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1370')
    wolf = wolf.copy()
    fox = fox.copy()
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    wolf = wolf.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    fox = fox.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    zebra = wolf.groupby('code', sort=False).tail(5)
    panda = fox.groupby('code', sort=False).tail(5)
    koala = zebra.groupby('code', sort=False)['term_087'].last().astype(float)
    dolphin = panda.groupby('code', sort=False)['term_083'].first().astype(float)
    bear = pd.DataFrame({'cost_t': koala, 'liab_prev': dolphin}).dropna()
    if bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1370')
    whale = np.isfinite(bear['cost_t'].values) & np.isfinite(bear['liab_prev'].values) & (bear['cost_t'].values > 0) & (bear['liab_prev'].values > 0)
    bear = bear.loc[whale]
    if bear.shape[0] < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1370')
    sparrow = np.log(bear['cost_t'].values.astype(float))
    hawk = np.log(bear['liab_prev'].values.astype(float))
    cat = np.column_stack([np.ones_like(hawk), hawk])
    try:
        tiger, dog, dog, dog = np.linalg.lstsq(cat, sparrow, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1370')
    shark = sparrow - cat.dot(tiger)
    giraffe = {lion: float(rabbit) for lion, rabbit in zip(bear.index.values, shark) if np.isfinite(rabbit)}
    return _make_factor_series(giraffe, date, universe=universe, name='factor1370')

def factor1371(universe, date, n=20, freq='5m', chunk_size=200):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, n)
    if len(koala) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1371')
    koala = [pd.to_datetime(panda).date() for panda in koala]
    sparrow = koala[0]
    fox = koala[-1]
    owl = list(universe)

    def _chunks(seq, n_):
        for cat in range(0, len(seq), n_):
            yield seq[cat:cat + n_]
    shark = {cat: [] for cat in owl}
    for dog in _chunks(owl, chunk_size):
        otter = get_price(dog, start_date=sparrow, end_date=fox + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if otter is None or otter.empty:
            continue
        otter = otter.copy()
        if 'time' in otter.columns:
            otter['time'] = pd.to_datetime(otter['time'])
            otter['date'] = otter['time'].dt.date
        else:
            otter['time'] = pd.to_datetime(otter.index)
            otter['date'] = otter['time'].dt.date
        if 'code' not in otter.columns:
            if len(dog) == 1:
                otter['code'] = dog[0]
            else:
                continue
        otter = otter[otter['date'].isin(koala)]
        if otter.empty:
            continue
        otter = otter[['code', 'date', 'time', 'close']].dropna(subset=['close'])
        otter['close'] = otter['close'].astype(float)
        otter = otter[np.isfinite(otter['close'].values)]
        if otter.empty:
            continue
        otter = otter.sort_values(['code', 'date', 'time'])
        for (cat, tiger), bear in otter.groupby(['code', 'date'], sort=False):
            zebra = bear['close'].values.astype(float)
            if zebra.size < 3 or np.any(~np.isfinite(zebra)):
                continue
            dolphin = zebra[1:] / zebra[:-1] - 1.0
            dolphin = dolphin[np.isfinite(dolphin)]
            if dolphin.size > 0:
                shark[cat].append(dolphin)
    wolf = {}
    for cat, rabbit in shark.items():
        if not rabbit:
            continue
        whale = np.concatenate(rabbit)
        whale = whale[np.isfinite(whale)]
        if whale.size < 20:
            continue
        giraffe = float(np.mean(whale))
        eagle = float(np.std(whale, ddof=1))
        if not np.isfinite(eagle) or eagle <= 0:
            continue
        turtle = (whale - giraffe) / eagle
        hawk = float(np.mean(turtle ** 3))
        if np.isfinite(hawk):
            wolf[cat] = hawk
    return _make_factor_series(wolf, date, universe=universe, name='factor1371')

def factor1372(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1372')

def factor1373(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1373')

def factor1374(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1374')

def factor1375(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1375')

def factor1376(universe, date, K_short=20, K_long=120):
    _set_asof_date(date)
    koala = _to_date(date)
    cat = max(K_long, K_short)
    otter = _last_n_trade_days(koala, cat)
    if len(otter) < cat:
        return _make_factor_series({}, date, universe=universe, name='factor1376')
    otter = [pd.to_datetime(lion).date() for lion in otter]
    turtle = otter[0]
    rabbit = otter[-1]
    salmon = list(universe)
    fox = get_price(salmon, start_date=turtle, end_date=rabbit, frequency='daily', fields=['high', 'low', 'money'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1376')
    fox = fox.copy()
    if 'time' in fox.columns:
        fox['date'] = pd.to_datetime(fox['time']).dt.date
    else:
        fox['date'] = pd.to_datetime(fox.index).date
    if 'code' not in fox.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1376')
    fox = fox[fox['date'].isin(otter)]
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1376')
    dolphin = fox.pivot_table(index='date', columns='code', values='high', aggfunc='last').reindex(otter)
    shark = fox.pivot_table(index='date', columns='code', values='low', aggfunc='last').reindex(otter)
    hawk = fox.pivot_table(index='date', columns='code', values='money', aggfunc='last').reindex(otter)
    panda = 2.0 / (float(K_short) + 1.0)
    dog = 2.0 / (float(K_long) + 1.0)
    giraffe = {}
    for tiger in dolphin.columns:
        zebra = dolphin[tiger].astype(float).values
        whale = shark[tiger].astype(float).values
        eagle = hawk[tiger].astype(float).values
        owl = np.full_like(zebra, np.nan, dtype=float)
        sparrow = np.isfinite(zebra) & np.isfinite(whale) & np.isfinite(eagle) & (eagle > 0)
        owl[sparrow] = (zebra[sparrow] - whale[sparrow]) / eagle[sparrow]
        if np.isfinite(owl[-K_long:]).sum() < max(10, K_long // 2):
            continue
        bear = None
        wolf = None
        for tuna in owl:
            if not np.isfinite(tuna):
                continue
            bear = tuna if bear is None else panda * tuna + (1.0 - panda) * bear
            wolf = tuna if wolf is None else dog * tuna + (1.0 - dog) * wolf
        if bear is None or wolf is None:
            continue
        lizard = float(np.nanstd(owl[-K_long:], ddof=1))
        if not np.isfinite(lizard) or lizard <= 0:
            continue
        frog = (float(bear) - float(wolf)) / lizard
        if np.isfinite(frog):
            giraffe[tiger] = float(frog)
    return _make_factor_series(giraffe, date, universe=universe, name='factor1376')

def factor1377(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1377')

def factor1378(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1378')

def factor1379(universe, date, N=20, freq='5m'):
    _set_asof_date(date)
    eagle = _to_date(date)
    hawk = _last_n_trade_days(eagle, N)
    if len(hawk) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1379')
    hawk = [pd.to_datetime(whale).date() for whale in hawk]
    quail = hawk[0]
    tuna = hawk[-1] + dt.timedelta(days=1)
    seal = list(universe)
    turkey = set(seal)
    turtle = get_price(seal, start_date=quail, end_date=tuna, frequency=freq, fields=['close'], fq='post', panel=False)
    if turtle is None or turtle.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1379')
    turtle = turtle.copy()
    if 'time' in turtle.columns:
        turtle['time'] = pd.to_datetime(turtle['time'])
        turtle['date'] = turtle['time'].dt.date
    else:
        turtle['time'] = pd.to_datetime(turtle.index)
        turtle['date'] = turtle['time'].dt.date
    if 'code' not in turtle.columns:
        if len(seal) == 1:
            turtle['code'] = seal[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1379')
    turtle = turtle[turtle['date'].isin(hawk)]
    if turtle.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1379')
    turtle = turtle[['code', 'date', 'time', 'close']].dropna(subset=['close'])
    turtle['close'] = turtle['close'].astype(float)
    turtle = turtle[np.isfinite(turtle['close'].values)]
    if turtle.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1379')
    turtle = turtle.sort_values(['date', 'code', 'time'])
    salmon = {rabbit: [] for rabbit in seal}
    for shark, lizard in turtle.groupby('date', sort=False):
        if shark not in set(hawk):
            continue
        panda = {}
        dog = {}
        for rabbit, badger in lizard.groupby('code', sort=False):
            if rabbit not in turkey:
                continue
            badger = badger.sort_values('time')
            jaguar = badger['close'].values.astype(float)
            if jaguar.size < 11 or np.any(~np.isfinite(jaguar)):
                continue
            llama = jaguar[1:] / jaguar[:-1] - 1.0
            koala = llama.size
            if koala < 10:
                continue
            raccoon = np.linspace(0.0, 1.0, koala)
            kangaroo = np.where(llama > 0)[0]
            if kangaroo.size > 0:
                narwhal = llama[kangaroo]
                iguana = np.argsort(-narwhal)
                penguin = kangaroo[iguana[:min(17, iguana.size)]]
                lion = llama[penguin]
                otter = raccoon[penguin]
                owl = float(np.sum(np.abs(lion)))
                if owl > 0:
                    panda[rabbit] = float(np.sum(otter * lion) / owl)
            ferret = np.where(llama < 0)[0]
            if ferret.size > 0:
                mole = llama[ferret]
                hyena = np.argsort(np.abs(mole))[::-1]
                octopus = ferret[hyena[:min(17, hyena.size)]]
                tiger = llama[octopus]
                cat = raccoon[octopus]
                sparrow = float(np.sum(np.abs(tiger)))
                if sparrow > 0:
                    dog[rabbit] = float(np.sum(cat * tiger) / sparrow)
        giraffe = sorted(set(panda.keys()) & set(dog.keys()))
        if len(giraffe) < 5:
            continue
        walrus = np.array([panda[bear] for bear in giraffe], dtype=float)
        ant = np.array([dog[bear] for bear in giraffe], dtype=float)
        donkey = np.isfinite(walrus) & np.isfinite(ant)
        if donkey.sum() < 5:
            continue
        walrus = walrus[donkey]
        ant = ant[donkey]
        zebra = [giraffe[beaver] for beaver, gecko in enumerate(donkey) if gecko]
        yak = float(np.mean(walrus))
        bee = float(np.mean(ant))
        vulture = float(np.sum((walrus - yak) ** 2))
        if vulture <= 0 or not np.isfinite(vulture):
            continue
        dolphin = float(np.sum((walrus - yak) * (ant - bee)))
        wolf = dolphin / vulture
        fox = bee - wolf * yak
        alpaca = ant - (fox + wolf * walrus)
        for rabbit, frog in zip(zebra, alpaca):
            if np.isfinite(frog):
                salmon[rabbit].append(float(frog))
    lemur = {}
    for rabbit, camel in salmon.items():
        if not camel:
            continue
        urchin = float(np.mean(np.asarray(camel, dtype=float)))
        if np.isfinite(urchin):
            lemur[rabbit] = urchin
    return _make_factor_series(lemur, date, universe=universe, name='factor1379')

def factor1380(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1380')

def factor1381(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1381')

def factor1382(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    frog = pd.Period(fox, freq='M')
    jaguar = frog.year
    sparrow = frog.month
    alpaca = dt.date(jaguar, sparrow, 1)
    if sparrow == 12:
        lizard = dt.date(jaguar + 1, 1, 1)
    else:
        lizard = dt.date(jaguar, sparrow + 1, 1)
    zebra = lizard - dt.timedelta(days=1)
    bear = list(get_trade_days(start_date=alpaca, end_date=zebra))
    if not bear:
        return _make_factor_series({}, date, universe=universe, name='factor1382')
    wolf = [pd.to_datetime(otter).date() for otter in bear]
    lemur = list(universe)
    rabbit = get_price(lemur, start_date=alpaca, end_date=zebra, frequency='daily', fields=['close', 'pre_close', 'high_limit', 'low_limit', 'paused'], fq='post', panel=False)
    if rabbit is None or rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1382')
    rabbit = rabbit.copy()
    if 'time' in rabbit.columns:
        rabbit['date'] = pd.to_datetime(rabbit['time']).dt.date
    else:
        rabbit['date'] = pd.to_datetime(rabbit.index).date
    if 'code' not in rabbit.columns:
        if len(lemur) == 1:
            rabbit['code'] = lemur[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1382')
    rabbit = rabbit[rabbit['date'].isin(wolf)]
    if rabbit.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1382')
    rabbit = rabbit[['code', 'date', 'close', 'pre_close', 'high_limit', 'low_limit', 'paused']].copy()
    rabbit['paused'] = rabbit['paused'].astype(float)
    badger = rabbit['paused'] != 1.0
    tiger = rabbit['close'].astype(float)
    salmon = rabbit['pre_close'].astype(float)
    shark = rabbit['high_limit'].astype(float)
    eagle = rabbit['low_limit'].astype(float)
    badger = badger & np.isfinite(tiger) & np.isfinite(salmon) & np.isfinite(shark) & np.isfinite(eagle) & (salmon > 0)
    giraffe = rabbit[badger].copy()
    if giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1382')
    giraffe['ret'] = giraffe['close'].astype(float) / giraffe['pre_close'].astype(float) - 1.0
    giraffe['is_upper'] = (giraffe['close'].astype(float) >= giraffe['high_limit'].astype(float)).astype(int)
    giraffe['is_lower'] = (giraffe['close'].astype(float) <= giraffe['low_limit'].astype(float)).astype(int)
    whale = giraffe.groupby('date', sort=False)
    dog = whale.size().astype(float)
    turtle = whale['is_upper'].sum().astype(float)
    owl = whale['is_lower'].sum().astype(float)
    cat = (turtle + owl) / dog
    cat = cat.reindex(wolf)
    if cat.notna().sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1382')
    tuna = giraffe.pivot_table(index='date', columns='code', values='ret', aggfunc='last').reindex(wolf)
    dolphin = {}
    donkey = cat.values.astype(float)
    for lion in tuna.columns:
        hyena = tuna[lion].values.astype(float)
        hawk = np.isfinite(donkey) & np.isfinite(hyena)
        if hawk.sum() < 5:
            continue
        camel = donkey[hawk]
        gecko = hyena[hawk]
        ferret = float(np.mean(camel))
        iguana = float(np.mean(gecko))
        beaver = float(np.sum((camel - ferret) ** 2))
        if not np.isfinite(beaver) or beaver <= 0:
            continue
        koala = float(np.sum((camel - ferret) * (gecko - iguana)))
        panda = koala / beaver
        if np.isfinite(panda):
            dolphin[lion] = float(panda)
    return _make_factor_series(dolphin, date, universe=universe, name='factor1382')

def factor1383(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1383')

def factor1384(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1384')

def factor1385(universe, date, k_days=5, perc=0.9, freq='1m', batch_size=200):
    _set_asof_date(date)
    rabbit = _to_date(date)
    zebra = _last_n_trade_days(rabbit, k_days + 1)
    if len(zebra) < k_days + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1385')
    zebra = [pd.to_datetime(wolf).date() for wolf in zebra]
    owl = zebra[:-1]
    giraffe = zebra[-1]
    alpaca = list(universe)
    whale = get_fundamentals(query(giraffe.code, giraffe.circulating_cap).filter(giraffe.code.in_(alpaca)), date=rabbit)
    if whale is None or whale.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1385')
    koala = pd.Series(whale['circulating_cap'].values, index=whale['code'].values).astype(float)
    hawk = (koala * 10000.0).where(np.isfinite(koala) & (koala > 0), np.nan)
    donkey = []
    for bear in owl:
        for turtle in range(0, len(alpaca), max(1, int(batch_size))):
            tiger = alpaca[turtle:turtle + max(1, int(batch_size))]
            shark = get_price(tiger, start_date=bear, end_date=bear + dt.timedelta(days=1), frequency=freq, fields=['volume'], fq='post', panel=False)
            if shark is None or shark.empty:
                continue
            shark = shark.copy()
            lemur = shark['volume'].astype(float).values
            lemur = lemur[np.isfinite(lemur) & (lemur > 0)]
            if lemur.size > 0:
                donkey.append(lemur.astype(np.float32))
    if not donkey:
        return _make_factor_series({}, date, universe=universe, name='factor1385')
    camel = np.concatenate(donkey).astype(float)
    camel = camel[np.isfinite(camel) & (camel > 0)]
    if camel.size == 0:
        return _make_factor_series({}, date, universe=universe, name='factor1385')
    cat = float(np.quantile(camel, float(perc)))
    if not np.isfinite(cat):
        return _make_factor_series({}, date, universe=universe, name='factor1385')
    eagle = {}
    for turtle in range(0, len(alpaca), max(1, int(batch_size))):
        tiger = alpaca[turtle:turtle + max(1, int(batch_size))]
        dolphin = get_price(tiger, start_date=giraffe, end_date=giraffe + dt.timedelta(days=1), frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if dolphin is None or dolphin.empty:
            continue
        dolphin = dolphin.copy()
        if 'time' in dolphin.columns:
            dolphin['time'] = pd.to_datetime(dolphin['time'])
        else:
            dolphin['time'] = pd.to_datetime(dolphin.index)
        if 'code' not in dolphin.columns:
            if len(tiger) == 1:
                dolphin['code'] = tiger[0]
            else:
                continue
        dolphin = dolphin[['code', 'time', 'close', 'volume']].dropna(subset=['close', 'volume'])
        dolphin['close'] = dolphin['close'].astype(float)
        dolphin['volume'] = dolphin['volume'].astype(float)
        dolphin = dolphin[np.isfinite(dolphin['close'].values) & np.isfinite(dolphin['volume'].values)]
        if dolphin.empty:
            continue
        dolphin = dolphin.sort_values(['code', 'time'])
        for fox, salmon in dolphin.groupby('code', sort=False):
            sparrow = hawk.get(fox, np.nan)
            if not (np.isfinite(sparrow) and sparrow > 0):
                continue
            otter = salmon['close'].values.astype(float)
            beaver = salmon['volume'].values.astype(float)
            if otter.size < 10:
                continue
            tuna = beaver > cat
            if tuna.sum() < 3:
                continue
            lion = otter[tuna]
            badger = beaver[tuna]
            lizard = float(np.mean(lion))
            if not np.isfinite(lizard):
                continue
            panda = float(np.sum(badger[lion < lizard]))
            dog = float(np.sum(badger[lion > lizard]))
            frog = (panda - dog) / float(sparrow)
            if np.isfinite(frog):
                eagle[fox] = float(frog)
    return _make_factor_series(eagle, date, universe=universe, name='factor1385')

def factor1386(universe, date, window=20, freq='1m', chunk_size=120, sample_peers=200, seed=7, ridge=1e-08, scale=1000000.0):
    _set_asof_date(date)
    camel = _to_date(date)
    pizza = int(window)
    if pizza < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1386')
    gecko = _last_n_trade_days(camel, pizza)
    if len(gecko) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1386')
    ferret = [pd.to_datetime(badger).date() for badger in gecko]
    sheep = ferret[0]
    mole = ferret[-1] + dt.timedelta(days=1)
    weasel = list(universe)
    if not weasel:
        return _make_factor_series({}, date, universe=universe, name='factor1386')
    donkey = {badger: quail for quail, badger in enumerate(ferret)}
    tuna = {owl: quail for quail, owl in enumerate(weasel)}
    bear = np.full((len(weasel), len(ferret)), np.nan, dtype=np.float32)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    for alpaca in _chunks(weasel, int(chunk_size)):
        jaguar = get_price(security=alpaca, start_date=sheep, end_date=mole, frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if jaguar is None or jaguar.empty:
            continue
        jaguar = jaguar.copy()
        if 'time' not in jaguar.columns:
            jaguar = jaguar.reset_index().rename(columns={'index': 'time'})
        if 'code' not in jaguar.columns:
            if len(alpaca) == 1:
                jaguar['code'] = alpaca[0]
            else:
                continue
        jaguar['time'] = pd.to_datetime(jaguar['time'])
        jaguar['date'] = jaguar['time'].dt.date
        jaguar = jaguar[jaguar['date'].isin(ferret)]
        if jaguar.empty:
            continue
        jaguar['close'] = pd.to_numeric(jaguar['close'], errors='coerce').astype(float)
        jaguar['volume'] = pd.to_numeric(jaguar['volume'], errors='coerce').astype(float)
        jaguar = jaguar.dropna(subset=['close', 'volume'])
        jaguar = jaguar[np.isfinite(jaguar['close'].values) & (jaguar['close'].values > 0) & np.isfinite(jaguar['volume'].values)]
        if jaguar.empty:
            continue
        jaguar = jaguar.sort_values(['code', 'date', 'time'])
        for (salmon, beaver), penguin in jaguar.groupby(['code', 'date'], sort=False):
            if salmon not in tuna or beaver not in donkey:
                continue
            owl = penguin['close'].values.astype(float)
            apple = penguin['volume'].values.astype(float)
            if owl.size < 40 or apple.size != owl.size:
                continue
            if np.any(~np.isfinite(owl)) or np.any(~np.isfinite(apple)):
                continue
            mink = owl[1:] / owl[:-1] - 1.0
            donut = (apple[1:] - apple[:-1]) / float(scale)
            koala = int(mink.size)
            if koala <= 12:
                continue
            raccoon = np.arange(5, koala)
            sushi = mink[raccoon]
            fox = [donut[raccoon - urchin] for urchin in range(0, 6)]
            otter = np.column_stack([np.ones_like(sushi)] + fox)
            walrus = np.isfinite(sushi) & np.all(np.isfinite(otter), axis=1)
            if walrus.sum() < 15:
                continue
            sushi = sushi[walrus]
            otter = otter[walrus, :]
            crab, turkey = otter.shape
            kangaroo = crab - turkey
            if kangaroo <= 0:
                continue
            try:
                sparrow, eagle, eagle, eagle = np.linalg.lstsq(otter, sushi, rcond=None)
            except Exception:
                continue
            horse = sushi - otter.dot(sparrow)
            lion = float(np.sum(horse ** 2))
            if not np.isfinite(lion) or lion <= 0:
                continue
            pig = lion / float(kangaroo)
            rabbit = otter.T.dot(otter)
            try:
                giraffe = np.linalg.inv(rabbit + float(ridge) * np.eye(turkey))
            except Exception:
                continue
            newt = float(np.sqrt(max(giraffe[0, 0] * pig, 0.0)))
            if not np.isfinite(newt) or newt <= 0:
                continue
            toad = float(sparrow[0] / newt)
            if np.isfinite(toad):
                bear[tuna[salmon], donkey[beaver]] = np.float32(toad)
    octopus = np.isfinite(bear)
    lizard = octopus.sum(axis=1)
    bee = max(5, pizza // 2)
    carrot = np.where(lizard >= bee)[0]
    if carrot.size < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1386')
    zebra = bear[carrot].astype(np.float32)
    tiger = np.isfinite(zebra).astype(np.int32)
    frog = tiger.sum(axis=1).astype(np.float32)
    swan = np.nansum(zebra, axis=1).astype(np.float32)
    yak = np.divide(swan, frog, out=np.zeros_like(swan), where=frog > 0)
    wolf = zebra - yak[:, None]
    wolf[~np.isfinite(wolf)] = 0.0
    rat = np.sum(wolf * wolf, axis=1).astype(np.float32)
    hyena = np.maximum(frog - 1.0, 1.0)
    stoat = np.sqrt(rat / hyena)
    stoat = np.where(np.isfinite(stoat) & (stoat > 0), stoat, 1.0).astype(np.float32)
    dolphin = (zebra - yak[:, None]) / stoat[:, None]
    dolphin[~np.isfinite(dolphin)] = 0.0
    mouse = np.random.RandomState(int(seed))
    cat = int(carrot.size)
    goat = int(max(10, sample_peers))
    ant = int(bee)
    hawk = np.full(cat, np.nan, dtype=float)
    for quail in range(cat):
        if cat <= 1:
            continue
        if cat - 1 <= goat:
            elk = [seal for seal in range(cat) if seal != quail]
        else:
            turtle = mouse.choice(np.array([seal for seal in range(cat) if seal != quail], dtype=int), size=goat, replace=False)
            elk = turtle.tolist()
        whale = dolphin[quail].astype(np.float32)
        dog = tiger[quail].astype(np.int32)
        shark = dolphin[elk].astype(np.float32)
        panda = tiger[elk].astype(np.int32)
        deer = (panda * dog[None, :]).sum(axis=1).astype(np.int32)
        llama = (shark @ whale).astype(np.float32)
        iguana = np.maximum(deer - 1, 1).astype(np.float32)
        lemur = llama / iguana
        lemur = np.where(deer >= ant, lemur, np.nan)
        lemur = np.abs(lemur.astype(float))
        lemur = lemur[np.isfinite(lemur)]
        if lemur.size == 0:
            continue
        hawk[quail] = float(np.mean(lemur))
    narwhal = {}
    for vulture, banana in enumerate(hawk):
        if not np.isfinite(banana):
            continue
        salmon = weasel[int(carrot[vulture])]
        narwhal[salmon] = float(banana)
    return _make_factor_series(narwhal, date, universe=universe, name='factor1386')

def factor1387(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1387')

def factor1388(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1388')

def factor1389(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1389')

def factor1390(universe, date):
    _set_asof_date(date)
    fox = _to_date(date)
    frog = list(universe)
    bear = get_history_fundamentals(security=frog, fields=[fox.surplus_reserve_fund], watch_date=fox, count=6, interval='1q', stat_by_year=False)
    wolf = get_history_fundamentals(security=frog, fields=[bear.term_021], watch_date=fox, count=6, interval='1q', stat_by_year=False)
    if bear is None or bear.empty or wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1390')
    bear = bear.copy()
    wolf = wolf.copy()
    bear['statDate'] = pd.to_datetime(bear['statDate'])
    wolf['statDate'] = pd.to_datetime(wolf['statDate'])
    bear = bear.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    wolf = wolf.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    lizard = bear.groupby('code', sort=False).tail(6).groupby('code', sort=False)['surplus_reserve_fund'].last().astype(float)
    shark = wolf.groupby('code', sort=False).tail(6).copy()
    whale = shark.groupby('code', sort=False).head(2)
    if whale.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1390')
    hawk = whale.groupby('code', sort=False)['term_021'].first().astype(float)
    eagle = whale.groupby('code', sort=False)['term_021'].last().astype(float)
    sparrow = (eagle - hawk).astype(float)
    rabbit = pd.DataFrame({'SR_t': lizard, 'INT_q': sparrow}).dropna()
    if rabbit.empty or rabbit.shape[0] < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1390')
    zebra = 1e-06
    dog = np.abs(rabbit['SR_t'].values.astype(float))
    cat = np.abs(rabbit['INT_q'].values.astype(float))
    tuna = np.log(dog + zebra)
    salmon = np.log(cat + zebra)
    owl = np.isfinite(tuna) & np.isfinite(salmon)
    if owl.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1390')
    tuna = tuna[owl]
    salmon = salmon[owl]
    otter = rabbit.index.values[owl]
    panda = np.column_stack([np.ones_like(salmon), salmon])
    try:
        lion, tiger, tiger, tiger = np.linalg.lstsq(panda, tuna, rcond=None)
    except np.linalg.LinAlgError:
        return _make_factor_series({}, date, universe=universe, name='factor1390')
    turtle = tuna - panda.dot(lion)
    dolphin = {koala: float(giraffe) for koala, giraffe in zip(otter, turtle) if np.isfinite(giraffe)}
    return _make_factor_series(dolphin, date, universe=universe, name='factor1390')

def factor1391(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1391')

def factor1392(universe, date, window=20, freq='1m', chunk_size=120):
    _set_asof_date(date)
    fox = _to_date(date)
    bear = _last_n_trade_days(fox, window)
    if len(bear) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1392')
    bear = [pd.to_datetime(koala).date() for koala in bear]
    owl = bear[0]
    zebra = bear[-1]
    turtle = list(universe)
    tuna = (np.arange(1, len(bear) + 1, dtype=float) / float(len(bear))).astype(float)
    wolf = {koala: float(alpaca) for koala, alpaca in zip(bear, tuna)}

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    hawk = {}
    for lion in _chunks(turtle, chunk_size):
        giraffe = get_price(lion, start_date=owl, end_date=zebra + dt.timedelta(days=1), frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' in giraffe.columns:
            giraffe['time'] = pd.to_datetime(giraffe['time'])
            giraffe['date'] = giraffe['time'].dt.date
        else:
            giraffe['time'] = pd.to_datetime(giraffe.index)
            giraffe['date'] = giraffe['time'].dt.date
        if 'code' not in giraffe.columns:
            if len(lion) == 1:
                giraffe['code'] = lion[0]
            else:
                continue
        giraffe = giraffe[giraffe['date'].isin(bear)]
        if giraffe.empty:
            continue
        giraffe = giraffe[['code', 'date', 'time', 'close', 'volume']].dropna(subset=['close', 'volume'])
        giraffe['close'] = giraffe['close'].astype(float)
        giraffe['volume'] = giraffe['volume'].astype(float)
        giraffe = giraffe[np.isfinite(giraffe['close'].values) & np.isfinite(giraffe['volume'].values)]
        if giraffe.empty:
            continue
        giraffe = giraffe.sort_values(['code', 'date', 'time'])
        for (tiger, otter), whale in giraffe.groupby(['code', 'date'], sort=False):
            dog = whale['close'].values.astype(float)
            lizard = whale['volume'].values.astype(float)
            if dog.size < 5 or lizard.size != dog.size:
                continue
            sparrow = dog[1:] / dog[:-1] - 1.0
            salmon = lizard[1:]
            shark = np.isfinite(sparrow) & np.isfinite(salmon)
            if shark.sum() < 3:
                continue
            cat = float(np.sum(sparrow[shark] * salmon[shark]))
            if np.isfinite(cat):
                hawk[tiger, otter] = cat
    dolphin = {}
    for tiger in turtle:
        eagle = 0.0
        rabbit = 0.0
        panda = 0
        for otter in bear:
            lizard = hawk.get((tiger, otter), np.nan)
            if not np.isfinite(lizard):
                continue
            alpaca = wolf[otter]
            eagle += alpaca * float(lizard)
            rabbit += alpaca
            panda += 1
        if panda < 5 or rabbit <= 0:
            continue
        frog = eagle / rabbit
        if np.isfinite(frog):
            dolphin[tiger] = float(frog)
    return _make_factor_series(dolphin, date, universe=universe, name='factor1392')

def factor1393(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1393')

def factor1394(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1394')

def factor1395(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1395')

def factor1396(universe, date, K=20):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, K)
    if len(koala) < K:
        return _make_factor_series({}, date, universe=universe, name='factor1396')
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    dolphin = koala[0]
    fox = koala[-1]
    whale = list(universe)
    otter = get_price(whale, start_date=dolphin, end_date=fox, frequency='daily', fields=['open', 'close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1396')
    otter = otter.copy()
    if 'time' in otter.columns:
        otter['date'] = pd.to_datetime(otter['time']).dt.date
    else:
        otter['date'] = pd.to_datetime(otter.index).date
    if 'code' not in otter.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1396')
    otter = otter[otter['date'].isin(koala)]
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1396')
    zebra = otter.pivot_table(index='date', columns='code', values='open', aggfunc='last').reindex(koala)
    dog = otter.pivot_table(index='date', columns='code', values='close', aggfunc='last').reindex(koala)
    wolf = {}
    for panda in zebra.columns:
        giraffe = zebra[panda].astype(float).values
        cat = dog[panda].astype(float).values
        rabbit = np.isfinite(giraffe) & np.isfinite(cat) & (giraffe > 0)
        if rabbit.sum() < max(5, K // 2):
            continue
        bear = (cat[rabbit] - giraffe[rabbit]) / giraffe[rabbit]
        if bear.size < max(5, K // 2):
            continue
        shark = float(np.mean(bear[-K:])) if bear.size >= K else float(np.mean(bear))
        if np.isfinite(shark):
            wolf[panda] = shark
    return _make_factor_series(wolf, date, universe=universe, name='factor1396')

def factor1397(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1397')

def factor1398(universe, date, window=20, freq='1m', batch_size=200):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = _last_n_trade_days(fox, window)
    if len(wolf) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1398')
    wolf = [pd.to_datetime(otter).date() for otter in wolf]
    alpaca = list(universe)
    tuna = wolf[0]
    zebra = wolf[-1]
    bear = get_price(alpaca, start_date=tuna, end_date=zebra, frequency='daily', fields=['high', 'low', 'pre_close'], fq='post', panel=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1398')
    bear = bear.copy()
    if 'time' in bear.columns:
        bear['date'] = pd.to_datetime(bear['time']).dt.date
    else:
        bear['date'] = pd.to_datetime(bear.index).date
    if 'code' not in bear.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1398')
    bear = bear[bear['date'].isin(wolf)]
    if bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1398')
    bear['high'] = bear['high'].astype(float)
    bear['low'] = bear['low'].astype(float)
    bear['pre_close'] = bear['pre_close'].astype(float)
    with np.errstate(divide='ignore', invalid='ignore'):
        bear['range'] = (bear['high'] - bear['low']) / bear['pre_close']
    bear.loc[~np.isfinite(bear['range']) | (bear['pre_close'] <= 0), 'range'] = np.nan
    frog = bear.pivot_table(index='date', columns='code', values='range', aggfunc='last').reindex(wolf).reindex(columns=alpaca)
    hawk = []
    for eagle in range(0, len(alpaca), max(1, int(batch_size))):
        lion = alpaca[eagle:eagle + max(1, int(batch_size))]
        rabbit = get_price(lion, start_date=tuna, end_date=zebra + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if rabbit is None or rabbit.empty:
            continue
        rabbit = rabbit.copy()
        if 'time' in rabbit.columns:
            rabbit['time'] = pd.to_datetime(rabbit['time'])
            rabbit['date'] = rabbit['time'].dt.date
        else:
            rabbit['time'] = pd.to_datetime(rabbit.index)
            rabbit['date'] = rabbit['time'].dt.date
        if 'code' not in rabbit.columns:
            if len(lion) == 1:
                rabbit['code'] = lion[0]
            else:
                continue
        rabbit = rabbit[rabbit['date'].isin(wolf)]
        if rabbit.empty:
            continue
        rabbit = rabbit[['code', 'date', 'time', 'close']].dropna(subset=['close'])
        rabbit['close'] = rabbit['close'].astype(float)
        rabbit = rabbit[np.isfinite(rabbit['close'].values)]
        if rabbit.empty:
            continue
        rabbit = rabbit.sort_values(['code', 'date', 'time'])
        rabbit['prev_close'] = rabbit.groupby(['code', 'date'], sort=False)['close'].shift(1)
        with np.errstate(divide='ignore', invalid='ignore'):
            salmon = rabbit['close'] / rabbit['prev_close']
        salmon = salmon.replace([np.inf, -np.inf], np.nan)
        with np.errstate(divide='ignore', invalid='ignore'):
            lizard = salmon - 1.0
            turtle = np.log(salmon)
        giraffe = lizard - turtle
        sparrow = giraffe * 2.0 - turtle ** 2
        rabbit['jump'] = sparrow.replace([np.inf, -np.inf], np.nan)
        tiger = rabbit.groupby(['code', 'date'], sort=False)['jump'].agg(['count', 'mean']).reset_index()
        tiger = tiger.rename(columns={'count': 'n_jump', 'mean': 'J'})
        tiger.loc[(tiger['n_jump'] < 3) | ~np.isfinite(tiger['J']), 'J'] = np.nan
        tiger = tiger.dropna(subset=['J'])
        if not tiger.empty:
            hawk.append(tiger[['code', 'date', 'J']])
    if len(hawk) == 0:
        return _make_factor_series({}, date, universe=universe, name='factor1398')
    cat = pd.concat(hawk, ignore_index=True)
    panda = cat.pivot_table(index='date', columns='code', values='J', aggfunc='last').reindex(wolf).reindex(columns=alpaca)
    dog = panda.mean(axis=1, skipna=True)
    owl = panda.lt(dog, axis=0)
    shark = frog.where(~owl, -frog)
    shark = shark.where(panda.notna(), np.nan)
    dolphin = shark.mean(axis=0, skipna=True)
    whale = {}
    for koala in alpaca:
        lemur = dolphin.get(koala, np.nan)
        whale[koala] = float(lemur) if np.isfinite(lemur) else np.nan
    return _make_factor_series(whale, date, universe=universe, name='factor1398')

def factor1399(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1399')

def factor1400(universe, date, K=239, eps=1e-06):
    _set_asof_date(date)
    koala = _to_date(date)
    otter = _last_n_trade_days(koala, K + 1)
    if len(otter) < K + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1400')
    otter = [pd.to_datetime(lion).date() for lion in otter]
    hawk = otter[0]
    wolf = otter[-1]
    sparrow = list(universe)
    fox = get_price(sparrow, start_date=hawk, end_date=wolf, frequency='daily', fields=['high', 'low', 'volume'], fq='post', panel=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1400')
    fox = fox.copy()
    if 'time' in fox.columns:
        fox['date'] = pd.to_datetime(fox['time']).dt.date
    else:
        fox['date'] = pd.to_datetime(fox.index).date
    if 'code' not in fox.columns:
        return _make_factor_series({}, date, universe=universe, name='factor1400')
    fox = fox[fox['date'].isin(otter)]
    if fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1400')
    giraffe = fox.pivot_table(index='date', columns='code', values='high', aggfunc='last').reindex(otter)
    whale = fox.pivot_table(index='date', columns='code', values='low', aggfunc='last').reindex(otter)
    frog = fox.pivot_table(index='date', columns='code', values='volume', aggfunc='last').reindex(otter)
    bear = {}
    for tiger in giraffe.columns:
        rabbit = giraffe[tiger].astype(float).values
        dolphin = whale[tiger].astype(float).values
        owl = frog[tiger].astype(float).values
        panda = np.isfinite(rabbit) & np.isfinite(dolphin) & np.isfinite(owl)
        if panda.sum() < max(20, (K + 1) // 2):
            continue
        zebra = rabbit + dolphin
        cat = (zebra[1:] - zebra[:-1]) / 2.0
        eagle = rabbit[1:] - dolphin[1:]
        eagle = np.where(np.isfinite(eagle), np.maximum(eagle, float(eps)), np.nan)
        lizard = owl[1:]
        dog = np.full_like(cat, np.nan, dtype=float)
        shark = np.isfinite(cat) & np.isfinite(eagle) & np.isfinite(lizard) & (lizard > 0)
        dog[shark] = cat[shark] * eagle[shark] / lizard[shark]
        dog = dog[np.isfinite(dog)]
        if dog.size < max(30, K // 2):
            continue
        turtle = float(np.mean(dog[-K:])) if dog.size >= K else float(np.mean(dog))
        if np.isfinite(turtle):
            bear[tiger] = turtle
    return _make_factor_series(bear, date, universe=universe, name='factor1400')

def factor1401(universe, date, min_obs=5, x_scale=100000000.0):
    _set_asof_date(date)
    otter = _to_date(date)
    hawk = pd.Period(otter, freq='M')
    beaver, shark = (hawk.year, hawk.month)
    turtle = dt.date(beaver, shark, 1)
    eagle = dt.date(beaver + 1, 1, 1) if shark == 12 else dt.date(beaver, shark + 1, 1)
    rabbit = eagle - dt.timedelta(days=1)
    wolf = list(get_trade_days(start_date=turtle, end_date=rabbit))
    if not wolf:
        return _make_factor_series({}, date, universe=universe, name='factor1401')
    fox = [pd.to_datetime(koala).date() for koala in wolf]
    lizard = list(universe)
    bear = get_price(lizard, start_date=turtle, end_date=rabbit, frequency='daily', fields=['close', 'pre_close', 'money'], fq='post', panel=False)
    if bear is None or bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1401')
    bear = bear.copy()
    if 'time' not in bear.columns:
        bear['time'] = bear.index
    bear['time'] = pd.to_datetime(bear['time'])
    bear['date'] = bear['time'].dt.date
    if 'code' not in bear.columns:
        if len(lizard) == 1:
            bear['code'] = lizard[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1401')
    bear = bear[bear['date'].isin(fox)]
    if bear.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1401')
    panda = bear.pivot_table(index='date', columns='code', values='close', aggfunc='last').reindex(fox)
    sparrow = bear.pivot_table(index='date', columns='code', values='pre_close', aggfunc='last').reindex(fox)
    whale = bear.pivot_table(index='date', columns='code', values='money', aggfunc='last').reindex(fox)
    with np.errstate(divide='ignore', invalid='ignore'):
        owl = panda.astype(float) / sparrow.astype(float) - 1.0
    owl = owl.replace([np.inf, -np.inf], np.nan)
    dolphin = whale.astype(float).replace([np.inf, -np.inf], np.nan).fillna(0.0).sum(axis=1)
    dolphin = dolphin.reindex(fox).astype(float)
    dolphin = dolphin.replace([np.inf, -np.inf], np.nan)
    salmon = dolphin.values.astype(float)
    tuna = np.isfinite(salmon)
    if tuna.sum() < min_obs:
        return _make_factor_series({}, date, universe=universe, name='factor1401')
    alpaca = salmon / float(x_scale)
    giraffe = {}
    for tiger in owl.columns:
        badger = owl[tiger].values.astype(float)
        zebra = np.isfinite(badger) & np.isfinite(alpaca)
        if zebra.sum() < min_obs:
            continue
        lemur = alpaca[zebra]
        camel = badger[zebra]
        frog = float(np.sum((lemur - lemur.mean()) ** 2))
        if not np.isfinite(frog) or frog <= 0:
            continue
        lion = float(np.sum((lemur - lemur.mean()) * (camel - camel.mean())))
        dog = lion / frog
        cat = float(dog) / float(x_scale)
        if np.isfinite(cat):
            giraffe[tiger] = float(abs(cat))
    return _make_factor_series(giraffe, date, universe=universe, name='factor1401')

def factor1402(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1402')

def factor1403(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1403')

def factor1404(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1404')

def factor1405(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1405')

def factor1406(universe, date, freq='1m', chunk_size=300):
    _set_asof_date(date)
    tiger = _to_date(date)
    shark = list(universe)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    otter = {}
    for panda in _chunks(shark, chunk_size):
        lion = get_price(panda, start_date=tiger, end_date=tiger + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if lion is None or lion.empty:
            continue
        lion = lion.copy()
        if 'time' not in lion.columns:
            lion['time'] = lion.index
        lion['time'] = pd.to_datetime(lion['time'])
        if 'code' not in lion.columns:
            if len(panda) == 1:
                lion['code'] = panda[0]
            else:
                continue
        lion = lion[['code', 'time', 'close']].dropna(subset=['close'])
        lion['close'] = lion['close'].astype(float)
        lion = lion[np.isfinite(lion['close'].values)]
        if lion.empty:
            continue
        lion = lion.sort_values(['code', 'time'])
        lion['prev_close'] = lion.groupby('code', sort=False)['close'].shift(1)
        rabbit = lion['prev_close'].values.astype(float)
        cat = lion['close'].values.astype(float)
        bear = np.isfinite(rabbit) & np.isfinite(cat) & (rabbit > 0) & (cat > 0)
        dolphin = np.full_like(cat, np.nan, dtype=float)
        dolphin[bear] = cat[bear] / rabbit[bear]
        with np.errstate(divide='ignore', invalid='ignore'):
            zebra = dolphin - 1.0
            giraffe = np.log(dolphin)
        koala = zebra - giraffe
        wolf = 2.0 * koala - giraffe ** 2
        lion['jump'] = wolf
        fox = lion.groupby('code', sort=False)['jump'].agg(['count', 'mean'])
        for dog, whale in fox.iterrows():
            if int(whale['count']) < 3:
                continue
            eagle = float(whale['mean'])
            if np.isfinite(eagle):
                otter[dog] = eagle
    return _make_factor_series(otter, date, universe=universe, name='factor1406')

def factor1407(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1407')

def factor1408(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1408')

def factor1409(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1409')

def factor1410(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1410')

def factor1411(universe, date, min_stocks=5, eps0=1e-06):
    _set_asof_date(date)
    otter = _to_date(date)
    eagle = list(universe)
    fox = get_history_fundamentals(security=eagle, fields=[fox.term_075], watch_date=otter, count=6, interval='1q', stat_by_year=False)
    if fox is None or fox.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1411')
    fox = fox.copy()
    fox['statDate'] = pd.to_datetime(fox['statDate'])
    fox = fox.sort_values(['code', 'statDate']).drop_duplicates(['code', 'statDate'], keep='last')
    giraffe = fox.groupby('code', sort=False).tail(6)
    if giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1411')
    frog = {}
    owl = {}
    for tiger, rabbit in giraffe.groupby('code', sort=False):
        if rabbit.shape[0] < 6:
            continue
        shark = rabbit['term_075'].astype(float).values
        if np.any(~np.isfinite(shark)):
            continue
        zebra = shark[-1] - shark[-2]
        dolphin = shark[-5] - shark[-6]
        if not (np.isfinite(zebra) and np.isfinite(dolphin)):
            continue
        if abs(dolphin) < eps0:
            continue
        lizard = math.log(abs(zebra) + eps0)
        sparrow = math.log(abs(dolphin) + eps0)
        if np.isfinite(sparrow) and np.isfinite(lizard):
            frog[tiger] = lizard
            owl[tiger] = sparrow
    if len(owl) < min_stocks:
        return _make_factor_series({}, date, universe=universe, name='factor1411')
    lion = list(owl.keys())
    sparrow = np.array([owl[panda] for panda in lion], dtype=float)
    lizard = np.array([frog[panda] for panda in lion], dtype=float)
    turtle = float(np.mean(sparrow))
    salmon = float(np.mean(lizard))
    hawk = float(np.sum((sparrow - turtle) ** 2))
    if not np.isfinite(hawk) or hawk <= 0:
        return _make_factor_series({}, date, universe=universe, name='factor1411')
    koala = float(np.sum((sparrow - turtle) * (lizard - salmon)))
    dog = koala / hawk
    cat = salmon - dog * turtle
    whale = lizard - (cat + dog * sparrow)
    bear = {panda: float(wolf) for panda, wolf in zip(lion, whale) if np.isfinite(wolf)}
    return _make_factor_series(bear, date, universe=universe, name='factor1411')

def factor1412(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1412')

def factor1413(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1413')

def factor1414(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1414')

def factor1415(universe, date, m=20):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = _last_n_trade_days(fox, m)
    if len(wolf) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1415')
    hawk = list(universe)
    dolphin = query(giraffe.code, giraffe.term_095).filter(giraffe.code.in_(hawk))
    shark = {}
    tiger = {}
    for otter in wolf:
        bear = get_fundamentals(dolphin, date=otter)
        if bear is None or bear.empty:
            continue
        koala = bear['code'].values
        turtle = bear['term_095'].values
        for lion, sparrow in zip(koala, turtle):
            if lion not in shark:
                shark[lion] = 0.0
                tiger[lion] = 0
            if sparrow is None:
                continue
            try:
                giraffe = float(sparrow)
            except Exception:
                continue
            if np.isfinite(giraffe):
                shark[lion] += giraffe
                tiger[lion] += 1
    cat = {panda: shark[panda] / tiger[panda] for panda in shark.keys() if tiger.get(panda, 0) > 0 and np.isfinite(shark[panda] / tiger[panda])}
    if not cat:
        return _make_factor_series({}, date, universe=universe, name='factor1415')
    eagle = float(np.sum(list(cat.values())))
    dog = int(len(cat))
    rabbit = {}
    for lion in hawk:
        if lion not in cat:
            continue
        whale = float(cat[lion])
        zebra = (eagle - whale) / (dog - 1) if dog > 1 else whale
        owl = zebra - whale
        if np.isfinite(owl):
            rabbit[lion] = float(owl)
    return _make_factor_series(rabbit, date, universe=universe, name='factor1415')

def factor1416(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1416')

def factor1417(universe, date, freq='1m', chunk_size=300):
    _set_asof_date(date)
    koala = _to_date(date)
    hawk = list(universe)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    fox = {}
    for lion in _chunks(hawk, chunk_size):
        otter = get_price(lion, start_date=koala, end_date=koala + dt.timedelta(days=1), frequency=freq, fields=['high', 'low'], fq='post', panel=False)
        if otter is None or otter.empty:
            continue
        otter = otter.copy()
        if 'time' not in otter.columns:
            otter['time'] = otter.index
        otter['time'] = pd.to_datetime(otter['time'])
        if 'code' not in otter.columns:
            if len(lion) == 1:
                otter['code'] = lion[0]
            else:
                continue
        otter = otter[['code', 'time', 'high', 'low']].dropna(subset=['high', 'low'])
        otter['high'] = otter['high'].astype(float)
        otter['low'] = otter['low'].astype(float)
        otter = otter[np.isfinite(otter['high'].values) & np.isfinite(otter['low'].values)]
        if otter.empty:
            continue
        otter = otter.sort_values(['code', 'time'])
        for tiger, wolf in otter.groupby('code', sort=False):
            bear = wolf['high'].values.astype(float)
            whale = wolf['low'].values.astype(float)
            cat = int(bear.size)
            if cat < 10:
                continue
            shark = float(np.max(bear))
            eagle = float(np.min(whale))
            giraffe = np.where(bear == shark)[0]
            dolphin = np.where(whale == eagle)[0]
            if giraffe.size == 0 or dolphin.size == 0:
                continue
            rabbit = int(giraffe[-1]) + 1
            zebra = int(dolphin[-1]) + 1
            panda = (cat - rabbit) / float(cat) * 100.0
            dog = (cat - zebra) / float(cat) * 100.0
            sparrow = panda - dog
            if np.isfinite(sparrow):
                fox[tiger] = float(sparrow)
    return _make_factor_series(fox, date, universe=universe, name='factor1417')

def factor1418(universe, date, D=60):
    _set_asof_date(date)
    tiger = _to_date(date)
    lion = _last_n_trade_days(tiger, D + 1)
    if len(lion) < D + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1418')
    lion = [pd.to_datetime(panda).date() for panda in lion]
    koala = lion[-D:]
    whale = lion[0]
    fox = lion[-1]
    shark = list(universe)
    otter = get_price(shark, start_date=whale, end_date=fox, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1418')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter['time'] = otter.index
    otter['time'] = pd.to_datetime(otter['time'])
    otter['date'] = otter['time'].dt.date
    if 'code' not in otter.columns:
        if len(shark) == 1:
            otter['code'] = shark[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1418')
    otter = otter[otter['date'].isin(lion)]
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1418')
    cat = otter.pivot_table(index='date', columns='code', values='close', aggfunc='last').reindex(lion)
    rabbit = otter.pivot_table(index='date', columns='code', values='pre_close', aggfunc='last').reindex(lion)
    with np.errstate(divide='ignore', invalid='ignore'):
        giraffe = cat.astype(float) / rabbit.astype(float) - 1.0
    giraffe = giraffe.replace([np.inf, -np.inf], np.nan).reindex(koala)
    wolf = {}
    for dog in giraffe.columns:
        eagle = giraffe[dog].values.astype(float)
        eagle = eagle[np.isfinite(eagle)]
        if eagle.size < max(10, D // 2):
            continue
        eagle = eagle[-D:] if eagle.size >= D else eagle
        bear = float(np.mean(eagle))
        zebra = float(np.std(eagle, ddof=1))
        if not np.isfinite(zebra) or zebra <= 0:
            continue
        hawk = (eagle - bear) / zebra
        dolphin = float(np.mean(hawk ** 3))
        if np.isfinite(dolphin):
            wolf[dog] = dolphin
    return _make_factor_series(wolf, date, universe=universe, name='factor1418')

def factor1419(universe, date, freq='5m', chunk_size=400):
    _set_asof_date(date)
    panda = _to_date(date)
    giraffe = list(universe)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    lion = {}
    for dog in _chunks(giraffe, chunk_size):
        tiger = get_price(dog, start_date=panda, end_date=panda + dt.timedelta(days=1), frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if tiger is None or tiger.empty:
            continue
        tiger = tiger.copy()
        if 'time' not in tiger.columns:
            tiger['time'] = tiger.index
        tiger['time'] = pd.to_datetime(tiger['time'])
        if 'code' not in tiger.columns:
            if len(dog) == 1:
                tiger['code'] = dog[0]
            else:
                continue
        tiger = tiger[['code', 'time', 'close', 'volume']].dropna(subset=['close', 'volume'])
        tiger['close'] = tiger['close'].astype(float)
        tiger['volume'] = tiger['volume'].astype(float)
        tiger = tiger[np.isfinite(tiger['close'].values) & np.isfinite(tiger['volume'].values) & (tiger['volume'].values > 0)]
        if tiger.empty:
            continue
        tiger = tiger.sort_values(['code', 'time'])
        for cat, koala in tiger.groupby('code', sort=False):
            fox = koala['close'].values.astype(float)
            dolphin = koala['volume'].values.astype(float)
            if fox.size < 5:
                continue
            rabbit = float(np.sum(dolphin))
            if not np.isfinite(rabbit) or rabbit <= 0:
                continue
            whale = dolphin / rabbit
            otter = float(np.sum(whale * fox))
            zebra = float(np.sum(whale * (fox - otter) ** 2))
            if not np.isfinite(zebra) or zebra <= 0:
                continue
            bear = math.sqrt(zebra)
            wolf = float(np.sum(whale * (fox - otter) ** 3) / bear ** 3)
            if np.isfinite(wolf):
                lion[cat] = wolf
    return _make_factor_series(lion, date, universe=universe, name='factor1419')

def factor1420(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1420')

def factor1421(universe, date, window=20, freq='1m', chunk_size=120):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = _last_n_trade_days(otter, window)
    if len(fox) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1421')
    fox = [pd.to_datetime(lion).date() for lion in fox]
    eagle = fox[0]
    bear = fox[-1]
    owl = list(universe)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    sparrow = {dog: 0.0 for dog in owl}
    whale = {dog: 0 for dog in owl}
    for tiger in _chunks(owl, chunk_size):
        wolf = get_price(tiger, start_date=eagle, end_date=bear + dt.timedelta(days=1), frequency=freq, fields=['volume'], fq='post', panel=False)
        if wolf is None or wolf.empty:
            continue
        wolf = wolf.copy()
        if 'time' not in wolf.columns:
            wolf['time'] = wolf.index
        wolf['time'] = pd.to_datetime(wolf['time'])
        wolf['date'] = wolf['time'].dt.date
        if 'code' not in wolf.columns:
            if len(tiger) == 1:
                wolf['code'] = tiger[0]
            else:
                continue
        wolf = wolf[wolf['date'].isin(fox)]
        if wolf.empty:
            continue
        wolf = wolf[['code', 'date', 'time', 'volume']].dropna(subset=['volume'])
        wolf['volume'] = wolf['volume'].astype(float)
        wolf = wolf[np.isfinite(wolf['volume'].values)]
        if wolf.empty:
            continue
        wolf = wolf.sort_values(['code', 'date', 'time'])
        for (panda, koala), giraffe in wolf.groupby(['code', 'date'], sort=False):
            turtle = giraffe['volume'].values.astype(float)
            if turtle.size < 30:
                continue
            lizard = turtle[np.isfinite(turtle)]
            if lizard.size < 10:
                continue
            zebra = float(np.mean(lizard))
            hawk = float(np.std(lizard, ddof=1))
            if not np.isfinite(hawk) or hawk <= 0:
                continue
            cat = np.flatnonzero(turtle > zebra + hawk)
            if cat.size == 0:
                shark = 0.0
            else:
                shark = 1.0 + float(np.sum(np.diff(cat) > 1))
            sparrow[panda] += shark
            whale[panda] += 1
    rabbit = {}
    for panda in owl:
        dolphin = whale.get(panda, 0)
        if dolphin <= 0:
            continue
        frog = float(sparrow[panda] / float(dolphin))
        if np.isfinite(frog):
            rabbit[panda] = frog
    return _make_factor_series(rabbit, date, universe=universe, name='factor1421')

def factor1422(universe, date, R=20, freq='1m', chunk_size=120):
    _set_asof_date(date)
    otter = _to_date(date)
    fox = _last_n_trade_days(otter, R)
    if len(fox) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1422')
    fox = [pd.to_datetime(lion).date() for lion in fox]
    hawk = fox[0]
    giraffe = fox[-1]
    turtle = list(universe)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    sparrow = {cat: 0.0 for cat in turtle}
    dog = {cat: 0 for cat in turtle}
    for tiger in _chunks(turtle, chunk_size):
        bear = get_price(tiger, start_date=hawk, end_date=giraffe + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        if 'time' not in bear.columns:
            bear['time'] = bear.index
        bear['time'] = pd.to_datetime(bear['time'])
        bear['date'] = bear['time'].dt.date
        if 'code' not in bear.columns:
            if len(tiger) == 1:
                bear['code'] = tiger[0]
            else:
                continue
        bear = bear[bear['date'].isin(fox)]
        if bear.empty:
            continue
        bear = bear[['code', 'date', 'time', 'close']].dropna(subset=['close'])
        bear['close'] = bear['close'].astype(float)
        bear = bear[np.isfinite(bear['close'].values)]
        if bear.empty:
            continue
        bear = bear.sort_values(['code', 'date', 'time'])
        for (panda, koala), dolphin in bear.groupby(['code', 'date'], sort=False):
            shark = dolphin['close'].values.astype(float)
            if shark.size < 5:
                continue
            rabbit = np.abs(shark[1:] - shark[:-1])
            eagle = float(np.sum(rabbit))
            if not np.isfinite(eagle) or eagle <= 0:
                continue
            wolf = float(shark[-1] - shark[0])
            owl = wolf / eagle
            if np.isfinite(owl):
                sparrow[panda] += float(owl)
                dog[panda] += 1
    zebra = {}
    for panda in turtle:
        whale = dog.get(panda, 0)
        if whale <= 0:
            continue
        lizard = float(sparrow[panda] / float(whale))
        if np.isfinite(lizard):
            zebra[panda] = lizard
    return _make_factor_series(zebra, date, universe=universe, name='factor1422')

def factor1423(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1423')

def factor1424(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1424')

def factor1425(universe, date, top_n=10, min_gap=5, lookahead=5, window=20, freq='1m', chunk_size=120):
    _set_asof_date(date)
    rabbit = _to_date(date)
    giraffe = _last_n_trade_days(rabbit, window)
    if len(giraffe) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1425')
    giraffe = [pd.to_datetime(wolf).date() for wolf in giraffe]
    lemur = giraffe[0]
    whale = giraffe[-1]
    camel = list(universe)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    badger = {tiger: 0.0 for tiger in camel}
    lion = {tiger: 0 for tiger in camel}
    for otter in _chunks(camel, chunk_size):
        zebra = get_price(otter, start_date=lemur, end_date=whale + dt.timedelta(days=1), frequency=freq, fields=['volume'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            zebra['time'] = zebra.index
        zebra['time'] = pd.to_datetime(zebra['time'])
        zebra['date'] = zebra['time'].dt.date
        if 'code' not in zebra.columns:
            if len(otter) == 1:
                zebra['code'] = otter[0]
            else:
                continue
        zebra = zebra[zebra['date'].isin(giraffe)]
        if zebra.empty:
            continue
        zebra = zebra[['code', 'date', 'time', 'volume']].dropna(subset=['volume'])
        zebra['volume'] = zebra['volume'].astype(float)
        zebra = zebra[np.isfinite(zebra['volume'].values)]
        if zebra.empty:
            continue
        zebra = zebra.sort_values(['code', 'date', 'time'])
        for (koala, bear), hawk in zebra.groupby(['code', 'date'], sort=False):
            donkey = hawk['volume'].values.astype(float)
            if donkey.size < 30:
                continue
            gecko = np.where(np.isfinite(donkey), donkey, 0.0)
            if gecko.size == 0:
                continue
            owl = int(min(top_n, gecko.size))
            if owl <= 0:
                continue
            sparrow = np.argpartition(-gecko, owl - 1)[:owl]
            sparrow = np.sort(sparrow)
            if sparrow.size == 0:
                continue
            cat = []
            turtle = None
            for beaver in sparrow:
                if turtle is None or beaver - turtle >= int(min_gap):
                    cat.append(int(beaver))
                turtle = int(beaver)
            if not cat:
                continue
            tuna = []
            dog = int(lookahead)
            frog = int(gecko.size)
            for panda in cat:
                ferret = float(gecko[panda])
                if not np.isfinite(ferret) or ferret <= 0:
                    continue
                alpaca = panda + 1
                dolphin = min(panda + dog, frog - 1)
                if alpaca > dolphin:
                    continue
                eagle = float(np.sum(gecko[alpaca:dolphin + 1]))
                salmon = eagle / ferret
                if np.isfinite(salmon):
                    tuna.append(float(salmon))
            if tuna:
                fox = float(np.mean(tuna))
                if np.isfinite(fox):
                    badger[koala] += fox
                    lion[koala] += 1
    shark = {}
    for koala in camel:
        lizard = lion.get(koala, 0)
        if lizard <= 0:
            continue
        hyena = float(badger[koala] / float(lizard))
        if np.isfinite(hyena):
            shark[koala] = hyena
    return _make_factor_series(shark, date, universe=universe, name='factor1425')

def factor1426(universe, date, K=20):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, K)
    if len(koala) < K:
        return _make_factor_series({}, date, universe=universe, name='factor1426')
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    hawk = koala[0]
    fox = koala[-1]
    owl = list(universe)
    otter = get_price(owl, start_date=hawk, end_date=fox, frequency='daily', fields=['open', 'high', 'low', 'close'], fq='post', panel=False)
    if otter is None or otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1426')
    otter = otter.copy()
    if 'time' not in otter.columns:
        otter['time'] = otter.index
    otter['time'] = pd.to_datetime(otter['time'])
    otter['date'] = otter['time'].dt.date
    if 'code' not in otter.columns:
        if len(owl) == 1:
            otter['code'] = owl[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1426')
    otter = otter[otter['date'].isin(koala)]
    if otter.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1426')
    whale = otter.pivot_table(index='date', columns='code', values='open', aggfunc='last').reindex(koala).astype(float)
    bear = otter.pivot_table(index='date', columns='code', values='high', aggfunc='last').reindex(koala).astype(float)
    giraffe = otter.pivot_table(index='date', columns='code', values='low', aggfunc='last').reindex(koala).astype(float)
    cat = otter.pivot_table(index='date', columns='code', values='close', aggfunc='last').reindex(koala).astype(float)
    wolf = {}
    for dog in cat.columns:
        shark = whale[dog].values
        rabbit = bear[dog].values
        zebra = giraffe[dog].values
        panda = cat[dog].values
        dolphin = np.isfinite(shark) & np.isfinite(rabbit) & np.isfinite(zebra) & np.isfinite(panda) & (panda != 0)
        if dolphin.sum() < max(5, K // 2):
            continue
        eagle = np.sign(panda - shark)
        sparrow = (2.0 * (rabbit - zebra) * eagle - (panda - shark)) / panda
        sparrow = sparrow[dolphin]
        sparrow = sparrow[np.isfinite(sparrow)]
        if sparrow.size < max(5, K // 2):
            continue
        turtle = float(np.mean(sparrow[-K:])) if sparrow.size >= K else float(np.mean(sparrow))
        if np.isfinite(turtle):
            wolf[dog] = turtle
    return _make_factor_series(wolf, date, universe=universe, name='factor1426')

def factor1427(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1427')

def factor1428(universe, date, window=20, freq='1m', chunk_size=120, tick=1e-06):
    _set_asof_date(date)
    fox = _to_date(date)
    bear = _last_n_trade_days(fox, window)
    if len(bear) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1428')
    bear = [pd.to_datetime(koala).date() for koala in bear]
    owl = bear[0]
    zebra = bear[-1]
    alpaca = (np.arange(1, len(bear) + 1, dtype=float) / float(len(bear))).astype(float)
    wolf = {koala: float(lemur) for koala, lemur in zip(bear, alpaca)}
    frog = list(universe)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    turtle = {panda: 0.0 for panda in frog}
    lizard = {panda: 0.0 for panda in frog}
    for lion in _chunks(frog, chunk_size):
        giraffe = get_price(lion, start_date=owl, end_date=zebra + dt.timedelta(days=1), frequency=freq, fields=['high', 'low', 'close', 'volume'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe['time'] = giraffe.index
        giraffe['time'] = pd.to_datetime(giraffe['time'])
        giraffe['date'] = giraffe['time'].dt.date
        if 'code' not in giraffe.columns:
            if len(lion) == 1:
                giraffe['code'] = lion[0]
            else:
                continue
        giraffe = giraffe[giraffe['date'].isin(bear)]
        if giraffe.empty:
            continue
        giraffe = giraffe[['code', 'date', 'time', 'high', 'low', 'close', 'volume']].dropna(subset=['high', 'low', 'close', 'volume'])
        giraffe['high'] = giraffe['high'].astype(float)
        giraffe['low'] = giraffe['low'].astype(float)
        giraffe['close'] = giraffe['close'].astype(float)
        giraffe['volume'] = giraffe['volume'].astype(float)
        giraffe = giraffe[np.isfinite(giraffe['high'].values) & np.isfinite(giraffe['low'].values) & np.isfinite(giraffe['close'].values) & np.isfinite(giraffe['volume'].values)]
        if giraffe.empty:
            continue
        giraffe = giraffe.sort_values(['code', 'date', 'time'])
        for (tiger, otter), whale in giraffe.groupby(['code', 'date'], sort=False):
            shark = whale['high'].values
            eagle = whale['low'].values
            panda = whale['close'].values
            salmon = whale['volume'].values
            if shark.size < 10:
                continue
            sparrow = np.maximum(shark - eagle, float(tick))
            hawk = (2.0 * panda - shark - eagle) / sparrow
            dog = hawk * salmon
            cat = float(np.sum(dog))
            if np.isfinite(cat):
                badger = wolf.get(otter, 0.0)
                turtle[tiger] += badger * cat
                lizard[tiger] += badger
    dolphin = {}
    for tiger in frog:
        rabbit = float(lizard.get(tiger, 0.0))
        if rabbit <= 0:
            continue
        tuna = float(turtle[tiger] / rabbit)
        if np.isfinite(tuna):
            dolphin[tiger] = tuna
    return _make_factor_series(dolphin, date, universe=universe, name='factor1428')

def factor1429(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1429')

def factor1430(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1430')

def factor1431(universe, date, k_days=5, perc=0.9, lookahead=5, window=20, freq='1m', batch_size=200, max_samples=2000000, seed=7):
    _set_asof_date(date)
    donkey = np.random.RandomState(int(seed))
    bear = _to_date(date)
    mole = list(universe)
    giraffe = _last_n_trade_days(bear, k_days + 1)
    if len(giraffe) < k_days + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1431')
    sparrow = [pd.to_datetime(urchin).date() for urchin in giraffe[:-1]]
    turtle = sparrow[0]
    owl = sparrow[-1]
    rabbit = _last_n_trade_days(bear, window)
    if len(rabbit) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1431')
    raccoon = [pd.to_datetime(urchin).date() for urchin in rabbit]
    turkey = raccoon[0]
    seal = raccoon[-1]
    ferret = []
    gecko = 0
    for lizard in range(0, len(mole), max(1, int(batch_size))):
        lion = mole[lizard:lizard + max(1, int(batch_size))]
        dolphin = get_price(lion, start_date=turtle, end_date=owl + dt.timedelta(days=1), frequency=freq, fields=['volume'], fq='post', panel=False)
        if dolphin is None or dolphin.empty:
            continue
        dolphin = dolphin.copy()
        if 'time' not in dolphin.columns:
            dolphin['time'] = dolphin.index
        dolphin['time'] = pd.to_datetime(dolphin['time'])
        dolphin['date'] = dolphin['time'].dt.date
        if 'code' not in dolphin.columns:
            if len(lion) == 1:
                dolphin['code'] = lion[0]
            else:
                continue
        dolphin = dolphin[dolphin['date'].isin(sparrow)]
        if dolphin.empty:
            continue
        narwhal = dolphin['volume'].astype(float).values
        narwhal = narwhal[np.isfinite(narwhal) & (narwhal > 0)]
        if narwhal.size == 0:
            continue
        if gecko < max_samples:
            jaguar = min(narwhal.size, max_samples - gecko)
            if jaguar > 0:
                if narwhal.size > jaguar:
                    frog = donkey.choice(narwhal.size, size=jaguar, replace=False)
                    ferret.append(narwhal[frog])
                else:
                    ferret.append(narwhal)
                gecko += jaguar
        else:
            jaguar = min(narwhal.size, 20000)
            if jaguar > 0:
                frog = donkey.choice(narwhal.size, size=jaguar, replace=False) if narwhal.size > jaguar else np.arange(narwhal.size)
                octopus = narwhal[frog]
                lemur = donkey.choice(max_samples, size=octopus.size, replace=False) if octopus.size < max_samples else donkey.choice(max_samples, size=20000, replace=False)
                if isinstance(ferret, list):
                    ferret = np.concatenate(ferret) if ferret else np.array([], dtype=float)
                ferret[lemur[:octopus.size]] = octopus[:lemur[:octopus.size].size]
    if isinstance(ferret, list):
        ferret = np.concatenate(ferret) if ferret else np.array([], dtype=float)
    if ferret.size == 0:
        return _make_factor_series({}, date, universe=universe, name='factor1431')
    dog = float(np.quantile(ferret, float(perc)))
    if not np.isfinite(dog):
        return _make_factor_series({}, date, universe=universe, name='factor1431')
    camel = {koala: 0.0 for koala in mole}
    beaver = {koala: 0 for koala in mole}
    cat = int(lookahead)
    for lizard in range(0, len(mole), max(1, int(batch_size))):
        lion = mole[lizard:lizard + max(1, int(batch_size))]
        zebra = get_price(lion, start_date=turkey, end_date=seal + dt.timedelta(days=1), frequency=freq, fields=['close', 'volume'], fq='post', panel=False)
        if zebra is None or zebra.empty:
            continue
        zebra = zebra.copy()
        if 'time' not in zebra.columns:
            zebra['time'] = zebra.index
        zebra['time'] = pd.to_datetime(zebra['time'])
        zebra['date'] = zebra['time'].dt.date
        if 'code' not in zebra.columns:
            if len(lion) == 1:
                zebra['code'] = lion[0]
            else:
                continue
        zebra = zebra[zebra['date'].isin(raccoon)]
        if zebra.empty:
            continue
        zebra = zebra[['code', 'date', 'time', 'close', 'volume']].dropna(subset=['close', 'volume'])
        zebra['close'] = zebra['close'].astype(float)
        zebra['volume'] = zebra['volume'].astype(float)
        zebra = zebra[np.isfinite(zebra['close'].values) & np.isfinite(zebra['volume'].values)]
        if zebra.empty:
            continue
        zebra = zebra.sort_values(['code', 'date', 'time'])
        for (fox, wolf), hyena in zebra.groupby(['code', 'date'], sort=False):
            otter = hyena['close'].values.astype(float)
            quail = hyena['volume'].values.astype(float)
            if otter.size < 10:
                continue
            llama = np.flatnonzero(quail > dog)
            if llama.size < 2:
                continue
            panda = quail * otter
            if not np.isfinite(panda).all():
                continue
            alpaca = int(panda.size)
            if alpaca < 3 or cat <= 0:
                continue
            hawk = np.full(alpaca, np.nan, dtype=float)
            for salmon in range(1, cat + 1):
                kangaroo = np.full(alpaca, np.nan, dtype=float)
                kangaroo[:-salmon] = panda[salmon:]
                hawk = kangaroo if salmon == 1 else np.fmax(hawk, kangaroo)
            tiger = panda[llama]
            eagle = hawk[llama]
            tuna = np.isfinite(tiger) & np.isfinite(eagle) & (tiger > 0) & (eagle > 0)
            if tuna.sum() < 3:
                continue
            iguana = tiger[tuna]
            whale = eagle[tuna]
            if np.std(iguana, ddof=1) == 0 or np.std(whale, ddof=1) == 0:
                continue
            badger = float(np.corrcoef(iguana, whale)[0, 1])
            if np.isfinite(badger):
                camel[fox] += badger
                beaver[fox] += 1
    shark = {}
    for fox in mole:
        alpaca = beaver.get(fox, 0)
        if alpaca <= 0:
            continue
        penguin = float(camel[fox] / float(alpaca))
        if np.isfinite(penguin):
            shark[fox] = penguin
    return _make_factor_series(shark, date, universe=universe, name='factor1431')

def factor1432(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1432')

def factor1433(universe, date, K=239):
    _set_asof_date(date)
    wolf = _to_date(date)
    bear = _last_n_trade_days(wolf, K + 1)
    if len(bear) < K + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1433')
    bear = [pd.to_datetime(fox).date() for fox in bear]
    tuna = bear[0]
    shark = bear[-1]
    badger = list(universe)
    zebra = get_price(badger, start_date=tuna, end_date=shark, frequency='daily', fields=['high', 'low'], fq='post', panel=False)
    if zebra is None or zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1433')
    zebra = zebra.copy()
    if 'time' not in zebra.columns:
        zebra['time'] = zebra.index
    zebra['time'] = pd.to_datetime(zebra['time'])
    zebra['date'] = zebra['time'].dt.date
    if 'code' not in zebra.columns:
        if len(badger) == 1:
            zebra['code'] = badger[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1433')
    zebra = zebra[zebra['date'].isin(bear)]
    if zebra.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1433')
    tiger = zebra.pivot_table(index='date', columns='code', values='high', aggfunc='last').reindex(bear).astype(float)
    lion = zebra.pivot_table(index='date', columns='code', values='low', aggfunc='last').reindex(bear).astype(float)
    eagle = {}
    for koala in tiger.columns:
        hawk = tiger[koala].values
        turtle = lion[koala].values
        if np.sum(np.isfinite(hawk) & np.isfinite(turtle)) < max(20, (K + 1) // 2):
            continue
        owl = hawk[1:]
        frog = turtle[1:]
        sparrow = hawk[:-1]
        lizard = turtle[:-1]
        salmon = np.isfinite(owl) & np.isfinite(frog) & np.isfinite(sparrow) & np.isfinite(lizard)
        if salmon.sum() < max(20, K // 2):
            continue
        dolphin = np.abs(owl - sparrow)
        whale = np.abs(frog - lizard)
        cat = np.maximum(dolphin, whale)
        otter = owl + frog <= sparrow + lizard
        panda = np.where(otter, cat, 0.0)
        dog = np.where(otter, 0.0, cat)
        lemur = float(np.sum(panda[salmon]))
        alpaca = float(np.sum(dog[salmon]))
        giraffe = lemur + alpaca
        if not np.isfinite(giraffe) or giraffe <= 0:
            continue
        rabbit = 100.0 * (lemur - alpaca) / giraffe
        if np.isfinite(rabbit):
            eagle[koala] = float(rabbit)
    return _make_factor_series(eagle, date, universe=universe, name='factor1433')

def factor1434(universe, date, min_obs=5):
    _set_asof_date(date)
    koala = _to_date(date)
    shark = pd.Period(koala, freq='M')
    tuna, dolphin = (shark.year, shark.month)
    sparrow = dt.date(tuna, dolphin, 1)
    whale = dt.date(tuna + 1, 1, 1) if dolphin == 12 else dt.date(tuna, dolphin + 1, 1)
    bear = whale - dt.timedelta(days=1)
    fox = list(get_trade_days(start_date=sparrow, end_date=bear))
    if len(fox) < min_obs:
        return _make_factor_series({}, date, universe=universe, name='factor1434')
    otter = [pd.to_datetime(lion).date() for lion in fox]
    owl = list(universe)
    wolf = get_price(security=owl, start_date=sparrow, end_date=bear, frequency='daily', fields=['close', 'pre_close'], fq='post', panel=False)
    if wolf is None or wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1434')
    wolf = wolf.copy()
    if 'time' not in wolf.columns:
        wolf['time'] = wolf.index
    wolf['time'] = pd.to_datetime(wolf['time'])
    wolf['date'] = wolf['time'].dt.date
    if 'code' not in wolf.columns:
        if len(owl) == 1:
            wolf['code'] = owl[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1434')
    wolf = wolf[wolf['date'].isin(otter)]
    if wolf.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1434')
    dog = wolf.pivot_table(index='date', columns='code', values='close', aggfunc='last').reindex(otter)
    eagle = wolf.pivot_table(index='date', columns='code', values='pre_close', aggfunc='last').reindex(otter)
    with np.errstate(divide='ignore', invalid='ignore'):
        hawk = dog.astype(float) / eagle.astype(float) - 1.0
    hawk = hawk.replace([np.inf, -np.inf], np.nan)
    giraffe = hawk.std(axis=1, ddof=1, skipna=True)
    lizard = giraffe.values.astype(float)
    rabbit = {}
    for panda in hawk.columns:
        salmon = hawk[panda].values.astype(float)
        zebra = np.isfinite(lizard) & np.isfinite(salmon)
        if zebra.sum() < min_obs:
            continue
        frog = lizard[zebra]
        alpaca = salmon[zebra]
        turtle = float(np.sum((frog - frog.mean()) ** 2))
        if not np.isfinite(turtle) or turtle <= 0:
            continue
        tiger = float(np.sum((frog - frog.mean()) * (alpaca - alpaca.mean())))
        cat = tiger / turtle
        if np.isfinite(cat):
            rabbit[panda] = float(abs(cat))
    return _make_factor_series(rabbit, date, universe=universe, name='factor1434')

def factor1435(universe, date, R=20, chunk_size=300):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = _last_n_trade_days(fox, R)
    if len(wolf) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1435')
    wolf = [pd.to_datetime(koala).date() for koala in wolf]
    eagle = wolf[0]
    rabbit = wolf[-1]
    sparrow = list(universe)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    hawk = {cat: 0.0 for cat in sparrow}
    panda = {cat: 0 for cat in sparrow}
    for lion in _chunks(sparrow, chunk_size):
        bear = get_price(lion, start_date=eagle, end_date=rabbit + dt.timedelta(days=1), frequency='1m', fields=['open', 'close'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        if 'time' not in bear.columns:
            bear['time'] = bear.index
        bear['time'] = pd.to_datetime(bear['time'])
        bear['date'] = bear['time'].dt.date
        if 'code' not in bear.columns:
            if len(lion) == 1:
                bear['code'] = lion[0]
            else:
                continue
        bear = bear[bear['date'].isin(wolf)]
        if bear.empty:
            continue
        bear = bear[['code', 'date', 'time', 'open', 'close']].dropna(subset=['open', 'close'])
        bear['open'] = bear['open'].astype(float)
        bear['close'] = bear['close'].astype(float)
        bear = bear[np.isfinite(bear['open'].values) & np.isfinite(bear['close'].values)]
        if bear.empty:
            continue
        bear = bear.sort_values(['code', 'date', 'time'])
        for (tiger, otter), zebra in bear.groupby(['code', 'date'], sort=False):
            if zebra.shape[0] < 3:
                continue
            zebra = zebra.iloc[:3]
            whale = float(zebra['open'].iloc[0])
            dog = float(zebra['close'].iloc[2])
            if not np.isfinite(whale) or not np.isfinite(dog) or whale <= 0:
                continue
            shark = (dog - whale) / whale
            if np.isfinite(shark):
                hawk[tiger] += float(shark)
                panda[tiger] += 1
    giraffe = {}
    for tiger in sparrow:
        dolphin = panda.get(tiger, 0)
        if dolphin <= 0:
            continue
        owl = float(hawk[tiger] / float(dolphin))
        if np.isfinite(owl):
            giraffe[tiger] = owl
    return _make_factor_series(giraffe, date, universe=universe, name='factor1435')

def factor1436(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1436')

def factor1437(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1437')

def factor1438(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1438')

def factor1439(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1439')

def factor1440(universe, date, gamma=5, freq='5m', chunk_size=300):
    _set_asof_date(date)
    lion = _to_date(date)
    koala = _last_n_trade_days(lion, gamma)
    if len(koala) < 3:
        return _make_factor_series({}, date, universe=universe, name='factor1440')
    koala = [pd.to_datetime(tiger).date() for tiger in koala]
    sparrow = koala[0]
    fox = koala[-1]
    owl = list(universe)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    zebra = {cat: 0 for cat in owl}
    whale = {cat: 0.0 for cat in owl}
    hawk = {cat: 0.0 for cat in owl}
    for panda in _chunks(owl, chunk_size):
        otter = get_price(panda, start_date=sparrow, end_date=fox + dt.timedelta(days=1), frequency=freq, fields=['volume'], fq='post', panel=False)
        if otter is None or otter.empty:
            continue
        otter = otter.copy()
        if 'time' not in otter.columns:
            otter['time'] = otter.index
        otter['time'] = pd.to_datetime(otter['time'])
        otter['date'] = otter['time'].dt.date
        if 'code' not in otter.columns:
            if len(panda) == 1:
                otter['code'] = panda[0]
            else:
                continue
        otter = otter[otter['date'].isin(koala)]
        if otter.empty:
            continue
        otter = otter[['code', 'date', 'volume']].dropna(subset=['volume'])
        otter['volume'] = otter['volume'].astype(float)
        otter = otter[np.isfinite(otter['volume'].values) & (otter['volume'].values > 0)]
        if otter.empty:
            continue
        for dog, bear in otter.groupby('code', sort=False):
            turtle = bear['volume'].values.astype(float)
            if turtle.size == 0:
                continue
            zebra[dog] += int(turtle.size)
            whale[dog] += float(np.sum(turtle))
            hawk[dog] += float(np.sum(turtle * turtle))
    wolf = {}
    for dog in owl:
        giraffe = zebra.get(dog, 0)
        if giraffe < 10:
            continue
        dolphin = float(whale.get(dog, 0.0))
        eagle = float(hawk.get(dog, 0.0))
        if not np.isfinite(dolphin) or not np.isfinite(eagle) or dolphin <= 0:
            continue
        rabbit = dolphin / float(giraffe)
        if rabbit <= 0:
            continue
        if giraffe <= 1:
            continue
        lizard = (eagle - dolphin * dolphin / float(giraffe)) / float(giraffe - 1)
        if not np.isfinite(lizard) or lizard <= 0:
            continue
        shark = math.sqrt(lizard)
        frog = shark / rabbit
        if np.isfinite(frog):
            wolf[dog] = float(frog)
    return _make_factor_series(wolf, date, universe=universe, name='factor1440')

def factor1441(universe, date, n=20, freq='5m', chunk_size=300):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = _last_n_trade_days(bear, n)
    if len(rabbit) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1441')
    rabbit = [pd.to_datetime(fox).date() for fox in rabbit]
    lizard = rabbit[0]
    zebra = rabbit[-1]
    frog = list(universe)

    def _chunks(seq, n_):
        for cat in range(0, len(seq), n_):
            yield seq[cat:cat + n_]
    hawk = {lion: 0 for lion in frog}
    eagle = {lion: 0.0 for lion in frog}
    dog = {lion: 0.0 for lion in frog}
    tiger = {lion: 0.0 for lion in frog}

    def _update(code, x):
        koala = n_map[code]
        otter = koala + 1
        panda = x - mean_map[code]
        tiger = panda / otter
        lion = mean_map[code] + tiger
        fox = panda * tiger * koala
        dog = M4_map[code]
        cat = M2_map[code]
        dog += fox * tiger * tiger * (otter * otter - 3 * otter + 3) + 6 * (tiger * tiger) * cat
        cat += fox
        n_map[code] = otter
        mean_map[code] = lion
        M2_map[code] = cat
        M4_map[code] = dog
    for otter in _chunks(frog, chunk_size):
        giraffe = get_price(otter, start_date=lizard, end_date=zebra + dt.timedelta(days=1), frequency=freq, fields=['close'], fq='post', panel=False)
        if giraffe is None or giraffe.empty:
            continue
        giraffe = giraffe.copy()
        if 'time' not in giraffe.columns:
            giraffe['time'] = giraffe.index
        giraffe['time'] = pd.to_datetime(giraffe['time'])
        giraffe['date'] = giraffe['time'].dt.date
        if 'code' not in giraffe.columns:
            if len(otter) == 1:
                giraffe['code'] = otter[0]
            else:
                continue
        giraffe = giraffe[giraffe['date'].isin(rabbit)]
        if giraffe.empty:
            continue
        giraffe = giraffe[['code', 'date', 'time', 'close']].dropna(subset=['close'])
        giraffe['close'] = giraffe['close'].astype(float)
        giraffe = giraffe[np.isfinite(giraffe['close'].values)]
        if giraffe.empty:
            continue
        giraffe = giraffe.sort_values(['code', 'date', 'time'])
        for (koala, wolf), whale in giraffe.groupby(['code', 'date'], sort=False):
            owl = whale['close'].values.astype(float)
            if owl.size < 5:
                continue
            turtle = owl[1:] / owl[:-1] - 1.0
            turtle = turtle[np.isfinite(turtle)]
            if turtle.size == 0:
                continue
            for salmon in turtle:
                _update(koala, float(salmon))
    dolphin = {}
    for koala in frog:
        sparrow = hawk.get(koala, 0)
        if sparrow < 30:
            continue
        cat = float(dog.get(koala, 0.0))
        panda = float(tiger.get(koala, 0.0))
        if not np.isfinite(cat) or cat <= 0 or (not np.isfinite(panda)) or (panda <= 0):
            continue
        shark = panda * float(sparrow - 1) ** 2 / (float(sparrow) * cat ** 2)
        if np.isfinite(shark):
            dolphin[koala] = float(shark)
    return _make_factor_series(dolphin, date, universe=universe, name='factor1441')

def factor1442(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1442')

def factor1443(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1443')

def factor1444(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1444')

def factor1445(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1445')

def factor1446(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1446')

def factor1447(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1447')

def factor1448(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1448')

def factor1449(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1449')

def factor1450(universe, date, K=239, window=20):
    _set_asof_date(date)
    bear = _to_date(date)
    rabbit = _last_n_trade_days(bear, K + window)
    if len(rabbit) < K + window:
        return _make_factor_series({}, date, universe=universe, name='factor1450')
    rabbit = [pd.to_datetime(wolf).date() for wolf in rabbit]
    salmon = rabbit[0]
    dolphin = rabbit[-1]
    alpaca = list(universe)
    giraffe = get_price(alpaca, start_date=salmon, end_date=dolphin, frequency='daily', fields=['close', 'high', 'low'], fq='post', panel=False)
    if giraffe is None or giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1450')
    giraffe = giraffe.copy()
    if 'time' not in giraffe.columns:
        giraffe['time'] = giraffe.index
    giraffe['time'] = pd.to_datetime(giraffe['time'])
    giraffe['date'] = giraffe['time'].dt.date
    if 'code' not in giraffe.columns:
        if len(alpaca) == 1:
            giraffe['code'] = alpaca[0]
        else:
            return _make_factor_series({}, date, universe=universe, name='factor1450')
    giraffe = giraffe[giraffe['date'].isin(rabbit)]
    if giraffe.empty:
        return _make_factor_series({}, date, universe=universe, name='factor1450')
    cat = giraffe.pivot_table(index='date', columns='code', values='close', aggfunc='last').reindex(rabbit).astype(float)
    dog = giraffe.pivot_table(index='date', columns='code', values='high', aggfunc='last').reindex(rabbit).astype(float)
    panda = giraffe.pivot_table(index='date', columns='code', values='low', aggfunc='last').reindex(rabbit).astype(float)
    whale = {}
    sparrow = pd.Index(rabbit[1:], name='date')
    for fox in cat.columns:
        lion = cat[fox].values
        eagle = dog[fox].values
        owl = panda[fox].values
        if np.sum(np.isfinite(lion) & np.isfinite(eagle) & np.isfinite(owl)) < max(60, (K + window) // 2):
            continue
        otter = lion[1:]
        koala = lion[:-1]
        hawk = eagle[1:]
        turtle = owl[1:]
        lizard = np.isfinite(otter) & np.isfinite(koala) & np.isfinite(hawk) & np.isfinite(turtle)
        if lizard.sum() < max(60, K // 2):
            continue
        zebra = np.full(otter.shape[0], np.nan, dtype=float)
        shark = otter > koala
        zebra[lizard & shark] = otter[lizard & shark] - np.minimum(turtle[lizard & shark], koala[lizard & shark])
        zebra[lizard & ~shark] = otter[lizard & ~shark] - np.maximum(hawk[lizard & ~shark], koala[lizard & ~shark])
        frog = pd.Series(zebra, index=sparrow)
        tiger = frog.rolling(window=int(K), min_periods=1).sum()
        tuna = tiger.iloc[-int(window):]
        tuna = tuna[np.isfinite(tuna.values)]
        if tuna.size < max(5, window // 2):
            continue
        lemur = float(tuna.mean())
        if np.isfinite(lemur):
            whale[fox] = lemur
    return _make_factor_series(whale, date, universe=universe, name='factor1450')

def factor1451(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1451')

def factor1452(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1452')

def factor1453(universe, date, N=12, eps=1e-06):
    _set_asof_date(date)
    wolf = _to_date(date)
    hyena = list(universe)
    zebra = pd.Period(wolf, freq='M')
    alpaca = [zebra - shark for shark in range(N, -1, -1)]
    turtle = []
    for tuna in alpaca:
        ferret = tuna.start_time.date()
        giraffe = tuna.end_time.date()
        gecko = get_trade_days(start_date=ferret, end_date=giraffe)
        if gecko is None or len(gecko) == 0:
            turtle.append(None)
            continue
        fox = pd.to_datetime(gecko[-1]).date()
        turtle.append(fox)
    turtle = [koala for koala in turtle if koala is not None]
    if len(turtle) < N + 1:
        return _make_factor_series({}, date, universe=universe, name='factor1453')
    turtle = turtle[-(N + 1):]
    badger = query(giraffe.code, giraffe.pb_ratio).filter(giraffe.code.in_(hyena))
    salmon = np.full((len(hyena), len(turtle)), np.nan, dtype=float)
    for eagle, otter in enumerate(turtle):
        rabbit = get_fundamentals(badger, date=otter)
        if rabbit is None or rabbit.empty:
            continue
        donkey = pd.Series(rabbit['pb_ratio'].values, index=rabbit['code'].values).astype(float)
        salmon[:, eagle] = donkey.reindex(hyena).values
    salmon = np.where(np.isfinite(salmon) & (salmon > eps), salmon, np.nan)
    frog = np.isfinite(salmon).sum(axis=1) == N + 1
    if frog.sum() < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1453')
    beaver = salmon[:, 1:] / salmon[:, :-1] - 1.0
    tiger = 0.88
    sparrow = 2.25
    whale = 0.61
    bear = 0.69

    def value_func(x):
        if x >= 0:
            return x ** alpha
        return -lambd * (-x) ** alpha

    def w_plus(P):
        if P <= 0:
            return 0.0
        if P >= 1:
            return 1.0
        dog = P ** gamma
        cat = (P ** gamma + (1 - P) ** gamma) ** (1.0 / gamma)
        return float(dog / cat) if cat > 0 else 0.0

    def w_minus(P):
        if P <= 0:
            return 0.0
        if P >= 1:
            return 1.0
        dog = P ** delta
        cat = (P ** delta + (1 - P) ** delta) ** (1.0 / delta)
        return float(dog / cat) if cat > 0 else 0.0
    dolphin = {}
    for shark, lion in enumerate(hyena):
        if not frog[shark]:
            continue
        camel = beaver[shark, :].astype(float)
        if np.any(~np.isfinite(camel)):
            continue
        lizard = np.sort(camel[camel < 0])
        lemur = np.sort(camel[camel >= 0])
        panda = 0.0
        if lizard.size > 0:
            owl = int(lizard.size)
            for hawk in range(owl):
                iguana = float(lizard[hawk])
                cat = (hawk + 1) / owl
                dog = hawk / owl
                panda += value_func(iguana) * (w_minus(cat) - w_minus(dog))
        if lemur.size > 0:
            owl = int(lemur.size)
            for hawk in range(owl):
                iguana = float(lemur[hawk])
                cat = (hawk + 1) / owl
                dog = hawk / owl
                panda += value_func(iguana) * (w_plus(cat) - w_plus(dog))
        if np.isfinite(panda):
            dolphin[lion] = float(panda)
    return _make_factor_series(dolphin, date, universe=universe, name='factor1453')

def factor1454(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1454')

def factor1455(universe, date, window=20, freq='5m', chunk_size=200):
    _set_asof_date(date)
    fox = _to_date(date)
    wolf = _last_n_trade_days(fox, window)
    if len(wolf) < 5:
        return _make_factor_series({}, date, universe=universe, name='factor1455')
    wolf = [pd.to_datetime(otter).date() for otter in wolf]
    whale = wolf[0]
    rabbit = wolf[-1]
    eagle = list(universe)

    def _chunks(seq, n):
        for cat in range(0, len(seq), n):
            yield seq[cat:cat + n]
    giraffe = {}
    for lion in _chunks(eagle, chunk_size):
        bear = get_price(lion, start_date=whale, end_date=rabbit + dt.timedelta(days=1), frequency=freq, fields=['money'], fq='post', panel=False)
        if bear is None or bear.empty:
            continue
        bear = bear.copy()
        if 'time' in bear.columns:
            bear['time'] = pd.to_datetime(bear['time'])
        else:
            bear['time'] = pd.to_datetime(bear.index)
        if 'code' not in bear.columns:
            if len(lion) == 1:
                bear['code'] = lion[0]
            else:
                continue
        bear['date'] = bear['time'].dt.date
        bear = bear[bear['date'].isin(wolf)]
        if bear.empty:
            continue
        bear = bear[['code', 'date', 'money']].dropna(subset=['money'])
        bear['money'] = bear['money'].astype(float)
        bear = bear[np.isfinite(bear['money'].values) & (bear['money'].values > 0)]
        if bear.empty:
            continue
        bear['xlogx'] = bear['money'] * np.log(bear['money'])
        zebra = bear.groupby(['code', 'date'], sort=False)
        panda = zebra['money'].sum()
        cat = zebra['money'].count()
        tiger = zebra['xlogx'].sum()
        shark = pd.DataFrame({'S': panda, 'C': cat, 'XLOGX': tiger})
        shark = shark[(shark['C'] >= 5) & np.isfinite(shark['S'].values) & (shark['S'].values > 0)]
        if shark.empty:
            continue
        dog = np.log(shark['S'].values) - shark['XLOGX'].values / shark['S'].values
        shark['H'] = dog
        shark.loc[~np.isfinite(shark['H']), 'H'] = np.nan
        shark = shark.dropna(subset=['H'])
        if shark.empty:
            continue
        dolphin = shark['H'].groupby(level=0, sort=False).mean()
        for koala, hawk in dolphin.items():
            if np.isfinite(hawk):
                giraffe[str(koala)] = float(hawk)
    return _make_factor_series(giraffe, date, universe=universe, name='factor1455')

def factor1456(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1456')

def factor1457(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1457')

def factor1458(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1458')

def factor1459(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1459')

def factor1460(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1460')

def factor1461(universe, date):
    _set_asof_date(date)
    dog = {cat: np.nan for cat in universe}
    return _make_factor_series(dog, date, universe=universe, name='factor1461')
